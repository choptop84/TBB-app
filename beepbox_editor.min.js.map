{"version":3,"names":["Config","centerWave","wave","sum","i","length","average","performIntegral","push","Float32Array","cumulative","temp","getPulseWidthRatio","pulseWidth","Math","pow","pulseWidthRange","pulseWidthStepPower","getDrumWave","index","inverseRealFourierTransform","scaleElementsByFactor","chipNoises","samples","chipNoiseLength","drumBuffer","newBuffer","random","Error","drawNoiseSpectrum","sqrt","waveLength","lowOctave","highOctave","lowPower","highPower","overallSlope","lowIndex","highIndex","min","retroWave","combinedAmplitude","lerped","log2","amplitude","radians","PI","cos","sin","getArpeggioPitchIndex","pitchCount","rhythm","arpeggio","arpeggioPattern","rhythms","arpeggioPatterns","toNameMap","array","dictionary","value","name","result","effectsIncludeTransition","effects","effectsIncludeChord","effectsIncludePitchShift","effectsIncludeDetune","effectsIncludeVibrato","effectsIncludeNoteFilter","effectsIncludeDistortion","effectsIncludeBitcrusher","effectsIncludePanning","effectsIncludeChorus","effectsIncludeEcho","effectsIncludeReverb","scales","realName","flags","keys","isWhiteKey","basePitch","blackKeyNameParents","tempoMin","tempoMax","echoDelayRange","echoDelayStepTicks","echoSustainRange","echoShelfHz","echoShelfGain","reverbShelfHz","reverbShelfGain","reverbRange","reverbDelayBufferSize","reverbDelayBufferMask","beatsPerBarMin","beatsPerBarMax","barCountMin","barCountMax","instrumentCountMin","layeredInstrumentCountMax","patternInstrumentCountMax","partsPerBeat","ticksPerPart","stepsPerBeat","ticksPerArpeggio","roundUpThresholds","instrumentTypeNames","instrumentTypeHasSpecialInterval","chipBaseExpression","fmBaseExpression","noiseBaseExpression","spectrumBaseExpression","drumsetBaseExpression","harmonicsBaseExpression","pwmBaseExpression","supersawBaseExpression","pickedStringBaseExpression","distortionBaseVolume","bitcrusherBaseVolume","chipWaves","expression","pitchFilterMult","isSoft","filterFreqStep","filterFreqRange","filterFreqReferenceSetting","filterFreqReferenceHz","filterFreqMaxHz","filterFreqMinHz","filterGainRange","filterGainCenter","filterGainStep","filterMaxPoints","filterTypeNames","fadeInRange","fadeOutTicks","fadeOutNeutral","drumsetFadeOutTicks","transitions","isSeamless","continues","slides","slideTicks","includeAdjacentPatterns","vibratos","periodsSeconds","delayTicks","unisons","voices","spread","offset","sign","effectNames","effectOrder","noteSizeMax","volumeRange","volumeLogScale","panCenter","panMax","panDelaySecondsMax","chorusRange","chorusPeriodSeconds","chorusDelayRange","chorusDelayOffsets","chorusPhaseOffsets","chorusMaxDelay","concat","reduce","x","y","max","chords","customInterval","arpeggiates","strumParts","singleTone","maxChordSize","operatorCount","maxPitchOrOperatorCount","algorithms","carrierCount","associatedCarrier","modulatedBy","operatorCarrierInterval","operatorAmplitudeMax","operatorFrequencies","mult","hzOffset","amplitudeSign","envelopes","type","speed","feedbacks","indices","spectrumNoiseLength","spectrumBasePitch","spectrumControlPoints","spectrumControlPointsPerOctave","spectrumControlPointBits","spectrumMax","harmonicsControlPoints","harmonicsRendered","harmonicsRenderedForPickedString","harmonicsControlPointBits","harmonicsMax","harmonicsWavelength","supersawVoiceCount","supersawDynamismMax","supersawSpreadMax","supersawShapeMax","pitchChannelCountMin","pitchChannelCountMax","noiseChannelCountMin","noiseChannelCountMax","noiseInterval","pitchesPerOctave","drumCount","pitchOctaves","maxPitch","maximumTonesPerChannel","justIntonationSemitones","map","pitchShiftRange","pitchShiftCenter","detuneCenter","detuneMax","sineWaveLength","sineWaveMask","sineWave","generateSineWave","pickedStringDispersionCenterFreq","pickedStringDispersionFreqScale","pickedStringDispersionFreqMult","pickedStringShelfHz","stringSustainRange","stringDecayRate","enableAcousticSustain","sustainTypeNames","distortionRange","bitcrusherFreqRange","bitcrusherOctaveStep","bitcrusherQuantizationRange","maxEnvelopeCount","defaultAutomationRange","instrumentAutomationTargets","computeIndex","displayName","interleave","isFilter","maxCount","effect","compatibleInstruments","isMobile","test","navigator","userAgent","prettyNumber","toFixed","replace","EditorConfig","valueToPreset","presetValue","categoryIndex","presetIndex","presetCategories","presets","midiProgramToPresetValue","program","category","preset","generalMidi","midiProgram","nameToPresetValue","presetName","version","versionDisplayName","releaseNotesURL","isOnMac","platform","ctrlSymbol","ctrlName","customType","settings","eqFilter","transition","fadeInSeconds","chord","unison","cutoffHz","linearGain","vibrato","isNoise","filterCutoffHz","filterResonance","filterEnvelope","algorithm","feedbackType","feedbackAmplitude","operators","frequency","target","envelope","reverb","dynamism","shape","noteFilter","harmonics","stringSustain","stringSustainType","feedbackEnvelope","midiSubharmonicOctaves","interval","bitcrusherOctave","bitcrusherQuantization","distortion","chorus","spectrum","pulseEnvelope","drums","pitchShiftSemitones","applyElementArgs","element","args","args_1","__values","args_1_1","next","done","arg","Node","appendChild","document","createTextNode","Array","isArray","Symbol","iterator","__spread","constructor","Object","Element","_d","e_2","_e","key","setAttribute","join","console","warn","tagName","_f","e_3","_g","styleKey","style","setProperty","removeAttribute","svgNS","HTML","_i","arguments","createRange","createContextualFragment","SVG","fragment","createDocumentFragment","svgParser","DOMParser","parseFromString","documentElement","firstChild","importNode","name_1","createElement","_c","split","name_2","createElementNS","snakeCaseName","ColorConfig","getChannelColor","song","channel","pitchChannelCount","pitchChannels","noiseChannels","setTheme","theme","this","themes","undefined","_styleElement","textContent","themeColor","querySelector","getComputedStyle","getPropertyValue","marine","flame","amber","vermilion","pageMargin","editorBackground","hoverPreview","playhead","primaryText","secondaryText","invertedText","textSelection","boxSelectionFill","loopAccent","linkAccent","uiWidgetBackground","uiWidgetFocus","pitchBackground","tonic","fifthNote","whitePianoKey","blackPianoKey","secondaryChannel","primaryChannel","secondaryNote","primaryNote","head","scrollBarTest","body","div","clientWidth","classList","add","removeChild","Layout","setLayout","layout","_layoutMap","small","long","tall","button","h2","select","option","ThemePrompt","_doc","_themeSelect","_cancelButton","class","_okayButton","container","lastTheme","window","localStorage","getItem","_close","undo","cleanUp","removeEventListener","_saveChanges","_whenKeyPressed","event","keyCode","setItem","prompt","prefs","colorTheme","_previewTheme","notifier","changed","addEventListener","factor","countBits","n","isPowerOf2","round","log","fullArrayLength","totalPasses","pass","subStride","midSubStride","stride","radiansIncrement","cosIncrement","sinIncrement","oscillatorMultiplier","startIndex","startIndexA","midIndexA","startIndexB","midIndexB","stopIndex","realStartA","imagStartB","c","s","cPrev","sPrev","indexA0","indexA1","indexB0","indexB1","real0","real1","imag0","imag1","tempA","tempB","cTemp","sTemp","index1","index2","index3","imag2","imag3","bitCount","finalShift","j","reverseIndexBits","Deque","_capacity","_buffer","_mask","_offset","_count","pushFront","_expandCapacity","pushBack","popFront","popBack","peakFront","peakBack","count","set","get","remove","oldBuffer","size","FilterCoefficients","a","b","order","linearGain0thOrder","lowPass1stOrderButterworth","cornerRadiansPerSample","g","tan","a0","lowPass1stOrderSimplified","highPass1stOrderButterworth","highShelf1stOrder","shelfLinearGain","sqrtGain","allPass1stOrderInvertPhaseAbove","allPass1stOrderFractionalDelay","delay","lowPass2ndOrderButterworth","peakLinearGain","alpha","lowPass2ndOrderSimplified","feedback","highPass2ndOrderButterworth","highShelf2ndOrder","slope","A","Aplus","Aminus","sqrtA2Alpha","peak2ndOrder","bandWidthScale","bandWidth","FrequencyResponse","real","imag","denom","analyze","filter","radiansPerSample","analyzeComplex","realZ1","imagZ1","realNum","imagNum","realDenom","imagDenom","realZ","imagZ","imagTemp","magnitude","angle","atan2","DynamicBiquadFilter","a1","a2","b0","b1","b2","a1Delta","a2Delta","b0Delta","b1Delta","b2Delta","output1","output2","useMultiplicativeInputCoefficients","resetOutput","loadCoefficientsWithGradient","start","end","deltaRate","warpInfinityToNyquist","atan","epsilon","clamp","val","validateRange","base64IntToCharCode","base64CharCodeToInt","BitFieldReader","source","_bits","_readIndex","charCodeAt","read","readLongTail","minValue","minBits","numBits","readPartDuration","readLegacyPartDuration","readPinCount","readPitchInterval","BitFieldWriter","_index","clear","write","writeLongTail","writePartDuration","writePinCount","writePitchInterval","other","encodeBase64","buffer","lengthBase64","ceil","makeNotePin","time","Note","pitch","fadeout","pitches","pins","continuesLastPattern","pickMainInterval","longestFlatIntervalDuration","mainInterval","pinIndex","pinA","pinB","duration","loudestSize","pin","clone","newNote","getEndPinIndex","part","endPinIndex","Pattern","notes","instruments","cloneNotes","note","reset","toJsonObject","noteArray","pointArray","tick","pitchBend","volume","noteObject","points","patternObject","patternInstruments","fromJsonObject","importedPartsPerBeat","isNoiseChannel","instrumentCount","getMaxInstrumentsPerPatternForChannel","maxNoteCount","beatsPerBar","tickClock","k","indexOf","noteClock","startInterval","pointObject","lowestPitch","highestPitch","splice","Operator","SpectrumWave","hash","isHarmonic","markCustomWaveDirty","hashMult","Synth","fittingPowerOfTwo","point","SpectrumWaveState","_hash","getCustomWave","lowestOctave","pitchTweak","controlPointToOctave","floor","value1","value2","octave1","octave2","HarmonicsWave","HarmonicsWaveState","instrumentType","_generatedForType","combinedControlPointAmplitude","harmonicIndex","harmonicFreq","controlValue","normalizedValue","FilterControlPoint","freq","gain","freqSetting","gainSetting","getHz","getHzFromSettingValue","getSettingValueFromHz","hz","getRoundedSettingValueFromHz","getLinearGain","peakMult","power","neutral","interpolatedPower","getRoundedSettingValueFromLinearGain","toCoefficients","sampleRate","freqMult","getVolumeCompensationMult","octave","gainPow","freqRelativeTo8khz","warpedFreq","warpedOctave","distanceFromCenter","freqLoudness","FilterSettings","controlPoints","controlPointCount","addPoint","controlPoint","filterArray","filterObject","convertLegacySettings","legacyCutoffSetting","legacyResonanceSetting","legacyEnv","legacyFilterMaxRadians","asin","legacyFilterMax","resonant","firstOrder","cutoffAtMax","legacyFilterCutoffRange","envDecays","standardSampleRate","legacyHz","legacyRadians","extraOctaves","targetRadians","curvedHz","finalHz","finalRadians","legacyFilter","response","legacyFilterGainAtNewRadians","logGain","convertedGain","intendedGain","invertedGain","curvedRadians","legacyFilterGain","EnvelopeSettings","envelopeObject","Instrument","chipWave","chipNoise","envelopeCount","fadeIn","fadeOut","pitchShift","detune","pan","supersawDynamism","supersawSpread","supersawShape","bitcrusherFreq","echoSustain","echoDelay","harmonicsWave","drumsetEnvelopes","drumsetSpectrumWaves","spectrumWave","setTypeAndReset","legacySettings","filterCutoff","legacyFilterEnv","legacyPulseEnv","legacyOperatorEnvelopes","operatorEnvelopes","legacyFeedbackEnv","noCarriersControlledByNoteSize","allCarriersControlledByNoteSize","noteSizeControlsSomethingElse","addEnvelope","instrumentObject","getChord","detuneToCents","fadeInSettingToSeconds","fadeOutSettingToTicks","getDrumsetEnvelope","operatorArray","operator","legacyGlobalReverb","legacyEffectsNames","transitionProperty","binary","seamless","sudden","hard","smooth","soft","slide","secondsToFadeInSetting","ticksToFadeOutSetting","chordProperty","legacyChordNames","harmony","unisonProperty","legacyChorusNames","union","fifths","octaves","centsToDetune","vibratoProperty","legacyVibratoNames","isNaN","findIndex","legacyEnvelopeNames","custom","steady","getEnvelope","drum","legacyWaveNames","triangle","square","sawtooth","spiky","plateau","operatorObject","filterCutoffMaxHz","filterCutoffRange","filterResonanceRange","LN2","legacyToCutoff","legacyToEnvelope","filterNames","oldFilterNames","envelopeArray","tempEnvelope","frequencyFromPitch","supportsEnvelopeTarget","envelopeSettings","automationTarget","clearInvalidEnvelopeTargets","envelopeIndex","getTransition","getFadeInSeconds","getFadeOutTicks","Channel","patterns","bars","muted","Song","string","channels","fromBase64String","initToDefault","getChannelCount","noiseChannelCount","getMaxInstrumentsPerChannel","layeredInstruments","getMaxInstrumentsPerPattern","channelIndex","getChannelIsNoise","andResetChannels","scale","loopStart","loopLength","tempo","barCount","patternsPerChannel","pattern","instrument","bar","toBase64String","bits","_latestVersion","harmonicsBits","o","spectrumBits","neededBits","shapeBits","bitsPerNoteSize","getNeededBits","maxInstrumentsPerPattern","neededInstrumentCountBits","neededInstrumentIndexBits","octaveOffset","lastPitch","recentPitches","recentShapes","curPart","shapePart","startPitch","currentPitch","pitchBends","nextPitch","shapeString","String","fromCharCode","apply","shapeIndex","unshift","pop","allPitches","pitchIndex","pitchIter","stringLength","digits","prototype","maxApplyArgs","slice","_envelopeFromLegacyIndex","legacyIndex","compressed","charIndex","JSON","parse","substring","_oldestVersion","beforeThree","beforeFour","beforeFive","beforeSix","beforeSeven","beforeEight","beforeNine","legacySettingsCache","command","instrumentChannelIterator","instrumentIndexIterator","channelCount","instrumentsPerChannel","instrumentIndex","instrumentsFlagBits","legacyWaves","originalControlPointCount","sustainValue","legacyEffects","legacyEnvelopes","originalValue","byteCount","subStringLength","bitStringLength","bitStringLengthLength","newPattern","newNotes","noteCount","useOldShape","pinCount","initialSize","bendCount","pinObj","intervalIter","shift","enableIntro","loopCount","enableOutro","channelArray","instrumentArray","patternArray","sequenceArray","l","channelObject","sequence","format","_format","introBars","loopBars","ticksPerBeat","beatsPerMinute","jsonObject","oldScaleNames","enigma","scaleName","letter","charAt","toUpperCase","symbol","toLowerCase","C","D","E","F","G","B","maxInstruments","maxPatterns","maxBars","newPitchChannels","newNoiseChannels","instrumentObjects","getPattern","patternIndex","getBeatsPerMinute","maxValue","clz32","PickedString","delayLine","allPassG","allPassGDelta","sustainFilterA1","sustainFilterA1Delta","sustainFilterA2","sustainFilterA2Delta","sustainFilterB0","sustainFilterB0Delta","sustainFilterB1","sustainFilterB1Delta","sustainFilterB2","sustainFilterB2Delta","delayIndex","allPassSample","allPassPrevInput","sustainFilterSample","sustainFilterPrevOutput2","sustainFilterPrevInput1","sustainFilterPrevInput2","fractionalDelaySample","prevDelayLength","delayResetOffset","update","synth","instrumentState","tone","stringIndex","roundedSamplesPerTick","stringDecayStart","stringDecayEnd","sustainType","allPassCenter","samplesPerSecond","phaseDeltaStart","phaseDeltas","phaseDeltaScale","phaseDeltaScales","phaseDeltaEnd","radiansPerSampleStart","radiansPerSampleEnd","centerHarmonicStart","centerHarmonicEnd","allPassRadiansStart","allPassRadiansEnd","shelfRadians","decayCurveStart","decayCurveEnd","register","registerShelfCenter","registerLowpassCenter","decayRateStart","decayRateEnd","expressionDecayStart","expressionDecayEnd","tempFilterStartCoefficients","tempFrequencyResponse","allPassGStart","allPassPhaseDelayStart","tempFilterEndCoefficients","allPassGEnd","allPassPhaseDelayEnd","brightnessType","shelfGainStart","shelfGainEnd","cornerHardness","lowpass1stOrderCutoffRadiansStart","lowpass1stOrderCutoffRadiansEnd","lowpass2ndOrderCutoffRadiansStart","lowpass2ndOrderCutoffRadiansEnd","lowpass2ndOrderGainStart","lowpass2ndOrderGainEnd","sustainFilterA1Start","sustainFilterA2Start","sustainFilterB0Start","sustainFilterB1Start","sustainFilterB2Start","sustainFilterPhaseDelayStart","sustainFilterA1End","sustainFilterA2End","sustainFilterB0End","sustainFilterB1End","sustainFilterB2End","sustainFilterPhaseDelayEnd","periodLengthStart","periodLengthEnd","minBufferLength","delayLength","delayLengthEnd","delayLengthDelta","pitchChanged","abs","reinitializeImpulse","likelyMaximumLength","newDelayLine","oldDelayBufferMask","startCopyingFromIndex","delayBufferMask","startImpulseFrom","startZerosFrom","stopZerosAt","impulseWave","impulseWaveLength","impulsePhaseDelta","fadeDuration","startImpulseFromSample","stopImpulseAt","stopImpulseAtSample","impulsePhase","prevWaveIntegral","impulsePhaseInt","nextWaveIntegral","phaseRatio","sample","combinedFade","curvedFade","EnvelopeComputer","noteSecondsStart","noteSecondsEnd","noteTicksStart","noteTicksEnd","noteSizeStart","noteSizeEnd","prevNoteSize","nextNoteSize","_noteSizeFinal","prevNoteSecondsStart","prevNoteSecondsEnd","prevNoteTicksStart","prevNoteTicksEnd","_prevNoteSizeFinal","prevSlideStart","prevSlideEnd","nextSlideStart","nextSlideEnd","prevSlideRatioStart","prevSlideRatioEnd","nextSlideRatioStart","nextSlideRatioEnd","envelopeStarts","envelopeEnds","_modifiedEnvelopeIndices","_modifiedEnvelopeCount","lowpassCutoffDecayVolumeCompensation","computeEnvelopes","currentPart","tickTimeStart","secondsPerTick","atNoteStart","forceContinueAtStart","tickTimeEnd","beatsPerTick","beatTimeStart","beatTimeEnd","passedEndOfNote","startPin","endPin","startPinTick","endPinTick","ratioStart","ratioEnd","noteStartTick","noteStartPart","noteEndTick","noteEndPart","maximumSlideTicks","prevNote","nextNote","forceContinueAtEnd","usedNoteSize","targetIndex","envelopeStart","computeEnvelope","envelopeEnd","filterSettings","getLowpassCutoffDecayVolumeCompensation","clearEnvelopes","beats","noteSize","noteSizeToVolumeMult","attack","Tone","fill","chordSize","drumsetPitch","prevNotePitchIndex","nextNotePitchIndex","freshlyAllocated","isOnLastTick","ticksSinceReleased","liveInputSamplesHeld","lastInterval","noiseSample","phases","expressionDelta","operatorExpressions","operatorExpressionDeltas","prevPitchExpressions","prevVibrato","prevStringDecay","pulseWidthDelta","supersawDynamismDelta","supersawUnisonDetunes","supersawShapeDelta","supersawDelayLength","supersawDelayLengthDelta","supersawDelayLine","supersawDelayIndex","supersawPrevPhaseDelta","pickedStrings","noteFilters","noteFilterCount","initialNoteFilterInput1","initialNoteFilterInput2","specialIntervalExpressionMult","feedbackOutputs","feedbackMult","feedbackDelta","envelopeComputer","pickedString","InstrumentState","awake","computed","tonesAddedInThisTick","flushingDelayLines","deactivateAfterThisTick","attentuationProgress","flushedSamples","activeTones","releasedTones","liveInputTones","synthesizer","noisePitchFilterMult","eqFilterVolume","eqFilterVolumeDelta","mixVolume","mixVolumeDelta","delayInputMult","delayInputMultDelta","distortionDelta","distortionDrive","distortionDriveDelta","distortionFractionalInput1","distortionFractionalInput2","distortionFractionalInput3","distortionPrevInput","distortionNextOutput","bitcrusherPrevInput","bitcrusherCurrentOutput","bitcrusherPhase","bitcrusherPhaseDelta","bitcrusherPhaseDeltaScale","bitcrusherScale","bitcrusherScaleScale","bitcrusherFoldLevel","bitcrusherFoldLevelScale","eqFilters","eqFilterCount","initialEqFilterInput1","initialEqFilterInput2","panningDelayLine","panningDelayPos","panningVolumeL","panningVolumeR","panningVolumeDeltaL","panningVolumeDeltaR","panningOffsetL","panningOffsetR","panningOffsetDeltaL","panningOffsetDeltaR","chorusDelayLineL","chorusDelayLineR","chorusDelayLineDirty","chorusDelayPos","chorusPhase","chorusVoiceMult","chorusVoiceMultDelta","chorusCombinedMult","chorusCombinedMultDelta","echoDelayLineL","echoDelayLineR","echoDelayLineDirty","echoDelayPos","echoDelayOffsetStart","echoDelayOffsetEnd","echoDelayOffsetRatio","echoDelayOffsetRatioDelta","echoMult","echoMultDelta","echoShelfA1","echoShelfB0","echoShelfB1","echoShelfSampleL","echoShelfSampleR","echoShelfPrevInputL","echoShelfPrevInputR","reverbDelayLine","reverbDelayLineDirty","reverbDelayPos","reverbMult","reverbMultDelta","reverbShelfA1","reverbShelfB0","reverbShelfB1","reverbShelfSample0","reverbShelfSample1","reverbShelfSample2","reverbShelfSample3","reverbShelfPrevInput0","reverbShelfPrevInput1","reverbShelfPrevInput2","reverbShelfPrevInput3","allocateNecessaryBuffers","samplesPerTick","panningDelayBufferSize","chorusDelayBufferSize","safeEchoDelaySteps","safeEchoDelayBufferSize","newDelayLineL","newDelayLineR","oldMask","deactivate","resetAllEffects","compute","getInstrumentSynthFunction","updateWaves","usesDistortion","usesBitcrusher","usesPanning","usesChorus","usesEcho","usesReverb","distortionSliderStart","distortionSliderEnd","distortionStart","distortionEnd","distortionDriveStart","distortionDriveEnd","freqSettingStart","freqSettingEnd","quantizationSettingStart","quantizationSettingEnd","freqStart","freqEnd","scaleStart","scaleEnd","foldLevelStart","foldLevelEnd","eqFilterSettings","mainInstrumentVolume","instrumentVolumeToVolumeMult","mixVolumeEnd","eqFilterVolumeStart","eqFilterVolumeEnd","delayInputMultStart","delayInputMultEnd","panStart","panEnd","volumeStartL","volumeStartR","volumeEndL","volumeEndR","maxDelaySamples","delayStart","delayEnd","delayStartL","delayStartR","delayEndL","delayEndR","chorusStart","chorusEnd","chorusCombinedMultStart","chorusCombinedMultEnd","maxEchoMult","averageEchoDelaySeconds","echoMultStart","echoMultEnd","echoDelayOffset","maxReverbMult","reverbStart","reverbEnd","totalDelaySamples","attenuationThreshold","halfLifeMult","delayDuration","attenuationPerSecond","averageMult","averageReverbDelaySeconds","progressInTick","progressAtEndOfTick","_drumsetIndexToSpectrumOctave","getDrumsetWave","drumsetIndexReferenceDelta","ChannelState","singleSeamlessInstrument","syncSongState","channelState","warmUpSynthesizer","getSamplesPerTick","operatorAmplitudeCurve","playing","isPlayingSong","recording","isRecording","playheadInternal","remainder","beat","tickSampleCountdown","isAtStartOfTick","prevBar","getSamplesPerBar","getTicksIntoBar","getCurrentPart","getTotalBars","loopRepeatCount","preferLowerLatency","anticipatePoorPerformance","liveInputDuration","liveInputStarted","liveInputPitches","liveInputChannel","liveInputInstruments","enableMetronome","countInMetronome","nextBar","liveInputEndTime","browserAutomaticallyClearsAudioBuffer","tempDrumSetControlPoint","tonePool","tempMatchedPitchTones","startedMetronome","metronomeSamplesRemaining","metronomeAmplitude","metronomePrevAmplitude","metronomeFilter","limit","tempMonoInstrumentSampleBuffer","audioCtx","scriptNode","audioProcessCallback","audioProcessingEvent","outputBuffer","outputDataL","getChannelData","outputDataR","performance","now","deactivateAudio","synthesize","computeDelayBufferSizes","setSong","panningDelayBufferMask","chorusDelayBufferMask","activateAudio","bufferSize","latencyHint","AudioContext","webkitAudioContext","createScriptProcessor","createJavaScriptNode","onaudioprocess","channelCountMode","channelInterpretation","connect","destination","resume","disconnect","close","maintainLiveInput","play","pause","startRecording","snapToStart","snapToBar","goToBar","resetEffects","freeAllTones","jumpIntoLoop","oldBar","goToNextBar","goToPrevBar","getNextBar","outputBufferLength","playSong","ended","limitDecay","limitRise","bufferIndex","samplesLeftInBuffer","samplesLeftInTick","runLength","runEnd","determineCurrentActiveTones","determineLiveInputTones","tonesPlayedInThisInstrument","freeReleasedTone","shouldFadeOutFast","computeTone","playTone","effectsSynth","midBeat","periods","samplesPerPeriod","tempAmplitude","sampleL","sampleR","limitedVolume","Number","isFinite","freeTone","newTone","releaseTone","toneIndex","toneList","toneCount","moveTonesIntoOrderedTempMatchedList","clearTempMatchedPitchTones","adjacentPatternHasCompatibleInstrumentTransition","otherPattern","otherNote","forceContinue","otherInstrument","otherTransition","adjacentNotesHaveMatchingPitches","firstNote","secondNote","firstNoteInterval","notePitches","currentTick","newInstrumentIndex","sourceInstrumentState","destInstrumentState","prevNoteForThisInstrument","nextNoteForThisInstrument","partsPerBar","tonesInPrevNote","tonesInNextNote","prevPattern","lastNote","patternForcesContinueAtStart","chordOfCompatibleInstrument","nextPattern","nextPatternForcesContinueAtStart","oldTone","strumOffsetParts","prevNoteForThisTone","noteForThisTone","nextNoteForThisTone","computeChordExpression","released","chordExpression","intervalScale","secondsPerPart","sampleTime","beatsPerPart","ticksIntoBar","partTimeStart","partTimeEnd","specialIntervalMult","toneIsOnLastTick","intervalStart","intervalEnd","fadeExpressionStart","fadeExpressionEnd","chordExpressionStart","chordExpressionEnd","expressionReferencePitch","baseExpression","pitchDamping","startTicksSinceReleased","endTicksSinceReleased","pinStart","pinEnd","noteTicksPassedTickStart","noteTicksPassedTickEnd","pinRatioStart","pinRatioEnd","noteLengthTicks","intervalDiff","chordSizeDiff","vibratoAmplitude","vibratoStart","getLFOAmplitude","ticksUntilVibratoStart","vibratoEnd","ticksUntilVibratoEnd","noteFilterExpression","noteFilterSettings","noteAllFreqsEnvelopeStart","noteAllFreqsEnvelopeEnd","noteFreqEnvelopeStart","noteFreqEnvelopeEnd","notePeakEnvelopeStart","notePeakEnvelopeEnd","drumsetFilterEnvelope","drumsetFilterEnvelopeStart","drumsetFilterEnvelopeEnd","sineExpressionBoost","totalCarrierExpression","arpeggioInterval","associatedCarrierIndex","pitchStart","pitchEnd","baseFreqStart","baseFreqEnd","targetFreqStart","targetFreqEnd","freqEnvelopeStart","freqEnvelopeEnd","amplitudeCurve","amplitudeMult","expressionStart","expressionEnd","pitchExpressionStart","pitchExpressionEnd","feedbackStart","feedbackEnd","freqEndRatio","basePhaseDeltaScale","intervalOffset","endPitch","settingsExpressionMult","basePulseWidth","pulseWidthStart","pulseWidthEnd","startFreq","voiceCountExpression","unisonEnvelopeStart","unisonEnvelopeEnd","unisonAStart","unisonAEnd","unisonBStart","unisonBEnd","supersawExpressionStart","supersawExpressionEnd","minFirstVoiceAmplitude","baseDynamismSlider","curvedDynamismStart","curvedDynamismEnd","firstVoiceAmplitudeStart","firstVoiceAmplitudeEnd","dynamismStart","dynamismEnd","initializeSupersaw","accumulator","normalizedPhase","zeroCrossingPhase","prevDrop","nextDrop","phaseDelta","distanceToZeroCrossing","swappedIndex","baseSpreadSlider","averageSpreadSlider","curvedSpread","baseShape","shapeStart","shapeEnd","delayLengthStart","pulseExpressionRatio","sustainEnvelopeStart","sustainEnvelopeEnd","secondsIntoBar","vibratoPeriodSeconds","fingerprint","fmSynthFunctionCache","synthSource","line","fmSourceTemplate","outputs","operatorLine","operatorSourceTemplate","modulators","modulatorNumber","feedbackIndices","wrappedFmSynth","Function","chipSynth","harmonicsSynth","pulseWidthSynth","supersawSynth","pickedStringSynth","noiseSynth","spectrumSynth","drumsetSynth","data","unisonSign","phaseDeltaA","phaseDeltaB","phaseDeltaScaleA","phaseDeltaScaleB","phaseA","phaseB","filters","filterCount","initialFilterInput1","initialFilterInput2","applyFilters","phaseAInt","phaseBInt","indexA","indexB","phaseRatioA","phaseRatioB","prevWaveIntegralA","prevWaveIntegralB","sampleIndex","nextWaveIntegralA","nextWaveIntegralB","waveA","waveB","inputSample","output","sanitizeFilters","voiceCount","pickedStringFunction","pickedStringFunctionCache","pickedStringSource","sampleList","voice","lines","usesEqFilter","signature","effectsFunction","effectsFunctionCache","effectsSource","usesDelays","phase","sawPhaseA","sawPhaseB","pulseWave","t","dynamismDelta","unisonDetunes","shapeDelta","supersawSample","detunedPhaseDelta","delaySampleTime","lowerIndex","upperIndex","delayRatio","prevDelaySample","phaseMask","pitchRelativefilter","findRandomZeroCrossing","phaseInt","waveSample","referenceDelta","indexPrev","wavePrev","attemptsRemaining","indexNext","waveNext","innerIndexNext","innerWaveNext","instrumentVolume","volumeMultToInstrumentVolume","volumeMult","volumeMultToNoteSize","setting","seconds","ticks","lower","upper","cents","beatsPerSecond","partsPerSecond","tickPerSecond","sanitizeDelayLine","lastIndex","mask","input1","input2","p","TipPrompt","message","_closeButton","setTimeout","focus","Change","_noop","_didSomething","isNoop","commit","UndoableChange","reversed","super","_reversed","_doneForwards","_doForwards","_doBackwards","redo","_isDoneForwards","ChangeGroup","append","change","ChangeSequence","changes","_changes","patternsContainSameInstruments","pattern1Instruments","pattern2Instruments","pattern2Has1Instruments","every","pattern1Has2Instruments","discardInvalidPatternInstruments","uniqueInstruments","Set","unionOfUsedNotes","removeRedundantPins","prevPin","nextPin","prevTimeSpan","nextTimeSpan","projectNoteIntoBar","oldNote","timeOffset","newNoteLength","newPinTime","nextPinTime","ratio","prevPinTime","offsetInterval","pitchIdx","pinIdx","joinedWithPrevNote","newIntervalOffset","newTimeOffset","tempPin","transformedPin","ChangeMoveAndOverflowNotes","doc","newBeatsPerBar","partsToMove","oldChannel","newChannel","oldPartsPerBar","newPartsPerBar","currentBar","oldPattern","oldBarStart","absoluteNoteStart","absoluteNoteEnd","startBar","endBar","barStartPart","removeDuplicatePatterns","ChangeReplacePatterns","ChangePins","_note","_oldStart","_oldEnd","_newStart","_newEnd","_oldPins","_newPins","_oldPitches","_newPitches","_oldContinuesLastPattern","_newContinuesLastPattern","_finishSetup","firstInterval","firstTime","ChangeCustomizeInstrument","getCurrentInstrument","ChangePreset","newValue","tempVolume","tempPan","ChangeRandomGeneratedInstrument","selectWeightedRandom","entries","total","entry","weight","item","selectCurvedDistribution","peak","width","PotentialFilterPoint","chance","minFreq","maxFreq","centerHz","centerGain","applyFilterPoints","potentialPoints","usedFreqs","potentialPoint","includes","midFreq","normalize","spectrumGenerators","current","generator","harmonicGenerators","ChangeTransition","ChangeToggleEffects","toggleFlag","oldValue","wasSelected","ChangePatternNumbers","startChannel","height","ChangeBarCount","atBeginning","diff","barScrollPos","ChangeInsertBars","newLength","ChangeDeleteBars","ChangeChannelOrder","selectionMin","selectionMax","ChangeChannelCount","newPitchChannelCount","newNoiseChannelCount","newChannels","changeGroup","newCount","oldCount","newStart","oldStart","pickRandomPresetValue","ChangeAddChannel","addedChannelIndex","ChangeRemoveChannel","minIndex","maxIndex","ChangeChannelBar","newBar","silently","selection","scrollToSelectedPattern","ChangeUnison","ChangeChord","ChangeVibrato","ChangeSpectrum","ChangeHarmonics","ChangeDrumsetEnvelope","drumIndex","ChangeInstrumentSlider","_instrument","ChangePulseWidth","ChangeSupersawDynamism","ChangeSupersawSpread","ChangeSupersawShape","ChangePitchShift","ChangeDetune","ChangeDistortion","ChangeBitcrusherFreq","ChangeBitcrusherQuantization","ChangeStringSustain","ChangeStringSustainType","ChangeFilterAddPoint","isNoteFilter","deletion","_envelopeTargetsAdd","_envelopeIndicesAdd","_envelopeTargetsRemove","_envelopeIndicesRemove","_instrumentNextPreset","_instrumentPrevPreset","_filterSettings","_point","ChangeFilterMovePoint","oldFreq","newFreq","oldGain","newGain","_oldFreq","_newFreq","_oldGain","_newGain","ChangeFadeInOut","_oldFadeIn","_oldFadeOut","_newFadeIn","_newFadeOut","ChangeAlgorithm","ChangeFeedbackType","ChangeOperatorFrequency","operatorIndex","ChangeOperatorAmplitude","ChangeFeedbackAmplitude","ChangeAddChannelInstrument","viewedInstrument","ChangeRemoveChannelInstrument","removedIndex","ChangeViewInstrument","ChangeInstrumentsFlags","newLayeredInstruments","newPatternInstruments","oldLayeredInstruments","oldPatternInstruments","ChangeKey","ChangeLoop","oldLength","ChangePitchAdded","_pitch","ChangeOctave","ChangeRhythm","ChangePaste","selectionStart","selectionEnd","oldPartDuration","ChangeNoteTruncate","noteInsertionIndex","noteStart","noteEnd","ChangeNoteLength","ChangePasteInstrument","instrumentCopy","ChangeSetPatternInstruments","ChangePatternsPerChannel","channelBars","channelPatterns","ChangeEnsurePatternExists","_patternOldNotes","_oldPatternInstruments","_bar","_channelIndex","_oldPatternCount","_newPatternCount","_newPatternInstruments","recentPatternInstruments","firstEmptyUnusedIndex","firstUnusedIndex","used","barIndex","_patternIndex","ChangePinTime","shiftedTime","originalTime","skipStart","skipEnd","setPin","oldPin","ChangePitchBend","bendStart","bendEnd","bendTo","direction","stop","setStart","setEnd","prevInterval","prevSize","persist","ChangePatternRhythm","minDivision","changeRhythm","oldTime","thresholds","beatStart","newTime","threshold","ChangeNoteAdded","ChangeRhythmNote","ChangeMoveNotesSideways","beatsToMove","strategy","originalBarCount","originalLoopStart","originalLoopLength","firstBarIsEmpty","ChangeBeatsPerBar","noteIndex","ChangeTempo","ChangeScale","ChangeDetectKey","keyWeights","bestKey","bestKeyWeight","keyWeight","absoluteDiff","ChangeTranspose","eligiblePresetValues","setDefaultInstruments","ChangeSong","newHash","ChangePatternSelection","resetBoxSelection","defaultScale","ChangeValidateTrackSelection","removeExtraSparseChannels","maxLength","sparsestIndex","mostZeroes","zeroes","combinedChannels","comparePatternNotes","newPatterns","foundMatchingPattern","newPatternIndex","ChangeEchoDelay","ChangeEchoSustain","ChangeChorus","ChangeReverb","_pattern","truncStart","truncEnd","pushLastPin","skipNote","copy","ChangeSplitNotesAtSelection","patternSelectionStart","patternSelectionEnd","ChangeTransposeNote","upward","ignoreScale","foundMatch","patternSelectionActive","ChangeTrackSelection","newX0","newX1","newY0","newY1","boxSelectionX0","boxSelectionX1","boxSelectionY0","boxSelectionY1","newEnd","_oldActive","_newActive","ChangeDragSelectedNotes","parts","transpose","oldEnd","draggedNotes","notesOutsideScale","ChangeDuplicateSelectedReusedPatterns","barStart","barWidth","channelStart","channelHeight","reusablePatterns","currentPatternIndex","isUsedElsewhere","bar2","copiedPattern","ChangePatternScale","scaleMap","newPitches","newPins","transformedPitch","transformedInterval","ChangeVolume","ChangePan","ChangeSizeBend","bendPart","bendSize","bendInterval","uniformSize","inserted","ChangeChipWave","ChangeNoiseWave","ChangeAddEnvelope","ChangeRemoveEnvelope","ChangeSetEnvelopeTarget","oldTarget","oldIndex","ChangeSetEnvelopeType","PatternCursor","valid","curNote","curIndex","exactPart","nearPinIndex","PatternEditor","_interactive","_barOffset","_svgNoteBackground","id","patternUnits","_svgDrumBackground","_svgBackground","rect","_svgNoteContainer","svg","_svgPlayhead","_selectionRect","stroke","visibility","_svgPreview","path","_svg","defs","_backgroundPitchRows","_backgroundDrumRow","_pitchHeight","_mouseX","_mouseY","_mouseDown","_mouseOver","_mouseDragging","_mouseHorizontal","_usingTouch","_copiedPinChannels","_mouseXStart","_mouseYStart","_ctrlHeld","_shiftHeld","_touchTime","_draggingStartOfSelection","_draggingEndOfSelection","_draggingSelectionContents","_dragTime","_dragPitch","_dragSize","_dragVisible","_dragChange","_changePatternSelection","_lastChangeWasPatternSelection","_cursor","_playheadX","_octaveOffset","_renderedWidth","_renderedHeight","_renderedBeatWidth","_renderedPitchHeight","_renderedFifths","_renderedDrums","_renderedRhythm","_renderedPitchChannelCount","_renderedNoiseChannelCount","_followPlayheadBar","resetCopiedPins","maxDivision","_getMaxDivision","_animatePlayhead","timestamp","lastChangeWas","_whenCursorPressed","notifyWatchers","playheadBar","modPlayhead","_editorWidth","autoFollow","currentPatternIsDirty","_redrawNotePatterns","requestAnimationFrame","_whenMouseOver","_whenMouseOut","_whenMousePressed","preventDefault","boundingRect","getBoundingClientRect","clientX","pageX","left","right","clientY","pageY","top","_editorHeight","bottom","ctrlKey","metaKey","shiftKey","_whenTouchPressed","touches","_whenMouseMoved","_whenCursorMoved","_whenTouchMoved","_whenCursorReleased","continuousState","record","_setPatternSelection","_copyPins","enableNotePreview","setTemporaryPitches","_updateCursorStatus","_updatePreview","rectangle","display","_getMaxPitch","rhythmStepsPerBeat","_getMinDivision","_snapToMinDivision","input","_partWidth","mousePitch","_findMousePitch","error","leftSide","rightSide","intervalRatio","arc","bendHeight","minInterval","MAX_VALUE","maxInterval","bestDistance","pinDistance","_snapToPitch","nearest","distance","defaultLength","_copiedPins","fullBeats","modMouse","division","forceStart","forceEnd","_cursorIsInSelection","_cursorAtStartOfSelection","_cursorAtEndOfSelection","pixelY","_pitchCount","guess","topPitch","bottomPitch","topRange","bottomRange","movePlayheadToMouse","setProspectiveChange","getCurrentPattern","_updateSelection","dx","dy","notesInScale","pitchRatio","draggedParts","draggedTranspose","backwards","directLength","blessedLength","theNote","shiftedPin","sizeRatio","minPitch","hasRedoHistory","_pitchToPixelHeight","radius","pathString","sizeMax","center","_drawNote","render","clientHeight","getVisiblePitchCount","getBaseVisibleOctave","beatWidth","showFifth","node","cloneNode","parentNode","replaceChild","makeEmptyReplacementElement","showChannels","pattern2","notePath","displayNumberedChords","indicatorOffset","arrowHeight","arrowPath","arrow","oscillatorLabel","text","svgElement","showSize","totalWidth","endOffset","prevSide","nextSide","prevHeight","nextHeight","nextSize","EnvelopeEditor","_rows","_targetSelects","_envelopeSelects","_deleteButtons","_renderedEnvelopeCount","_renderedEqFilterCount","_renderedNoteFilterCount","_renderedEffects","_onChange","targetSelectIndex","envelopeSelectIndex","combinedValue","parseInt","selectedIndex","_onClick","_makeOption","_updateTargetOptionVisibility","menu","optionIndex","childElementCount","children","hidden","alwaysShowSettings","targetSelect","interleaved","envelopeSelect","deleteButton","row","_renderedInstrumentType","FadeInOutEditor","_fadeCurve","_dottedLinePath","_controlCurve","viewBox","preserveAspectRatio","_draggingFadeIn","_renderedFadeIn","_renderedFadeOut","offsetParent","_xToFadeIn","_xToFadeOut","dottedLineX","_fadeOutToX","_fadeInToX","fadeInX","fadeOutX","fadePath","FilterEditor","useNoteFilter","_responsePath","_controlPointPath","_highlight","circle","r","_label","_pointRadius","_useNoteFilter","_touchMode","_addingPoint","_deletingPoint","_addedType","_selectedIndex","_freqStart","_gainStart","_renderedSelectedIndex","_renderedPointCount","_renderedPointTypes","_renderedPointFreqs","_renderedPointGains","_updatePath","_updateCursor","_xToFreq","_freqToX","_yToGain","_gainToY","nearestDistance","POSITIVE_INFINITY","_findNearestFreqSlot","freqDelta","gainDelta","targetFreq","ignoreIndex","roundedFreq","lowerFreq","upperFreq","tryingLower","foundConflict","currentFreq","_circlePath","cx","cy","reverse","controlPointPath","dottedLinePath","pointX","pointY","responsePath","pointTypes","pointFreqs","pointGains","Box","color","_text","ChannelRow","patternHeight","_renderedIndex","background","setWidth","setIndex","selected","_renderedBarWidth","_boxes","getBarWidth","box","dim","colors","MuteEditor","_cornerFiller","_buttons","enableChannelMuting","muteButton","title","TrackEditor","_channelRowContainer","_playhead","_boxHighlight","_upHighlight","_downHighlight","_select","_channels","_mouseStartBar","_mouseStartChannel","_mouseBar","_mouseChannel","_mousePressed","_barWidth","_renderedEditorWidth","_renderedEditorHeight","_renderedPatternCount","_renderedPlayhead","_whenSelectChanged","setPattern","_whenSelectPressed","_updateSelectPos","_whenSelectMoved","_dragBoxSelection","_whenSelectReleased","_updateMousePos","setTrackSelection","selectionUpdated","setChannelBar","_whenMouseReleased","up","patternCount","determinedCursorType","middle","base","tip","lastChild","selectedPattern","channelRow","editorWidth","editorHeight","boxSelectionActive","boxSelectionBar","boxSelectionChannel","boxSelectionWidth","boxSelectionHeight","label","form","LayoutPrompt","_fileInput","accept","_form","_confirm","elements","save","LoopEditor","_startMode","_endMode","_bothMode","_loop","_change","mode","_clientStartX","_clientStartY","_startedScrolling","_draggingHorizontally","_renderedLoopStart","_renderedLoopStop","_renderedBarCount","_whenTouchReleased","_render","_documentChanged","watch","_findEndPoints","endPoints","showHighlight","highlightStart","highlightStop","loopStop","SpectrumEditor","_spectrumIndex","_fill","_octaves","_fifths","_curve","_arrow","_freqPrev","_ampPrev","_renderedPath","_yToAmp","amp","controlPointToHeight","lastValue","nextValue","lastHeight","HarmonicsEditor","_lastControlPoints","_lastControlPointContainer","xPos","BarScrollBar","_notches","_handle","_handleHighlight","_leftHighlight","_rightHighlight","_dragging","_renderedNotchCount","_renderedScrollBarPos","_notchSpace","trackVisibleBars","_dragStart","showleftHighlight","showRightHighlight","showHandleHighlight","resized","lineHeight","OctaveScrollBar","_notchHeight","_octaveCount","_octaveHeight","_renderedBarBottom","_renderedVisibleOctaveCount","_barBottom","_barHeight","visibleOctaveCount","getVisibleOctaveCount","scrollableOctaves","canReplaceLastChange","currentOctave","showUpHighlight","showDownHighlight","defaultMidiPitchBend","analogousDrumMap","midiVolumeToVolumeMult","toString","MidiInputHandler","_takeMidiHandlerFocus","_handleStateChange","port","state","_registerMidiInput","_unregisterMidiInput","midiInput","_onMidiMessage","clearAllPitches","enableMidi","isDrum","eventType","velocity","addPerformedPitch","removePerformedPitch","registerMidiAccessHandler","requestMIDIAccess","midiAccess","inputs","forEach","e","KeyboardLayout","keyPosToPitch","keyboardLayout","pitchOffset","forcedKey","scaleIndices","flag","_pianoAtC","_pianoAtA","keyOffset","_possiblyPlayingPitchesFromKeyboard","_onWindowBlur","handleKeyEvent","pressed","code","handleKey","Piano","_pianoContainer","_drumContainer","_preview","_pianoKeys","_pianoLabels","_playedPitch","_renderedScale","_renderedKey","_renderedPitchCount","_renderedLiveInputPitches","_updateCursorPitch","_playLiveInput","_releaseLiveInput","_onAnimationFrame","liveInputChanged","liveInputPitchCount","pitchesAreTemporary","showLetters","innerHTML","pianoLabel","pianoKey","pitchNameIndex","getPitchName","_cursorPitch","pitchHeight","child","scaleIndex","shiftDir","span","br","BeatsPerBarPrompt","_beatsStepper","step","_conversionStrategySelect","_validateKey","_validateNumber","_validate","lastStrategy","charCode","which","MoveNotesSidewaysPrompt","SongDurationPrompt","_barsStepper","_positionSelect","group","lastPosition","SustainPrompt","_typeSelect","ChannelSettingsPrompt","_patternsStepper","_pitchChannelStepper","_drumChannelStepper","_layeredInstrumentsBox","_patternInstrumentsBox","checked","transfer","dest","ArrayBuffer","nextOffset","leftBytes","byteLength","wordSizes","wordSize","transferWith","ViewClass","Uint8Array","Float64Array","Uint16Array","view_source","view_dest","byteOffset","ArrayBufferWriter","initialCapacity","_writeIndex","_fileSize","_arrayBuffer","_data","DataView","_addBytes","numBytes","getWriteIndex","rewriteUint32","setUint32","writeUint32","writeUint24","setUint8","writeUint16","setUint16","writeUint8","writeInt8","setInt8","writeMidi7Bits","writeMidiVariableLength","startWriting","writeMidiAscii","toCompactArrayBuffer","lerp","low","high","blob","msSaveOrOpenBlob","anchor","download","url","URL","createObjectURL","revokeObjectURL","href","dispatchEvent","MouseEvent","open","location","ExportPrompt","_fileName","maxlength","autofocus","_enableIntro","_loopDropDown","_enableOutro","_formatSelect","_exportButton","_validateFileName","_export","_exportToWav","_exportToMp3","_exportToMidi","_exportToJson","_exportToHtml","disabled","lastExportFormat","deleteChars","cursorPos","setSelectionRange","_synthesize","introIter","sampleFrames","recordedSamplesL","recordedSamplesR","sampleCount","arrayBuffer","bytesPerSample","range","valL","valR","setInt16","Blob","trim","whenEncoderIsAvailable","sampleBlockSize","mp3encoder","Mp3Encoder","mp3Data","Int16Array","leftChunk","subarray","rightChunk","mp3buf","encodeBuffer","flush","script","src","onload","midiTicksPerBeat","midiTicksPerPart","microsecondsPerBeat","secondsPerMinute","midiTicksPerBar","pitchBendRange","unrolledBars","loopIndex","tracks","isMeta","midiChannel","isDrumset","midiChannelCounter","foundADrumset","writer","track","trackStartIndex","prevTime","barStartTime","writeEventTime","writeControlEvent","isMinor","numSharps","channelName","prevInstrumentIndex","writeInstrumentSettings","instrumentProgram","midiChipInstruments","instrumentPan","prevPitchBend","prevExpression","shouldResetExpressionAndPitchBend","channelRoot","usesArpeggio","polyphony","noteStartTime","pinTime","pinSize","pinInterval","prevPitches","nextPitches","maxPitchOffset","minPitchOffset","nextPinSize","nextPinInterval","midiTick","midiTickTime","linearSize","noteStarting","drumsetMap","midiTicksSinceBeat","midiTicksPerArpeggio","noteEndTime","jsonString","stringify","fileContents","ArrayBufferReader","getReadIndex","readUint32","getUint32","readUint24","readUint8","readUint16","getUint16","getUint8","readInt8","getInt8","peakUint8","readMidi7Bits","readMidiVariableLength","nextByte","skipBytes","hasMore","getReaderForNextBytes","ImportPrompt","_whenFileSelected","file","files","extension","lastIndexOf","reader","FileReader","goBackToStart","readAsText","_parseMidiFile","readAsArrayBuffer","headerReader","chunkType","chunkLength","trackReader","nextEventMidiTick","runningStatus","fileFormat","currentIndependentTrackIndex","currentTrackIndices","independentTracks","trackIndex","channelRPNMSB","channelRPNLSB","pitchBendRangeMSB","pitchBendRangeLSB","currentInstrumentProgram","currentInstrumentVolumes","currentInstrumentPans","noteEvents","pitchBendEvents","noteSizeEvents","currentMidiTick","anyTrackHasMore","eventStatus","eventChannel","foundTrackEndEvent","on","lsb","numerator","denominatorExponent","songTotalBars","quantizeMidiTickToPart","channelPresetValue","channelPreset","isDrumsetChannel","channelBasePitch","midiIntervalScale","channelMaxPitch","currentVelocity","currentProgram","currentInstrumentVolume","currentInstrumentPan","heldPitches","prevEventPart","setInstrumentVolume","noteEventIndex","noteEvent","nextEventPart","MAX_SAFE_INTEGER","drumFreqs","minDuration","maxDuration","heldPitch","currentMidiInterval","currentMidiNoteSize","pitchBendEventIndex","noteSizeEventIndex","updateCurrentMidiInterval","updateCurrentMidiNoteSize","instrumentByProgram","prevEventMidiTick","pitchSum","createdNote","barStartMidiTick","barEndMidiTick","noteStartMidiTick","noteEndMidiTick","shiftedHeldPitch","initialBeepBoxPitch","heldPitchOffset","firstPin","potentialPins","keyPitch","keySize","prevPinIndex","prevPartPitch","prevPartSize","noteRelativePart","lastPart","partPitch","partSize","nearestPitch","pitchIsNearInteger","pitchCrossedInteger","nearestSize","sizeIsNearInteger","sizeCrossedInteger","currentPin","addPin","addPinAtIndex","furthestIntervalDistance","addIntervalPin","addIntervalPinAtIndex","potentialIndex","potentialPin","interpolatedInterval","furthestSizeDistance","addSizePin","addSizePinAtIndex","interpolatedSize","toBePinned","lastToBePinned","notePin","shiftedPitch","averagePitch","compactChannels","bestChannelIndexA","bestChannelIndexB","fewestConflicts","fewestGaps","channelIndexA","channelIndexB","channelA","channelB","conflicts","gaps","channelAInstrumentCount","channelAPatternCount","some","versionPrefix","keyToVersion","versionToKey","generateUid","errorAlert","alert","compareSongs","versions","compareVersions","SongRecovery","_song","getAllRecoveredSongs","songs","songsByUid","itemKey","uid","sort","saveVersion","songData","Date","clearTimeout","_saveVersionTimeoutHandle","currentSong","newWork","mostRecentTime","work","newVersion","newKey","minSpan","spanMult","indexToDiscard","currentTime","newerTime","removeItem","leastImportantSong","leastImportance","maximumSongCount","timeScale","iframe","SongRecoveryPrompt","_songContainer","versionMenu","toLocaleString","player","contentWindow","Event","RecordingSetupPrompt","_keyboardMode","_keyboardLayout","_keyboardLayoutPreview","_enableMidi","_showRecordButton","_snapRecordedNotesToRhythm","_ignorePerformedNotesNotInScale","_metronomeCountIn","_metronomeWhileRecording","pressControlForShortcuts","showRecordButton","snapRecordedNotesToRhythm","ignorePerformedNotesNotInScale","metronomeCountIn","metronomeWhileRecording","_renderKeyboardLayoutPreview","rowLengths","rowIndex","spacer","colIndex","scalePitch","border","optgroup","buildOptions","items","buildPresetOptions","customTypeGroup","foundAny","setSelectedValue","stringValue","Slider","_getChange","_value","_oldValue","_whenInput","_whenChange","updateValue","SongEditor","_patternEditorPrev","_patternEditor","_patternEditorNext","_muteEditor","_trackEditor","_loopEditor","_octaveScrollBar","_piano","_playButton","_pauseButton","_recordButton","_stopButton","_prevBarButton","_nextBarButton","_volumeSlider","_fileMenu","_editMenu","_optionsMenu","_scaleSelect","_keySelect","_tempoSlider","_tempoStepper","_chorusSlider","_chorusRow","onclick","_openPrompt","_reverbSlider","_reverbRow","_echoSustainSlider","_echoSustainRow","_echoDelaySlider","_echoDelayRow","_rhythmSelect","_pitchedPresetSelect","_drumPresetSelect","_algorithmSelect","_algorithmSelectRow","_instrumentButtons","_instrumentAddButton","_instrumentRemoveButton","_instrumentsButtonBar","_instrumentsButtonRow","_instrumentCopyButton","_instrumentPasteButton","_instrumentCopyPasteRow","_instrumentVolumeSlider","_instrumentVolumeSliderRow","_panSlider","_panSliderRow","_chipWaveSelect","_chipNoiseSelect","_chipWaveSelectRow","_chipNoiseSelectRow","_fadeInOutEditor","_fadeInOutRow","_transitionSelect","_transitionRow","_effectsSelect","_eqFilterEditor","_eqFilterRow","_noteFilterEditor","_noteFilterRow","_supersawDynamismSlider","_supersawDynamismRow","_supersawSpreadSlider","_supersawSpreadRow","_supersawShapeSlider","_supersawShapeRow","_pulseWidthSlider","_pulseWidthRow","_pitchShiftSlider","_pitchShiftTonicMarkers","_pitchShiftFifthMarkers","_pitchShiftMarkerContainer","_pitchShiftRow","_detuneSlider","_detuneRow","_distortionSlider","_distortionRow","_bitcrusherQuantizationSlider","_bitcrusherQuantizationRow","_bitcrusherFreqSlider","_bitcrusherFreqRow","_stringSustainSlider","_stringSustainLabel","_stringSustainRow","_unisonSelect","_unisonSelectRow","_chordSelect","_chordSelectRow","_vibratoSelect","_vibratoSelectRow","_phaseModGroup","_feedbackTypeSelect","_feedbackRow1","_spectrumEditor","_spectrumRow","_harmonicsEditor","_harmonicsRow","_envelopeEditor","_drumsetGroup","_feedbackAmplitudeSlider","_feedbackRow2","_customizeInstrumentButton","_addEnvelopeButton","_customInstrumentSettingsGroup","_instrumentSettingsGroup","_promptContainer","_zoomInButton","_zoomOutButton","_patternEditorRow","_patternArea","_trackContainer","_trackVisibleArea","_trackAndMuteContainer","_barScrollBar","_trackArea","_menuArea","_songSettingsArea","_instrumentSettingsArea","_settingsArea","mainLayer","tabIndex","_wasPlaying","_currentPromptName","_highlightedInstrumentIndex","_renderedInstrumentCount","_renderedIsPlaying","_renderedIsRecording","_renderedShowRecordButton","_renderedCtrlHeld","_deactivatedInstruments","_operatorRows","_operatorAmplitudeSliders","_operatorFrequencySelects","_drumsetSpectrumEditors","_drumsetEnvelopeSelects","_refocusStage","preventScroll","_onFocusIn","whenUpdated","trackBounds","trackVisibleChannels","scrollLeft","scrollTop","channelScrollPos","showScrollBar","getFullScreen","targetBeatWidth","minBeatWidth","maxBeatWidth","patternEditorWidth","flexShrink","optionCommands","autoPlay","instrumentCopyPaste","displayBrowserUrl","wasActive","contains","activeElement","effectFlag","isCarrier","operatorName","marker","chordIndex","hasAttribute","maxInstrumentsPerChannel","instrumentButton","insertBefore","oldButton","_setPrompt","addedEffect","envButtonRect","instSettingsRect","settingsRect","addedEnvelope","scrollHeight","updatePlayButton","pointerEvents","opacity","_onTrackAreaScroll","_disableCtrlContextMenu","_tempoStepperCaptureNumberKeys","stopPropagation","_toggleRecord","needControlForShortcuts","getModifierState","canPlayNotes","_togglePlay","_copyInstrument","insertChannel","insertBars","deleteChannel","deleteBars","selectChannel","selectAll","duplicatePatterns","muteChannels","soloChannels","pasteNumbers","_pasteInstrument","pasteNotes","panningEffectIndex","_copyTextToClipboard","_randomGenerated","_randomPreset","swapChannels","scrollToEndOfSelection","nextDigit","instrumentDigits","_whenKeyReleased","_whenPrevBarPressed","_whenNextBarPressed","_setVolumeSlider","setVolume","_whenSetTempo","_whenSetScale","forceScale","_whenSetKey","_whenSetRhythm","forceRhythm","_whenSetPitchedPreset","_setPreset","_whenSetDrumPreset","_whenSetFeedbackType","_whenSetAlgorithm","_whenSelectInstrument","selectInstrument","_whenCustomizePressed","_whenSetChipWave","_whenSetNoiseWave","_whenSetTransition","_whenSetEffects","_whenSetVibrato","_whenSetUnison","_whenSetChord","_addNewEnvelope","_zoomIn","visibleOctaves","_zoomOut","_fileMenuHandler","share","encodeURIComponent","_editMenuHandler","_optionsMenuHandler","toggleDisplayBrowserUrl","operatorNumber","frequencySelect","amplitudeSlider","spectrumEditor","capture","passive","autoPlayOption","screen","availWidth","availHeight","layoutOption","promptName","openPrompt","clipboard","writeText","catch","textField","succeeded","execCommand","SongPerformance","_channelIsDrum","_channelOctave","_songKey","_pitchesAreTemporary","_recentlyAddedPitches","_songLengthWhenRecordingStarted","_playheadPart","_playheadPattern","_pitchesChanged","_lastNote","_recordingChange","_updateRecordedNotes","_lastBarHasPatterns","_getCurrentPlayheadPart","abortRecording","oldPart","oldPlayheadPart","newPart","dirty","startPart","endPart","addedAlreadyReleasedPitch","erasePatternInBar","recentPitch","recentIndex","Selection","_changeTranspose","_changeReorder","_changeTrack","_changeInstrument","toJSON","x0","x1","y0","y1","fromJSON","json","digit","forInstrument","parsed","insertIndex","_eachSelectedChannel","_eachSelectedPattern","_eachSelectedBar","handledPatterns","_parseCopiedInstrumentArray","patternCopy","from","_patternIndexIsUnused","patternNumber","channelCopy","selectionCopy","partDuration","channelCopies","copiedPartDuration","fillSelection","pasteHeight","pasteChannel","patternCopies","copiedBars","pasteWidth","usedPatterns","pasteBar","copiedPatternIndex","reusedIndex","instrumentsCopy","existingPattern","removedPattern","allChannels","anyMuted","anyUnmuted","invert","alreadySoloed","shouldBeMuted","scaleFlags","oldScaleFlags","newScaleValue","newScaleFlags","oldScale","newScale","largerToSmaller","smallerScale","largerScale","roles","bestScore","bestIndexMap","stack","indexMap","score","sparsePitchMap","smallerScalePitch","largerScalePitch","sparseIndex","fullPitchMap","oldLow","newLow","oldHigh","newHigh","nearestPitchDistance","newPitch","generateScaleMap","possibleSectionBoundaries","channelSectionMin","channelSectionMax","nextBoundary","newSelectionMin","newSelectionMax","maxLayers","Preferences","defaultVisibleOctaves","reload","ChangeNotifier","_watchers","_dirty","watcher","unwatch","SongDocument","_recovery","_recentChange","_sequenceNumber","_lastSequenceNumber","_stateShouldBePushed","_recordedNewSong","_waitingToUpdateState","_whenHistoryStateChanged","history","_resetSongRecoveryUid","canUndo","sequenceNumber","recoveryUid","_recoveryUid","_replaceState","_pushState","forgetLastChange","_getHistoryState","_getHash","_cleanDocument","_validateDocState","highlightedPattern","_updateHistoryState","sessionStorage","songString","_calcVolume","eventName","replaceState","pathname","pushState","currentIndex","oldestIndex","_maximumUndoHistory","_forward","forward","_back","back","newSong","barOffset","getMobileLayout","innerWidth","editor","getElementById","autoplay","scrollRestoration","serviceWorker","updateViaCache","scope"],"sources":["../synth/SynthConfig.ts","../editor/EditorConfig.ts","../node_modules/imperative-html/src/elements-base.ts","../node_modules/imperative-html/src/elements-strict.ts","../editor/ColorConfig.ts","../editor/style.ts","../editor/Layout.ts","../editor/ThemePrompt.ts","../synth/FFT.ts","../synth/Deque.ts","../synth/filtering.ts","../synth/synth.ts","../editor/TipPrompt.ts","../editor/Change.ts","../editor/changes.ts","../editor/PatternEditor.ts","../editor/EnvelopeEditor.ts","../editor/FadeInOutEditor.ts","../editor/FilterEditor.ts","../editor/ChannelRow.ts","../editor/MuteEditor.ts","../editor/TrackEditor.ts","../editor/LayoutPrompt.ts","../editor/LoopEditor.ts","../editor/SpectrumEditor.ts","../editor/HarmonicsEditor.ts","../editor/BarScrollBar.ts","../editor/OctaveScrollBar.ts","../editor/Midi.ts","../editor/MidiInput.ts","../editor/KeyboardLayout.ts","../editor/Piano.ts","../editor/BeatsPerBarPrompt.ts","../editor/MoveNotesSidewaysPrompt.ts","../editor/SongDurationPrompt.ts","../editor/SustainPrompt.ts","../editor/ChannelSettingsPrompt.ts","../editor/ArrayBufferWriter.ts","../editor/ExportPrompt.ts","../editor/ArrayBufferReader.ts","../editor/ImportPrompt.ts","../editor/SongRecovery.ts","../editor/SongRecoveryPrompt.ts","../editor/RecordingSetupPrompt.ts","../editor/SongEditor.ts","../editor/SongPerformance.ts","../editor/Selection.ts","../editor/Preferences.ts","../editor/ChangeNotifier.ts","../editor/SongDocument.ts","../editor/main.ts"],"sourcesContent":["/*!\r\nCopyright (c) 2012-2022 John Nesky and contributing authors\r\n\r\nPermission is hereby granted, free of charge, to any person obtaining a copy of \r\nthis software and associated documentation files (the \"Software\"), to deal in \r\nthe Software without restriction, including without limitation the rights to \r\nuse, copy, modify, merge, publish, distribute, sublicense, and/or sell copies \r\nof the Software, and to permit persons to whom the Software is furnished to do \r\nso, subject to the following conditions:\r\n\r\nThe above copyright notice and this permission notice shall be included in all \r\ncopies or substantial portions of the Software.\r\n\r\nTHE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR \r\nIMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, \r\nFITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE \r\nAUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER \r\nLIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, \r\nOUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE \r\nSOFTWARE.\r\n*/\r\n\r\nexport interface Dictionary<T> {\r\n\t[K: string]: T;\r\n}\r\n\r\nexport interface DictionaryArray<T> extends ReadonlyArray<T> {\r\n\tdictionary: Dictionary<T>;\r\n}\r\n\r\nexport const enum FilterType {\r\n\tlowPass,\r\n\thighPass,\r\n\tpeak,\r\n\tlength,\r\n}\r\n\r\nexport const enum SustainType {\r\n\tbright,\r\n\tacoustic,\r\n\tlength,\r\n}\r\n\r\nexport const enum EnvelopeType {\r\n\tnoteSize,\r\n\tnone,\r\n\tpunch,\r\n\tflare,\r\n\ttwang,\r\n\tswell,\r\n\ttremolo,\r\n\ttremolo2,\r\n\tdecay,\r\n}\r\n\r\nexport const enum InstrumentType {\r\n\tchip,\r\n\tfm,\r\n\tnoise,\r\n\tspectrum,\r\n\tdrumset,\r\n\tharmonics,\r\n\tpwm,\r\n\tpickedString,\r\n\tsupersaw,\r\n\tlength,\r\n}\r\n\r\nexport const enum EffectType {\r\n\treverb,\r\n\tchorus,\r\n\tpanning,\r\n\tdistortion,\r\n\tbitcrusher,\r\n\tnoteFilter,\r\n\techo,\r\n\tpitchShift,\r\n\tdetune,\r\n\tvibrato,\r\n\ttransition,\r\n\tchord,\r\n\t// If you add more, you'll also have to extend the bitfield used in Base64 which currently uses two six-bit characters.\r\n\tlength,\r\n}\r\n\r\nexport const enum EnvelopeComputeIndex {\r\n\tnoteVolume,\r\n\tnoteFilterAllFreqs,\r\n\tpulseWidth,\r\n\tstringSustain,\r\n\tunison,\r\n\toperatorFrequency0, operatorFrequency1, operatorFrequency2, operatorFrequency3,\r\n\toperatorAmplitude0, operatorAmplitude1, operatorAmplitude2, operatorAmplitude3,\r\n\tfeedbackAmplitude,\r\n\tpitchShift,\r\n\tdetune,\r\n\tvibratoDepth,\r\n\tnoteFilterFreq0, noteFilterFreq1, noteFilterFreq2, noteFilterFreq3, noteFilterFreq4, noteFilterFreq5, noteFilterFreq6, noteFilterFreq7,\r\n\tnoteFilterGain0, noteFilterGain1, noteFilterGain2, noteFilterGain3, noteFilterGain4, noteFilterGain5, noteFilterGain6, noteFilterGain7,\r\n\tsupersawDynamism,\r\n\tsupersawSpread,\r\n\tsupersawShape,\r\n\tlength,\r\n}\r\n\r\n/*\r\nexport const enum InstrumentAutomationIndex {\r\n\tmixVolume,\r\n\teqFilterAllFreqs,\r\n\teqFilterFreq0, eqFilterFreq1, eqFilterFreq2, eqFilterFreq3, eqFilterFreq4, eqFilterFreq5, eqFilterFreq6, eqFilterFreq7,\r\n\teqFilterGain0, eqFilterGain1, eqFilterGain2, eqFilterGain3, eqFilterGain4, eqFilterGain5, eqFilterGain6, eqFilterGain7,\r\n\tdistortion,\r\n\tbitcrusherQuantization,\r\n\tbitcrusherFrequency,\r\n\tpanning,\r\n\tchorus,\r\n\techoSustain,\r\n\t//echoDelay, // Wait until tick settings can be computed once for multiple run lengths.\r\n\treverb,\r\n\tlength,\r\n}\r\n*/\r\n\r\nexport interface BeepBoxOption {\r\n\treadonly index: number;\r\n\treadonly name: string;\r\n}\r\n\r\nexport interface Scale extends BeepBoxOption {\r\n\treadonly flags: ReadonlyArray<boolean>;\r\n\treadonly realName: string;\r\n}\r\n\r\nexport interface Key extends BeepBoxOption {\r\n\treadonly isWhiteKey: boolean;\r\n\treadonly basePitch: number;\r\n}\r\n\r\nexport interface Rhythm extends BeepBoxOption {\r\n\treadonly stepsPerBeat: number;\r\n\treadonly ticksPerArpeggio: number;\r\n\treadonly arpeggioPatterns: ReadonlyArray<ReadonlyArray<number>>;\r\n\treadonly roundUpThresholds: number[] | null;\r\n}\r\n\r\nexport interface ChipWave extends BeepBoxOption {\r\n\treadonly expression: number;\r\n\treadonly samples: Float32Array;\r\n}\r\n\r\nexport interface ChipNoise extends BeepBoxOption {\r\n\treadonly expression: number;\r\n\treadonly basePitch: number;\r\n\treadonly pitchFilterMult: number;\r\n\treadonly isSoft: boolean;\r\n\tsamples: Float32Array | null;\r\n}\r\n\r\nexport interface Transition extends BeepBoxOption {\r\n\treadonly isSeamless: boolean;\r\n\treadonly continues: boolean;\r\n\treadonly slides: boolean;\r\n\treadonly slideTicks: number;\r\n\treadonly includeAdjacentPatterns: boolean;\r\n}\r\n\r\nexport interface Vibrato extends BeepBoxOption {\r\n\treadonly amplitude: number;\r\n\treadonly periodsSeconds: ReadonlyArray<number>;\r\n\treadonly delayTicks: number;\r\n}\r\n\r\nexport interface Unison extends BeepBoxOption {\r\n\treadonly voices: number;\r\n\treadonly spread: number;\r\n\treadonly offset: number;\r\n\treadonly expression: number;\r\n\treadonly sign: number;\r\n}\r\n\r\nexport interface Chord extends BeepBoxOption {\r\n\treadonly customInterval: boolean;\r\n\treadonly arpeggiates: boolean;\r\n\treadonly strumParts: number;\r\n\treadonly singleTone: boolean;\r\n}\r\n\r\nexport interface Algorithm extends BeepBoxOption {\r\n\treadonly carrierCount: number;\r\n\treadonly associatedCarrier: ReadonlyArray<number>;\r\n\treadonly modulatedBy: ReadonlyArray<ReadonlyArray<number>>;\r\n}\r\n\r\nexport interface OperatorFrequency extends BeepBoxOption {\r\n\treadonly mult: number;\r\n\treadonly hzOffset: number;\r\n\treadonly amplitudeSign: number;\r\n}\r\n\r\nexport interface Feedback extends BeepBoxOption {\r\n\treadonly indices: ReadonlyArray<ReadonlyArray<number>>;\r\n}\r\n\r\nexport interface Envelope extends BeepBoxOption {\r\n\treadonly type: EnvelopeType;\r\n\treadonly speed: number;\r\n}\r\n\r\nexport interface AutomationTarget extends BeepBoxOption {\r\n\treadonly computeIndex: EnvelopeComputeIndex /*| InstrumentAutomationIndex*/ | null;\r\n\treadonly displayName: string;\r\n\t//readonly perNote: boolean; // Whether to compute envelopes on a per-note basis.\r\n\treadonly interleave: boolean; // Whether to interleave this target with the next one in the menu (e.g. filter frequency and gain).\r\n\treadonly isFilter: boolean; // Filters are special because the maxCount depends on other instrument settings.\r\n\t//readonly range: number | null; // set if automation is allowed.\r\n\treadonly maxCount: number;\r\n\treadonly effect: EffectType | null;\r\n\treadonly compatibleInstruments: InstrumentType[] | null;\r\n}\r\n\r\nexport class Config {\r\n\tpublic static readonly scales: DictionaryArray<Scale> = toNameMap([\r\n\t\t{name: \"easy :)\",            realName: \"pentatonic major\",      flags: [true, false,  true, false,  true, false, false,  true, false,  true, false, false]},\r\n\t\t{name: \"easy :(\",            realName: \"pentatonic minor\",      flags: [true, false, false,  true, false,  true, false,  true, false, false,  true, false]},\r\n\t\t{name: \"island :)\",          realName: \"ryukyu\",                flags: [true, false, false, false,  true,  true, false,  true, false, false, false,  true]},\r\n\t\t{name: \"island :(\",          realName: \"pelog selisir\",         flags: [true,  true, false,  true, false, false, false,  true,  true, false, false, false]},\r\n\t\t{name: \"blues :)\",           realName: \"blues major\",           flags: [true, false,  true,  true,  true, false, false,  true, false,  true, false, false]},\r\n\t\t{name: \"blues :(\",           realName: \"blues\",                 flags: [true, false, false,  true, false,  true,  true,  true, false, false,  true, false]},\r\n\t\t{name: \"normal :)\",          realName: \"ionian\",                flags: [true, false,  true, false,  true,  true, false,  true, false,  true, false,  true]},\r\n\t\t{name: \"normal :(\",          realName: \"aeolian\",               flags: [true, false,  true,  true, false,  true, false,  true,  true, false,  true, false]},\r\n\t\t{name: \"double harmonic :)\", realName: \"double harmonic major\", flags: [true,  true, false, false,  true,  true, false,  true,  true, false, false,  true]},\r\n\t\t{name: \"double harmonic :(\", realName: \"double harmonic minor\", flags: [true, false,  true,  true, false, false,  true,  true,  true, false, false,  true]},\r\n\t\t{name: \"strange\",            realName: \"whole tone\",            flags: [true, false,  true, false,  true, false,  true, false,  true, false,  true, false]},\r\n\t\t{name: \"expert\",             realName: \"chromatic\",             flags: [true,  true,  true,  true,  true,  true,  true,  true,  true,  true,  true,  true]},\r\n\t]);\r\n\tpublic static readonly keys: DictionaryArray<Key> = toNameMap([\r\n\t\t{name: \"C\",  isWhiteKey:  true, basePitch: 12}, // C0 has index 12 on the MIDI scale. C7 is 96, and C9 is 120. C10 is barely in the audible range.\r\n\t\t{name: \"C\", isWhiteKey: false, basePitch: 13},\r\n\t\t{name: \"D\",  isWhiteKey:  true, basePitch: 14},\r\n\t\t{name: \"D\", isWhiteKey: false, basePitch: 15},\r\n\t\t{name: \"E\",  isWhiteKey:  true, basePitch: 16},\r\n\t\t{name: \"F\",  isWhiteKey:  true, basePitch: 17},\r\n\t\t{name: \"F\", isWhiteKey: false, basePitch: 18},\r\n\t\t{name: \"G\",  isWhiteKey:  true, basePitch: 19},\r\n\t\t{name: \"G\", isWhiteKey: false, basePitch: 20},\r\n\t\t{name: \"A\",  isWhiteKey:  true, basePitch: 21},\r\n\t\t{name: \"A\", isWhiteKey: false, basePitch: 22},\r\n\t\t{name: \"B\",  isWhiteKey:  true, basePitch: 23},\r\n\t]);\r\n\tpublic static readonly blackKeyNameParents: ReadonlyArray<number> = [-1, 1, -1, 1, -1, 1, -1, -1, 1, -1, 1, -1];\r\n\tpublic static readonly tempoMin: number = 30;\r\n\tpublic static readonly tempoMax: number = 300;\r\n\tpublic static readonly echoDelayRange: number = 24;\r\n\tpublic static readonly echoDelayStepTicks: number = 4;\r\n\tpublic static readonly echoSustainRange: number = 8;\r\n\tpublic static readonly echoShelfHz: number = 4000.0; // The cutoff freq of the shelf filter that is used to decay echoes.\r\n\tpublic static readonly echoShelfGain: number = Math.pow(2.0, -0.5);\r\n\tpublic static readonly reverbShelfHz: number = 8000.0; // The cutoff freq of the shelf filter that is used to decay reverb.\r\n\tpublic static readonly reverbShelfGain: number = Math.pow(2.0, -1.5);\r\n\tpublic static readonly reverbRange: number = 4;\r\n\tpublic static readonly reverbDelayBufferSize: number = 16384; // TODO: Compute a buffer size based on sample rate.\r\n\tpublic static readonly reverbDelayBufferMask: number = Config.reverbDelayBufferSize - 1; // TODO: Compute a buffer size based on sample rate.\r\n\tpublic static readonly beatsPerBarMin: number = 3;\r\n\tpublic static readonly beatsPerBarMax: number = 16;\r\n\tpublic static readonly barCountMin: number = 1;\r\n\tpublic static readonly barCountMax: number = 128;\r\n\tpublic static readonly instrumentCountMin: number = 1;\r\n\tpublic static readonly layeredInstrumentCountMax: number = 4;\r\n\tpublic static readonly patternInstrumentCountMax: number = 10;\r\n\tpublic static readonly partsPerBeat: number = 24;\r\n\tpublic static readonly ticksPerPart: number = 2;\r\n\tpublic static readonly rhythms: DictionaryArray<Rhythm> = toNameMap([\r\n\t\t{name: \"3 (triplets)\", stepsPerBeat: 3, ticksPerArpeggio: 4, arpeggioPatterns: [[0], [0, 0, 1, 1], [0, 1, 2, 1]], roundUpThresholds: [/*0*/ 5, /*8*/ 12, /*16*/ 18 /*24*/]},\r\n\t\t{name: \"4 (standard)\", stepsPerBeat: 4, ticksPerArpeggio: 3, arpeggioPatterns: [[0], [0, 0, 1, 1], [0, 1, 2, 1]], roundUpThresholds: [/*0*/ 3, /*6*/ 9, /*12*/ 17, /*18*/ 21 /*24*/]},\r\n\t\t{name: \"6\",            stepsPerBeat: 6, ticksPerArpeggio: 4, arpeggioPatterns: [[0], [0, 1],       [0, 1, 2, 1]], roundUpThresholds: null},\r\n\t\t{name: \"8\",            stepsPerBeat: 8, ticksPerArpeggio: 3, arpeggioPatterns: [[0], [0, 1],       [0, 1, 2, 1]], roundUpThresholds: null},\r\n\t\t{name: \"freehand\",      stepsPerBeat:24, ticksPerArpeggio: 3, arpeggioPatterns: [[0], [0, 1],       [0, 1, 2, 1]], roundUpThresholds: null},\r\n\t]);\r\n\t\r\n\tpublic static readonly instrumentTypeNames: ReadonlyArray<string> = [\"chip\", \"FM\", \"noise\", \"spectrum\", \"drumset\", \"harmonics\", \"PWM\", \"Picked String\", \"supersaw\"]; // See InstrumentType enum above.\r\n\tpublic static readonly instrumentTypeHasSpecialInterval: ReadonlyArray<boolean> = [true, true, false, false, false, true, false, false, false];\r\n\tpublic static readonly chipBaseExpression:      number = 0.03375; // Doubled by unison feature, but affected by expression adjustments per unison setting and wave shape.\r\n\tpublic static readonly fmBaseExpression:        number = 0.03;\r\n\tpublic static readonly noiseBaseExpression:     number = 0.19;\r\n\tpublic static readonly spectrumBaseExpression:  number = 0.3; // Spectrum can be in pitch or noise channels, the expression is doubled for noise.\r\n\tpublic static readonly drumsetBaseExpression:   number = 0.45; // Drums tend to be loud but brief!\r\n\tpublic static readonly harmonicsBaseExpression: number = 0.025;\r\n\tpublic static readonly pwmBaseExpression:       number = 0.04725; // It's actually closer to half of this, the synthesized pulse amplitude range is only .5 to -.5, but also note that the fundamental sine partial amplitude of a square wave is 4/ times the measured square wave amplitude.\r\n\tpublic static readonly supersawBaseExpression:  number = 0.061425; // It's actually closer to half of this, the synthesized sawtooth amplitude range is only .5 to -.5.\r\n\tpublic static readonly pickedStringBaseExpression: number = 0.025; // Same as harmonics.\r\n\tpublic static readonly distortionBaseVolume:    number = 0.011; // Distortion is not affected by pitchDamping, which otherwise approximately halves expression for notes around the middle of the range.\r\n\tpublic static readonly bitcrusherBaseVolume:    number = 0.010; // Also not affected by pitchDamping, used when bit crushing is maxed out (aka \"1-bit\" output).\r\n\t\r\n\tpublic static readonly chipWaves: DictionaryArray<ChipWave> = toNameMap([\r\n\t\t{name: \"rounded\",      expression: 0.94, samples: centerWave([0.0, 0.2, 0.4, 0.5, 0.6, 0.7, 0.8, 0.85, 0.9, 0.95, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 0.95, 0.9, 0.85, 0.8, 0.7, 0.6, 0.5, 0.4, 0.2, 0.0, -0.2, -0.4, -0.5, -0.6, -0.7, -0.8, -0.85, -0.9, -0.95, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -0.95, -0.9, -0.85, -0.8, -0.7, -0.6, -0.5, -0.4, -0.2])},\r\n\t\t{name: \"triangle\",     expression: 1.0,  samples: centerWave([1.0/15.0, 3.0/15.0, 5.0/15.0, 7.0/15.0, 9.0/15.0, 11.0/15.0, 13.0/15.0, 15.0/15.0, 15.0/15.0, 13.0/15.0, 11.0/15.0, 9.0/15.0, 7.0/15.0, 5.0/15.0, 3.0/15.0, 1.0/15.0, -1.0/15.0, -3.0/15.0, -5.0/15.0, -7.0/15.0, -9.0/15.0, -11.0/15.0, -13.0/15.0, -15.0/15.0, -15.0/15.0, -13.0/15.0, -11.0/15.0, -9.0/15.0, -7.0/15.0, -5.0/15.0, -3.0/15.0, -1.0/15.0])},\r\n\t\t{name: \"square\",       expression: 0.5,  samples: centerWave([1.0, -1.0])},\r\n\t\t{name: \"1/4 pulse\",    expression: 0.5,  samples: centerWave([1.0, -1.0, -1.0, -1.0])},\r\n\t\t{name: \"1/8 pulse\",    expression: 0.5,  samples: centerWave([1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0])},\r\n\t\t{name: \"sawtooth\",     expression: 0.65, samples: centerWave([1.0/31.0, 3.0/31.0, 5.0/31.0, 7.0/31.0, 9.0/31.0, 11.0/31.0, 13.0/31.0, 15.0/31.0, 17.0/31.0, 19.0/31.0, 21.0/31.0, 23.0/31.0, 25.0/31.0, 27.0/31.0, 29.0/31.0, 31.0/31.0, -31.0/31.0, -29.0/31.0, -27.0/31.0, -25.0/31.0, -23.0/31.0, -21.0/31.0, -19.0/31.0, -17.0/31.0, -15.0/31.0, -13.0/31.0, -11.0/31.0, -9.0/31.0, -7.0/31.0, -5.0/31.0, -3.0/31.0, -1.0/31.0])},\r\n\t\t{name: \"double saw\",   expression: 0.5,  samples: centerWave([0.0, -0.2, -0.4, -0.6, -0.8, -1.0, 1.0, -0.8, -0.6, -0.4, -0.2, 1.0, 0.8, 0.6, 0.4, 0.2])},\r\n\t\t{name: \"double pulse\", expression: 0.4,  samples: centerWave([1.0, 1.0, 1.0, 1.0, 1.0, -1.0, -1.0, -1.0, 1.0, 1.0, 1.0, 1.0, -1.0, -1.0, -1.0, -1.0])},\r\n\t\t{name: \"spiky\",        expression: 0.4,  samples: centerWave([1.0, -1.0, 1.0, -1.0, 1.0, 0.0])},\r\n\t]);\r\n\t// Noise waves have too many samples to write by hand, they're generated on-demand by getDrumWave instead.\r\n\tpublic static readonly chipNoises: DictionaryArray<ChipNoise> = toNameMap([\r\n\t\t{name: \"retro\",   expression: 0.25, basePitch: 69,  pitchFilterMult: 1024.0, isSoft: false, samples: null},\r\n\t\t{name: \"white\",   expression: 1.0,  basePitch: 69,  pitchFilterMult:    8.0, isSoft: true,  samples: null},\r\n\t\t// The \"clang\" and \"buzz\" noises are based on similar noises in the modded beepbox! :D\r\n\t\t{name: \"clang\",   expression: 0.4,  basePitch: 69,  pitchFilterMult: 1024.0, isSoft: false, samples: null},\r\n\t\t{name: \"buzz\",    expression: 0.3,  basePitch: 69,  pitchFilterMult: 1024.0, isSoft: false, samples: null},\r\n\t\t{name: \"hollow\",  expression: 1.5,  basePitch: 96,  pitchFilterMult:    1.0, isSoft: true,  samples: null},\r\n\t]);\r\n\t\r\n\tpublic static readonly filterFreqStep: number = 1.0/4.0;\r\n\tpublic static readonly filterFreqRange: number = 34;\r\n\tpublic static readonly filterFreqReferenceSetting: number = 28;\r\n\tpublic static readonly filterFreqReferenceHz: number = 8000.0;\r\n\tpublic static readonly filterFreqMaxHz: number = Config.filterFreqReferenceHz * Math.pow(2.0, Config.filterFreqStep * (Config.filterFreqRange - 1 - Config.filterFreqReferenceSetting)); // ~19khz\r\n\tpublic static readonly filterFreqMinHz: number = 8.0;\r\n\tpublic static readonly filterGainRange: number = 15;\r\n\tpublic static readonly filterGainCenter: number = 7;\r\n\tpublic static readonly filterGainStep: number = 1.0/2.0;\r\n\tpublic static readonly filterMaxPoints: number = 8;\r\n\tpublic static readonly filterTypeNames: ReadonlyArray<string> = [\"low-pass\", \"high-pass\", \"peak\"]; // See FilterType enum above.\r\n\t\r\n\tpublic static readonly fadeInRange: number = 10;\r\n\tpublic static readonly fadeOutTicks: ReadonlyArray<number> = [-24, -12, -6, -3, -1, 6, 12, 24, 48, 72, 96];\r\n\tpublic static readonly fadeOutNeutral: number = 4;\r\n\tpublic static readonly drumsetFadeOutTicks: number = 48;\r\n\tpublic static readonly transitions: DictionaryArray<Transition> = toNameMap([\r\n\t\t{name: \"normal\",        isSeamless: false, continues: false, slides: false, slideTicks: 3, includeAdjacentPatterns: false},\r\n\t\t{name: \"interrupt\",     isSeamless: true,  continues: false, slides: false, slideTicks: 3, includeAdjacentPatterns: true},\r\n\t\t{name: \"continue\",      isSeamless: true,  continues: true,  slides: false, slideTicks: 3, includeAdjacentPatterns: true},\r\n\t\t{name: \"slide\",         isSeamless: true,  continues: false, slides: true,  slideTicks: 3, includeAdjacentPatterns: true},\r\n\t\t{name: \"slide in pattern\", isSeamless: true,  continues: false, slides: true,  slideTicks: 3, includeAdjacentPatterns: false},\r\n\t]);\r\n\tpublic static readonly vibratos: DictionaryArray<Vibrato> = toNameMap([\r\n\t\t{name: \"none\",    amplitude: 0.0,  periodsSeconds: [0.14], delayTicks: 0},\r\n\t\t{name: \"light\",   amplitude: 0.15, periodsSeconds: [0.14], delayTicks: 0},\r\n\t\t{name: \"delayed\", amplitude: 0.3,  periodsSeconds: [0.14], delayTicks: 37}, // It will fade in over the previous two ticks.\r\n\t\t{name: \"heavy\",   amplitude: 0.45, periodsSeconds: [0.14], delayTicks: 0},\r\n\t\t{name: \"shaky\",   amplitude: 0.1,  periodsSeconds: [0.11, 1.618*0.11, 3*0.11], delayTicks: 0},\r\n\t]);\r\n\tpublic static readonly unisons: DictionaryArray<Unison> = toNameMap([\r\n\t\t{name: \"none\",       voices: 1, spread: 0.0,  offset: 0.0, expression: 1.4, sign: 1.0},\r\n\t\t{name: \"shimmer\",    voices: 2, spread: 0.018,offset: 0.0, expression: 0.8, sign: 1.0},\r\n\t\t{name: \"hum\",        voices: 2, spread: 0.045,offset: 0.0, expression: 1.0, sign: 1.0},\r\n\t\t{name: \"honky tonk\", voices: 2, spread: 0.09, offset: 0.0, expression: 1.0, sign: 1.0},\r\n\t\t{name: \"dissonant\",  voices: 2, spread: 0.25, offset: 0.0, expression: 0.9, sign: 1.0},\r\n\t\t{name: \"fifth\",      voices: 2, spread: 3.5,  offset: 3.5, expression: 0.9, sign: 1.0},\r\n\t\t{name: \"octave\",     voices: 2, spread: 6.0,  offset: 6.0, expression: 0.8, sign: 1.0},\r\n\t\t{name: \"bowed\",      voices: 2, spread: 0.02, offset: 0.0, expression: 1.0, sign:-1.0},\r\n\t\t{name: \"piano\",      voices: 2, spread: 0.01, offset: 0.0, expression: 1.0, sign: 0.7},\r\n\t]);\r\n\tpublic static readonly effectNames: ReadonlyArray<string> = [\"reverb\", \"chorus\", \"panning\", \"distortion\", \"bitcrusher\", \"note filter\", \"echo\", \"pitch shift\", \"detune\", \"vibrato\", \"transition type\", \"chord type\"];\r\n\tpublic static readonly effectOrder: ReadonlyArray<EffectType> = [EffectType.transition, EffectType.chord, EffectType.pitchShift, EffectType.detune, EffectType.vibrato, EffectType.noteFilter, EffectType.distortion, EffectType.bitcrusher, EffectType.panning, EffectType.chorus, EffectType.echo, EffectType.reverb];\r\n\tpublic static readonly noteSizeMax: number = 3;\r\n\tpublic static readonly volumeRange: number = 8;\r\n\tpublic static readonly volumeLogScale: number = -0.5;\r\n\tpublic static readonly panCenter: number = 4;\r\n\tpublic static readonly panMax: number = Config.panCenter * 2;\r\n\tpublic static readonly panDelaySecondsMax: number = 0.0005;\r\n\tpublic static readonly chorusRange: number = 4;\r\n\tpublic static readonly chorusPeriodSeconds: number = 2.0;\r\n\tpublic static readonly chorusDelayRange: number = 0.0034;\r\n\tpublic static readonly chorusDelayOffsets: ReadonlyArray<ReadonlyArray<number>> = [[1.51, 2.10, 3.35], [1.47, 2.15, 3.25]];\r\n\tpublic static readonly chorusPhaseOffsets: ReadonlyArray<ReadonlyArray<number>> = [[0.0, 2.1, 4.2], [3.2, 5.3, 1.0]];\r\n\tpublic static readonly chorusMaxDelay: number = Config.chorusDelayRange * (1.0 + Config.chorusDelayOffsets[0].concat(Config.chorusDelayOffsets[1]).reduce((x,y)=>Math.max(x,y)));\r\n\tpublic static readonly chords: DictionaryArray<Chord> = toNameMap([\r\n\t\t{name: \"simultaneous\",    customInterval: false, arpeggiates: false, strumParts: 0, singleTone: false},\r\n\t\t{name: \"strum\",           customInterval: false, arpeggiates: false, strumParts: 1, singleTone: false},\r\n\t\t{name: \"arpeggio\",        customInterval: false, arpeggiates:  true, strumParts: 0, singleTone:  true},\r\n\t\t{name: \"custom interval\", customInterval:  true, arpeggiates: false, strumParts: 0, singleTone:  true},\r\n\t]);\r\n\tpublic static readonly maxChordSize: number = 4;\r\n\tpublic static readonly operatorCount: number = 4;\r\n\tpublic static readonly maxPitchOrOperatorCount: number = Math.max(Config.maxChordSize, Config.operatorCount);\r\n\tpublic static readonly algorithms: DictionaryArray<Algorithm> = toNameMap([\r\n\t\t{name: \"1(234)\",   carrierCount: 1, associatedCarrier: [1, 1, 1, 1], modulatedBy: [[2, 3, 4], [],     [],  []]},\r\n\t\t{name: \"1(234)\",   carrierCount: 1, associatedCarrier: [1, 1, 1, 1], modulatedBy: [[2, 3],    [],     [4], []]},\r\n\t\t{name: \"12(34)\",   carrierCount: 1, associatedCarrier: [1, 1, 1, 1], modulatedBy: [[2],       [3, 4], [],  []]},\r\n\t\t{name: \"1(23)4\",   carrierCount: 1, associatedCarrier: [1, 1, 1, 1], modulatedBy: [[2, 3],    [4],    [4], []]},\r\n\t\t{name: \"1234\",     carrierCount: 1, associatedCarrier: [1, 1, 1, 1], modulatedBy: [[2],       [3],    [4], []]},\r\n\t\t{name: \"1324\",     carrierCount: 2, associatedCarrier: [1, 2, 1, 2], modulatedBy: [[3],       [4],    [],  []]},\r\n\t\t{name: \"12(34)\",   carrierCount: 2, associatedCarrier: [1, 2, 2, 2], modulatedBy: [[],        [3, 4], [],  []]},\r\n\t\t{name: \"1234\",     carrierCount: 2, associatedCarrier: [1, 2, 2, 2], modulatedBy: [[],        [3],    [4], []]},\r\n\t\t{name: \"(12)34\",   carrierCount: 2, associatedCarrier: [1, 2, 2, 2], modulatedBy: [[3],       [3],    [4], []]},\r\n\t\t{name: \"(12)(34)\", carrierCount: 2, associatedCarrier: [1, 2, 2, 2], modulatedBy: [[3, 4],    [3, 4], [],  []]},\r\n\t\t{name: \"1234\",     carrierCount: 3, associatedCarrier: [1, 2, 3, 3], modulatedBy: [[],        [],     [4], []]},\r\n\t\t{name: \"(123)4\",   carrierCount: 3, associatedCarrier: [1, 2, 3, 3], modulatedBy: [[4],       [4],    [4], []]},\r\n\t\t{name: \"1234\",     carrierCount: 4, associatedCarrier: [1, 2, 3, 4], modulatedBy: [[],        [],     [],  []]},\r\n\t]);\r\n\tpublic static readonly operatorCarrierInterval: ReadonlyArray<number> = [0.0, 0.04, -0.073, 0.091];\r\n\tpublic static readonly operatorAmplitudeMax: number = 15;\r\n\tpublic static readonly operatorFrequencies: DictionaryArray<OperatorFrequency> = toNameMap([\r\n\t\t{name:  \"1\", mult:  1.0, hzOffset: 0.0, amplitudeSign: 1.0},\r\n\t\t{name: \"~1\", mult:  1.0, hzOffset: 1.5, amplitudeSign:-1.0},\r\n\t\t{name:  \"2\", mult:  2.0, hzOffset: 0.0, amplitudeSign: 1.0},\r\n\t\t{name: \"~2\", mult:  2.0, hzOffset:-1.3, amplitudeSign:-1.0},\r\n\t\t{name:  \"3\", mult:  3.0, hzOffset: 0.0, amplitudeSign: 1.0},\r\n\t\t{name:  \"4\", mult:  4.0, hzOffset: 0.0, amplitudeSign: 1.0},\r\n\t\t{name:  \"5\", mult:  5.0, hzOffset: 0.0, amplitudeSign: 1.0},\r\n\t\t{name:  \"6\", mult:  6.0, hzOffset: 0.0, amplitudeSign: 1.0},\r\n\t\t{name:  \"7\", mult:  7.0, hzOffset: 0.0, amplitudeSign: 1.0},\r\n\t\t{name:  \"8\", mult:  8.0, hzOffset: 0.0, amplitudeSign: 1.0},\r\n\t\t{name:  \"9\", mult:  9.0, hzOffset: 0.0, amplitudeSign: 1.0},\r\n\t\t{name: \"11\", mult: 11.0, hzOffset: 0.0, amplitudeSign: 1.0},\r\n\t\t{name: \"13\", mult: 13.0, hzOffset: 0.0, amplitudeSign: 1.0},\r\n\t\t{name: \"16\", mult: 16.0, hzOffset: 0.0, amplitudeSign: 1.0},\r\n\t\t{name: \"20\", mult: 20.0, hzOffset: 0.0, amplitudeSign: 1.0},\r\n\t]);\r\n\tpublic static readonly envelopes: DictionaryArray<Envelope> = toNameMap([\r\n\t\t{name: \"none\",     type: EnvelopeType.none,     speed:  0.0},\r\n\t\t{name: \"note size\",type: EnvelopeType.noteSize, speed:  0.0},\r\n\t\t{name: \"punch\",    type: EnvelopeType.punch,    speed:  0.0},\r\n\t\t{name: \"flare 1\",  type: EnvelopeType.flare,    speed: 32.0},\r\n\t\t{name: \"flare 2\",  type: EnvelopeType.flare,    speed:  8.0},\r\n\t\t{name: \"flare 3\",  type: EnvelopeType.flare,    speed:  2.0},\r\n\t\t{name: \"twang 1\",  type: EnvelopeType.twang,    speed: 32.0},\r\n\t\t{name: \"twang 2\",  type: EnvelopeType.twang,    speed:  8.0},\r\n\t\t{name: \"twang 3\",  type: EnvelopeType.twang,    speed:  2.0},\r\n\t\t{name: \"swell 1\",  type: EnvelopeType.swell,    speed: 32.0},\r\n\t\t{name: \"swell 2\",  type: EnvelopeType.swell,    speed:  8.0},\r\n\t\t{name: \"swell 3\",  type: EnvelopeType.swell,    speed:  2.0},\r\n\t\t{name: \"tremolo1\", type: EnvelopeType.tremolo,  speed:  4.0},\r\n\t\t{name: \"tremolo2\", type: EnvelopeType.tremolo,  speed:  2.0},\r\n\t\t{name: \"tremolo3\", type: EnvelopeType.tremolo,  speed:  1.0},\r\n\t\t{name: \"tremolo4\", type: EnvelopeType.tremolo2, speed:  4.0},\r\n\t\t{name: \"tremolo5\", type: EnvelopeType.tremolo2, speed:  2.0},\r\n\t\t{name: \"tremolo6\", type: EnvelopeType.tremolo2, speed:  1.0},\r\n\t\t{name: \"decay 1\",  type: EnvelopeType.decay,    speed: 10.0},\r\n\t\t{name: \"decay 2\",  type: EnvelopeType.decay,    speed:  7.0},\r\n\t\t{name: \"decay 3\",  type: EnvelopeType.decay,    speed:  4.0},\r\n\t]);\r\n\tpublic static readonly feedbacks: DictionaryArray<Feedback> = toNameMap([\r\n\t\t{name: \"1\",          indices: [[1],  [],  [],  []]},\r\n\t\t{name: \"2\",          indices: [ [], [2],  [],  []]},\r\n\t\t{name: \"3\",          indices: [ [],  [], [3],  []]},\r\n\t\t{name: \"4\",          indices: [ [],  [],  [], [4]]},\r\n\t\t{name: \"12\",       indices: [[1], [2],  [],  []]},\r\n\t\t{name: \"34\",       indices: [ [],  [], [3], [4]]},\r\n\t\t{name: \"123\",    indices: [[1], [2], [3],  []]},\r\n\t\t{name: \"234\",    indices: [ [], [2], [3], [4]]},\r\n\t\t{name: \"1 2 3 4\", indices: [[1], [2], [3], [4]]},\r\n\t\t{name: \"12\",         indices: [ [], [1],  [],  []]},\r\n\t\t{name: \"13\",         indices: [ [],  [], [1],  []]},\r\n\t\t{name: \"14\",         indices: [ [],  [],  [], [1]]},\r\n\t\t{name: \"23\",         indices: [ [],  [], [2],  []]},\r\n\t\t{name: \"24\",         indices: [ [],  [],  [], [2]]},\r\n\t\t{name: \"34\",         indices: [ [],  [],  [], [3]]},\r\n\t\t{name: \"1324\",     indices: [ [],  [], [1], [2]]},\r\n\t\t{name: \"1423\",     indices: [ [],  [], [2], [1]]},\r\n\t\t{name: \"1234\",     indices: [ [], [1], [2], [3]]},\r\n\t]);\r\n\tpublic static readonly chipNoiseLength: number = 1 << 15; // 32768\r\n\tpublic static readonly spectrumNoiseLength: number = 1 << 15; // 32768\r\n\tpublic static readonly spectrumBasePitch: number = 24;\r\n\tpublic static readonly spectrumControlPoints: number = 30;\r\n\tpublic static readonly spectrumControlPointsPerOctave: number = 7;\r\n\tpublic static readonly spectrumControlPointBits: number = 3;\r\n\tpublic static readonly spectrumMax: number = (1 << Config.spectrumControlPointBits) - 1;\r\n\tpublic static readonly harmonicsControlPoints: number = 28;\r\n\tpublic static readonly harmonicsRendered: number = 64;\r\n\tpublic static readonly harmonicsRenderedForPickedString: number = 1 << 8; // 256\r\n\tpublic static readonly harmonicsControlPointBits: number = 3;\r\n\tpublic static readonly harmonicsMax: number = (1 << Config.harmonicsControlPointBits) - 1;\r\n\tpublic static readonly harmonicsWavelength: number = 1 << 11; // 2048\r\n\tpublic static readonly pulseWidthRange: number = 8;\r\n\tpublic static readonly pulseWidthStepPower: number = 0.5;\r\n\tpublic static readonly supersawVoiceCount: number = 7;\r\n\tpublic static readonly supersawDynamismMax: number = 6;\r\n\tpublic static readonly supersawSpreadMax: number = 12;\r\n\tpublic static readonly supersawShapeMax: number = 6;\r\n\tpublic static readonly pitchChannelCountMin: number = 1;\r\n\tpublic static readonly pitchChannelCountMax: number = 10;\r\n\tpublic static readonly noiseChannelCountMin: number = 0;\r\n\tpublic static readonly noiseChannelCountMax: number = 5;\r\n\tpublic static readonly noiseInterval: number = 6;\r\n\tpublic static readonly pitchesPerOctave: number = 12; // TODO: Use this for converting pitch to frequency.\r\n\tpublic static readonly drumCount: number = 12;\r\n\tpublic static readonly pitchOctaves: number = 7;\r\n\tpublic static readonly maxPitch: number = Config.pitchOctaves * Config.pitchesPerOctave;\r\n\tpublic static readonly maximumTonesPerChannel: number = Config.maxChordSize * 2;\r\n\tpublic static readonly justIntonationSemitones: number[] = [1.0/2.0, 8.0/15.0, 9.0/16.0, 3.0/5.0, 5.0/8.0, 2.0/3.0, 32.0/45.0, 3.0/4.0, 4.0/5.0, 5.0/6.0, 8.0/9.0, 15.0/16.0, 1.0, 16.0/15.0, 9.0/8.0, 6.0/5.0, 5.0/4.0, 4.0/3.0, 45.0/32.0, 3.0/2.0, 8.0/5.0, 5.0/3.0, 16.0/9.0, 15.0/8.0, 2.0].map(x=>Math.log2(x) * Config.pitchesPerOctave);\r\n\tpublic static readonly pitchShiftRange: number = Config.justIntonationSemitones.length;\r\n\tpublic static readonly pitchShiftCenter: number = Config.pitchShiftRange >> 1;\r\n\tpublic static readonly detuneCenter: number = 9;\r\n\tpublic static readonly detuneMax: number = Config.detuneCenter * 2;\r\n\tpublic static readonly sineWaveLength: number = 1 << 8; // 256\r\n\tpublic static readonly sineWaveMask: number = Config.sineWaveLength - 1;\r\n\tpublic static readonly sineWave: Float32Array = generateSineWave();\r\n\t\r\n\t// Picked strings have an all-pass filter with a corner frequency based on the tone fundamental frequency, in order to add a slight inharmonicity. (Which is important for distortion.)\r\n\tpublic static readonly pickedStringDispersionCenterFreq: number = 6000.0; // The tone fundamental freq is pulled toward this freq for computing the all-pass corner freq.\r\n\tpublic static readonly pickedStringDispersionFreqScale: number = 0.3; // The tone fundamental freq freq moves this much toward the center freq for computing the all-pass corner freq.\r\n\tpublic static readonly pickedStringDispersionFreqMult: number = 4.0; // The all-pass corner freq is based on this times the adjusted tone fundamental freq.\r\n\tpublic static readonly pickedStringShelfHz: number = 4000.0; // The cutoff freq of the shelf filter that is used to decay the high frequency energy in the picked string.\r\n\tpublic static readonly stringSustainRange: number = 15;\r\n\tpublic static readonly stringDecayRate: number = 0.12;\r\n\tpublic static readonly enableAcousticSustain: boolean = false;\r\n\tpublic static readonly sustainTypeNames: ReadonlyArray<string> = [\"bright\", \"acoustic\"]; // See SustainType enum above.\r\n\t\r\n\tpublic static readonly distortionRange: number = 8;\r\n\tpublic static readonly bitcrusherFreqRange: number = 14;\r\n\tpublic static readonly bitcrusherOctaveStep: number = 0.5;\r\n\tpublic static readonly bitcrusherQuantizationRange: number = 8;\r\n\t\r\n\tpublic static readonly maxEnvelopeCount: number = 12;\r\n\tpublic static readonly defaultAutomationRange: number = 13;\r\n\tpublic static readonly instrumentAutomationTargets: DictionaryArray<AutomationTarget> = toNameMap([\r\n\t\t{name: \"none\",                   computeIndex:                           null,                   displayName: \"none\",             /*perNote: false,*/ interleave: false, isFilter: false, /*range: 0,                              */    maxCount: 1,    effect: null,                    compatibleInstruments: null},\r\n\t\t{name: \"noteVolume\",             computeIndex:       EnvelopeComputeIndex.noteVolume,             displayName: \"note volume\",      /*perNote:  true,*/ interleave: false, isFilter: false, /*range: Config.volumeRange,             */    maxCount: 1,    effect: null,                    compatibleInstruments: null},\r\n\t\t{name: \"pulseWidth\",             computeIndex:       EnvelopeComputeIndex.pulseWidth,             displayName: \"pulse width\",      /*perNote:  true,*/ interleave: false, isFilter: false, /*range: Config.pulseWidthRange,         */    maxCount: 1,    effect: null,                    compatibleInstruments: [InstrumentType.pwm, InstrumentType.supersaw]},\r\n\t\t{name: \"stringSustain\",          computeIndex:       EnvelopeComputeIndex.stringSustain,          displayName: \"sustain\",          /*perNote:  true,*/ interleave: false, isFilter: false, /*range: Config.stringSustainRange,      */    maxCount: 1,    effect: null,                    compatibleInstruments: [InstrumentType.pickedString]},\r\n\t\t{name: \"unison\",                 computeIndex:       EnvelopeComputeIndex.unison,                 displayName: \"unison\",           /*perNote:  true,*/ interleave: false, isFilter: false, /*range: Config.defaultAutomationRange,  */    maxCount: 1,    effect: null,                    compatibleInstruments: [InstrumentType.chip, InstrumentType.harmonics, InstrumentType.pickedString]},\r\n\t\t{name: \"operatorFrequency\",      computeIndex:       EnvelopeComputeIndex.operatorFrequency0,     displayName: \"fm# freq\",         /*perNote:  true,*/ interleave:  true, isFilter: false, /*range: Config.defaultAutomationRange,  */    maxCount: Config.operatorCount, effect: null,    compatibleInstruments: [InstrumentType.fm]},\r\n\t\t{name: \"operatorAmplitude\",      computeIndex:       EnvelopeComputeIndex.operatorAmplitude0,     displayName: \"fm# volume\",       /*perNote:  true,*/ interleave: false, isFilter: false, /*range: Config.operatorAmplitudeMax + 1,*/    maxCount: Config.operatorCount, effect: null,    compatibleInstruments: [InstrumentType.fm]},\r\n\t\t{name: \"feedbackAmplitude\",      computeIndex:       EnvelopeComputeIndex.feedbackAmplitude,      displayName: \"fm feedback\",      /*perNote:  true,*/ interleave: false, isFilter: false, /*range: Config.operatorAmplitudeMax + 1,*/    maxCount: 1,    effect: null,                    compatibleInstruments: [InstrumentType.fm]},\r\n\t\t{name: \"pitchShift\",             computeIndex:       EnvelopeComputeIndex.pitchShift,             displayName: \"pitch shift\",      /*perNote:  true,*/ interleave: false, isFilter: false, /*range: Config.pitchShiftRange,         */    maxCount: 1,    effect: EffectType.pitchShift,   compatibleInstruments: null},\r\n\t\t{name: \"detune\",                 computeIndex:       EnvelopeComputeIndex.detune,                 displayName: \"detune\",           /*perNote:  true,*/ interleave: false, isFilter: false, /*range: Config.detuneMax + 1,           */    maxCount: 1,    effect: EffectType.detune,       compatibleInstruments: null},\r\n\t\t{name: \"vibratoDepth\",           computeIndex:       EnvelopeComputeIndex.vibratoDepth,           displayName: \"vibrato range\",    /*perNote:  true,*/ interleave: false, isFilter: false, /*range: Config.defaultAutomationRange,  */    maxCount: 1,    effect: EffectType.vibrato,      compatibleInstruments: null},\r\n\t\t{name: \"noteFilterAllFreqs\",     computeIndex:       EnvelopeComputeIndex.noteFilterAllFreqs,     displayName: \"n. filter freqs\",  /*perNote:  true,*/ interleave: false, isFilter:  true, /*range: null,                           */    maxCount: 1,    effect: EffectType.noteFilter,   compatibleInstruments: null},\r\n\t\t{name: \"noteFilterFreq\",         computeIndex:       EnvelopeComputeIndex.noteFilterFreq0,        displayName: \"n. filter # freq\", /*perNote:  true,*/ interleave: false/*true*/, isFilter:  true, /*range: Config.filterFreqRange, */    maxCount: Config.filterMaxPoints, effect: EffectType.noteFilter, compatibleInstruments: null},\r\n\t\t// Controlling filter gain is less obvious and intuitive than controlling filter freq, so to avoid confusion I've disabled it for envelopes.\r\n\t\t{name: \"noteFilterGain\",         computeIndex:                           null,                    displayName: \"n. filter # vol\",  /*perNote:  true,*/ interleave: false, isFilter:  true, /*range: Config.filterGainRange,         */    maxCount: Config.filterMaxPoints, effect: EffectType.noteFilter, compatibleInstruments: null},\r\n\t\t{name: \"supersawDynamism\",       computeIndex:       EnvelopeComputeIndex.supersawDynamism,       displayName: \"dynamism\",         /*perNote:  true,*/ interleave: false, isFilter: false, /*range: Config.supersawDynamismMax + 1, */    maxCount: 1,    effect: null,                    compatibleInstruments: [InstrumentType.supersaw]},\r\n\t\t{name: \"supersawSpread\",         computeIndex:       EnvelopeComputeIndex.supersawSpread,         displayName: \"spread\",           /*perNote:  true,*/ interleave: false, isFilter: false, /*range: Config.supersawSpreadMax + 1,   */    maxCount: 1,    effect: null,                    compatibleInstruments: [InstrumentType.supersaw]},\r\n\t\t{name: \"supersawShape\",          computeIndex:       EnvelopeComputeIndex.supersawShape,          displayName: \"sawpulse\",        /*perNote:  true,*/ interleave: false, isFilter: false, /*range: Config.supersawShapeMax + 1,    */    maxCount: 1,    effect: null,                    compatibleInstruments: [InstrumentType.supersaw]},\r\n\t\t/*\r\n\t\t{name: \"distortion\",             computeIndex: InstrumentAutomationIndex.distortion,             displayName: \"distortion\",       perNote: false, interleave: false, isFilter: false, range: Config.distortionRange,             maxCount: 1,    effect: EffectType.distortion,   compatibleInstruments: null},\r\n\t\t{name: \"bitcrusherQuantization\", computeIndex: InstrumentAutomationIndex.bitcrusherQuantization, displayName: \"bit crush\",        perNote: false, interleave: false, isFilter: false, range: Config.bitcrusherQuantizationRange, maxCount: 1,    effect: EffectType.bitcrusher,   compatibleInstruments: null},\r\n\t\t{name: \"bitcrusherFrequency\",    computeIndex: InstrumentAutomationIndex.bitcrusherFrequency,    displayName: \"freq crush\",       perNote: false, interleave: false, isFilter: false, range: Config.bitcrusherFreqRange,         maxCount: 1,    effect: EffectType.bitcrusher,   compatibleInstruments: null},\r\n\t\t{name: \"eqFilterAllFreqs\",       computeIndex: InstrumentAutomationIndex.eqFilterAllFreqs,       displayName: \"eq filter freqs\",  perNote: false, interleave: false, isFilter:  true, range: null,                               maxCount: 1,    effect: null,                    compatibleInstruments: null},\r\n\t\t{name: \"eqFilterFreq\",           computeIndex: InstrumentAutomationIndex.eqFilterFreq0,          displayName: \"eq filter # freq\", perNote: false, interleave:  true, isFilter:  true, range: Config.filterFreqRange,             maxCount: Config.filterMaxPoints, effect: null,  compatibleInstruments: null},\r\n\t\t{name: \"eqFilterGain\",           computeIndex: InstrumentAutomationIndex.eqFilterGain0,          displayName: \"eq filter # vol\",  perNote: false, interleave: false, isFilter:  true, range: Config.filterGainRange,             maxCount: Config.filterMaxPoints, effect: null,  compatibleInstruments: null},\r\n\t\t{name: \"panning\",                computeIndex: InstrumentAutomationIndex.panning,                displayName: \"panning\",          perNote: false, interleave: false, isFilter: false, range: Config.panMax + 1,                  maxCount: 1,    effect: EffectType.panning,      compatibleInstruments: null},\r\n\t\t{name: \"chorus\",                 computeIndex: InstrumentAutomationIndex.chorus,                 displayName: \"chorus\",           perNote: false, interleave: false, isFilter: false, range: Config.chorusRange,                 maxCount: 1,    effect: EffectType.chorus,       compatibleInstruments: null},\r\n\t\t{name: \"echoSustain\",            computeIndex: InstrumentAutomationIndex.echoSustain,            displayName: \"echo\",             perNote: false, interleave: false, isFilter: false, range: Config.echoSustainRange,            maxCount: 1,    effect: EffectType.echo,         compatibleInstruments: null},\r\n\t\t{name: \"echoDelay\",              computeIndex: InstrumentAutomationIndex.echoDelay,              displayName: \"echo delay\",       perNote: false, interleave: false, isFilter: false, range: Config.echoDelayRange,              maxCount: 1,    effect: EffectType.echo,         compatibleInstruments: null}, // wait until after we're computing a tick's settings for multiple run lengths.\r\n\t\t{name: \"reverb\",                 computeIndex: InstrumentAutomationIndex.reverb,                 displayName: \"reverb\",           perNote: false, interleave: false, isFilter: false, range: Config.reverbRange,                 maxCount: 1,    effect: EffectType.reverb,       compatibleInstruments: null},\r\n\t\t{name: \"mixVolume\",              computeIndex: InstrumentAutomationIndex.mixVolume,              displayName: \"mix volume\",       perNote: false, interleave: false, isFilter: false, range: Config.volumeRange,                 maxCount: 1,    effect: null,                    compatibleInstruments: null},\r\n\t\t{name: \"envelope#\",              computeIndex: null,                                             displayName: \"envelope\",         perNote: false, interleave: false, isFilter: false, range: Config.defaultAutomationRange,      maxCount: Config.maxEnvelopeCount, effect: null, compatibleInstruments: null}, // maxCount special case for envelopes to be allowed to target earlier ones.\r\n\t\t*/\r\n\t]);\r\n}\r\n\r\nfunction centerWave(wave: Array<number>): Float32Array {\r\n\tlet sum: number = 0.0;\r\n\tfor (let i: number = 0; i < wave.length; i++) sum += wave[i];\r\n\tconst average: number = sum / wave.length;\r\n\tfor (let i: number = 0; i < wave.length; i++) wave[i] -= average;\r\n\tperformIntegral(wave);\r\n\t// The first sample should be zero, and we'll duplicate it at the end for easier interpolation.\r\n\twave.push(0);\r\n\treturn new Float32Array(wave);\r\n}\r\n\r\nexport function performIntegral(wave: {length: number, [index: number]: number}): void {\r\n\t// Perform the integral on the wave. The synth function will perform the derivative to get the original wave back but with antialiasing.\r\n\tlet cumulative: number = 0.0;\r\n\tfor (let i: number = 0; i < wave.length; i++) {\r\n\t\tconst temp = wave[i];\r\n\t\twave[i] = cumulative;\r\n\t\tcumulative += temp;\r\n\t}\r\n}\r\n\r\nexport function getPulseWidthRatio(pulseWidth: number): number {\r\n\treturn Math.pow(0.5, (Config.pulseWidthRange - 1 - pulseWidth) * Config.pulseWidthStepPower) * 0.5;\r\n}\r\n\r\n// The function arguments will be defined in FFT.ts, but I want\r\n// SynthConfig.ts to be at the top of the compiled JS so I won't directly\r\n// depend on FFT here. synth.ts will take care of importing FFT.ts.\r\n//function inverseRealFourierTransform(array: {length: number, [index: number]: number}, fullArrayLength: number): void;\r\n//function scaleElementsByFactor(array: {length: number, [index: number]: number}, factor: number): void;\r\nexport function getDrumWave(index: number, inverseRealFourierTransform: Function | null, scaleElementsByFactor: Function | null): Float32Array {\r\n\tlet wave: Float32Array | null = Config.chipNoises[index].samples;\r\n\tif (wave == null) {\r\n\t\twave = new Float32Array(Config.chipNoiseLength + 1);\r\n\t\tConfig.chipNoises[index].samples = wave;\r\n\t\t\r\n\t\tif (index == 0) {\r\n\t\t\t// The \"retro\" drum uses a \"Linear Feedback Shift Register\" similar to the NES noise channel.\r\n\t\t\tlet drumBuffer: number = 1;\r\n\t\t\tfor (let i: number = 0; i < Config.chipNoiseLength; i++) {\r\n\t\t\t\twave[i] = (drumBuffer & 1) * 2.0 - 1.0;\r\n\t\t\t\tlet newBuffer: number = drumBuffer >> 1;\r\n\t\t\t\tif (((drumBuffer + newBuffer) & 1) == 1) {\r\n\t\t\t\t\tnewBuffer += 1 << 14;\r\n\t\t\t\t}\r\n\t\t\t\tdrumBuffer = newBuffer;\r\n\t\t\t}\r\n\t\t} else if (index == 1) {\r\n\t\t\t// White noise is just random values for each sample.\r\n\t\t\tfor (let i: number = 0; i < Config.chipNoiseLength; i++) {\r\n\t\t\t\twave[i] = Math.random() * 2.0 - 1.0;\r\n\t\t\t}\r\n\t\t} else if (index == 2) {\r\n\t\t\t// The \"clang\" noise wave is based on a similar noise wave in the modded beepbox made by DAzombieRE.\r\n\t\t\tlet drumBuffer: number = 1;\r\n\t\t\tfor (let i: number = 0; i < Config.chipNoiseLength; i++) {\r\n\t\t\t\twave[i] = (drumBuffer & 1) * 2.0 - 1.0;\r\n\t\t\t\tlet newBuffer: number = drumBuffer >> 1;\r\n\t\t\t\tif (((drumBuffer + newBuffer) & 1) == 1) {\r\n\t\t\t\t\tnewBuffer += 2 << 14;\r\n\t\t\t\t}\r\n\t\t\t\tdrumBuffer = newBuffer;\r\n\t\t\t}\r\n\t\t} else if (index == 3) {\r\n\t\t\t// The \"buzz\" noise wave is based on a similar noise wave in the modded beepbox made by DAzombieRE.\r\n\t\t\tlet drumBuffer: number = 1;\r\n\t\t\tfor (let i: number = 0; i < Config.chipNoiseLength; i++) {\r\n\t\t\t\twave[i] = (drumBuffer & 1) * 2.0 - 1.0;\r\n\t\t\t\tlet newBuffer: number = drumBuffer >> 1;\r\n\t\t\t\tif (((drumBuffer + newBuffer) & 1) == 1) {\r\n\t\t\t\t\tnewBuffer += 10 << 2;\r\n\t\t\t\t}\r\n\t\t\t\tdrumBuffer = newBuffer;\r\n\t\t\t}\r\n\t\t} else if (index == 4) {\r\n\t\t\t// \"hollow\" drums, designed in frequency space and then converted via FFT:\r\n\t\t\tdrawNoiseSpectrum(wave, Config.chipNoiseLength, 10, 11, 1, 1, 0);\r\n\t\t\tdrawNoiseSpectrum(wave, Config.chipNoiseLength, 11, 14, .6578, .6578, 0);\r\n\t\t\tinverseRealFourierTransform!(wave, Config.chipNoiseLength);\r\n\t\t\tscaleElementsByFactor!(wave, 1.0 / Math.sqrt(Config.chipNoiseLength));\r\n\t\t} else {\r\n\t\t\tthrow new Error(\"Unrecognized drum index: \" + index);\r\n\t\t}\r\n\t\t\r\n\t\twave[Config.chipNoiseLength] = wave[0];\r\n\t}\r\n\t\r\n\treturn wave;\r\n}\r\n\r\nexport function drawNoiseSpectrum(wave: Float32Array, waveLength: number, lowOctave: number, highOctave: number, lowPower: number, highPower: number, overallSlope: number): number {\r\n\tconst referenceOctave: number = 11;\r\n\tconst referenceIndex: number = 1 << referenceOctave;\r\n\tconst lowIndex: number = Math.pow(2, lowOctave) | 0;\r\n\tconst highIndex: number = Math.min(waveLength >> 1, Math.pow(2, highOctave) | 0);\r\n\tconst retroWave: Float32Array = getDrumWave(0, null, null);\r\n\tlet combinedAmplitude: number = 0.0;\r\n\tfor (let i: number = lowIndex; i < highIndex; i++) {\r\n\t\t\r\n\t\tlet lerped: number = lowPower + (highPower - lowPower) * (Math.log2(i) - lowOctave) / (highOctave - lowOctave);\r\n\t\tlet amplitude: number = Math.pow(2, (lerped - 1) * 7 + 1) * lerped;\r\n\t\t\r\n\t\tamplitude *= Math.pow(i / referenceIndex, overallSlope);\r\n\t\t\r\n\t\tcombinedAmplitude += amplitude;\r\n\t\t\r\n\t\t// Add two different sources of psuedo-randomness to the noise\r\n\t\t// (individually they aren't random enough) but in a deterministic\r\n\t\t// way so that live spectrum editing doesn't result in audible pops.\r\n\t\t// Multiply all the sine wave amplitudes by 1 or -1 based on the\r\n\t\t// LFSR retro wave (effectively random), and also rotate the phase\r\n\t\t// of each sine wave based on the golden angle to disrupt the symmetry.\r\n\t\tamplitude *= retroWave[i];\r\n\t\tconst radians: number = 0.61803398875 * i * i * Math.PI * 2.0;\r\n\t\t\r\n\t\twave[i] = Math.cos(radians) * amplitude;\r\n\t\twave[waveLength - i] = Math.sin(radians) * amplitude;\r\n\t}\r\n\t\r\n\treturn combinedAmplitude;\r\n}\r\n\r\nfunction generateSineWave(): Float32Array {\r\n\tconst wave: Float32Array = new Float32Array(Config.sineWaveLength + 1);\r\n\tfor (let i: number = 0; i < Config.sineWaveLength + 1; i++) {\r\n\t\twave[i] = Math.sin(i * Math.PI * 2.0 / Config.sineWaveLength);\r\n\t}\r\n\treturn wave;\r\n}\r\n\r\nexport function getArpeggioPitchIndex(pitchCount: number, rhythm: number, arpeggio: number): number {\r\n\tconst arpeggioPattern: ReadonlyArray<number> = Config.rhythms[rhythm].arpeggioPatterns[pitchCount - 1];\r\n\tif (arpeggioPattern != null) {\r\n\t\treturn arpeggioPattern[arpeggio % arpeggioPattern.length];\r\n\t} else {\r\n\t\treturn arpeggio % pitchCount;\r\n\t}\r\n}\r\n\r\n// Pardon the messy type casting. This allows accessing array members by numerical index or string name.\r\nexport function toNameMap<T extends BeepBoxOption>(array: Array<Pick<T, Exclude<keyof T, \"index\">>>): DictionaryArray<T> {\r\n\tconst dictionary: Dictionary<T> = {};\r\n\tfor (let i: number = 0; i < array.length; i++) {\r\n\t\tconst value: any = array[i];\r\n\t\tvalue.index = i;\r\n\t\tdictionary[value.name] = <T> value;\r\n\t}\r\n\tconst result: DictionaryArray<T> = <DictionaryArray<T>> <any> array;\r\n\tresult.dictionary = dictionary;\r\n\treturn result;\r\n}\r\n\r\nexport function effectsIncludeTransition(effects: number): boolean {\r\n\treturn (effects & (1 << EffectType.transition)) != 0;\r\n}\r\nexport function effectsIncludeChord(effects: number): boolean {\r\n\treturn (effects & (1 << EffectType.chord)) != 0;\r\n}\r\nexport function effectsIncludePitchShift(effects: number): boolean {\r\n\treturn (effects & (1 << EffectType.pitchShift)) != 0;\r\n}\r\nexport function effectsIncludeDetune(effects: number): boolean {\r\n\treturn (effects & (1 << EffectType.detune)) != 0;\r\n}\r\nexport function effectsIncludeVibrato(effects: number): boolean {\r\n\treturn (effects & (1 << EffectType.vibrato)) != 0;\r\n}\r\nexport function effectsIncludeNoteFilter(effects: number): boolean {\r\n\treturn (effects & (1 << EffectType.noteFilter)) != 0;\r\n}\r\nexport function effectsIncludeDistortion(effects: number): boolean {\r\n\treturn (effects & (1 << EffectType.distortion)) != 0;\r\n}\r\nexport function effectsIncludeBitcrusher(effects: number): boolean {\r\n\treturn (effects & (1 << EffectType.bitcrusher)) != 0;\r\n}\r\nexport function effectsIncludePanning(effects: number): boolean {\r\n\treturn (effects & (1 << EffectType.panning)) != 0;\r\n}\r\nexport function effectsIncludeChorus(effects: number): boolean {\r\n\treturn (effects & (1 << EffectType.chorus)) != 0;\r\n}\r\nexport function effectsIncludeEcho(effects: number): boolean {\r\n\treturn (effects & (1 << EffectType.echo)) != 0;\r\n}\r\nexport function effectsIncludeReverb(effects: number): boolean {\r\n\treturn (effects & (1 << EffectType.reverb)) != 0;\r\n}\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nimport {DictionaryArray, BeepBoxOption, InstrumentType, toNameMap} from \"../synth/SynthConfig\";\r\n\r\nexport interface PresetCategory extends BeepBoxOption {\r\n\treadonly presets: DictionaryArray<Preset>;\r\n}\r\n\r\nexport interface Preset extends BeepBoxOption {\r\n\treadonly isNoise?: boolean;\r\n\treadonly generalMidi?: boolean;\r\n\treadonly midiProgram?: number;\r\n\treadonly midiSubharmonicOctaves?: number;\r\n\treadonly customType?: InstrumentType;\r\n\treadonly settings?: any;\r\n}\r\n\r\nexport const isMobile: boolean = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini|android|ipad|playbook|silk/i.test(navigator.userAgent);\r\n\r\nexport function prettyNumber(value: number): string {\r\n\treturn value.toFixed(2).replace(/\\.?0*$/, \"\");\r\n}\r\n\r\nexport class EditorConfig {\r\n\tpublic static readonly version: string = \"4.2\";\r\n\t\r\n\tpublic static readonly versionDisplayName: string = \"BeepBox\";\r\n\tpublic static readonly releaseNotesURL: string = \"https://github.com/johnnesky/beepbox/releases/tag/v\" + EditorConfig.version;\r\n\t\r\n\tpublic static readonly isOnMac: boolean = /^Mac/i.test(navigator.platform) || /Mac OS X/i.test(navigator.userAgent) || /^(iPhone|iPad|iPod)/i.test(navigator.platform) || /(iPhone|iPad|iPod)/i.test(navigator.userAgent);\r\n\tpublic static readonly ctrlSymbol: string = EditorConfig.isOnMac ? \"\" : \"Ctrl+\";\r\n\tpublic static readonly ctrlName: string = EditorConfig.isOnMac ? \"command\" : \"control\";\r\n\t\r\n\tpublic static readonly presetCategories: DictionaryArray<PresetCategory> = toNameMap([\r\n\t\t{name: \"Custom Instruments\", presets: <DictionaryArray<Preset>> toNameMap([\r\n\t\t\t{name: \"chip wave\",        customType: InstrumentType.chip},\r\n\t\t\t{name: \"FM (expert)\",      customType: InstrumentType.fm},\r\n\t\t\t{name: \"basic noise\",      customType: InstrumentType.noise},\r\n\t\t\t{name: \"spectrum\",         customType: InstrumentType.spectrum},\r\n\t\t\t{name: \"drumset\",          customType: InstrumentType.drumset},\r\n\t\t\t{name: \"harmonics\",        customType: InstrumentType.harmonics},\r\n\t\t\t{name: \"pulse width\",      customType: InstrumentType.pwm},\r\n\t\t\t{name: \"picked string\",    customType: InstrumentType.pickedString},\r\n\t\t\t{name: \"supersaw\",         customType: InstrumentType.supersaw},\r\n\t\t])},\r\n\t\t{name: \"Retro Presets\", presets: <DictionaryArray<Preset>> toNameMap([\r\n\t\t\t{name: \"square wave\",      midiProgram:  80, settings: {\"type\":\"chip\",\"eqFilter\":[],\"effects\":[],\"transition\":\"interrupt\",\"fadeInSeconds\":0,\"fadeOutTicks\":-1,\"chord\":\"arpeggio\",\"wave\":\"square\",\"unison\":\"none\",\"envelopes\":[]}},\r\n\t\t\t{name: \"triangle wave\",    midiProgram:  71, settings: {\"type\":\"chip\",\"eqFilter\":[],\"effects\":[],\"transition\":\"interrupt\",\"fadeInSeconds\":0,\"fadeOutTicks\":-1,\"chord\":\"arpeggio\",\"wave\":\"triangle\",\"unison\":\"none\",\"envelopes\":[]}},\r\n\t\t\t{name: \"square lead\",      midiProgram:  80, generalMidi: true, settings: {\"type\":\"chip\",\"eqFilter\":[{\"type\":\"low-pass\",\"cutoffHz\":8000,\"linearGain\":0.3536}],\"effects\":[],\"transition\":\"normal\",\"fadeInSeconds\":0,\"fadeOutTicks\":-3,\"chord\":\"simultaneous\",\"wave\":\"square\",\"unison\":\"hum\",\"envelopes\":[]}},\r\n\t\t\t{name: \"sawtooth lead 1\",  midiProgram:  81, generalMidi: true, settings: {\"type\":\"chip\",\"eqFilter\":[{\"type\":\"low-pass\",\"cutoffHz\":4000,\"linearGain\":0.5}],\"effects\":[],\"transition\":\"normal\",\"fadeInSeconds\":0,\"fadeOutTicks\":-3,\"chord\":\"simultaneous\",\"wave\":\"sawtooth\",\"unison\":\"shimmer\",\"envelopes\":[]}},\r\n\t\t\t{name: \"sawtooth lead 2\",  midiProgram:  81, settings: {\"type\":\"chip\",\"eqFilter\":[{\"type\":\"low-pass\",\"cutoffHz\":6727.17,\"linearGain\":1}],\"effects\":[\"vibrato\"],\"vibrato\":\"light\",\"transition\":\"normal\",\"fadeInSeconds\":0.0125,\"fadeOutTicks\":72,\"chord\":\"simultaneous\",\"wave\":\"sawtooth\",\"unison\":\"hum\",\"envelopes\":[]}},\r\n\t\t\t{name: \"chip noise\",       midiProgram: 116, isNoise: true, settings: {\"type\":\"noise\",\"transition\":\"hard\",\"effects\":\"none\",\"chord\":\"arpeggio\",\"filterCutoffHz\":4000,\"filterResonance\":0,\"filterEnvelope\":\"steady\",\"wave\":\"retro\"}},\r\n\t\t\t{name: \"FM twang\",         midiProgram:  32, settings: {\"type\":\"FM\",\"eqFilter\":[],\"effects\":[],\"transition\":\"normal\",\"fadeInSeconds\":0,\"fadeOutTicks\":-3,\"chord\":\"simultaneous\",\"algorithm\":\"1(234)\",\"feedbackType\":\"1\",\"feedbackAmplitude\":0,\"operators\":[{\"frequency\":\"1\",\"amplitude\":15},{\"frequency\":\"1\",\"amplitude\":15},{\"frequency\":\"1\",\"amplitude\":0},{\"frequency\":\"1\",\"amplitude\":0}],\"envelopes\":[{\"target\":\"operatorAmplitude\",\"envelope\":\"twang 2\",\"index\":1}]}},\r\n\t\t\t{name: \"FM bass\",          midiProgram:  36, settings: {\"type\":\"FM\",\"eqFilter\":[],\"effects\":[],\"transition\":\"normal\",\"fadeInSeconds\":0,\"fadeOutTicks\":-3,\"chord\":\"custom interval\",\"algorithm\":\"1(234)\",\"feedbackType\":\"1\",\"feedbackAmplitude\":0,\"operators\":[{\"frequency\":\"2\",\"amplitude\":11},{\"frequency\":\"1\",\"amplitude\":7},{\"frequency\":\"1\",\"amplitude\":9},{\"frequency\":\"20\",\"amplitude\":3}],\"envelopes\":[{\"target\":\"operatorAmplitude\",\"envelope\":\"twang 2\",\"index\":1},{\"target\":\"operatorAmplitude\",\"envelope\":\"twang 3\",\"index\":2},{\"target\":\"operatorAmplitude\",\"envelope\":\"twang 2\",\"index\":3}]}},\r\n\t\t\t{name: \"FM flute\",         midiProgram:  73, settings: {\"type\":\"FM\",\"eqFilter\":[],\"effects\":[],\"transition\":\"normal\",\"fadeInSeconds\":0.0263,\"fadeOutTicks\":-3,\"chord\":\"simultaneous\",\"algorithm\":\"1(234)\",\"feedbackType\":\"1\",\"feedbackAmplitude\":0,\"operators\":[{\"frequency\":\"1\",\"amplitude\":15},{\"frequency\":\"1\",\"amplitude\":6},{\"frequency\":\"1\",\"amplitude\":0},{\"frequency\":\"1\",\"amplitude\":0}],\"envelopes\":[{\"target\":\"operatorAmplitude\",\"envelope\":\"twang 2\",\"index\":1}]}},\r\n\t\t\t{name: \"FM organ\",         midiProgram:  16, settings: {\"type\":\"FM\",\"eqFilter\":[],\"effects\":[\"vibrato\"],\"vibrato\":\"delayed\",\"transition\":\"normal\",\"fadeInSeconds\":0.0263,\"fadeOutTicks\":-3,\"chord\":\"custom interval\",\"algorithm\":\"1324\",\"feedbackType\":\"12\",\"feedbackAmplitude\":0,\"operators\":[{\"frequency\":\"1\",\"amplitude\":14},{\"frequency\":\"2\",\"amplitude\":14},{\"frequency\":\"1\",\"amplitude\":11},{\"frequency\":\"2\",\"amplitude\":11}],\"envelopes\":[]}},\r\n\t\t\t{name: \"supersaw lead\",    midiProgram:  81, settings: {\"type\":\"supersaw\",\"eqFilter\":[{\"type\":\"low-pass\",\"cutoffHz\":6727.17,\"linearGain\":2}],\"effects\":[\"reverb\"],\"reverb\":67,\"fadeInSeconds\":0,\"fadeOutTicks\":-6,\"pulseWidth\":50,\"dynamism\":100,\"spread\":58,\"shape\":0,\"envelopes\":[]}},\r\n\t\t])},\r\n\t\t{name: \"Keyboard Presets\", presets: <DictionaryArray<Preset>> toNameMap([\r\n\t\t\t{name: \"grand piano\",      midiProgram:   0, generalMidi: true, settings: {\"type\":\"Picked String\",\"eqFilter\":[{\"type\":\"high-pass\",\"cutoffHz\":148.65,\"linearGain\":0.7071},{\"type\":\"peak\",\"cutoffHz\":1681.79,\"linearGain\":4},{\"type\":\"low-pass\",\"cutoffHz\":8000,\"linearGain\":0.1768},{\"type\":\"peak\",\"cutoffHz\":3363.59,\"linearGain\":4},{\"type\":\"peak\",\"cutoffHz\":2378.41,\"linearGain\":0.25}],\"effects\":[\"note filter\",\"reverb\"],\"noteFilter\":[{\"type\":\"low-pass\",\"cutoffHz\":4756.83,\"linearGain\":0.3536},{\"type\":\"high-pass\",\"cutoffHz\":125,\"linearGain\":0.0884}],\"reverb\":67,\"fadeInSeconds\":0,\"fadeOutTicks\":48,\"harmonics\":[100,100,86,86,86,71,71,71,0,71,71,71,71,57,57,71,57,14,57,57,57,57,57,57,57,57,29,57],\"unison\":\"piano\",\"stringSustain\":86,\"stringSustainType\":\"acoustic\",\"envelopes\":[{\"target\":\"noteFilterFreq\",\"envelope\":\"note size\",\"index\":0},{\"target\":\"noteFilterFreq\",\"envelope\":\"twang 1\",\"index\":1},{\"target\":\"noteFilterFreq\",\"envelope\":\"twang 1\",\"index\":1}]}},\r\n\t\t\t{name: \"bright piano\",     midiProgram:   1, generalMidi: true, settings: {\"type\":\"Picked String\",\"eqFilter\":[{\"type\":\"low-pass\",\"cutoffHz\":1681.79,\"linearGain\":0.7071},{\"type\":\"high-pass\",\"cutoffHz\":148.65,\"linearGain\":0.5},{\"type\":\"peak\",\"cutoffHz\":3363.59,\"linearGain\":1.4142}],\"effects\":[\"reverb\"],\"reverb\":33,\"transition\":\"normal\",\"fadeInSeconds\":0,\"fadeOutTicks\":24,\"chord\":\"simultaneous\",\"harmonics\":[100,100,86,86,71,71,0,71,71,71,71,71,71,14,57,57,57,57,57,57,29,57,57,57,57,57,57,57],\"unison\":\"piano\",\"stringSustain\":86,\"envelopes\":[]}},\r\n\t\t\t{name: \"electric grand\",   midiProgram:   2, generalMidi: true, settings: {\"type\":\"chip\",\"eqFilter\":[],\"effects\":[\"note filter\"],\"noteFilter\":[{\"type\":\"low-pass\",\"cutoffHz\":2378.41,\"linearGain\":0.5}],\"transition\":\"normal\",\"fadeInSeconds\":0,\"fadeOutTicks\":48,\"chord\":\"simultaneous\",\"wave\":\"1/8 pulse\",\"unison\":\"shimmer\",\"envelopes\":[{\"target\":\"noteFilterAllFreqs\",\"envelope\":\"twang 3\"}]}},\r\n\t\t\t{name: \"honky-tonk piano\", midiProgram:   3, generalMidi: true, settings: {\"type\":\"Picked String\",\"eqFilter\":[{\"type\":\"low-pass\",\"cutoffHz\":5656.85,\"linearGain\":0.3536}],\"effects\":[\"reverb\"],\"reverb\":33,\"transition\":\"normal\",\"fadeInSeconds\":0,\"fadeOutTicks\":48,\"chord\":\"simultaneous\",\"harmonics\":[100,100,86,71,86,71,43,71,43,43,57,57,57,29,57,57,57,57,57,57,43,57,57,57,43,43,43,43],\"unison\":\"honky tonk\",\"stringSustain\":71,\"envelopes\":[]}},\r\n\t\t\t{name: \"electric piano 1\", midiProgram:   4, generalMidi: true, settings: {\"type\":\"harmonics\",\"eqFilter\":[],\"effects\":[\"note filter\"],\"noteFilter\":[{\"type\":\"low-pass\",\"cutoffHz\":3363.59,\"linearGain\":0.5}],\"transition\":\"normal\",\"fadeInSeconds\":0,\"fadeOutTicks\":-3,\"chord\":\"simultaneous\",\"harmonics\":[86,100,100,71,71,57,57,43,43,43,29,29,29,14,14,14,0,0,0,0,0,57,0,0,0,0,0,0],\"unison\":\"none\",\"envelopes\":[{\"target\":\"noteFilterAllFreqs\",\"envelope\":\"twang 2\"}]}},\r\n\t\t\t{name: \"electric piano 2\", midiProgram:   5, generalMidi: true, settings: {\"type\":\"FM\",\"eqFilter\":[],\"effects\":[\"note filter\"],\"noteFilter\":[{\"type\":\"low-pass\",\"cutoffHz\":13454.34,\"linearGain\":0.25}],\"transition\":\"normal\",\"fadeInSeconds\":0,\"fadeOutTicks\":48,\"chord\":\"simultaneous\",\"algorithm\":\"1324\",\"feedbackType\":\"12\",\"feedbackAmplitude\":0,\"operators\":[{\"frequency\":\"1\",\"amplitude\":12},{\"frequency\":\"1\",\"amplitude\":6},{\"frequency\":\"1\",\"amplitude\":9},{\"frequency\":\"16\",\"amplitude\":6}],\"envelopes\":[{\"target\":\"noteFilterAllFreqs\",\"envelope\":\"twang 3\"},{\"target\":\"operatorAmplitude\",\"envelope\":\"twang 3\",\"index\":3}]}},\r\n\t\t\t{name: \"harpsichord\",      midiProgram:   6, generalMidi: true, settings: {\"type\":\"Picked String\",\"eqFilter\":[{\"type\":\"high-pass\",\"cutoffHz\":250,\"linearGain\":0.3536},{\"type\":\"peak\",\"cutoffHz\":11313.71,\"linearGain\":2.8284}],\"effects\":[\"reverb\"],\"reverb\":33,\"transition\":\"normal\",\"fadeInSeconds\":0,\"fadeOutTicks\":24,\"chord\":\"simultaneous\",\"harmonics\":[100,100,100,86,57,86,86,86,86,57,57,71,71,86,86,71,71,86,86,71,71,71,71,71,71,71,71,71],\"unison\":\"none\",\"stringSustain\":79,\"envelopes\":[]}},\r\n\t\t\t{name: \"clavinet\",         midiProgram:   7, generalMidi: true, settings: {\"type\":\"FM\",\"eqFilter\":[],\"effects\":[\"note filter\"],\"noteFilter\":[{\"type\":\"low-pass\",\"cutoffHz\":19027.31,\"linearGain\":0.3536}],\"transition\":\"normal\",\"fadeInSeconds\":0,\"fadeOutTicks\":-3,\"chord\":\"simultaneous\",\"algorithm\":\"1(234)\",\"feedbackType\":\"3\",\"feedbackAmplitude\":6,\"operators\":[{\"frequency\":\"3\",\"amplitude\":15},{\"frequency\":\"~1\",\"amplitude\":6},{\"frequency\":\"8\",\"amplitude\":4},{\"frequency\":\"1\",\"amplitude\":0}],\"envelopes\":[{\"target\":\"noteFilterAllFreqs\",\"envelope\":\"twang 2\"},{\"target\":\"feedbackAmplitude\",\"envelope\":\"twang 2\"}]}},\r\n\t\t\t{name: \"dulcimer\",         midiProgram:  15, generalMidi: true, settings: {\"type\":\"Picked String\",\"eqFilter\":[{\"type\":\"low-pass\",\"cutoffHz\":8000,\"linearGain\":0.3536}],\"effects\":[\"reverb\"],\"reverb\":33,\"transition\":\"normal\",\"fadeInSeconds\":0,\"fadeOutTicks\":48,\"chord\":\"strum\",\"harmonics\":[100,100,100,86,100,86,57,100,100,86,100,86,100,86,100,71,57,71,71,100,86,71,86,86,100,86,86,86],\"unison\":\"piano\",\"stringSustain\":79,\"envelopes\":[]}},\r\n\t\t])},\r\n\t\t{name: \"Idiophone Presets\", presets: <DictionaryArray<Preset>> toNameMap([\r\n\t\t\t{name: \"celesta\",          midiProgram:   8, generalMidi: true, settings: {\"type\":\"FM\",\"effects\":\"reverb\",\"transition\":\"hard fade\",\"chord\":\"strum\",\"filterCutoffHz\":5657,\"filterResonance\":14,\"filterEnvelope\":\"twang 2\",\"vibrato\":\"none\",\"algorithm\":\"(12)(34)\",\"feedbackType\":\"12\",\"feedbackAmplitude\":0,\"feedbackEnvelope\":\"steady\",\"operators\":[{\"frequency\":\"~1\",\"amplitude\":11,\"envelope\":\"custom\"},{\"frequency\":\"8\",\"amplitude\":6,\"envelope\":\"custom\"},{\"frequency\":\"20\",\"amplitude\":3,\"envelope\":\"twang 1\"},{\"frequency\":\"3\",\"amplitude\":1,\"envelope\":\"twang 2\"}]}},\r\n\t\t\t{name: \"glockenspiel\",     midiProgram:   9, generalMidi: true, settings: {\"type\":\"FM\",\"effects\":\"reverb\",\"transition\":\"hard fade\",\"chord\":\"strum\",\"filterCutoffHz\":5657,\"filterResonance\":14,\"filterEnvelope\":\"twang 2\",\"vibrato\":\"none\",\"algorithm\":\"(123)4\",\"feedbackType\":\"123\",\"feedbackAmplitude\":2,\"feedbackEnvelope\":\"decay 1\",\"operators\":[{\"frequency\":\"1\",\"amplitude\":7,\"envelope\":\"custom\"},{\"frequency\":\"5\",\"amplitude\":11,\"envelope\":\"custom\"},{\"frequency\":\"8\",\"amplitude\":7,\"envelope\":\"custom\"},{\"frequency\":\"20\",\"amplitude\":2,\"envelope\":\"twang 1\"}]}},\r\n\t\t\t{name: \"music box 1\",      midiProgram:  10, generalMidi: true, settings: {\"type\":\"Picked String\",\"eqFilter\":[{\"type\":\"low-pass\",\"cutoffHz\":4756.83,\"linearGain\":0.5}],\"effects\":[\"reverb\"],\"reverb\":33,\"transition\":\"normal\",\"fadeInSeconds\":0,\"fadeOutTicks\":48,\"chord\":\"strum\",\"harmonics\":[100,0,0,100,0,0,0,0,0,0,100,0,0,0,0,0,0,0,0,86,0,0,0,0,0,0,71,0],\"unison\":\"none\",\"stringSustain\":64,\"envelopes\":[]}},\r\n\t\t\t{name: \"music box 2\",      midiProgram:  10, settings: {\"type\":\"Picked String\",\"eqFilter\":[{\"type\":\"low-pass\",\"cutoffHz\":2828.43,\"linearGain\":0.7071}],\"effects\":[\"reverb\"],\"reverb\":33,\"transition\":\"normal\",\"fadeInSeconds\":0,\"fadeOutTicks\":48,\"chord\":\"strum\",\"harmonics\":[100,57,57,0,0,0,0,0,0,57,0,0,0,0,0,0,0,0,0,43,0,0,0,0,0,0,0,0],\"unison\":\"none\",\"stringSustain\":29,\"envelopes\":[]}},\r\n\t\t\t{name: \"vibraphone\",       midiProgram:  11, generalMidi: true, settings: {\"type\":\"FM\",\"effects\":\"reverb\",\"transition\":\"hard fade\",\"chord\":\"harmony\",\"filterCutoffHz\":2828,\"filterResonance\":14,\"filterEnvelope\":\"twang 2\",\"vibrato\":\"none\",\"algorithm\":\"1234\",\"feedbackType\":\"1234\",\"feedbackAmplitude\":3,\"feedbackEnvelope\":\"twang 1\",\"operators\":[{\"frequency\":\"1\",\"amplitude\":9,\"envelope\":\"custom\"},{\"frequency\":\"~1\",\"amplitude\":9,\"envelope\":\"custom\"},{\"frequency\":\"9\",\"amplitude\":3,\"envelope\":\"custom\"},{\"frequency\":\"4\",\"amplitude\":9,\"envelope\":\"custom\"}]}},\r\n\t\t\t{name: \"marimba\",          midiProgram:  12, generalMidi: true, settings: {\"type\":\"FM\",\"effects\":\"reverb\",\"transition\":\"hard fade\",\"chord\":\"strum\",\"filterCutoffHz\":2000,\"filterResonance\":29,\"filterEnvelope\":\"decay 1\",\"vibrato\":\"none\",\"algorithm\":\"12(34)\",\"feedbackType\":\"1\",\"feedbackAmplitude\":0,\"feedbackEnvelope\":\"steady\",\"operators\":[{\"frequency\":\"1\",\"amplitude\":10,\"envelope\":\"custom\"},{\"frequency\":\"4\",\"amplitude\":6,\"envelope\":\"custom\"},{\"frequency\":\"13\",\"amplitude\":6,\"envelope\":\"twang 1\"},{\"frequency\":\"1\",\"amplitude\":0,\"envelope\":\"steady\"}]}},\r\n\t\t\t{name: \"kalimba\",          midiProgram: 108, generalMidi: true, settings: {\"type\":\"FM\",\"effects\":\"reverb\",\"transition\":\"hard fade\",\"chord\":\"strum\",\"filterCutoffHz\":2828,\"filterResonance\":14,\"filterEnvelope\":\"decay 1\",\"vibrato\":\"none\",\"algorithm\":\"1(234)\",\"feedbackType\":\"1\",\"feedbackAmplitude\":0,\"feedbackEnvelope\":\"steady\",\"operators\":[{\"frequency\":\"1\",\"amplitude\":11,\"envelope\":\"custom\"},{\"frequency\":\"5\",\"amplitude\":3,\"envelope\":\"twang 2\"},{\"frequency\":\"20\",\"amplitude\":3,\"envelope\":\"twang 1\"},{\"frequency\":\"1\",\"amplitude\":0,\"envelope\":\"steady\"}]}},\r\n\t\t\t{name: \"xylophone\",        midiProgram:  13, generalMidi: true, settings: {\"type\":\"FM\",\"effects\":\"reverb\",\"transition\":\"hard\",\"chord\":\"strum\",\"filterCutoffHz\":2000,\"filterResonance\":14,\"filterEnvelope\":\"twang 1\",\"vibrato\":\"none\",\"algorithm\":\"(123)4\",\"feedbackType\":\"123\",\"feedbackAmplitude\":0,\"feedbackEnvelope\":\"steady\",\"operators\":[{\"frequency\":\"1\",\"amplitude\":9,\"envelope\":\"custom\"},{\"frequency\":\"6\",\"amplitude\":9,\"envelope\":\"custom\"},{\"frequency\":\"11\",\"amplitude\":9,\"envelope\":\"custom\"},{\"frequency\":\"20\",\"amplitude\":6,\"envelope\":\"twang 1\"}]}},\r\n\t\t\t{name: \"tubular bell\",     midiProgram:  14, generalMidi: true, midiSubharmonicOctaves: 1, settings: {\"type\":\"Picked String\",\"eqFilter\":[{\"type\":\"low-pass\",\"cutoffHz\":4000,\"linearGain\":0.5},{\"type\":\"high-pass\",\"cutoffHz\":105.11,\"linearGain\":0.3536}],\"effects\":[\"reverb\"],\"reverb\":33,\"transition\":\"normal\",\"fadeInSeconds\":0,\"fadeOutTicks\":96,\"chord\":\"strum\",\"harmonics\":[43,71,0,100,0,100,0,86,0,0,86,0,14,71,14,14,57,14,14,43,14,14,43,14,14,43,14,14],\"unison\":\"shimmer\",\"stringSustain\":86,\"envelopes\":[]}},\r\n\t\t\t{name: \"bell synth\",       midiProgram:  14, settings: {\"type\":\"FM\",\"effects\":\"reverb\",\"transition\":\"hard fade\",\"chord\":\"strum\",\"filterCutoffHz\":2000,\"filterResonance\":29,\"filterEnvelope\":\"twang 3\",\"vibrato\":\"none\",\"algorithm\":\"1(234)\",\"feedbackType\":\"1\",\"feedbackAmplitude\":0,\"feedbackEnvelope\":\"steady\",\"operators\":[{\"frequency\":\"~2\",\"amplitude\":10,\"envelope\":\"custom\"},{\"frequency\":\"7\",\"amplitude\":6,\"envelope\":\"twang 3\"},{\"frequency\":\"20\",\"amplitude\":1,\"envelope\":\"twang 1\"},{\"frequency\":\"1\",\"amplitude\":0,\"envelope\":\"steady\"}]}},\r\n\t\t\t{name: \"rain drop\",        midiProgram:  96, generalMidi: true, settings: {\"type\":\"FM\",\"effects\":\"reverb\",\"transition\":\"hard fade\",\"chord\":\"strum\",\"filterCutoffHz\":4000,\"filterResonance\":14,\"filterEnvelope\":\"twang 1\",\"vibrato\":\"none\",\"algorithm\":\"(12)(34)\",\"feedbackType\":\"12\",\"feedbackAmplitude\":0,\"feedbackEnvelope\":\"steady\",\"operators\":[{\"frequency\":\"1\",\"amplitude\":12,\"envelope\":\"custom\"},{\"frequency\":\"6\",\"amplitude\":4,\"envelope\":\"custom\"},{\"frequency\":\"20\",\"amplitude\":3,\"envelope\":\"twang 1\"},{\"frequency\":\"1\",\"amplitude\":6,\"envelope\":\"tremolo1\"}]}},\r\n\t\t\t{name: \"crystal\",          midiProgram:  98, generalMidi: true, settings: {\"type\":\"FM\",\"effects\":\"reverb\",\"transition\":\"hard fade\",\"chord\":\"harmony\",\"filterCutoffHz\":2828,\"filterResonance\":14,\"filterEnvelope\":\"twang 2\",\"vibrato\":\"delayed\",\"algorithm\":\"1234\",\"feedbackType\":\"1 2 3 4\",\"feedbackAmplitude\":4,\"feedbackEnvelope\":\"twang 1\",\"operators\":[{\"frequency\":\"1\",\"amplitude\":10,\"envelope\":\"custom\"},{\"frequency\":\"3\",\"amplitude\":7,\"envelope\":\"custom\"},{\"frequency\":\"6\",\"amplitude\":4,\"envelope\":\"custom\"},{\"frequency\":\"13\",\"amplitude\":4,\"envelope\":\"custom\"}]}},\r\n\t\t\t{name: \"tinkle bell\",      midiProgram: 112, generalMidi: true, settings: {\"type\":\"FM\",\"effects\":\"reverb\",\"transition\":\"hard\",\"chord\":\"strum\",\"filterCutoffHz\":2828,\"filterResonance\":14,\"filterEnvelope\":\"twang 2\",\"vibrato\":\"none\",\"algorithm\":\"1234\",\"feedbackType\":\"1234\",\"feedbackAmplitude\":5,\"feedbackEnvelope\":\"twang 3\",\"operators\":[{\"frequency\":\"~2\",\"amplitude\":7,\"envelope\":\"custom\"},{\"frequency\":\"5\",\"amplitude\":7,\"envelope\":\"custom\"},{\"frequency\":\"7\",\"amplitude\":7,\"envelope\":\"custom\"},{\"frequency\":\"16\",\"amplitude\":7,\"envelope\":\"custom\"}]}},\r\n\t\t\t{name: \"agogo\",            midiProgram: 113, generalMidi: true, settings: {\"type\":\"FM\",\"effects\":\"reverb\",\"transition\":\"hard fade\",\"chord\":\"strum\",\"filterCutoffHz\":4000,\"filterResonance\":14,\"filterEnvelope\":\"decay 1\",\"vibrato\":\"none\",\"algorithm\":\"1234\",\"feedbackType\":\"14\",\"feedbackAmplitude\":15,\"feedbackEnvelope\":\"decay 1\",\"operators\":[{\"frequency\":\"2\",\"amplitude\":9,\"envelope\":\"custom\"},{\"frequency\":\"5\",\"amplitude\":6,\"envelope\":\"custom\"},{\"frequency\":\"8\",\"amplitude\":9,\"envelope\":\"custom\"},{\"frequency\":\"13\",\"amplitude\":11,\"envelope\":\"custom\"}]}},\r\n\t\t])},\r\n\t\t{name: \"Guitar Presets\", presets: <DictionaryArray<Preset>> toNameMap([\r\n\t\t\t{name: \"nylon guitar\",     midiProgram:  24, generalMidi: true, settings: {\"type\":\"FM\",\"effects\":\"reverb\",\"transition\":\"hard fade\",\"chord\":\"strum\",\"filterCutoffHz\":5657,\"filterResonance\":14,\"filterEnvelope\":\"twang 1\",\"vibrato\":\"none\",\"algorithm\":\"1234\",\"feedbackType\":\"3\",\"feedbackAmplitude\":6,\"feedbackEnvelope\":\"twang 1\",\"operators\":[{\"frequency\":\"1\",\"amplitude\":15,\"envelope\":\"custom\"},{\"frequency\":\"1\",\"amplitude\":6,\"envelope\":\"steady\"},{\"frequency\":\"5\",\"amplitude\":2,\"envelope\":\"steady\"},{\"frequency\":\"7\",\"amplitude\":4,\"envelope\":\"steady\"}]}},\r\n\t\t\t{name: \"steel guitar\",     midiProgram:  25, generalMidi: true, settings: {\"type\":\"Picked String\",\"eqFilter\":[],\"effects\":[\"reverb\"],\"reverb\":33,\"transition\":\"normal\",\"fadeInSeconds\":0,\"fadeOutTicks\":48,\"chord\":\"strum\",\"harmonics\":[100,100,86,71,71,71,86,86,71,57,43,43,43,57,57,57,57,57,43,43,43,43,43,43,43,43,43,43],\"unison\":\"none\",\"stringSustain\":71,\"envelopes\":[]}},\r\n\t\t\t{name: \"jazz guitar\",      midiProgram:  26, generalMidi: true, settings: {\"type\":\"harmonics\",\"effects\":\"reverb\",\"transition\":\"hard\",\"chord\":\"strum\",\"filterCutoffHz\":2000,\"filterResonance\":14,\"filterEnvelope\":\"twang 2\",\"interval\":\"union\",\"vibrato\":\"none\",\"harmonics\":[100,100,86,71,57,71,71,43,57,71,57,43,29,29,29,29,29,29,29,29,14,14,14,14,14,14,14,0]}},\r\n\t\t\t{name: \"clean guitar\",     midiProgram:  27, generalMidi: true, settings: {\"type\":\"harmonics\",\"effects\":\"reverb\",\"transition\":\"hard\",\"chord\":\"strum\",\"filterCutoffHz\":2828,\"filterResonance\":14,\"filterEnvelope\":\"twang 2\",\"interval\":\"union\",\"vibrato\":\"none\",\"harmonics\":[86,100,100,100,86,57,86,100,100,100,71,57,43,71,86,71,57,57,71,71,71,71,57,57,57,57,57,43]}},\r\n\t\t\t{name: \"muted guitar\",     midiProgram:  28, generalMidi: true, settings: {\"type\":\"FM\",\"effects\":\"reverb\",\"transition\":\"hard\",\"chord\":\"strum\",\"filterCutoffHz\":2000,\"filterResonance\":14,\"filterEnvelope\":\"twang 1\",\"vibrato\":\"none\",\"algorithm\":\"1(234)\",\"feedbackType\":\"1\",\"feedbackAmplitude\":7,\"feedbackEnvelope\":\"twang 2\",\"operators\":[{\"frequency\":\"1\",\"amplitude\":13,\"envelope\":\"custom\"},{\"frequency\":\"1\",\"amplitude\":4,\"envelope\":\"twang 3\"},{\"frequency\":\"4\",\"amplitude\":4,\"envelope\":\"twang 2\"},{\"frequency\":\"16\",\"amplitude\":4,\"envelope\":\"twang 1\"}]}},\r\n\t\t])},\r\n\t\t{name: \"Picked Bass Presets\", presets: <DictionaryArray<Preset>> toNameMap([\r\n\t\t\t{name: \"acoustic bass\",    midiProgram:  32, generalMidi: true, settings: {\"type\":\"harmonics\",\"effects\":\"reverb\",\"transition\":\"hard fade\",\"chord\":\"strum\",\"filterCutoffHz\":4000,\"filterResonance\":14,\"filterEnvelope\":\"twang 1\",\"interval\":\"union\",\"vibrato\":\"none\",\"harmonics\":[100,86,71,71,71,71,57,57,57,57,43,43,43,43,43,29,29,29,29,29,29,14,14,14,14,14,14,14]}},\r\n\t\t\t{name: \"fingered bass\",    midiProgram:  33, generalMidi: true, settings: {\"type\":\"harmonics\",\"effects\":\"reverb\",\"transition\":\"hard fade\",\"chord\":\"strum\",\"filterCutoffHz\":2828,\"filterResonance\":14,\"filterEnvelope\":\"twang 1\",\"interval\":\"union\",\"vibrato\":\"none\",\"harmonics\":[100,86,71,57,71,43,57,29,29,29,29,29,29,14,14,14,14,14,14,14,14,14,14,14,14,14,14,0]}},\r\n\t\t\t{name: \"picked bass\",      midiProgram:  34, generalMidi: true, settings: {\"type\":\"FM\",\"effects\":\"reverb\",\"transition\":\"hard fade\",\"chord\":\"strum\",\"filterCutoffHz\":2828,\"filterResonance\":0,\"filterEnvelope\":\"twang 1\",\"vibrato\":\"none\",\"algorithm\":\"1(234)\",\"feedbackType\":\"3\",\"feedbackAmplitude\":4,\"feedbackEnvelope\":\"twang 1\",\"operators\":[{\"frequency\":\"1\",\"amplitude\":15,\"envelope\":\"custom\"},{\"frequency\":\"1\",\"amplitude\":5,\"envelope\":\"steady\"},{\"frequency\":\"11\",\"amplitude\":1,\"envelope\":\"twang 3\"},{\"frequency\":\"1\",\"amplitude\":9,\"envelope\":\"steady\"}]}},\r\n\t\t\t{name: \"fretless bass\",    midiProgram:  35, generalMidi: true, settings: {\"type\":\"harmonics\",\"effects\":\"reverb\",\"transition\":\"hard\",\"chord\":\"strum\",\"filterCutoffHz\":1000,\"filterResonance\":14,\"filterEnvelope\":\"flare 2\",\"interval\":\"union\",\"vibrato\":\"none\",\"harmonics\":[100,100,86,71,71,57,57,71,71,71,57,57,57,57,57,57,57,43,43,43,43,43,43,43,43,29,29,14]}},\r\n\t\t\t{name: \"slap bass 1\",      midiProgram:  36, generalMidi: true, settings: {\"type\":\"harmonics\",\"effects\":\"reverb\",\"transition\":\"hard\",\"chord\":\"strum\",\"filterCutoffHz\":4000,\"filterResonance\":0,\"filterEnvelope\":\"twang 1\",\"interval\":\"union\",\"vibrato\":\"none\",\"harmonics\":[100,100,100,100,86,71,57,29,29,43,43,57,71,57,29,29,43,57,57,57,43,43,43,57,71,71,71,71]}},\r\n\t\t\t{name: \"slap bass 2\",      midiProgram:  37, generalMidi: true, settings: {\"type\":\"FM\",\"effects\":\"reverb\",\"transition\":\"hard\",\"chord\":\"strum\",\"filterCutoffHz\":5657,\"filterResonance\":0,\"filterEnvelope\":\"twang 1\",\"vibrato\":\"none\",\"algorithm\":\"1234\",\"feedbackType\":\"3\",\"feedbackAmplitude\":4,\"feedbackEnvelope\":\"steady\",\"operators\":[{\"frequency\":\"3\",\"amplitude\":13,\"envelope\":\"custom\"},{\"frequency\":\"1\",\"amplitude\":7,\"envelope\":\"steady\"},{\"frequency\":\"13\",\"amplitude\":3,\"envelope\":\"steady\"},{\"frequency\":\"1\",\"amplitude\":11,\"envelope\":\"steady\"}]}},\r\n\t\t\t{name: \"bass synth 1\",     midiProgram:  38, generalMidi: true, settings: {\"type\":\"FM\",\"effects\":\"reverb\",\"transition\":\"hard\",\"chord\":\"strum\",\"filterCutoffHz\":4000,\"filterResonance\":43,\"filterEnvelope\":\"twang 2\",\"vibrato\":\"none\",\"algorithm\":\"1324\",\"feedbackType\":\"34\",\"feedbackAmplitude\":9,\"feedbackEnvelope\":\"twang 2\",\"operators\":[{\"frequency\":\"1\",\"amplitude\":15,\"envelope\":\"custom\"},{\"frequency\":\"1\",\"amplitude\":10,\"envelope\":\"custom\"},{\"frequency\":\"1\",\"amplitude\":14,\"envelope\":\"twang 1\"},{\"frequency\":\"~1\",\"amplitude\":13,\"envelope\":\"twang 2\"}]}},\r\n\t\t\t{name: \"bass synth 2\",     midiProgram:  39, generalMidi: true, settings: {\"type\":\"FM\",\"effects\":\"reverb\",\"transition\":\"hard fade\",\"chord\":\"strum\",\"filterCutoffHz\":1000,\"filterResonance\":57,\"filterEnvelope\":\"punch\",\"vibrato\":\"none\",\"algorithm\":\"1(234)\",\"feedbackType\":\"12\",\"feedbackAmplitude\":4,\"feedbackEnvelope\":\"twang 3\",\"operators\":[{\"frequency\":\"1\",\"amplitude\":9,\"envelope\":\"custom\"},{\"frequency\":\"1\",\"amplitude\":9,\"envelope\":\"steady\"},{\"frequency\":\"3\",\"amplitude\":0,\"envelope\":\"steady\"},{\"frequency\":\"1\",\"amplitude\":0,\"envelope\":\"steady\"}]}},\r\n\t\t\t{name: \"bass & lead\",      midiProgram:  87, generalMidi: true, settings: {\"type\":\"chip\",\"transition\":\"hard\",\"effects\":\"reverb\",\"chord\":\"harmony\",\"filterCutoffHz\":4000,\"filterResonance\":86,\"filterEnvelope\":\"twang 2\",\"wave\":\"sawtooth\",\"interval\":\"shimmer\",\"vibrato\":\"none\"}},\r\n\t\t\t{name: \"dubstep yoi yoi\",  midiProgram:  87, settings: {\"type\":\"chip\",\"eqFilter\":[{\"type\":\"low-pass\",\"cutoffHz\":6727.17,\"linearGain\":0.7071}],\"effects\":[\"note filter\",\"bitcrusher\"],\"noteFilter\":[{\"type\":\"low-pass\",\"cutoffHz\":594.6,\"linearGain\":11.3137}],\"bitcrusherOctave\":1.5,\"bitcrusherQuantization\":0,\"transition\":\"slide\",\"fadeInSeconds\":0.0263,\"fadeOutTicks\":-3,\"chord\":\"arpeggio\",\"wave\":\"sawtooth\",\"unison\":\"none\",\"envelopes\":[{\"target\":\"noteFilterFreq\",\"envelope\":\"flare 2\",\"index\":0}]}},\r\n\t\t])},\r\n\t\t{name: \"Picked String Presets\", presets: <DictionaryArray<Preset>> toNameMap([\r\n\t\t\t{name: \"pizzicato strings\",midiProgram:  45, generalMidi: true, settings: {\"type\":\"FM\",\"effects\":\"reverb\",\"transition\":\"medium fade\",\"chord\":\"harmony\",\"filterCutoffHz\":1000,\"filterResonance\":14,\"filterEnvelope\":\"twang 1\",\"vibrato\":\"none\",\"algorithm\":\"(123)4\",\"feedbackType\":\"1 2 3 4\",\"feedbackAmplitude\":7,\"feedbackEnvelope\":\"twang 1\",\"operators\":[{\"frequency\":\"1\",\"amplitude\":14,\"envelope\":\"custom\"},{\"frequency\":\"3\",\"amplitude\":11,\"envelope\":\"custom\"},{\"frequency\":\"6\",\"amplitude\":9,\"envelope\":\"custom\"},{\"frequency\":\"~1\",\"amplitude\":10,\"envelope\":\"steady\"}]}},\r\n\t\t\t{name: \"harp\",             midiProgram:  46, generalMidi: true, settings: {\"type\":\"FM\",\"transition\":\"hard fade\",\"effects\":\"reverb\",\"chord\":\"strum\",\"filterCutoffHz\":2828,\"filterResonance\":0,\"filterEnvelope\":\"twang 1\",\"vibrato\":\"none\",\"algorithm\":\"1324\",\"feedbackType\":\"3\",\"feedbackAmplitude\":6,\"feedbackEnvelope\":\"twang 2\",\"operators\":[{\"frequency\":\"1\",\"amplitude\":15,\"envelope\":\"custom\"},{\"frequency\":\"4\",\"amplitude\":6,\"envelope\":\"custom\"},{\"frequency\":\"~2\",\"amplitude\":3,\"envelope\":\"steady\"},{\"frequency\":\"1\",\"amplitude\":6,\"envelope\":\"steady\"}]}},\r\n\t\t\t{name: \"sitar\",            midiProgram: 104, generalMidi: true, settings: {\"type\":\"FM\",\"transition\":\"hard fade\",\"effects\":\"reverb\",\"chord\":\"strum\",\"filterCutoffHz\":8000,\"filterResonance\":57,\"filterEnvelope\":\"twang 2\",\"vibrato\":\"none\",\"algorithm\":\"1(234)\",\"feedbackType\":\"1\",\"feedbackAmplitude\":0,\"feedbackEnvelope\":\"steady\",\"operators\":[{\"frequency\":\"1\",\"amplitude\":15,\"envelope\":\"custom\"},{\"frequency\":\"1\",\"amplitude\":14,\"envelope\":\"twang 3\"},{\"frequency\":\"9\",\"amplitude\":3,\"envelope\":\"twang 3\"},{\"frequency\":\"16\",\"amplitude\":9,\"envelope\":\"swell 3\"}]}},\r\n\t\t\t{name: \"banjo\",            midiProgram: 105, generalMidi: true, settings: {\"type\":\"FM\",\"effects\":\"reverb\",\"transition\":\"hard fade\",\"chord\":\"strum\",\"filterCutoffHz\":2828,\"filterResonance\":14,\"filterEnvelope\":\"twang 2\",\"vibrato\":\"none\",\"algorithm\":\"1(234)\",\"feedbackType\":\"2\",\"feedbackAmplitude\":4,\"feedbackEnvelope\":\"steady\",\"operators\":[{\"frequency\":\"4\",\"amplitude\":14,\"envelope\":\"custom\"},{\"frequency\":\"1\",\"amplitude\":10,\"envelope\":\"steady\"},{\"frequency\":\"11\",\"amplitude\":3,\"envelope\":\"twang 3\"},{\"frequency\":\"1\",\"amplitude\":11,\"envelope\":\"steady\"}]}},\r\n\t\t\t{name: \"ukulele\",          midiProgram: 105, settings: {\"type\":\"FM\",\"effects\":\"reverb\",\"transition\":\"hard fade\",\"chord\":\"strum\",\"filterCutoffHz\":2000,\"filterResonance\":0,\"filterEnvelope\":\"twang 1\",\"vibrato\":\"none\",\"algorithm\":\"1(234)\",\"feedbackType\":\"3\",\"feedbackAmplitude\":5,\"feedbackEnvelope\":\"twang 1\",\"operators\":[{\"frequency\":\"2\",\"amplitude\":14,\"envelope\":\"custom\"},{\"frequency\":\"1\",\"amplitude\":6,\"envelope\":\"steady\"},{\"frequency\":\"9\",\"amplitude\":4,\"envelope\":\"twang 2\"},{\"frequency\":\"1\",\"amplitude\":11,\"envelope\":\"steady\"}]}},\r\n\t\t\t{name: \"shamisen\",         midiProgram: 106, generalMidi: true, settings: {\"type\":\"FM\",\"effects\":\"reverb\",\"transition\":\"hard fade\",\"chord\":\"harmony\",\"filterCutoffHz\":8000,\"filterResonance\":14,\"filterEnvelope\":\"twang 1\",\"vibrato\":\"none\",\"algorithm\":\"1(234)\",\"feedbackType\":\"3\",\"feedbackAmplitude\":9,\"feedbackEnvelope\":\"twang 3\",\"operators\":[{\"frequency\":\"1\",\"amplitude\":15,\"envelope\":\"custom\"},{\"frequency\":\"1\",\"amplitude\":12,\"envelope\":\"steady\"},{\"frequency\":\"16\",\"amplitude\":4,\"envelope\":\"twang 3\"},{\"frequency\":\"1\",\"amplitude\":7,\"envelope\":\"steady\"}]}},\r\n\t\t\t{name: \"koto\",             midiProgram: 107, generalMidi: true, settings: {\"type\":\"FM\",\"effects\":\"reverb\",\"transition\":\"hard fade\",\"chord\":\"harmony\",\"filterCutoffHz\":4000,\"filterResonance\":14,\"filterEnvelope\":\"twang 2\",\"vibrato\":\"none\",\"algorithm\":\"1324\",\"feedbackType\":\"12\",\"feedbackAmplitude\":5,\"feedbackEnvelope\":\"twang 2\",\"operators\":[{\"frequency\":\"~1\",\"amplitude\":12,\"envelope\":\"custom\"},{\"frequency\":\"6\",\"amplitude\":10,\"envelope\":\"custom\"},{\"frequency\":\"4\",\"amplitude\":8,\"envelope\":\"twang 3\"},{\"frequency\":\"~2\",\"amplitude\":8,\"envelope\":\"twang 3\"}]}},\r\n\t\t])},\r\n\t\t{name: \"Distortion Presets\", presets: <DictionaryArray<Preset>> toNameMap([\r\n\t\t\t{name: \"overdrive guitar\", midiProgram:  29, generalMidi: true, settings: {\"type\":\"Picked String\",\"eqFilter\":[{\"type\":\"low-pass\",\"cutoffHz\":4756.83,\"linearGain\":0.7071},{\"type\":\"high-pass\",\"cutoffHz\":210.22,\"linearGain\":1},{\"type\":\"low-pass\",\"cutoffHz\":5656.85,\"linearGain\":1},{\"type\":\"peak\",\"cutoffHz\":840.9,\"linearGain\":0.5}],\"effects\":[\"note filter\",\"distortion\"],\"noteFilter\":[{\"type\":\"high-pass\",\"cutoffHz\":297.3,\"linearGain\":2},{\"type\":\"low-pass\",\"cutoffHz\":2378.41,\"linearGain\":0.7071}],\"distortion\":71,\"transition\":\"normal\",\"fadeInSeconds\":0,\"fadeOutTicks\":12,\"chord\":\"strum\",\"harmonics\":[86,100,100,86,86,86,86,71,71,71,71,71,71,71,71,71,71,57,57,57,57,57,57,57,57,57,57,57],\"unison\":\"none\",\"stringSustain\":71,\"envelopes\":[{\"target\":\"noteFilterFreq\",\"envelope\":\"note size\",\"index\":1}]}},\r\n\t\t\t{name: \"distortion guitar\",midiProgram:  30, generalMidi: true, settings: {\"type\":\"Picked String\",\"eqFilter\":[{\"type\":\"low-pass\",\"cutoffHz\":4756.83,\"linearGain\":0.7071},{\"type\":\"high-pass\",\"cutoffHz\":210.22,\"linearGain\":1},{\"type\":\"low-pass\",\"cutoffHz\":5656.85,\"linearGain\":1},{\"type\":\"peak\",\"cutoffHz\":594.6,\"linearGain\":0.3536},{\"type\":\"peak\",\"cutoffHz\":1000,\"linearGain\":0.25}],\"effects\":[\"note filter\",\"distortion\",\"reverb\"],\"noteFilter\":[{\"type\":\"high-pass\",\"cutoffHz\":353.55,\"linearGain\":2},{\"type\":\"low-pass\",\"cutoffHz\":2000,\"linearGain\":1}],\"distortion\":86,\"reverb\":67,\"transition\":\"normal\",\"fadeInSeconds\":0,\"fadeOutTicks\":12,\"chord\":\"strum\",\"harmonics\":[86,100,100,86,86,86,86,71,71,71,71,71,71,71,71,71,71,57,57,57,57,57,57,57,57,57,57,57],\"unison\":\"none\",\"stringSustain\":71,\"envelopes\":[{\"target\":\"noteFilterFreq\",\"envelope\":\"note size\",\"index\":1}]}},\r\n\t\t\t{name: \"charango synth\",   midiProgram:  84, generalMidi: true, settings: {\"type\":\"FM\",\"eqFilter\":[{\"type\":\"low-pass\",\"cutoffHz\":11313.71,\"linearGain\":1}],\"effects\":[],\"transition\":\"normal\",\"fadeInSeconds\":0,\"fadeOutTicks\":-3,\"chord\":\"strum\",\"algorithm\":\"1(234)\",\"feedbackType\":\"1234\",\"feedbackAmplitude\":8,\"operators\":[{\"frequency\":\"3\",\"amplitude\":13},{\"frequency\":\"~1\",\"amplitude\":5},{\"frequency\":\"4\",\"amplitude\":6},{\"frequency\":\"3\",\"amplitude\":7}],\"envelopes\":[{\"target\":\"feedbackAmplitude\",\"envelope\":\"twang 3\"}]}},\r\n\t\t\t{name: \"guitar harmonics\", midiProgram:  31, generalMidi: true, settings: {\"type\":\"FM\",\"eqFilter\":[{\"type\":\"low-pass\",\"cutoffHz\":4000,\"linearGain\":2}],\"effects\":[\"reverb\"],\"reverb\":33,\"transition\":\"normal\",\"fadeInSeconds\":0,\"fadeOutTicks\":-3,\"chord\":\"strum\",\"algorithm\":\"1(23)4\",\"feedbackType\":\"1\",\"feedbackAmplitude\":2,\"operators\":[{\"frequency\":\"4\",\"amplitude\":12},{\"frequency\":\"16\",\"amplitude\":5},{\"frequency\":\"1\",\"amplitude\":2},{\"frequency\":\"~1\",\"amplitude\":12}],\"envelopes\":[{\"target\":\"operatorAmplitude\",\"envelope\":\"swell 1\",\"index\":1},{\"target\":\"operatorAmplitude\",\"envelope\":\"punch\",\"index\":2},{\"target\":\"operatorAmplitude\",\"envelope\":\"twang 1\",\"index\":3}]}},\r\n\t\t\t{name: \"PWM overdrive\",    midiProgram:  29, settings: {\"type\":\"PWM\",\"eqFilter\":[{\"type\":\"low-pass\",\"cutoffHz\":5656.85,\"linearGain\":1.4142}],\"effects\":[],\"transition\":\"normal\",\"fadeInSeconds\":0,\"fadeOutTicks\":-3,\"chord\":\"strum\",\"pulseWidth\":17.67767,\"envelopes\":[{\"target\":\"pulseWidth\",\"envelope\":\"punch\"}]}},\r\n\t\t\t{name: \"PWM distortion\",   midiProgram:  30, settings: {\"type\":\"PWM\",\"eqFilter\":[{\"type\":\"low-pass\",\"cutoffHz\":3363.59,\"linearGain\":2}],\"effects\":[\"vibrato\"],\"vibrato\":\"delayed\",\"transition\":\"normal\",\"fadeInSeconds\":0,\"fadeOutTicks\":-3,\"chord\":\"strum\",\"pulseWidth\":50,\"envelopes\":[{\"target\":\"pulseWidth\",\"envelope\":\"swell 1\"}]}},\r\n\t\t\t{name: \"FM overdrive\",     midiProgram:  29, settings: {\"type\":\"FM\",\"eqFilter\":[{\"type\":\"low-pass\",\"cutoffHz\":4756.83,\"linearGain\":1}],\"effects\":[\"reverb\"],\"reverb\":33,\"transition\":\"normal\",\"fadeInSeconds\":0,\"fadeOutTicks\":-3,\"chord\":\"strum\",\"algorithm\":\"1(234)\",\"feedbackType\":\"12\",\"feedbackAmplitude\":2,\"operators\":[{\"frequency\":\"~1\",\"amplitude\":15},{\"frequency\":\"1\",\"amplitude\":12},{\"frequency\":\"~2\",\"amplitude\":6},{\"frequency\":\"1\",\"amplitude\":12}],\"envelopes\":[{\"target\":\"operatorAmplitude\",\"envelope\":\"twang 1\",\"index\":2},{\"target\":\"operatorAmplitude\",\"envelope\":\"swell 3\",\"index\":3},{\"target\":\"feedbackAmplitude\",\"envelope\":\"punch\"}]}},\r\n\t\t\t{name: \"FM distortion\",    midiProgram:  30, settings: {\"type\":\"FM\",\"eqFilter\":[{\"type\":\"low-pass\",\"cutoffHz\":4000,\"linearGain\":2}],\"effects\":[\"reverb\"],\"reverb\":33,\"transition\":\"normal\",\"fadeInSeconds\":0,\"fadeOutTicks\":-3,\"chord\":\"strum\",\"algorithm\":\"1(234)\",\"feedbackType\":\"12\",\"feedbackAmplitude\":4,\"operators\":[{\"frequency\":\"~1\",\"amplitude\":15},{\"frequency\":\"1\",\"amplitude\":11},{\"frequency\":\"1\",\"amplitude\":9},{\"frequency\":\"~2\",\"amplitude\":4}],\"envelopes\":[{\"target\":\"operatorAmplitude\",\"envelope\":\"swell 1\",\"index\":2},{\"target\":\"operatorAmplitude\",\"envelope\":\"swell 3\",\"index\":3}]}},\r\n\t\t])},\r\n\t\t{name: \"Bellows Presets\", presets: <DictionaryArray<Preset>> toNameMap([\r\n\t\t\t{name: \"drawbar organ 1\",  midiProgram:  16, generalMidi: true, midiSubharmonicOctaves: 1, settings: {\"type\":\"harmonics\",\"effects\":\"reverb\",\"transition\":\"hard\",\"chord\":\"harmony\",\"filterCutoffHz\":2828,\"filterResonance\":14,\"filterEnvelope\":\"steady\",\"interval\":\"union\",\"vibrato\":\"none\",\"harmonics\":[86,86,0,86,0,0,0,86,0,0,0,0,0,0,0,86,0,0,0,0,0,0,0,0,0,0,0,0]}},\r\n\t\t\t{name: \"drawbar organ 2\",  midiProgram:  16, midiSubharmonicOctaves: 1, settings: {\"type\":\"harmonics\",\"effects\":\"reverb\",\"transition\":\"hard\",\"chord\":\"harmony\",\"filterCutoffHz\":2828,\"filterResonance\":14,\"filterEnvelope\":\"steady\",\"interval\":\"union\",\"vibrato\":\"none\",\"harmonics\":[86,29,71,86,71,14,0,100,0,0,0,86,0,0,0,71,0,0,0,57,0,0,0,29,0,0,0,0]}},\r\n\t\t\t{name: \"percussive organ\", midiProgram:  17, generalMidi: true, midiSubharmonicOctaves: 1, settings: {\"type\":\"FM\",\"transition\":\"hard\",\"effects\":\"reverb\",\"chord\":\"harmony\",\"filterCutoffHz\":2000,\"filterResonance\":14,\"filterEnvelope\":\"punch\",\"vibrato\":\"light\",\"algorithm\":\"1234\",\"feedbackType\":\"1324\",\"feedbackAmplitude\":7,\"feedbackEnvelope\":\"decay 1\",\"operators\":[{\"frequency\":\"1\",\"amplitude\":7,\"envelope\":\"custom\"},{\"frequency\":\"2\",\"amplitude\":7,\"envelope\":\"custom\"},{\"frequency\":\"3\",\"amplitude\":8,\"envelope\":\"custom\"},{\"frequency\":\"4\",\"amplitude\":8,\"envelope\":\"custom\"}]}},\r\n\t\t\t{name: \"rock organ\",       midiProgram:  18, generalMidi: true, midiSubharmonicOctaves: 1, settings: {\"type\":\"FM\",\"effects\":\"chorus & reverb\",\"transition\":\"hard\",\"chord\":\"harmony\",\"filterCutoffHz\":4000,\"filterResonance\":14,\"filterEnvelope\":\"punch\",\"vibrato\":\"delayed\",\"algorithm\":\"(123)4\",\"feedbackType\":\"123\",\"feedbackAmplitude\":2,\"feedbackEnvelope\":\"flare 1\",\"operators\":[{\"frequency\":\"1\",\"amplitude\":9,\"envelope\":\"custom\"},{\"frequency\":\"4\",\"amplitude\":9,\"envelope\":\"custom\"},{\"frequency\":\"6\",\"amplitude\":9,\"envelope\":\"custom\"},{\"frequency\":\"2\",\"amplitude\":5,\"envelope\":\"steady\"}]}},\r\n\t\t\t{name: \"pipe organ\",       midiProgram:  19, generalMidi: true, midiSubharmonicOctaves: 1, settings: {\"type\":\"FM\",\"transition\":\"cross fade\",\"effects\":\"reverb\",\"chord\":\"harmony\",\"filterCutoffHz\":5657,\"filterResonance\":43,\"filterEnvelope\":\"steady\",\"vibrato\":\"none\",\"algorithm\":\"1234\",\"feedbackType\":\"1 2 3 4\",\"feedbackAmplitude\":5,\"feedbackEnvelope\":\"steady\",\"operators\":[{\"frequency\":\"1\",\"amplitude\":8,\"envelope\":\"custom\"},{\"frequency\":\"2\",\"amplitude\":9,\"envelope\":\"custom\"},{\"frequency\":\"4\",\"amplitude\":9,\"envelope\":\"custom\"},{\"frequency\":\"8\",\"amplitude\":8,\"envelope\":\"custom\"}]}},\r\n\t\t\t{name: \"reed organ\",       midiProgram:  20, generalMidi: true, settings: {\"type\":\"harmonics\",\"effects\":\"reverb\",\"transition\":\"soft\",\"chord\":\"harmony\",\"filterCutoffHz\":2000,\"filterResonance\":29,\"filterEnvelope\":\"steady\",\"interval\":\"union\",\"vibrato\":\"none\",\"harmonics\":[71,86,100,86,71,100,57,71,71,71,43,43,43,71,43,71,57,57,57,57,57,57,57,29,43,29,29,14]}},\r\n\t\t\t{name: \"accordion\",        midiProgram:  21, generalMidi: true, settings: {\"type\":\"chip\",\"effects\":\"reverb\",\"transition\":\"cross fade\",\"chord\":\"harmony\",\"filterCutoffHz\":5657,\"filterResonance\":0,\"filterEnvelope\":\"swell 1\",\"wave\":\"double saw\",\"interval\":\"honky tonk\",\"vibrato\":\"none\"}},\r\n\t\t\t{name: \"bandoneon\",        midiProgram:  23, generalMidi: true, settings: {\"type\":\"harmonics\",\"effects\":\"reverb\",\"transition\":\"soft\",\"chord\":\"harmony\",\"filterCutoffHz\":4000,\"filterResonance\":29,\"filterEnvelope\":\"swell 1\",\"interval\":\"hum\",\"vibrato\":\"none\",\"harmonics\":[86,86,86,57,71,86,57,71,71,71,57,43,57,43,71,43,71,57,57,43,43,43,57,43,43,29,29,29]}},\r\n\t\t\t{name: \"bagpipe\",          midiProgram: 109, generalMidi: true, settings: {\"type\":\"harmonics\",\"effects\":\"reverb\",\"transition\":\"cross fade\",\"chord\":\"harmony\",\"filterCutoffHz\":5657,\"filterResonance\":43,\"filterEnvelope\":\"punch\",\"interval\":\"hum\",\"vibrato\":\"none\",\"harmonics\":[71,86,86,100,100,86,57,100,86,71,71,71,57,57,57,71,57,71,57,71,43,57,57,43,43,43,43,43]}},\r\n\t\t])},\r\n\t\t{name: \"String Presets\", presets: <DictionaryArray<Preset>> toNameMap([\r\n\t\t\t{name: \"violin\",           midiProgram:  40, generalMidi: true, settings: {\"type\":\"FM\",\"eqFilter\":[{\"type\":\"low-pass\",\"cutoffHz\":4000,\"linearGain\":1.4142},{\"type\":\"high-pass\",\"cutoffHz\":105.11,\"linearGain\":0.3536}],\"effects\":[\"vibrato\",\"reverb\"],\"vibrato\":\"delayed\",\"reverb\":67,\"transition\":\"normal\",\"fadeInSeconds\":0.0413,\"fadeOutTicks\":6,\"chord\":\"simultaneous\",\"algorithm\":\"(12)(34)\",\"feedbackType\":\"12\",\"feedbackAmplitude\":5,\"operators\":[{\"frequency\":\"4\",\"amplitude\":9},{\"frequency\":\"3\",\"amplitude\":9},{\"frequency\":\"2\",\"amplitude\":7},{\"frequency\":\"7\",\"amplitude\":5}],\"envelopes\":[{\"target\":\"operatorAmplitude\",\"envelope\":\"swell 1\",\"index\":3},{\"target\":\"feedbackAmplitude\",\"envelope\":\"twang 3\"}]}},\r\n\t\t\t{name: \"viola\",            midiProgram:  41, generalMidi: true, settings: {\"type\":\"FM\",\"effects\":\"reverb\",\"transition\":\"cross fade\",\"chord\":\"harmony\",\"filterCutoffHz\":2000,\"filterResonance\":29,\"filterEnvelope\":\"steady\",\"vibrato\":\"delayed\",\"algorithm\":\"(123)4\",\"feedbackType\":\"123\",\"feedbackAmplitude\":8,\"feedbackEnvelope\":\"swell 1\",\"operators\":[{\"frequency\":\"2\",\"amplitude\":11,\"envelope\":\"custom\"},{\"frequency\":\"7\",\"amplitude\":7,\"envelope\":\"custom\"},{\"frequency\":\"13\",\"amplitude\":4,\"envelope\":\"custom\"},{\"frequency\":\"1\",\"amplitude\":5,\"envelope\":\"steady\"}]}},\r\n\t\t\t{name: \"cello\",            midiProgram:  42, generalMidi: true, settings: {\"type\":\"FM\",\"eqFilter\":[{\"type\":\"low-pass\",\"cutoffHz\":4000,\"linearGain\":0.1768},{\"type\":\"high-pass\",\"cutoffHz\":297.3,\"linearGain\":0.7071},{\"type\":\"peak\",\"cutoffHz\":4756.83,\"linearGain\":5.6569}],\"effects\":[\"note filter\",\"reverb\"],\"noteFilter\":[{\"type\":\"low-pass\",\"cutoffHz\":16000,\"linearGain\":0.0884}],\"reverb\":67,\"transition\":\"normal\",\"fadeInSeconds\":0.0125,\"fadeOutTicks\":12,\"chord\":\"simultaneous\",\"algorithm\":\"(12)34\",\"feedbackType\":\"12\",\"feedbackAmplitude\":3,\"operators\":[{\"frequency\":\"16\",\"amplitude\":5},{\"frequency\":\"~1\",\"amplitude\":10},{\"frequency\":\"1\",\"amplitude\":9},{\"frequency\":\"6\",\"amplitude\":3}],\"envelopes\":[{\"target\":\"noteFilterAllFreqs\",\"envelope\":\"swell 1\"},{\"target\":\"operatorAmplitude\",\"envelope\":\"swell 1\",\"index\":3}]}},\r\n\t\t\t{name: \"contrabass\",       midiProgram:  43, generalMidi: true, settings: {\"type\":\"FM\",\"effects\":\"reverb\",\"transition\":\"cross fade\",\"chord\":\"harmony\",\"filterCutoffHz\":2000,\"filterResonance\":29,\"filterEnvelope\":\"steady\",\"vibrato\":\"delayed\",\"algorithm\":\"(12)34\",\"feedbackType\":\"12\",\"feedbackAmplitude\":0,\"feedbackEnvelope\":\"steady\",\"operators\":[{\"frequency\":\"16\",\"amplitude\":5,\"envelope\":\"custom\"},{\"frequency\":\"1\",\"amplitude\":10,\"envelope\":\"custom\"},{\"frequency\":\"1\",\"amplitude\":10,\"envelope\":\"steady\"},{\"frequency\":\"6\",\"amplitude\":3,\"envelope\":\"swell 1\"}]}},\r\n\t\t\t{name: \"fiddle\",           midiProgram: 110, generalMidi: true, settings: {\"type\":\"FM\",\"effects\":\"reverb\",\"transition\":\"soft\",\"chord\":\"harmony\",\"filterCutoffHz\":2828,\"filterResonance\":29,\"filterEnvelope\":\"steady\",\"vibrato\":\"delayed\",\"algorithm\":\"(12)(34)\",\"feedbackType\":\"34\",\"feedbackAmplitude\":5,\"feedbackEnvelope\":\"twang 1\",\"operators\":[{\"frequency\":\"2\",\"amplitude\":10,\"envelope\":\"custom\"},{\"frequency\":\"8\",\"amplitude\":8,\"envelope\":\"custom\"},{\"frequency\":\"1\",\"amplitude\":8,\"envelope\":\"steady\"},{\"frequency\":\"16\",\"amplitude\":3,\"envelope\":\"steady\"}]}},\r\n\t\t\t{name: \"tremolo strings\",  midiProgram:  44, generalMidi: true, settings: {\"type\":\"FM\",\"effects\":\"chorus & reverb\",\"transition\":\"medium fade\",\"chord\":\"harmony\",\"filterCutoffHz\":2000,\"filterResonance\":0,\"filterEnvelope\":\"tremolo4\",\"vibrato\":\"none\",\"algorithm\":\"1234\",\"feedbackType\":\"1234\",\"feedbackAmplitude\":12,\"feedbackEnvelope\":\"steady\",\"operators\":[{\"frequency\":\"1\",\"amplitude\":8,\"envelope\":\"custom\"},{\"frequency\":\"~2\",\"amplitude\":8,\"envelope\":\"custom\"},{\"frequency\":\"4\",\"amplitude\":8,\"envelope\":\"custom\"},{\"frequency\":\"7\",\"amplitude\":8,\"envelope\":\"custom\"}]}},\r\n\t\t\t{name: \"strings\",          midiProgram:  48, generalMidi: true, settings: {\"type\":\"FM\",\"effects\":\"chorus & reverb\",\"transition\":\"cross fade\",\"chord\":\"harmony\",\"filterCutoffHz\":2828,\"filterResonance\":43,\"filterEnvelope\":\"steady\",\"vibrato\":\"none\",\"algorithm\":\"(12)(34)\",\"feedbackType\":\"4\",\"feedbackAmplitude\":5,\"feedbackEnvelope\":\"twang 3\",\"operators\":[{\"frequency\":\"4\",\"amplitude\":9,\"envelope\":\"custom\"},{\"frequency\":\"3\",\"amplitude\":9,\"envelope\":\"custom\"},{\"frequency\":\"2\",\"amplitude\":7,\"envelope\":\"steady\"},{\"frequency\":\"7\",\"amplitude\":3,\"envelope\":\"swell 1\"}]}},\r\n\t\t\t{name: \"slow strings\",     midiProgram:  49, generalMidi: true, settings: {\"type\":\"FM\",\"effects\":\"chorus & reverb\",\"transition\":\"soft fade\",\"chord\":\"harmony\",\"filterCutoffHz\":1414,\"filterResonance\":0,\"filterEnvelope\":\"swell 2\",\"vibrato\":\"none\",\"algorithm\":\"(12)(34)\",\"feedbackType\":\"4\",\"feedbackAmplitude\":6,\"feedbackEnvelope\":\"flare 3\",\"operators\":[{\"frequency\":\"4\",\"amplitude\":10,\"envelope\":\"custom\"},{\"frequency\":\"3\",\"amplitude\":10,\"envelope\":\"custom\"},{\"frequency\":\"2\",\"amplitude\":7,\"envelope\":\"steady\"},{\"frequency\":\"7\",\"amplitude\":4,\"envelope\":\"swell 1\"}]}},\r\n\t\t\t{name: \"strings synth 1\",  midiProgram:  50, generalMidi: true, settings: {\"type\":\"chip\",\"transition\":\"soft fade\",\"effects\":\"chorus & reverb\",\"chord\":\"harmony\",\"filterCutoffHz\":1414,\"filterResonance\":43,\"filterEnvelope\":\"steady\",\"wave\":\"sawtooth\",\"interval\":\"hum\",\"vibrato\":\"delayed\"}},\r\n\t\t\t{name: \"strings synth 2\",  midiProgram:  51, generalMidi: true, settings: {\"type\":\"FM\",\"effects\":\"chorus & reverb\",\"transition\":\"soft fade\",\"chord\":\"harmony\",\"filterCutoffHz\":2000,\"filterResonance\":43,\"filterEnvelope\":\"steady\",\"vibrato\":\"none\",\"algorithm\":\"1234\",\"feedbackType\":\"1 2 3 4\",\"feedbackAmplitude\":12,\"feedbackEnvelope\":\"swell 1\",\"operators\":[{\"frequency\":\"3\",\"amplitude\":6,\"envelope\":\"custom\"},{\"frequency\":\"2\",\"amplitude\":7,\"envelope\":\"custom\"},{\"frequency\":\"1\",\"amplitude\":8,\"envelope\":\"custom\"},{\"frequency\":\"1\",\"amplitude\":9,\"envelope\":\"custom\"}]}},\r\n\t\t\t{name: \"orchestra hit 1\",  midiProgram:  55, generalMidi: true, midiSubharmonicOctaves: 1, settings: {\"type\":\"FM\",\"effects\":\"chorus & reverb\",\"transition\":\"hard fade\",\"chord\":\"harmony\",\"filterCutoffHz\":8000,\"filterResonance\":14,\"filterEnvelope\":\"custom\",\"vibrato\":\"none\",\"algorithm\":\"1234\",\"feedbackType\":\"1 2 3 4\",\"feedbackAmplitude\":14,\"feedbackEnvelope\":\"twang 3\",\"operators\":[{\"frequency\":\"1\",\"amplitude\":15,\"envelope\":\"twang 3\"},{\"frequency\":\"2\",\"amplitude\":15,\"envelope\":\"flare 3\"},{\"frequency\":\"4\",\"amplitude\":15,\"envelope\":\"flare 2\"},{\"frequency\":\"8\",\"amplitude\":15,\"envelope\":\"flare 1\"}]}},\r\n\t\t\t{name: \"orchestra hit 2\",  midiProgram:  55, midiSubharmonicOctaves: 1, settings: {\"type\":\"FM\",\"effects\":\"chorus & reverb\",\"transition\":\"medium fade\",\"chord\":\"harmony\",\"filterCutoffHz\":8000,\"filterResonance\":0,\"filterEnvelope\":\"decay 1\",\"vibrato\":\"delayed\",\"algorithm\":\"1234\",\"feedbackType\":\"1 2 3 4\",\"feedbackAmplitude\":14,\"feedbackEnvelope\":\"steady\",\"operators\":[{\"frequency\":\"1\",\"amplitude\":12,\"envelope\":\"custom\"},{\"frequency\":\"2\",\"amplitude\":14,\"envelope\":\"custom\"},{\"frequency\":\"3\",\"amplitude\":12,\"envelope\":\"custom\"},{\"frequency\":\"4\",\"amplitude\":14,\"envelope\":\"custom\"}]}},\r\n\t\t\t{name: \"supersaw string\",  midiProgram:  41, settings: {\"type\":\"supersaw\",\"eqFilter\":[{\"type\":\"low-pass\",\"cutoffHz\":2828.43,\"linearGain\":1.4142},{\"type\":\"low-pass\",\"cutoffHz\":3363.59,\"linearGain\":0.1768}],\"effects\":[\"note filter\",\"reverb\"],\"noteFilter\":[{\"type\":\"high-pass\",\"cutoffHz\":500,\"linearGain\":0.1768}],\"reverb\":33,\"fadeInSeconds\":0.0263,\"fadeOutTicks\":6,\"pulseWidth\":35.35534,\"dynamism\":83,\"spread\":8,\"shape\":50,\"envelopes\":[{\"target\":\"noteFilterFreq\",\"envelope\":\"twang 1\",\"index\":0}]}},\r\n\t\t])},\r\n\t\t{name: \"Vocal Presets\", presets: <DictionaryArray<Preset>> toNameMap([\r\n\t\t\t{name: \"choir soprano\",    midiProgram:  94, generalMidi: true, settings: {\"type\":\"harmonics\",\"eqFilter\":[{\"type\":\"low-pass\",\"cutoffHz\":2828.43,\"linearGain\":2},{\"type\":\"peak\",\"cutoffHz\":1189.21,\"linearGain\":5.6569},{\"type\":\"high-pass\",\"cutoffHz\":707.11,\"linearGain\":2.8284},{\"type\":\"peak\",\"cutoffHz\":2000,\"linearGain\":0.0884},{\"type\":\"peak\",\"cutoffHz\":840.9,\"linearGain\":0.25},{\"type\":\"low-pass\",\"cutoffHz\":6727.17,\"linearGain\":11.3137}],\"effects\":[\"vibrato\",\"chorus\",\"reverb\"],\"vibrato\":\"shaky\",\"chorus\":100,\"reverb\":33,\"fadeInSeconds\":0.0413,\"fadeOutTicks\":24,\"harmonics\":[100,100,86,57,29,29,57,71,57,29,14,14,14,29,43,57,43,29,14,14,14,14,14,14,0,0,0,0],\"unison\":\"none\",\"envelopes\":[]}},\r\n\t\t\t{name: \"choir tenor\",      midiProgram:  52, generalMidi: true, settings: {\"type\":\"harmonics\",\"eqFilter\":[{\"type\":\"peak\",\"cutoffHz\":1000,\"linearGain\":11.3137},{\"type\":\"peak\",\"cutoffHz\":707.11,\"linearGain\":5.6569},{\"type\":\"peak\",\"cutoffHz\":840.9,\"linearGain\":0.0884},{\"type\":\"peak\",\"cutoffHz\":1681.79,\"linearGain\":0.0884},{\"type\":\"high-pass\",\"cutoffHz\":297.3,\"linearGain\":0.7071},{\"type\":\"low-pass\",\"cutoffHz\":2828.43,\"linearGain\":11.3137}],\"effects\":[\"vibrato\",\"chorus\",\"reverb\"],\"vibrato\":\"shaky\",\"chorus\":100,\"reverb\":67,\"transition\":\"normal\",\"fadeInSeconds\":0.0413,\"fadeOutTicks\":48,\"chord\":\"simultaneous\",\"harmonics\":[86,100,100,86,71,57,43,29,29,29,29,43,43,43,29,29,29,29,29,29,29,29,29,14,14,14,14,14],\"unison\":\"none\",\"envelopes\":[]}},\r\n\t\t\t{name: \"choir bass\",       midiProgram:  52, settings: {\"type\":\"harmonics\",\"eqFilter\":[{\"type\":\"low-pass\",\"cutoffHz\":2378.41,\"linearGain\":11.3137},{\"type\":\"peak\",\"cutoffHz\":594.6,\"linearGain\":5.6569},{\"type\":\"peak\",\"cutoffHz\":1681.79,\"linearGain\":0.0884},{\"type\":\"peak\",\"cutoffHz\":707.11,\"linearGain\":0.0884},{\"type\":\"peak\",\"cutoffHz\":840.9,\"linearGain\":11.3137}],\"effects\":[\"vibrato\",\"chorus\",\"reverb\"],\"vibrato\":\"shaky\",\"chorus\":100,\"reverb\":67,\"transition\":\"normal\",\"fadeInSeconds\":0.0413,\"fadeOutTicks\":48,\"chord\":\"simultaneous\",\"harmonics\":[71,86,100,100,86,86,57,43,29,29,29,29,29,29,43,43,43,43,43,29,29,29,29,14,14,14,14,14],\"unison\":\"none\",\"envelopes\":[]}},\r\n\t\t\t{name: \"solo soprano\",     midiProgram:  85, settings: {\"type\":\"harmonics\",\"eqFilter\":[{\"type\":\"low-pass\",\"cutoffHz\":2828.43,\"linearGain\":2},{\"type\":\"peak\",\"cutoffHz\":1189.21,\"linearGain\":5.6569},{\"type\":\"high-pass\",\"cutoffHz\":707.11,\"linearGain\":2.8284},{\"type\":\"peak\",\"cutoffHz\":2000,\"linearGain\":0.0884},{\"type\":\"peak\",\"cutoffHz\":840.9,\"linearGain\":0.25}],\"effects\":[\"vibrato\",\"reverb\"],\"vibrato\":\"shaky\",\"reverb\":33,\"fadeInSeconds\":0.0413,\"fadeOutTicks\":12,\"harmonics\":[86,100,86,43,14,14,57,71,57,14,14,14,14,14,43,57,43,14,14,14,14,14,14,14,0,0,0,0],\"unison\":\"none\",\"envelopes\":[]}},\r\n\t\t\t{name: \"solo tenor\",       midiProgram:  85, settings: {\"type\":\"harmonics\",\"eqFilter\":[{\"type\":\"peak\",\"cutoffHz\":1000,\"linearGain\":11.3137},{\"type\":\"peak\",\"cutoffHz\":707.11,\"linearGain\":5.6569},{\"type\":\"peak\",\"cutoffHz\":840.9,\"linearGain\":0.0884},{\"type\":\"peak\",\"cutoffHz\":1681.79,\"linearGain\":0.0884},{\"type\":\"high-pass\",\"cutoffHz\":297.3,\"linearGain\":0.7071},{\"type\":\"low-pass\",\"cutoffHz\":2828.43,\"linearGain\":11.3137}],\"effects\":[\"vibrato\",\"reverb\"],\"vibrato\":\"shaky\",\"reverb\":33,\"fadeInSeconds\":0.0413,\"fadeOutTicks\":12,\"harmonics\":[86,100,100,86,71,57,43,29,29,29,29,43,43,43,29,29,29,29,29,29,29,29,29,14,14,14,14,14],\"unison\":\"none\",\"envelopes\":[]}},\r\n\t\t\t{name: \"solo bass\",        midiProgram:  85, settings: {\"type\":\"harmonics\",\"eqFilter\":[{\"type\":\"low-pass\",\"cutoffHz\":2378.41,\"linearGain\":5.6569},{\"type\":\"peak\",\"cutoffHz\":594.6,\"linearGain\":8},{\"type\":\"peak\",\"cutoffHz\":1681.79,\"linearGain\":0.0884},{\"type\":\"peak\",\"cutoffHz\":707.11,\"linearGain\":0.0884},{\"type\":\"peak\",\"cutoffHz\":840.9,\"linearGain\":8},{\"type\":\"high-pass\",\"cutoffHz\":210.22,\"linearGain\":1.4142}],\"effects\":[\"vibrato\",\"reverb\"],\"vibrato\":\"shaky\",\"reverb\":33,\"transition\":\"normal\",\"fadeInSeconds\":0.0263,\"fadeOutTicks\":12,\"chord\":\"simultaneous\",\"harmonics\":[71,86,100,100,86,86,57,43,29,29,29,29,29,29,43,43,43,43,43,29,29,29,29,14,14,14,14,14],\"unison\":\"none\",\"envelopes\":[]}},\r\n\t\t\t{name: \"voice ooh\",        midiProgram:  53, generalMidi: true, settings: {\"type\":\"harmonics\",\"effects\":\"reverb\",\"transition\":\"soft\",\"chord\":\"harmony\",\"filterCutoffHz\":1414,\"filterResonance\":57,\"filterEnvelope\":\"steady\",\"interval\":\"union\",\"vibrato\":\"shaky\",\"harmonics\":[100,57,43,43,14,14,0,0,0,14,29,29,14,0,14,29,29,14,0,0,0,0,0,0,0,0,0,0]}},\r\n\t\t\t{name: \"voice synth\",      midiProgram:  54, generalMidi: true, settings: {\"type\":\"chip\",\"transition\":\"medium fade\",\"effects\":\"chorus & reverb\",\"chord\":\"harmony\",\"filterCutoffHz\":4000,\"filterResonance\":57,\"filterEnvelope\":\"steady\",\"wave\":\"rounded\",\"interval\":\"union\",\"vibrato\":\"light\"}},\r\n\t\t\t{name: \"vox synth lead\",   midiProgram:  85, generalMidi: true, settings: {\"type\":\"FM\",\"effects\":\"chorus & reverb\",\"transition\":\"cross fade\",\"chord\":\"harmony\",\"filterCutoffHz\":2828,\"filterResonance\":14,\"filterEnvelope\":\"steady\",\"vibrato\":\"light\",\"algorithm\":\"(123)4\",\"feedbackType\":\"1234\",\"feedbackAmplitude\":2,\"feedbackEnvelope\":\"punch\",\"operators\":[{\"frequency\":\"2\",\"amplitude\":10,\"envelope\":\"custom\"},{\"frequency\":\"9\",\"amplitude\":5,\"envelope\":\"custom\"},{\"frequency\":\"20\",\"amplitude\":1,\"envelope\":\"custom\"},{\"frequency\":\"~1\",\"amplitude\":4,\"envelope\":\"steady\"}]}},\r\n\t\t\t{name: \"tiny robot\",       midiProgram:  85, settings: {\"type\":\"FM\",\"eqFilter\":[],\"effects\":[\"vibrato\",\"reverb\"],\"vibrato\":\"delayed\",\"reverb\":33,\"transition\":\"slide\",\"fadeInSeconds\":0.0263,\"fadeOutTicks\":-3,\"chord\":\"simultaneous\",\"algorithm\":\"1(234)\",\"feedbackType\":\"1\",\"feedbackAmplitude\":2,\"operators\":[{\"frequency\":\"2\",\"amplitude\":15},{\"frequency\":\"1\",\"amplitude\":7},{\"frequency\":\"~1\",\"amplitude\":7},{\"frequency\":\"1\",\"amplitude\":0}],\"envelopes\":[{\"target\":\"operatorAmplitude\",\"envelope\":\"punch\",\"index\":1},{\"target\":\"feedbackAmplitude\",\"envelope\":\"twang 3\"}]}},\r\n\t\t\t{name: \"yowie\",            midiProgram:  85, settings: {\"type\":\"FM\",\"effects\":\"reverb\",\"transition\":\"cross fade\",\"chord\":\"harmony\",\"filterCutoffHz\":2000,\"filterResonance\":86,\"filterEnvelope\":\"tremolo5\",\"vibrato\":\"none\",\"algorithm\":\"12(34)\",\"feedbackType\":\"1\",\"feedbackAmplitude\":12,\"feedbackEnvelope\":\"tremolo3\",\"operators\":[{\"frequency\":\"2\",\"amplitude\":12,\"envelope\":\"custom\"},{\"frequency\":\"16\",\"amplitude\":5,\"envelope\":\"steady\"},{\"frequency\":\"1\",\"amplitude\":5,\"envelope\":\"steady\"},{\"frequency\":\"1\",\"amplitude\":0,\"envelope\":\"steady\"}]}},\r\n\t\t\t{name: \"mouse\",            midiProgram:  85, settings: {\"type\":\"FM\",\"eqFilter\":[],\"effects\":[\"vibrato\",\"reverb\"],\"vibrato\":\"light\",\"reverb\":33,\"transition\":\"slide in pattern\",\"fadeInSeconds\":0.0263,\"fadeOutTicks\":-3,\"chord\":\"simultaneous\",\"algorithm\":\"1234\",\"feedbackType\":\"12\",\"feedbackAmplitude\":5,\"operators\":[{\"frequency\":\"2\",\"amplitude\":13},{\"frequency\":\"5\",\"amplitude\":12},{\"frequency\":\"1\",\"amplitude\":0},{\"frequency\":\"1\",\"amplitude\":0}],\"envelopes\":[{\"target\":\"noteVolume\",\"envelope\":\"note size\"},{\"target\":\"feedbackAmplitude\",\"envelope\":\"flare 2\"}]}},\r\n\t\t\t{name: \"gumdrop\",          midiProgram:  85, settings: {\"type\":\"FM\",\"effects\":\"reverb\",\"transition\":\"hard\",\"chord\":\"harmony\",\"filterCutoffHz\":8000,\"filterResonance\":0,\"filterEnvelope\":\"steady\",\"vibrato\":\"none\",\"algorithm\":\"(123)4\",\"feedbackType\":\"123\",\"feedbackAmplitude\":0,\"feedbackEnvelope\":\"steady\",\"operators\":[{\"frequency\":\"2\",\"amplitude\":15,\"envelope\":\"punch\"},{\"frequency\":\"4\",\"amplitude\":15,\"envelope\":\"punch\"},{\"frequency\":\"7\",\"amplitude\":15,\"envelope\":\"punch\"},{\"frequency\":\"1\",\"amplitude\":10,\"envelope\":\"twang 1\"}]}},\r\n\t\t\t{name: \"echo drop\",        midiProgram: 102, generalMidi: true, settings: {\"type\":\"FM\",\"effects\":\"chorus & reverb\",\"transition\":\"hard\",\"chord\":\"harmony\",\"filterCutoffHz\":2828,\"filterResonance\":14,\"filterEnvelope\":\"punch\",\"vibrato\":\"none\",\"algorithm\":\"1(234)\",\"feedbackType\":\"1\",\"feedbackAmplitude\":2,\"feedbackEnvelope\":\"steady\",\"operators\":[{\"frequency\":\"~2\",\"amplitude\":11,\"envelope\":\"custom\"},{\"frequency\":\"~1\",\"amplitude\":5,\"envelope\":\"steady\"},{\"frequency\":\"11\",\"amplitude\":2,\"envelope\":\"steady\"},{\"frequency\":\"16\",\"amplitude\":5,\"envelope\":\"swell 3\"}]}},\r\n\t\t\t{name: \"dark choir\",       midiProgram:  85, settings: {\"type\":\"spectrum\",\"effects\":\"reverb\",\"transition\":\"soft\",\"chord\":\"harmony\",\"filterCutoffHz\":4000,\"filterResonance\":29,\"filterEnvelope\":\"swell 1\",\"spectrum\":[43,14,14,14,14,14,14,100,14,14,14,57,14,14,100,14,43,14,43,14,14,43,14,29,14,29,14,14,29,0]}},\r\n\t\t])},\r\n\t\t{name: \"Brass Presets\", presets: <DictionaryArray<Preset>> toNameMap([\r\n\t\t\t{name: \"trumpet\",          midiProgram:  56, generalMidi: true, settings: {\"type\":\"FM\",\"effects\":\"reverb\",\"transition\":\"soft\",\"chord\":\"harmony\",\"filterCutoffHz\":2828,\"filterResonance\":43,\"filterEnvelope\":\"steady\",\"vibrato\":\"none\",\"algorithm\":\"1(234)\",\"feedbackType\":\"1\",\"feedbackAmplitude\":9,\"feedbackEnvelope\":\"swell 1\",\"operators\":[{\"frequency\":\"1\",\"amplitude\":14,\"envelope\":\"custom\"},{\"frequency\":\"1\",\"amplitude\":8,\"envelope\":\"steady\"},{\"frequency\":\"1\",\"amplitude\":5,\"envelope\":\"flare 2\"},{\"frequency\":\"1\",\"amplitude\":0,\"envelope\":\"steady\"}]}},\r\n\t\t\t{name: \"trombone\",         midiProgram:  57, generalMidi: true, settings: {\"type\":\"FM\",\"effects\":\"reverb\",\"transition\":\"soft\",\"chord\":\"harmony\",\"filterCutoffHz\":2000,\"filterResonance\":43,\"filterEnvelope\":\"steady\",\"vibrato\":\"none\",\"algorithm\":\"1(234)\",\"feedbackType\":\"2\",\"feedbackAmplitude\":7,\"feedbackEnvelope\":\"swell 1\",\"operators\":[{\"frequency\":\"1\",\"amplitude\":14,\"envelope\":\"custom\"},{\"frequency\":\"1\",\"amplitude\":8,\"envelope\":\"steady\"},{\"frequency\":\"1\",\"amplitude\":0,\"envelope\":\"steady\"},{\"frequency\":\"1\",\"amplitude\":0,\"envelope\":\"steady\"}]}},\r\n\t\t\t{name: \"tuba\",             midiProgram:  58, generalMidi: true, settings: {\"type\":\"FM\",\"effects\":\"reverb\",\"transition\":\"soft\",\"chord\":\"harmony\",\"filterCutoffHz\":2000,\"filterResonance\":43,\"filterEnvelope\":\"steady\",\"vibrato\":\"none\",\"algorithm\":\"1(234)\",\"feedbackType\":\"2\",\"feedbackAmplitude\":8,\"feedbackEnvelope\":\"swell 1\",\"operators\":[{\"frequency\":\"1\",\"amplitude\":14,\"envelope\":\"custom\"},{\"frequency\":\"1\",\"amplitude\":6,\"envelope\":\"steady\"},{\"frequency\":\"1\",\"amplitude\":0,\"envelope\":\"steady\"},{\"frequency\":\"1\",\"amplitude\":0,\"envelope\":\"steady\"}]}},\r\n\t\t\t{name: \"muted trumpet\",    midiProgram:  59, generalMidi: true, settings: {\"type\":\"FM\",\"eqFilter\":[{\"type\":\"low-pass\",\"cutoffHz\":8000,\"linearGain\":2.8284},{\"type\":\"peak\",\"cutoffHz\":4000,\"linearGain\":2.8284}],\"effects\":[\"note filter\",\"reverb\"],\"noteFilter\":[{\"type\":\"low-pass\",\"cutoffHz\":3363.59,\"linearGain\":1}],\"reverb\":33,\"fadeInSeconds\":0.0263,\"fadeOutTicks\":-3,\"algorithm\":\"1(234)\",\"feedbackType\":\"1\",\"feedbackAmplitude\":5,\"operators\":[{\"frequency\":\"1\",\"amplitude\":13},{\"frequency\":\"1\",\"amplitude\":5},{\"frequency\":\"9\",\"amplitude\":5},{\"frequency\":\"13\",\"amplitude\":7}],\"envelopes\":[{\"target\":\"noteFilterAllFreqs\",\"envelope\":\"swell 1\"},{\"target\":\"operatorAmplitude\",\"envelope\":\"swell 1\",\"index\":3},{\"target\":\"feedbackAmplitude\",\"envelope\":\"flare 2\"}]}},\r\n\t\t\t{name: \"french horn\",      midiProgram:  60, generalMidi: true, settings: {\"type\":\"FM\",\"eqFilter\":[{\"type\":\"low-pass\",\"cutoffHz\":4000,\"linearGain\":1},{\"type\":\"peak\",\"cutoffHz\":2378.41,\"linearGain\":2.8284}],\"effects\":[\"reverb\"],\"reverb\":33,\"fadeInSeconds\":0.0263,\"fadeOutTicks\":-3,\"algorithm\":\"1324\",\"feedbackType\":\"12\",\"feedbackAmplitude\":3,\"operators\":[{\"frequency\":\"1\",\"amplitude\":15},{\"frequency\":\"1\",\"amplitude\":12},{\"frequency\":\"1\",\"amplitude\":10},{\"frequency\":\"~1\",\"amplitude\":8}],\"envelopes\":[{\"target\":\"operatorAmplitude\",\"envelope\":\"swell 1\",\"index\":2},{\"target\":\"operatorAmplitude\",\"envelope\":\"flare 2\",\"index\":3},{\"target\":\"feedbackAmplitude\",\"envelope\":\"swell 1\"}]}},\r\n\t\t\t{name: \"brass section\",    midiProgram:  61, generalMidi: true, settings: {\"type\":\"FM\",\"effects\":\"reverb\",\"transition\":\"soft\",\"chord\":\"harmony\",\"filterCutoffHz\":2828,\"filterResonance\":14,\"filterEnvelope\":\"punch\",\"vibrato\":\"none\",\"algorithm\":\"1324\",\"feedbackType\":\"12\",\"feedbackAmplitude\":6,\"feedbackEnvelope\":\"swell 1\",\"operators\":[{\"frequency\":\"1\",\"amplitude\":14,\"envelope\":\"custom\"},{\"frequency\":\"1\",\"amplitude\":12,\"envelope\":\"custom\"},{\"frequency\":\"1\",\"amplitude\":10,\"envelope\":\"swell 1\"},{\"frequency\":\"~1\",\"amplitude\":10,\"envelope\":\"swell 1\"}]}},\r\n\t\t\t{name: \"brass synth 1\",    midiProgram:  62, generalMidi: true, settings: {\"type\":\"FM\",\"effects\":\"reverb\",\"transition\":\"soft\",\"chord\":\"harmony\",\"filterCutoffHz\":4000,\"filterResonance\":29,\"filterEnvelope\":\"steady\",\"vibrato\":\"none\",\"algorithm\":\"1324\",\"feedbackType\":\"12\",\"feedbackAmplitude\":11,\"feedbackEnvelope\":\"swell 1\",\"operators\":[{\"frequency\":\"1\",\"amplitude\":14,\"envelope\":\"custom\"},{\"frequency\":\"1\",\"amplitude\":14,\"envelope\":\"custom\"},{\"frequency\":\"1\",\"amplitude\":12,\"envelope\":\"flare 1\"},{\"frequency\":\"~1\",\"amplitude\":8,\"envelope\":\"flare 2\"}]}},\r\n\t\t\t{name: \"brass synth 2\",    midiProgram:  63, generalMidi: true, settings: {\"type\":\"FM\",\"transition\":\"soft\",\"effects\":\"reverb\",\"chord\":\"harmony\",\"filterCutoffHz\":4000,\"filterResonance\":43,\"filterEnvelope\":\"twang 3\",\"vibrato\":\"none\",\"algorithm\":\"1324\",\"feedbackType\":\"12\",\"feedbackAmplitude\":9,\"feedbackEnvelope\":\"swell 1\",\"operators\":[{\"frequency\":\"1\",\"amplitude\":15,\"envelope\":\"custom\"},{\"frequency\":\"1\",\"amplitude\":15,\"envelope\":\"custom\"},{\"frequency\":\"1\",\"amplitude\":10,\"envelope\":\"flare 1\"},{\"frequency\":\"~1\",\"amplitude\":7,\"envelope\":\"flare 1\"}]}},\r\n\t\t\t{name: \"pulse brass\",      midiProgram:  62, settings: {\"type\":\"PWM\",\"effects\":\"reverb\",\"transition\":\"soft\",\"chord\":\"harmony\",\"filterCutoffHz\":4000,\"filterResonance\":29,\"filterEnvelope\":\"swell 1\",\"pulseWidth\":50,\"pulseEnvelope\":\"flare 3\",\"vibrato\":\"none\"}},\r\n\t\t])},\r\n\t\t{name: \"Reed Presets\", presets: <DictionaryArray<Preset>> toNameMap([\r\n\t\t\t{name: \"soprano sax\",      midiProgram:  64, generalMidi: true, settings: {\"type\":\"FM\",\"effects\":\"reverb\",\"transition\":\"soft\",\"chord\":\"harmony\",\"filterCutoffHz\":2000,\"filterResonance\":29,\"filterEnvelope\":\"steady\",\"vibrato\":\"none\",\"algorithm\":\"1234\",\"feedbackType\":\"4\",\"feedbackAmplitude\":5,\"feedbackEnvelope\":\"swell 1\",\"operators\":[{\"frequency\":\"1\",\"amplitude\":13,\"envelope\":\"custom\"},{\"frequency\":\"4\",\"amplitude\":4,\"envelope\":\"swell 1\"},{\"frequency\":\"1\",\"amplitude\":7,\"envelope\":\"steady\"},{\"frequency\":\"5\",\"amplitude\":4,\"envelope\":\"punch\"}]}},\r\n\t\t\t{name: \"alto sax\",         midiProgram:  65, generalMidi: true, settings: {\"type\":\"FM\",\"effects\":\"reverb\",\"transition\":\"soft\",\"chord\":\"harmony\",\"filterCutoffHz\":2000,\"filterResonance\":43,\"filterEnvelope\":\"steady\",\"vibrato\":\"none\",\"algorithm\":\"1(234)\",\"feedbackType\":\"1\",\"feedbackAmplitude\":4,\"feedbackEnvelope\":\"punch\",\"operators\":[{\"frequency\":\"1\",\"amplitude\":13,\"envelope\":\"custom\"},{\"frequency\":\"1\",\"amplitude\":6,\"envelope\":\"steady\"},{\"frequency\":\"4\",\"amplitude\":6,\"envelope\":\"swell 1\"},{\"frequency\":\"1\",\"amplitude\":12,\"envelope\":\"steady\"}]}},\r\n\t\t\t{name: \"tenor sax\",        midiProgram:  66, generalMidi: true, settings: {\"type\":\"FM\",\"effects\":\"reverb\",\"transition\":\"soft\",\"chord\":\"harmony\",\"filterCutoffHz\":2828,\"filterResonance\":29,\"filterEnvelope\":\"steady\",\"vibrato\":\"none\",\"algorithm\":\"1234\",\"feedbackType\":\"1\",\"feedbackAmplitude\":6,\"feedbackEnvelope\":\"swell 1\",\"operators\":[{\"frequency\":\"2\",\"amplitude\":12,\"envelope\":\"custom\"},{\"frequency\":\"3\",\"amplitude\":7,\"envelope\":\"steady\"},{\"frequency\":\"1\",\"amplitude\":3,\"envelope\":\"steady\"},{\"frequency\":\"8\",\"amplitude\":3,\"envelope\":\"steady\"}]}},\r\n\t\t\t{name: \"baritone sax\",     midiProgram:  67, generalMidi: true, settings: {\"type\":\"FM\",\"effects\":\"reverb\",\"transition\":\"soft\",\"chord\":\"harmony\",\"filterCutoffHz\":2828,\"filterResonance\":0,\"filterEnvelope\":\"steady\",\"vibrato\":\"none\",\"algorithm\":\"1(234)\",\"feedbackType\":\"1\",\"feedbackAmplitude\":2,\"feedbackEnvelope\":\"swell 2\",\"operators\":[{\"frequency\":\"1\",\"amplitude\":12,\"envelope\":\"custom\"},{\"frequency\":\"8\",\"amplitude\":4,\"envelope\":\"steady\"},{\"frequency\":\"4\",\"amplitude\":5,\"envelope\":\"steady\"},{\"frequency\":\"1\",\"amplitude\":4,\"envelope\":\"punch\"}]}},\r\n\t\t\t{name: \"sax synth\",        midiProgram:  64, settings: {\"type\":\"FM\",\"effects\":\"reverb\",\"transition\":\"soft\",\"chord\":\"harmony\",\"filterCutoffHz\":8000,\"filterResonance\":0,\"filterEnvelope\":\"steady\",\"vibrato\":\"light\",\"algorithm\":\"1(234)\",\"feedbackType\":\"12\",\"feedbackAmplitude\":4,\"feedbackEnvelope\":\"steady\",\"operators\":[{\"frequency\":\"4\",\"amplitude\":15,\"envelope\":\"custom\"},{\"frequency\":\"1\",\"amplitude\":15,\"envelope\":\"steady\"},{\"frequency\":\"1\",\"amplitude\":0,\"envelope\":\"steady\"},{\"frequency\":\"1\",\"amplitude\":0,\"envelope\":\"steady\"}]}},\r\n\t\t\t{name: \"shehnai\",          midiProgram: 111, generalMidi: true, settings: {\"type\":\"FM\",\"effects\":\"reverb\",\"transition\":\"soft\",\"chord\":\"harmony\",\"filterCutoffHz\":8000,\"filterResonance\":0,\"filterEnvelope\":\"steady\",\"vibrato\":\"light\",\"algorithm\":\"1(234)\",\"feedbackType\":\"1\",\"feedbackAmplitude\":3,\"feedbackEnvelope\":\"steady\",\"operators\":[{\"frequency\":\"4\",\"amplitude\":15,\"envelope\":\"custom\"},{\"frequency\":\"1\",\"amplitude\":8,\"envelope\":\"steady\"},{\"frequency\":\"1\",\"amplitude\":0,\"envelope\":\"steady\"},{\"frequency\":\"1\",\"amplitude\":0,\"envelope\":\"steady\"}]}},\r\n\t\t\t{name: \"oboe\",             midiProgram:  68, generalMidi: true, settings: {\"type\":\"FM\",\"effects\":\"reverb\",\"transition\":\"cross fade\",\"chord\":\"harmony\",\"filterCutoffHz\":4000,\"filterResonance\":14,\"filterEnvelope\":\"swell 1\",\"vibrato\":\"none\",\"algorithm\":\"12(34)\",\"feedbackType\":\"2\",\"feedbackAmplitude\":2,\"feedbackEnvelope\":\"tremolo5\",\"operators\":[{\"frequency\":\"1\",\"amplitude\":7,\"envelope\":\"custom\"},{\"frequency\":\"4\",\"amplitude\":12,\"envelope\":\"custom\"},{\"frequency\":\"1\",\"amplitude\":6,\"envelope\":\"steady\"},{\"frequency\":\"6\",\"amplitude\":2,\"envelope\":\"steady\"}]}},\r\n\t\t\t{name: \"english horn\",     midiProgram:  69, generalMidi: true, settings: {\"type\":\"FM\",\"effects\":\"reverb\",\"transition\":\"cross fade\",\"chord\":\"harmony\",\"filterCutoffHz\":2000,\"filterResonance\":14,\"filterEnvelope\":\"steady\",\"vibrato\":\"none\",\"algorithm\":\"12(34)\",\"feedbackType\":\"2\",\"feedbackAmplitude\":2,\"feedbackEnvelope\":\"steady\",\"operators\":[{\"frequency\":\"4\",\"amplitude\":12,\"envelope\":\"custom\"},{\"frequency\":\"2\",\"amplitude\":10,\"envelope\":\"custom\"},{\"frequency\":\"1\",\"amplitude\":8,\"envelope\":\"punch\"},{\"frequency\":\"8\",\"amplitude\":4,\"envelope\":\"steady\"}]}},\r\n\t\t\t{name: \"bassoon\",          midiProgram:  70, generalMidi: true, settings: {\"type\":\"FM\",\"effects\":\"reverb\",\"transition\":\"soft\",\"chord\":\"harmony\",\"filterCutoffHz\":707,\"filterResonance\":57,\"filterEnvelope\":\"steady\",\"vibrato\":\"none\",\"algorithm\":\"1(234)\",\"feedbackType\":\"1\",\"feedbackAmplitude\":2,\"feedbackEnvelope\":\"steady\",\"operators\":[{\"frequency\":\"2\",\"amplitude\":11,\"envelope\":\"custom\"},{\"frequency\":\"1\",\"amplitude\":6,\"envelope\":\"steady\"},{\"frequency\":\"6\",\"amplitude\":6,\"envelope\":\"swell 1\"},{\"frequency\":\"1\",\"amplitude\":0,\"envelope\":\"steady\"}]}},\r\n\t\t\t{name: \"clarinet\",         midiProgram:  71, generalMidi: true, settings: {\"type\":\"harmonics\",\"effects\":\"reverb\",\"transition\":\"soft\",\"chord\":\"harmony\",\"filterCutoffHz\":1414,\"filterResonance\":14,\"filterEnvelope\":\"steady\",\"interval\":\"union\",\"vibrato\":\"none\",\"harmonics\":[100,43,86,57,86,71,86,71,71,71,71,71,71,43,71,71,57,57,57,57,57,57,43,43,43,29,14,0]}},\r\n\t\t\t{name: \"harmonica\",        midiProgram:  22, generalMidi: true, settings: {\"type\":\"FM\",\"effects\":\"reverb\",\"transition\":\"soft\",\"chord\":\"harmony\",\"filterCutoffHz\":5657,\"filterResonance\":29,\"filterEnvelope\":\"swell 1\",\"vibrato\":\"none\",\"algorithm\":\"1(234)\",\"feedbackType\":\"1\",\"feedbackAmplitude\":9,\"feedbackEnvelope\":\"tremolo5\",\"operators\":[{\"frequency\":\"2\",\"amplitude\":14,\"envelope\":\"custom\"},{\"frequency\":\"1\",\"amplitude\":15,\"envelope\":\"steady\"},{\"frequency\":\"~2\",\"amplitude\":2,\"envelope\":\"twang 3\"},{\"frequency\":\"1\",\"amplitude\":0,\"envelope\":\"steady\"}]}},\r\n\t\t])},\r\n\t\t{name: \"Flute Presets\", presets: <DictionaryArray<Preset>> toNameMap([\r\n\t\t\t{name: \"flute\",            midiProgram:  73, generalMidi: true, settings: {\"type\":\"FM\",\"effects\":\"reverb\",\"transition\":\"soft\",\"chord\":\"harmony\",\"filterCutoffHz\":5657,\"filterResonance\":14,\"filterEnvelope\":\"steady\",\"vibrato\":\"none\",\"algorithm\":\"1(234)\",\"feedbackType\":\"4\",\"feedbackAmplitude\":7,\"feedbackEnvelope\":\"decay 2\",\"operators\":[{\"frequency\":\"1\",\"amplitude\":15,\"envelope\":\"custom\"},{\"frequency\":\"2\",\"amplitude\":4,\"envelope\":\"steady\"},{\"frequency\":\"1\",\"amplitude\":3,\"envelope\":\"steady\"},{\"frequency\":\"~1\",\"amplitude\":1,\"envelope\":\"punch\"}]}},\r\n\t\t\t{name: \"recorder\",         midiProgram:  74, generalMidi: true, settings: {\"type\":\"harmonics\",\"effects\":\"reverb\",\"transition\":\"soft\",\"chord\":\"harmony\",\"filterCutoffHz\":4000,\"filterResonance\":29,\"filterEnvelope\":\"swell 2\",\"interval\":\"union\",\"vibrato\":\"none\",\"harmonics\":[100,43,57,43,57,43,43,43,43,43,43,43,43,29,29,29,29,29,29,29,14,14,14,14,14,14,14,0]}},\r\n\t\t\t{name: \"whistle\",          midiProgram:  78, generalMidi: true, settings: {\"type\":\"harmonics\",\"effects\":\"chorus & reverb\",\"transition\":\"soft\",\"chord\":\"harmony\",\"filterCutoffHz\":2000,\"filterResonance\":43,\"filterEnvelope\":\"steady\",\"interval\":\"union\",\"vibrato\":\"delayed\",\"harmonics\":[100,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]}},\r\n\t\t\t{name: \"ocarina\",          midiProgram:  79, generalMidi: true, settings: {\"type\":\"harmonics\",\"effects\":\"reverb\",\"transition\":\"soft\",\"chord\":\"harmony\",\"filterCutoffHz\":2828,\"filterResonance\":43,\"filterEnvelope\":\"steady\",\"interval\":\"union\",\"vibrato\":\"none\",\"harmonics\":[100,14,57,14,29,14,14,14,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]}},\r\n\t\t\t{name: \"piccolo\",          midiProgram:  72, generalMidi: true, settings: {\"type\":\"FM\",\"effects\":\"reverb\",\"transition\":\"soft\",\"chord\":\"harmony\",\"filterCutoffHz\":5657,\"filterResonance\":43,\"filterEnvelope\":\"steady\",\"vibrato\":\"none\",\"algorithm\":\"1324\",\"feedbackType\":\"4\",\"feedbackAmplitude\":15,\"feedbackEnvelope\":\"twang 1\",\"operators\":[{\"frequency\":\"1\",\"amplitude\":15,\"envelope\":\"custom\"},{\"frequency\":\"1\",\"amplitude\":10,\"envelope\":\"custom\"},{\"frequency\":\"~2\",\"amplitude\":3,\"envelope\":\"punch\"},{\"frequency\":\"~1\",\"amplitude\":5,\"envelope\":\"punch\"}]}},\r\n\t\t\t{name: \"shakuhachi\",       midiProgram:  77, generalMidi: true, settings: {\"type\":\"FM\",\"effects\":\"chorus & reverb\",\"transition\":\"soft\",\"chord\":\"harmony\",\"filterCutoffHz\":4000,\"filterResonance\":14,\"filterEnvelope\":\"steady\",\"vibrato\":\"delayed\",\"algorithm\":\"1(234)\",\"feedbackType\":\"34\",\"feedbackAmplitude\":15,\"feedbackEnvelope\":\"steady\",\"operators\":[{\"frequency\":\"1\",\"amplitude\":15,\"envelope\":\"custom\"},{\"frequency\":\"2\",\"amplitude\":3,\"envelope\":\"punch\"},{\"frequency\":\"~1\",\"amplitude\":4,\"envelope\":\"twang 1\"},{\"frequency\":\"20\",\"amplitude\":15,\"envelope\":\"steady\"}]}},\r\n\t\t\t{name: \"pan flute\",        midiProgram:  75, generalMidi: true, settings: {\"type\":\"spectrum\",\"eqFilter\":[{\"type\":\"low-pass\",\"cutoffHz\":9513.66,\"linearGain\":5.6569}],\"effects\":[\"note filter\",\"reverb\"],\"noteFilter\":[{\"type\":\"high-pass\",\"cutoffHz\":4756.83,\"linearGain\":0.7071}],\"reverb\":33,\"fadeInSeconds\":0.0125,\"fadeOutTicks\":-3,\"spectrum\":[100,0,0,0,0,0,0,14,0,0,0,71,0,0,14,0,57,0,29,14,29,14,14,29,14,29,14,14,29,14],\"envelopes\":[{\"target\":\"noteFilterFreq\",\"envelope\":\"twang 1\",\"index\":0},{\"target\":\"noteVolume\",\"envelope\":\"punch\"}]}},\r\n\t\t\t{name: \"blown bottle\",     midiProgram:  76, generalMidi: true, settings: {\"type\":\"FM\",\"effects\":\"chorus & reverb\",\"transition\":\"cross fade\",\"chord\":\"harmony\",\"filterCutoffHz\":5657,\"filterResonance\":57,\"filterEnvelope\":\"steady\",\"vibrato\":\"none\",\"algorithm\":\"1234\",\"feedbackType\":\"1 2 3 4\",\"feedbackAmplitude\":7,\"feedbackEnvelope\":\"twang 1\",\"operators\":[{\"frequency\":\"1\",\"amplitude\":15,\"envelope\":\"custom\"},{\"frequency\":\"3\",\"amplitude\":4,\"envelope\":\"custom\"},{\"frequency\":\"6\",\"amplitude\":2,\"envelope\":\"custom\"},{\"frequency\":\"11\",\"amplitude\":2,\"envelope\":\"custom\"}]}},\r\n\t\t\t{name: \"calliope\",         midiProgram:  82, generalMidi: true, settings: {\"type\":\"spectrum\",\"transition\":\"cross fade\",\"effects\":\"reverb\",\"chord\":\"harmony\",\"filterCutoffHz\":5657,\"filterResonance\":14,\"filterEnvelope\":\"steady\",\"spectrum\":[100,0,0,0,0,0,0,86,0,0,0,71,0,0,57,0,43,0,29,14,14,29,14,14,14,14,14,14,14,14]}},\r\n\t\t\t{name: \"chiffer\",          midiProgram:  83, generalMidi: true, settings: {\"type\":\"spectrum\",\"effects\":\"reverb\",\"transition\":\"hard\",\"chord\":\"harmony\",\"filterCutoffHz\":2000,\"filterResonance\":14,\"filterEnvelope\":\"punch\",\"spectrum\":[86,0,0,0,0,0,0,71,0,0,0,71,0,0,57,0,57,0,43,14,14,43,14,29,14,29,29,29,29,14]}},\r\n\t\t\t{name: \"breath noise\",     midiProgram: 121, generalMidi: true, settings: {\"type\":\"spectrum\",\"eqFilter\":[],\"effects\":[\"chord type\",\"note filter\",\"reverb\"],\"chord\":\"strum\",\"noteFilter\":[{\"type\":\"high-pass\",\"cutoffHz\":840.9,\"linearGain\":0.3536},{\"type\":\"low-pass\",\"cutoffHz\":16000,\"linearGain\":0.3536}],\"reverb\":33,\"fadeInSeconds\":0.0413,\"fadeOutTicks\":12,\"spectrum\":[71,0,0,0,0,0,0,29,0,0,0,71,0,0,29,0,100,29,14,29,100,29,100,14,14,71,0,29,0,0],\"envelopes\":[{\"target\":\"noteFilterAllFreqs\",\"envelope\":\"twang 1\"}]}},\r\n\t\t])},\r\n\t\t{name: \"Pad Presets\", presets: <DictionaryArray<Preset>> toNameMap([\r\n\t\t\t{name: \"new age pad\",      midiProgram:  88, generalMidi: true, settings: {\"type\":\"FM\",\"eqFilter\":[],\"effects\":[\"chorus\"],\"chorus\":100,\"transition\":\"normal\",\"fadeInSeconds\":0,\"fadeOutTicks\":48,\"chord\":\"simultaneous\",\"algorithm\":\"1(234)\",\"feedbackType\":\"12\",\"feedbackAmplitude\":3,\"operators\":[{\"frequency\":\"2\",\"amplitude\":14},{\"frequency\":\"~1\",\"amplitude\":4},{\"frequency\":\"6\",\"amplitude\":3},{\"frequency\":\"13\",\"amplitude\":3}],\"envelopes\":[{\"target\":\"operatorAmplitude\",\"envelope\":\"swell 2\",\"index\":1},{\"target\":\"operatorAmplitude\",\"envelope\":\"twang 3\",\"index\":2},{\"target\":\"feedbackAmplitude\",\"envelope\":\"swell 3\"}]}},\r\n\t\t\t{name: \"warm pad\",         midiProgram:  89, generalMidi: true, settings: {\"type\":\"FM\",\"eqFilter\":[],\"effects\":[\"note filter\",\"chorus\"],\"noteFilter\":[{\"type\":\"low-pass\",\"cutoffHz\":3363.59,\"linearGain\":1}],\"chorus\":100,\"transition\":\"normal\",\"fadeInSeconds\":0.0575,\"fadeOutTicks\":96,\"chord\":\"simultaneous\",\"algorithm\":\"1(234)\",\"feedbackType\":\"1\",\"feedbackAmplitude\":7,\"operators\":[{\"frequency\":\"1\",\"amplitude\":14},{\"frequency\":\"1\",\"amplitude\":6},{\"frequency\":\"1\",\"amplitude\":0},{\"frequency\":\"1\",\"amplitude\":0}],\"envelopes\":[{\"target\":\"noteFilterAllFreqs\",\"envelope\":\"swell 3\"},{\"target\":\"operatorAmplitude\",\"envelope\":\"swell 1\",\"index\":1}]}},\r\n\t\t\t{name: \"polysynth pad\",    midiProgram:  90, generalMidi: true, settings: {\"type\":\"chip\",\"eqFilter\":[],\"effects\":[\"vibrato\",\"note filter\",\"chorus\"],\"vibrato\":\"delayed\",\"noteFilter\":[{\"type\":\"low-pass\",\"cutoffHz\":2828.43,\"linearGain\":1}],\"chorus\":100,\"transition\":\"normal\",\"fadeInSeconds\":0,\"fadeOutTicks\":48,\"chord\":\"simultaneous\",\"wave\":\"sawtooth\",\"unison\":\"honky tonk\",\"envelopes\":[{\"target\":\"noteFilterAllFreqs\",\"envelope\":\"twang 3\"}]}},\r\n\t\t\t{name: \"space voice pad\",  midiProgram:  91, generalMidi: true, settings: {\"type\":\"FM\",\"eqFilter\":[{\"type\":\"low-pass\",\"cutoffHz\":6727.17,\"linearGain\":5.6569},{\"type\":\"peak\",\"cutoffHz\":2828.43,\"linearGain\":5.6569},{\"type\":\"peak\",\"cutoffHz\":1414.21,\"linearGain\":0.1768}],\"effects\":[\"chorus\"],\"chorus\":100,\"transition\":\"normal\",\"fadeInSeconds\":0.0125,\"fadeOutTicks\":72,\"chord\":\"simultaneous\",\"algorithm\":\"(123)4\",\"feedbackType\":\"1 2 3 4\",\"feedbackAmplitude\":5,\"operators\":[{\"frequency\":\"1\",\"amplitude\":10},{\"frequency\":\"2\",\"amplitude\":8},{\"frequency\":\"3\",\"amplitude\":7},{\"frequency\":\"11\",\"amplitude\":2}],\"envelopes\":[{\"target\":\"operatorAmplitude\",\"envelope\":\"punch\",\"index\":3},{\"target\":\"feedbackAmplitude\",\"envelope\":\"swell 2\"}]}},\r\n\t\t\t{name: \"bowed glass pad\",  midiProgram:  92, generalMidi: true, settings: {\"type\":\"FM\",\"eqFilter\":[],\"effects\":[\"note filter\"],\"noteFilter\":[{\"type\":\"low-pass\",\"cutoffHz\":4756.83,\"linearGain\":0.5}],\"transition\":\"normal\",\"fadeInSeconds\":0.0575,\"fadeOutTicks\":96,\"chord\":\"simultaneous\",\"algorithm\":\"1324\",\"feedbackType\":\"12\",\"feedbackAmplitude\":0,\"operators\":[{\"frequency\":\"1\",\"amplitude\":10},{\"frequency\":\"2\",\"amplitude\":12},{\"frequency\":\"3\",\"amplitude\":7},{\"frequency\":\"7\",\"amplitude\":4}],\"envelopes\":[{\"target\":\"noteFilterAllFreqs\",\"envelope\":\"twang 3\"},{\"target\":\"operatorAmplitude\",\"envelope\":\"twang 3\",\"index\":2},{\"target\":\"operatorAmplitude\",\"envelope\":\"flare 3\",\"index\":3}]}},\r\n\t\t\t{name: \"metallic pad\",     midiProgram:  93, generalMidi: true, settings: {\"type\":\"FM\",\"eqFilter\":[],\"effects\":[\"note filter\"],\"noteFilter\":[{\"type\":\"low-pass\",\"cutoffHz\":6727.17,\"linearGain\":0.5}],\"transition\":\"normal\",\"fadeInSeconds\":0.0125,\"fadeOutTicks\":72,\"chord\":\"simultaneous\",\"algorithm\":\"1324\",\"feedbackType\":\"12\",\"feedbackAmplitude\":13,\"operators\":[{\"frequency\":\"1\",\"amplitude\":15},{\"frequency\":\"~1\",\"amplitude\":9},{\"frequency\":\"1\",\"amplitude\":7},{\"frequency\":\"11\",\"amplitude\":7}],\"envelopes\":[{\"target\":\"noteFilterAllFreqs\",\"envelope\":\"twang 3\"},{\"target\":\"operatorAmplitude\",\"envelope\":\"swell 2\",\"index\":2},{\"target\":\"feedbackAmplitude\",\"envelope\":\"twang 3\"}]}},\r\n\t\t\t{name: \"sweep pad\",        midiProgram:  95, generalMidi: true, settings: {\"type\":\"chip\",\"eqFilter\":[],\"effects\":[\"note filter\",\"chorus\"],\"noteFilter\":[{\"type\":\"low-pass\",\"cutoffHz\":4000,\"linearGain\":4}],\"chorus\":100,\"transition\":\"normal\",\"fadeInSeconds\":0.0575,\"fadeOutTicks\":96,\"chord\":\"simultaneous\",\"wave\":\"sawtooth\",\"unison\":\"hum\",\"envelopes\":[{\"target\":\"noteFilterAllFreqs\",\"envelope\":\"flare 3\"}]}},\r\n\t\t\t{name: \"atmosphere\",       midiProgram:  99, generalMidi: true, settings: {\"type\":\"FM\",\"eqFilter\":[{\"type\":\"low-pass\",\"cutoffHz\":4756.83,\"linearGain\":1}],\"effects\":[\"chorus\",\"reverb\"],\"chorus\":100,\"reverb\":33,\"transition\":\"normal\",\"fadeInSeconds\":0,\"fadeOutTicks\":48,\"chord\":\"strum\",\"algorithm\":\"1(234)\",\"feedbackType\":\"34\",\"feedbackAmplitude\":3,\"operators\":[{\"frequency\":\"1\",\"amplitude\":14},{\"frequency\":\"~1\",\"amplitude\":10},{\"frequency\":\"3\",\"amplitude\":7},{\"frequency\":\"1\",\"amplitude\":7}],\"envelopes\":[{\"target\":\"operatorAmplitude\",\"envelope\":\"swell 3\",\"index\":1},{\"target\":\"operatorAmplitude\",\"envelope\":\"twang 2\",\"index\":2},{\"target\":\"operatorAmplitude\",\"envelope\":\"twang 3\",\"index\":3}]}},\r\n\t\t\t{name: \"brightness\",       midiProgram: 100, generalMidi: true, settings: {\"type\":\"Picked String\",\"eqFilter\":[{\"type\":\"low-pass\",\"cutoffHz\":4756.83,\"linearGain\":2}],\"effects\":[\"chorus\"],\"chorus\":100,\"transition\":\"normal\",\"fadeInSeconds\":0.0125,\"fadeOutTicks\":72,\"chord\":\"simultaneous\",\"harmonics\":[100,86,86,86,43,57,43,71,43,43,43,57,43,43,57,71,57,43,29,43,57,57,43,29,29,29,29,14],\"unison\":\"octave\",\"stringSustain\":86,\"envelopes\":[]}},\r\n\t\t\t{name: \"goblins\",          midiProgram: 101, generalMidi: true, settings: {\"type\":\"FM\",\"eqFilter\":[{\"type\":\"peak\",\"cutoffHz\":2828.43,\"linearGain\":11.3137}],\"effects\":[\"note filter\",\"chorus\"],\"noteFilter\":[{\"type\":\"low-pass\",\"cutoffHz\":1681.79,\"linearGain\":0.5}],\"chorus\":100,\"transition\":\"normal\",\"fadeInSeconds\":0.0575,\"fadeOutTicks\":96,\"chord\":\"simultaneous\",\"algorithm\":\"1234\",\"feedbackType\":\"1\",\"feedbackAmplitude\":10,\"operators\":[{\"frequency\":\"1\",\"amplitude\":15},{\"frequency\":\"4\",\"amplitude\":5},{\"frequency\":\"1\",\"amplitude\":10},{\"frequency\":\"1\",\"amplitude\":0}],\"envelopes\":[{\"target\":\"noteFilterAllFreqs\",\"envelope\":\"swell 2\"},{\"target\":\"operatorAmplitude\",\"envelope\":\"swell 3\",\"index\":1},{\"target\":\"operatorAmplitude\",\"envelope\":\"tremolo1\",\"index\":2},{\"target\":\"feedbackAmplitude\",\"envelope\":\"flare 3\"}]}},\r\n\t\t\t{name: \"sci-fi\",           midiProgram: 103, generalMidi: true, settings: {\"type\":\"FM\",\"eqFilter\":[{\"type\":\"peak\",\"cutoffHz\":9513.66,\"linearGain\":2.8284}],\"effects\":[\"note filter\",\"chorus\"],\"noteFilter\":[{\"type\":\"low-pass\",\"cutoffHz\":6727.17,\"linearGain\":0.5}],\"chorus\":100,\"transition\":\"normal\",\"fadeInSeconds\":0.0125,\"fadeOutTicks\":48,\"chord\":\"simultaneous\",\"algorithm\":\"(12)34\",\"feedbackType\":\"1 2 3 4\",\"feedbackAmplitude\":8,\"operators\":[{\"frequency\":\"~1\",\"amplitude\":13},{\"frequency\":\"2\",\"amplitude\":10},{\"frequency\":\"5\",\"amplitude\":5},{\"frequency\":\"11\",\"amplitude\":8}],\"envelopes\":[{\"target\":\"noteFilterAllFreqs\",\"envelope\":\"twang 3\"},{\"target\":\"operatorAmplitude\",\"envelope\":\"twang 3\",\"index\":2},{\"target\":\"operatorAmplitude\",\"envelope\":\"tremolo5\",\"index\":3},{\"target\":\"feedbackAmplitude\",\"envelope\":\"twang 3\"}]}},\r\n\t\t\t{name: \"flutter pad\",      midiProgram:  90, settings: {\"type\":\"FM\",\"eqFilter\":[],\"effects\":[\"vibrato\",\"note filter\",\"chorus\"],\"vibrato\":\"delayed\",\"noteFilter\":[{\"type\":\"low-pass\",\"cutoffHz\":4000,\"linearGain\":4}],\"chorus\":100,\"transition\":\"normal\",\"fadeInSeconds\":0,\"fadeOutTicks\":48,\"chord\":\"simultaneous\",\"algorithm\":\"(12)(34)\",\"feedbackType\":\"123\",\"feedbackAmplitude\":9,\"operators\":[{\"frequency\":\"1\",\"amplitude\":13},{\"frequency\":\"5\",\"amplitude\":7},{\"frequency\":\"7\",\"amplitude\":5},{\"frequency\":\"~1\",\"amplitude\":6}],\"envelopes\":[{\"target\":\"noteFilterAllFreqs\",\"envelope\":\"twang 3\"},{\"target\":\"operatorAmplitude\",\"envelope\":\"tremolo1\",\"index\":2},{\"target\":\"operatorAmplitude\",\"envelope\":\"punch\",\"index\":3}]}},\r\n\t\t\t{name: \"feedback pad\",     midiProgram:  89, settings: {\"type\":\"FM\",\"eqFilter\":[{\"type\":\"peak\",\"cutoffHz\":2378.41,\"linearGain\":8}],\"effects\":[],\"transition\":\"normal\",\"fadeInSeconds\":0.0575,\"fadeOutTicks\":96,\"chord\":\"custom interval\",\"algorithm\":\"1234\",\"feedbackType\":\"1 2 3 4\",\"feedbackAmplitude\":8,\"operators\":[{\"frequency\":\"1\",\"amplitude\":15},{\"frequency\":\"1\",\"amplitude\":15},{\"frequency\":\"1\",\"amplitude\":15},{\"frequency\":\"~1\",\"amplitude\":15}],\"envelopes\":[{\"target\":\"feedbackAmplitude\",\"envelope\":\"swell 2\"}]}},\r\n\t\t\t{name: \"supersaw pad\",     midiProgram:  93, settings: {\"type\":\"supersaw\",\"eqFilter\":[{\"type\":\"low-pass\",\"cutoffHz\":8000,\"linearGain\":0.1768}],\"effects\":[\"reverb\"],\"reverb\":100,\"fadeInSeconds\":0.0263,\"fadeOutTicks\":24,\"pulseWidth\":50,\"dynamism\":100,\"spread\":58,\"shape\":0,\"envelopes\":[]}},\r\n\t\t])},\r\n\t\t{name: \"Drum Presets\", presets: <DictionaryArray<Preset>> toNameMap([\r\n\t\t\t{name: \"standard drumset\", midiProgram: 116, isNoise: true, settings: {\"type\":\"drumset\",\"effects\":\"reverb\",\"drums\":[{\"filterEnvelope\":\"twang 1\",\"spectrum\":[57,71,71,86,86,86,71,71,71,71,57,57,57,57,43,43,43,43,29,29,29,29,29,29,29,29,29,29,29,29]},{\"filterEnvelope\":\"twang 1\",\"spectrum\":[0,0,0,100,71,71,57,86,57,57,57,71,43,43,57,43,43,43,43,43,43,43,43,43,43,43,43,43,43,43]},{\"filterEnvelope\":\"twang 1\",\"spectrum\":[0,0,0,0,100,57,43,43,29,57,43,29,71,43,43,43,43,57,43,43,43,43,43,43,43,43,29,43,43,43]},{\"filterEnvelope\":\"twang 1\",\"spectrum\":[0,0,0,0,0,71,57,43,43,43,57,57,43,29,57,43,43,43,29,43,57,43,43,43,43,43,43,29,43,43]},{\"filterEnvelope\":\"decay 2\",\"spectrum\":[0,14,29,43,86,71,29,43,43,43,43,29,71,29,71,29,43,43,43,43,57,43,43,57,43,43,43,57,57,57]},{\"filterEnvelope\":\"decay 1\",\"spectrum\":[0,0,14,14,14,14,29,29,29,43,43,43,57,57,57,71,71,71,71,71,71,71,71,57,57,57,57,43,43,43]},{\"filterEnvelope\":\"twang 3\",\"spectrum\":[43,43,43,71,29,29,43,43,43,29,43,43,43,29,29,43,43,29,29,29,57,14,57,43,43,57,43,43,57,57]},{\"filterEnvelope\":\"decay 3\",\"spectrum\":[29,43,43,43,43,29,29,43,29,29,43,29,14,29,43,29,43,29,57,29,43,57,43,71,43,71,57,57,71,71]},{\"filterEnvelope\":\"twang 3\",\"spectrum\":[43,29,29,43,29,29,29,57,29,29,29,57,43,43,29,29,57,43,43,43,71,43,43,71,57,71,71,71,71,71]},{\"filterEnvelope\":\"decay 3\",\"spectrum\":[57,57,57,43,57,57,43,43,57,43,43,43,71,57,43,57,86,71,57,86,71,57,86,100,71,86,86,86,86,86]},{\"filterEnvelope\":\"flare 1\",\"spectrum\":[0,0,14,14,14,14,29,29,29,43,43,43,57,57,71,71,86,86,100,100,100,100,100,100,100,100,86,57,29,0]},{\"filterEnvelope\":\"decay 2\",\"spectrum\":[14,14,14,14,29,14,14,29,14,43,14,43,57,86,57,57,100,57,43,43,57,100,57,43,29,14,0,0,0,0]}]}},\r\n\t\t\t{name: \"steel pan\",        midiProgram: 114, generalMidi: true, settings: {\"type\":\"FM\",\"eqFilter\":[{\"type\":\"high-pass\",\"cutoffHz\":62.5,\"linearGain\":0.1768}],\"effects\":[\"note filter\",\"chorus\",\"reverb\"],\"noteFilter\":[{\"type\":\"low-pass\",\"cutoffHz\":13454.34,\"linearGain\":0.25}],\"chorus\":67,\"reverb\":33,\"transition\":\"normal\",\"fadeInSeconds\":0,\"fadeOutTicks\":24,\"chord\":\"simultaneous\",\"algorithm\":\"1(234)\",\"feedbackType\":\"1\",\"feedbackAmplitude\":0,\"operators\":[{\"frequency\":\"~1\",\"amplitude\":14},{\"frequency\":\"7\",\"amplitude\":3},{\"frequency\":\"3\",\"amplitude\":5},{\"frequency\":\"4\",\"amplitude\":4}],\"envelopes\":[{\"target\":\"noteFilterAllFreqs\",\"envelope\":\"decay 2\"},{\"target\":\"operatorAmplitude\",\"envelope\":\"flare 1\",\"index\":1},{\"target\":\"operatorAmplitude\",\"envelope\":\"flare 2\",\"index\":2},{\"target\":\"operatorAmplitude\",\"envelope\":\"swell 2\",\"index\":3}]}},\r\n\t\t\t{name: \"steel pan synth\",  midiProgram: 114, settings: {\"type\":\"FM\",\"eqFilter\":[],\"effects\":[\"note filter\"],\"noteFilter\":[{\"type\":\"low-pass\",\"cutoffHz\":13454.34,\"linearGain\":0.25}],\"transition\":\"normal\",\"fadeInSeconds\":0,\"fadeOutTicks\":-3,\"chord\":\"simultaneous\",\"algorithm\":\"1234\",\"feedbackType\":\"1\",\"feedbackAmplitude\":5,\"operators\":[{\"frequency\":\"~1\",\"amplitude\":12},{\"frequency\":\"2\",\"amplitude\":15},{\"frequency\":\"4\",\"amplitude\":14},{\"frequency\":\"~1\",\"amplitude\":3}],\"envelopes\":[{\"target\":\"noteFilterAllFreqs\",\"envelope\":\"twang 1\"},{\"target\":\"operatorAmplitude\",\"envelope\":\"note size\",\"index\":0},{\"target\":\"operatorAmplitude\",\"envelope\":\"note size\",\"index\":1},{\"target\":\"operatorAmplitude\",\"envelope\":\"flare 1\",\"index\":2},{\"target\":\"operatorAmplitude\",\"envelope\":\"flare 2\",\"index\":3},{\"target\":\"feedbackAmplitude\",\"envelope\":\"flare 1\"}]}},\r\n\t\t\t{name: \"timpani\",          midiProgram:  47, generalMidi: true, settings: {\"type\":\"spectrum\",\"eqFilter\":[{\"type\":\"peak\",\"cutoffHz\":6727.17,\"linearGain\":5.6569}],\"effects\":[\"pitch shift\",\"note filter\",\"reverb\"],\"pitchShiftSemitones\":15,\"noteFilter\":[{\"type\":\"low-pass\",\"cutoffHz\":19027.31,\"linearGain\":0.5}],\"reverb\":33,\"transition\":\"normal\",\"fadeInSeconds\":0,\"fadeOutTicks\":48,\"chord\":\"simultaneous\",\"spectrum\":[100,0,0,0,86,0,0,71,0,14,43,14,43,43,0,29,43,29,29,29,43,29,43,29,43,43,43,43,43,43],\"envelopes\":[{\"target\":\"noteFilterAllFreqs\",\"envelope\":\"twang 1\"},{\"target\":\"pitchShift\",\"envelope\":\"twang 1\"}]}},\r\n\t\t\t{name: \"dark strike\",      midiProgram:  47, settings: {\"type\":\"spectrum\",\"eqFilter\":[],\"effects\":[\"note filter\",\"reverb\"],\"noteFilter\":[{\"type\":\"low-pass\",\"cutoffHz\":4756.83,\"linearGain\":0.7071}],\"reverb\":33,\"transition\":\"normal\",\"fadeInSeconds\":0,\"fadeOutTicks\":48,\"chord\":\"simultaneous\",\"spectrum\":[0,0,14,14,14,29,29,43,43,86,43,43,43,29,86,29,29,29,86,29,14,14,14,14,0,0,0,0,0,0],\"envelopes\":[{\"target\":\"noteFilterAllFreqs\",\"envelope\":\"twang 2\"}]}},\r\n\t\t\t{name: \"woodblock\",        midiProgram: 115, generalMidi: true, isNoise: true, midiSubharmonicOctaves: -2.5, settings: {\"type\":\"spectrum\",\"effects\":\"reverb\",\"transition\":\"hard fade\",\"chord\":\"strum\",\"filterCutoffHz\":2828,\"filterResonance\":14,\"filterEnvelope\":\"twang 1\",\"spectrum\":[0,14,29,43,43,57,86,86,71,57,57,43,43,57,86,86,43,43,71,57,57,57,57,57,86,86,71,71,71,71]}},\r\n\t\t\t{name: \"taiko drum\",       midiProgram: 116, generalMidi: true, isNoise: true, midiSubharmonicOctaves: -0.5, settings: {\"type\":\"spectrum\",\"effects\":\"reverb\",\"transition\":\"hard fade\",\"chord\":\"strum\",\"filterCutoffHz\":2828,\"filterResonance\":29,\"filterEnvelope\":\"twang 1\",\"spectrum\":[71,100,100,43,43,71,71,43,43,43,43,43,43,57,29,57,43,57,43,43,57,43,43,43,43,43,43,43,43,43]}},\r\n\t\t\t{name: \"melodic drum\",     midiProgram: 117, generalMidi: true, isNoise: true, midiSubharmonicOctaves: -1.5, settings: {\"type\":\"spectrum\",\"effects\":\"reverb\",\"transition\":\"hard fade\",\"chord\":\"strum\",\"filterCutoffHz\":2828,\"filterResonance\":43,\"filterEnvelope\":\"twang 1\",\"spectrum\":[100,71,71,57,57,43,43,71,43,43,43,57,43,43,57,43,43,43,43,29,29,29,29,29,29,29,29,29,29,29]}},\r\n\t\t\t{name: \"drum synth\",       midiProgram: 118, generalMidi: true, isNoise: true, midiSubharmonicOctaves: -2, settings: {\"type\":\"spectrum\",\"effects\":\"reverb\",\"transition\":\"hard fade\",\"chord\":\"harmony\",\"filterCutoffHz\":4000,\"filterResonance\":43,\"filterEnvelope\":\"decay 1\",\"spectrum\":[100,86,71,57,43,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29]}},\r\n\t\t\t{name: \"tom-tom\",          midiProgram: 116, isNoise: true, midiSubharmonicOctaves: -1, settings: {\"type\":\"spectrum\",\"effects\":\"reverb\",\"transition\":\"hard fade\",\"chord\":\"strum\",\"filterCutoffHz\":2000,\"filterResonance\":14,\"filterEnvelope\":\"twang 1\",\"spectrum\":[100,29,14,0,0,86,14,43,29,86,29,14,29,57,43,43,43,43,57,43,43,43,29,57,43,43,43,43,43,43]}},\r\n\t\t\t{name: \"metal pipe\",       midiProgram: 117, isNoise: true, midiSubharmonicOctaves: -1.5, settings: {\"type\":\"spectrum\",\"effects\":\"reverb\",\"transition\":\"hard fade\",\"chord\":\"strum\",\"filterCutoffHz\":8000,\"filterResonance\":14,\"filterEnvelope\":\"twang 2\",\"spectrum\":[29,43,86,43,43,43,43,43,100,29,14,14,100,14,14,0,0,0,0,0,14,29,29,14,0,0,14,29,0,0]}},\r\n\t\t\t{name: \"synth kick\",       midiProgram:  47, settings: {\"type\":\"FM\",\"eqFilter\":[],\"effects\":[],\"transition\":\"normal\",\"fadeInSeconds\":0,\"fadeOutTicks\":-6,\"chord\":\"simultaneous\",\"algorithm\":\"1(234)\",\"feedbackType\":\"1\",\"feedbackAmplitude\":0,\"operators\":[{\"frequency\":\"8\",\"amplitude\":15},{\"frequency\":\"1\",\"amplitude\":0},{\"frequency\":\"1\",\"amplitude\":0},{\"frequency\":\"1\",\"amplitude\":0}],\"envelopes\":[{\"target\":\"operatorFrequency\",\"envelope\":\"twang 1\",\"index\":0},{\"target\":\"noteVolume\",\"envelope\":\"twang 2\"}]}},\r\n\t\t])},\r\n\t\t{name: \"Novelty Presets\", presets: <DictionaryArray<Preset>> toNameMap([\r\n\t\t\t{name: \"guitar fret noise\",midiProgram: 120, generalMidi: true, settings: {\"type\":\"spectrum\",\"eqFilter\":[{\"type\":\"high-pass\",\"cutoffHz\":1000,\"linearGain\":0.1768}],\"effects\":[\"note filter\"],\"noteFilter\":[{\"type\":\"low-pass\",\"cutoffHz\":6727.17,\"linearGain\":5.6569}],\"transition\":\"normal\",\"fadeInSeconds\":0.0125,\"fadeOutTicks\":-3,\"chord\":\"simultaneous\",\"spectrum\":[0,0,0,0,0,0,0,0,0,0,0,0,0,14,0,0,0,29,14,0,0,43,0,43,0,71,43,0,57,0],\"envelopes\":[{\"target\":\"noteFilterAllFreqs\",\"envelope\":\"flare 1\"},{\"target\":\"noteVolume\",\"envelope\":\"twang 2\"}]}},\r\n\t\t\t{name: \"fifth saw lead\",   midiProgram:  86, generalMidi: true, midiSubharmonicOctaves: 1, settings: {\"type\":\"chip\",\"eqFilter\":[],\"effects\":[\"note filter\",\"chorus\"],\"noteFilter\":[{\"type\":\"low-pass\",\"cutoffHz\":2828.43,\"linearGain\":1.4142}],\"chorus\":67,\"transition\":\"normal\",\"fadeInSeconds\":0,\"fadeOutTicks\":48,\"chord\":\"simultaneous\",\"wave\":\"sawtooth\",\"unison\":\"fifth\",\"envelopes\":[{\"target\":\"noteFilterAllFreqs\",\"envelope\":\"twang 3\"}]}},\r\n\t\t\t{name: \"fifth swell\",      midiProgram:  86, midiSubharmonicOctaves: 1, settings: {\"type\":\"chip\",\"eqFilter\":[],\"effects\":[\"note filter\",\"chorus\"],\"noteFilter\":[{\"type\":\"low-pass\",\"cutoffHz\":2000,\"linearGain\":2}],\"chorus\":100,\"transition\":\"normal\",\"fadeInSeconds\":0.0125,\"fadeOutTicks\":72,\"chord\":\"simultaneous\",\"wave\":\"sawtooth\",\"unison\":\"fifth\",\"envelopes\":[{\"target\":\"noteFilterAllFreqs\",\"envelope\":\"swell 3\"}]}},\r\n\t\t\t{name: \"soundtrack\",       midiProgram:  97, generalMidi: true, settings: {\"type\":\"chip\",\"eqFilter\":[],\"effects\":[\"note filter\",\"chorus\"],\"noteFilter\":[{\"type\":\"low-pass\",\"cutoffHz\":2378.41,\"linearGain\":0.5}],\"chorus\":67,\"transition\":\"normal\",\"fadeInSeconds\":0.0413,\"fadeOutTicks\":72,\"chord\":\"simultaneous\",\"wave\":\"sawtooth\",\"unison\":\"fifth\",\"envelopes\":[{\"target\":\"noteFilterAllFreqs\",\"envelope\":\"flare 3\"}]}},\r\n\t\t\t{name: \"reverse cymbal\",   midiProgram: 119, generalMidi: true, isNoise: true, midiSubharmonicOctaves: -3, settings: {\"type\":\"spectrum\",\"effects\":\"none\",\"transition\":\"soft\",\"chord\":\"harmony\",\"filterCutoffHz\":4000,\"filterResonance\":14,\"filterEnvelope\":\"swell 3\",\"spectrum\":[29,57,57,29,57,57,29,29,43,29,29,43,29,29,57,57,14,57,14,57,71,71,57,86,57,100,86,86,86,86]}},\r\n\t\t\t{name: \"seashore\",         midiProgram: 122, generalMidi: true, isNoise: true, midiSubharmonicOctaves: -3, settings: {\"type\":\"spectrum\",\"transition\":\"soft fade\",\"effects\":\"reverb\",\"chord\":\"harmony\",\"filterCutoffHz\":2828,\"filterResonance\":0,\"filterEnvelope\":\"swell 3\",\"spectrum\":[14,14,29,29,43,43,43,57,57,57,57,57,57,71,71,71,71,71,71,71,71,71,71,71,71,71,71,71,71,57]}},\r\n\t\t\t{name: \"bird tweet\",       midiProgram: 123, generalMidi: true, settings: {\"type\":\"harmonics\",\"eqFilter\":[],\"effects\":[\"chord type\",\"vibrato\",\"reverb\"],\"chord\":\"strum\",\"vibrato\":\"heavy\",\"reverb\":67,\"fadeInSeconds\":0.0575,\"fadeOutTicks\":-6,\"harmonics\":[0,0,0,100,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],\"unison\":\"hum\",\"envelopes\":[{\"target\":\"noteVolume\",\"envelope\":\"decay 1\"}]}},\r\n\t\t\t{name: \"telephone ring\",   midiProgram: 124, generalMidi: true, settings: {\"type\":\"FM\",\"eqFilter\":[],\"effects\":[\"note filter\"],\"noteFilter\":[{\"type\":\"low-pass\",\"cutoffHz\":5656.85,\"linearGain\":1}],\"transition\":\"normal\",\"fadeInSeconds\":0.0125,\"fadeOutTicks\":-3,\"chord\":\"arpeggio\",\"algorithm\":\"1(234)\",\"feedbackType\":\"1\",\"feedbackAmplitude\":0,\"operators\":[{\"frequency\":\"2\",\"amplitude\":12},{\"frequency\":\"1\",\"amplitude\":4},{\"frequency\":\"20\",\"amplitude\":1},{\"frequency\":\"1\",\"amplitude\":0}],\"envelopes\":[{\"target\":\"noteFilterAllFreqs\",\"envelope\":\"tremolo4\"},{\"target\":\"operatorAmplitude\",\"envelope\":\"tremolo1\",\"index\":1}]}},\r\n\t\t\t{name: \"helicopter\",       midiProgram: 125, generalMidi: true, isNoise: true, midiSubharmonicOctaves: -0.5, settings: {\"type\":\"spectrum\",\"effects\":\"reverb\",\"transition\":\"seamless\",\"chord\":\"arpeggio\",\"filterCutoffHz\":1414,\"filterResonance\":14,\"filterEnvelope\":\"tremolo4\",\"spectrum\":[14,43,43,57,57,57,71,71,71,71,86,86,86,86,86,86,86,86,86,86,86,71,71,71,71,71,71,71,57,57]}},\r\n\t\t\t{name: \"applause\",         midiProgram: 126, generalMidi: true, isNoise: true, midiSubharmonicOctaves: -3, settings: {\"type\":\"spectrum\",\"effects\":\"reverb\",\"transition\":\"soft fade\",\"chord\":\"harmony\",\"filterCutoffHz\":2000,\"filterResonance\":14,\"filterEnvelope\":\"swell 3\",\"spectrum\":[14,14,29,29,29,43,43,57,71,71,86,86,86,71,71,57,57,57,71,86,86,86,86,86,71,71,57,57,57,57]}},\r\n\t\t\t{name: \"gunshot\",          midiProgram: 127, generalMidi: true, isNoise: true, midiSubharmonicOctaves: -2, settings: {\"type\":\"spectrum\",\"effects\":\"reverb\",\"transition\":\"hard fade\",\"chord\":\"strum\",\"filterCutoffHz\":1414,\"filterResonance\":29,\"filterEnvelope\":\"twang 1\",\"spectrum\":[14,29,43,43,57,57,57,71,71,71,86,86,86,86,86,86,86,86,86,86,86,71,71,71,71,57,57,57,57,43]}},\r\n\t\t\t{name: \"scoot\",            midiProgram:  92, settings: {\"type\":\"chip\",\"eqFilter\":[],\"effects\":[\"note filter\"],\"noteFilter\":[{\"type\":\"low-pass\",\"cutoffHz\":707.11,\"linearGain\":4}],\"transition\":\"normal\",\"fadeInSeconds\":0.0125,\"fadeOutTicks\":-3,\"chord\":\"simultaneous\",\"wave\":\"double saw\",\"unison\":\"shimmer\",\"envelopes\":[{\"target\":\"noteFilterAllFreqs\",\"envelope\":\"flare 1\"}]}},\r\n\t\t\t{name: \"buzz saw\",         midiProgram:  30, settings: {\"type\":\"FM\",\"eqFilter\":[{\"type\":\"low-pass\",\"cutoffHz\":9513.66,\"linearGain\":0.5}],\"effects\":[],\"transition\":\"normal\",\"fadeInSeconds\":0.0263,\"fadeOutTicks\":-3,\"chord\":\"custom interval\",\"algorithm\":\"1234\",\"feedbackType\":\"1\",\"feedbackAmplitude\":4,\"operators\":[{\"frequency\":\"5\",\"amplitude\":13},{\"frequency\":\"1\",\"amplitude\":10},{\"frequency\":\"~1\",\"amplitude\":6},{\"frequency\":\"11\",\"amplitude\":12}],\"envelopes\":[]}},\r\n\t\t\t{name: \"mosquito\",         midiProgram:  93, settings: {\"type\":\"PWM\",\"eqFilter\":[{\"type\":\"low-pass\",\"cutoffHz\":2828.43,\"linearGain\":2}],\"effects\":[\"vibrato\"],\"vibrato\":\"shaky\",\"transition\":\"normal\",\"fadeInSeconds\":0.0575,\"fadeOutTicks\":-6,\"chord\":\"simultaneous\",\"pulseWidth\":4.41942,\"envelopes\":[{\"target\":\"pulseWidth\",\"envelope\":\"tremolo6\"}]}},\r\n\t\t\t{name: \"breathing\",        midiProgram: 126, isNoise: true, midiSubharmonicOctaves: -1, settings: {\"type\":\"spectrum\",\"effects\":\"reverb\",\"transition\":\"hard fade\",\"chord\":\"harmony\",\"filterCutoffHz\":2000,\"filterResonance\":14,\"filterEnvelope\":\"swell 2\",\"spectrum\":[14,14,14,29,29,29,29,29,43,29,29,43,43,43,29,29,71,43,86,86,57,100,86,86,86,86,71,86,71,57]}},\r\n\t\t\t{name: \"klaxon synth\",     midiProgram: 125, isNoise: true, midiSubharmonicOctaves: -1, settings: {\"type\":\"noise\",\"effects\":\"reverb\",\"transition\":\"slide\",\"chord\":\"harmony\",\"filterCutoffHz\":2000,\"filterResonance\":86,\"filterEnvelope\":\"steady\",\"wave\":\"buzz\"}},\r\n\t\t\t{name: \"theremin\",         midiProgram:  40, settings: {\"type\":\"harmonics\",\"eqFilter\":[{\"type\":\"low-pass\",\"cutoffHz\":8000,\"linearGain\":0.7071}],\"effects\":[\"vibrato\",\"reverb\"],\"vibrato\":\"heavy\",\"reverb\":33,\"transition\":\"slide in pattern\",\"fadeInSeconds\":0.0263,\"fadeOutTicks\":-6,\"chord\":\"simultaneous\",\"harmonics\":[100,71,57,43,29,29,14,14,14,14,14,14,14,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],\"unison\":\"none\",\"envelopes\":[]}},\r\n\t\t\t{name: \"sonar ping\",       midiProgram: 121, settings: {\"type\":\"spectrum\",\"eqFilter\":[],\"effects\":[\"note filter\",\"reverb\"],\"noteFilter\":[{\"type\":\"low-pass\",\"cutoffHz\":1681.79,\"linearGain\":0.5}],\"reverb\":33,\"transition\":\"normal\",\"fadeInSeconds\":0.0125,\"fadeOutTicks\":72,\"chord\":\"simultaneous\",\"spectrum\":[100,43,29,29,14,14,14,14,14,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],\"envelopes\":[{\"target\":\"noteFilterAllFreqs\",\"envelope\":\"twang 2\"}]}},\r\n\t\t])},\r\n\t]);\r\n\t\r\n\tpublic static valueToPreset(presetValue: number): Preset | null {\r\n\t\tconst categoryIndex: number = presetValue >> 6;\r\n\t\tconst presetIndex: number = presetValue & 0x3F;\r\n\t\treturn EditorConfig.presetCategories[categoryIndex].presets[presetIndex];\r\n\t}\r\n\t\r\n\tpublic static midiProgramToPresetValue(program: number): number | null {\r\n\t\tfor (let categoryIndex: number = 0; categoryIndex < EditorConfig.presetCategories.length; categoryIndex++) {\r\n\t\t\tconst category: PresetCategory = EditorConfig.presetCategories[categoryIndex];\r\n\t\t\tfor (let presetIndex: number = 0; presetIndex < category.presets.length; presetIndex++) {\r\n\t\t\t\tconst preset: Preset = category.presets[presetIndex];\r\n\t\t\t\tif (preset.generalMidi && preset.midiProgram == program) return (categoryIndex << 6) + presetIndex;\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn null;\r\n\t}\r\n\t\r\n\tpublic static nameToPresetValue(presetName: string): number | null {\r\n\t\tfor (let categoryIndex: number = 0; categoryIndex < EditorConfig.presetCategories.length; categoryIndex++) {\r\n\t\t\tconst category: PresetCategory = EditorConfig.presetCategories[categoryIndex];\r\n\t\t\tfor (let presetIndex: number = 0; presetIndex < category.presets.length; presetIndex++) {\r\n\t\t\t\tconst preset: Preset = category.presets[presetIndex];\r\n\t\t\t\tif (preset.name == presetName) return (categoryIndex << 6) + presetIndex;\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn null;\r\n\t}\r\n}\r\n","// Copyright (C) 2020 John Nesky, distributed under the MIT license.\n\nexport function applyElementArgs<T extends HTMLElement | SVGElement | DocumentFragment>(element: T, args: Array<any>): T {\n\tfor (const arg of args) {\n\t\tif (arg instanceof Node) {\n\t\t\telement.appendChild(arg);\n\t\t} else if (typeof arg === \"string\") {\n\t\t\telement.appendChild(document.createTextNode(arg));\n\t\t} else if (typeof arg === \"function\") {\n\t\t\tapplyElementArgs(element, [arg()]);\n\t\t} else if (Array.isArray(arg)) {\n\t\t\tapplyElementArgs(element, arg);\n\t\t} else if (arg && typeof Symbol !== \"undefined\" && typeof arg[Symbol.iterator] === \"function\") {\n\t\t\tapplyElementArgs(element, [...arg]);\n\t\t} else if (arg && arg.constructor === Object && element instanceof Element) {\n\t\t\t// If the argument is a literal {} Object\n\t\t\tfor (const key of Object.keys(arg)) {\n\t\t\t\tconst value = arg[key];\n\t\t\t\t/*if (key === \"classList\") {\n\t\t\t\t\tif (typeof value === \"string\") {\n\t\t\t\t\t\telement.classList.add(...value.split(\" \"));\n\t\t\t\t\t} else if (Array.isArray(arg) || (value && typeof Symbol !== \"undefined\" && typeof value[Symbol.iterator] === \"function\")) {\n\t\t\t\t\t\telement.classList.add(...value);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tconsole.warn(\"Invalid classList value \\\"\" + value + \"\\\" on \" + element.tagName + \" element.\");\n\t\t\t\t\t}\n\t\t\t\t} else*/ if (key === \"class\" /* || key === \"className\" */) {\n\t\t\t\t\tif (typeof value === \"string\") {\n\t\t\t\t\t\telement.setAttribute(\"class\", value);\n\t\t\t\t\t} else if (Array.isArray(arg) || (value && typeof Symbol !== \"undefined\" && typeof value[Symbol.iterator] === \"function\")) {\n\t\t\t\t\t\telement.setAttribute(\"class\", [...value].join(\" \"));\n\t\t\t\t\t} else {\n\t\t\t\t\t\tconsole.warn(\"Invalid \" + key + \" value \\\"\" + value + \"\\\" on \" + element.tagName + \" element.\");\n\t\t\t\t\t}\n\t\t\t\t} else if (key === \"style\") {\n\t\t\t\t\tif (value && value.constructor === Object) {\n\t\t\t\t\t\tfor (const styleKey of Object.keys(value)) {\n\t\t\t\t\t\t\tif (styleKey in (<HTMLElement | SVGElement>element).style) {\n\t\t\t\t\t\t\t\t// In practice, camelCase and kebab-case properties both work as properties on CSSStyleDeclaration objects.\n\t\t\t\t\t\t\t\t(<any> element).style[styleKey] = value[styleKey];\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t// CSS variables start with -- and must be set with setProperty.\n\t\t\t\t\t\t\t\t(<HTMLElement | SVGElement>element).style.setProperty(styleKey, value[styleKey]);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t} else {\n\t\t\t\t\t\telement.setAttribute(key, value);\n\t\t\t\t\t}\n\t\t\t\t} else if (typeof(value) === \"function\") {\n\t\t\t\t\t// If value is a callback, set as a property instead trying to coerce to string.\n\t\t\t\t\t(<any>element)[key] = value;\n\t\t\t\t} else if (typeof(value) === \"boolean\") {\n\t\t\t\t\t// If value is boolean, set attribute if true, remove if false.\n\t\t\t\t\tif (value) element.setAttribute(key, \"\");\n\t\t\t\t\telse element.removeAttribute(key);\n\t\t\t\t} else {\n\t\t\t\t\t// Default to setting attribute, as if writing html directly.\n\t\t\t\t\telement.setAttribute(key, value);\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\t// Just convert unrecognized objects to text and append them.\n\t\t\telement.appendChild(document.createTextNode(arg));\n\t\t}\n\t}\n\treturn element;\n}\n\nexport const svgNS: string = \"http://www.w3.org/2000/svg\";\n\nexport function parseHTML(...args: Array<any>): DocumentFragment {\n\treturn document.createRange().createContextualFragment(args.join());\n}\n\n//let svgParser: SVGSVGElement | null = null;\nexport function parseSVG(...args: Array<any>): DocumentFragment {\n\tconst fragment: DocumentFragment = document.createDocumentFragment();\n\t\n\t// Internet Explorer doesn't support the first method here, so I commented it out and used a slightly more complex one involving DOMParser below.\n\t/*\n\tif (svgParser === null) svgParser = <SVGSVGElement>document.createElementNS(svgNS, \"svg\");\n\tsvgParser.innerHTML = args.join();\n\twhile (svgParser.firstChild !== null) fragment.appendChild(svgParser.firstChild);\n\t*/\n\tconst svgParser: Element = new DOMParser().parseFromString(\"<svg xmlns=\\\"http://www.w3.org/2000/svg\\\">\" + args.join() + \"</svg>\", \"image/svg+xml\").documentElement;\n\twhile (svgParser.firstChild !== null) {\n\t\tdocument.importNode(svgParser.firstChild, true);\n\t\tfragment.appendChild(svgParser.firstChild);\n\t}\n\t\n\treturn fragment;\n}\n\nexport function replaceScriptWith(...args: Array<any>): void {\n\tlet currentScript: HTMLScriptElement | SVGScriptElement | null = document.currentScript;\n\tif (currentScript == null) { // double-equals to intentionally include undefined in Internet Explorer.\n\t\t\n\t\t// Internet Explorer doens't support currentScript, try this method instead:\n\t\tif (document.readyState === \"loading\") {\n\t\t\tconst scripts: HTMLCollectionOf<HTMLScriptElement> = document.getElementsByTagName(\"script\");\n\t\t\tcurrentScript = scripts[scripts.length - 1];\n\t\t}\n\t\t\n\t\tif (currentScript == null) {\n\t\t\tconsole.warn(\"Couldn't replace script because no script is currently being parsed and executed, maybe this is happening in a callback function or event handler instead?\");\n\t\t\treturn;\n\t\t}\n\t}\n\tif (currentScript.parentNode === null) {\n\t\tconsole.warn(\"Couldn't replace script element because it is not attached to a parent anymore, did you try to replace the same script more than once?\");\n\t\treturn;\n\t}\n\tcurrentScript.parentNode.replaceChild(applyElementArgs(document.createDocumentFragment(), args), currentScript);\n}\n\nexport function applyToElement<T extends HTMLElement | SVGElement | DocumentFragment>(element: T, ...args: Array<any>): T {\n\tif (!(element instanceof Element || element instanceof DocumentFragment)) {\n\t\tconsole.warn(\"Couldn't apply to provided argument because it's not an element or DocumentFragment.\");\n\t\treturn element;\n\t}\n\treturn applyElementArgs(element, args);\n}\n","// Copyright (C) 2020 John Nesky, distributed under the MIT license.\n\nimport {applyElementArgs, svgNS, parseHTML, parseSVG, replaceScriptWith, applyToElement} from \"./elements-base\";\nexport {replaceScriptWith, applyToElement};\n\ninterface HTMLElementFactory {\n\t(...args: Array<string>): DocumentFragment;\n\t//readonly [key: string]: (...args: Array<any>) => HTMLElement;\n\ta(...args: Array<any>): HTMLAnchorElement;\n\tabbr(...args: Array<any>): HTMLElement;\n\taddress(...args: Array<any>): HTMLElement;\n\tarea(...args: Array<any>): HTMLAreaElement;\n\tarticle(...args: Array<any>): HTMLElement;\n\taside(...args: Array<any>): HTMLElement;\n\taudio(...args: Array<any>): HTMLAudioElement;\n\tb(...args: Array<any>): HTMLElement;\n\tbase(...args: Array<any>): HTMLBaseElement;\n\tbdi(...args: Array<any>): HTMLElement;\n\tbdo(...args: Array<any>): HTMLElement;\n\tblockquote(...args: Array<any>): HTMLQuoteElement;\n\tbr(...args: Array<any>): HTMLBRElement;\n\tbutton(...args: Array<any>): HTMLButtonElement;\n\tcanvas(...args: Array<any>): HTMLCanvasElement;\n\tcaption(...args: Array<any>): HTMLTableCaptionElement;\n\tcite(...args: Array<any>): HTMLElement;\n\tcode(...args: Array<any>): HTMLElement;\n\tcol(...args: Array<any>): HTMLTableColElement;\n\tcolgroup(...args: Array<any>): HTMLTableColElement;\n\tdatalist(...args: Array<any>): HTMLDataListElement;\n\tdd(...args: Array<any>): HTMLElement;\n\tdel(...args: Array<any>): HTMLModElement;\n\tdetails(...args: Array<any>): HTMLDetailsElement;\n\tdfn(...args: Array<any>): HTMLElement;\n\tdialog(...args: Array<any>): HTMLDialogElement;\n\tdiv(...args: Array<any>): HTMLDivElement;\n\tdl(...args: Array<any>): HTMLDListElement;\n\tdt(...args: Array<any>): HTMLElement;\n\tem(...args: Array<any>): HTMLElement;\n\tembed(...args: Array<any>): HTMLEmbedElement;\n\tfieldset(...args: Array<any>): HTMLFieldSetElement;\n\tfigcaption(...args: Array<any>): HTMLElement;\n\tfigure(...args: Array<any>): HTMLElement;\n\tfooter(...args: Array<any>): HTMLElement;\n\tform(...args: Array<any>): HTMLFormElement;\n\th1(...args: Array<any>): HTMLHeadingElement;\n\th2(...args: Array<any>): HTMLHeadingElement;\n\th3(...args: Array<any>): HTMLHeadingElement;\n\th4(...args: Array<any>): HTMLHeadingElement;\n\th5(...args: Array<any>): HTMLHeadingElement;\n\th6(...args: Array<any>): HTMLHeadingElement;\n\theader(...args: Array<any>): HTMLElement;\n\thr(...args: Array<any>): HTMLHRElement;\n\ti(...args: Array<any>): HTMLElement;\n\tiframe(...args: Array<any>): HTMLIFrameElement;\n\timg(...args: Array<any>): HTMLImageElement;\n\tinput(...args: Array<any>): HTMLInputElement;\n\tins(...args: Array<any>): HTMLModElement;\n\tkbd(...args: Array<any>): HTMLElement;\n\tlabel(...args: Array<any>): HTMLLabelElement;\n\tlegend(...args: Array<any>): HTMLLegendElement;\n\tli(...args: Array<any>): HTMLLIElement;\n\tlink(...args: Array<any>): HTMLLinkElement;\n\tmain(...args: Array<any>): HTMLElement;\n\tmap(...args: Array<any>): HTMLMapElement;\n\tmark(...args: Array<any>): HTMLElement;\n\tmenu(...args: Array<any>): HTMLMenuElement;\n\tmenuitem(...args: Array<any>): HTMLUnknownElement;\n\tmeta(...args: Array<any>): HTMLMetaElement;\n\tmeter(...args: Array<any>): HTMLMeterElement;\n\tnav(...args: Array<any>): HTMLElement;\n\tnoscript(...args: Array<any>): HTMLElement;\n\tobject(...args: Array<any>): HTMLObjectElement;\n\tol(...args: Array<any>): HTMLOListElement;\n\toptgroup(...args: Array<any>): HTMLOptGroupElement;\n\toption(...args: Array<any>): HTMLOptionElement;\n\toutput(...args: Array<any>): HTMLOutputElement;\n\tp(...args: Array<any>): HTMLParagraphElement;\n\tparam(...args: Array<any>): HTMLParamElement;\n\tpicture(...args: Array<any>): HTMLPictureElement;\n\tpre(...args: Array<any>): HTMLPreElement;\n\tprogress(...args: Array<any>): HTMLProgressElement;\n\tq(...args: Array<any>): HTMLQuoteElement;\n\trp(...args: Array<any>): HTMLElement;\n\trt(...args: Array<any>): HTMLElement;\n\truby(...args: Array<any>): HTMLElement;\n\ts(...args: Array<any>): HTMLElement;\n\tsamp(...args: Array<any>): HTMLElement;\n\tscript(...args: Array<any>): HTMLScriptElement;\n\tsection(...args: Array<any>): HTMLElement;\n\tselect(...args: Array<any>): HTMLSelectElement;\n\tsmall(...args: Array<any>): HTMLElement;\n\tsource(...args: Array<any>): HTMLSourceElement;\n\tspan(...args: Array<any>): HTMLSpanElement;\n\tstrong(...args: Array<any>): HTMLElement;\n\tstyle(...args: Array<any>): HTMLStyleElement;\n\tsub(...args: Array<any>): HTMLElement;\n\tsummary(...args: Array<any>): HTMLElement;\n\tsup(...args: Array<any>): HTMLElement;\n\ttable(...args: Array<any>): HTMLTableElement;\n\ttbody(...args: Array<any>): HTMLTableSectionElement;\n\ttd(...args: Array<any>): HTMLTableCellElement;\n\ttemplate(...args: Array<any>): HTMLTemplateElement;\n\ttextarea(...args: Array<any>): HTMLTextAreaElement;\n\ttfoot(...args: Array<any>): HTMLTableSectionElement;\n\tth(...args: Array<any>): HTMLTableCellElement;\n\tthead(...args: Array<any>): HTMLTableSectionElement;\n\ttime(...args: Array<any>): HTMLTimeElement;\n\ttitle(...args: Array<any>): HTMLTitleElement;\n\ttr(...args: Array<any>): HTMLTableRowElement;\n\ttrack(...args: Array<any>): HTMLTrackElement;\n\tu(...args: Array<any>): HTMLElement;\n\tul(...args: Array<any>): HTMLUListElement;\n\tvar(...args: Array<any>): HTMLElement;\n\tvideo(...args: Array<any>): HTMLVideoElement;\n\twbr(...args: Array<any>): HTMLElement;\n}\n\ninterface SVGElementFactory {\n\t(...args: Array<string>): DocumentFragment;\n\t//readonly [key: string]: (...args: Array<any>) => SVGElement;\n\ta(...args: Array<any>): SVGAElement;\n\taltGlyph(...args: Array<any>): SVGElement;\n\taltGlyphDef(...args: Array<any>): SVGElement;\n\taltGlyphItem(...args: Array<any>): SVGElement;\n\tanimate(...args: Array<any>): SVGAnimateElement;\n\tanimateMotion(...args: Array<any>): SVGAnimateMotionElement;\n\tanimateTransform(...args: Array<any>): SVGAnimateTransformElement;\n\tcircle(...args: Array<any>): SVGCircleElement;\n\tclipPath(...args: Array<any>): SVGClipPathElement;\n\t\"color-profile\"(...args: Array<any>): SVGElement;\n\tcolor_profile(...args: Array<any>): SVGElement;\n\tcursor(...args: Array<any>): SVGElement;\n\tdefs(...args: Array<any>): SVGDefsElement;\n\tdesc(...args: Array<any>): SVGDescElement;\n\tdiscard(...args: Array<any>): SVGElement;\n\tellipse(...args: Array<any>): SVGEllipseElement;\n\tfeBlend(...args: Array<any>): SVGFEBlendElement;\n\tfeColorMatrix(...args: Array<any>): SVGFEColorMatrixElement;\n\tfeComponentTransfer(...args: Array<any>): SVGFEComponentTransferElement;\n\tfeComposite(...args: Array<any>): SVGFECompositeElement;\n\tfeConvolveMatrix(...args: Array<any>): SVGFEConvolveMatrixElement;\n\tfeDiffuseLighting(...args: Array<any>): SVGFEDiffuseLightingElement;\n\tfeDisplacementMap(...args: Array<any>): SVGFEDisplacementMapElement;\n\tfeDistantLight(...args: Array<any>): SVGFEDistantLightElement;\n\tfeDropShadow(...args: Array<any>): SVGElement;\n\tfeFlood(...args: Array<any>): SVGFEFloodElement;\n\tfeFuncA(...args: Array<any>): SVGFEFuncAElement;\n\tfeFuncB(...args: Array<any>): SVGFEFuncBElement;\n\tfeFuncG(...args: Array<any>): SVGFEFuncGElement;\n\tfeFuncR(...args: Array<any>): SVGFEFuncRElement;\n\tfeGaussianBlur(...args: Array<any>): SVGFEGaussianBlurElement;\n\tfeImage(...args: Array<any>): SVGFEImageElement;\n\tfeMerge(...args: Array<any>): SVGFEMergeElement;\n\tfeMergeNode(...args: Array<any>): SVGFEMergeNodeElement;\n\tfeMorphology(...args: Array<any>): SVGFEMorphologyElement;\n\tfeOffset(...args: Array<any>): SVGFEOffsetElement;\n\tfePointLight(...args: Array<any>): SVGFEPointLightElement;\n\tfeSpecularLighting(...args: Array<any>): SVGFESpecularLightingElement;\n\tfeSpotLight(...args: Array<any>): SVGFESpotLightElement;\n\tfeTile(...args: Array<any>): SVGFETileElement;\n\tfeTurbulence(...args: Array<any>): SVGFETurbulenceElement;\n\tfilter(...args: Array<any>): SVGFilterElement;\n\tfont(...args: Array<any>): SVGElement;\n\t\"font-face\"(...args: Array<any>): SVGElement;\n\tfont_face(...args: Array<any>): SVGElement;\n\t\"font-face-format\"(...args: Array<any>): SVGElement;\n\tfont_face_format(...args: Array<any>): SVGElement;\n\t\"font-face-name\"(...args: Array<any>): SVGElement;\n\tfont_face_name(...args: Array<any>): SVGElement;\n\t\"font-face-src\"(...args: Array<any>): SVGElement;\n\tfont_face_src(...args: Array<any>): SVGElement;\n\t\"font-face-uri\"(...args: Array<any>): SVGElement;\n\tfont_face_uri(...args: Array<any>): SVGElement;\n\tforeignObject(...args: Array<any>): SVGForeignObjectElement;\n\tg(...args: Array<any>): SVGGElement;\n\tglyph(...args: Array<any>): SVGElement;\n\tglyphRef(...args: Array<any>): SVGElement;\n\thkern(...args: Array<any>): SVGElement;\n\timage(...args: Array<any>): SVGImageElement;\n\tline(...args: Array<any>): SVGLineElement;\n\tlinearGradient(...args: Array<any>): SVGLinearGradientElement;\n\tmarker(...args: Array<any>): SVGMarkerElement;\n\tmask(...args: Array<any>): SVGMaskElement;\n\tmetadata(...args: Array<any>): SVGMetadataElement;\n\t\"missing-glyph\"(...args: Array<any>): SVGElement;\n\tmissing_glyph(...args: Array<any>): SVGElement;\n\tmpath(...args: Array<any>): SVGElement;\n\tpath(...args: Array<any>): SVGPathElement;\n\tpattern(...args: Array<any>): SVGPatternElement;\n\tpolygon(...args: Array<any>): SVGPolygonElement;\n\tpolyline(...args: Array<any>): SVGPolylineElement;\n\tradialGradient(...args: Array<any>): SVGRadialGradientElement;\n\trect(...args: Array<any>): SVGRectElement;\n\tscript(...args: Array<any>): SVGScriptElement;\n\tset(...args: Array<any>): SVGElement;\n\tstop(...args: Array<any>): SVGStopElement;\n\tstyle(...args: Array<any>): SVGStyleElement;\n\tsvg(...args: Array<any>): SVGSVGElement;\n\tswitch(...args: Array<any>): SVGSwitchElement;\n\tsymbol(...args: Array<any>): SVGSymbolElement;\n\ttext(...args: Array<any>): SVGTextElement;\n\ttextPath(...args: Array<any>): SVGTextPathElement;\n\ttitle(...args: Array<any>): SVGTitleElement;\n\ttref(...args: Array<any>): SVGElement;\n\ttspan(...args: Array<any>): SVGTSpanElement;\n\tuse(...args: Array<any>): SVGUseElement;\n\tview(...args: Array<any>): SVGViewElement;\n\tvkern(...args: Array<any>): SVGElement;\n}\n\nexport const HTML: HTMLElementFactory = <HTMLElementFactory> <unknown> parseHTML;\nexport const SVG: SVGElementFactory = <SVGElementFactory> <unknown> parseSVG;\n\nfor (const name of \"a abbr address area article aside audio b base bdi bdo blockquote br button canvas caption cite code col colgroup datalist dd del details dfn dialog div dl dt em embed fieldset figcaption figure footer form h1 h2 h3 h4 h5 h6 header hr i iframe img input ins kbd label legend li link main map mark menu menuitem meta meter nav noscript object ol optgroup option output p param picture pre progress q rp rt ruby s samp script section select small source span strong style sub summary sup table tbody td template textarea tfoot th thead time title tr track u ul var video wbr\".split(\" \")) {\n\t(<any>HTML)[name] = (...args: Array<any>) => applyElementArgs(document.createElement(name), args);\n}\nfor (const name of \"a altGlyph altGlyphDef altGlyphItem animate animateMotion animateTransform circle clipPath color-profile cursor defs desc discard ellipse feBlend feColorMatrix feComponentTransfer feComposite feConvolveMatrix feDiffuseLighting feDisplacementMap feDistantLight feDropShadow feFlood feFuncA feFuncB feFuncG feFuncR feGaussianBlur feImage feMerge feMergeNode feMorphology feOffset fePointLight feSpecularLighting feSpotLight feTile feTurbulence filter font font-face font-face-format font-face-name font-face-src font-face-uri foreignObject g glyph glyphRef hkern image line linearGradient marker mask metadata missing-glyph mpath path pattern polygon polyline radialGradient rect script set stop style svg switch symbol text textPath title tref tspan use view vkern\".split(\" \")) {\n\t(<any>SVG)[name] = (...args: Array<any>) => applyElementArgs(<SVGElement> document.createElementNS(svgNS, name), args);\n\tif (/-/.test(name)) {\n\t\tconst snakeCaseName = name.replace(/-/g, \"_\");\n\t\t(<any>SVG)[snakeCaseName] = (...args: Array<any>) => applyElementArgs(<SVGElement> document.createElementNS(svgNS, name), args);\n\t}\n}\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nimport {BeepBoxOption, DictionaryArray, toNameMap} from \"../synth/SynthConfig\";\r\nimport {Song} from \"../synth/synth\";\r\nimport {HTML} from \"imperative-html/dist/esm/elements-strict\";\r\n\r\nexport interface ChannelColors extends BeepBoxOption {\r\n\treadonly secondaryChannel: string;\r\n\treadonly primaryChannel:   string;\r\n\treadonly secondaryNote: string;\r\n\treadonly primaryNote: string;\r\n}\r\n\r\nexport class ColorConfig {\r\n\tpublic static readonly themes: {[name: string]: string} = {\r\n\t\t\"dark classic\": `\r\n\t\t\t:root {\r\n\t\t\t\t--page-margin: black;\r\n\t\t\t\t--editor-background: black;\r\n\t\t\t\t--hover-preview: white;\r\n\t\t\t\t--playhead: white;\r\n\t\t\t\t--primary-text: white;\r\n\t\t\t\t--secondary-text: #999;\r\n\t\t\t\t--inverted-text: black;\r\n\t\t\t\t--text-selection: rgba(119,68,255,0.99);\r\n\t\t\t\t--box-selection-fill: rgba(255,255,255,0.2);\r\n\t\t\t\t--loop-accent: #74f;\r\n\t\t\t\t--link-accent: #98f;\r\n\t\t\t\t--ui-widget-background: #444;\r\n\t\t\t\t--ui-widget-focus: #777;\r\n\t\t\t\t--pitch-background: #444;\r\n\t\t\t\t--tonic: #864;\r\n\t\t\t\t--fifth-note: #468;\r\n\t\t\t\t--white-piano-key: #bbb;\r\n\t\t\t\t--black-piano-key: #444;\r\n\t\t\t\t--pitch1-secondary-channel: #0099A1;\r\n\t\t\t\t--pitch1-primary-channel:   #25F3FF;\r\n\t\t\t\t--pitch1-secondary-note:    #00BDC7;\r\n\t\t\t\t--pitch1-primary-note:      #92F9FF;\r\n\t\t\t\t--pitch2-secondary-channel: #A1A100;\r\n\t\t\t\t--pitch2-primary-channel:   #FFFF25;\r\n\t\t\t\t--pitch2-secondary-note:    #C7C700;\r\n\t\t\t\t--pitch2-primary-note:      #FFFF92;\r\n\t\t\t\t--pitch3-secondary-channel: #C75000;\r\n\t\t\t\t--pitch3-primary-channel:   #FF9752;\r\n\t\t\t\t--pitch3-secondary-note:    #FF771C;\r\n\t\t\t\t--pitch3-primary-note:      #FFCDAB;\r\n\t\t\t\t--pitch4-secondary-channel: #00A100;\r\n\t\t\t\t--pitch4-primary-channel:   #50FF50;\r\n\t\t\t\t--pitch4-secondary-note:    #00C700;\r\n\t\t\t\t--pitch4-primary-note:      #A0FFA0;\r\n\t\t\t\t--pitch5-secondary-channel: #D020D0;\r\n\t\t\t\t--pitch5-primary-channel:   #FF90FF;\r\n\t\t\t\t--pitch5-secondary-note:    #E040E0;\r\n\t\t\t\t--pitch5-primary-note:      #FFC0FF;\r\n\t\t\t\t--pitch6-secondary-channel: #7777B0;\r\n\t\t\t\t--pitch6-primary-channel:   #A0A0FF;\r\n\t\t\t\t--pitch6-secondary-note:    #8888D0;\r\n\t\t\t\t--pitch6-primary-note:      #D0D0FF;\r\n\t\t\t\t--pitch7-secondary-channel: #8AA100;\r\n\t\t\t\t--pitch7-primary-channel:   #DEFF25;\r\n\t\t\t\t--pitch7-secondary-note:    #AAC700;\r\n\t\t\t\t--pitch7-primary-note:      #E6FF92;\r\n\t\t\t\t--pitch8-secondary-channel: #DF0019;\r\n\t\t\t\t--pitch8-primary-channel:   #FF98A4;\r\n\t\t\t\t--pitch8-secondary-note:    #FF4E63;\r\n\t\t\t\t--pitch8-primary-note:      #FFB2BB;\r\n\t\t\t\t--pitch9-secondary-channel: #00A170;\r\n\t\t\t\t--pitch9-primary-channel:   #50FFC9;\r\n\t\t\t\t--pitch9-secondary-note:    #00C78A;\r\n\t\t\t\t--pitch9-primary-note:      #83FFD9;\r\n\t\t\t\t--pitch10-secondary-channel:#A11FFF;\r\n\t\t\t\t--pitch10-primary-channel:  #CE8BFF;\r\n\t\t\t\t--pitch10-secondary-note:   #B757FF;\r\n\t\t\t\t--pitch10-primary-note:     #DFACFF;\r\n\t\t\t\t--noise1-secondary-channel: #6F6F6F;\r\n\t\t\t\t--noise1-primary-channel:   #AAAAAA;\r\n\t\t\t\t--noise1-secondary-note:    #A7A7A7;\r\n\t\t\t\t--noise1-primary-note:      #E0E0E0;\r\n\t\t\t\t--noise2-secondary-channel: #996633;\r\n\t\t\t\t--noise2-primary-channel:   #DDAA77;\r\n\t\t\t\t--noise2-secondary-note:    #CC9966;\r\n\t\t\t\t--noise2-primary-note:      #F0D0BB;\r\n\t\t\t\t--noise3-secondary-channel: #4A6D8F;\r\n\t\t\t\t--noise3-primary-channel:   #77AADD;\r\n\t\t\t\t--noise3-secondary-note:    #6F9FCF;\r\n\t\t\t\t--noise3-primary-note:      #BBD7FF;\r\n\t\t\t\t--noise4-secondary-channel: #7A4F9A;\r\n\t\t\t\t--noise4-primary-channel:   #AF82D2;\r\n\t\t\t\t--noise4-secondary-note:    #9E71C1;\r\n\t\t\t\t--noise4-primary-note:      #D4C1EA;\r\n\t\t\t\t--noise5-secondary-channel: #607837;\r\n\t\t\t\t--noise5-primary-channel:   #A2BB77;\r\n\t\t\t\t--noise5-secondary-note:    #91AA66;\r\n\t\t\t\t--noise5-primary-note:      #C5E2B2;\r\n\t\t\t}\r\n\t\t`,\r\n\t\t\"dark competition\": `\r\n\t\t\t:root {\r\n\t\t\t\t\t--page-margin: black;\r\n\t\t\t\t\t--editor-background: black;\r\n\t\t\t\t\t--hover-preview: #ddd;\r\n\t\t\t\t\t--playhead: #ddd;\r\n\t\t\t\t\t--primary-text: #ddd;\r\n\t\t\t\t\t--secondary-text: #8e695b;\r\n\t\t\t\t\t--inverted-text: black;\r\n\t\t\t\t\t--text-selection: rgba(169,0,255,0.99);\r\n\t\t\t\t\t--box-selection-fill: rgba(221,221,221,0.2);\r\n\t\t\t\t\t--loop-accent: #bf15ba;\r\n\t\t\t\t\t--link-accent: #f888ff;\r\n\t\t\t\t\t--ui-widget-background: #443a3a;\r\n\t\t\t\t\t--ui-widget-focus: #777;\r\n\t\t\t\t\t--pitch-background: #353333;\r\n\t\t\t\t\t--tonic: #884a44;\r\n\t\t\t\t\t--fifth-note: #415498;\r\n\t\t\t\t\t--white-piano-key: #bbb;\r\n\t\t\t\t\t--black-piano-key: #444;\r\n\t\t\t\t\t--input-box-outline: #333;\r\n\t\t\t\t\t--pitch1-secondary-channel: #0099a1;\r\n\t\t\t\t\t--pitch1-primary-channel:   #25f3ff;\r\n\t\t\t\t\t--pitch1-secondary-note:    #00bdc7;\r\n\t\t\t\t\t--pitch1-primary-note:      #92f9ff;\r\n\t\t\t\t\t--pitch2-secondary-channel: #a1a100;\r\n\t\t\t\t\t--pitch2-primary-channel:   #ffff25;\r\n\t\t\t\t\t--pitch2-secondary-note:    #c7c700;\r\n\t\t\t\t\t--pitch2-primary-note:      #ffff92;\r\n\t\t\t\t\t--pitch3-secondary-channel: #c75000;\r\n\t\t\t\t\t--pitch3-primary-channel:   #ff9752;\r\n\t\t\t\t\t--pitch3-secondary-note:    #ff771c;\r\n\t\t\t\t\t--pitch3-primary-note:      #ffcdab;\r\n\t\t\t\t\t--pitch4-secondary-channel: #00a100;\r\n\t\t\t\t\t--pitch4-primary-channel:   #50ff50;\r\n\t\t\t\t\t--pitch4-secondary-note:    #00c700;\r\n\t\t\t\t\t--pitch4-primary-note:      #a0ffa0;\r\n\t\t\t\t\t--pitch5-secondary-channel: #d020d0;\r\n\t\t\t\t\t--pitch5-primary-channel:   #ff90ff;\r\n\t\t\t\t\t--pitch5-secondary-note:    #e040e0;\r\n\t\t\t\t\t--pitch5-primary-note:      #ffc0ff;\r\n\t\t\t\t\t--pitch6-secondary-channel: #7777b0;\r\n\t\t\t\t\t--pitch6-primary-channel:   #a0a0ff;\r\n\t\t\t\t\t--pitch6-secondary-note:    #8888d0;\r\n\t\t\t\t\t--pitch6-primary-note:      #d0d0ff;\r\n\t\t\t\t\t--pitch7-secondary-channel: #8AA100;\r\n\t\t\t\t\t--pitch7-primary-channel:   #DEFF25;\r\n\t\t\t\t\t--pitch7-secondary-note:\t  #AAC700;\r\n\t\t\t\t\t--pitch7-primary-note:\t\t\t#E6FF92;\r\n\t\t\t\t\t--pitch8-secondary-channel: #DF0019;\r\n\t\t\t\t\t--pitch8-primary-channel:   #FF98A4;\r\n\t\t\t\t\t--pitch8-secondary-note:    #FF4E63;\r\n\t\t\t\t\t--pitch8-primary-note:      #FFB2BB;\r\n\t\t\t\t\t--pitch9-secondary-channel: #00A170;\r\n\t\t\t\t\t--pitch9-primary-channel:   #50FFC9;\r\n\t\t\t\t\t--pitch9-secondary-note:    #00C78A;\r\n\t\t\t\t\t--pitch9-primary-note:\t\t\t#83FFD9;\r\n\t\t\t\t\t--pitch10-secondary-channel:#A11FFF;\r\n\t\t\t\t\t--pitch10-primary-channel:  #CE8BFF;\r\n\t\t\t\t\t--pitch10-secondary-note:   #B757FF;\r\n\t\t\t\t\t--pitch10-primary-note:     #DFACFF;\r\n\t\t\t\t\t--noise1-secondary-channel: #6f6f6f;\r\n\t\t\t\t\t--noise1-primary-channel:   #aaaaaa;\r\n\t\t\t\t\t--noise1-secondary-note:    #a7a7a7;\r\n\t\t\t\t\t--noise1-primary-note:      #e0e0e0;\r\n\t\t\t\t\t--noise2-secondary-channel: #996633;\r\n\t\t\t\t\t--noise2-primary-channel:   #ddaa77;\r\n\t\t\t\t\t--noise2-secondary-note:    #cc9966;\r\n\t\t\t\t\t--noise2-primary-note:      #f0d0bb;\r\n\t\t\t\t\t--noise3-secondary-channel: #4a6d8f;\r\n\t\t\t\t\t--noise3-primary-channel:   #77aadd;\r\n\t\t\t\t\t--noise3-secondary-note:    #6f9fcf;\r\n\t\t\t\t\t--noise3-primary-note:      #bbd7ff;\r\n\t\t\t\t\t--noise4-secondary-channel: #6B3E8E;\r\n\t\t\t\t\t--noise4-primary-channel:   #AF82D2;\r\n\t\t\t\t\t--noise4-secondary-note:    #9E71C1;\r\n\t\t\t\t\t--noise5-secondary-channel: #607837;\r\n\t\t\t\t\t--noise5-primary-channel:   #A2BB77;\r\n\t\t\t\t\t--noise5-secondary-note:    #91AA66;\r\n\t\t\t\t\t--noise5-primary-note:      #C5E2B2;\r\n\r\n\t\t\t}\r\n\t\t`,\r\n\t\t\"light classic\": `\r\n\t\t\t:root {\r\n\t\t\t\t-webkit-text-stroke-width: 0.5px;\r\n\t\t\t\t--page-margin: #685d88;\r\n\t\t\t\t--editor-background: white;\r\n\t\t\t\t--hover-preview: black;\r\n\t\t\t\t--playhead: rgba(0,0,0,0.5);\r\n\t\t\t\t--primary-text: black;\r\n\t\t\t\t--secondary-text: #777;\r\n\t\t\t\t--inverted-text: white;\r\n\t\t\t\t--text-selection: rgba(200,170,255,0.99);\r\n\t\t\t\t--box-selection-fill: rgba(0,0,0,0.1);\r\n\t\t\t\t--loop-accent: #98f;\r\n\t\t\t\t--link-accent: #74f;\r\n\t\t\t\t--ui-widget-background: #ececec;\r\n\t\t\t\t--ui-widget-focus: #eee;\r\n\t\t\t\t--pitch-background: #ececec;\r\n\t\t\t\t--tonic: #f0d6b6;\r\n\t\t\t\t--fifth-note: #bbddf0;\r\n\t\t\t\t--white-piano-key: #eee;\r\n\t\t\t\t--black-piano-key: #666;\r\n\t\t\t\t--pitch1-secondary-channel: #6CD9ED;\r\n\t\t\t\t--pitch1-primary-channel:   #00A0BD;\r\n\t\t\t\t--pitch1-secondary-note:    #34C2DC;\r\n\t\t\t\t--pitch1-primary-note:      #00758A;\r\n\t\t\t\t--pitch2-secondary-channel: #E3C941;\r\n\t\t\t\t--pitch2-primary-channel:   #B49700;\r\n\t\t\t\t--pitch2-secondary-note:    #D1B628;\r\n\t\t\t\t--pitch2-primary-note:      #836E00;\r\n\t\t\t\t--pitch3-secondary-channel: #FF9D61;\r\n\t\t\t\t--pitch3-primary-channel:   #E14E00;\r\n\t\t\t\t--pitch3-secondary-note:    #F67D3C;\r\n\t\t\t\t--pitch3-primary-note:      #B64000;\r\n\t\t\t\t--pitch4-secondary-channel: #4BE24B;\r\n\t\t\t\t--pitch4-primary-channel:   #00A800;\r\n\t\t\t\t--pitch4-secondary-note:    #2DC82D;\r\n\t\t\t\t--pitch4-primary-note:      #008000;\r\n\t\t\t\t--pitch5-secondary-channel: #FF90FF;\r\n\t\t\t\t--pitch5-primary-channel:   #E12EDF;\r\n\t\t\t\t--pitch5-secondary-note:    #EC6EEC;\r\n\t\t\t\t--pitch5-primary-note:      #A600A5;\r\n\t\t\t\t--pitch6-secondary-channel: #B5B5FE;\r\n\t\t\t\t--pitch6-primary-channel:   #6969FD;\r\n\t\t\t\t--pitch6-secondary-note:    #9393FE;\r\n\t\t\t\t--pitch6-primary-note:      #4A4AD7;\r\n\t\t\t\t--pitch7-secondary-channel: #C2D848;\r\n\t\t\t\t--pitch7-primary-channel:   #8EA800;\r\n\t\t\t\t--pitch7-secondary-note:    #B0C82D;\r\n\t\t\t\t--pitch7-primary-note:      #6C8000;\r\n\t\t\t\t--pitch8-secondary-channel: #FF90A4;\r\n\t\t\t\t--pitch8-primary-channel:   #E12E4D;\r\n\t\t\t\t--pitch8-secondary-note:    #EC6E85;\r\n\t\t\t\t--pitch8-primary-note:      #A6001D;\r\n\t\t\t\t--pitch9-secondary-channel: #41E3B5;\r\n\t\t\t\t--pitch9-primary-channel:   #00B481;\r\n\t\t\t\t--pitch9-secondary-note:    #28D1A1;\r\n\t\t\t\t--pitch9-primary-note:      #00835E;\r\n\t\t\t\t--pitch10-secondary-channel:#CA77FF;\r\n\t\t\t\t--pitch10-primary-channel:  #9609FF;\r\n\t\t\t\t--pitch10-secondary-note:   #B54FFF;\r\n\t\t\t\t--pitch10-primary-note:     #8400E3;\r\n\t\t\t\t--noise1-secondary-channel: #C1C1C1;\r\n\t\t\t\t--noise1-primary-channel:   #898989;\r\n\t\t\t\t--noise1-secondary-note:    #ADADAD;\r\n\t\t\t\t--noise1-primary-note:      #6C6C6C;\r\n\t\t\t\t--noise2-secondary-channel: #E8BB8C;\r\n\t\t\t\t--noise2-primary-channel:   #BD7D3A;\r\n\t\t\t\t--noise2-secondary-note:    #D1A374;\r\n\t\t\t\t--noise2-primary-note:      #836342;\r\n\t\t\t\t--noise3-secondary-channel: #9BC4EB;\r\n\t\t\t\t--noise3-primary-channel:   #4481BE;\r\n\t\t\t\t--noise3-secondary-note:    #7CA7D3;\r\n\t\t\t\t--noise3-primary-note:      #476685;\r\n\t\t\t\t--noise4-secondary-channel: #C5A5E0;\r\n\t\t\t\t--noise4-primary-channel:   #8553AE;\r\n\t\t\t\t--noise4-secondary-note:    #B290CC;\r\n\t\t\t\t--noise4-primary-note:      #684F7D;\r\n\t\t\t\t--noise5-secondary-channel: #B8CE93;\r\n\t\t\t\t--noise5-primary-channel:   #87A74F;\r\n\t\t\t\t--noise5-secondary-note:    #ABC183;\r\n\t\t\t\t--noise5-primary-note:      #68784C;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t.beepboxEditor button, .beepboxEditor select {\r\n\t\t\t\tbox-shadow: inset 0 0 0 1px var(--secondary-text);\r\n\t\t\t}\r\n\t\t`,\r\n\t\t\"marine\": `\r\n\t\t\t:root {\r\n\t\t\t\t--page-margin: #09070f;\r\n\t\t\t\t--editor-background: #09070f;\r\n\t\t\t\t--hover-preview: #bec2f0;\r\n\t\t\t\t--playhead: #fff;\r\n\t\t\t\t--primary-text: #bec2f0;\r\n\t\t\t\t--secondary-text: #5a5f9d;\r\n\t\t\t\t--inverted-text: #09070f;\r\n\t\t\t\t--text-selection: rgba(156, 118, 255, 0.99);\r\n\t\t\t\t--box-selection-fill: rgba(187, 186, 232, 0.2);\r\n\t\t\t\t--loop-accent: #74f;\r\n\t\t\t\t--link-accent: #98f;\r\n\t\t\t\t--ui-widget-background: #2d3057;\r\n\t\t\t\t--ui-widget-focus: #383c73;\r\n\t\t\t\t--pitch-background: #383b4f;\r\n\t\t\t\t--tonic: #5a44a6;\r\n\t\t\t\t--fifth-note: #88447d;\r\n\t\t\t\t--white-piano-key: #96a1bb;\r\n\t\t\t\t--black-piano-key: #303144;\r\n\t\t\t\t--pitch1-secondary-channel: #117734;\r\n\t\t\t\t--pitch1-primary-channel: #5de88d;\r\n\t\t\t\t--pitch1-secondary-note: #117734;\r\n\t\t\t\t--pitch1-primary-note: #5de88d;\r\n\t\t\t\t--pitch2-secondary-channel: #106b75;\r\n\t\t\t\t--pitch2-primary-channel: #4dc7d5;\r\n\t\t\t\t--pitch2-secondary-note: #106b75;\r\n\t\t\t\t--pitch2-primary-note: #4dc7d5;\r\n\t\t\t\t--pitch3-secondary-channel: #0f1f75;\r\n\t\t\t\t--pitch3-primary-channel: #566dec;\r\n\t\t\t\t--pitch3-secondary-note: #0f1f75;\r\n\t\t\t\t--pitch3-primary-note: #566dec;\r\n\t\t\t\t--pitch4-secondary-channel: #230948;\r\n\t\t\t\t--pitch4-primary-channel: #a07dd2;\r\n\t\t\t\t--pitch4-secondary-note: #230948;\r\n\t\t\t\t--pitch4-primary-note: #a07dd2;\r\n\t\t\t\t--pitch5-secondary-channel: #3e073d;\r\n\t\t\t\t--pitch5-primary-channel: #d944d6;\r\n\t\t\t\t--pitch5-secondary-note: #3e073d;\r\n\t\t\t\t--pitch5-primary-note: #d944d6;\r\n\t\t\t\t--pitch6-secondary-channel: #4f031c;\r\n\t\t\t\t--pitch6-primary-channel: #d73c6f;\r\n\t\t\t\t--pitch6-secondary-note: #4f031c;\r\n\t\t\t\t--pitch6-primary-note: #d73c6f;\r\n\t\t\t\t--pitch7-secondary-channel: #4d1313;\r\n\t\t\t\t--pitch7-primary-channel: #d27373;\r\n\t\t\t\t--pitch7-secondary-note: #4d1313;\r\n\t\t\t\t--pitch7-primary-note: #d27373;\r\n\t\t\t\t--pitch8-secondary-channel: #623a07;\r\n\t\t\t\t--pitch8-primary-channel: #e8af67;\r\n\t\t\t\t--pitch8-secondary-note: #623a07;\r\n\t\t\t\t--pitch8-primary-note: #e8af67;\r\n\t\t\t\t--pitch9-secondary-channel: #4d4805;\r\n\t\t\t\t--pitch9-primary-channel: #eadd33;\r\n\t\t\t\t--pitch9-secondary-note: #4d4805;\r\n\t\t\t\t--pitch9-primary-note: #eadd33;\r\n\t\t\t\t--pitch10-secondary-channel: #134f06;\r\n\t\t\t\t--pitch10-primary-channel: #7fee66;\r\n\t\t\t\t--pitch10-secondary-note: #134f06;\r\n\t\t\t\t--pitch10-primary-note: #7fee66;\r\n\t\t\t\t--noise1-secondary-channel: #3d4c5e;\r\n\t\t\t\t--noise1-primary-channel: #7089a6;\r\n\t\t\t\t--noise1-secondary-note: #3d4c5e;\r\n\t\t\t\t--noise1-primary-note: #7089a6;\r\n\t\t\t\t--noise2-secondary-channel: #2b5127;\r\n\t\t\t\t--noise2-primary-channel: #4c8a44;\r\n\t\t\t\t--noise2-secondary-note: #2b5127;\r\n\t\t\t\t--noise2-primary-note: #4c8a44;\r\n\t\t\t\t--noise3-secondary-channel: #2e4b4f;\r\n\t\t\t\t--noise3-primary-channel: #71a5ac;\r\n\t\t\t\t--noise3-secondary-note: #2e4b4f;\r\n\t\t\t\t--noise3-primary-note: #71a5ac;\r\n\t\t\t\t--noise4-secondary-channel: #1c1b40;\r\n\t\t\t\t--noise4-primary-channel: #6765ae;\r\n\t\t\t\t--noise4-secondary-note: #1c1b40;\r\n\t\t\t\t--noise4-primary-note: #6765ae;\r\n\t\t\t\t--noise5-secondary-channel: #3e1237;\r\n\t\t\t\t--noise5-primary-channel: #bf6cb2;\r\n\t\t\t\t--noise5-secondary-note: #3e1237;\r\n\t\t\t\t--noise5-primary-note: #bf6cb2;\r\n\t\t\t}\r\n\t\t`,\r\n\t\t\"flame\": `\r\n\t\t\t:root {\r\n\t\t\t\t--page-margin: #1a0306;\r\n\t\t\t\t--editor-background: #1a0306;\r\n\t\t\t\t--hover-preview: #dfa4a4;\r\n\t\t\t\t--playhead: white;\r\n\t\t\t\t--primary-text: #f4b1b1;\r\n\t\t\t\t--secondary-text: #a25050;\r\n\t\t\t\t--inverted-text: black;\r\n\t\t\t\t--text-selection: rgba(255, 68, 164, 0.99);\r\n\t\t\t\t--box-selection-fill: rgba(255, 0, 143, 0.2);\r\n\t\t\t\t--loop-accent: #ff44ad;\r\n\t\t\t\t--link-accent: #ff3d85;\r\n\t\t\t\t--ui-widget-background: #640b1b;\r\n\t\t\t\t--ui-widget-focus: #8a1b2f;\r\n\t\t\t\t--pitch-background: #441515;\r\n\t\t\t\t--tonic: #842929;\r\n\t\t\t\t--fifth-note: #771c4f;\r\n\t\t\t\t--white-piano-key: #ffbebe;\r\n\t\t\t\t--black-piano-key: #6a3535;\r\n\t\t\t\t--pitch1-secondary-channel: #391702;\r\n\t\t\t\t--pitch1-primary-channel: #c4794c;\r\n\t\t\t\t--pitch1-secondary-note: #391702;\r\n\t\t\t\t--pitch1-primary-note: #c4794c;\r\n\t\t\t\t--pitch2-secondary-channel: #1f5307;\r\n\t\t\t\t--pitch2-primary-channel: #81b768;\r\n\t\t\t\t--pitch2-secondary-note: #1f5307;\r\n\t\t\t\t--pitch2-primary-note: #81b768;\r\n\t\t\t\t--pitch3-secondary-channel: #01261a;\r\n\t\t\t\t--pitch3-primary-channel: #26bb8b;\r\n\t\t\t\t--pitch3-secondary-note: #01261a;\r\n\t\t\t\t--pitch3-primary-note: #26bb8b;\r\n\t\t\t\t--pitch4-secondary-channel: #051239;\r\n\t\t\t\t--pitch4-primary-channel: #7085c4;\r\n\t\t\t\t--pitch4-secondary-note: #051239;\r\n\t\t\t\t--pitch4-primary-note: #7085c4;\r\n\t\t\t\t--pitch5-secondary-channel: #290442;\r\n\t\t\t\t--pitch5-primary-channel: #894eb0;\r\n\t\t\t\t--pitch5-secondary-note: #290442;\r\n\t\t\t\t--pitch5-primary-note: #894eb0;\r\n\t\t\t\t--pitch6-secondary-channel: #350534;\r\n\t\t\t\t--pitch6-primary-channel: #a811a5;\r\n\t\t\t\t--pitch6-secondary-note: #350534;\r\n\t\t\t\t--pitch6-primary-note: #a811a5;\r\n\t\t\t\t--pitch7-secondary-channel: #46031c;\r\n\t\t\t\t--pitch7-primary-channel: #e84481;\r\n\t\t\t\t--pitch7-secondary-note: #46031c;\r\n\t\t\t\t--pitch7-primary-note: #e84481;\r\n\t\t\t\t--pitch8-secondary-channel: #400;\r\n\t\t\t\t--pitch8-primary-channel: #c45656;\r\n\t\t\t\t--pitch8-secondary-note: #400;\r\n\t\t\t\t--pitch8-primary-note: #c45656;\r\n\t\t\t\t--pitch9-secondary-channel: #2d1f1f;\r\n\t\t\t\t--pitch9-primary-channel: #a47777;\r\n\t\t\t\t--pitch9-secondary-note: #2d1f1f;\r\n\t\t\t\t--pitch9-primary-note: #a47777;\r\n\t\t\t\t--pitch10-secondary-channel: #604017;\r\n\t\t\t\t--pitch10-primary-channel: #e19533;\r\n\t\t\t\t--pitch10-secondary-note: #604017;\r\n\t\t\t\t--pitch10-primary-note: #e19533;\r\n\t\t\t\t--noise1-secondary-channel: #535353;\r\n\t\t\t\t--noise1-primary-channel: #959595;\r\n\t\t\t\t--noise1-secondary-note: #535353;\r\n\t\t\t\t--noise1-primary-note: #959595;\r\n\t\t\t\t--noise2-secondary-channel: #223303;\r\n\t\t\t\t--noise2-primary-channel: #62930a;\r\n\t\t\t\t--noise2-secondary-note: #223303;\r\n\t\t\t\t--noise2-primary-note: #62930a;\r\n\t\t\t\t--noise3-secondary-channel: #01482d;\r\n\t\t\t\t--noise3-primary-channel: #00b36f;\r\n\t\t\t\t--noise3-secondary-note: #01482d;\r\n\t\t\t\t--noise3-primary-note: #00b36f;\r\n\t\t\t\t--noise4-secondary-channel: #001439;\r\n\t\t\t\t--noise4-primary-channel: #0052ea;\r\n\t\t\t\t--noise4-secondary-note: #001439;\r\n\t\t\t\t--noise4-primary-note: #0052ea;\r\n\t\t\t\t--noise5-secondary-channel: #420625;\r\n\t\t\t\t--noise5-primary-channel: #bf1a6f;\r\n\t\t\t\t--noise5-secondary-note: #420625;\r\n\t\t\t\t--noise5-primary-note: #bf1a6f;\r\n\t\t\t}\r\n\t\t`,\r\n\t\t\"amber\": `\r\n\t\t\t:root {\r\n\t\t\t\t--page-margin: #240e04;\r\n\t\t\t\t--editor-background: #240e04;\r\n\t\t\t\t--hover-preview: #dfbc90;\r\n\t\t\t\t--playhead: white;\r\n\t\t\t\t--primary-text: #dfbc90;\r\n\t\t\t\t--secondary-text: #b78a52;\r\n\t\t\t\t--inverted-text: #240e04;\r\n\t\t\t\t--text-selection: rgba(255, 138, 68, 0.99);\r\n\t\t\t\t--box-selection-fill: rgba(255,255,255,0.2);\r\n\t\t\t\t--loop-accent: #ff7944;\r\n\t\t\t\t--link-accent: #ffc588;\r\n\t\t\t\t--ui-widget-background: #4f2113;\r\n\t\t\t\t--ui-widget-focus: #804634;\r\n\t\t\t\t--pitch-background: #482b22;\r\n\t\t\t\t--tonic: #8e4534;\r\n\t\t\t\t--fifth-note: #a26835;\r\n\t\t\t\t--white-piano-key: #eac2b3;\r\n\t\t\t\t--black-piano-key: #4f3329;\r\n\t\t\t\t--pitch1-secondary-channel: #0d1b2d;\r\n\t\t\t\t--pitch1-primary-channel: #3d6293;\r\n\t\t\t\t--pitch1-secondary-note: #20334d;\r\n\t\t\t\t--pitch1-primary-note: #3d6293;\r\n\t\t\t\t--pitch2-secondary-channel: #002821;\r\n\t\t\t\t--pitch2-primary-channel: #2a9d89;\r\n\t\t\t\t--pitch2-secondary-note: #107160;\r\n\t\t\t\t--pitch2-primary-note: #2a9d89;\r\n\t\t\t\t--pitch3-secondary-channel: #1f3906;\r\n\t\t\t\t--pitch3-primary-channel: #7fc140;\r\n\t\t\t\t--pitch3-secondary-note: #4a8413;\r\n\t\t\t\t--pitch3-primary-note: #7fc140;\r\n\t\t\t\t--pitch4-secondary-channel: #391a02;\r\n\t\t\t\t--pitch4-primary-channel: #e38d4a;\r\n\t\t\t\t--pitch4-secondary-note: #664730;\r\n\t\t\t\t--pitch4-primary-note: #e38d4a;\r\n\t\t\t\t--pitch5-secondary-channel: #2f0014;\r\n\t\t\t\t--pitch5-primary-channel: #b01c5b;\r\n\t\t\t\t--pitch5-secondary-note: #6f0e37;\r\n\t\t\t\t--pitch5-primary-note: #b01c5b;\r\n\t\t\t\t--pitch6-secondary-channel: #20002f;\r\n\t\t\t\t--pitch6-primary-channel: #9635c4;\r\n\t\t\t\t--pitch6-secondary-note: #6f1699;\r\n\t\t\t\t--pitch6-primary-note: #9635c4;\r\n\t\t\t\t--pitch7-secondary-channel: #100537;\r\n\t\t\t\t--pitch7-primary-channel: #6243d0;\r\n\t\t\t\t--pitch7-secondary-note: #3d2593;\r\n\t\t\t\t--pitch7-primary-note: #6243d0;\r\n\t\t\t\t--pitch8-secondary-channel: #03132d;\r\n\t\t\t\t--pitch8-primary-channel: #305ca4;\r\n\t\t\t\t--pitch8-secondary-note: #0c3c8a;\r\n\t\t\t\t--pitch8-primary-note: #305ca4;\r\n\t\t\t\t--pitch9-secondary-channel: #001317;\r\n\t\t\t\t--pitch9-primary-channel: #30b3ce;\r\n\t\t\t\t--pitch9-secondary-note: #036d84;\r\n\t\t\t\t--pitch9-primary-note: #30b3ce;\r\n\t\t\t\t--pitch10-secondary-channel: #2b1400;\r\n\t\t\t\t--pitch10-primary-channel: #bb5700;\r\n\t\t\t\t--pitch10-secondary-note: #7b3900;\r\n\t\t\t\t--pitch10-primary-note: #bb5700;\r\n\t\t\t\t--noise1-secondary-channel: #1e1e1e;\r\n\t\t\t\t--noise1-primary-channel: #848484;\r\n\t\t\t\t--noise1-secondary-note: #4a4a4a;\r\n\t\t\t\t--noise1-primary-note: #848484;\r\n\t\t\t\t--noise2-secondary-channel: #072800;\r\n\t\t\t\t--noise2-primary-channel: #1eaa00;\r\n\t\t\t\t--noise2-secondary-note: #147500;\r\n\t\t\t\t--noise2-primary-note: #1eaa00;\r\n\t\t\t\t--noise3-secondary-channel: #260000;\r\n\t\t\t\t--noise3-primary-channel: #ca0000;\r\n\t\t\t\t--noise3-secondary-note: #860000;\r\n\t\t\t\t--noise3-primary-note: #ca0000;\r\n\t\t\t\t--noise4-secondary-channel: #01002f;\r\n\t\t\t\t--noise4-primary-channel: #4a48c6;\r\n\t\t\t\t--noise4-secondary-note: #3c39b5;\r\n\t\t\t\t--noise4-primary-note: #4a48c6;\r\n\t\t\t\t--noise5-secondary-channel: #002616;\r\n\t\t\t\t--noise5-primary-channel: #00c471;\r\n\t\t\t\t--noise5-secondary-note: #00804a;\r\n\t\t\t\t--noise5-primary-note: #00c471;\r\n\t\t\t}\r\n\t\t`,\r\n\t\t\"vermilion\": `\r\n\t\t\t:root {\r\n\t\t\t\t--page-margin: #822219;\r\n\t\t\t\t--editor-background: #822219;\r\n\t\t\t\t--hover-preview: white;\r\n\t\t\t\t--playhead: #FFF;\r\n\t\t\t\t--primary-text: #FFCECA;\r\n\t\t\t\t--secondary-text: #CA7169;\r\n\t\t\t\t--inverted-text: black;\r\n\t\t\t\t--text-selection: rgba(119,68,255,0.99);\r\n\t\t\t\t--box-selection-fill: rgba(142, 138, 79, 0.28);\r\n\t\t\t\t--loop-accent: #ffbf44;\r\n\t\t\t\t--link-accent: #ffe788;\r\n\t\t\t\t--ui-widget-background: #E34234;\r\n\t\t\t\t--ui-widget-focus: #777;\r\n\t\t\t\t--pitch-background: #93332B;\r\n\t\t\t\t--tonic: #A2453E;\r\n\t\t\t\t--fifth-note: #C8372D;\r\n\t\t\t\t--white-piano-key: #FFA29A;\r\n\t\t\t\t--black-piano-key: #7B231B;\r\n\t\t\t\t--pitch1-secondary-channel: #660303;\r\n\t\t\t\t--pitch1-primary-channel: #ff8080;\r\n\t\t\t\t--pitch1-secondary-note: #d75353;\r\n\t\t\t\t--pitch1-primary-note: #f7c0c0;\r\n\t\t\t\t--pitch2-secondary-channel: #9f3400;\r\n\t\t\t\t--pitch2-primary-channel: #ffb693;\r\n\t\t\t\t--pitch2-secondary-note: #e87943;\r\n\t\t\t\t--pitch2-primary-note: #ffb693;\r\n\t\t\t\t--pitch3-secondary-channel: #953b04;\r\n\t\t\t\t--pitch3-primary-channel: #ffd778;\r\n\t\t\t\t--pitch3-secondary-note: #cc9b28;\r\n\t\t\t\t--pitch3-primary-note: #ffd778;\r\n\t\t\t\t--pitch4-secondary-channel: #2c4000;\r\n\t\t\t\t--pitch4-primary-channel: #befd35;\r\n\t\t\t\t--pitch4-secondary-note: #83b90c;\r\n\t\t\t\t--pitch4-primary-note: #befd35;\r\n\t\t\t\t--pitch5-secondary-channel: #00363c;\r\n\t\t\t\t--pitch5-primary-channel: #15e8ff;\r\n\t\t\t\t--pitch5-secondary-note: #209aa8;\r\n\t\t\t\t--pitch5-primary-note: #15e8ff;\r\n\t\t\t\t--pitch6-secondary-channel: #00234f;\r\n\t\t\t\t--pitch6-primary-channel: #3b92ff;\r\n\t\t\t\t--pitch6-secondary-note: #0b56b5;\r\n\t\t\t\t--pitch6-primary-note: #99c6ff;\r\n\t\t\t\t--pitch7-secondary-channel: #08012d;\r\n\t\t\t\t--pitch7-primary-channel: #5335f7;\r\n\t\t\t\t--pitch7-secondary-note: #351faa;\r\n\t\t\t\t--pitch7-primary-note: #5335f7;\r\n\t\t\t\t--pitch8-secondary-channel: #280033;\r\n\t\t\t\t--pitch8-primary-channel: #c800ff;\r\n\t\t\t\t--pitch8-secondary-note: #8500aa;\r\n\t\t\t\t--pitch8-primary-note: #e588ff;\r\n\t\t\t\t--pitch9-secondary-channel: #260020;\r\n\t\t\t\t--pitch9-primary-channel: #df68cc;\r\n\t\t\t\t--pitch9-secondary-note: #bb20a2;\r\n\t\t\t\t--pitch9-primary-note: #ffa2f0;\r\n\t\t\t\t--pitch10-secondary-channel: #370012;\r\n\t\t\t\t--pitch10-primary-channel: #f06593;\r\n\t\t\t\t--pitch10-secondary-note: #c1446d;\r\n\t\t\t\t--pitch10-primary-note: #ffbad1;\r\n\t\t\t\t--noise1-secondary-channel: #2d2d2d;\r\n\t\t\t\t--noise1-primary-channel: #a8a8a8;\r\n\t\t\t\t--noise1-secondary-note: #666;\r\n\t\t\t\t--noise1-primary-note: #a8a8a8;\r\n\t\t\t\t--noise2-secondary-channel: #511a00;\r\n\t\t\t\t--noise2-primary-channel: #f77d44;\r\n\t\t\t\t--noise2-secondary-note: #c66538;\r\n\t\t\t\t--noise2-primary-note: #f77d44;\r\n\t\t\t\t--noise3-secondary-channel: #003517;\r\n\t\t\t\t--noise3-primary-channel: #66ffa9;\r\n\t\t\t\t--noise3-secondary-note: #29c86e;\r\n\t\t\t\t--noise3-primary-note: #66ffa9;\r\n\t\t\t\t--noise4-secondary-channel: #001528;\r\n\t\t\t\t--noise4-primary-channel: #4fa1ec;\r\n\t\t\t\t--noise4-secondary-note: #2674bb;\r\n\t\t\t\t--noise4-primary-note: #4fa1ec;\r\n\t\t\t\t--noise5-secondary-channel: #204;\r\n\t\t\t\t--noise5-primary-channel: #93f;\r\n\t\t\t\t--noise5-secondary-note: #6000bf;\r\n\t\t\t\t--noise5-primary-note: #93f;\r\n\t\t\t}\r\n\t\t`,\r\n\t};\r\n\t\r\n\tpublic static readonly pageMargin: string = \"var(--page-margin)\";\r\n\tpublic static readonly editorBackground: string = \"var(--editor-background)\";\r\n\tpublic static readonly hoverPreview: string = \"var(--hover-preview)\";\r\n\tpublic static readonly playhead: string = \"var(--playhead)\";\r\n\tpublic static readonly primaryText: string = \"var(--primary-text)\";\r\n\tpublic static readonly secondaryText: string = \"var(--secondary-text)\";\r\n\tpublic static readonly invertedText: string = \"var(--inverted-text)\";\r\n\tpublic static readonly textSelection: string = \"var(--text-selection)\";\r\n\tpublic static readonly boxSelectionFill: string = \"var(--box-selection-fill)\";\r\n\tpublic static readonly loopAccent: string = \"var(--loop-accent)\";\r\n\tpublic static readonly linkAccent: string = \"var(--link-accent)\";\r\n\tpublic static readonly uiWidgetBackground: string = \"var(--ui-widget-background)\";\r\n\tpublic static readonly uiWidgetFocus: string = \"var(--ui-widget-focus)\";\r\n\tpublic static readonly pitchBackground: string = \"var(--pitch-background)\";\r\n\tpublic static readonly tonic: string = \"var(--tonic)\";\r\n\tpublic static readonly fifthNote: string = \"var(--fifth-note)\";\r\n\tpublic static readonly whitePianoKey: string = \"var(--white-piano-key)\";\r\n\tpublic static readonly blackPianoKey: string = \"var(--black-piano-key)\";\r\n\t\r\n\tpublic static readonly pitchChannels: DictionaryArray<ChannelColors> = toNameMap([\r\n\t\t{\r\n\t\t\tname: \"pitch1\", // cyan\r\n\t\t\tsecondaryChannel: \"var(--pitch1-secondary-channel)\",\r\n\t\t\tprimaryChannel:   \"var(--pitch1-primary-channel)\",\r\n\t\t\tsecondaryNote:    \"var(--pitch1-secondary-note)\",\r\n\t\t\tprimaryNote:      \"var(--pitch1-primary-note)\",\r\n\t\t}, {\r\n\t\t\tname: \"pitch2\", // yellow\r\n\t\t\tsecondaryChannel: \"var(--pitch2-secondary-channel)\",\r\n\t\t\tprimaryChannel:   \"var(--pitch2-primary-channel)\",\r\n\t\t\tsecondaryNote:    \"var(--pitch2-secondary-note)\",\r\n\t\t\tprimaryNote:      \"var(--pitch2-primary-note)\",\r\n\t\t}, {\r\n\t\t\tname: \"pitch3\", // orange\r\n\t\t\tsecondaryChannel: \"var(--pitch3-secondary-channel)\",\r\n\t\t\tprimaryChannel:   \"var(--pitch3-primary-channel)\",\r\n\t\t\tsecondaryNote:    \"var(--pitch3-secondary-note)\",\r\n\t\t\tprimaryNote:      \"var(--pitch3-primary-note)\",\r\n\t\t}, {\r\n\t\t\tname: \"pitch4\", // green\r\n\t\t\tsecondaryChannel: \"var(--pitch4-secondary-channel)\",\r\n\t\t\tprimaryChannel:   \"var(--pitch4-primary-channel)\",\r\n\t\t\tsecondaryNote:    \"var(--pitch4-secondary-note)\",\r\n\t\t\tprimaryNote:      \"var(--pitch4-primary-note)\",\r\n\t\t}, {\r\n\t\t\tname: \"pitch5\", // magenta\r\n\t\t\tsecondaryChannel: \"var(--pitch5-secondary-channel)\",\r\n\t\t\tprimaryChannel:   \"var(--pitch5-primary-channel)\",\r\n\t\t\tsecondaryNote:    \"var(--pitch5-secondary-note)\",\r\n\t\t\tprimaryNote:      \"var(--pitch5-primary-note)\",\r\n\t\t}, {\r\n\t\t\tname: \"pitch6\", // blue\r\n\t\t\tsecondaryChannel: \"var(--pitch6-secondary-channel)\",\r\n\t\t\tprimaryChannel:   \"var(--pitch6-primary-channel)\",\r\n\t\t\tsecondaryNote:    \"var(--pitch6-secondary-note)\",\r\n\t\t\tprimaryNote:      \"var(--pitch6-primary-note)\",\r\n\t\t}, {\r\n\t\t\tname: \"pitch7\", // olive\r\n\t\t\tsecondaryChannel: \"var(--pitch7-secondary-channel)\",\r\n\t\t\tprimaryChannel:   \"var(--pitch7-primary-channel)\",\r\n\t\t\tsecondaryNote:    \"var(--pitch7-secondary-note)\",\r\n\t\t\tprimaryNote:      \"var(--pitch7-primary-note)\",\r\n\t\t}, {\r\n\t\t\tname: \"pitch8\", // red\r\n\t\t\tsecondaryChannel: \"var(--pitch8-secondary-channel)\",\r\n\t\t\tprimaryChannel:   \"var(--pitch8-primary-channel)\",\r\n\t\t\tsecondaryNote:    \"var(--pitch8-secondary-note)\",\r\n\t\t\tprimaryNote:      \"var(--pitch8-primary-note)\",\r\n\t\t}, {\r\n\t\t\tname: \"pitch9\", // teal\r\n\t\t\tsecondaryChannel: \"var(--pitch9-secondary-channel)\",\r\n\t\t\tprimaryChannel:   \"var(--pitch9-primary-channel)\",\r\n\t\t\tsecondaryNote:    \"var(--pitch9-secondary-note)\",\r\n\t\t\tprimaryNote:      \"var(--pitch9-primary-note)\",\r\n\t\t}, {\r\n\t\t\tname: \"pitch10\", // purple\r\n\t\t\tsecondaryChannel: \"var(--pitch10-secondary-channel)\",\r\n\t\t\tprimaryChannel:   \"var(--pitch10-primary-channel)\",\r\n\t\t\tsecondaryNote:    \"var(--pitch10-secondary-note)\",\r\n\t\t\tprimaryNote:      \"var(--pitch10-primary-note)\",\r\n\t\t},\r\n\t]);\r\n\tpublic static readonly noiseChannels: DictionaryArray<ChannelColors> = toNameMap([\r\n\t\t{\r\n\t\t\tname: \"noise1\", // gray\r\n\t\t\tsecondaryChannel: \"var(--noise1-secondary-channel)\",\r\n\t\t\tprimaryChannel:   \"var(--noise1-primary-channel)\",\r\n\t\t\tsecondaryNote:    \"var(--noise1-secondary-note)\",\r\n\t\t\tprimaryNote:      \"var(--noise1-primary-note)\",\r\n\t\t}, {\r\n\t\t\tname: \"noise2\", // brown\r\n\t\t\tsecondaryChannel: \"var(--noise2-secondary-channel)\",\r\n\t\t\tprimaryChannel:   \"var(--noise2-primary-channel)\",\r\n\t\t\tsecondaryNote:    \"var(--noise2-secondary-note)\",\r\n\t\t\tprimaryNote:      \"var(--noise2-primary-note)\",\r\n\t\t}, {\r\n\t\t\tname: \"noise3\", // azure\r\n\t\t\tsecondaryChannel: \"var(--noise3-secondary-channel)\",\r\n\t\t\tprimaryChannel:   \"var(--noise3-primary-channel)\",\r\n\t\t\tsecondaryNote:    \"var(--noise3-secondary-note)\",\r\n\t\t\tprimaryNote:      \"var(--noise3-primary-note)\",\r\n\t\t}, {\r\n\t\t\tname: \"noise4\", // purple\r\n\t\t\tsecondaryChannel: \"var(--noise4-secondary-channel)\",\r\n\t\t\tprimaryChannel:   \"var(--noise4-primary-channel)\",\r\n\t\t\tsecondaryNote:    \"var(--noise4-secondary-note)\",\r\n\t\t\tprimaryNote:      \"var(--noise4-primary-note)\",\r\n\t\t}, {\r\n\t\t\tname: \"noise5\", // sage\r\n\t\t\tsecondaryChannel: \"var(--noise5-secondary-channel)\",\r\n\t\t\tprimaryChannel:   \"var(--noise5-primary-channel)\",\r\n\t\t\tsecondaryNote:    \"var(--noise5-secondary-note)\",\r\n\t\t\tprimaryNote:      \"var(--noise5-primary-note)\",\r\n\t\t},\r\n\t]);\r\n\t\r\n\tpublic static getChannelColor(song: Song, channel: number): ChannelColors {\r\n\t\treturn channel < song.pitchChannelCount\r\n\t\t\t? ColorConfig.pitchChannels[channel % ColorConfig.pitchChannels.length]\r\n\t\t\t: ColorConfig.noiseChannels[(channel - song.pitchChannelCount) % ColorConfig.noiseChannels.length];\r\n\t}\r\n\t\r\n\tprivate static readonly _styleElement: HTMLStyleElement = document.head.appendChild(HTML.style({type: \"text/css\"}));\r\n\t\r\n\tpublic static setTheme(name: string): void {\r\n\t\tlet theme: string = this.themes[name];\r\n\t\tif (theme == undefined) theme = this.themes[\"dark classic\"];\r\n\t\tthis._styleElement.textContent = theme;\r\n\t\t\r\n\t\tconst themeColor = <HTMLMetaElement> document.querySelector(\"meta[name='theme-color']\");\r\n\t\tif (themeColor != null) {\r\n\t\t\tthemeColor.setAttribute(\"content\", getComputedStyle(document.documentElement).getPropertyValue('--ui-widget-background'));\r\n\t\t}\r\n\t}\r\n}\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nimport {ColorConfig} from \"./ColorConfig\";\r\nimport {HTML} from \"imperative-html/dist/esm/elements-strict\";\r\n\r\n\r\n// Determine if the user's browser/OS adds scrollbars that occupy space.\r\n// See: https://www.filamentgroup.com/lab/scrollbars/\r\nconst scrollBarTest: HTMLDivElement = document.body.appendChild(HTML.div({style: \"width:30px; height:30px; overflow: auto;\"}, \r\n\tHTML.div({style: \"width:100%;height:40px\"}),\r\n));\r\nif ((<any>scrollBarTest).firstChild.clientWidth < 30) {\r\n\tdocument.documentElement.classList.add(\"obtrusive-scrollbars\");\r\n}\r\ndocument.body.removeChild(scrollBarTest);\r\n\r\n\r\ndocument.head.appendChild(HTML.style({type: \"text/css\"}, `\r\n\r\n/* Note: \"#\" symbols need to be encoded as \"%23\" in SVG data urls, otherwise they are interpreted as fragment identifiers! */\r\n:root {\r\n\t--button-size: 26px;\r\n\t--settings-area-width: 192px;\r\n\t--play-symbol: url('data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"26\" height=\"26\" viewBox=\"-13 -13 26 26\"><path d=\"M -5 -8 L -5 8 L 8 0 z\" fill=\"gray\"/></svg>');\r\n\t--pause-symbol: url('data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"26\" height=\"26\" viewBox=\"-13 -13 26 26\"><rect x=\"-5\" y=\"-7\" width=\"4\" height=\"14\" fill=\"gray\"/><rect x=\"3\" y=\"-7\" width=\"4\" height=\"14\" fill=\"gray\"/></svg>');\r\n\t--record-symbol: url('data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"26\" height=\"26\" viewBox=\"-13 -13 26 26\"><circle cx=\"0\" cy=\"0\" r=\"6\" fill=\"gray\"/></svg>');\r\n\t--stop-symbol: url('data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"26\" height=\"26\" viewBox=\"-13 -13 26 26\"><rect x=\"-6\" y=\"-6\" width=\"12\" height=\"12\" fill=\"gray\"/></svg>');\r\n\t--prev-bar-symbol: url('data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"26\" height=\"26\" viewBox=\"-13 -13 26 26\"><rect x=\"-6\" y=\"-6\" width=\"2\" height=\"12\" fill=\"gray\"/><path d=\"M 6 -6 L 6 6 L -3 0 z\" fill=\"gray\"/></svg>');\r\n\t--next-bar-symbol: url('data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"26\" height=\"26\" viewBox=\"-13 -13 26 26\"><rect x=\"4\" y=\"-6\" width=\"2\" height=\"12\" fill=\"gray\"/><path d=\"M -6 -6 L -6 6 L 3 0 z\" fill=\"gray\"/></svg>');\r\n\t--volume-symbol: url('data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"26\" height=\"26\" viewBox=\"0 0 26 26\"><path d=\"M 4 16 L 4 10 L 8 10 L 13 5 L 13 21 L 8 16 z M 15 11 L 16 10 A 7.2 7.2 0 0 1 16 16 L 15 15 A 5.8 5.8 0 0 0 15 12 z M 18 8 L 19 7 A 11.5 11.5 0 0 1 19 19 L 18 18 A 10.1 10.1 0 0 0 18 8 z\" fill=\"gray\"/></svg>');\r\n\t--unmuted-symbol: url('data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"3 3 20 20\"><path d=\"M 4 16 L 4 10 L 8 10 L 13 5 L 13 21 L 8 16 z M 15 11 L 16 10 A 7.2 7.2 0 0 1 16 16 L 15 15 A 5.8 5.8 0 0 0 15 12 z M 18 8 L 19 7 A 11.5 11.5 0 0 1 19 19 L 18 18 A 10.1 10.1 0 0 0 18 8 z\" fill=\"gray\"/></svg>');\r\n\t--muted-symbol: url('data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"3 3 20 20\"><path d=\"M 4 16 L 4 10 L 8 10 L 13 5 L 13 21 L 8 16 z\" fill=\"gray\"/></svg>');\r\n\t--menu-down-symbol: url('data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"26\" height=\"26\" viewBox=\"-13 -13 26 26\"><path d=\"M -4 -2 L 4 -2 L 0 3 z\" fill=\"gray\"/></svg>');\r\n\t--select-arrows-symbol: url('data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"26\" height=\"26\" viewBox=\"-13 -13 26 26\"><path d=\"M -4 -3 L 4 -3 L 0 -8 z M -4 3 L 4 3 L 0 8 z\" fill=\"gray\"/></svg>');\r\n\t--file-page-symbol: url('data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"26\" height=\"26\" viewBox=\"-5 -21 26 26\"><path d=\"M 2 0 L 2 -16 L 10 -16 L 14 -12 L 14 0 z M 3 -1 L 13 -1 L 13 -11 L 9 -11 L 9 -15 L 3 -15 z\" fill=\"gray\"/></svg>');\r\n\t--edit-pencil-symbol: url('data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"26\" height=\"26\" viewBox=\"-5 -21 26 26\"><path d=\"M 0 0 L 1 -4 L 4 -1 z M 2 -5 L 10 -13 L 13 -10 L 5 -2 zM 11 -14 L 13 -16 L 14 -16 L 16 -14 L 16 -13 L 14 -11 z\" fill=\"gray\"/></svg>');\r\n\t--preferences-gear-symbol: url('data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"26\" height=\"26\" viewBox=\"-13 -13 26 26\"><path d=\"M 5.78 -1.6 L 7.93 -0.94 L 7.93 0.94 L 5.78 1.6 L 4.85 3.53 L 5.68 5.61 L 4.21 6.78 L 2.36 5.52 L 0.27 5.99 L -0.85 7.94 L -2.68 7.52 L -2.84 5.28 L -4.52 3.95 L -6.73 4.28 L -7.55 2.59 L -5.9 1.07 L -5.9 -1.07 L -7.55 -2.59 L -6.73 -4.28 L -4.52 -3.95 L -2.84 -5.28 L -2.68 -7.52 L -0.85 -7.94 L 0.27 -5.99 L 2.36 -5.52 L 4.21 -6.78 L 5.68 -5.61 L 4.85 -3.53 M 2.92 0.67 L 2.92 -0.67 L 2.35 -1.87 L 1.3 -2.7 L 0 -3 L -1.3 -2.7 L -2.35 -1.87 L -2.92 -0.67 L -2.92 0.67 L -2.35 1.87 L -1.3 2.7 L -0 3 L 1.3 2.7 L 2.35 1.87 z\" fill=\"gray\"/></svg>');\r\n\t--customize-dial-symbol: url('data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"26\" height=\"26\" viewBox=\"-13 -13 26 26\"> \\\r\n\t\t\t<g transform=\"translate(0,1)\" fill=\"gray\"> \\\r\n\t\t\t\t<circle cx=\"0\" cy=\"0\" r=\"6.5\" stroke=\"gray\" stroke-width=\"1\" fill=\"none\"/> \\\r\n\t\t\t\t<rect x=\"-1\" y=\"-5\" width=\"2\" height=\"4\" transform=\"rotate(30)\"/> \\\r\n\t\t\t\t<circle cx=\"-7.79\" cy=\"4.5\" r=\"0.75\"/> \\\r\n\t\t\t\t<circle cx=\"-9\" cy=\"0\" r=\"0.75\"/> \\\r\n\t\t\t\t<circle cx=\"-7.79\" cy=\"-4.5\" r=\"0.75\"/> \\\r\n\t\t\t\t<circle cx=\"-4.5\" cy=\"-7.79\" r=\"0.75\"/> \\\r\n\t\t\t\t<circle cx=\"0\" cy=\"-9\" r=\"0.75\"/> \\\r\n\t\t\t\t<circle cx=\"4.5\" cy=\"-7.79\" r=\"0.75\"/> \\\r\n\t\t\t\t<circle cx=\"7.79\" cy=\"-4.5\" r=\"0.75\"/> \\\r\n\t\t\t\t<circle cx=\"9\" cy=\"0\" r=\"0.75\"/> \\\r\n\t\t\t\t<circle cx=\"7.79\" cy=\"4.5\" r=\"0.75\"/> \\\r\n\t\t\t</g> \\\r\n\t\t</svg>');\r\n\t--instrument-copy-symbol: url('data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"26\" height=\"26\" viewBox=\"-5 -21 26 26\"><path d=\"M 0 -15 L 1 -15 L 1 0 L 13 0 L 13 1 L 0 1 L 0 -15 z M 2 -1 L 2 -17 L 10 -17 L 14 -13 L 14 -1 z M 3 -2 L 13 -2 L 13 -12 L 9 -12 L 9 -16 L 3 -16 z\" fill=\"currentColor\"></path></svg>');\r\n\t--instrument-paste-symbol: url('data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"26\" height=\"26\" viewBox=\"0 0 26 26\"><path d=\"M 8 18 L 6 18 L 6 5 L 17 5 L 17 7 M 9 8 L 16 8 L 20 12 L 20 22 L 9 22 z\" stroke=\"currentColor\" fill=\"none\"></path><path d=\"M 9 3 L 14 3 L 14 6 L 9 6 L 9 3 z M 16 8 L 20 12 L 16 12 L 16 8 z\" fill=\"currentColor\"></path></svg>');\r\n\t--export-symbol: url('data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"26\" height=\"26\" viewBox=\"-13 -13 26 26\"><path fill=\"gray\" d=\"M -8 3 L -8 8 L 8 8 L 8 3 L 6 3 L 6 6 L -6 6 L -6 3 z M 0 2 L -4 -2 L -1 -2 L -1 -8 L 1 -8 L 1 -2 L 4 -2 z\"/></svg>');\r\n\t--close-symbol: url('data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"26\" height=\"26\" viewBox=\"-13 -13 26 26\"><path fill=\"gray\" d=\"M -7.07 -5.66 L -5.66 -7.07 L 0 -1.4 L 5.66 -7.07 L 7.07 -5.66 L 1.4 0 L 7.07 5.66 L 5.66 7.07 L 0 1.4 L -5.66 7.07 L -7.07 5.66 L -1.4 0 z\"/></svg>');\r\n\t--add-symbol: url('data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"26\" height=\"26\" viewBox=\"-13 -13 26 26\"><path fill=\"gray\" d=\"M -8 -1 L -1 -1 L -1 -8  L 1 -8 L 1 -1 L 8 -1 L 8 1 L 1 1 L 1 8 L -1 8 L -1 1 L -8 1 z\"/></svg>');\r\n\t--zoom-in-symbol: url('data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"-10 -10 20 20\"><circle cx=\"-1\" cy=\"-1\" r=\"6\" stroke-width=\"2\" stroke=\"gray\" fill=\"none\"></circle><path stroke=\"gray\" stroke-width=\"2\" d=\"M 3 3 L 7 7 M -1 -4 L -1 2 M -4 -1 L 2 -1\" fill=\"none\"></path></svg>');\r\n\t--zoom-out-symbol: url('data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"-10 -10 20 20\"><circle cx=\"-1\" cy=\"-1\" r=\"6\" stroke-width=\"2\" stroke=\"gray\" fill=\"none\"></circle><path stroke=\"gray\" stroke-width=\"2\" d=\"M 3 3 L 7 7 M -4 -1 L 2 -1\" fill=\"none\"></path></svg>');\r\n\t--checkmark-symbol: url('data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"26\" height=\"26\" viewBox=\"-13 -13 26 26\"><path fill=\"gray\" d=\"M -9 -2 L -8 -3 L -3 2 L 9 -8 L 10 -7 L -3 8 z\"/></svg>');\r\n\t--drum-symbol: url('data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"32\" height=\"40\" viewBox=\"0 0 32 40\"> \\\r\n\t\t\t<defs> \\\r\n\t\t\t\t<linearGradient id=\"gold1\" x1=\"0%\" y1=\"0%\" x2=\"100%\" y2=\"0%\"> \\\r\n\t\t\t\t\t<stop offset=\"0%\" stop-color=\"%237e3302\"/> \\\r\n\t\t\t\t\t<stop offset=\"40%\" stop-color=\"%23ffec6b\"/> \\\r\n\t\t\t\t\t<stop offset=\"100%\" stop-color=\"%237e3302\"/> \\\r\n\t\t\t\t</linearGradient> \\\r\n\t\t\t\t<linearGradient id=\"gold2\" x1=\"0%\" y1=\"0%\" x2=\"100%\" y2=\"0%\"> \\\r\n\t\t\t\t\t<stop offset=\"0%\" stop-color=\"%23faaf7d\"/> \\\r\n\t\t\t\t\t<stop offset=\"15%\" stop-color=\"%23fffba9\"/> \\\r\n\t\t\t\t\t<stop offset=\"40%\" stop-color=\"%23ffffe3\"/> \\\r\n\t\t\t\t\t<stop offset=\"65%\" stop-color=\"%23fffba9\"/> \\\r\n\t\t\t\t\t<stop offset=\"100%\" stop-color=\"%23faaf7d\"/> \\\r\n\t\t\t\t</linearGradient> \\\r\n\t\t\t\t<radialGradient id=\"gold3\" cx=\"0%\" cy=\"0%\" r=\"100%\"> \\\r\n\t\t\t\t\t<stop offset=\"0%\" stop-color=\"%23ffffe3\"/> \\\r\n\t\t\t\t\t<stop offset=\"50%\" stop-color=\"%23ffec6b\"/> \\\r\n\t\t\t\t\t<stop offset=\"100%\" stop-color=\"%237e3302\"/> \\\r\n\t\t\t\t</radialGradient> \\\r\n\t\t\t\t<linearGradient id=\"red\" x1=\"0%\" y1=\"0%\" x2=\"100%\" y2=\"0%\"> \\\r\n\t\t\t\t\t<stop offset=\"0%\" stop-color=\"%23641919\"/> \\\r\n\t\t\t\t\t<stop offset=\"40%\" stop-color=\"%23cd2c2c\"/> \\\r\n\t\t\t\t\t<stop offset=\"100%\" stop-color=\"%23641919\"/> \\\r\n\t\t\t\t</linearGradient> \\\r\n\t\t\t\t<radialGradient id=\"membrane\"> \\\r\n\t\t\t\t\t<stop offset=\"10%\" stop-color=\"%23cccccc\" /> \\\r\n\t\t\t\t\t<stop offset=\"90%\" stop-color=\"%23f6f6f7\" /> \\\r\n\t\t\t\t\t<stop offset=\"100%\" stop-color=\"%23999\" /> \\\r\n\t\t\t\t</radialGradient> \\\r\n\t\t\t</defs> \\\r\n\t\t\t<ellipse cx=\"16\" cy=\"26\" rx=\"16\" ry=\"14\" fill=\"rgba(0,0,0,0.5)\"/> \\\r\n\t\t\t<ellipse cx=\"16\" cy=\"25\" rx=\"16\" ry=\"14\" fill=\"url(%23gold1)\"/> \\\r\n\t\t\t<rect x=\"0\" y=\"23\" width=\"32\" height=\"2\" fill=\"url(%23gold1)\"/> \\\r\n\t\t\t<ellipse cx=\"16\" cy=\"23\" rx=\"16\" ry=\"14\" fill=\"url(%23gold2)\"/> \\\r\n\t\t\t<ellipse cx=\"16\" cy=\"23\" rx=\"15\" ry=\"13\" fill=\"url(%23red)\"/> \\\r\n\t\t\t<rect x=\"1\" y=\"17\" width=\"30\" height=\"6\" fill=\"url(%23red)\"/> \\\r\n\t\t\t<rect x=\"5\" y=\"27\" width=\"1\" height=\"5\" rx=\"0.5\" fill=\"rgba(0,0,0,0.5)\"/> \\\r\n\t\t\t<rect x=\"15\" y=\"31\" width=\"2\" height=\"5\" rx=\"1\" fill=\"rgba(0,0,0,0.5)\"/> \\\r\n\t\t\t<rect x=\"26\" y=\"27\" width=\"1\" height=\"5\" rx=\"0.5\" fill=\"rgba(0,0,0,0.5)\"/> \\\r\n\t\t\t<rect x=\"5\" y=\"26\" width=\"1\" height=\"5\" rx=\"0.5\" fill=\"url(%23gold3)\"/> \\\r\n\t\t\t<rect x=\"15\" y=\"30\" width=\"2\" height=\"5\" rx=\"1\" fill=\"url(%23gold3)\"/> \\\r\n\t\t\t<rect x=\"26\" y=\"26\" width=\"1\" height=\"5\" rx=\"0.5\" fill=\"url(%23gold3)\"/> \\\r\n\t\t\t<ellipse cx=\"16\" cy=\"18\" rx=\"15\" ry=\"13\" fill=\"rgba(0,0,0,0.5)\"/> \\\r\n\t\t\t<ellipse cx=\"16\" cy=\"16\" rx=\"16\" ry=\"14\" fill=\"url(%23gold1)\"/> \\\r\n\t\t\t<rect x=\"0\" y=\"14\" width=\"32\" height=\"2\" fill=\"url(%23gold1)\"/> \\\r\n\t\t\t<ellipse cx=\"16\" cy=\"14\" rx=\"16\" ry=\"14\" fill=\"url(%23gold2)\"/> \\\r\n\t\t\t<ellipse cx=\"16\" cy=\"14\" rx=\"15\" ry=\"13\" fill=\"url(%23membrane)\"/> \\\r\n\t\t</svg>');\r\n\t--piano-key-symbol: url('data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"32\" height=\"15\" preserveAspectRatio=\"none\" viewBox=\"0 -1 32 15\"> \\\r\n\t\t\t<defs> \\\r\n\t\t\t\t<linearGradient id=\"shadow\" x1=\"0%\" y1=\"0%\" x2=\"100%\" y2=\"0%\"> \\\r\n\t\t\t\t\t<stop offset=\"0%\" stop-color=\"rgba(0,0,0,0.5)\"/> \\\r\n\t\t\t\t\t<stop offset=\"100%\" stop-color=\"transparent\"/> \\\r\n\t\t\t\t</linearGradient> \\\r\n\t\t\t</defs> \\\r\n\t\t\t<rect x=\"-1\" y=\"1\" width=\"31\" height=\"1\" rx=\"0.6\" fill=\"rgba(255,255,255,0.4)\"/> \\\r\n\t\t\t<path d=\"M -1 11 L 30 11 L 30 2 L 33 -1 L 33 14 L -1 14 z\" fill=\"rgba(0,0,0,0.7)\"/> \\\r\n\t\t\t<rect x=\"-1\" y=\"-1\" width=\"19\" height=\"15\" fill=\"url(%23shadow)\"/> \\\r\n\t\t</svg>');\r\n}\r\n\r\n\r\n.obtrusive-scrollbars, .obtrusive-scrollbars * {\r\n\tscrollbar-width: thin;\r\n\tscrollbar-color: ${ColorConfig.uiWidgetBackground} ${ColorConfig.editorBackground};\r\n}\r\n.obtrusive-scrollbars::-webkit-scrollbar, .obtrusive-scrollbars *::-webkit-scrollbar {\r\n\twidth: 12px;\r\n}\r\n.obtrusive-scrollbars::-webkit-scrollbar-track, .obtrusive-scrollbars *::-webkit-scrollbar-track {\r\n\tbackground: ${ColorConfig.editorBackground};\r\n}\r\n.obtrusive-scrollbars::-webkit-scrollbar-thumb, .obtrusive-scrollbars *::-webkit-scrollbar-thumb {\r\n\tbackground-color: ${ColorConfig.uiWidgetBackground};\r\n\tborder: 3px solid ${ColorConfig.editorBackground};\r\n}\r\n\r\n\r\n.beepboxEditor {\r\n\tdisplay: grid;\r\n    grid-template-columns: minmax(0, 1fr) max-content;\r\n    grid-template-rows: max-content 1fr; /* max-content minmax(0, 1fr); Chrome 80 grid layout regression. https://bugs.chromium.org/p/chromium/issues/detail?id=1050307 */\r\n    grid-template-areas: \"pattern-area settings-area\" \"track-area settings-area\";\r\n\tgrid-column-gap: 6px;\r\n\tgrid-row-gap: 6px;\r\n\tposition: relative;\r\n\ttouch-action: manipulation;\r\n\tcursor: default;\r\n\tfont-size: 13px;\r\n\toverflow: hidden;\r\n\tcolor: ${ColorConfig.primaryText};\r\n\tbackground: ${ColorConfig.editorBackground};\r\n}\r\n\r\n.beepboxEditor .noSelection {\r\n\t-webkit-touch-callout: none;\r\n\t-webkit-user-select: none;\r\n\t-moz-user-select: none;\r\n\t-ms-user-select: none;\r\n\tuser-select: none;\r\n}\r\n\r\n.beepboxEditor div {\r\n\tmargin: 0;\r\n\tpadding: 0;\r\n}\r\n\r\n.beepboxEditor .pattern-area {\r\n\tgrid-area: pattern-area;\r\n\theight: 481px;\r\n\tdisplay: flex;\r\n\tflex-direction: row;\r\n\tposition: relative;\r\n}\r\n\r\n.beepboxEditor .track-area {\r\n\tgrid-area: track-area;\r\n}\r\n\r\n.beepboxEditor .loopEditor {\r\n\theight: 20px;\r\n\tposition: sticky;\r\n\tbottom: 0;\r\n\tpadding: 5px 0;\r\n\tbackground-color: ${ColorConfig.editorBackground};\r\n}\r\n\r\n.beepboxEditor .settings-area {\r\n\tgrid-area: settings-area;\r\n\tdisplay: grid;\r\n    grid-template-columns: auto;\r\n    grid-template-rows: min-content min-content min-content min-content min-content;\r\n    grid-template-areas: \"version-area\" \"play-pause-area\" \"menu-area\" \"song-settings-area\" \"instrument-settings-area\";\r\n\tgrid-column-gap: 6px;\r\n}\r\n\r\n.beepboxEditor .version-area{ grid-area: version-area; }\r\n.beepboxEditor .play-pause-area{ grid-area: play-pause-area; }\r\n.beepboxEditor .menu-area{ grid-area: menu-area; }\r\n.beepboxEditor .song-settings-area{ grid-area: song-settings-area; }\r\n.beepboxEditor .instrument-settings-area{ grid-area: instrument-settings-area; }\r\n\r\n.beepboxEditor .tip {\r\n\tcursor: help;\r\n\tcolor: ${ColorConfig.secondaryText};\r\n\ttext-decoration: none;\r\n}\r\n\r\n.beepboxEditor .tip:hover {\r\n\tcolor: ${ColorConfig.linkAccent};\r\n\ttext-decoration: underline;\r\n}\r\n.beepboxEditor .tip:active {\r\n\tcolor: ${ColorConfig.primaryText};\r\n}\r\n\r\n.beepboxEditor .volume-speaker {\r\n\tflex-shrink: 0;\r\n\twidth: var(--button-size);\r\n\theight: var(--button-size);\r\n\tbackground: ${ColorConfig.secondaryText};\r\n\t-webkit-mask-image: var(--volume-symbol);\r\n\t-webkit-mask-repeat: no-repeat;\r\n\t-webkit-mask-position: center;\r\n\tmask-image: var(--volume-symbol);\r\n\tmask-repeat: no-repeat;\r\n\tmask-position: center;\r\n}\r\n\r\n.beepboxEditor .drum-button {\r\n\tflex: 1;\r\n\tbackground-color: transparent;\r\n\tbackground-image: var(--drum-symbol);\r\n\tbackground-repeat: no-repeat;\r\n\tbackground-position: center;\r\n}\r\n\r\n.beepboxEditor .piano-button {\r\n\tflex: 1;\r\n\tposition: relative;\r\n\tdisplay: flex;\r\n\talign-items: center;\r\n}\r\n.beepboxEditor .piano-button::before {\r\n\tcontent: \"\";\r\n\tposition: absolute;\r\n\tleft: 0;\r\n\ttop: 0;\r\n\twidth: 100%;\r\n\theight: 100%;\r\n\tpointer-events: none;\r\n\tbackground-image: var(--piano-key-symbol);\r\n\tbackground-repeat: no-repeat;\r\n\tbackground-position: center;\r\n\tbackground-size: 100% 115.38%;\r\n}\r\n.beepboxEditor .piano-button.disabled::after {\r\n\tcontent: \"\";\r\n\tposition: absolute;\r\n\tright: 0;\r\n\ttop: 0;\r\n\twidth: 70%;\r\n\theight: 100%;\r\n\tpointer-events: none;\r\n\tbackground: ${ColorConfig.editorBackground};\r\n\t-webkit-mask-image: linear-gradient(90deg, transparent 0%, gray 70%, gray 100%);\r\n\t-webkit-mask-repeat: no-repeat;\r\n\t-webkit-mask-position: center;\r\n\tmask-image: linear-gradient(90deg, transparent 0%, gray 70%, gray 100%);\r\n\tmask-repeat: no-repeat;\r\n\tmask-position: center;\r\n}\r\n\r\n.beepboxEditor .piano-button.pressed, .beepboxEditor .drum-button.pressed {\r\n\tfilter: brightness(0.5);\r\n}\r\n\r\n.beepboxEditor .customize-instrument {\r\n\tmargin: 2px 0;\r\n}\r\n.beepboxEditor .customize-instrument::before {\r\n\tcontent: \"\";\r\n\tflex-shrink: 0;\r\n\tposition: absolute;\r\n\tleft: 0;\r\n\ttop: 50%;\r\n\ttransform: translateY(-50%);\r\n\tpointer-events: none;\r\n\twidth: var(--button-size);\r\n\theight: var(--button-size);\r\n\tbackground: currentColor;\r\n\t-webkit-mask-image: var(--customize-dial-symbol);\r\n\t-webkit-mask-repeat: no-repeat;\r\n\t-webkit-mask-position: center;\r\n\tmask-image: var(--customize-dial-symbol);\r\n\tmask-repeat: no-repeat;\r\n\tmask-position: center;\r\n}\r\n\r\n.beepboxEditor .instrumentCopyPasteRow {\r\n\tgap: 2px;\r\n}\r\n\r\n.beepboxEditor .copy-instrument {\r\n\tmargin: 2px 0;\r\n\tflex-grow: 1;\r\n}\r\n.beepboxEditor .copy-instrument::before {\r\n\tcontent: \"\";\r\n\tflex-shrink: 0;\r\n\tposition: absolute;\r\n\tleft: 0;\r\n\ttop: 50%;\r\n\ttransform: translateY(-50%);\r\n\tpointer-events: none;\r\n\twidth: var(--button-size);\r\n\theight: var(--button-size);\r\n\tbackground: currentColor;\r\n\t-webkit-mask-image: var(--instrument-copy-symbol);\r\n\t-webkit-mask-repeat: no-repeat;\r\n\t-webkit-mask-position: center;\r\n\tmask-image: var(--instrument-copy-symbol);\r\n\tmask-repeat: no-repeat;\r\n\tmask-position: center;\r\n}\r\n\r\n.beepboxEditor .paste-instrument {\r\n\tmargin: 2px 0;\r\n\tflex-grow: 1;\r\n}\r\n.beepboxEditor .paste-instrument::before {\r\n\tcontent: \"\";\r\n\tflex-shrink: 0;\r\n\tposition: absolute;\r\n\tleft: 0;\r\n\ttop: 50%;\r\n\ttransform: translateY(-50%);\r\n\tpointer-events: none;\r\n\twidth: var(--button-size);\r\n\theight: var(--button-size);\r\n\tbackground: currentColor;\r\n\t-webkit-mask-image: var(--instrument-paste-symbol);\r\n\t-webkit-mask-repeat: no-repeat;\r\n\t-webkit-mask-position: center;\r\n\tmask-image: var(--instrument-paste-symbol);\r\n\tmask-repeat: no-repeat;\r\n\tmask-position: center;\r\n}\r\n\r\n.beepboxEditor .envelopeEditor {\r\n\tdisplay: flex;\r\n\tflex-direction: column;\r\n}\r\n\r\n.beepboxEditor .envelope-row {\r\n\tdisplay: flex;\r\n\tmargin: 2px 0;\r\n\tgap: 2px;\r\n}\r\n\r\n.beepboxEditor .add-envelope {\r\n\twidth: var(--button-size);\r\n}\r\n.beepboxEditor .add-envelope::before {\r\n\tcontent: \"\";\r\n\tposition: absolute;\r\n\twidth: var(--button-size);\r\n\theight: var(--button-size);\r\n\tleft: 0;\r\n\ttop: 0;\r\n\tpointer-events: none;\r\n\tbackground: currentColor;\r\n\tmask-image: var(--add-symbol);\r\n\tmask-repeat: no-repeat;\r\n\tmask-position: center;\r\n\t-webkit-mask-image: var(--add-symbol);\r\n\t-webkit-mask-repeat: no-repeat;\r\n\t-webkit-mask-position: center;\r\n}\r\n.beepboxEditor .add-envelope:disabled {\r\n\tvisibility: hidden;\r\n}\r\n\r\n.beepboxEditor .effects-menu {\r\n\twidth: var(--button-size);\r\n\tposition: relative;\r\n}\r\n.beepboxEditor .effects-menu::before {\r\n\tcontent: \"\";\r\n\tposition: absolute;\r\n\twidth: var(--button-size);\r\n\theight: var(--button-size);\r\n\tleft: 0;\r\n\ttop: 0;\r\n\tpointer-events: none;\r\n\tbackground: currentColor;\r\n\tmask-image: var(--menu-down-symbol);\r\n\tmask-repeat: no-repeat;\r\n\tmask-position: center;\r\n\t-webkit-mask-image: var(--menu-down-symbol);\r\n\t-webkit-mask-repeat: no-repeat;\r\n\t-webkit-mask-position: center;\r\n}\r\n\r\n.beepboxEditor .zoomInButton, .beepboxEditor .zoomOutButton {\r\n\twidth: var(--button-size);\r\n\tposition: absolute;\r\n\tright: 10px;\r\n}\r\n.beepboxEditor .zoomInButton {\r\n\ttop: 10px;\r\n}\r\n.beepboxEditor .zoomOutButton {\r\n\ttop: 50px;\r\n}\r\n.beepboxEditor .zoomInButton::before {\r\n\tcontent: \"\";\r\n\tposition: absolute;\r\n\twidth: var(--button-size);\r\n\theight: var(--button-size);\r\n\tleft: 0;\r\n\ttop: 0;\r\n\tpointer-events: none;\r\n\tbackground: currentColor;\r\n\tmask-image: var(--zoom-in-symbol);\r\n\tmask-repeat: no-repeat;\r\n\tmask-position: center;\r\n\t-webkit-mask-image: var(--zoom-in-symbol);\r\n\t-webkit-mask-repeat: no-repeat;\r\n\t-webkit-mask-position: center;\r\n}\r\n.beepboxEditor .zoomOutButton::before {\r\n\tcontent: \"\";\r\n\tposition: absolute;\r\n\twidth: var(--button-size);\r\n\theight: var(--button-size);\r\n\tleft: 0;\r\n\ttop: 0;\r\n\tpointer-events: none;\r\n\tbackground: currentColor;\r\n\tmask-image: var(--zoom-out-symbol);\r\n\tmask-repeat: no-repeat;\r\n\tmask-position: center;\r\n\t-webkit-mask-image: var(--zoom-out-symbol);\r\n\t-webkit-mask-repeat: no-repeat;\r\n\t-webkit-mask-position: center;\r\n}\r\n\r\n.beepboxEditor .delete-envelope {\r\n\twidth: var(--button-size);\r\n\tflex-shrink: 0;\r\n\tflex-grow: 0;\r\n}\r\n.beepboxEditor .delete-envelope::before {\r\n\tcontent: \"\";\r\n\tposition: absolute;\r\n\twidth: var(--button-size);\r\n\theight: var(--button-size);\r\n\tleft: 0;\r\n\ttop: 0;\r\n\tpointer-events: none;\r\n\tbackground: currentColor;\r\n\tmask-image: var(--close-symbol);\r\n\tmask-repeat: no-repeat;\r\n\tmask-position: center;\r\n\t-webkit-mask-image: var(--close-symbol);\r\n\t-webkit-mask-repeat: no-repeat;\r\n\t-webkit-mask-position: center;\r\n}\r\n.beepboxEditor .delete-envelope:disabled {\r\n\tvisibility: hidden;\r\n}\r\n\r\n.beepboxEditor .menu.file::before {\r\n\tcontent: \"\";\r\n\tflex-shrink: 0;\r\n\tposition: absolute;\r\n\tleft: 0;\r\n\ttop: 50%;\r\n\ttransform: translateY(-50%);\r\n\tpointer-events: none;\r\n\twidth: var(--button-size);\r\n\theight: var(--button-size);\r\n\tbackground: currentColor;\r\n\t-webkit-mask-image: var(--file-page-symbol);\r\n\t-webkit-mask-repeat: no-repeat;\r\n\t-webkit-mask-position: center;\r\n\tmask-image: var(--file-page-symbol);\r\n\tmask-repeat: no-repeat;\r\n\tmask-position: center;\r\n}\r\n\r\n.beepboxEditor .menu.edit::before {\r\n\tcontent: \"\";\r\n\tflex-shrink: 0;\r\n\tposition: absolute;\r\n\tleft: 0;\r\n\ttop: 50%;\r\n\ttransform: translateY(-50%);\r\n\tpointer-events: none;\r\n\twidth: var(--button-size);\r\n\theight: var(--button-size);\r\n\tbackground: currentColor;\r\n\t-webkit-mask-image: var(--edit-pencil-symbol);\r\n\t-webkit-mask-repeat: no-repeat;\r\n\t-webkit-mask-position: center;\r\n\tmask-image: var(--edit-pencil-symbol);\r\n\tmask-repeat: no-repeat;\r\n\tmask-position: center;\r\n}\r\n\r\n.beepboxEditor .menu.preferences::before {\r\n\tcontent: \"\";\r\n\tflex-shrink: 0;\r\n\tposition: absolute;\r\n\tleft: 0;\r\n\ttop: 50%;\r\n\ttransform: translateY(-50%);\r\n\tpointer-events: none;\r\n\twidth: var(--button-size);\r\n\theight: var(--button-size);\r\n\tbackground: currentColor;\r\n\t-webkit-mask-image: var(--preferences-gear-symbol);\r\n\t-webkit-mask-repeat: no-repeat;\r\n\t-webkit-mask-position: center;\r\n\tmask-image: var(--preferences-gear-symbol);\r\n\tmask-repeat: no-repeat;\r\n\tmask-position: center;\r\n}\r\n\r\n.beepboxEditor .mute-button::before {\r\n\tcontent: \"\";\r\n\tpointer-events: none;\r\n\twidth: 100%;\r\n\theight: 100%;\r\n\tbackground: ${ColorConfig.primaryText};\r\n\tdisplay: inline-block;\r\n\t-webkit-mask-image: var(--unmuted-symbol);\r\n\t-webkit-mask-repeat: no-repeat;\r\n\t-webkit-mask-position: center;\r\n\t-webkit-mask-size: contain;\r\n\tmask-image: var(--unmuted-symbol);\r\n\tmask-repeat: no-repeat;\r\n\tmask-position: center;\r\n\tmask-size: contain;\r\n}\r\n\r\n.beepboxEditor .mute-button.muted::before {\r\n\tbackground: ${ColorConfig.editorBackground};\r\n\t-webkit-mask-image: var(--muted-symbol);\r\n\tmask-image: var(--muted-symbol);\r\n}\r\n\r\n.beepboxEditor .promptContainer {\r\n\tposition: absolute;\r\n\ttop: 0;\r\n\tleft: 0;\r\n\twidth: 100%;\r\n\theight: 100%;\r\n\tdisplay: flex;\r\n\tjustify-content: center;\r\n\talign-items: center;\r\n\tz-index: 100;\r\n}\r\n\r\n.beepboxEditor .promptContainer::before {\r\n\tcontent: \"\";\r\n\tposition: absolute;\r\n\ttop: 0;\r\n\tleft: 0;\r\n\twidth: 100%;\r\n\theight: 100%;\r\n\tbackground: ${ColorConfig.editorBackground};\r\n\topacity: 0.5;\r\n\tdisplay: flex;\r\n}\r\n\r\n.beepboxEditor .prompt {\r\n\tmargin: auto;\r\n\ttext-align: center;\r\n\tbackground: ${ColorConfig.editorBackground};\r\n\tborder-radius: 15px;\r\n\tborder: 4px solid ${ColorConfig.uiWidgetBackground};\r\n\tcolor: ${ColorConfig.primaryText};\r\n\tpadding: 20px;\r\n\tdisplay: flex;\r\n\tflex-direction: column;\r\n\tposition: relative;\r\n\tbox-shadow: 5px 5px 20px 10px rgba(0,0,0,0.5);\r\n}\r\n\r\n.beepboxEditor .prompt > *:not(:first-child):not(.cancelButton) {\r\n\tmargin-top: 1.5em;\r\n}\r\n\r\n.beepboxEditor .prompt h2 {\r\n\tfont-size: 2em;\r\n\tmargin: 0 16px;\r\n\tfont-weight: normal;\r\n}\r\n\r\n.beepboxEditor .prompt p {\r\n\ttext-align: left;\r\n\tmargin: 1em 0;\r\n}\r\n\r\n.beepboxEditor .prompt label {\r\n\tcursor: pointer;\r\n}\r\n\r\n.beepboxEditor .prompt.recordingSetupPrompt p {\r\n\tmargin-top: 0.75em;\r\n\tmargin-bottom: 0;\r\n}\r\n\r\n.beepboxEditor .prompt.recordingSetupPrompt > label:not(:first-child):not(.cancelButton) {\r\n\tmargin: 2px 0;\r\n}\r\n\r\n.beepboxEditor .layout-option {\r\n\tdisplay: flex;\r\n\tflex-direction: column;\r\n\tflex: 1;\r\n\tcursor: pointer;\r\n\tcolor: ${ColorConfig.secondaryText};\r\n}\r\n\r\n.beepboxEditor .layout-option input {\r\n\tdisplay: none;\r\n}\r\n\r\n.beepboxEditor .layout-option input:checked ~ * {\r\n\tcolor: ${ColorConfig.primaryText};\r\n}\r\n\r\n.beepboxEditor .selectContainer {\r\n\tposition: relative;\r\n}\r\n.beepboxEditor .selectContainer:not(.menu)::after {\r\n\tcontent: \"\";\r\n\tflex-shrink: 0;\r\n\tposition: absolute;\r\n\tright: 0;\r\n\ttop: 50%;\r\n\ttransform: translateY(-50%);\r\n\tpointer-events: none;\r\n\twidth: 14px;\r\n\theight: var(--button-size);\r\n\tbackground: currentColor;\r\n\t-webkit-mask-image: var(--select-arrows-symbol);\r\n\t-webkit-mask-repeat: no-repeat;\r\n\t-webkit-mask-position: center;\r\n\tmask-image: var(--select-arrows-symbol);\r\n\tmask-repeat: no-repeat;\r\n\tmask-position: center;\r\n}\r\n.beepboxEditor .selectContainer.menu::after {\r\n\tcontent: \"\";\r\n\tflex-shrink: 0;\r\n\tposition: absolute;\r\n\tright: 0;\r\n\ttop: 50%;\r\n\ttransform: translateY(-50%);\r\n\tpointer-events: none;\r\n\twidth: var(--button-size);\r\n\theight: var(--button-size);\r\n\tbackground: currentColor;\r\n\t-webkit-mask-image: var(--menu-down-symbol);\r\n\t-webkit-mask-repeat: no-repeat;\r\n\t-webkit-mask-position: center;\r\n\tmask-image: var(--menu-down-symbol);\r\n\tmask-repeat: no-repeat;\r\n\tmask-position: center;\r\n}\r\n.beepboxEditor select {\r\n\tmargin: 0;\r\n\tpadding: 0 4px;\r\n\tdisplay: block;\r\n\theight: var(--button-size);\r\n\tborder: none;\r\n\tborder-radius: 5px;\r\n\tbackground: ${ColorConfig.uiWidgetBackground};\r\n\tcolor: inherit;\r\n\tfont-size: inherit;\r\n\tcursor: pointer;\r\n\tfont-family: inherit;\r\n\tfont-weight: inherit;\r\n\r\n\t-webkit-appearance:none;\r\n\t-moz-appearance: none;\r\n\tappearance: none;\r\n}\r\n.beepboxEditor .menu select {\r\n\tpadding: 0 var(--button-size);\r\n}\r\n.beepboxEditor select:focus {\r\n\tbackground: ${ColorConfig.uiWidgetFocus};\r\n\toutline: none;\r\n}\r\n.beepboxEditor .menu select {\r\n\ttext-align: center;\r\n\ttext-align-last: center;\r\n}\r\n.beepboxEditor .settings-area select {\r\n       width: 100%;\r\n}\r\n\r\n/* This makes it look better in firefox on my computer... What about others?\r\n@-moz-document url-prefix() {\r\n\t.beepboxEditor select { padding: 0 2px; }\r\n}\r\n*/\r\n.beepboxEditor button {\r\n\tmargin: 0;\r\n\tposition: relative;\r\n\theight: var(--button-size);\r\n\tborder: none;\r\n\tborder-radius: 5px;\r\n\tbackground: ${ColorConfig.uiWidgetBackground};\r\n\tcolor: inherit;\r\n\tfont-size: inherit;\r\n\tfont-family: inherit;\r\n\tfont-weight: inherit;\r\n\tcursor: pointer;\r\n}\r\n.beepboxEditor button:focus {\r\n\tbackground: ${ColorConfig.uiWidgetFocus};\r\n\toutline: none;\r\n}\r\n\r\n.beepboxEditor button.cancelButton {\r\n\tfloat: right;\r\n\twidth: var(--button-size);\r\n\tposition: absolute;\r\n\ttop: 8px;\r\n\tright: 8px;\r\n}\r\n\r\n.beepboxEditor .playback-bar-controls {\r\n\tdisplay: grid;\r\n\tgrid-template-columns: minmax(0, 1fr) minmax(0, 1fr) minmax(0, 1fr) minmax(0, 1fr);\r\n\tgrid-template-rows: min-content;\r\n\tgrid-column-gap: 4px;\r\n}\r\n\r\n.beepboxEditor button.playButton::before {\r\n\tcontent: \"\";\r\n\tflex-shrink: 0;\r\n\tposition: absolute;\r\n\tleft: 0;\r\n\ttop: 50%;\r\n\ttransform: translateY(-50%);\r\n\tpointer-events: none;\r\n\twidth: var(--button-size);\r\n\theight: var(--button-size);\r\n\tbackground: currentColor;\r\n\t-webkit-mask-image: var(--play-symbol);\r\n\t-webkit-mask-repeat: no-repeat;\r\n\t-webkit-mask-position: center;\r\n\tmask-image: var(--play-symbol);\r\n\tmask-repeat: no-repeat;\r\n\tmask-position: center;\r\n}\r\n.beepboxEditor button.pauseButton::before {\r\n\tcontent: \"\";\r\n\tflex-shrink: 0;\r\n\tposition: absolute;\r\n\tleft: 0;\r\n\ttop: 50%;\r\n\ttransform: translateY(-50%);\r\n\tpointer-events: none;\r\n\twidth: var(--button-size);\r\n\theight: var(--button-size);\r\n\tbackground: currentColor;\r\n\t-webkit-mask-image: var(--pause-symbol);\r\n\t-webkit-mask-repeat: no-repeat;\r\n\t-webkit-mask-position: center;\r\n\tmask-image: var(--pause-symbol);\r\n\tmask-repeat: no-repeat;\r\n\tmask-position: center;\r\n}\r\n.beepboxEditor button.recordButton::before {\r\n\tcontent: \"\";\r\n\tflex-shrink: 0;\r\n\tposition: absolute;\r\n\tleft: 0;\r\n\ttop: 50%;\r\n\ttransform: translateY(-50%);\r\n\tpointer-events: none;\r\n\twidth: var(--button-size);\r\n\theight: var(--button-size);\r\n\tbackground: currentColor;\r\n\t-webkit-mask-image: var(--record-symbol);\r\n\t-webkit-mask-repeat: no-repeat;\r\n\t-webkit-mask-position: center;\r\n\tmask-image: var(--record-symbol);\r\n\tmask-repeat: no-repeat;\r\n\tmask-position: center;\r\n}\r\n.beepboxEditor button.stopButton::before {\r\n\tcontent: \"\";\r\n\tflex-shrink: 0;\r\n\tposition: absolute;\r\n\tleft: 0;\r\n\ttop: 50%;\r\n\ttransform: translateY(-50%);\r\n\tpointer-events: none;\r\n\twidth: var(--button-size);\r\n\theight: var(--button-size);\r\n\tbackground: currentColor;\r\n\t-webkit-mask-image: var(--stop-symbol);\r\n\t-webkit-mask-repeat: no-repeat;\r\n\t-webkit-mask-position: center;\r\n\tmask-image: var(--stop-symbol);\r\n\tmask-repeat: no-repeat;\r\n\tmask-position: center;\r\n}\r\n\r\n.beepboxEditor button.prevBarButton::before {\r\n\tcontent: \"\";\r\n\tflex-shrink: 0;\r\n\tposition: absolute;\r\n\tleft: 50%;\r\n\ttop: 50%;\r\n\ttransform: translate(-50%, -50%);\r\n\tpointer-events: none;\r\n\twidth: var(--button-size);\r\n\theight: var(--button-size);\r\n\tbackground: currentColor;\r\n\t-webkit-mask-image: var(--prev-bar-symbol);\r\n\t-webkit-mask-repeat: no-repeat;\r\n\t-webkit-mask-position: center;\r\n\tmask-image: var(--prev-bar-symbol);\r\n\tmask-repeat: no-repeat;\r\n\tmask-position: center;\r\n}\r\n\r\n.beepboxEditor button.nextBarButton::before {\r\n\tcontent: \"\";\r\n\tflex-shrink: 0;\r\n\tposition: absolute;\r\n\tleft: 50%;\r\n\ttop: 50%;\r\n\ttransform: translate(-50%, -50%);\r\n\tpointer-events: none;\r\n\twidth: var(--button-size);\r\n\theight: var(--button-size);\r\n\tbackground: currentColor;\r\n\t-webkit-mask-image: var(--next-bar-symbol);\r\n\t-webkit-mask-repeat: no-repeat;\r\n\t-webkit-mask-position: center;\r\n\tmask-image: var(--next-bar-symbol);\r\n\tmask-repeat: no-repeat;\r\n\tmask-position: center;\r\n}\r\n\r\n.beepboxEditor button.playButton, .beepboxEditor button.pauseButton, .beepboxEditor button.recordButton, .beepboxEditor button.stopButton, .beepboxEditor button.okayButton, .beepboxEditor button.exportButton {\r\n\tpadding-left: var(--button-size);\r\n}\r\n.beepboxEditor button.playButton, .beepboxEditor button.pauseButton, .beepboxEditor button.recordButton {\r\n\tgrid-column-start: 1;\r\n\tgrid-column-end: 3;\r\n}\r\n.beepboxEditor button.stopButton {\r\n\tgrid-column-start: 1;\r\n\tgrid-column-end: 5;\r\n}\r\n.beepboxEditor button.prevBarButton {\r\n\tgrid-column-start: 3;\r\n\tgrid-column-end: 4;\r\n}\r\n.beepboxEditor button.nextBarButton {\r\n\tgrid-column-start: 4;\r\n\tgrid-column-end: 5;\r\n}\r\n\r\n.beepboxEditor button.playButton.shrunk, .beepboxEditor button.recordButton.shrunk {\r\n\tpadding: 0;\r\n}\r\n.beepboxEditor button.playButton.shrunk::before, .beepboxEditor button.recordButton.shrunk::before {\r\n\tleft: 50%;\r\n\ttop: 50%;\r\n\ttransform: translate(-50%, -50%);\r\n}\r\n.beepboxEditor button.playButton.shrunk span, .beepboxEditor button.recordButton.shrunk span {\r\n\tdisplay: none;\r\n}\r\n.beepboxEditor button.playButton.shrunk {\r\n\tgrid-column-start: 1;\r\n\tgrid-column-end: 2;\r\n}\r\n.beepboxEditor button.recordButton.shrunk {\r\n\tgrid-column-start: 2;\r\n\tgrid-column-end: 3;\r\n}\r\n\r\n.beepboxEditor button.cancelButton::before {\r\n\tcontent: \"\";\r\n\tposition: absolute;\r\n\twidth: var(--button-size);\r\n\theight: var(--button-size);\r\n\tleft: 0;\r\n\ttop: 0;\r\n\tpointer-events: none;\r\n\tbackground: currentColor;\r\n\tmask-image: var(--close-symbol);\r\n\tmask-repeat: no-repeat;\r\n\tmask-position: center;\r\n\t-webkit-mask-image: var(--close-symbol);\r\n\t-webkit-mask-repeat: no-repeat;\r\n\t-webkit-mask-position: center;\r\n}\r\n\r\n.beepboxEditor button.okayButton::before {\r\n\tcontent: \"\";\r\n\tposition: absolute;\r\n\twidth: var(--button-size);\r\n\theight: var(--button-size);\r\n\tleft: 0;\r\n\ttop: 0;\r\n\tpointer-events: none;\r\n\tbackground: currentColor;\r\n\t-webkit-mask-image: var(--checkmark-symbol);\r\n\t-webkit-mask-repeat: no-repeat;\r\n\t-webkit-mask-position: center;\r\n\tmask-image: var(--checkmark-symbol);\r\n\tmask-repeat: no-repeat;\r\n\tmask-position: center;\r\n}\r\n\r\n.beepboxEditor button.exportButton::before {\r\n\tcontent: \"\";\r\n\tposition: absolute;\r\n\twidth: var(--button-size);\r\n\theight: var(--button-size);\r\n\tleft: 0;\r\n\ttop: 0;\r\n\tpointer-events: none;\r\n\tbackground: currentColor;\r\n\tmask-image: var(--export-symbol);\r\n\tmask-repeat: no-repeat;\r\n\tmask-position: center;\r\n\t-webkit-mask-image: var(--export-symbol);\r\n\t-webkit-mask-repeat: no-repeat;\r\n\t-webkit-mask-position: center;\r\n}\r\n\r\n.beepboxEditor .instrument-bar {\r\n\tdisplay: flex;\r\n\tgap: 2px;\r\n}\r\n\r\n.beepboxEditor .instrument-bar button {\r\n\tflex-grow: 1;\r\n\tmin-width: 0;\r\n\tpadding: 0;\r\n\tflex-basis: 0;\r\n\tdisplay: flex;\r\n\talign-items: center;\r\n\tjustify-content: center;\r\n\tcolor: var(--text-color-lit);\r\n}\r\n\r\n.beepboxEditor .instrument-bar .remove-instrument, .beepboxEditor .instrument-bar .add-instrument {\r\n\tmax-width: var(--button-size);\r\n}\r\n\r\n.beepboxEditor .instrument-bar > :not(:first-child) {\r\n\tborder-top-left-radius: 0;\r\n\tborder-bottom-left-radius: 0;\r\n}\r\n\r\n.beepboxEditor .instrument-bar > :not(.last-button) {\r\n\tborder-top-right-radius: 0;\r\n\tborder-bottom-right-radius: 0;\r\n}\r\n\r\n.beepboxEditor .instrument-bar .selected-instrument {\r\n\tbackground: var(--background-color-lit);\r\n\tcolor: ${ColorConfig.invertedText};\r\n}\r\n\r\n.beepboxEditor .instrument-bar .deactivated {\r\n\tbackground: ${ColorConfig.editorBackground};\r\n\tcolor: var(--text-color-dim);\r\n}\r\n\r\n.beepboxEditor .instrument-bar .deactivated.selected-instrument {\r\n\tbackground: var(--background-color-dim);\r\n\tcolor: ${ColorConfig.invertedText};\r\n}\r\n\r\n.beepboxEditor .instrument-bar .remove-instrument::before {\r\n\tcontent: \"\";\r\n\tposition: absolute;\r\n\twidth: 100%;\r\n\theight: var(--button-size);\r\n\tleft: 0;\r\n\ttop: 0;\r\n\tpointer-events: none;\r\n\tbackground: currentColor;\r\n\tmask-image: var(--close-symbol);\r\n\tmask-repeat: no-repeat;\r\n\tmask-position: center;\r\n\t-webkit-mask-image: var(--close-symbol);\r\n\t-webkit-mask-repeat: no-repeat;\r\n\t-webkit-mask-position: center;\r\n}\r\n\r\n.beepboxEditor .instrument-bar .add-instrument::before {\r\n\tcontent: \"\";\r\n\tposition: absolute;\r\n\twidth: 100%;\r\n\theight: var(--button-size);\r\n\tleft: 0;\r\n\ttop: 0;\r\n\tpointer-events: none;\r\n\tbackground: currentColor;\r\n\tmask-image: var(--add-symbol);\r\n\tmask-repeat: no-repeat;\r\n\tmask-position: center;\r\n\t-webkit-mask-image: var(--add-symbol);\r\n\t-webkit-mask-repeat: no-repeat;\r\n\t-webkit-mask-position: center;\r\n}\r\n\r\n.beepboxEditor canvas {\r\n\toverflow: hidden;\r\n\tposition: absolute;\r\n\tdisplay: block;\r\n}\r\n\r\n.beepboxEditor .trackContainer {\r\n\tflex-grow: 1;\r\n}\r\n\r\n.beepboxEditor .trackAndMuteContainer {\r\n\tdisplay: flex;\r\n\talign-items: flex-start;\r\n\twidth: 100%;\r\n\tmin-height: 0;\r\n\tflex: 1;\r\n\toverflow-x: hidden;\r\n\tposition: relative;\r\n}\r\n\r\n.beepboxEditor .channelRow {\r\n\tdisplay: flex;\r\n}\r\n\r\n.beepboxEditor .channelBox {\r\n\tdisplay: flex;\r\n\ttext-align: center;\r\n\talign-items: center;\r\n\tjustify-content: center;\r\n\tbox-sizing: border-box;\r\n\tpadding-top: 1px;\r\n}\r\n\r\n.beepboxEditor .channelBoxLabel {\r\n\tfont-size: 20px;\r\n\tfont-family: sans-serif;\r\n\tfont-weight: bold;\r\n}\r\n\r\n.beepboxEditor .muteEditor {\r\n\twidth: 32px;\r\n\tflex-shrink: 0;\r\n\tdisplay: flex;\r\n\tflex-direction: column;\r\n\talign-items: stretch;\r\n\tposition: sticky;\r\n\tleft: 0;\r\n\tz-index: 1;\r\n\tbackground: ${ColorConfig.editorBackground};\r\n}\r\n\r\n.beepboxEditor .selectRow, .beepboxEditor .instrumentCopyPasteRow {\r\n\tmargin: 2px 0;\r\n\theight: var(--button-size);\r\n\tdisplay: flex;\r\n\tflex-direction: row;\r\n\talign-items: center;\r\n\tjustify-content: space-between;\r\n}\r\n\r\n.beepboxEditor .selectRow > :last-child {\r\n\twidth: 62.5%;\r\n\tflex-shrink: 0;\r\n}\r\n\r\n.beepboxEditor .menu-area {\r\n\tdisplay: flex;\r\n\tflex-direction: column;\r\n}\r\n.beepboxEditor .menu-area > * {\r\n\tmargin: 2px 0;\r\n}\r\n.beepboxEditor .menu-area > button {\r\n\tpadding: 0 var(--button-size);\r\n\twhite-space: nowrap;\r\n}\r\n\r\n.beepboxEditor .song-settings-area {\r\n\tdisplay: flex;\r\n\tflex-direction: column;\r\n}\r\n\r\n.beepboxEditor .editor-controls {\r\n\tflex-shrink: 0;\r\n\tdisplay: flex;\r\n\tflex-direction: column;\r\n}\r\n\r\n.beepboxEditor .instrument-settings-area {\r\n\tdisplay: flex;\r\n\tflex-direction: column;\r\n}\r\n\r\n.beepboxEditor .editor-right-side-top > *, .beepboxEditor .editor-right-side-bottom > * {\r\n\tflex-shrink: 0;\r\n}\r\n\r\n.beepboxEditor .pitchShiftMarkerContainer {\r\n\tbox-sizing: border-box;\r\n\tdisplay: flex;\r\n\theight: 100%;\r\n\tleft: 3px;\r\n\tright: 3px;\r\n\tposition: absolute;\r\n\talign-items: center;\r\n\tpointer-events: none;\r\n}\r\n\r\n.beepboxEditor .pitchShiftMarker {\r\n\twidth: 0;\r\n\theight: 0;\r\n\tposition: absolute;\r\n}\r\n\r\n.beepboxEditor .pitchShiftMarker::before {\r\n\tcontent: \"\";\r\n\twidth: 2px;\r\n\theight: 20px;\r\n\ttransform: translate(-50%, -50%);\r\n\tposition: absolute;\r\n\tbackground: currentColor;\r\n\tborder-radius: 3px;\r\n}\r\n\r\n.beepboxEditor input[type=text], .beepboxEditor input[type=number] {\r\n\tfont-size: inherit;\r\n\tfont-weight: inherit;\r\n\tfont-family: inherit;\r\n\tbackground: transparent;\r\n\tborder: 1px solid ${ColorConfig.uiWidgetFocus};\r\n\tcolor: ${ColorConfig.primaryText};\r\n}\r\n\r\n.beepboxEditor input[type=text]::selection, .beepboxEditor input[type=number]::selection {\r\n\tbackground-color: ${ColorConfig.textSelection};\r\n\tcolor: ${ColorConfig.primaryText};\r\n}\r\n\r\n.beepboxEditor input[type=checkbox] {\r\n  transform: scale(1.5);\r\n}\r\n\r\n.beepboxEditor input[type=range] {\r\n\t-webkit-appearance: none;\r\n\tcolor: inherit;\r\n\twidth: 100%;\r\n\theight: var(--button-size);\r\n\tfont-size: inherit;\r\n\tmargin: 0;\r\n\tcursor: pointer;\r\n\tbackground: none;\r\n\ttouch-action: pan-y;\r\n}\r\n.beepboxEditor input[type=range]:focus {\r\n\toutline: none;\r\n}\r\n.beepboxEditor input[type=range]::-webkit-slider-runnable-track {\r\n\twidth: 100%;\r\n\theight: 6px;\r\n\tcursor: pointer;\r\n\tbackground: ${ColorConfig.uiWidgetBackground};\r\n}\r\n.beepboxEditor input[type=range]::-webkit-slider-thumb {\r\n\theight: var(--button-size);\r\n\twidth: 6px;\r\n\tborder-radius: 3px;\r\n\tbackground: currentColor;\r\n\tcursor: pointer;\r\n\t-webkit-appearance: none;\r\n\tmargin-top: -10px;\r\n}\r\n.beepboxEditor input[type=range]:focus::-webkit-slider-runnable-track {\r\n\tbackground: ${ColorConfig.uiWidgetFocus};\r\n}\r\n.beepboxEditor input[type=range]::-moz-range-track {\r\n\twidth: 100%;\r\n\theight: 6px;\r\n\tcursor: pointer;\r\n\tbackground: ${ColorConfig.uiWidgetBackground};\r\n}\r\n.beepboxEditor input[type=range]:focus::-moz-range-track {\r\n\tbackground: ${ColorConfig.uiWidgetFocus};\r\n}\r\n.beepboxEditor input[type=range]::-moz-range-thumb {\r\n\theight: var(--button-size);\r\n\twidth: 6px;\r\n\tborder-radius: 3px;\r\n\tborder: none;\r\n\tbackground: currentColor;\r\n\tcursor: pointer;\r\n}\r\n.beepboxEditor input[type=range]::-ms-track {\r\n\twidth: 100%;\r\n\theight: 6px;\r\n\tcursor: pointer;\r\n\tbackground: ${ColorConfig.uiWidgetBackground};\r\n\tborder-color: transparent;\r\n}\r\n.beepboxEditor input[type=range]:focus::-ms-track {\r\n\tbackground: ${ColorConfig.uiWidgetFocus};\r\n}\r\n.beepboxEditor input[type=range]::-ms-thumb {\r\n\theight: var(--button-size);\r\n\twidth: 6px;\r\n\tborder-radius: 3px;\r\n\tbackground: currentColor;\r\n\tcursor: pointer;\r\n}\r\n\r\n/* wide screen */\r\n@media (min-width: 711px) {\r\n\t#beepboxEditorContainer {\r\n\t\tdisplay: table;\r\n\t}\r\n\t.beepboxEditor {\r\n\t\tflex-direction: row;\r\n\t}\r\n\t.beepboxEditor:focus-within {\r\n\t\toutline: 3px solid ${ColorConfig.uiWidgetBackground};\r\n\t}\r\n\t.beepboxEditor .trackAndMuteContainer {\r\n\t\twidth: 512px;\r\n\t}\r\n\t.beepboxEditor .play-pause-area {\r\n\t\tdisplay: flex;\r\n\t\tflex-direction: column;\r\n\t}\r\n\t.beepboxEditor .playback-bar-controls {\r\n\t\tmargin: 2px 0;\r\n\t}\r\n\t.beepboxEditor .playback-volume-controls {\r\n\t\tdisplay: flex;\r\n\t\tflex-direction: row;\r\n\t\tmargin: 2px 0;\r\n\t\talign-items: center;\r\n\t}\r\n\t.beepboxEditor .settings-area {\r\n\t\twidth: var(--settings-area-width);\r\n\t}\r\n}\r\n\r\n/* narrow screen */\r\n@media (max-width: 710px) {\r\n\t.beepboxEditor {\r\n\t\tgrid-template-columns: minmax(0, 1fr);\r\n\t\tgrid-template-rows: min-content 6px min-content min-content;\r\n\t\tgrid-template-areas: \"pattern-area\" \".\" \"track-area\" \"settings-area\";\r\n\t\tgrid-row-gap: 0;\r\n\t}\r\n\t.beepboxEditor .settings-area {\r\n\t\tgrid-template-columns: minmax(0, 1fr) minmax(0, 1fr);\r\n\t\tgrid-template-rows: min-content min-content 1fr min-content;\r\n\t\tgrid-template-areas:\r\n\t\t\t\"play-pause-area play-pause-area\"\r\n\t\t\t\"menu-area instrument-settings-area\"\r\n\t\t\t\"song-settings-area instrument-settings-area\"\r\n\t\t\t\"version-area version-area\";\r\n\t\tgrid-column-gap: 8px;\r\n\t\tmargin: 0 4px;\r\n\t}\r\n\t.beepboxEditor:focus-within {\r\n\t\toutline: none;\r\n\t}\r\n\t.beepboxEditor .pattern-area {\r\n\t\tmax-height: 75vh;\r\n\t}\r\n\t.beepboxEditor .trackAndMuteContainer {\r\n\t\toverflow-x: auto;\r\n\t}\r\n\t.beepboxEditor .barScrollBar {\r\n\t\tdisplay: none;\r\n\t}\r\n\t.beepboxEditor .play-pause-area {\r\n\t\tdisplay: grid;\r\n\t\tgrid-template-columns: minmax(0, 1fr) minmax(0, 1fr);\r\n\t\tgrid-column-gap: 8px;\r\n\t\tmargin: 2px 0;\r\n\t}\r\n\t.beepboxEditor .playback-bar-controls {\r\n\t\tflex-grow: 1;\r\n\t}\r\n\t.beepboxEditor .playback-volume-controls {\r\n\t\tdisplay: flex;\r\n\t\tflex-direction: row;\r\n\t\talign-items: center;\r\n\t\tflex-grow: 1;\r\n\t}\r\n}\r\n\r\n`));\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nimport {HTML} from \"imperative-html/dist/esm/elements-strict\";\r\nimport {ColorConfig} from \"./ColorConfig\";\r\n\r\nexport class Layout {\r\n\tprivate static readonly _layoutMap: {[K: string]: string} = {\r\n\t\t\"small\": \"\",\r\n\t\t\"long\": `\\\r\n\t\t\t/* long layout */\r\n\t\t\t@media (min-width: 711px) {\r\n\t\t\t\t#beepboxEditorContainer {\r\n\t\t\t\t\tmax-width: initial;\r\n\t\t\t\t\theight: 100vh;\r\n\t\t\t\t}\r\n\t\t\t\t.beepboxEditor {\r\n\t\t\t\t\twidth: 100%;\r\n\t\t\t\t\theight: 100vh;\r\n\t\t\t\t\tgrid-template-columns: minmax(0, 1fr) 390px; /* minmax(0, 1fr) min-content; Chrome 80 grid layout regression. https://bugs.chromium.org/p/chromium/issues/detail?id=1050307 */\r\n\t\t\t\t\tgrid-template-rows: minmax(481px, 1fr) minmax(0, min-content);\r\n\t\t\t\t\tgrid-template-areas: \"pattern-area settings-area\" \"track-area track-area\";\r\n\t\t\t\t}\r\n\t\t\t\t.beepboxEditor .pattern-area {\r\n\t\t\t\t\twidth: 100%;\r\n\t\t\t\t\theight: 100%;\r\n\t\t\t\t}\r\n\t\t\t\t.beepboxEditor .track-area {\r\n\t\t\t\t\twidth: 100%;\r\n\t\t\t\t\tdisplay: flex;\r\n\t\t\t\t\tflex-direction: column;\r\n\t\t\t\t}\r\n\t\t\t\t.beepboxEditor .trackAndMuteContainer {\r\n\t\t\t\t\twidth: 100%;\r\n\t\t\t\t\tmin-height: 0;\r\n\t\t\t\t\tflex: 1;\r\n\t\t\t\t\toverflow: auto;\r\n\t\t\t\t}\r\n\t\t\t\t.beepboxEditor .instrument-settings-area {\r\n\t\t\t\t\toverflow-y: auto;\r\n\t\t\t\t\tposition: relative;\r\n\t\t\t\t}\r\n\t\t\t\t.beepboxEditor .instrument-settings-area > .editor-controls {\r\n\t\t\t\t\tposition: absolute;\r\n\t\t\t\t\twidth: 100%;\r\n\t\t\t\t}\r\n\t\t\t\t.beepboxEditor .song-settings-area {\r\n\t\t\t\t\toverflow-y: auto;\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\t.beepboxEditor .settings-area {\r\n\t\t\t\t\twidth: 390px;\r\n\t\t\t\t\tgrid-template-columns: minmax(0, 1fr) minmax(0, 1fr);\r\n\t\t\t\t\tgrid-template-rows: auto auto auto minmax(0, 1fr);\r\n\t\t\t\t\tgrid-template-areas:\r\n\t\t\t\t\t\t\"instrument-settings-area version-area\"\r\n\t\t\t\t\t\t\"instrument-settings-area play-pause-area\"\r\n\t\t\t\t\t\t\"instrument-settings-area menu-area\"\r\n\t\t\t\t\t\t\"instrument-settings-area song-settings-area\";\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\t.beepboxEditor .barScrollBar {\r\n\t\t\t\t\tdisplay: none;\r\n\t\t\t\t}\r\n\t\t\t\t.beepboxEditor .trackContainer {\r\n\t\t\t\t\toverflow: visible;\r\n\t\t\t\t}\r\n\t\t\t\t.beepboxEditor .trackAndMuteContainer {\r\n\t\t\t\t\tscrollbar-width: auto;\r\n\t\t\t\t\tscrollbar-color: ${ColorConfig.uiWidgetBackground} ${ColorConfig.editorBackground};\r\n\t\t\t\t}\r\n\t\t\t\t.beepboxEditor .trackAndMuteContainer::-webkit-scrollbar {\r\n\t\t\t\t\twidth: 20px;\r\n\t\t\t\t\theight: 20px;\r\n\t\t\t\t}\r\n\t\t\t\t.beepboxEditor .trackAndMuteContainer::-webkit-scrollbar-track {\r\n\t\t\t\t\tbackground: ${ColorConfig.editorBackground};\r\n\t\t\t\t}\r\n\t\t\t\t.beepboxEditor .trackAndMuteContainer::-webkit-scrollbar-thumb {\r\n\t\t\t\t\tbackground-color: ${ColorConfig.uiWidgetBackground};\r\n\t\t\t\t\tborder: 3px solid ${ColorConfig.editorBackground};\r\n\t\t\t\t}\r\n\t\t\t\t.beepboxEditor .trackAndMuteContainer::-webkit-scrollbar-corner {\r\n\t\t\t\t\tbackground-color: ${ColorConfig.editorBackground};\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t`,\r\n\t\t\"tall\": `\\\r\n\t\t\t/* tall layout */\r\n\t\t\t@media (min-width: 711px) {\r\n\t\t\t\t#beepboxEditorContainer {\r\n\t\t\t\t\tmax-width: initial;\r\n\t\t\t\t\theight: 100vh;\r\n\t\t\t\t}\r\n\t\t\t\t.beepboxEditor {\r\n\t\t\t\t\twidth: 100%;\r\n\t\t\t\t\theight: 100vh;\r\n\t\t\t\t\tgrid-template-columns: minmax(0, 1fr) minmax(0, 1fr) 192px;\r\n\t\t\t\t\tgrid-template-rows: 1fr;\r\n\t\t\t\t\tgrid-template-areas: \"track-area pattern-area settings-area\";\r\n\t\t\t\t}\r\n\t\t\t\t.beepboxEditor .pattern-area {\r\n\t\t\t\t\twidth: 100%;\r\n\t\t\t\t\theight: 100%;\r\n\t\t\t\t}\r\n\t\t\t\t.beepboxEditor .track-area {\r\n\t\t\t\t\twidth: 100%;\r\n\t\t\t\t\theight: 100%;\r\n\t\t\t\t\tdisplay: flex;\r\n\t\t\t\t\tflex-direction: column;\r\n\t\t\t\t\tjustify-content: center;\r\n\t\t\t\t}\r\n\t\t\t\t.beepboxEditor .trackAndMuteContainer {\r\n\t\t\t\t\twidth: 100%;\r\n\t\t\t\t\tmin-height: 0;\r\n\t\t\t\t\tflex: 0;\r\n\t\t\t\t\toverflow: auto;\r\n\t\t\t\t\tflex-basis: initial;\r\n\t\t\t\t\tflex-grow: 0;\r\n\t\t\t\t}\r\n\t\t\t\t.beepboxEditor .instrument-settings-area > .editor-controls {\r\n\t\t\t\t\tposition: absolute;\r\n\t\t\t\t\twidth: 100%;\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\t.beepboxEditor .settings-area {\r\n\t\t\t\t\twidth: 192px;\r\n\t\t\t\t\tposition: relative;\r\n\t\t\t\t\toverflow-y: auto;\r\n\t\t\t\t\tgrid-template-columns: minmax(0, 1fr);\r\n\t\t\t\t\tgrid-template-rows: auto auto auto auto minmax(0, 1fr);\r\n\t\t\t\t\tgrid-template-areas:\r\n\t\t\t\t\t\t\"version-area\"\r\n\t\t\t\t\t\t\"play-pause-area\"\r\n\t\t\t\t\t\t\"menu-area\"\r\n\t\t\t\t\t\t\"song-settings-area\"\r\n\t\t\t\t\t\t\"instrument-settings-area\";\r\n\t\t\t\t}\r\n\t\t\t\t.beepboxEditor .version-area {\r\n\t\t\t\t\tposition: sticky;\r\n\t\t\t\t\ttop: 0;\r\n\t\t\t\t\tz-index: 1;\r\n\t\t\t\t\tbackground: ${ColorConfig.editorBackground};\r\n\t\t\t\t}\r\n\t\t\t\t.beepboxEditor .play-pause-area {\r\n\t\t\t\t\tposition: sticky;\r\n\t\t\t\t\ttop: 22px;\r\n\t\t\t\t\tz-index: 1;\r\n\t\t\t\t\tbackground: ${ColorConfig.editorBackground};\r\n\t\t\t\t}\r\n\t\t\t\t.beepboxEditor .menu-area {\r\n\t\t\t\t\tposition: sticky;\r\n\t\t\t\t\ttop: 82px;\r\n\t\t\t\t\tz-index: 1;\r\n\t\t\t\t\tbackground: ${ColorConfig.editorBackground};\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\t.beepboxEditor .barScrollBar {\r\n\t\t\t\t\tdisplay: none;\r\n\t\t\t\t}\r\n\t\t\t\t.beepboxEditor .trackContainer {\r\n\t\t\t\t\toverflow: visible;\r\n\t\t\t\t}\r\n\t\t\t\t.beepboxEditor .trackAndMuteContainer {\r\n\t\t\t\t\tscrollbar-width: auto;\r\n\t\t\t\t\tscrollbar-color: ${ColorConfig.uiWidgetBackground} ${ColorConfig.editorBackground};\r\n\t\t\t\t}\r\n\t\t\t\t.beepboxEditor .trackAndMuteContainer::-webkit-scrollbar {\r\n\t\t\t\t\twidth: 20px;\r\n\t\t\t\t\theight: 20px;\r\n\t\t\t\t}\r\n\t\t\t\t.beepboxEditor .trackAndMuteContainer::-webkit-scrollbar-track {\r\n\t\t\t\t\tbackground: ${ColorConfig.editorBackground};\r\n\t\t\t\t}\r\n\t\t\t\t.beepboxEditor .trackAndMuteContainer::-webkit-scrollbar-thumb {\r\n\t\t\t\t\tbackground-color: ${ColorConfig.uiWidgetBackground};\r\n\t\t\t\t\tborder: 3px solid ${ColorConfig.editorBackground};\r\n\t\t\t\t}\r\n\t\t\t\t.beepboxEditor .trackAndMuteContainer::-webkit-scrollbar-corner {\r\n\t\t\t\t\tbackground-color: ${ColorConfig.editorBackground};\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t`,\r\n\t}\r\n\t\r\n\tprivate static readonly _styleElement: HTMLStyleElement = document.head.appendChild(HTML.style({type: \"text/css\"}));\r\n\t\r\n\tpublic static setLayout(layout: string): void {\r\n\t\tthis._styleElement.textContent = this._layoutMap[layout];\r\n\t}\r\n}\r\n","// Copyright (C) 2020 John Nesky, distributed under the MIT license.\n\nimport { HTML } from \"imperative-html/dist/esm/elements-strict\";\nimport { Prompt } from \"./Prompt\";\nimport { SongDocument } from \"./SongDocument\";\nimport { ColorConfig } from \"./ColorConfig\";\n\n//namespace beepbox {\nconst { button, div, h2, select, option } = HTML;\n\nexport class ThemePrompt implements Prompt {\n\tprivate readonly _themeSelect: HTMLSelectElement = select({ style: \"width: 100%;\" },\n\t\toption({ value: \"dark classic\" }, \"BeepBox Dark\"),\n\t\toption({ value: \"dark competition\" }, \"BeepBox Competitive\"),\n\t\toption({ value: \"light classic\" }, \"BeepBox Light\"),\n\t\toption({ value: \"marine\" }, \"Marine\"),\n\t\toption({ value: \"flame\" }, \"Flame\"),\n\t\toption({ value: \"amber\" }, \"Amber\"),\n\t\toption({ value: \"vermilion\" }, \"Vermilion\"),\n\t);\n\tprivate readonly _cancelButton: HTMLButtonElement = button({ class: \"cancelButton\" });\n\tprivate readonly _okayButton: HTMLButtonElement = button({ class: \"okayButton\", style: \"width:45%;\" }, \"Okay\");\n\n\tpublic readonly container: HTMLDivElement = div({ class: \"prompt noSelection\", style: \"width: 220px;\" },\n\t\th2(\"Set Theme\"),\n\t\tdiv({ style: \"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;\" },\n\t\t\tdiv({ class: \"selectContainer\", style: \"width: 100%;\" }, this._themeSelect),\n\t\t),\n\t\tdiv({ style: \"display: flex; flex-direction: row-reverse; justify-content: space-between;\" },\n\t\t\tthis._okayButton,\n\t\t),\n\t\tthis._cancelButton,\n\t);\n\tprivate readonly lastTheme: string | null = window.localStorage.getItem(\"TBBcolorTheme\")\n\n\tconstructor(private _doc: SongDocument) {\n\t\tif (this.lastTheme != null) {\n\t\t\tthis._themeSelect.value = this.lastTheme;\n\t\t}\n\t\tthis._okayButton.addEventListener(\"click\", this._saveChanges);\n\t\tthis._cancelButton.addEventListener(\"click\", this._close);\n\t\tthis.container.addEventListener(\"keydown\", this._whenKeyPressed);\n\t\tthis._themeSelect.addEventListener(\"change\", this._previewTheme);\n\t}\n\n\tprivate _close = (): void => {\n\t\tif (this.lastTheme != null) {\n\t\t\tColorConfig.setTheme(this.lastTheme);\n\t\t} else {\n\t\t\tColorConfig.setTheme(\"dark classic\");\n\t\t}\n\t\tthis._doc.undo();\n\t}\n\n\tpublic cleanUp = (): void => {\n\t\tthis._okayButton.removeEventListener(\"click\", this._saveChanges);\n\t\tthis._cancelButton.removeEventListener(\"click\", this._close);\n\t\tthis.container.removeEventListener(\"keydown\", this._whenKeyPressed);\n\t}\n\n\tprivate _whenKeyPressed = (event: KeyboardEvent): void => {\n\t\tif ((<Element>event.target).tagName != \"BUTTON\" && event.keyCode == 13) { // Enter key\n\t\t\tthis._saveChanges();\n\t\t}\n\t}\n\n\tprivate _saveChanges = (): void => {\n\t\twindow.localStorage.setItem(\"TBBcolorTheme\", this._themeSelect.value);\n\t\tthis._doc.prompt = null;\n\t\tthis._doc.prefs.colorTheme = this._themeSelect.value;\n\t\tthis._doc.undo();\n\t}\n\n\tprivate _previewTheme = (): void => {\n\t\tColorConfig.setTheme(this._themeSelect.value);\n\t\tthis._doc.notifier.changed();\n\t}\n}\n//}\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\n// interface shared by number[], Float32Array, and other typed arrays in JavaScript.\r\ninterface NumberArray {\r\n\tlength: number;\r\n\t[index: number]: number;\r\n}\r\n\r\n// A basic FFT operation scales the overall magnitude of elements by the\r\n// square root of the length of the array, N. Performing a forward FFT and\r\n// then an inverse FFT results in the original array, but multiplied by N.\r\n// This helper function can be used to compensate for that. \r\nexport function scaleElementsByFactor(array: NumberArray, factor: number): void {\r\n\tfor (let i: number = 0; i < array.length; i++) {\r\n\t\tarray[i] *= factor;\r\n\t}\r\n}\r\n\r\nfunction isPowerOf2(n: number): boolean {\r\n\treturn !!n && !(n & (n - 1));\r\n}\r\n\r\nfunction countBits(n: number): number {\r\n\tif (!isPowerOf2(n)) throw new Error(\"FFT array length must be a power of 2.\");\r\n\treturn Math.round(Math.log(n) / Math.log(2));\r\n}\r\n\r\n// Rearranges the elements of the array, swapping the element at an index\r\n// with an element at an index that is the bitwise reverse of the first\r\n// index in base 2. Useful for computing the FFT.\r\nfunction reverseIndexBits(array: NumberArray, fullArrayLength: number): void {\r\n\tconst bitCount: number = countBits(fullArrayLength);\r\n\tif (bitCount > 16) throw new Error(\"FFT array length must not be greater than 2^16.\");\r\n\tconst finalShift: number = 16 - bitCount;\r\n\tfor (let i: number = 0; i < fullArrayLength; i++) {\r\n\t\t// Dear Javascript: Please support bit order reversal intrinsics. Thanks! :D\r\n\t\tlet j: number;\r\n\t\tj = ((i & 0xaaaa) >> 1) | ((i & 0x5555) << 1);\r\n\t\tj = ((j & 0xcccc) >> 2) | ((j & 0x3333) << 2);\r\n\t\tj = ((j & 0xf0f0) >> 4) | ((j & 0x0f0f) << 4);\r\n\t\tj = ((j           >> 8) | ((j &   0xff) << 8)) >> finalShift;\r\n\t\tif (j > i) {\r\n\t\t\tlet temp: number = array[i];\r\n\t\t\tarray[i] = array[j];\r\n\t\t\tarray[j] = temp;\r\n\t\t}\r\n\t}\r\n}\r\n\r\n// Provided for educational purposes. Easier to read than\r\n// fastFourierTransform(), but computes the same result.\r\n// Takes two parallel arrays representing the real and imaginary elements,\r\n// respectively, and returns an array containing two new arrays, which\r\n// contain the complex result of the transform.\r\nexport function discreteFourierTransform(realArray: NumberArray, imagArray: NumberArray): number[][] {\r\n\tconst fullArrayLength: number = realArray.length;\r\n\tif (fullArrayLength != imagArray.length) throw new Error(\"FFT arrays must be the same length.\");\r\n\tconst realOut: number[] = [];\r\n\tconst imagOut: number[] = [];\r\n\tfor (let i: number = 0; i < fullArrayLength; i++) {\r\n\t\trealOut[i] = 0.0;\r\n\t\timagOut[i] = 0.0;\r\n\t\tfor (let j: number = 0; j < fullArrayLength; j++) {\r\n\t\t\tconst radians: number = -6.2831853 * j * i / fullArrayLength;\r\n\t\t\tconst c: number = Math.cos(radians);\r\n\t\t\tconst s: number = Math.sin(radians);\r\n\t\t\trealOut[i] += realArray[j] * c - imagArray[j] * s;\r\n\t\t\timagOut[i] += realArray[j] * s + imagArray[j] * c;\r\n\t\t}\r\n\t}\r\n\treturn [realOut, imagOut];\r\n}\r\n\r\n// Performs a Fourier transform in O(N log(N)) operations. Overwrites the\r\n// input real and imaginary arrays. Can be used for both forward and inverse\r\n// transforms: swap the order of the arguments for the inverse.\r\nexport function fastFourierTransform(realArray: NumberArray, imagArray: NumberArray): void {\r\n\tconst fullArrayLength: number = realArray.length;\r\n\tif (!isPowerOf2(fullArrayLength)) throw new Error(\"FFT array length must be a power of 2.\");\r\n\tif (fullArrayLength < 4) throw new Error(\"FFT array length must be at least 4.\");\r\n\tif (fullArrayLength != imagArray.length) throw new Error(\"FFT arrays must be the same length.\");\r\n\t\r\n\treverseIndexBits(realArray, fullArrayLength);\r\n\treverseIndexBits(imagArray, fullArrayLength);\r\n\t\r\n\t// First two passes, with strides of 2 and 4, can be combined and optimized.\r\n\tfor (let startIndex: number = 0; startIndex < fullArrayLength; startIndex += 4) {\r\n\t\tconst startIndex1: number = startIndex + 1;\r\n\t\tconst startIndex2: number = startIndex + 2;\r\n\t\tconst startIndex3: number = startIndex + 3;\r\n\t\tconst real0: number = realArray[startIndex ];\r\n\t\tconst real1: number = realArray[startIndex1];\r\n\t\tconst real2: number = realArray[startIndex2];\r\n\t\tconst real3: number = realArray[startIndex3];\r\n\t\tconst imag0: number = imagArray[startIndex ];\r\n\t\tconst imag1: number = imagArray[startIndex1];\r\n\t\tconst imag2: number = imagArray[startIndex2];\r\n\t\tconst imag3: number = imagArray[startIndex3];\r\n\t\tconst realTemp0: number = real0 + real1;\r\n\t\tconst realTemp1: number = real0 - real1;\r\n\t\tconst realTemp2: number = real2 + real3;\r\n\t\tconst realTemp3: number = real2 - real3;\r\n\t\tconst imagTemp0: number = imag0 + imag1;\r\n\t\tconst imagTemp1: number = imag0 - imag1;\r\n\t\tconst imagTemp2: number = imag2 + imag3;\r\n\t\tconst imagTemp3: number = imag2 - imag3;\r\n\t\trealArray[startIndex ] = realTemp0 + realTemp2;\r\n\t\trealArray[startIndex1] = realTemp1 + imagTemp3;\r\n\t\trealArray[startIndex2] = realTemp0 - realTemp2;\r\n\t\trealArray[startIndex3] = realTemp1 - imagTemp3;\r\n\t\timagArray[startIndex ] = imagTemp0 + imagTemp2;\r\n\t\timagArray[startIndex1] = imagTemp1 - realTemp3;\r\n\t\timagArray[startIndex2] = imagTemp0 - imagTemp2;\r\n\t\timagArray[startIndex3] = imagTemp1 + realTemp3;\r\n\t}\r\n\t\r\n\tfor (let stride: number = 8; stride <= fullArrayLength; stride += stride) {\r\n\t\tconst halfLength: number = stride >>> 1;\r\n\t\tconst radiansIncrement: number = Math.PI * 2.0 / stride;\r\n\t\tconst cosIncrement: number = Math.cos(radiansIncrement);\r\n\t\tconst sinIncrement: number = Math.sin(radiansIncrement);\r\n\t\tconst oscillatorMultiplier: number = 2.0 * cosIncrement;\r\n\t\tfor (let startIndex: number = 0; startIndex < fullArrayLength; startIndex += stride) {\r\n\t\t\tlet c: number = 1.0;\r\n\t\t\tlet s: number = 0.0;\r\n\t\t\tlet cPrev: number = cosIncrement;\r\n\t\t\tlet sPrev: number = sinIncrement;\r\n\t\t\tconst secondHalf: number = startIndex + halfLength;\r\n\t\t\tfor (let i: number = startIndex; i < secondHalf; i++) {\r\n\t\t\t\tconst j: number = i + halfLength;\r\n\t\t\t\tconst real0: number = realArray[i];\r\n\t\t\t\tconst imag0: number = imagArray[i];\r\n\t\t\t\tconst real1: number = realArray[j] * c - imagArray[j] * s;\r\n\t\t\t\tconst imag1: number = realArray[j] * s + imagArray[j] * c;\r\n\t\t\t\trealArray[i] = real0 + real1;\r\n\t\t\t\timagArray[i] = imag0 + imag1;\r\n\t\t\t\trealArray[j] = real0 - real1;\r\n\t\t\t\timagArray[j] = imag0 - imag1;\r\n\t\t\t\tconst cTemp: number = oscillatorMultiplier * c - cPrev;\r\n\t\t\t\tconst sTemp: number = oscillatorMultiplier * s - sPrev;\r\n\t\t\t\tcPrev = c;\r\n\t\t\t\tsPrev = s;\r\n\t\t\t\tc = cTemp;\r\n\t\t\t\ts = sTemp;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n\r\n// Computes the Fourier transform from an array of real-valued time-domain\r\n// samples. The output is specially formatted for space efficieny: elements\r\n// 0 through N/2 represent cosine wave amplitudes in ascending frequency,\r\n// and elements N/2+1 through N-1 represent sine wave amplitudes in\r\n// descending frequency. Overwrites the input array.\r\nexport function forwardRealFourierTransform(array: NumberArray): void {\r\n\tconst fullArrayLength: number = array.length;\r\n\tconst totalPasses: number = countBits(fullArrayLength);\r\n\tif (fullArrayLength < 4) throw new Error(\"FFT array length must be at least 4.\");\r\n\t\r\n\treverseIndexBits(array, fullArrayLength);\r\n\t\r\n\t// First and second pass.\r\n\tfor (let index: number = 0; index < fullArrayLength; index += 4) {\r\n\t\tconst index1: number = index + 1;\r\n\t\tconst index2: number = index + 2;\r\n\t\tconst index3: number = index + 3;\r\n\t\tconst real0: number = array[index ];\r\n\t\tconst real1: number = array[index1];\r\n\t\tconst real2: number = array[index2];\r\n\t\tconst real3: number = array[index3];\r\n\t\t// no imaginary elements yet since the input is fully real.\r\n\t\tconst tempA: number = real0 + real1;\r\n\t\tconst tempB: number = real2 + real3;\r\n\t\tarray[index ] = tempA + tempB;\r\n\t\tarray[index1] = real0 - real1;\r\n\t\tarray[index2] = tempA - tempB;\r\n\t\tarray[index3] = real2 - real3;\r\n\t}\r\n\t\r\n\t// Third pass.\r\n\tconst sqrt2over2: number = Math.sqrt(2.0) / 2.0;\r\n\tfor (let index: number = 0; index < fullArrayLength; index += 8) {\r\n\t\tconst index1: number = index + 1;\r\n\t\tconst index3: number = index + 3;\r\n\t\tconst index4: number = index + 4;\r\n\t\tconst index5: number = index + 5;\r\n\t\tconst index7: number = index + 7;\r\n\t\tconst real0: number = array[index ];\r\n\t\tconst real1: number = array[index1];\r\n\t\tconst imag3: number = array[index3];\r\n\t\tconst real4: number = array[index4];\r\n\t\tconst real5: number = array[index5];\r\n\t\tconst imag7: number = array[index7];\r\n\t\tconst tempA: number = (real5 - imag7) * sqrt2over2;\r\n\t\tconst tempB: number = (real5 + imag7) * sqrt2over2;\r\n\t\tarray[index ] = real0 + real4;\r\n\t\tarray[index1] = real1 + tempA;\r\n\t\tarray[index3] = real1 - tempA;\r\n\t\tarray[index4] = real0 - real4;\r\n\t\tarray[index5] = tempB - imag3;\r\n\t\tarray[index7] = tempB + imag3;\r\n\t}\r\n\t\r\n\t// Handle remaining passes.\r\n\tfor (let pass: number = 3; pass < totalPasses; pass++) {\r\n\t\tconst subStride: number = 1 << pass;\r\n\t\tconst midSubStride: number = subStride >> 1;\r\n\t\tconst stride: number = subStride << 1;\r\n\t\tconst radiansIncrement: number = Math.PI * 2.0 / stride;\r\n\t\tconst cosIncrement: number = Math.cos(radiansIncrement);\r\n\t\tconst sinIncrement: number = Math.sin(radiansIncrement);\r\n\t\tconst oscillatorMultiplier: number = 2.0 * cosIncrement;\r\n\t\tfor (let startIndex: number = 0; startIndex < fullArrayLength; startIndex += stride) {\r\n\t\t\tconst startIndexA: number = startIndex;\r\n\t\t\tconst startIndexB: number = startIndexA + subStride;\r\n\t\t\tconst stopIndex: number = startIndexB + subStride;\r\n\t\t\tconst realStartA: number = array[startIndexA];\r\n\t\t\tconst realStartB: number = array[startIndexB];\r\n\t\t\tarray[startIndexA] = realStartA + realStartB;\r\n\t\t\tarray[startIndexB] = realStartA - realStartB;\r\n\t\t\tlet c: number = cosIncrement;\r\n\t\t\tlet s: number = -sinIncrement;\r\n\t\t\tlet cPrev: number = 1.0;\r\n\t\t\tlet sPrev: number = 0.0;\r\n\t\t\tfor (let index: number = 1; index < midSubStride; index++) {\r\n\t\t\t\tconst indexA0: number = startIndexA + index;\r\n\t\t\t\tconst indexA1: number = startIndexB - index;\r\n\t\t\t\tconst indexB0: number = startIndexB + index;\r\n\t\t\t\tconst indexB1: number = stopIndex   - index;\r\n\t\t\t\tconst real0: number = array[indexA0];\r\n\t\t\t\tconst imag0: number = array[indexA1];\r\n\t\t\t\tconst real1: number = array[indexB0];\r\n\t\t\t\tconst imag1: number = array[indexB1];\r\n\t\t\t\tconst tempA: number = real1 * c + imag1 * s;\r\n\t\t\t\tconst tempB: number = real1 * s - imag1 * c;\r\n\t\t\t\tarray[indexA0] = real0 + tempA;\r\n\t\t\t\tarray[indexA1] = real0 - tempA;\r\n\t\t\t\tarray[indexB0] =-imag0 - tempB;\r\n\t\t\t\tarray[indexB1] = imag0 - tempB;\r\n\t\t\t\tconst cTemp: number = oscillatorMultiplier * c - cPrev;\r\n\t\t\t\tconst sTemp: number = oscillatorMultiplier * s - sPrev;\r\n\t\t\t\tcPrev = c;\r\n\t\t\t\tsPrev = s;\r\n\t\t\t\tc = cTemp;\r\n\t\t\t\ts = sTemp;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n\r\n// Computes the inverse Fourier transform from a specially formatted array of\r\n// scalar values. Elements 0 through N/2 are expected to be the real values of\r\n// the corresponding complex elements, representing cosine wave amplitudes in\r\n// ascending frequency, and elements N/2+1 through N-1 correspond to the\r\n// imaginary values, representing sine wave amplitudes in descending frequency.\r\n// Generates real-valued time-domain samples. Overwrites the input array.\r\nexport function inverseRealFourierTransform(array: NumberArray, fullArrayLength: number): void {\r\n\tconst totalPasses: number = countBits(fullArrayLength);\r\n\tif (fullArrayLength < 4) throw new Error(\"FFT array length must be at least 4.\");\r\n\r\n\t// Perform all but the last few passes in reverse.\r\n\tfor (let pass: number = totalPasses - 1; pass >= 2; pass--) {\r\n\t\tconst subStride: number = 1 << pass;\r\n\t\tconst midSubStride: number = subStride >> 1;\r\n\t\tconst stride: number = subStride << 1;\r\n\t\tconst radiansIncrement: number = Math.PI * 2.0 / stride;\r\n\t\tconst cosIncrement: number = Math.cos(radiansIncrement);\r\n\t\tconst sinIncrement: number = Math.sin(radiansIncrement);\r\n\t\tconst oscillatorMultiplier: number = 2.0 * cosIncrement;\r\n\t\t\r\n\t\tfor (let startIndex: number = 0; startIndex < fullArrayLength; startIndex += stride) {\r\n\t\t\tconst startIndexA: number = startIndex;\r\n\t\t\tconst midIndexA: number = startIndexA + midSubStride;\r\n\t\t\tconst startIndexB: number = startIndexA + subStride;\r\n\t\t\tconst midIndexB: number = startIndexB + midSubStride;\r\n\t\t\tconst stopIndex: number = startIndexB + subStride;\r\n\t\t\tconst realStartA: number = array[startIndexA];\r\n\t\t\tconst imagStartB: number = array[startIndexB];\r\n\t\t\tarray[startIndexA] = realStartA + imagStartB;\r\n\t\t\tarray[midIndexA] *= 2;\r\n\t\t\tarray[startIndexB] = realStartA - imagStartB;\r\n\t\t\tarray[midIndexB] *= 2;\r\n\t\t\tlet c: number = cosIncrement;\r\n\t\t\tlet s: number = -sinIncrement;\r\n\t\t\tlet cPrev: number = 1.0;\r\n\t\t\tlet sPrev: number = 0.0;\r\n\t\t\tfor (let index: number = 1; index < midSubStride; index++) {\r\n\t\t\t\tconst indexA0: number = startIndexA + index;\r\n\t\t\t\tconst indexA1: number = startIndexB - index;\r\n\t\t\t\tconst indexB0: number = startIndexB + index;\r\n\t\t\t\tconst indexB1: number = stopIndex   - index;\r\n\t\t\t\tconst real0: number = array[indexA0];\r\n\t\t\t\tconst real1: number = array[indexA1];\r\n\t\t\t\tconst imag0: number = array[indexB0];\r\n\t\t\t\tconst imag1: number = array[indexB1];\r\n\t\t\t\tconst tempA: number = real0 - real1;\r\n\t\t\t\tconst tempB: number = imag0 + imag1;\r\n\t\t\t\tarray[indexA0] = real0 + real1;\r\n\t\t\t\tarray[indexA1] = imag1 - imag0;\r\n\t\t\t\tarray[indexB0] = tempA * c - tempB * s;\r\n\t\t\t\tarray[indexB1] = tempB * c + tempA * s;\r\n\t\t\t\tconst cTemp: number = oscillatorMultiplier * c - cPrev;\r\n\t\t\t\tconst sTemp: number = oscillatorMultiplier * s - sPrev;\r\n\t\t\t\tcPrev = c;\r\n\t\t\t\tsPrev = s;\r\n\t\t\t\tc = cTemp;\r\n\t\t\t\ts = sTemp;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\t/*\r\n\t// Commented out this block (and compensated with an extra pass above)\r\n\t// because it's slower in my testing so far.\r\n\t// Pass with stride 8.\r\n\tconst sqrt2over2: number = Math.sqrt(2.0) / 2.0;\r\n\tfor (let index: number = 0; index < fullArrayLength; index += 8) {\r\n\t\tconst index1: number = index + 1;\r\n\t\tconst index2: number = index + 2;\r\n\t\tconst index3: number = index + 3;\r\n\t\tconst index4: number = index + 4;\r\n\t\tconst index5: number = index + 5;\r\n\t\tconst index6: number = index + 6;\r\n\t\tconst index7: number = index + 7;\r\n\t\tconst real0: number = array[index ];\r\n\t\tconst real1: number = array[index1];\r\n\t\tconst real2: number = array[index2];\r\n\t\tconst real3: number = array[index3];\r\n\t\tconst imag4: number = array[index4];\r\n\t\tconst imag5: number = array[index5];\r\n\t\tconst imag6: number = array[index6];\r\n\t\tconst imag7: number = array[index7];\r\n\t\tconst tempA: number = real1 - real3;\r\n\t\tconst tempB: number = imag5 + imag7;\r\n\t\tarray[index ] = real0 + imag4;\r\n\t\tarray[index1] = real1 + real3;\r\n\t\tarray[index2] = real2 * 2;\r\n\t\tarray[index3] = imag7 - imag5;\r\n\t\tarray[index4] = real0 - imag4;\r\n\t\tarray[index5] = (tempA + tempB) * sqrt2over2;\r\n\t\tarray[index6] = imag6 * 2;\r\n\t\tarray[index7] = (tempB - tempA) * sqrt2over2;\r\n\t}\r\n\t*/\r\n\t// The final passes with strides 4 and 2, combined into one loop.\r\n\tfor (let index: number = 0; index < fullArrayLength; index += 4) {\r\n\t\tconst index1: number = index + 1;\r\n\t\tconst index2: number = index + 2;\r\n\t\tconst index3: number = index + 3;\r\n\t\tconst real0: number = array[index ];\r\n\t\tconst real1: number = array[index1] * 2;\r\n\t\tconst imag2: number = array[index2];\r\n\t\tconst imag3: number = array[index3] * 2;\r\n\t\tconst tempA: number = real0 + imag2;\r\n\t\tconst tempB: number = real0 - imag2;\r\n\t\tarray[index ] = tempA + real1;\r\n\t\tarray[index1] = tempA - real1;\r\n\t\tarray[index2] = tempB + imag3;\r\n\t\tarray[index3] = tempB - imag3;\r\n\t}\r\n\t\r\n\treverseIndexBits(array, fullArrayLength);\r\n}\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nexport class Deque<T> {\r\n\tprivate _capacity: number = 1;\r\n\tprivate _buffer: Array<T | undefined> = [undefined];\r\n\tprivate _mask: number = 0;\r\n\tprivate _offset: number = 0;\r\n\tprivate _count: number = 0;\r\n\r\n\tpublic pushFront(element: T): void {\r\n\t\tif (this._count >= this._capacity) this._expandCapacity();\r\n\t\tthis._offset = (this._offset - 1) & this._mask;\r\n\t\tthis._buffer[this._offset] = element;\r\n\t\tthis._count++;\r\n\t}\r\n\tpublic pushBack(element: T): void {\r\n\t\tif (this._count >= this._capacity) this._expandCapacity();\r\n\t\tthis._buffer[(this._offset + this._count) & this._mask] = element;\r\n\t\tthis._count++;\r\n\t}\r\n\tpublic popFront(): T {\r\n\t\tif (this._count <= 0) throw new Error(\"No elements left to pop.\");\r\n\t\tconst element: T = <T>this._buffer[this._offset];\r\n\t\tthis._buffer[this._offset] = undefined;\r\n\t\tthis._offset = (this._offset + 1) & this._mask;\r\n\t\tthis._count--;\r\n\t\treturn element;\r\n\t}\r\n\tpublic popBack(): T {\r\n\t\tif (this._count <= 0) throw new Error(\"No elements left to pop.\");\r\n\t\tthis._count--;\r\n\t\tconst index: number = (this._offset + this._count) & this._mask;\r\n\t\tconst element: T = <T>this._buffer[index];\r\n\t\tthis._buffer[index] = undefined;\r\n\t\treturn element;\r\n\t}\r\n\tpublic peakFront(): T {\r\n\t\tif (this._count <= 0) throw new Error(\"No elements left to pop.\");\r\n\t\treturn <T>this._buffer[this._offset];\r\n\t}\r\n\tpublic peakBack(): T {\r\n\t\tif (this._count <= 0) throw new Error(\"No elements left to pop.\");\r\n\t\treturn <T>this._buffer[(this._offset + this._count - 1) & this._mask];\r\n\t}\r\n\tpublic count(): number {\r\n\t\treturn this._count;\r\n\t}\r\n\tpublic set(index: number, element: T): void {\r\n\t\tif (index < 0 || index >= this._count) throw new Error(\"Invalid index\");\r\n\t\tthis._buffer[(this._offset + index) & this._mask] = element;\r\n\t}\r\n\tpublic get(index: number): T {\r\n\t\tif (index < 0 || index >= this._count) throw new Error(\"Invalid index\");\r\n\t\treturn <T>this._buffer[(this._offset + index) & this._mask];\r\n\t}\r\n\tpublic remove(index: number): void {\r\n\t\tif (index < 0 || index >= this._count) throw new Error(\"Invalid index\");\r\n\t\tif (index <= (this._count >> 1)) {\r\n\t\t\twhile (index > 0) {\r\n\t\t\t\tthis.set(index, this.get(index - 1));\r\n\t\t\t\tindex--;\r\n\t\t\t}\r\n\t\t\tthis.popFront();\r\n\t\t} else {\r\n\t\t\tindex++;\r\n\t\t\twhile (index < this._count) {\r\n\t\t\t\tthis.set(index - 1, this.get(index));\r\n\t\t\t\tindex++;\r\n\t\t\t}\r\n\t\t\tthis.popBack();\r\n\t\t}\r\n\t}\r\n\tprivate _expandCapacity(): void {\r\n\t\tif (this._capacity >= 0x40000000) throw new Error(\"Capacity too big.\");\r\n\t\tthis._capacity = this._capacity << 1;\r\n\t\tconst oldBuffer: Array<T | undefined> = this._buffer;\r\n\t\tconst newBuffer: Array<T | undefined> = new Array(this._capacity);\r\n\t\tconst size: number = this._count | 0;\r\n\t\tconst offset: number = this._offset | 0;\r\n\t\tfor (let i = 0; i < size; i++) {\r\n\t\t\tnewBuffer[i] = oldBuffer[(offset + i) & this._mask];\r\n\t\t}\r\n\t\tfor (let i = size; i < this._capacity; i++) {\r\n\t\t\tnewBuffer[i] = undefined;\r\n\t\t}\r\n\t\tthis._offset = 0;\r\n\t\tthis._buffer = newBuffer;\r\n\t\tthis._mask = this._capacity - 1;\r\n\t}\r\n}\r\n","/*\r\nThis file contains code to compute digital audio filter coefficients based on\r\nthe desired type, cutoff frequency, and other parameters. You can use these\r\ncoefficients to apply the filter to audio samples. It also contains code to\r\nanalyze these filters, which is useful for graphically displaying their effects.\r\n\r\nAll of the filters in this file are known as \"Infinite Impulse Response\" or IIR\r\nfilters, because older output samples contribute feedback to newer output\r\nsamples and thus contribute to all future samples, although typically filters\r\nare design to reduce the contribution of older samples over time.\r\n\r\nLow-pass filters aka high-cut filters preserve audio signals below the cutoff\r\nfrequency, and attenuate audio signals above the cutoff frequency. High-pass\r\nfilters aka low-cut filters are the reverse. All-pass filters do not affect the\r\nvolume of the signal at all but induce phase changes above the cutoff frequency.\r\nPeak/Notch filters maintain the volume on either side of the cutoff frequency,\r\nbut raise or lower the volume at that frequency. \r\n\r\nThe number of old samples used in the filter determines the \"order\" of the\r\nfilter. First-order filters generally have shallower slopes, and second-order\r\nfilters generally have steeper slopes and can be configured to \"resonate\",\r\nmeaning they have a louder peak at the cutoff frequency. This file contains\r\nfirst-order filters and second-order filters, meaning one or two older samples\r\nare involved, as well as the current input sample.\r\n\r\nThe class FilterCoefficients is defined lower in this file. You can use it to\r\nset up a first order filter like this:\r\n\r\n\tconst cutoffRadiansPerSample: number = 2 * Math.PI * cutoffHz / sampleRate;\r\n\tconst filter: FilterCoefficients = new FilterCoefficients();\r\n\tfilter.lowPass1stOrderButterworth(cutoffRadiansPerSample);\r\n\t// output sample coefficients are conventionally called a0, a1, etc. Note\r\n\t// that a[0] is typically normalized to 1.0 and need not be used directly.\r\n\tconst a: number[] = filter.a;\r\n\t// input sample coefficients are conventionally called b0, b1, etc\r\n\tconst b: number[] = filter.b;\r\n\t// filter input samples, x[0] is the most recent, x[1] is the previous one, etc.\r\n\tconst x: number[] = [0, 0, 0];\r\n\t// filter output samples, y[0] will be computed by the filter based on input\r\n\t// samples and older output samples.\r\n\tconst y: number[] = [0, 0, 0];\r\n\r\nThen to apply the first-order filter to samples inside a loop, using the current\r\ninput sample (x[0]) as well as previous input and output samples, do this:\r\n\r\n\t// Compute the next output sample y[0]:\r\n\ty[0] = b[0] * x[0] + b[1] * x[1] - a[1] * y[1];\r\n\t// Remember the input and output samples for next time:\r\n\tx[1] = x[0];\r\n\ty[1] = y[0];\r\n\r\n2nd order filters are similar, but have more parameters and require more old\r\nsamples:\r\n\r\n\t// Compute the next output sample y[0]:\r\n\ty[0] = b[0] * x[0] + b[1] * x[1] + b[2] * x[2] - a[1] * y[1] - a[2] * y[2];\r\n\t// Remember the input and output samples for next time:\r\n\tx[2] = x[1];\r\n\tx[1] = x[0];\r\n\ty[2] = y[1];\r\n\ty[1] = y[0];\r\n\r\nYou can compose multiple filters into a higher order filter, although doing so\r\nreduces the numerical stability of the filter:\r\n\r\n\tfilter3.combination(filter1, filter2);\r\n\t// filter3.order will equal: filter1.order + filter2.order\r\n\t// The number of coefficients in filter3.a and filter3.b will be: order + 1\r\n\r\nThis file also contains a class called FrequencyResponse. You can use it to\r\ndetermine how much gain or attenuation a filter would apply to sounds at a\r\nspecific input frequency, as well as the phase offset:\r\n\r\n\tconst inputRadians: number = 2 * Math.PI * cutoffHz / sampleRate;\r\n\tconst response: FrequencyResponse = new FrequencyResponse();\r\n\tresponse.analyze(filter, inputRadians);\r\n\tconst gainResponse = response.magnitude();\r\n\tconst phaseResponse = response.angle();\r\n\r\nThat's basically all you need to know to use this code, but I'll also explain\r\nhow the analysis works.\r\n\r\nA first-order digital IIR filter is ordinarily implemented in a form like this:\r\n\r\n\toutput = inputCoeff * input + prevInputCoeff * prevInput - prevOutputCoeff * prevOutput;\r\n\r\nIf we adopt standard naming conventions for audio filters, this same code would\r\ninstead look like:\r\n\r\n\t// x0 = current input, x1 = prevInput, y0 = current output, y1 = prevOutput\r\n\ty0 = b0*x0 + b1*x1 - a1*y1;\r\n\r\nLeaving behind the world of code for a moment and entering the world of algebra,\r\nwe can rewrite this equation by moving all the output terms to the left side,\r\nand we can add a coefficient to the y0 term called a0 (which is typically\r\nnormalized to 1.0, which is why I didn't bother including it until now):\r\n\r\n\ta0*y0 + a1*y1 = b0*x0 + b1*x1\r\n\r\nThis is known as the symmetrical form of the filter, and it will help us analyze\r\nthe impact of the filter on an input audio signal. Here's a lesson that helped\r\nme understand the symmetrical form:\r\nhttps://web.archive.org/web/20200626183458/http://123.physics.ucdavis.edu/week_5_files/filters/digital_filter.pdf\r\n\r\nThe end of that lesson introduces a concept called the \"delay operator\" which\r\nlooks like \"z^-1\", which (magically) turns a sample into the previous sample\r\nwhen you multiply them. For example:\r\n\r\n\tx0 * z^-1 = x1\r\n\r\nThe lesson doesn't explain how it actually works. Audio signals aren't always\r\npredictable, which means that you generally can't do math on a single sample to\r\ncompute what the previous sample was. However, some audio signals ARE\r\npredictable, such as pure sine waves. Fortunately, all audio signals can be\r\nbroken down into a sum of independent sine waves. We can pick one sine wave at a\r\ntime, and use it to analyze the filter's impact on waves at that frequency. In\r\npractice, this tells us what the filter will do to unpredictable input samples\r\nthat contain a partial sine wave at that frequency.\r\n\r\nTechnically, you can't just use a single sine wave sample to determine the\r\nprevious sine wave sample, because each possible value is passed going upwards\r\nand downwards once per period and the direction is ambigous. This is where we\r\nneed to move into the complex number domain, where the real and imaginary\r\ncomponents can provide enough information to compute the previous position on\r\nthe input signal. So now instead of talking about sine waves, we're talking\r\nabout waves where the imaginary component is a sine wave and the real component\r\nis a cosine wave at the same frequency. Together, they trace around a unit\r\ncircle in the complex domain, and each sample is just a consistent rotation\r\napplied to the previous sample. The \"delay operator\" described above, z^-1, is\r\nthis same rotation applied in reverse, and it can be computed as:\r\n\r\n\tz^-1 = cos(radiansPerSample) - i * sin(radiansPerSample)\r\n\r\nMath nerds may be interested to know that \"Euler's formula\" was used here, but\r\nexplaining what that means is probably beyond the scope of this documentation\r\naside from noting that a complex number on the unit circle represents a 2D\r\nrotation that you can apply via multiplication.\r\n\r\nNow we can rewrite the symmetrical form using the delay operator and algebra:\r\n\r\n\ta0*y0 + a1*y0*z^-1 = b0*x0 + b1*x0*z^-1\r\n\ty0 * (a0 + a1*z^-1) = x0 * (b0 + b1*z^-1)\r\n\ty0 = x0 * (b0 + b1*z^-1) / (a0 + a1*z^-1)\r\n\ty0 / x0 = (b0 + b1*z^-1) / (a0 + a1*z^-1)\r\n\r\nThat last equation expresses the relationship between the input and output\r\nsignals (y0/x0) in terms of the filter coefficients and delay operator. At this\r\npoint, the specific values of the input and output samples don't even matter!\r\nThis is called the \"transfer function\", and it's conventionally named \"H(z)\":\r\n\r\n\tH(z) = (b0 + b1*z^-1) / (a0 + a1*z^-1)\r\n\r\nIf you plug in actual filter coefficients and express the delay operators as\r\ncomplex numbers with the appropriate trigonometry functions, the transfer\r\nfunction can be computed and produces a complex number that represents the\r\nrelationship between the input and output signals, whose magnitude represents\r\nthe volume gain (or attenuation) of signals at that frequency, and whose angle\r\nrepresents how much phase shift is applied by the filter to signals at that\r\nfrequency.\r\n\r\n(Note that in order to compute the transfer function, you'll need to do\r\nsomething about the complex number in the denominator. It turns out you can turn\r\nthe denominator into a real number by multiplying both the numerator and\r\ndenominator by the complex conjugate of the denominator, which is just the\r\ndenominator with the imaginary component negated.)\r\n\r\nFinally, I'll list some of the links that helped me understand filters and\r\nprovided some of the algorithms I that use here.\r\n\r\nHere's where I found accurate 2nd order low-pass, high-pass, and high-shelf\r\ndigital filters:\r\nhttps://web.archive.org/web/20120531011328/http://www.musicdsp.org/files/Audio-EQ-Cookbook.txt\r\n\r\nThis page is how I found a link to the cookbook article above. It claims these\r\nfilters are Butterworth filters:\r\nhttp://web.archive.org/web/20191213120120/https://crypto.stanford.edu/~blynn/sound/analog.html\r\n\r\nI found the first-order digital Butterworth filter coefficients at:\r\nhttps://www.researchgate.net/publication/338022014_Digital_Implementation_of_Butterworth_First-Order_Filter_Type_IIR\r\n\r\nThis meta-paper helped me understand how to make 2nd order peak/notch filters:\r\nhttps://web.archive.org/web/20170706085655/https://www.thesounddesign.com/MIO/EQ-Coefficients.pdf\r\n\r\nBeepBox originally used simpler low-pass filters that I adapted from SFXR:\r\nhttps://www.drpetter.se/project_sfxr.html\r\nFor low cutoff frequencies, the simpler filters and the Butterworth filters are\r\nnearly identical, but when closer to the nyquist frequency the simpler filters\r\ncreate extra resonance.\r\n*/\r\n\r\nexport class FilterCoefficients {\r\n\tpublic readonly a: number[] = [1.0]; // output coefficients (negated, keep a[0]=1)\r\n\tpublic readonly b: number[] = [1.0]; // input coefficients\r\n\tpublic order: number = 0;\r\n\t\r\n\tpublic linearGain0thOrder(linearGain: number): void {\r\n\t\t//a[0] = 1.0; // a0 should always be normalized to 1.0, no need to assign it directly.\r\n\t\tthis.b[0] = linearGain;\r\n\t\tthis.order = 0;\r\n\t}\r\n\t\r\n\tpublic lowPass1stOrderButterworth(cornerRadiansPerSample: number): void {\r\n\t\t// First-order Butterworth low-pass filter according to:\r\n\t\t// https://www.researchgate.net/publication/338022014_Digital_Implementation_of_Butterworth_First-Order_Filter_Type_IIR\r\n\t\t// A butterworth filter is one where the amplitude response is equal to:\r\n\t\t// 1 / (1 + (freq / cutoffFreq)^(2 * order))\r\n\t\tconst g: number = 1.0 / Math.tan(cornerRadiansPerSample * 0.5);\r\n\t\tconst a0: number = 1.0 + g;\r\n\t\tthis.a[1] = (1.0 - g) / a0;\r\n\t\tthis.b[1] = this.b[0] = 1 / a0;\r\n\t\tthis.order = 1;\r\n\t}\r\n\t\r\n\tpublic lowPass1stOrderSimplified(cornerRadiansPerSample: number): void {\r\n\t\t// The output of this filter is nearly identical to the 1st order\r\n\t\t// Butterworth low-pass above, except if the cutoff is set to nyquist/3,\r\n\t\t// then the output is the same as the input, and if the cutoff is higher\r\n\t\t// than that, then the output actually resonates at high frequencies\r\n\t\t// instead of attenuating.\r\n\t\t// I'm guessing this filter was converted from analog to digital using\r\n\t\t// the \"matched z-transform\" method instead of the \"bilinear transform\"\r\n\t\t// method. The difference is that the bilinear transform warps\r\n\t\t// frequencies so that the lowpass response of zero at analogue hz maps\r\n\t\t// to the digital nyquist frequency, whereas the matched z-transform\r\n\t\t// preserves the frequency of the filter response but also adds the\r\n\t\t// reflected response from above the nyquist frequency.\r\n\t\tconst g: number = 2.0 * Math.sin(cornerRadiansPerSample * 0.5);\r\n\t\tthis.a[1] = g - 1.0;\r\n\t\tthis.b[0] = g;\r\n\t\tthis.b[1] = 0.0;\r\n\t\t/*\r\n\t\t// Alternatively:\r\n\t\tconst g: number = 1.0 / (2.0 * Math.sin(cornerRadiansPerSample / 2));\r\n\t\tconst a0: number = g;\r\n\t\tthis.a[1] = (1.0 - g) / a0;\r\n\t\tthis.b[0] = 1.0 / a0;\r\n\t\tthis.b[1] = 0.0 / a0;\r\n\t\t*/\r\n\t\tthis.order = 1;\r\n\t}\r\n\t\r\n\tpublic highPass1stOrderButterworth(cornerRadiansPerSample: number): void {\r\n\t\t// First-order Butterworth high-pass filter according to:\r\n\t\t// https://www.researchgate.net/publication/338022014_Digital_Implementation_of_Butterworth_First-Order_Filter_Type_IIR\r\n\t\tconst g: number = 1.0 / Math.tan(cornerRadiansPerSample * 0.5);\r\n\t\tconst a0: number = 1.0 + g;\r\n\t\tthis.a[1] = (1.0 - g) / a0;\r\n\t\tthis.b[0] = g / a0;\r\n\t\tthis.b[1] = -g / a0;\r\n\t\tthis.order = 1;\r\n\t}\r\n\t/*\r\n\tpublic highPass1stOrderSimplified(cornerRadiansPerSample: number): void {\r\n\t\t// The output of this filter is nearly identical to the 1st order\r\n\t\t// Butterworth high-pass above, except it resonates when the cutoff\r\n\t\t// appoaches the nyquist.\r\n\t\tconst g: number = 2.0 * Math.sin(cornerRadiansPerSample * 0.5);\r\n\t\tthis.a[1] = g - 1.0;\r\n\t\tthis.b[0] = 1.0;\r\n\t\tthis.b[1] = -1.0;\r\n\t\tthis.order = 1;\r\n\t}\r\n\t*/\r\n\tpublic highShelf1stOrder(cornerRadiansPerSample: number, shelfLinearGain: number): void {\r\n\t\t// I had trouble figuring this one out because I couldn't find any\r\n\t\t// online algorithms that I understood. There are 3 degrees of freedom\r\n\t\t// and I could narrow down a couple of them based on the desired gain at\r\n\t\t// DC and nyquist, but getting the cutoff frequency correct took a\r\n\t\t// little bit of trial and error in my attempts to interpret page 53 of\r\n\t\t// this chapter: http://www.music.mcgill.ca/~ich/classes/FiltersChap2.pdf\r\n\t\t// Obviously I don't fully understand the bilinear transform yet!\r\n\t\tconst tan: number = Math.tan(cornerRadiansPerSample * 0.5);\r\n\t\tconst sqrtGain: number = Math.sqrt(shelfLinearGain);\r\n\t\tconst g: number = (tan * sqrtGain - 1) / (tan * sqrtGain + 1.0);\r\n\t\tconst a0: number = 1.0;\r\n\t\tthis.a[1] = g / a0;\r\n\t\tthis.b[0] = (1.0 + g + shelfLinearGain * (1.0 - g)) / (2.0 * a0);\r\n\t\tthis.b[1] = (1.0 + g - shelfLinearGain * (1.0 - g)) / (2.0 * a0);\r\n\t\tthis.order = 1;\r\n\t}\r\n\t\r\n\tpublic allPass1stOrderInvertPhaseAbove(cornerRadiansPerSample: number): void {\r\n\t\tconst g: number = (Math.sin(cornerRadiansPerSample) - 1.0) / Math.cos(cornerRadiansPerSample);\r\n\t\tthis.a[1] = g;\r\n\t\tthis.b[0] = g;\r\n\t\tthis.b[1] = 1.0;\r\n\t\tthis.order = 1;\r\n\t}\r\n\t\r\n\t/*\r\n\t// I haven't found a practical use for this version of the all pass filter.\r\n\t// It seems to create a weird subharmonic when used in a delay feedback loop.\r\n\tpublic allPass1stOrderInvertPhaseBelow(cornerRadiansPerSample: number): void {\r\n\t\tconst g: number = (Math.sin(cornerRadiansPerSample) - 1.0) / Math.cos(cornerRadiansPerSample);\r\n\t\tthis.a[1] = g;\r\n\t\tthis.b[0] = -g;\r\n\t\tthis.b[1] = -1.0;\r\n\t\tthis.order = 1;\r\n\t}\r\n\t*/\r\n\t\r\n\tpublic allPass1stOrderFractionalDelay(delay: number) {\r\n\t\t// Very similar to allPass1stOrderInvertPhaseAbove, but configured\r\n\t\t// differently and for a different purpose! Useful for interpolating\r\n\t\t// between samples in a delay line.\r\n\t\tconst g: number = (1.0 - delay) / (1.0 + delay);\r\n\t\tthis.a[1] = g;\r\n\t\tthis.b[0] = g;\r\n\t\tthis.b[1] = 1.0;\r\n\t\tthis.order = 1;\r\n\t}\r\n\t\r\n\tpublic lowPass2ndOrderButterworth(cornerRadiansPerSample: number, peakLinearGain: number): void {\r\n\t\t// This is Butterworth if peakLinearGain=1/2 according to:\r\n\t\t// http://web.archive.org/web/20191213120120/https://crypto.stanford.edu/~blynn/sound/analog.html\r\n\t\t// An interesting property is that if peakLinearGain=1/16 then the\r\n\t\t// output resembles a first-order lowpass at a cutoff 4 octaves lower,\r\n\t\t// although it gets distorted near the nyquist.\r\n\t\tconst alpha: number = Math.sin(cornerRadiansPerSample) / (2.0 * peakLinearGain);\r\n\t\tconst cos: number = Math.cos(cornerRadiansPerSample);\r\n\t\tconst a0: number = 1.0 + alpha;\r\n\t\tthis.a[1] = -2.0*cos / a0;\r\n\t\tthis.a[2] = (1 - alpha) / a0;\r\n\t\tthis.b[2] = this.b[0] = (1 - cos) / (2.0*a0);\r\n\t\tthis.b[1] = (1 - cos) / a0;\r\n\t\tthis.order = 2;\r\n\t}\r\n\t\r\n\tpublic lowPass2ndOrderSimplified(cornerRadiansPerSample: number, peakLinearGain: number): void {\r\n\t\t// This filter is adapted from the one in the SFXR source code:\r\n\t\t// https://www.drpetter.se/project_sfxr.html\r\n\t\t// The output is nearly identical to the resonant Butterworth low-pass\r\n\t\t// above, except it resonates too much when the cutoff appoaches the\r\n\t\t// nyquist. If the resonance is set to zero and the cutoff is set to\r\n\t\t// nyquist/3, then the output is the same as the input.\r\n\t\tconst g: number = 2.0 * Math.sin(cornerRadiansPerSample / 2.0);\r\n\t\tconst filterResonance: number = 1.0 - 1.0 / (2.0 * peakLinearGain);\r\n\t\tconst feedback: number = filterResonance + filterResonance / (1.0 - g);\r\n\t\tthis.a[1] = 2.0*g + (g - 1.0) * g*feedback - 2.0;\r\n\t\tthis.a[2] = (g - 1.0) * (g - g*feedback - 1.0);\r\n\t\tthis.b[0] = g*g;\r\n\t\tthis.b[1] = 0;\r\n\t\tthis.b[2] = 0;\r\n\t\tthis.order = 2;\r\n\t}\r\n\t\r\n\tpublic highPass2ndOrderButterworth(cornerRadiansPerSample: number, peakLinearGain: number): void {\r\n\t\tconst alpha: number = Math.sin(cornerRadiansPerSample) / (2 * peakLinearGain);\r\n\t\tconst cos: number = Math.cos(cornerRadiansPerSample);\r\n\t\tconst a0: number = 1.0 + alpha;\r\n\t\tthis.a[1] = -2.0*cos / a0;\r\n\t\tthis.a[2] = (1.0 - alpha) / a0;\r\n\t\tthis.b[2] = this.b[0] = (1.0 + cos) / (2.0*a0);\r\n\t\tthis.b[1] = -(1.0 + cos) / a0;\r\n\t\tthis.order = 2;\r\n\t}\r\n\t/*\r\n\tpublic highPass2ndOrderSimplified(cornerRadiansPerSample: number, peakLinearGain: number): void {\r\n\t\tconst g: number = 2.0 * Math.sin(cornerRadiansPerSample * 0.5);\r\n\t\tconst filterResonance: number = 1.0 - 1.0 / (2.0 * peakLinearGain);\r\n\t\tconst feedback: number = filterResonance + filterResonance / (1.0 - g);\r\n\t\tthis.a[1] = 2.0*g + (g - 1.0) * g*feedback - 2.0;\r\n\t\tthis.a[2] = (g - 1.0) * (g - g*feedback - 1.0);\r\n\t\tthis.b[0] = 1.0;\r\n\t\tthis.b[1] = -2.0;\r\n\t\tthis.b[2] = 1.0;\r\n\t\tthis.order = 2;\r\n\t}\r\n\t*/\r\n\t\r\n\tpublic highShelf2ndOrder(cornerRadiansPerSample: number, shelfLinearGain: number, slope: number): void {\r\n\t\tconst A: number = Math.sqrt(shelfLinearGain);\r\n\t\tconst c: number = Math.cos(cornerRadiansPerSample);\r\n\t\tconst Aplus: number = A + 1.0;\r\n\t\tconst Aminus: number = A - 1.0;\r\n\t\tconst alpha: number = Math.sin(cornerRadiansPerSample) * 0.5 * Math.sqrt((Aplus / A) * (1.0 / slope - 1.0) + 2.0);\r\n\t\tconst sqrtA2Alpha: number = 2.0 * Math.sqrt(A) * alpha;\r\n\t\tconst a0: number =   (Aplus  - Aminus * c + sqrtA2Alpha);\r\n\t\tthis.a[1] =  2 *     (Aminus - Aplus  * c              ) / a0;\r\n\t\tthis.a[2] =          (Aplus  - Aminus * c - sqrtA2Alpha) / a0;\r\n\t\tthis.b[0] =      A * (Aplus  + Aminus * c + sqrtA2Alpha) / a0;\r\n\t\tthis.b[1] = -2 * A * (Aminus + Aplus  * c              ) / a0;\r\n\t\tthis.b[2] =      A * (Aplus  + Aminus * c - sqrtA2Alpha) / a0;\r\n\t\tthis.order = 2;\r\n\t}\r\n\t\r\n\tpublic peak2ndOrder(cornerRadiansPerSample: number, peakLinearGain: number, bandWidthScale: number): void {\r\n\t\tconst sqrtGain: number = Math.sqrt(peakLinearGain);\r\n\t\tconst bandWidth: number = bandWidthScale * cornerRadiansPerSample / (sqrtGain >= 1 ? sqrtGain : 1/sqrtGain);\r\n\t\t//const bandWidth: number = bandWidthScale * cornerRadiansPerSample / Math.max(sqrtGain, 1.0);\r\n\t\tconst alpha: number = Math.tan(bandWidth * 0.5);\r\n\t\tconst a0: number = 1.0 + alpha / sqrtGain;\r\n\t\tthis.b[0] = (1.0 + alpha * sqrtGain) / a0;\r\n\t\tthis.b[1] = this.a[1] = -2.0 * Math.cos(cornerRadiansPerSample) / a0;\r\n\t\tthis.b[2] = (1.0 - alpha * sqrtGain) / a0;\r\n\t\tthis.a[2] = (1.0 - alpha / sqrtGain) / a0;\r\n\t\tthis.order = 2;\r\n\t}\r\n\t/*\r\n\t// Create a higher order filter by combining two lower order filters.\r\n\t// However, making high order filters in this manner results in instability.\r\n\t// It is recommended to apply the 2nd order filters (biquads) in sequence instead.\r\n\tpublic combination(filter1: FilterCoefficients, filter2: FilterCoefficients): void {\r\n\t\tthis.order = filter1.order + filter2.order;\r\n\t\tfor (let i: number = 0; i <= this.order; i++) {\r\n\t\t\tthis.a[i] = 0.0;\r\n\t\t\tthis.b[i] = 0.0;\r\n\t\t}\r\n\t\tfor (let i: number = 0; i <= filter1.order; i++) {\r\n\t\t\tfor (let j: number = 0; j <= filter2.order; j++) {\r\n\t\t\t\tthis.a[i + j] += filter1.a[i] * filter2.a[j];\r\n\t\t\t\tthis.b[i + j] += filter1.b[i] * filter2.b[j];\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\t\r\n\tpublic scaledDifference(other: FilterCoefficients, scale: number): void {\r\n\t\tif (other.order != this.order) throw new Error();\r\n\t\tfor (let i: number = 0; i <= this.order; i++) {\r\n\t\t\tthis.a[i] = (this.a[i] - other.a[i]) * scale;\r\n\t\t\tthis.b[i] = (this.b[i] - other.b[i]) * scale;\r\n\t\t}\r\n\t}\r\n\t\r\n\tpublic copy(other: FilterCoefficients): void {\r\n\t\tthis.order = other.order;\r\n\t\tfor (let i: number = 0; i <= this.order; i++) {\r\n\t\t\tthis.a[i] = other.a[i];\r\n\t\t\tthis.b[i] = other.b[i];\r\n\t\t}\r\n\t}\r\n\t*/\r\n}\r\n\r\nexport class FrequencyResponse {\r\n\tpublic real: number = 0.0;\r\n\tpublic imag: number = 0.0;\r\n\tpublic denom: number = 1.0;\r\n\t\r\n\tpublic analyze(filter: FilterCoefficients, radiansPerSample: number): void {\r\n\t\tthis.analyzeComplex(filter, Math.cos(radiansPerSample), Math.sin(radiansPerSample));\r\n\t}\r\n\t\r\n\tpublic analyzeComplex(filter: FilterCoefficients, real: number, imag: number): void {\r\n\t\tconst a: number[] = filter.a;\r\n\t\tconst b: number[] = filter.b;\r\n\t\tconst realZ1: number = real;\r\n\t\tconst imagZ1: number = -imag;\r\n\t\tlet realNum: number = b[0] + b[1] * realZ1;\r\n\t\tlet imagNum: number = b[1] * imagZ1;\r\n\t\tlet realDenom: number = 1.0 + a[1] * realZ1;\r\n\t\tlet imagDenom: number = a[1] * imagZ1;\r\n\t\tlet realZ: number = realZ1;\r\n\t\tlet imagZ: number = imagZ1;\r\n\t\tfor (let i: number = 2; i <= filter.order; i++) {\r\n\t\t\tconst realTemp: number = realZ * realZ1 - imagZ * imagZ1;\r\n\t\t\tconst imagTemp: number = realZ * imagZ1 + imagZ * realZ1;\r\n\t\t\trealZ = realTemp;\r\n\t\t\timagZ = imagTemp;\r\n\t\t\trealNum += b[i] * realZ;\r\n\t\t\timagNum += b[i] * imagZ;\r\n\t\t\trealDenom += a[i] * realZ;\r\n\t\t\timagDenom += a[i] * imagZ;\r\n\t\t}\r\n\t\tthis.denom = realDenom * realDenom + imagDenom * imagDenom;\r\n\t\tthis.real = realNum * realDenom + imagNum * imagDenom;\r\n\t\tthis.imag = imagNum * realDenom - realNum * imagDenom;\r\n\t}\r\n\t\r\n\tpublic magnitude(): number {\r\n\t\treturn Math.sqrt(this.real * this.real + this.imag * this.imag) / this.denom;\r\n\t}\r\n\t\r\n\tpublic angle(): number {\r\n\t\treturn Math.atan2(this.imag, this.real);\r\n\t}\r\n}\r\n\r\nexport class DynamicBiquadFilter {\r\n\tpublic a1: number = 0.0;\r\n\tpublic a2: number = 0.0;\r\n\tpublic b0: number = 1.0;\r\n\tpublic b1: number = 0.0;\r\n\tpublic b2: number = 0.0;\r\n\tpublic a1Delta: number = 0.0;\r\n\tpublic a2Delta: number = 0.0;\r\n\tpublic b0Delta: number = 0.0;\r\n\tpublic b1Delta: number = 0.0;\r\n\tpublic b2Delta: number = 0.0;\r\n\tpublic output1: number = 0.0;\r\n\tpublic output2: number = 0.0;\r\n\t\r\n\t// Some filter types are more stable when interpolating between coefficients\r\n\t// if the \"b\" coefficient interpolation is multiplicative. Don't enable this\r\n\t// for filter types where the \"b\" coefficients might change sign!\r\n\tpublic useMultiplicativeInputCoefficients: boolean = false;\r\n\t\r\n\tpublic resetOutput(): void {\r\n\t\tthis.output1 = 0.0;\r\n\t\tthis.output2 = 0.0;\r\n\t}\r\n\t\r\n\tpublic loadCoefficientsWithGradient(start: FilterCoefficients, end: FilterCoefficients, deltaRate: number, useMultiplicativeInputCoefficients: boolean): void {\r\n\t\tif (start.order != 2 || end.order != 2) throw new Error();\r\n\t\tthis.a1 = start.a[1];\r\n\t\tthis.a2 = start.a[2];\r\n\t\tthis.b0 = start.b[0];\r\n\t\tthis.b1 = start.b[1];\r\n\t\tthis.b2 = start.b[2];\r\n\t\tthis.a1Delta = (end.a[1] - start.a[1]) * deltaRate;\r\n\t\tthis.a2Delta = (end.a[2] - start.a[2]) * deltaRate;\r\n\t\tif (useMultiplicativeInputCoefficients) {\r\n\t\t\tthis.b0Delta = Math.pow(end.b[0] / start.b[0], deltaRate);\r\n\t\t\tthis.b1Delta = Math.pow(end.b[1] / start.b[1], deltaRate);\r\n\t\t\tthis.b2Delta = Math.pow(end.b[2] / start.b[2], deltaRate);\r\n\t\t} else {\r\n\t\t\tthis.b0Delta = (end.b[0] - start.b[0]) * deltaRate;\r\n\t\t\tthis.b1Delta = (end.b[1] - start.b[1]) * deltaRate;\r\n\t\t\tthis.b2Delta = (end.b[2] - start.b[2]) * deltaRate;\r\n\t\t}\r\n\t\tthis.useMultiplicativeInputCoefficients = useMultiplicativeInputCoefficients;\r\n\t}\r\n}\r\n\r\n// Filters are typically designed as analog filters first, then converted to\r\n// digital filters using one of two methods: the \"matched z-transform\" or the\r\n// \"bilinear transform\". The \"bilinear transform\" does a better job of\r\n// preserving the magnitudes of the frequency response, but warps the frequency\r\n// range such that the nyquist frequency of the digital filter () maps to the\r\n// infinity frequency of the analog filter. You can use the below functions to\r\n// manually perform this warping in either direction.\r\nexport function warpNyquistToInfinity(radians: number): number {\r\n\treturn 2.0 * Math.tan(radians * 0.5);\r\n}\r\nexport function warpInfinityToNyquist(radians: number): number {\r\n\treturn 2.0 * Math.atan(radians * 0.5);\r\n}\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nimport {Dictionary, DictionaryArray, FilterType, SustainType, EnvelopeType, InstrumentType, EffectType, EnvelopeComputeIndex, Transition, Unison, Chord, Vibrato, Envelope, AutomationTarget, Config, getDrumWave, drawNoiseSpectrum, getArpeggioPitchIndex, performIntegral, getPulseWidthRatio, effectsIncludeTransition, effectsIncludeChord, effectsIncludePitchShift, effectsIncludeDetune, effectsIncludeVibrato, effectsIncludeNoteFilter, effectsIncludeDistortion, effectsIncludeBitcrusher, effectsIncludePanning, effectsIncludeChorus, effectsIncludeEcho, effectsIncludeReverb} from \"./SynthConfig\";\r\nimport {scaleElementsByFactor, inverseRealFourierTransform} from \"./FFT\";\r\nimport {Deque} from \"./Deque\";\r\nimport {FilterCoefficients, FrequencyResponse, DynamicBiquadFilter, warpInfinityToNyquist} from \"./filtering\";\r\n\r\ndeclare global {\r\n\tinterface Window {\r\n\t\tAudioContext: any;\r\n\t\twebkitAudioContext: any;\r\n\t}\r\n}\r\n\r\nconst epsilon: number = (1.0e-24); // For detecting and avoiding float denormals, which have poor performance.\r\n\r\n// For performance debugging:\r\n//let samplesAccumulated: number = 0;\r\n//let samplePerformance: number = 0;\r\n\r\nexport function clamp(min: number, max: number, val: number): number {\r\n\tmax = max - 1;\r\n\tif (val <= max) {\r\n\t\tif (val >= min) return val;\r\n\t\telse return min;\r\n\t} else {\r\n\t\treturn max;\r\n\t}\r\n}\r\n\r\nfunction validateRange(min: number, max: number, val: number): number {\r\n\tif (min <= val && val <= max) return val;\r\n\tthrow new Error(`Value ${val} not in range [${min}, ${max}]`);\r\n}\r\n\r\nconst enum CharCode {\r\n\tSPACE = 32,\r\n\tHASH = 35,\r\n\tPERCENT = 37,\r\n\tAMPERSAND = 38,\r\n\tPLUS = 43,\r\n\tDASH = 45,\r\n\tDOT = 46,\r\n\tNUM_0 = 48,\r\n\tNUM_1 = 49,\r\n\tNUM_2 = 50,\r\n\tNUM_3 = 51,\r\n\tNUM_4 = 52,\r\n\tNUM_5 = 53,\r\n\tNUM_6 = 54,\r\n\tNUM_7 = 55,\r\n\tNUM_8 = 56,\r\n\tNUM_9 = 57,\r\n\tEQUALS = 61,\r\n\tA =  65,\r\n\tB =  66,\r\n\tC =  67,\r\n\tD =  68,\r\n\tE =  69,\r\n\tF =  70,\r\n\tG =  71,\r\n\tH =  72,\r\n\tI =  73,\r\n\tJ =  74,\r\n\tK =  75,\r\n\tL =  76,\r\n\tM =  77,\r\n\tN =  78,\r\n\tO =  79,\r\n\tP =  80,\r\n\tQ =  81,\r\n\tR =  82,\r\n\tS =  83,\r\n\tT =  84,\r\n\tU =  85,\r\n\tV =  86,\r\n\tW =  87,\r\n\tX =  88,\r\n\tY =  89,\r\n\tZ =  90,\r\n\tUNDERSCORE = 95,\r\n\ta =  97,\r\n\tb =  98,\r\n\tc =  99,\r\n\td = 100,\r\n\te = 101,\r\n\tf = 102,\r\n\tg = 103,\r\n\th = 104,\r\n\ti = 105,\r\n\tj = 106,\r\n\tk = 107,\r\n\tl = 108,\r\n\tm = 109,\r\n\tn = 110,\r\n\to = 111,\r\n\tp = 112,\r\n\tq = 113,\r\n\tr = 114,\r\n\ts = 115,\r\n\tt = 116,\r\n\tu = 117,\r\n\tv = 118,\r\n\tw = 119,\r\n\tx = 120,\r\n\ty = 121,\r\n\tz = 122,\r\n\tLEFT_CURLY_BRACE = 123,\r\n\tRIGHT_CURLY_BRACE = 125,\r\n}\r\n\r\nconst enum SongTagCode {\r\n\tbeatCount           = CharCode.a, // added in BeepBox URL version 2\r\n\tbars                = CharCode.b, // added in BeepBox URL version 2\r\n\tvibrato             = CharCode.c, // added in BeepBox URL version 2, DEPRECATED\r\n\tfadeInOut           = CharCode.d, // added in BeepBox URL version 3 for transition, switched to fadeInOut in 9\r\n\tloopEnd             = CharCode.e, // added in BeepBox URL version 2\r\n\teqFilter            = CharCode.f, // added in BeepBox URL version 3\r\n\tbarCount            = CharCode.g, // added in BeepBox URL version 3\r\n\tunison              = CharCode.h, // added in BeepBox URL version 2\r\n\tinstrumentCount     = CharCode.i, // added in BeepBox URL version 3\r\n\tpatternCount        = CharCode.j, // added in BeepBox URL version 3\r\n\tkey                 = CharCode.k, // added in BeepBox URL version 2\r\n\tloopStart           = CharCode.l, // added in BeepBox URL version 2\r\n\treverb              = CharCode.m, // added in BeepBox URL version 5, DEPRECATED\r\n\tchannelCount        = CharCode.n, // added in BeepBox URL version 6\r\n\tchannelOctave       = CharCode.o, // added in BeepBox URL version 3\r\n\tpatterns            = CharCode.p, // added in BeepBox URL version 2\r\n\teffects             = CharCode.q, // added in BeepBox URL version 7\r\n\trhythm              = CharCode.r, // added in BeepBox URL version 2\r\n\tscale               = CharCode.s, // added in BeepBox URL version 2\r\n\ttempo               = CharCode.t, // added in BeepBox URL version 2\r\n\tpreset              = CharCode.u, // added in BeepBox URL version 7\r\n\tvolume              = CharCode.v, // added in BeepBox URL version 2\r\n\twave                = CharCode.w, // added in BeepBox URL version 2\r\n\tsupersaw            = CharCode.x, // added in BeepBox URL version 9\r\n\tfilterResonance     = CharCode.y, // added in BeepBox URL version 7, DEPRECATED\r\n\tdrumsetEnvelopes    = CharCode.z, // added in BeepBox URL version 7 for filter envelopes, still used for drumset envelopes\r\n\talgorithm           = CharCode.A, // added in BeepBox URL version 6\r\n\tfeedbackAmplitude   = CharCode.B, // added in BeepBox URL version 6\r\n\tchord               = CharCode.C, // added in BeepBox URL version 7, DEPRECATED\r\n//\t                    = CharCode.D, // added in JummBox URL version 3(?) for detune, DEPRECATED\r\n\tenvelopes           = CharCode.E, // added in BeepBox URL version 6 for FM operator envelopes, repurposed in 9 for general envelopes.\r\n\tfeedbackType        = CharCode.F, // added in BeepBox URL version 6\r\n//\t                    = CharCode.G, // added in JummBox URL version 3 for arpeggioSpeed, DEPRECATED\r\n\tharmonics           = CharCode.H, // added in BeepBox URL version 7\r\n\tstringSustain       = CharCode.I, // added in BeepBox URL version 9\r\n//\t                    = CharCode.J,\r\n//\t                    = CharCode.K,\r\n\tpan                 = CharCode.L, // added between 8 and 9, DEPRECATED\r\n//\t                    = CharCode.M, // added in JummBox URL version 1(?) for customChipWave\r\n//\t                    = CharCode.N, // added in JummBox URL version 1(?) for songTitle\r\n//\t                    = CharCode.O, // added in JummBox URL version 3(?) for limiterSettings\r\n\toperatorAmplitudes  = CharCode.P, // added in BeepBox URL version 6\r\n\toperatorFrequencies = CharCode.Q, // added in BeepBox URL version 6\r\n//\t                    = CharCode.R, // added in JummBox URL version 4 for operatorWaves\r\n\tspectrum            = CharCode.S, // added in BeepBox URL version 7\r\n\tstartInstrument     = CharCode.T, // added in BeepBox URL version 6\r\n//\t                    = CharCode.U, // added in JummBox URL version 4(?) for channelNames\r\n\tfeedbackEnvelope    = CharCode.V, // added in BeepBox URL version 6, DEPRECATED\r\n\tpulseWidth          = CharCode.W, // added in BeepBox URL version 7\r\n//\t                    = CharCode.X, // added in JummBox URL version 4 for aliases, DEPRECATED\r\n//\t                    = CharCode.Y,\r\n//\t                    = CharCode.Z,\r\n//\t                    = CharCode.NUM_0,\r\n//\t                    = CharCode.NUM_1,\r\n//\t                    = CharCode.NUM_2,\r\n//\t                    = CharCode.NUM_3,\r\n//\t                    = CharCode.NUM_4,\r\n//\t                    = CharCode.NUM_5,\r\n//\t                    = CharCode.NUM_6,\r\n//\t                    = CharCode.NUM_7,\r\n//\t                    = CharCode.NUM_8,\r\n//\t                    = CharCode.NUM_9,\r\n//\t                    = CharCode.DASH,\r\n//\t                    = CharCode.UNDERSCORE,\r\n}\r\n\r\nconst base64IntToCharCode: ReadonlyArray<number> = [48,49,50,51,52,53,54,55,56,57,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,45,95];\r\nconst base64CharCodeToInt: ReadonlyArray<number> = [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,62,62,0,0,1,2,3,4,5,6,7,8,9,0,0,0,0,0,0,0,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,0,0,0,0,63,0,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,0,0,0,0,0]; // 62 could be represented by either \"-\" or \".\" for historical reasons. New songs should use \"-\".\r\n\r\nclass BitFieldReader {\r\n\tprivate _bits: number[] = [];\r\n\tprivate _readIndex: number = 0;\r\n\t\r\n\tconstructor(source: string, startIndex: number, stopIndex: number) {\r\n\t\tfor (let i: number = startIndex; i < stopIndex; i++) {\r\n\t\t\tconst value: number = base64CharCodeToInt[source.charCodeAt(i)];\r\n\t\t\tthis._bits.push((value >> 5) & 0x1);\r\n\t\t\tthis._bits.push((value >> 4) & 0x1);\r\n\t\t\tthis._bits.push((value >> 3) & 0x1);\r\n\t\t\tthis._bits.push((value >> 2) & 0x1);\r\n\t\t\tthis._bits.push((value >> 1) & 0x1);\r\n\t\t\tthis._bits.push( value       & 0x1);\r\n\t\t}\r\n\t}\r\n\t\r\n\tpublic read(bitCount: number): number {\r\n\t\tlet result: number = 0;\r\n\t\twhile (bitCount > 0) {\r\n\t\t\tresult = result << 1;\r\n\t\t\tresult += this._bits[this._readIndex++];\r\n\t\t\tbitCount--;\r\n\t\t}\r\n\t\treturn result;\r\n\t}\r\n\t\r\n\tpublic readLongTail(minValue: number, minBits: number): number {\r\n\t\tlet result: number = minValue;\r\n\t\tlet numBits: number = minBits;\r\n\t\twhile (this._bits[this._readIndex++]) {\r\n\t\t\tresult += 1 << numBits;\r\n\t\t\tnumBits++;\r\n\t\t}\r\n\t\twhile (numBits > 0) {\r\n\t\t\tnumBits--;\r\n\t\t\tif (this._bits[this._readIndex++]) {\r\n\t\t\t\tresult += 1 << numBits;\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn result;\r\n\t}\r\n\t\r\n\tpublic readPartDuration(): number {\r\n\t\treturn this.readLongTail(1, 3);\r\n\t}\r\n\t\r\n\tpublic readLegacyPartDuration(): number {\r\n\t\treturn this.readLongTail(1, 2);\r\n\t}\r\n\t\r\n\tpublic readPinCount(): number {\r\n\t\treturn this.readLongTail(1, 0);\r\n\t}\r\n\t\r\n\tpublic readPitchInterval(): number {\r\n\t\tif (this.read(1)) {\r\n\t\t\treturn -this.readLongTail(1, 3);\r\n\t\t} else {\r\n\t\t\treturn this.readLongTail(1, 3);\r\n\t\t}\r\n\t}\r\n}\r\n\r\nclass BitFieldWriter {\r\n\tprivate _index: number = 0;\r\n\tprivate _bits: number[] = [];\r\n\t\r\n\tpublic clear() {\r\n\t\tthis._index = 0;\r\n\t}\r\n\t\r\n\tpublic write(bitCount: number, value: number): void {\r\n\t\tbitCount--;\r\n\t\twhile (bitCount >= 0) {\r\n\t\t\tthis._bits[this._index++] = (value >>> bitCount) & 1;\r\n\t\t\tbitCount--;\r\n\t\t}\r\n\t}\r\n\t\r\n\tpublic writeLongTail(minValue: number, minBits: number, value: number): void {\r\n\t\tif (value < minValue) throw new Error(\"value out of bounds\");\r\n\t\tvalue -= minValue;\r\n\t\tlet numBits: number = minBits;\r\n\t\twhile (value >= (1 << numBits)) {\r\n\t\t\tthis._bits[this._index++] = 1;\r\n\t\t\tvalue -= 1 << numBits;\r\n\t\t\tnumBits++;\r\n\t\t}\r\n\t\tthis._bits[this._index++] = 0;\r\n\t\twhile (numBits > 0) {\r\n\t\t\tnumBits--;\r\n\t\t\tthis._bits[this._index++] = (value >>> numBits) & 1;\r\n\t\t}\r\n\t}\r\n\t\r\n\tpublic writePartDuration(value: number): void {\r\n\t\tthis.writeLongTail(1, 3, value);\r\n\t}\r\n\t\r\n\tpublic writePinCount(value: number): void {\r\n\t\tthis.writeLongTail(1, 0, value);\r\n\t}\r\n\t\r\n\tpublic writePitchInterval(value: number): void {\r\n\t\tif (value < 0) {\r\n\t\t\tthis.write(1, 1); // sign\r\n\t\t\tthis.writeLongTail(1, 3, -value);\r\n\t\t} else {\r\n\t\t\tthis.write(1, 0); // sign\r\n\t\t\tthis.writeLongTail(1, 3, value);\r\n\t\t}\r\n\t}\r\n\t\r\n\tpublic concat(other: BitFieldWriter): void {\r\n\t\tfor (let i: number = 0; i < other._index; i++) {\r\n\t\t\tthis._bits[this._index++] = other._bits[i];\r\n\t\t}\r\n\t}\r\n\t\r\n\tpublic encodeBase64(buffer: number[]): number[] {\r\n\t\tfor (let i: number = 0; i < this._index; i += 6) {\r\n\t\t\tconst value: number = (this._bits[i] << 5) | (this._bits[i+1] << 4) | (this._bits[i+2] << 3) | (this._bits[i+3] << 2) | (this._bits[i+4] << 1) | this._bits[i+5];\r\n\t\t\tbuffer.push(base64IntToCharCode[value]);\r\n\t\t}\r\n\t\treturn buffer;\r\n\t}\r\n\t\r\n\tpublic lengthBase64(): number {\r\n\t\treturn Math.ceil(this._index / 6);\r\n\t}\r\n}\r\n\r\nexport interface NotePin {\r\n\tinterval: number;\r\n\ttime: number;\r\n\tsize: number;\r\n}\r\n\r\nexport function makeNotePin(interval: number, time: number, size: number): NotePin {\r\n\treturn {interval: interval, time: time, size: size};\r\n}\r\n\r\nexport class Note {\r\n\tpublic pitches: number[];\r\n\tpublic pins: NotePin[];\r\n\tpublic start: number;\r\n\tpublic end: number;\r\n\tpublic continuesLastPattern: boolean;\r\n\t\r\n\tpublic constructor(pitch: number, start: number, end: number, size: number, fadeout: boolean = false) {\r\n\t\tthis.pitches = [pitch];\r\n\t\tthis.pins = [makeNotePin(0, 0, size), makeNotePin(0, end - start, fadeout ? 0 : size)];\r\n\t\tthis.start = start;\r\n\t\tthis.end = end;\r\n\t\tthis.continuesLastPattern = false;\r\n\t}\r\n\t\r\n\tpublic pickMainInterval(): number {\r\n\t\tlet longestFlatIntervalDuration: number = 0;\r\n\t\tlet mainInterval: number = 0;\r\n\t\tfor (let pinIndex: number = 1; pinIndex < this.pins.length; pinIndex++) {\r\n\t\t\tconst pinA: NotePin = this.pins[pinIndex - 1];\r\n\t\t\tconst pinB: NotePin = this.pins[pinIndex];\r\n\t\t\tif (pinA.interval == pinB.interval) {\r\n\t\t\t\tconst duration: number = pinB.time - pinA.time;\r\n\t\t\t\tif (longestFlatIntervalDuration < duration) {\r\n\t\t\t\t\tlongestFlatIntervalDuration = duration;\r\n\t\t\t\t\tmainInterval = pinA.interval;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\tif (longestFlatIntervalDuration == 0) {\r\n\t\t\tlet loudestSize: number = 0;\r\n\t\t\tfor (let pinIndex: number = 0; pinIndex < this.pins.length; pinIndex++) {\r\n\t\t\t\tconst pin: NotePin = this.pins[pinIndex];\r\n\t\t\t\tif (loudestSize < pin.size) {\r\n\t\t\t\t\tloudestSize = pin.size;\r\n\t\t\t\t\tmainInterval = pin.interval;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn mainInterval;\r\n\t}\r\n\t\r\n\tpublic clone(): Note {\r\n\t\tconst newNote: Note = new Note(-1, this.start, this.end, Config.noteSizeMax);\r\n\t\tnewNote.pitches = this.pitches.concat();\r\n\t\tnewNote.pins = [];\r\n\t\tfor (const pin of this.pins) {\r\n\t\t\tnewNote.pins.push(makeNotePin(pin.interval, pin.time, pin.size));\r\n\t\t}\r\n\t\tnewNote.continuesLastPattern = this.continuesLastPattern;\r\n\t\treturn newNote;\r\n\t}\r\n\t\r\n\tpublic getEndPinIndex(part: number): number {\r\n\t\tlet endPinIndex: number;\r\n\t\tfor (endPinIndex = 1; endPinIndex < this.pins.length - 1; endPinIndex++) {\r\n\t\t\tif (this.pins[endPinIndex].time + this.start > part) break;\r\n\t\t}\r\n\t\treturn endPinIndex;\r\n\t}\r\n}\r\n\r\nexport class Pattern {\r\n\tpublic notes: Note[] = [];\r\n\tpublic readonly instruments: number[] = [0];\r\n\t\r\n\tpublic cloneNotes(): Note[] {\r\n\t\tconst result: Note[] = [];\r\n\t\tfor (const note of this.notes) {\r\n\t\t\tresult.push(note.clone());\r\n\t\t}\r\n\t\treturn result;\r\n\t}\r\n\t\r\n\tpublic reset(): void {\r\n\t\tthis.notes.length = 0;\r\n\t\tthis.instruments[0] = 0;\r\n\t\tthis.instruments.length = 1;\r\n\t}\r\n\t\r\n\tpublic toJsonObject(song: Song): any {\r\n\t\tconst noteArray: Object[] = [];\r\n\t\tfor (const note of this.notes) {\r\n\t\t\tconst pointArray: Object[] = [];\r\n\t\t\tfor (const pin of note.pins) {\r\n\t\t\t\tpointArray.push({\r\n\t\t\t\t\t\"tick\": (pin.time + note.start) * Config.rhythms[song.rhythm].stepsPerBeat / Config.partsPerBeat,\r\n\t\t\t\t\t\"pitchBend\": pin.interval,\r\n\t\t\t\t\t\"volume\": Math.round(pin.size * 100 / 3),\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tconst noteObject: any = {\r\n\t\t\t\t\"pitches\": note.pitches,\r\n\t\t\t\t\"points\": pointArray,\r\n\t\t\t};\r\n\t\t\tif (note.start == 0) {\r\n\t\t\t\tnoteObject[\"continuesLastPattern\"] = note.continuesLastPattern;\r\n\t\t\t}\r\n\t\t\tnoteArray.push(noteObject);\r\n\t\t}\r\n\t\t\r\n\t\tconst patternObject: any = {\"notes\": noteArray};\r\n\t\tif (song.patternInstruments) {\r\n\t\t\tpatternObject[\"instruments\"] = this.instruments.map(i => i + 1);\r\n\t\t}\r\n\t\treturn patternObject;\r\n\t}\r\n\t\r\n\tpublic fromJsonObject(patternObject: any, song: Song, channel: Channel, importedPartsPerBeat: number, isNoiseChannel: boolean): void {\r\n\t\tif (song.patternInstruments) {\r\n\t\t\tif (Array.isArray(patternObject[\"instruments\"])) {\r\n\t\t\t\tconst instruments: any[] = patternObject[\"instruments\"];\r\n\t\t\t\tconst instrumentCount: number = clamp(Config.instrumentCountMin, song.getMaxInstrumentsPerPatternForChannel(channel) + 1, instruments.length);\r\n\t\t\t\tfor (let j: number = 0; j < instrumentCount; j++) {\r\n\t\t\t\t\tthis.instruments[j] = clamp(0, channel.instruments.length, (instruments[j] | 0) - 1);\r\n\t\t\t\t}\r\n\t\t\t\tthis.instruments.length = instrumentCount;\r\n\t\t\t} else {\r\n\t\t\t\tthis.instruments[0] = clamp(0, channel.instruments.length, (patternObject[\"instrument\"] | 0) - 1);\r\n\t\t\t\tthis.instruments.length = 1;\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tif (patternObject[\"notes\"] && patternObject[\"notes\"].length > 0) {\r\n\t\t\tconst maxNoteCount: number = Math.min(song.beatsPerBar * Config.partsPerBeat, patternObject[\"notes\"].length >>> 0);\r\n\t\t\t\r\n\t\t\t// TODO: Consider supporting notes specified in any timing order, sorting them and truncating as necessary.\r\n\t\t\tlet tickClock: number = 0;\r\n\t\t\tfor (let j: number = 0; j < patternObject[\"notes\"].length; j++) {\r\n\t\t\t\tif (j >= maxNoteCount) break;\r\n\t\t\t\t\r\n\t\t\t\tconst noteObject = patternObject[\"notes\"][j];\r\n\t\t\t\tif (!noteObject || !noteObject[\"pitches\"] || !(noteObject[\"pitches\"].length >= 1) || !noteObject[\"points\"] || !(noteObject[\"points\"].length >= 2)) {\r\n\t\t\t\t\tcontinue;\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tconst note: Note = new Note(0, 0, 0, 0);\r\n\t\t\t\tnote.pitches = [];\r\n\t\t\t\tnote.pins = [];\r\n\t\t\t\t\r\n\t\t\t\tfor (let k: number = 0; k < noteObject[\"pitches\"].length; k++) {\r\n\t\t\t\t\tconst pitch: number = noteObject[\"pitches\"][k] | 0;\r\n\t\t\t\t\tif (note.pitches.indexOf(pitch) != -1) continue;\r\n\t\t\t\t\tnote.pitches.push(pitch);\r\n\t\t\t\t\tif (note.pitches.length >= Config.maxChordSize) break;\r\n\t\t\t\t}\r\n\t\t\t\tif (note.pitches.length < 1) continue;\r\n\t\t\t\t\r\n\t\t\t\tlet noteClock: number = tickClock;\r\n\t\t\t\tlet startInterval: number = 0;\r\n\t\t\t\tfor (let k: number = 0; k < noteObject[\"points\"].length; k++) {\r\n\t\t\t\t\tconst pointObject: any = noteObject[\"points\"][k];\r\n\t\t\t\t\tif (pointObject == undefined || pointObject[\"tick\"] == undefined) continue;\r\n\t\t\t\t\tconst interval: number = (pointObject[\"pitchBend\"] == undefined) ? 0 : (pointObject[\"pitchBend\"] | 0);\r\n\t\t\t\t\t\r\n\t\t\t\t\tconst time: number = Math.round((+pointObject[\"tick\"]) * Config.partsPerBeat / importedPartsPerBeat);\r\n\t\t\t\t\t\r\n\t\t\t\t\tconst size: number = (pointObject[\"volume\"] == undefined) ? 3 : Math.max(0, Math.min(3, Math.round((pointObject[\"volume\"] | 0) * 3 / 100)));\r\n\t\t\t\t\t\r\n\t\t\t\t\tif (time > song.beatsPerBar * Config.partsPerBeat) continue;\r\n\t\t\t\t\tif (note.pins.length == 0) {\r\n\t\t\t\t\t\tif (time < noteClock) continue;\r\n\t\t\t\t\t\tnote.start = time;\r\n\t\t\t\t\t\tstartInterval = interval;\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tif (time <= noteClock) continue;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tnoteClock = time;\r\n\t\t\t\t\t\r\n\t\t\t\t\tnote.pins.push(makeNotePin(interval - startInterval, time - note.start, size));\r\n\t\t\t\t}\r\n\t\t\t\tif (note.pins.length < 2) continue;\r\n\t\t\t\t\r\n\t\t\t\tnote.end = note.pins[note.pins.length - 1].time + note.start;\r\n\t\t\t\t\r\n\t\t\t\tconst maxPitch: number = isNoiseChannel ? Config.drumCount - 1 : Config.maxPitch;\r\n\t\t\t\tlet lowestPitch: number = maxPitch;\r\n\t\t\t\tlet highestPitch: number = 0;\r\n\t\t\t\tfor (let k: number = 0; k < note.pitches.length; k++) {\r\n\t\t\t\t\tnote.pitches[k] += startInterval;\r\n\t\t\t\t\tif (note.pitches[k] < 0 || note.pitches[k] > maxPitch) {\r\n\t\t\t\t\t\tnote.pitches.splice(k, 1);\r\n\t\t\t\t\t\tk--;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (note.pitches[k] < lowestPitch) lowestPitch = note.pitches[k];\r\n\t\t\t\t\tif (note.pitches[k] > highestPitch) highestPitch = note.pitches[k];\r\n\t\t\t\t}\r\n\t\t\t\tif (note.pitches.length < 1) continue;\r\n\t\t\t\t\r\n\t\t\t\tfor (let k: number = 0; k < note.pins.length; k++) {\r\n\t\t\t\t\tconst pin: NotePin = note.pins[k];\r\n\t\t\t\t\tif (pin.interval + lowestPitch < 0) pin.interval = -lowestPitch;\r\n\t\t\t\t\tif (pin.interval + highestPitch > maxPitch) pin.interval = maxPitch - highestPitch;\r\n\t\t\t\t\tif (k >= 2) {\r\n\t\t\t\t\t\tif (pin.interval == note.pins[k-1].interval &&\r\n\t\t\t\t\t\t\tpin.interval == note.pins[k-2].interval &&\r\n\t\t\t\t\t\t\tpin.size == note.pins[k-1].size &&\r\n\t\t\t\t\t\t\tpin.size == note.pins[k-2].size)\r\n\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\tnote.pins.splice(k-1, 1);\r\n\t\t\t\t\t\t\tk--;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tif (note.start == 0) {\r\n\t\t\t\t\tnote.continuesLastPattern = (noteObject[\"continuesLastPattern\"] === true);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tnote.continuesLastPattern = false;\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tthis.notes.push(note);\r\n\t\t\t\ttickClock = note.end;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport class Operator {\r\n\tpublic frequency: number = 0;\r\n\tpublic amplitude: number = 0;\r\n\t\r\n\tconstructor(index: number) {\r\n\t\tthis.reset(index);\r\n\t}\r\n\t\r\n\tpublic reset(index: number): void {\r\n\t\tthis.frequency = 0;\r\n\t\tthis.amplitude = (index <= 1) ? Config.operatorAmplitudeMax : 0;\r\n\t}\r\n}\r\n\r\nexport class SpectrumWave {\r\n\tpublic spectrum: number[] = [];\r\n\tpublic hash: number = -1;\r\n\t\r\n\tconstructor(isNoiseChannel: boolean) {\r\n\t\tthis.reset(isNoiseChannel);\r\n\t}\r\n\t\r\n\tpublic reset(isNoiseChannel: boolean): void {\r\n\t\tfor (let i: number = 0; i < Config.spectrumControlPoints; i++) {\r\n\t\t\tif (isNoiseChannel) {\r\n\t\t\t\tthis.spectrum[i] = Math.round(Config.spectrumMax * (1 / Math.sqrt(1 + i / 3)));\r\n\t\t\t} else {\r\n\t\t\t\tconst isHarmonic: boolean = i==0 || i==7 || i==11 || i==14 || i==16 || i==18 || i==21 || i==23 || i>=25;\r\n\t\t\t\tthis.spectrum[i] = isHarmonic ? Math.max(0, Math.round(Config.spectrumMax * (1 - i / 30))) : 0;\r\n\t\t\t}\r\n\t\t}\r\n\t\tthis.markCustomWaveDirty();\r\n\t}\r\n\t\r\n\tpublic markCustomWaveDirty(): void {\r\n\t\tconst hashMult: number = Synth.fittingPowerOfTwo(Config.spectrumMax + 2) - 1;\r\n\t\tlet hash: number = 0;\r\n\t\tfor (const point of this.spectrum) hash = ((hash * hashMult) + point) >>> 0;\r\n\t\tthis.hash = hash;\r\n\t}\r\n}\r\n\r\nclass SpectrumWaveState {\r\n\tpublic wave: Float32Array | null = null;\r\n\tprivate _hash: number = -1;\r\n\t\r\n\tpublic getCustomWave(settings: SpectrumWave, lowestOctave: number): Float32Array {\r\n\t\tif (this._hash == settings.hash) return this.wave!;\r\n\t\tthis._hash = settings.hash;\r\n\t\t\r\n\t\tconst waveLength: number = Config.spectrumNoiseLength;\r\n\t\tif (this.wave == null || this.wave.length != waveLength + 1) {\r\n\t\t\tthis.wave = new Float32Array(waveLength + 1);\r\n\t\t}\r\n\t\tconst wave: Float32Array = this.wave;\r\n\t\t\r\n\t\tfor (let i: number = 0; i < waveLength; i++) {\r\n\t\t\twave[i] = 0;\r\n\t\t}\r\n\t\t\r\n\t\tconst highestOctave: number = 14;\r\n\t\tconst falloffRatio: number = 0.25;\r\n\t\t// Nudge the 2/7 and 4/7 control points so that they form harmonic intervals.\r\n\t\tconst pitchTweak: number[] = [0, 1/7, Math.log2(5/4), 3/7, Math.log2(3/2), 5/7, 6/7];\r\n\t\tfunction controlPointToOctave(point: number): number {\r\n\t\t\treturn lowestOctave + Math.floor(point / Config.spectrumControlPointsPerOctave) + pitchTweak[(point + Config.spectrumControlPointsPerOctave) % Config.spectrumControlPointsPerOctave];\r\n\t\t}\r\n\t\t\r\n\t\tlet combinedAmplitude: number = 1;\r\n\t\tfor (let i: number = 0; i < Config.spectrumControlPoints + 1; i++) {\r\n\t\t\tconst value1: number = (i <= 0) ? 0 : settings.spectrum[i - 1];\r\n\t\t\tconst value2: number = (i >= Config.spectrumControlPoints) ? settings.spectrum[Config.spectrumControlPoints - 1] : settings.spectrum[i];\r\n\t\t\tconst octave1: number = controlPointToOctave(i - 1);\r\n\t\t\tlet octave2: number = controlPointToOctave(i);\r\n\t\t\tif (i >= Config.spectrumControlPoints) octave2 = highestOctave + (octave2 - highestOctave) * falloffRatio;\r\n\t\t\tif (value1 == 0 && value2 == 0) continue;\r\n\t\t\t\r\n\t\t\tcombinedAmplitude += 0.02 * drawNoiseSpectrum(wave, waveLength, octave1, octave2, value1 / Config.spectrumMax, value2 / Config.spectrumMax, -0.5);\r\n\t\t}\r\n\t\tif (settings.spectrum[Config.spectrumControlPoints - 1] > 0) {\r\n\t\t\tcombinedAmplitude += 0.02 * drawNoiseSpectrum(wave, waveLength, highestOctave + (controlPointToOctave(Config.spectrumControlPoints) - highestOctave) * falloffRatio, highestOctave, settings.spectrum[Config.spectrumControlPoints - 1] / Config.spectrumMax, 0, -0.5);\r\n\t\t}\r\n\t\t\r\n\t\tinverseRealFourierTransform(wave, waveLength);\r\n\t\tscaleElementsByFactor(wave, 5.0 / (Math.sqrt(waveLength) * Math.pow(combinedAmplitude, 0.75)));\r\n\t\t\r\n\t\t// Duplicate the first sample at the end for easier wrap-around interpolation.\r\n\t\twave[waveLength] = wave[0];\r\n\t\t\r\n\t\treturn wave;\r\n\t}\r\n}\r\n\r\nexport class HarmonicsWave {\r\n\tpublic harmonics: number[] = [];\r\n\tpublic hash: number = -1;\r\n\t\r\n\tconstructor() {\r\n\t\tthis.reset();\r\n\t}\r\n\t\r\n\tpublic reset(): void {\r\n\t\tfor (let i: number = 0; i < Config.harmonicsControlPoints; i++) {\r\n\t\t\tthis.harmonics[i] = 0;\r\n\t\t}\r\n\t\tthis.harmonics[0] = Config.harmonicsMax;\r\n\t\tthis.harmonics[3] = Config.harmonicsMax;\r\n\t\tthis.harmonics[6] = Config.harmonicsMax;\r\n\t\tthis.markCustomWaveDirty();\r\n\t}\r\n\t\r\n\tpublic markCustomWaveDirty(): void {\r\n\t\tconst hashMult: number = Synth.fittingPowerOfTwo(Config.harmonicsMax + 2) - 1;\r\n\t\tlet hash: number = 0;\r\n\t\tfor (const point of this.harmonics) hash = ((hash * hashMult) + point) >>> 0;\r\n\t\tthis.hash = hash;\r\n\t}\r\n}\r\n\r\nclass HarmonicsWaveState {\r\n\tpublic wave: Float32Array | null = null;\r\n\tprivate _hash: number = -1;\r\n\tprivate _generatedForType: InstrumentType;\r\n\t\r\n\tpublic getCustomWave(settings: HarmonicsWave, instrumentType: InstrumentType): Float32Array {\r\n\t\tif (this._hash == settings.hash && this._generatedForType == instrumentType) return this.wave!;\r\n\t\tthis._hash = settings.hash;\r\n\t\tthis._generatedForType = instrumentType;\r\n\t\t\r\n\t\tconst harmonicsRendered: number = (instrumentType == InstrumentType.pickedString) ? Config.harmonicsRenderedForPickedString : Config.harmonicsRendered;\r\n\t\t\r\n\t\tconst waveLength: number = Config.harmonicsWavelength;\r\n\t\tconst retroWave: Float32Array = getDrumWave(0, null, null);\r\n\t\t\r\n\t\tif (this.wave == null || this.wave.length != waveLength + 1) {\r\n\t\t\tthis.wave = new Float32Array(waveLength + 1);\r\n\t\t}\r\n\t\tconst wave: Float32Array = this.wave;\r\n\t\t\r\n\t\tfor (let i: number = 0; i < waveLength; i++) {\r\n\t\t\twave[i] = 0;\r\n\t\t}\r\n\t\t\r\n\t\tconst overallSlope: number = -0.25;\r\n\t\tlet combinedControlPointAmplitude: number = 1;\r\n\t\t\r\n\t\tfor (let harmonicIndex: number = 0; harmonicIndex < harmonicsRendered; harmonicIndex++) {\r\n\t\t\tconst harmonicFreq: number = harmonicIndex + 1;\r\n\t\t\tlet controlValue: number = harmonicIndex < Config.harmonicsControlPoints ? settings.harmonics[harmonicIndex] : settings.harmonics[Config.harmonicsControlPoints - 1];\r\n\t\t\tif (harmonicIndex >= Config.harmonicsControlPoints) {\r\n\t\t\t\tcontrolValue *= 1 - (harmonicIndex - Config.harmonicsControlPoints) / (harmonicsRendered - Config.harmonicsControlPoints);\r\n\t\t\t}\r\n\t\t\tconst normalizedValue: number = controlValue / Config.harmonicsMax;\r\n\t\t\tlet amplitude: number = Math.pow(2, controlValue - Config.harmonicsMax + 1) * Math.sqrt(normalizedValue);\r\n\t\t\tif (harmonicIndex < Config.harmonicsControlPoints) {\r\n\t\t\t\tcombinedControlPointAmplitude += amplitude;\r\n\t\t\t}\r\n\t\t\tamplitude *= Math.pow(harmonicFreq, overallSlope);\r\n\t\t\t\r\n\t\t\t// Multiply all the sine wave amplitudes by 1 or -1 based on the LFSR\r\n\t\t\t// retro wave (effectively random) to avoid egregiously tall spikes.\r\n\t\t\tamplitude *= retroWave[harmonicIndex + 589];\r\n\t\t\t\r\n\t\t\twave[waveLength - harmonicFreq] = amplitude;\r\n\t\t}\r\n\t\t\r\n\t\tinverseRealFourierTransform(wave, waveLength);\r\n\t\t\r\n\t\t// Limit the maximum wave amplitude.\r\n\t\tconst mult: number = 1 / Math.pow(combinedControlPointAmplitude, 0.7);\r\n\t\tfor (let i: number = 0; i < wave.length; i++) wave[i] *= mult;\r\n\t\t\r\n\t\tperformIntegral(wave);\r\n\t\t\r\n\t\t// The first sample should be zero, and we'll duplicate it at the end for easier interpolation.\r\n\t\twave[waveLength] = wave[0];\r\n\t\t\r\n\t\treturn wave;\r\n\t}\r\n}\r\n\r\nexport class FilterControlPoint {\r\n\tpublic freq: number = 0;\r\n\tpublic gain: number = Config.filterGainCenter;\r\n\tpublic type: FilterType = FilterType.peak;\r\n\t\r\n\tpublic set(freqSetting: number, gainSetting: number): void {\r\n\t\tthis.freq = freqSetting;\r\n\t\tthis.gain = gainSetting;\r\n\t}\r\n\t\r\n\tpublic getHz(): number {\r\n\t\treturn FilterControlPoint.getHzFromSettingValue(this.freq);\r\n\t}\r\n\t\r\n\tpublic static getHzFromSettingValue(value: number): number {\r\n\t\treturn Config.filterFreqReferenceHz * Math.pow(2.0, (value - Config.filterFreqReferenceSetting) * Config.filterFreqStep);\r\n\t}\r\n\tpublic static getSettingValueFromHz(hz: number): number {\r\n\t\treturn Math.log2(hz / Config.filterFreqReferenceHz) / Config.filterFreqStep + Config.filterFreqReferenceSetting;\r\n\t}\r\n\tpublic static getRoundedSettingValueFromHz(hz: number): number {\r\n\t\treturn Math.max(0, Math.min(Config.filterFreqRange - 1, Math.round(FilterControlPoint.getSettingValueFromHz(hz))));\r\n\t}\r\n\t\r\n\tpublic getLinearGain(peakMult: number = 1.0): number {\r\n\t\tconst power: number = (this.gain - Config.filterGainCenter) * Config.filterGainStep;\r\n\t\tconst neutral: number = (this.type == FilterType.peak) ? 0.0 : -0.5;\r\n\t\tconst interpolatedPower: number = neutral + (power - neutral) * peakMult;\r\n\t\treturn Math.pow(2.0, interpolatedPower);\r\n\t}\r\n\tpublic static getRoundedSettingValueFromLinearGain(linearGain: number): number {\r\n\t\treturn Math.max(0, Math.min(Config.filterGainRange - 1, Math.round(Math.log2(linearGain) / Config.filterGainStep + Config.filterGainCenter)));\r\n\t}\r\n\t\r\n\tpublic toCoefficients(filter: FilterCoefficients, sampleRate: number, freqMult: number = 1.0, peakMult: number = 1.0): void {\r\n\t\tconst cornerRadiansPerSample: number = 2.0 * Math.PI * Math.max(Config.filterFreqMinHz, Math.min(Config.filterFreqMaxHz, freqMult * this.getHz())) / sampleRate;\r\n\t\tconst linearGain: number = this.getLinearGain(peakMult);\r\n\t\tswitch (this.type) {\r\n\t\t\tcase FilterType.lowPass:\r\n\t\t\t\tfilter.lowPass2ndOrderButterworth(cornerRadiansPerSample, linearGain);\r\n\t\t\t\tbreak;\r\n\t\t\tcase FilterType.highPass:\r\n\t\t\t\tfilter.highPass2ndOrderButterworth(cornerRadiansPerSample, linearGain);\r\n\t\t\t\tbreak;\r\n\t\t\tcase FilterType.peak:\r\n\t\t\t\tfilter.peak2ndOrder(cornerRadiansPerSample, linearGain, 1.0);\r\n\t\t\t\tbreak;\r\n\t\t\tdefault:\r\n\t\t\t\tthrow new Error();\r\n\t\t}\r\n\t}\r\n\t\r\n\tpublic getVolumeCompensationMult(): number {\r\n\t\tconst octave: number = (this.freq - Config.filterFreqReferenceSetting) * Config.filterFreqStep;\r\n\t\tconst gainPow: number = (this.gain - Config.filterGainCenter) * Config.filterGainStep;\r\n\t\tswitch (this.type) {\r\n\t\t\tcase FilterType.lowPass:\r\n\t\t\t\tconst freqRelativeTo8khz: number = Math.pow(2.0, octave) * Config.filterFreqReferenceHz / 8000.0;\r\n\t\t\t\t// Reverse the frequency warping from importing legacy simplified filters to imitate how the legacy filter cutoff setting affected volume.\r\n\t\t\t\tconst warpedFreq: number = (Math.sqrt(1.0 + 4.0 * freqRelativeTo8khz) - 1.0) / 2.0;\r\n\t\t\t\tconst warpedOctave: number = Math.log2(warpedFreq);\r\n\t\t\t\treturn Math.pow(0.5, 0.2 * Math.max(0.0, gainPow + 1.0) + Math.min(0.0, Math.max(-3.0, 0.595 * warpedOctave + 0.35 * Math.min(0.0, gainPow + 1.0))));\r\n\t\t\tcase FilterType.highPass:\r\n\t\t\t\treturn Math.pow(0.5, 0.125 * Math.max(0.0, gainPow + 1.0) + Math.min(0.0, 0.3 * (-octave - Math.log2(Config.filterFreqReferenceHz / 125.0)) + 0.2 * Math.min(0.0, gainPow + 1.0)));\r\n\t\t\tcase FilterType.peak:\r\n\t\t\t\tconst distanceFromCenter: number = octave + Math.log2(Config.filterFreqReferenceHz / 2000.0);\r\n\t\t\t\tconst freqLoudness: number = Math.pow(1.0 / (1.0 + Math.pow(distanceFromCenter / 3.0, 2.0)), 2.0);\r\n\t\t\t\treturn Math.pow(0.5, 0.125 * Math.max(0.0, gainPow) + 0.1 * freqLoudness * Math.min(0.0, gainPow));\r\n\t\t\tdefault:\r\n\t\t\t\tthrow new Error();\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport class FilterSettings {\r\n\tpublic readonly controlPoints: FilterControlPoint[] = [];\r\n\tpublic controlPointCount: number = 0;\r\n\t\r\n\tconstructor() {\r\n\t\tthis.reset();\r\n\t}\r\n\t\r\n\treset(): void {\r\n\t\tthis.controlPointCount = 0;\r\n\t}\r\n\t\r\n\taddPoint(type: FilterType, freqSetting: number, gainSetting: number): void {\r\n\t\tlet controlPoint: FilterControlPoint;\r\n\t\tif (this.controlPoints.length <= this.controlPointCount) {\r\n\t\t\tcontrolPoint = new FilterControlPoint();\r\n\t\t\tthis.controlPoints[this.controlPointCount] = controlPoint;\r\n\t\t} else {\r\n\t\t\tcontrolPoint = this.controlPoints[this.controlPointCount];\r\n\t\t}\r\n\t\tthis.controlPointCount++;\r\n\t\tcontrolPoint.type = type;\r\n\t\tcontrolPoint.set(freqSetting, gainSetting);\r\n\t}\r\n\t\r\n\tpublic toJsonObject(): Object {\r\n\t\tconst filterArray: any[] = [];\r\n\t\tfor (let i: number = 0; i < this.controlPointCount; i++) {\r\n\t\t\tconst point: FilterControlPoint = this.controlPoints[i];\r\n\t\t\tfilterArray.push({\r\n\t\t\t\t\"type\": Config.filterTypeNames[point.type],\r\n\t\t\t\t\"cutoffHz\": Math.round(point.getHz() * 100) / 100,\r\n\t\t\t\t\"linearGain\": Math.round(point.getLinearGain() * 10000) / 10000,\r\n\t\t\t});\r\n\t\t}\r\n\t\treturn filterArray;\r\n\t}\r\n\t\r\n\tpublic fromJsonObject(filterObject: any): void {\r\n\t\tthis.controlPoints.length = 0;\r\n\t\tif (filterObject) {\r\n\t\t\tfor (const pointObject of filterObject) {\r\n\t\t\t\tconst point: FilterControlPoint = new FilterControlPoint();\r\n\t\t\t\tpoint.type = Config.filterTypeNames.indexOf(pointObject[\"type\"]);\r\n\t\t\t\tif (<any>point.type == -1) point.type = FilterType.peak;\r\n\t\t\t\tif (pointObject[\"cutoffHz\"] != undefined) {\r\n\t\t\t\t\tpoint.freq = FilterControlPoint.getRoundedSettingValueFromHz(pointObject[\"cutoffHz\"]);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tpoint.freq = 0;\r\n\t\t\t\t}\r\n\t\t\t\tif (pointObject[\"linearGain\"] != undefined) {\r\n\t\t\t\t\tpoint.gain = FilterControlPoint.getRoundedSettingValueFromLinearGain(pointObject[\"linearGain\"]);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tpoint.gain = Config.filterGainCenter;\r\n\t\t\t\t}\r\n\t\t\t\tthis.controlPoints.push(point);\r\n\t\t\t}\r\n\t\t}\r\n\t\tthis.controlPointCount = this.controlPoints.length;\r\n\t}\r\n\t\r\n\tpublic convertLegacySettings(legacyCutoffSetting: number, legacyResonanceSetting: number, legacyEnv: Envelope): void {\r\n\t\tthis.reset();\r\n\t\t\r\n\t\tconst legacyFilterCutoffMaxHz: number = 8000; // This was carefully calculated to correspond to no change in response when filtering at 48000 samples per second... when using the legacy simplified low-pass filter.\r\n\t\tconst legacyFilterMax: number = 0.95;\r\n\t\tconst legacyFilterMaxRadians: number = Math.asin(legacyFilterMax / 2.0) * 2.0;\r\n\t\tconst legacyFilterMaxResonance: number = 0.95;\r\n\t\tconst legacyFilterCutoffRange: number = 11;\r\n\t\tconst legacyFilterResonanceRange: number = 8;\r\n\t\t\r\n\t\tconst resonant: boolean = (legacyResonanceSetting > 1);\r\n\t\tconst firstOrder: boolean = (legacyResonanceSetting == 0);\r\n\t\tconst cutoffAtMax: boolean = (legacyCutoffSetting == legacyFilterCutoffRange - 1);\r\n\t\tconst envDecays: boolean = (legacyEnv.type == EnvelopeType.flare || legacyEnv.type == EnvelopeType.twang || legacyEnv.type == EnvelopeType.decay || legacyEnv.type == EnvelopeType.noteSize);\r\n\t\t\r\n\t\tconst standardSampleRate: number = 48000;\r\n\t\tconst legacyHz: number = legacyFilterCutoffMaxHz * Math.pow(2.0, (legacyCutoffSetting - (legacyFilterCutoffRange - 1)) * 0.5);\r\n\t\tconst legacyRadians: number = Math.min(legacyFilterMaxRadians, 2 * Math.PI * legacyHz / standardSampleRate);\r\n\t\t\r\n\t\tif (legacyEnv.type == EnvelopeType.none && !resonant && cutoffAtMax) {\r\n\t\t\t// The response is flat and there's no envelopes, so don't even bother adding any control points.\r\n\t\t} else if (firstOrder) {\r\n\t\t\t// In general, a 1st order lowpass can be approximated by a 2nd order lowpass\r\n\t\t\t// with a cutoff ~4 octaves higher (*16) and a gain of 1/16.\r\n\t\t\t// However, BeepBox's original lowpass filters behaved oddly as they\r\n\t\t\t// approach the nyquist frequency, so I've devised this curved conversion\r\n\t\t\t// to guess at a perceptually appropriate new cutoff frequency and gain.\r\n\t\t\tconst extraOctaves: number = 3.5;\r\n\t\t\tconst targetRadians: number = legacyRadians * Math.pow(2.0, extraOctaves);\r\n\t\t\tconst curvedRadians: number = targetRadians / (1.0 + targetRadians / Math.PI);\r\n\t\t\tconst curvedHz: number = standardSampleRate * curvedRadians / (2.0 * Math.PI)\r\n\t\t\tconst freqSetting: number = FilterControlPoint.getRoundedSettingValueFromHz(curvedHz);\r\n\t\t\tconst finalHz: number = FilterControlPoint.getHzFromSettingValue(freqSetting);\r\n\t\t\tconst finalRadians: number = 2.0 * Math.PI * finalHz / standardSampleRate;\r\n\t\t\t\r\n\t\t\tconst legacyFilter: FilterCoefficients = new FilterCoefficients();\r\n\t\t\tlegacyFilter.lowPass1stOrderSimplified(legacyRadians);\r\n\t\t\tconst response: FrequencyResponse = new FrequencyResponse();\r\n\t\t\tresponse.analyze(legacyFilter, finalRadians);\r\n\t\t\tconst legacyFilterGainAtNewRadians: number = response.magnitude();\r\n\t\t\t\r\n\t\t\tlet logGain: number = Math.log2(legacyFilterGainAtNewRadians);\r\n\t\t\t// Bias slightly toward 2^(-extraOctaves):\r\n\t\t\tlogGain = -extraOctaves + (logGain + extraOctaves) * 0.82;\r\n\t\t\t// Decaying envelopes move the cutoff frequency back into an area where the best approximation of the first order slope requires a lower gain setting.\r\n\t\t\tif (envDecays) logGain = Math.min(logGain, -1.0);\r\n\t\t\tconst convertedGain: number = Math.pow(2.0, logGain);\r\n\t\t\tconst gainSetting: number = FilterControlPoint.getRoundedSettingValueFromLinearGain(convertedGain);\r\n\t\t\t\r\n\t\t\tthis.addPoint(FilterType.lowPass, freqSetting, gainSetting);\r\n\t\t} else {\r\n\t\t\tconst intendedGain: number = 0.5 / (1.0 - legacyFilterMaxResonance * Math.sqrt(Math.max(0.0, legacyResonanceSetting - 1.0) / (legacyFilterResonanceRange - 2.0)));\r\n\t\t\tconst invertedGain: number = 0.5 / intendedGain;\r\n\t\t\tconst maxRadians: number = 2.0 * Math.PI * legacyFilterCutoffMaxHz / standardSampleRate;\r\n\t\t\tconst freqRatio: number = legacyRadians / maxRadians;\r\n\t\t\tconst targetRadians: number = legacyRadians * (freqRatio * Math.pow(invertedGain, 0.9) + 1.0);\r\n\t\t\tconst curvedRadians: number = legacyRadians + (targetRadians - legacyRadians) * invertedGain;\r\n\t\t\tlet curvedHz: number;\r\n\t\t\tif (envDecays) {\r\n\t\t\t\tcurvedHz = standardSampleRate * Math.min(curvedRadians, legacyRadians * Math.pow(2, 0.25)) / (2.0 * Math.PI)\r\n\t\t\t} else {\r\n\t\t\t\tcurvedHz = standardSampleRate * curvedRadians / (2.0 * Math.PI)\r\n\t\t\t}\r\n\t\t\tconst freqSetting: number = FilterControlPoint.getRoundedSettingValueFromHz(curvedHz);\r\n\t\t\t\r\n\t\t\tlet legacyFilterGain: number;\r\n\t\t\tif (envDecays) {\r\n\t\t\t\tlegacyFilterGain = intendedGain;\r\n\t\t\t} else {\r\n\t\t\t\tconst legacyFilter: FilterCoefficients = new FilterCoefficients();\r\n\t\t\t\tlegacyFilter.lowPass2ndOrderSimplified(legacyRadians, intendedGain);\r\n\t\t\t\tconst response: FrequencyResponse = new FrequencyResponse();\r\n\t\t\t\tresponse.analyze(legacyFilter, curvedRadians);\r\n\t\t\t\tlegacyFilterGain = response.magnitude();\r\n\t\t\t}\r\n\t\t\tif (!resonant) legacyFilterGain = Math.min(legacyFilterGain, Math.sqrt(0.5));\r\n\t\t\tconst gainSetting: number = FilterControlPoint.getRoundedSettingValueFromLinearGain(legacyFilterGain);\r\n\t\t\t\r\n\t\t\tthis.addPoint(FilterType.lowPass, freqSetting, gainSetting);\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport class EnvelopeSettings {\r\n\tpublic target: number = 0;\r\n\tpublic index: number = 0;\r\n\tpublic envelope: number = 0;\r\n\t\r\n\tconstructor() {\r\n\t\tthis.reset();\r\n\t}\r\n\t\r\n\treset(): void {\r\n\t\tthis.target = 0;\r\n\t\tthis.index = 0;\r\n\t\tthis.envelope = 0;\r\n\t}\r\n\t\r\n\tpublic toJsonObject(): Object {\r\n\t\tconst envelopeObject: any = {\r\n\t\t\t\"target\": Config.instrumentAutomationTargets[this.target].name,\r\n\t\t\t\"envelope\": Config.envelopes[this.envelope].name,\r\n\t\t};\r\n\t\tif (Config.instrumentAutomationTargets[this.target].maxCount > 1) {\r\n\t\t\tenvelopeObject[\"index\"] = this.index;\r\n\t\t}\r\n\t\treturn envelopeObject;\r\n\t}\r\n\t\r\n\tpublic fromJsonObject(envelopeObject: any): void {\r\n\t\tthis.reset();\r\n\t\t\r\n\t\tlet target: AutomationTarget = Config.instrumentAutomationTargets.dictionary[envelopeObject[\"target\"]];\r\n\t\tif (target == null) target = Config.instrumentAutomationTargets.dictionary[\"noteVolume\"];\r\n\t\tthis.target = target.index;\r\n\t\t\r\n\t\tlet envelope: Envelope = Config.envelopes.dictionary[envelopeObject[\"envelope\"]];\r\n\t\tif (envelope == null) envelope = Config.envelopes.dictionary[\"none\"];\r\n\t\tthis.envelope = envelope.index;\r\n\t\t\r\n\t\tif (envelopeObject[\"index\"] != undefined) {\r\n\t\t\tthis.index = clamp(0, Config.instrumentAutomationTargets[this.target].maxCount, envelopeObject[\"index\"] | 0);\r\n\t\t} else {\r\n\t\t\tthis.index = 0;\r\n\t\t}\r\n\t}\r\n}\r\n\r\n// Settings that were available to old versions of BeepBox but are no longer available in the\r\n// current version that need to be reinterpreted as a group to determine the best way to\r\n// represent them in the current version.\r\ninterface LegacySettings {\r\n\tfilterCutoff?: number;\r\n\tfilterResonance?: number;\r\n\tfilterEnvelope?: Envelope;\r\n\tpulseEnvelope?: Envelope;\r\n\toperatorEnvelopes?: Envelope[];\r\n\tfeedbackEnvelope?: Envelope;\r\n}\r\n\r\nexport class Instrument {\r\n\tpublic type: InstrumentType = InstrumentType.chip;\r\n\tpublic preset: number = 0;\r\n\tpublic chipWave: number = 2;\r\n\tpublic chipNoise: number = 1;\r\n\tpublic eqFilter: FilterSettings = new FilterSettings();\r\n\tpublic noteFilter: FilterSettings = new FilterSettings();\r\n\tpublic envelopes: EnvelopeSettings[] = [];\r\n\tpublic envelopeCount: number = 0;\r\n\tpublic fadeIn: number = 0;\r\n\tpublic fadeOut: number = Config.fadeOutNeutral;\r\n\tpublic transition: number = Config.transitions.dictionary[\"normal\"].index;\r\n\tpublic pitchShift: number = 0;\r\n\tpublic detune: number = 0;\r\n\tpublic vibrato: number = 0;\r\n\tpublic unison: number = 0;\r\n\tpublic effects: number = 0;\r\n\tpublic chord: number = 1;\r\n\tpublic volume: number = 0;\r\n\tpublic pan: number = Config.panCenter;\r\n\tpublic pulseWidth: number = Config.pulseWidthRange - 1;\r\n\tpublic supersawDynamism: number = Config.supersawDynamismMax;\r\n\tpublic supersawSpread: number = Math.ceil(Config.supersawSpreadMax / 2.0);\r\n\tpublic supersawShape: number = 0;\r\n\tpublic stringSustain: number = 10;\r\n\tpublic stringSustainType: SustainType = SustainType.acoustic;\r\n\tpublic distortion: number = 0;\r\n\tpublic bitcrusherFreq: number = 0;\r\n\tpublic bitcrusherQuantization: number = 0;\r\n\tpublic chorus: number = 0;\r\n\tpublic reverb: number = 0;\r\n\tpublic echoSustain: number = 0;\r\n\tpublic echoDelay: number = 0;\r\n\tpublic algorithm: number = 0;\r\n\tpublic feedbackType: number = 0;\r\n\tpublic feedbackAmplitude: number = 0;\r\n\tpublic readonly operators: Operator[] = [];\r\n\tpublic readonly spectrumWave: SpectrumWave;\r\n\tpublic readonly harmonicsWave: HarmonicsWave = new HarmonicsWave();\r\n\tpublic readonly drumsetEnvelopes: number[] = [];\r\n\tpublic readonly drumsetSpectrumWaves: SpectrumWave[] = [];\r\n\t\r\n\tconstructor(isNoiseChannel: boolean) {\r\n\t\tthis.spectrumWave = new SpectrumWave(isNoiseChannel);\r\n\t\tfor (let i: number = 0; i < Config.operatorCount; i++) {\r\n\t\t\tthis.operators[i] = new Operator(i);\r\n\t\t}\r\n\t\tfor (let i: number = 0; i < Config.drumCount; i++) {\r\n\t\t\tthis.drumsetEnvelopes[i] = Config.envelopes.dictionary[\"twang 2\"].index;\r\n\t\t\tthis.drumsetSpectrumWaves[i] = new SpectrumWave(true);\r\n\t\t}\r\n\t}\r\n\t\r\n\tpublic setTypeAndReset(type: InstrumentType, isNoiseChannel: boolean): void {\r\n\t\tthis.type = type;\r\n\t\tthis.preset = type;\r\n\t\tthis.volume = 0;\r\n\t\tthis.effects = 0;\r\n\t\tthis.chorus = Config.chorusRange - 1;\r\n\t\tthis.reverb = 2;\r\n\t\tthis.echoSustain = Math.floor((Config.echoSustainRange - 1) * 0.5);\r\n\t\tthis.echoDelay = Math.floor((Config.echoDelayRange - 1) * 0.5);\r\n\t\tthis.eqFilter.reset();\r\n\t\tthis.noteFilter.reset();\r\n\t\tthis.distortion = Math.floor((Config.distortionRange - 1) * 0.75);\r\n\t\tthis.bitcrusherFreq = Math.floor((Config.bitcrusherFreqRange - 1) * 0.5)\r\n\t\tthis.bitcrusherQuantization = Math.floor((Config.bitcrusherQuantizationRange - 1) * 0.5);\r\n\t\tthis.pan = Config.panCenter;\r\n\t\tthis.pitchShift = Config.pitchShiftCenter;\r\n\t\tthis.detune = Config.detuneCenter;\r\n\t\tthis.vibrato = 0;\r\n\t\tthis.unison = 0;\r\n\t\tthis.stringSustain = 10;\r\n\t\tthis.stringSustainType = Config.enableAcousticSustain ? SustainType.acoustic : SustainType.bright;\r\n\t\tthis.fadeIn = 0;\r\n\t\tthis.fadeOut = Config.fadeOutNeutral;\r\n\t\tthis.transition = Config.transitions.dictionary[\"normal\"].index;\r\n\t\tthis.envelopeCount = 0;\r\n\t\tswitch (type) {\r\n\t\t\tcase InstrumentType.chip:\r\n\t\t\t\tthis.chipWave = 2;\r\n\t\t\t\t// TODO: enable the chord effect?\r\n\t\t\t\tthis.chord = Config.chords.dictionary[\"arpeggio\"].index;\r\n\t\t\t\tbreak;\r\n\t\t\tcase InstrumentType.fm:\r\n\t\t\t\tthis.chord = Config.chords.dictionary[\"custom interval\"].index;\r\n\t\t\t\tthis.algorithm = 0;\r\n\t\t\t\tthis.feedbackType = 0;\r\n\t\t\t\tthis.feedbackAmplitude = 0;\r\n\t\t\t\tfor (let i: number = 0; i < this.operators.length; i++) {\r\n\t\t\t\t\tthis.operators[i].reset(i);\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\t\t\tcase InstrumentType.noise:\r\n\t\t\t\tthis.chipNoise = 1;\r\n\t\t\t\tthis.chord = Config.chords.dictionary[\"arpeggio\"].index;\r\n\t\t\t\tbreak;\r\n\t\t\tcase InstrumentType.spectrum:\r\n\t\t\t\tthis.chord = Config.chords.dictionary[\"simultaneous\"].index;\r\n\t\t\t\tthis.spectrumWave.reset(isNoiseChannel);\r\n\t\t\t\tbreak;\r\n\t\t\tcase InstrumentType.drumset:\r\n\t\t\t\tthis.chord = Config.chords.dictionary[\"simultaneous\"].index;\r\n\t\t\t\tfor (let i: number = 0; i < Config.drumCount; i++) {\r\n\t\t\t\t\tthis.drumsetEnvelopes[i] = Config.envelopes.dictionary[\"twang 2\"].index;\r\n\t\t\t\t\tthis.drumsetSpectrumWaves[i].reset(isNoiseChannel);\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\t\t\tcase InstrumentType.harmonics:\r\n\t\t\t\tthis.chord = Config.chords.dictionary[\"simultaneous\"].index;\r\n\t\t\t\tthis.harmonicsWave.reset();\r\n\t\t\t\tbreak;\r\n\t\t\tcase InstrumentType.pwm:\r\n\t\t\t\tthis.chord = Config.chords.dictionary[\"arpeggio\"].index;\r\n\t\t\t\tthis.pulseWidth = Config.pulseWidthRange - 1;\r\n\t\t\t\tbreak;\r\n\t\t\tcase InstrumentType.pickedString:\r\n\t\t\t\tthis.chord = Config.chords.dictionary[\"strum\"].index;\r\n\t\t\t\tthis.harmonicsWave.reset();\r\n\t\t\t\tbreak;\r\n\t\t\tcase InstrumentType.supersaw:\r\n\t\t\t\tthis.chord = Config.chords.dictionary[\"arpeggio\"].index;\r\n\t\t\t\tthis.supersawDynamism = Config.supersawDynamismMax;\r\n\t\t\t\tthis.supersawSpread = Math.ceil(Config.supersawSpreadMax / 2.0);\r\n\t\t\t\tthis.supersawShape = 0;\r\n\t\t\t\tthis.pulseWidth = Config.pulseWidthRange - 1;\r\n\t\t\t\tbreak;\r\n\t\t\tdefault:\r\n\t\t\t\tthrow new Error(\"Unrecognized instrument type: \" + type);\r\n\t\t}\r\n\t\t// Chip/noise instruments had arpeggio and FM had custom interval but neither\r\n\t\t// explicitly saved the chorus setting beforeSeven so enable it here. The effects\r\n\t\t// will otherwise get overridden when reading SongTagCode.startInstrument.\r\n\t\tif (this.chord != Config.chords.dictionary[\"simultaneous\"].index) {\r\n\t\t\t// Enable chord if it was used.\r\n\t\t\tthis.effects = (this.effects | (1 << EffectType.chord));\r\n\t\t}\r\n\t}\r\n\t\r\n\tpublic convertLegacySettings(legacySettings: LegacySettings): void {\r\n\t\tlet legacyCutoffSetting: number | undefined = legacySettings.filterCutoff;\r\n\t\tlet legacyResonanceSetting: number | undefined = legacySettings.filterResonance;\r\n\t\tlet legacyFilterEnv: Envelope | undefined = legacySettings.filterEnvelope;\r\n\t\tlet legacyPulseEnv: Envelope | undefined = legacySettings.pulseEnvelope;\r\n\t\tlet legacyOperatorEnvelopes: Envelope[] | undefined = legacySettings.operatorEnvelopes;\r\n\t\tlet legacyFeedbackEnv: Envelope | undefined = legacySettings.feedbackEnvelope;\r\n\t\t\r\n\t\t// legacy defaults:\r\n\t\tif (legacyCutoffSetting == undefined) legacyCutoffSetting = (this.type == InstrumentType.chip) ? 6 : 10;\r\n\t\tif (legacyResonanceSetting == undefined) legacyResonanceSetting = 0;\r\n\t\tif (legacyFilterEnv == undefined) legacyFilterEnv = Config.envelopes.dictionary[\"none\"];\r\n\t\tif (legacyPulseEnv == undefined) legacyPulseEnv = Config.envelopes.dictionary[(this.type == InstrumentType.pwm) ? \"twang 2\" : \"none\"];\r\n\t\tif (legacyOperatorEnvelopes == undefined) legacyOperatorEnvelopes = [Config.envelopes.dictionary[(this.type == InstrumentType.fm) ? \"note size\" : \"none\"], Config.envelopes.dictionary[\"none\"], Config.envelopes.dictionary[\"none\"], Config.envelopes.dictionary[\"none\"]];\r\n\t\tif (legacyFeedbackEnv == undefined) legacyFeedbackEnv = Config.envelopes.dictionary[\"none\"];\r\n\t\t\r\n\t\t// The \"punch\" envelope is special: it goes *above* the chosen cutoff. But if the cutoff was already at the max, it couldn't go any higher... except in the current version of BeepBox I raised the max cutoff so it *can* but then it sounds different, so to preserve the original sound let's just remove the punch envelope.\r\n\t\tconst legacyFilterCutoffRange: number = 11;\r\n\t\tconst cutoffAtMax: boolean = (legacyCutoffSetting == legacyFilterCutoffRange - 1);\r\n\t\tif (cutoffAtMax && legacyFilterEnv.type == EnvelopeType.punch) legacyFilterEnv = Config.envelopes.dictionary[\"none\"];\r\n\t\t\r\n\t\tconst carrierCount: number = Config.algorithms[this.algorithm].carrierCount;\r\n\t\tlet noCarriersControlledByNoteSize: boolean = true;\r\n\t\tlet allCarriersControlledByNoteSize: boolean = true;\r\n\t\tlet noteSizeControlsSomethingElse: boolean = (legacyFilterEnv.type == EnvelopeType.noteSize) || (legacyPulseEnv.type == EnvelopeType.noteSize);\r\n\t\tif (this.type == InstrumentType.fm) {\r\n\t\t\tnoteSizeControlsSomethingElse = noteSizeControlsSomethingElse || (legacyFeedbackEnv.type == EnvelopeType.noteSize);\r\n\t\t\tfor (let i: number = 0; i < legacyOperatorEnvelopes.length; i++) {\r\n\t\t\t\tif (i < carrierCount) {\r\n\t\t\t\t\tif (legacyOperatorEnvelopes[i].type != EnvelopeType.noteSize) {\r\n\t\t\t\t\t\tallCarriersControlledByNoteSize = false;\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tnoCarriersControlledByNoteSize = false;\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\tnoteSizeControlsSomethingElse = noteSizeControlsSomethingElse || (legacyOperatorEnvelopes[i].type == EnvelopeType.noteSize);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tthis.envelopeCount = 0;\r\n\t\t\r\n\t\tif (this.type == InstrumentType.fm) {\r\n\t\t\tif (allCarriersControlledByNoteSize && noteSizeControlsSomethingElse) {\r\n\t\t\t\tthis.addEnvelope(Config.instrumentAutomationTargets.dictionary[\"noteVolume\"].index, 0, Config.envelopes.dictionary[\"note size\"].index);\r\n\t\t\t} else if (noCarriersControlledByNoteSize && !noteSizeControlsSomethingElse) {\r\n\t\t\t\tthis.addEnvelope(Config.instrumentAutomationTargets.dictionary[\"none\"].index, 0, Config.envelopes.dictionary[\"note size\"].index);\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tif (legacyFilterEnv.type == EnvelopeType.none) {\r\n\t\t\tthis.noteFilter.reset();\r\n\t\t\tthis.eqFilter.convertLegacySettings(legacyCutoffSetting, legacyResonanceSetting, legacyFilterEnv);\r\n\t\t\tthis.effects &= ~(1 << EffectType.noteFilter);\r\n\t\t} else {\r\n\t\t\tthis.eqFilter.reset();\r\n\t\t\tthis.noteFilter.convertLegacySettings(legacyCutoffSetting, legacyResonanceSetting, legacyFilterEnv);\r\n\t\t\tthis.effects |= 1 << EffectType.noteFilter;\r\n\t\t\tthis.addEnvelope(Config.instrumentAutomationTargets.dictionary[\"noteFilterAllFreqs\"].index, 0, legacyFilterEnv.index);\r\n\t\t}\r\n\t\t\r\n\t\tif (legacyPulseEnv.type != EnvelopeType.none) {\r\n\t\t\tthis.addEnvelope(Config.instrumentAutomationTargets.dictionary[\"pulseWidth\"].index, 0, legacyPulseEnv.index);\r\n\t\t}\r\n\t\t\r\n\t\tfor (let i: number = 0; i < legacyOperatorEnvelopes.length; i++) {\r\n\t\t\tif (i < carrierCount && allCarriersControlledByNoteSize) continue;\r\n\t\t\tif (legacyOperatorEnvelopes[i].type != EnvelopeType.none) {\r\n\t\t\t\tthis.addEnvelope(Config.instrumentAutomationTargets.dictionary[\"operatorAmplitude\"].index, i, legacyOperatorEnvelopes[i].index);\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tif (legacyFeedbackEnv.type != EnvelopeType.none) {\r\n\t\t\tthis.addEnvelope(Config.instrumentAutomationTargets.dictionary[\"feedbackAmplitude\"].index, 0, legacyFeedbackEnv.index);\r\n\t\t}\r\n\t}\r\n\t\r\n\tpublic toJsonObject(): Object {\r\n\t\tconst instrumentObject: any = {\r\n\t\t\t\"type\": Config.instrumentTypeNames[this.type],\r\n\t\t\t\"volume\": (5 - this.volume) * 20,\r\n\t\t\t\"eqFilter\": this.eqFilter.toJsonObject(),\r\n\t\t};\r\n\t\t\r\n\t\tif (this.preset != this.type) {\r\n\t\t\tinstrumentObject[\"preset\"] = this.preset;\r\n\t\t}\r\n\t\t\r\n\t\tconst effects: string[] = [];\r\n\t\tfor (const effect of Config.effectOrder) {\r\n\t\t\tif (this.effects & (1 << effect)) {\r\n\t\t\t\teffects.push(Config.effectNames[effect]);\r\n\t\t\t}\r\n\t\t}\r\n\t\tinstrumentObject[\"effects\"] = effects;\r\n\t\t\r\n\t\t\r\n\t\tif (effectsIncludeTransition(this.effects)) {\r\n\t\t\tinstrumentObject[\"transition\"] = Config.transitions[this.transition].name;\r\n\t\t}\r\n\t\tif (effectsIncludeChord(this.effects)) {\r\n\t\t\tinstrumentObject[\"chord\"] = this.getChord().name;\r\n\t\t}\r\n\t\tif (effectsIncludePitchShift(this.effects)) {\r\n\t\t\tinstrumentObject[\"pitchShiftSemitones\"] = this.pitchShift;\r\n\t\t}\r\n\t\tif (effectsIncludeDetune(this.effects)) {\r\n\t\t\tinstrumentObject[\"detuneCents\"] = Synth.detuneToCents(this.detune - Config.detuneCenter);\r\n\t\t}\r\n\t\tif (effectsIncludeVibrato(this.effects)) {\r\n\t\t\tinstrumentObject[\"vibrato\"] = Config.vibratos[this.vibrato].name;\r\n\t\t}\r\n\t\tif (effectsIncludeNoteFilter(this.effects)) {\r\n\t\t\tinstrumentObject[\"noteFilter\"] = this.noteFilter.toJsonObject();\r\n\t\t}\r\n\t\tif (effectsIncludeDistortion(this.effects)) {\r\n\t\t\tinstrumentObject[\"distortion\"] = Math.round(100 * this.distortion / (Config.distortionRange - 1));\r\n\t\t}\r\n\t\tif (effectsIncludeBitcrusher(this.effects)) {\r\n\t\t\tinstrumentObject[\"bitcrusherOctave\"] = (Config.bitcrusherFreqRange - 1 - this.bitcrusherFreq) * Config.bitcrusherOctaveStep;\r\n\t\t\tinstrumentObject[\"bitcrusherQuantization\"] = Math.round(100 * this.bitcrusherQuantization / (Config.bitcrusherQuantizationRange - 1));\r\n\t\t}\r\n\t\tif (effectsIncludePanning(this.effects)) {\r\n\t\t\tinstrumentObject[\"pan\"] = Math.round(100 * (this.pan - Config.panCenter) / Config.panCenter);\r\n\t\t}\r\n\t\tif (effectsIncludeChorus(this.effects)) {\r\n\t\t\tinstrumentObject[\"chorus\"] = Math.round(100 * this.chorus / (Config.chorusRange - 1));\r\n\t\t}\r\n\t\tif (effectsIncludeEcho(this.effects)) {\r\n\t\t\tinstrumentObject[\"echoSustain\"] = Math.round(100 * this.echoSustain / (Config.echoSustainRange - 1));\r\n\t\t\tinstrumentObject[\"echoDelayBeats\"] = Math.round(1000 * (this.echoDelay + 1) * Config.echoDelayStepTicks / (Config.ticksPerPart * Config.partsPerBeat)) / 1000;\r\n\t\t}\r\n\t\tif (effectsIncludeReverb(this.effects)) {\r\n\t\t\tinstrumentObject[\"reverb\"] = Math.round(100 * this.reverb / (Config.reverbRange - 1));\r\n\t\t}\r\n\t\t\r\n\t\tif (this.type != InstrumentType.drumset) {\r\n\t\t\tinstrumentObject[\"fadeInSeconds\"] = Math.round(10000 * Synth.fadeInSettingToSeconds(this.fadeIn)) / 10000;\r\n\t\t\tinstrumentObject[\"fadeOutTicks\"] = Synth.fadeOutSettingToTicks(this.fadeOut);\r\n\t\t}\r\n\t\t\r\n\t\tif (this.type == InstrumentType.harmonics || this.type == InstrumentType.pickedString) {\r\n\t\t\tinstrumentObject[\"harmonics\"] = [];\r\n\t\t\tfor (let i: number = 0; i < Config.harmonicsControlPoints; i++) {\r\n\t\t\t\tinstrumentObject[\"harmonics\"][i] = Math.round(100 * this.harmonicsWave.harmonics[i] / Config.harmonicsMax);\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tif (this.type == InstrumentType.noise) {\r\n\t\t\tinstrumentObject[\"wave\"] = Config.chipNoises[this.chipNoise].name;\r\n\t\t} else if (this.type == InstrumentType.spectrum) {\r\n\t\t\tinstrumentObject[\"spectrum\"] = [];\r\n\t\t\tfor (let i: number = 0; i < Config.spectrumControlPoints; i++) {\r\n\t\t\t\tinstrumentObject[\"spectrum\"][i] = Math.round(100 * this.spectrumWave.spectrum[i] / Config.spectrumMax);\r\n\t\t\t}\r\n\t\t} else if (this.type == InstrumentType.drumset) {\r\n\t\t\tinstrumentObject[\"drums\"] = [];\r\n\t\t\tfor (let j: number = 0; j < Config.drumCount; j++) {\r\n\t\t\t\tconst spectrum: number[] = [];\r\n\t\t\t\tfor (let i: number = 0; i < Config.spectrumControlPoints; i++) {\r\n\t\t\t\t\tspectrum[i] = Math.round(100 * this.drumsetSpectrumWaves[j].spectrum[i] / Config.spectrumMax);\r\n\t\t\t\t}\r\n\t\t\t\tinstrumentObject[\"drums\"][j] = {\r\n\t\t\t\t\t\"filterEnvelope\": this.getDrumsetEnvelope(j).name,\r\n\t\t\t\t\t\"spectrum\": spectrum,\r\n\t\t\t\t};\r\n\t\t\t}\r\n\t\t} else if (this.type == InstrumentType.chip) {\r\n\t\t\tinstrumentObject[\"wave\"] = Config.chipWaves[this.chipWave].name;\r\n\t\t\tinstrumentObject[\"unison\"] = Config.unisons[this.unison].name;\r\n\t\t} else if (this.type == InstrumentType.pwm) {\r\n\t\t\tinstrumentObject[\"pulseWidth\"] = Math.round(getPulseWidthRatio(this.pulseWidth) * 100 * 100000) / 100000;\r\n\t\t} else if (this.type == InstrumentType.supersaw) {\r\n\t\t\tinstrumentObject[\"pulseWidth\"] = Math.round(getPulseWidthRatio(this.pulseWidth) * 100 * 100000) / 100000;\r\n\t\t\tinstrumentObject[\"dynamism\"] = Math.round(100 * this.supersawDynamism / Config.supersawDynamismMax);\r\n\t\t\tinstrumentObject[\"spread\"] = Math.round(100 * this.supersawSpread / Config.supersawSpreadMax);\r\n\t\t\tinstrumentObject[\"shape\"] = Math.round(100 * this.supersawShape / Config.supersawShapeMax);\r\n\t\t} else if (this.type == InstrumentType.pickedString) {\r\n\t\t\tinstrumentObject[\"unison\"] = Config.unisons[this.unison].name;\r\n\t\t\tinstrumentObject[\"stringSustain\"] = Math.round(100 * this.stringSustain / (Config.stringSustainRange - 1));\r\n\t\t\tif (Config.enableAcousticSustain) {\r\n\t\t\t\tinstrumentObject[\"stringSustainType\"] = Config.sustainTypeNames[this.stringSustainType];\r\n\t\t\t}\r\n\t\t} else if (this.type == InstrumentType.harmonics) {\r\n\t\t\tinstrumentObject[\"unison\"] = Config.unisons[this.unison].name;\r\n\t\t} else if (this.type == InstrumentType.fm) {\r\n\t\t\tconst operatorArray: Object[] = [];\r\n\t\t\tfor (const operator of this.operators) {\r\n\t\t\t\toperatorArray.push({\r\n\t\t\t\t\t\"frequency\": Config.operatorFrequencies[operator.frequency].name,\r\n\t\t\t\t\t\"amplitude\": operator.amplitude,\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t\tinstrumentObject[\"algorithm\"] = Config.algorithms[this.algorithm].name;\r\n\t\t\tinstrumentObject[\"feedbackType\"] = Config.feedbacks[this.feedbackType].name;\r\n\t\t\tinstrumentObject[\"feedbackAmplitude\"] = this.feedbackAmplitude;\r\n\t\t\tinstrumentObject[\"operators\"] = operatorArray;\r\n\t\t} else {\r\n\t\t\tthrow new Error(\"Unrecognized instrument type\");\r\n\t\t}\r\n\t\t\r\n\t\tconst envelopes: any[] = [];\r\n\t\tfor (let i = 0; i < this.envelopeCount; i++) {\r\n\t\t\tenvelopes.push(this.envelopes[i].toJsonObject());\r\n\t\t}\r\n\t\tinstrumentObject[\"envelopes\"] = envelopes;\r\n\t\t\r\n\t\treturn instrumentObject;\r\n\t}\r\n\t\r\n\tpublic fromJsonObject(instrumentObject: any, isNoiseChannel: boolean, legacyGlobalReverb: number = 0): void {\r\n\t\tif (instrumentObject == undefined) instrumentObject = {};\r\n\t\t\r\n\t\tlet type: InstrumentType = Config.instrumentTypeNames.indexOf(instrumentObject[\"type\"]);\r\n\t\tif (<any>type == -1) type = isNoiseChannel ? InstrumentType.noise : InstrumentType.chip;\r\n\t\tthis.setTypeAndReset(type, isNoiseChannel);\r\n\t\t\r\n\t\tif (instrumentObject[\"preset\"] != undefined) {\r\n\t\t\tthis.preset = instrumentObject[\"preset\"] >>> 0;\r\n\t\t}\r\n\t\t\r\n\t\tif (instrumentObject[\"volume\"] != undefined) {\r\n\t\t\tthis.volume = clamp(0, Config.volumeRange, Math.round(5 - (instrumentObject[\"volume\"] | 0) / 20));\r\n\t\t} else {\r\n\t\t\tthis.volume = 0;\r\n\t\t}\r\n\t\t\r\n\t\tif (Array.isArray(instrumentObject[\"effects\"])) {\r\n\t\t\tlet effects: number = 0;\r\n\t\t\tfor (let i: number = 0; i < instrumentObject[\"effects\"].length; i++) {\r\n\t\t\t\teffects = effects | (1 << Config.effectNames.indexOf(instrumentObject[\"effects\"][i]));\r\n\t\t\t}\r\n\t\t\tthis.effects = (effects & ((1 << EffectType.length) - 1));\r\n\t\t} else {\r\n\t\t\t// The index of these names is reinterpreted as a bitfield, which relies on reverb and chorus being the first effects!\r\n\t\t\tconst legacyEffectsNames: string[] = [\"none\", \"reverb\", \"chorus\", \"chorus & reverb\"];\r\n\t\t\tthis.effects = legacyEffectsNames.indexOf(instrumentObject[\"effects\"]);\r\n\t\t\tif (this.effects == -1) this.effects = (this.type == InstrumentType.noise) ? 0 : 1;\r\n\t\t}\r\n\t\t\r\n\t\tthis.transition = Config.transitions.dictionary[\"normal\"].index; // default value.\r\n\t\tconst transitionProperty: any = instrumentObject[\"transition\"] || instrumentObject[\"envelope\"]; // the transition property used to be called envelope, so check that too.\r\n\t\tif (transitionProperty != undefined) {\r\n\t\t\tlet transition: Transition | undefined = Config.transitions.dictionary[transitionProperty];\r\n\t\t\tif (instrumentObject[\"fadeInSeconds\"] == undefined || instrumentObject[\"fadeOutTicks\"] == undefined) {\r\n\t\t\t\tconst legacySettings = (<any>{\r\n\t\t\t\t\t\"binary\":      {transition: \"interrupt\", fadeInSeconds: 0.0,    fadeOutTicks: -1},\r\n\t\t\t\t\t\"seamless\":    {transition: \"interrupt\", fadeInSeconds: 0.0,    fadeOutTicks: -1},\r\n\t\t\t\t\t\"sudden\":      {transition: \"normal\",    fadeInSeconds: 0.0,    fadeOutTicks: -3},\r\n\t\t\t\t\t\"hard\":        {transition: \"normal\",    fadeInSeconds: 0.0,    fadeOutTicks: -3},\r\n\t\t\t\t\t\"smooth\":      {transition: \"normal\",    fadeInSeconds: 0.025,  fadeOutTicks: -3},\r\n\t\t\t\t\t\"soft\":        {transition: \"normal\",    fadeInSeconds: 0.025,  fadeOutTicks: -3},\r\n\t\t\t\t\t// Note that the old slide transition has the same name as a new slide transition that is different.\r\n\t\t\t\t\t// Only apply legacy settings if the instrument JSON was created before, based on the presence\r\n\t\t\t\t\t// of the fade in/out fields.\r\n\t\t\t\t\t\"slide\":       {transition: \"slide in pattern\", fadeInSeconds: 0.025,  fadeOutTicks: -3},\r\n\t\t\t\t\t\"cross fade\":  {transition: \"normal\",    fadeInSeconds: 0.04,   fadeOutTicks:  6},\r\n\t\t\t\t\t\"hard fade\":   {transition: \"normal\",    fadeInSeconds: 0.0,    fadeOutTicks: 48},\r\n\t\t\t\t\t\"medium fade\": {transition: \"normal\",    fadeInSeconds: 0.0125, fadeOutTicks: 72},\r\n\t\t\t\t\t\"soft fade\":   {transition: \"normal\",    fadeInSeconds: 0.06,   fadeOutTicks: 96},\r\n\t\t\t\t})[transitionProperty];\r\n\t\t\t\tif (legacySettings != undefined) {\r\n\t\t\t\t\ttransition = Config.transitions.dictionary[legacySettings.transition];\r\n\t\t\t\t\t// These may be overridden below.\r\n\t\t\t\t\tthis.fadeIn = Synth.secondsToFadeInSetting(legacySettings.fadeInSeconds);\r\n\t\t\t\t\tthis.fadeOut = Synth.ticksToFadeOutSetting(legacySettings.fadeOutTicks);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tif (transition != undefined) this.transition = transition.index;\r\n\t\t\t\r\n\t\t\tif (this.transition != Config.transitions.dictionary[\"normal\"].index) {\r\n\t\t\t\t// Enable transition if it was used.\r\n\t\t\t\tthis.effects = (this.effects | (1 << EffectType.transition));\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\t// Overrides legacy settings in transition above.\r\n\t\tif (instrumentObject[\"fadeInSeconds\"] != undefined) {\r\n\t\t\tthis.fadeIn = Synth.secondsToFadeInSetting(+instrumentObject[\"fadeInSeconds\"]);\r\n\t\t}\r\n\t\tif (instrumentObject[\"fadeOutTicks\"] != undefined) {\r\n\t\t\tthis.fadeOut = Synth.ticksToFadeOutSetting(+instrumentObject[\"fadeOutTicks\"]);\r\n\t\t}\r\n\t\t\r\n\t\t{\r\n\t\t\t// Note that the chord setting may be overridden by instrumentObject[\"chorus\"] below.\r\n\t\t\tconst chordProperty: any = instrumentObject[\"chord\"];\r\n\t\t\tconst legacyChordNames: Dictionary<string> = {\"harmony\": \"simultaneous\"};\r\n\t\t\tconst chord: Chord | undefined = Config.chords.dictionary[legacyChordNames[chordProperty]] || Config.chords.dictionary[chordProperty];\r\n\t\t\tif (chord != undefined) {\r\n\t\t\t\tthis.chord = chord.index;\r\n\t\t\t} else {\r\n\t\t\t\t// Different instruments have different default chord types based on historical behaviour.\r\n\t\t\t\tif (this.type == InstrumentType.noise) {\r\n\t\t\t\t\tthis.chord = Config.chords.dictionary[\"arpeggio\"].index;\r\n\t\t\t\t} else if (this.type == InstrumentType.pickedString) {\r\n\t\t\t\t\tthis.chord = Config.chords.dictionary[\"strum\"].index;\r\n\t\t\t\t} else if (this.type == InstrumentType.chip) {\r\n\t\t\t\t\tthis.chord = Config.chords.dictionary[\"arpeggio\"].index;\r\n\t\t\t\t} else if (this.type == InstrumentType.fm) {\r\n\t\t\t\t\tthis.chord = Config.chords.dictionary[\"custom interval\"].index;\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis.chord = Config.chords.dictionary[\"simultaneous\"].index;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tthis.unison = Config.unisons.dictionary[\"none\"].index; // default value.\r\n\t\tconst unisonProperty: any = instrumentObject[\"unison\"] || instrumentObject[\"interval\"] || instrumentObject[\"chorus\"]; // The unison property has gone by various names in the past.\r\n\t\tif (unisonProperty != undefined) {\r\n\t\t\tconst legacyChorusNames: Dictionary<string> = {\"union\": \"none\", \"fifths\": \"fifth\", \"octaves\": \"octave\"};\r\n\t\t\tconst unison: Unison | undefined = Config.unisons.dictionary[legacyChorusNames[unisonProperty]] || Config.unisons.dictionary[unisonProperty];\r\n\t\t\tif (unison != undefined) this.unison = unison.index;\r\n\t\t}\r\n\t\tif (instrumentObject[\"chorus\"] == \"custom harmony\") {\r\n\t\t\t// The original chorus setting had an option that now maps to two different settings. Override those if necessary.\r\n\t\t\tthis.unison = Config.unisons.dictionary[\"hum\"].index;\r\n\t\t\tthis.chord = Config.chords.dictionary[\"custom interval\"].index;\r\n\t\t}\r\n\t\tif (this.chord != Config.chords.dictionary[\"simultaneous\"].index && !Array.isArray(instrumentObject[\"effects\"])) {\r\n\t\t\t// Enable chord if it was used.\r\n\t\t\tthis.effects = (this.effects | (1 << EffectType.chord));\r\n\t\t}\r\n\t\t\r\n\t\tif (instrumentObject[\"pitchShiftSemitones\"] != undefined) {\r\n\t\t\tthis.pitchShift = clamp(0, Config.pitchShiftRange, Math.round(+instrumentObject[\"pitchShiftSemitones\"]));\r\n\t\t}\r\n\t\tif (instrumentObject[\"detuneCents\"] != undefined) {\r\n\t\t\tthis.detune = clamp(0, Config.detuneMax + 1, Math.round(Config.detuneCenter + Synth.centsToDetune(+instrumentObject[\"detuneCents\"])));\r\n\t\t}\r\n\t\t\r\n\t\tthis.vibrato = Config.vibratos.dictionary[\"none\"].index; // default value.\r\n\t\tconst vibratoProperty: any = instrumentObject[\"vibrato\"] || instrumentObject[\"effect\"]; // The vibrato property was previously called \"effect\", not to be confused with the current \"effects\".\r\n\t\tif (vibratoProperty != undefined) {\r\n\t\t\tconst legacyVibratoNames: Dictionary<string> = {\"vibrato light\": \"light\", \"vibrato delayed\": \"delayed\", \"vibrato heavy\": \"heavy\"};\r\n\t\t\tconst vibrato: Vibrato | undefined = Config.vibratos.dictionary[legacyVibratoNames[unisonProperty]] || Config.vibratos.dictionary[vibratoProperty];\r\n\t\t\tif (vibrato != undefined) this.vibrato = vibrato.index;\r\n\t\t\t\r\n\t\t\t// Old songs may have a vibrato effect without explicitly enabling it.\r\n\t\t\tif (vibrato != Config.vibratos.dictionary[\"none\"]) {\r\n\t\t\t\tthis.effects = (this.effects | (1 << EffectType.vibrato));\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tif (instrumentObject[\"pan\"] != undefined) {\r\n\t\t\tthis.pan = clamp(0, Config.panMax + 1, Math.round(Config.panCenter + (instrumentObject[\"pan\"] | 0) * Config.panCenter / 100));\r\n\t\t\t\r\n\t\t\t// Old songs may have a panning effect without explicitly enabling it.\r\n\t\t\tif (this.pan != Config.panCenter) {\r\n\t\t\t\tthis.effects = (this.effects | (1 << EffectType.panning));\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tthis.pan = Config.panCenter;\r\n\t\t}\r\n\t\t\r\n\t\tif (instrumentObject[\"distortion\"] != undefined) {\r\n\t\t\tthis.distortion = clamp(0, Config.distortionRange, Math.round((Config.distortionRange - 1) * (instrumentObject[\"distortion\"] | 0) / 100));\r\n\t\t}\r\n\t\t\r\n\t\tif (instrumentObject[\"bitcrusherOctave\"] != undefined) {\r\n\t\t\tthis.bitcrusherFreq = Config.bitcrusherFreqRange - 1 - (+instrumentObject[\"bitcrusherOctave\"]) / Config.bitcrusherOctaveStep;\r\n\t\t}\r\n\t\tif (instrumentObject[\"bitcrusherQuantization\"] != undefined) {\r\n\t\t\tthis.bitcrusherQuantization = clamp(0, Config.bitcrusherQuantizationRange, Math.round((Config.bitcrusherQuantizationRange - 1) * (instrumentObject[\"bitcrusherQuantization\"] | 0) / 100));\r\n\t\t}\r\n\t\t\r\n\t\tif (instrumentObject[\"echoSustain\"] != undefined) {\r\n\t\t\tthis.echoSustain = clamp(0, Config.echoSustainRange, Math.round((Config.echoSustainRange - 1) * (instrumentObject[\"echoSustain\"] | 0) / 100));\r\n\t\t}\r\n\t\tif (instrumentObject[\"echoDelayBeats\"] != undefined) {\r\n\t\t\tthis.echoDelay = clamp(0, Config.echoDelayRange, Math.round((+instrumentObject[\"echoDelayBeats\"]) * (Config.ticksPerPart * Config.partsPerBeat) / Config.echoDelayStepTicks - 1.0));\r\n\t\t}\r\n\t\t\r\n\t\tif (!isNaN(instrumentObject[\"chorus\"])) {\r\n\t\t\tthis.chorus = clamp(0, Config.chorusRange, Math.round((Config.chorusRange - 1) * (instrumentObject[\"chorus\"] | 0) / 100));\r\n\t\t}\r\n\t\t\r\n\t\tif (instrumentObject[\"reverb\"] != undefined) {\r\n\t\t\tthis.reverb = clamp(0, Config.reverbRange, Math.round((Config.reverbRange - 1) * (instrumentObject[\"reverb\"] | 0) / 100));\r\n\t\t} else {\r\n\t\t\tif (legacyGlobalReverb == 0) {\r\n\t\t\t\t// If the original song reverb was zero, just disable the instrument reverb effect entirely.\r\n\t\t\t\tthis.effects = (this.effects & (~(1 << EffectType.reverb)));\r\n\t\t\t} else {\r\n\t\t\t\tthis.reverb = legacyGlobalReverb;\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tif (instrumentObject[\"pulseWidth\"] != undefined) {\r\n\t\t\tthis.pulseWidth = clamp(0, Config.pulseWidthRange, Math.round(Math.log2((+instrumentObject[\"pulseWidth\"]) / 50) / 0.5 - 1 + 8));\r\n\t\t} else {\r\n\t\t\tthis.pulseWidth = Config.pulseWidthRange - 1;\r\n\t\t}\r\n\t\t\r\n\t\tif (instrumentObject[\"dynamism\"] != undefined) {\r\n\t\t\tthis.supersawDynamism = clamp(0, Config.supersawDynamismMax + 1, Math.round(Config.supersawDynamismMax * (instrumentObject[\"dynamism\"] | 0) / 100));\r\n\t\t} else {\r\n\t\t\tthis.supersawDynamism = Config.supersawDynamismMax;\r\n\t\t}\r\n\t\tif (instrumentObject[\"spread\"] != undefined) {\r\n\t\t\tthis.supersawSpread = clamp(0, Config.supersawSpreadMax + 1, Math.round(Config.supersawSpreadMax * (instrumentObject[\"spread\"] | 0) / 100));\r\n\t\t} else {\r\n\t\t\tthis.supersawSpread = Math.ceil(Config.supersawSpreadMax / 2.0);\r\n\t\t}\r\n\t\tif (instrumentObject[\"shape\"] != undefined) {\r\n\t\t\tthis.supersawShape = clamp(0, Config.supersawShapeMax + 1, Math.round(Config.supersawShapeMax * (instrumentObject[\"shape\"] | 0) / 100));\r\n\t\t} else {\r\n\t\t\tthis.supersawShape = 0;\r\n\t\t}\r\n\t\t\r\n\t\tif (instrumentObject[\"harmonics\"] != undefined) {\r\n\t\t\tfor (let i: number = 0; i < Config.harmonicsControlPoints; i++) {\r\n\t\t\t\tthis.harmonicsWave.harmonics[i] = Math.max(0, Math.min(Config.harmonicsMax, Math.round(Config.harmonicsMax * (+instrumentObject[\"harmonics\"][i]) / 100)));\r\n\t\t\t}\r\n\t\t\tthis.harmonicsWave.markCustomWaveDirty();\r\n\t\t} else {\r\n\t\t\tthis.harmonicsWave.reset();\r\n\t\t}\r\n\t\t\r\n\t\tif (instrumentObject[\"spectrum\"] != undefined) {\r\n\t\t\tfor (let i: number = 0; i < Config.spectrumControlPoints; i++) {\r\n\t\t\t\tthis.spectrumWave.spectrum[i] = Math.max(0, Math.min(Config.spectrumMax, Math.round(Config.spectrumMax * (+instrumentObject[\"spectrum\"][i]) / 100)));\r\n\t\t\t}\r\n\t\t\tthis.spectrumWave.markCustomWaveDirty();\r\n\t\t} else {\r\n\t\t\tthis.spectrumWave.reset(isNoiseChannel);\r\n\t\t}\r\n\t\t\r\n\t\tif (instrumentObject[\"stringSustain\"] != undefined) {\r\n\t\t\tthis.stringSustain = clamp(0, Config.stringSustainRange, Math.round((Config.stringSustainRange - 1) * (instrumentObject[\"stringSustain\"] | 0) / 100));\r\n\t\t} else {\r\n\t\t\tthis.stringSustain = 10;\r\n\t\t}\r\n\t\tthis.stringSustainType = Config.enableAcousticSustain ? Config.sustainTypeNames.indexOf(instrumentObject[\"stringSustainType\"]) : SustainType.bright;\r\n\t\tif (<any>this.stringSustainType == -1) this.stringSustainType = SustainType.bright;\r\n\t\t\r\n\t\tif (this.type == InstrumentType.noise) {\r\n\t\t\tthis.chipNoise = Config.chipNoises.findIndex(wave=>wave.name==instrumentObject[\"wave\"]);\r\n\t\t\tif (this.chipNoise == -1) this.chipNoise = 1;\r\n\t\t}\r\n\t\t\r\n\t\tconst legacyEnvelopeNames: Dictionary<string> = {\"custom\": \"note size\", \"steady\": \"none\", \"pluck 1\": \"twang 1\", \"pluck 2\": \"twang 2\", \"pluck 3\": \"twang 3\"};\r\n\t\tconst getEnvelope = (name: any): Envelope | undefined => (legacyEnvelopeNames[name] != undefined) ? Config.envelopes.dictionary[legacyEnvelopeNames[name]] : Config.envelopes.dictionary[name];\r\n\t\t\r\n\t\tif (this.type == InstrumentType.drumset) {\r\n\t\t\tif (instrumentObject[\"drums\"] != undefined) {\r\n\t\t\t\tfor (let j: number = 0; j < Config.drumCount; j++) {\r\n\t\t\t\t\tconst drum: any = instrumentObject[\"drums\"][j];\r\n\t\t\t\t\tif (drum == undefined) continue;\r\n\t\t\t\t\t\r\n\t\t\t\t\tthis.drumsetEnvelopes[j] = Config.envelopes.dictionary[\"twang 2\"].index; // default value.\r\n\t\t\t\t\tif (drum[\"filterEnvelope\"] != undefined) {\r\n\t\t\t\t\t\tconst envelope: Envelope | undefined = getEnvelope(drum[\"filterEnvelope\"]);\r\n\t\t\t\t\t\tif (envelope != undefined) this.drumsetEnvelopes[j] = envelope.index;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (drum[\"spectrum\"] != undefined) {\r\n\t\t\t\t\t\tfor (let i: number = 0; i < Config.spectrumControlPoints; i++) {\r\n\t\t\t\t\t\t\tthis.drumsetSpectrumWaves[j].spectrum[i] = Math.max(0, Math.min(Config.spectrumMax, Math.round(Config.spectrumMax * (+drum[\"spectrum\"][i]) / 100)));\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tif (this.type == InstrumentType.chip) {\r\n\t\t\tconst legacyWaveNames: Dictionary<number> = {\"triangle\": 1, \"square\": 2, \"pulse wide\": 3, \"pulse narrow\": 4, \"sawtooth\": 5, \"double saw\": 6, \"double pulse\": 7, \"spiky\": 8, \"plateau\": 0};\r\n\t\t\tthis.chipWave = legacyWaveNames[instrumentObject[\"wave\"]] != undefined ? legacyWaveNames[instrumentObject[\"wave\"]] : Config.chipWaves.findIndex(wave=>wave.name==instrumentObject[\"wave\"]);\r\n\t\t\tif (this.chipWave == -1) this.chipWave = 1;\r\n\t\t}\r\n\t\t\r\n\t\tif (this.type == InstrumentType.fm) {\r\n\t\t\tthis.algorithm = Config.algorithms.findIndex(algorithm=>algorithm.name==instrumentObject[\"algorithm\"]);\r\n\t\t\tif (this.algorithm == -1) this.algorithm = 0;\r\n\t\t\tthis.feedbackType = Config.feedbacks.findIndex(feedback=>feedback.name==instrumentObject[\"feedbackType\"]);\r\n\t\t\tif (this.feedbackType == -1) this.feedbackType = 0;\r\n\t\t\tif (instrumentObject[\"feedbackAmplitude\"] != undefined) {\r\n\t\t\t\tthis.feedbackAmplitude = clamp(0, Config.operatorAmplitudeMax + 1, instrumentObject[\"feedbackAmplitude\"] | 0);\r\n\t\t\t} else {\r\n\t\t\t\tthis.feedbackAmplitude = 0;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tfor (let j: number = 0; j < Config.operatorCount; j++) {\r\n\t\t\t\tconst operator: Operator = this.operators[j];\r\n\t\t\t\tlet operatorObject: any = undefined;\r\n\t\t\t\tif (instrumentObject[\"operators\"] != undefined) operatorObject = instrumentObject[\"operators\"][j];\r\n\t\t\t\tif (operatorObject == undefined) operatorObject = {};\r\n\t\t\t\t\r\n\t\t\t\toperator.frequency = Config.operatorFrequencies.findIndex(freq=>freq.name==operatorObject[\"frequency\"]);\r\n\t\t\t\tif (operator.frequency == -1) operator.frequency = 0;\r\n\t\t\t\tif (operatorObject[\"amplitude\"] != undefined) {\r\n\t\t\t\t\toperator.amplitude = clamp(0, Config.operatorAmplitudeMax + 1, operatorObject[\"amplitude\"] | 0);\r\n\t\t\t\t} else {\r\n\t\t\t\t\toperator.amplitude = 0;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tif (instrumentObject[\"noteFilter\"] != undefined) {\r\n\t\t\tthis.noteFilter.fromJsonObject(instrumentObject[\"noteFilter\"]);\r\n\t\t} else {\r\n\t\t\tthis.noteFilter.reset();\r\n\t\t}\r\n\t\tif (Array.isArray(instrumentObject[\"eqFilter\"])) {\r\n\t\t\tthis.eqFilter.fromJsonObject(instrumentObject[\"eqFilter\"]);\r\n\t\t} else {\r\n\t\t\tthis.eqFilter.reset();\r\n\t\t\t\r\n\t\t\tconst legacySettings: LegacySettings = {};\r\n\t\t\t\r\n\t\t\t// Try converting from legacy filter settings.\r\n\t\t\tconst filterCutoffMaxHz: number = 8000;\r\n\t\t\tconst filterCutoffRange: number = 11;\r\n\t\t\tconst filterResonanceRange: number = 8;\r\n\t\t\tif (instrumentObject[\"filterCutoffHz\"] != undefined) {\r\n\t\t\t\tlegacySettings.filterCutoff = clamp(0, filterCutoffRange, Math.round((filterCutoffRange - 1) + 2.0 * Math.log((instrumentObject[\"filterCutoffHz\"] | 0) / filterCutoffMaxHz) / Math.LN2));\r\n\t\t\t} else {\r\n\t\t\t\tlegacySettings.filterCutoff = (this.type == InstrumentType.chip) ? 6 : 10;\r\n\t\t\t}\r\n\t\t\tif (instrumentObject[\"filterResonance\"] != undefined) {\r\n\t\t\t\tlegacySettings.filterResonance = clamp(0, filterResonanceRange, Math.round((filterResonanceRange - 1) * (instrumentObject[\"filterResonance\"] | 0) / 100));\r\n\t\t\t} else {\r\n\t\t\t\tlegacySettings.filterResonance = 0;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tlegacySettings.filterEnvelope = getEnvelope(instrumentObject[\"filterEnvelope\"]);\r\n\t\t\tlegacySettings.pulseEnvelope = getEnvelope(instrumentObject[\"pulseEnvelope\"]);\r\n\t\t\tlegacySettings.feedbackEnvelope = getEnvelope(instrumentObject[\"feedbackEnvelope\"]);\r\n\t\t\tif (Array.isArray(instrumentObject[\"operators\"])) {\r\n\t\t\t\tlegacySettings.operatorEnvelopes = [];\r\n\t\t\t\tfor (let j: number = 0; j < Config.operatorCount; j++) {\r\n\t\t\t\t\tlet envelope: Envelope | undefined;\r\n\t\t\t\t\tif (instrumentObject[\"operators\"][j] != undefined) {\r\n\t\t\t\t\t\tenvelope = getEnvelope(instrumentObject[\"operators\"][j][\"envelope\"]);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tlegacySettings.operatorEnvelopes[j] = (envelope != undefined) ? envelope : Config.envelopes.dictionary[\"none\"];\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t// Try converting from even older legacy filter settings.\r\n\t\t\tif (instrumentObject[\"filter\"] != undefined) {\r\n\t\t\t\tconst legacyToCutoff: number[] = [10, 6, 3, 0, 8, 5, 2];\r\n\t\t\t\tconst legacyToEnvelope: string[] = [\"none\", \"none\", \"none\", \"none\", \"decay 1\", \"decay 2\", \"decay 3\"];\r\n\t\t\t\tconst filterNames: string[] = [\"none\", \"bright\", \"medium\", \"soft\", \"decay bright\", \"decay medium\", \"decay soft\"];\r\n\t\t\t\tconst oldFilterNames: Dictionary<number> = {\"sustain sharp\": 1, \"sustain medium\": 2, \"sustain soft\": 3, \"decay sharp\": 4};\r\n\t\t\t\tlet legacyFilter: number = oldFilterNames[instrumentObject[\"filter\"]] != undefined ? oldFilterNames[instrumentObject[\"filter\"]] : filterNames.indexOf(instrumentObject[\"filter\"]);\r\n\t\t\t\tif (legacyFilter == -1) legacyFilter = 0;\r\n\t\t\t\tlegacySettings.filterCutoff = legacyToCutoff[legacyFilter];\r\n\t\t\t\tlegacySettings.filterEnvelope = getEnvelope(legacyToEnvelope[legacyFilter]);\r\n\t\t\t\tlegacySettings.filterResonance = 0;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tthis.convertLegacySettings(legacySettings);\r\n\t\t}\r\n\t\t\r\n\t\tif (Array.isArray(instrumentObject[\"envelopes\"])) {\r\n\t\t\tconst envelopeArray: any[] = instrumentObject[\"envelopes\"];\r\n\t\t\tfor (let i = 0; i < envelopeArray.length; i++) {\r\n\t\t\t\tif (this.envelopeCount >= Config.maxEnvelopeCount) break;\r\n\t\t\t\tconst tempEnvelope: EnvelopeSettings = new EnvelopeSettings();\r\n\t\t\t\ttempEnvelope.fromJsonObject(envelopeArray[i]);\r\n\t\t\t\tthis.addEnvelope(tempEnvelope.target, tempEnvelope.index, tempEnvelope.envelope);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\t\r\n\tpublic static frequencyFromPitch(pitch: number): number {\r\n\t\treturn 440.0 * Math.pow(2.0, (pitch - 69.0) / 12.0);\r\n\t}\r\n\t\r\n\tpublic addEnvelope(target: number, index: number, envelope: number): void {\r\n\t\tif (!this.supportsEnvelopeTarget(target, index)) throw new Error();\r\n\t\tif (this.envelopeCount >= Config.maxEnvelopeCount) throw new Error();\r\n\t\twhile (this.envelopes.length <= this.envelopeCount) this.envelopes[this.envelopes.length] = new EnvelopeSettings();\r\n\t\tconst envelopeSettings: EnvelopeSettings = this.envelopes[this.envelopeCount];\r\n\t\tenvelopeSettings.target = target;\r\n\t\tenvelopeSettings.index = index;\r\n\t\tenvelopeSettings.envelope = envelope;\r\n\t\tthis.envelopeCount++;\r\n\t}\r\n\t\r\n\tpublic supportsEnvelopeTarget(target: number, index: number): boolean {\r\n\t\tconst automationTarget: AutomationTarget = Config.instrumentAutomationTargets[target];\r\n\t\tif (automationTarget.computeIndex == null && automationTarget.name != \"none\") {\r\n\t\t\treturn false;\r\n\t\t}\r\n\t\tif (index >= automationTarget.maxCount) {\r\n\t\t\treturn false;\r\n\t\t}\r\n\t\tif (automationTarget.compatibleInstruments != null && automationTarget.compatibleInstruments.indexOf(this.type) == -1) {\r\n\t\t\treturn false;\r\n\t\t}\r\n\t\tif (automationTarget.effect != null && (this.effects & (1 << automationTarget.effect)) == 0) {\r\n\t\t\treturn false;\r\n\t\t}\r\n\t\tif (automationTarget.isFilter) {\r\n\t\t\t//if (automationTarget.perNote) {\r\n\t\t\t\tif (index >= this.noteFilter.controlPointCount) return false;\r\n\t\t\t//} else {\r\n\t\t\t//\tif (index >= this.eqFilter.controlPointCount)   return false;\r\n\t\t\t//}\r\n\t\t}\r\n\t\treturn true;\r\n\t}\r\n\t\r\n\tpublic clearInvalidEnvelopeTargets(): void {\r\n\t\tfor (let envelopeIndex: number = 0; envelopeIndex < this.envelopeCount; envelopeIndex++) {\r\n\t\t\tconst target: number = this.envelopes[envelopeIndex].target;\r\n\t\t\tconst index: number = this.envelopes[envelopeIndex].index;\r\n\t\t\tif (!this.supportsEnvelopeTarget(target, index)) {\r\n\t\t\t\tthis.envelopes[envelopeIndex].target = Config.instrumentAutomationTargets.dictionary[\"none\"].index;\r\n\t\t\t\tthis.envelopes[envelopeIndex].index = 0;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\t\r\n\tpublic getTransition(): Transition {\r\n\t\treturn effectsIncludeTransition(this.effects) ? Config.transitions[this.transition] : Config.transitions.dictionary[\"normal\"];\r\n\t}\r\n\t\r\n\tpublic getFadeInSeconds(): number {\r\n\t\treturn (this.type == InstrumentType.drumset) ? 0.0 : Synth.fadeInSettingToSeconds(this.fadeIn);\r\n\t}\r\n\t\r\n\tpublic getFadeOutTicks(): number {\r\n\t\treturn (this.type == InstrumentType.drumset) ? Config.drumsetFadeOutTicks : Synth.fadeOutSettingToTicks(this.fadeOut)\r\n\t}\r\n\t\r\n\tpublic getChord(): Chord {\r\n\t\treturn effectsIncludeChord(this.effects) ? Config.chords[this.chord] : Config.chords.dictionary[\"simultaneous\"];\r\n\t}\r\n\t\r\n\tpublic getDrumsetEnvelope(pitch: number): Envelope {\r\n\t\tif (this.type != InstrumentType.drumset) throw new Error(\"Can't getDrumsetEnvelope() for non-drumset.\");\r\n\t\treturn Config.envelopes[this.drumsetEnvelopes[pitch]];\r\n\t}\r\n}\r\n\r\nexport class Channel {\r\n\tpublic octave: number = 0;\r\n\tpublic readonly instruments: Instrument[] = [];\r\n\tpublic readonly patterns: Pattern[] = [];\r\n\tpublic readonly bars: number[] = [];\r\n\tpublic muted: boolean = false;\r\n}\r\n\r\nexport class Song {\r\n\tprivate static readonly _format: string = \"BeepBox\";\r\n\tprivate static readonly _oldestVersion: number = 2;\r\n\tprivate static readonly _latestVersion: number = 9;\r\n\t\r\n\tpublic scale: number;\r\n\tpublic key: number;\r\n\tpublic tempo: number;\r\n\tpublic beatsPerBar: number;\r\n\tpublic barCount: number;\r\n\tpublic patternsPerChannel: number;\r\n\tpublic rhythm: number;\r\n\tpublic layeredInstruments: boolean;\r\n\tpublic patternInstruments: boolean;\r\n\tpublic loopStart: number;\r\n\tpublic loopLength: number;\r\n\tpublic pitchChannelCount: number;\r\n\tpublic noiseChannelCount: number;\r\n\tpublic readonly channels: Channel[] = [];\r\n\t\r\n\tconstructor(string?: string) {\r\n\t\tif (string != undefined) {\r\n\t\t\tthis.fromBase64String(string);\r\n\t\t} else {\r\n\t\t\tthis.initToDefault(true);\r\n\t\t}\r\n\t}\r\n\t\r\n\tpublic getChannelCount(): number {\r\n\t\treturn this.pitchChannelCount + this.noiseChannelCount;\r\n\t}\r\n\t\r\n\tpublic getMaxInstrumentsPerChannel(): number {\r\n\t\treturn Math.max(\r\n\t\t\tthis.layeredInstruments ? Config.layeredInstrumentCountMax : Config.instrumentCountMin,\r\n\t\t\tthis.patternInstruments ? Config.patternInstrumentCountMax : Config.instrumentCountMin);\r\n\t}\r\n\t\r\n\tpublic getMaxInstrumentsPerPattern(channelIndex: number): number {\r\n\t\treturn this.getMaxInstrumentsPerPatternForChannel(this.channels[channelIndex]);\r\n\t}\r\n\t\r\n\tpublic getMaxInstrumentsPerPatternForChannel(channel: Channel): number {\r\n\t\treturn this.layeredInstruments\r\n\t\t\t? Math.min(Config.layeredInstrumentCountMax, channel.instruments.length)\r\n\t\t\t: 1;\r\n\t}\r\n\t\r\n\tpublic getChannelIsNoise(channelIndex: number): boolean {\r\n\t\treturn (channelIndex >= this.pitchChannelCount);\r\n\t}\r\n\t\r\n\tpublic initToDefault(andResetChannels: boolean = true): void {\r\n\t\tthis.scale = 0;\r\n\t\tthis.key = 0;\r\n\t\tthis.loopStart = 0;\r\n\t\tthis.loopLength = 4;\r\n\t\tthis.tempo = 150;\r\n\t\tthis.beatsPerBar = 8;\r\n\t\tthis.barCount = 16;\r\n\t\tthis.patternsPerChannel = 8;\r\n\t\tthis.rhythm = 1;\r\n\t\tthis.layeredInstruments = false;\r\n\t\tthis.patternInstruments = false;\r\n\t\t\r\n\t\tif (andResetChannels) {\r\n\t\t\tthis.pitchChannelCount = 3;\r\n\t\t\tthis.noiseChannelCount = 1;\r\n\t\t\tfor (let channelIndex: number = 0; channelIndex < this.getChannelCount(); channelIndex++) {\r\n\t\t\t\tconst isNoiseChannel: boolean = channelIndex >= this.pitchChannelCount;\r\n\t\t\t\tif (this.channels.length <= channelIndex) {\r\n\t\t\t\t\tthis.channels[channelIndex] = new Channel();\r\n\t\t\t\t}\r\n\t\t\t\tconst channel: Channel = this.channels[channelIndex];\r\n\t\t\t\tchannel.octave = isNoiseChannel ? 0 : 4 - channelIndex; // [4, 3, 2, 0]: Descending octaves with drums at zero in last channel.\r\n\t\t\t\r\n\t\t\t\tfor (let pattern: number = 0; pattern < this.patternsPerChannel; pattern++) {\r\n\t\t\t\t\tif (channel.patterns.length <= pattern) {\r\n\t\t\t\t\t\tchannel.patterns[pattern] = new Pattern();\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tchannel.patterns[pattern].reset();\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tchannel.patterns.length = this.patternsPerChannel;\r\n\t\t\t\r\n\t\t\t\tfor (let instrument: number = 0; instrument < Config.instrumentCountMin; instrument++) {\r\n\t\t\t\t\tif (channel.instruments.length <= instrument) {\r\n\t\t\t\t\t\tchannel.instruments[instrument] = new Instrument(isNoiseChannel);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tchannel.instruments[instrument].setTypeAndReset(isNoiseChannel ? InstrumentType.noise : InstrumentType.chip, isNoiseChannel);\r\n\t\t\t\t}\r\n\t\t\t\tchannel.instruments.length = Config.instrumentCountMin;\r\n\t\t\t\r\n\t\t\t\tfor (let bar: number = 0; bar < this.barCount; bar++) {\r\n\t\t\t\t\tchannel.bars[bar] = bar < 4 ? 1 : 0;\r\n\t\t\t\t}\r\n\t\t\t\tchannel.bars.length = this.barCount;\r\n\t\t\t}\r\n\t\t\tthis.channels.length = this.getChannelCount();\r\n\t\t}\r\n\t}\r\n\t\r\n\tpublic toBase64String(): string {\r\n\t\tlet bits: BitFieldWriter;\r\n\t\tlet buffer: number[] = [];\r\n\t\t\r\n\t\tbuffer.push(base64IntToCharCode[Song._latestVersion]);\r\n\t\tbuffer.push(SongTagCode.channelCount, base64IntToCharCode[this.pitchChannelCount], base64IntToCharCode[this.noiseChannelCount]);\r\n\t\tbuffer.push(SongTagCode.scale, base64IntToCharCode[this.scale]);\r\n\t\tbuffer.push(SongTagCode.key, base64IntToCharCode[this.key]);\r\n\t\tbuffer.push(SongTagCode.loopStart, base64IntToCharCode[this.loopStart >> 6], base64IntToCharCode[this.loopStart & 0x3f]);\r\n\t\tbuffer.push(SongTagCode.loopEnd, base64IntToCharCode[(this.loopLength - 1) >> 6], base64IntToCharCode[(this.loopLength - 1) & 0x3f]);\r\n\t\tbuffer.push(SongTagCode.tempo, base64IntToCharCode[this.tempo >> 6], base64IntToCharCode[this.tempo & 63]);\r\n\t\tbuffer.push(SongTagCode.beatCount, base64IntToCharCode[this.beatsPerBar - 1]);\r\n\t\tbuffer.push(SongTagCode.barCount, base64IntToCharCode[(this.barCount - 1) >> 6], base64IntToCharCode[(this.barCount - 1) & 0x3f]);\r\n\t\tbuffer.push(SongTagCode.patternCount, base64IntToCharCode[(this.patternsPerChannel - 1) >> 6], base64IntToCharCode[(this.patternsPerChannel - 1) & 0x3f]);\r\n\t\tbuffer.push(SongTagCode.rhythm, base64IntToCharCode[this.rhythm]);\r\n\t\t\r\n\t\tbuffer.push(SongTagCode.instrumentCount, base64IntToCharCode[(<any>this.layeredInstruments << 1) | <any>this.patternInstruments]);\r\n\t\tif (this.layeredInstruments || this.patternInstruments) {\r\n\t\t\tfor (let channelIndex: number = 0; channelIndex < this.getChannelCount(); channelIndex++) {\r\n\t\t\t\tbuffer.push(base64IntToCharCode[this.channels[channelIndex].instruments.length - Config.instrumentCountMin]);\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tbuffer.push(SongTagCode.channelOctave);\r\n\t\tfor (let channelIndex: number = 0; channelIndex < this.pitchChannelCount; channelIndex++) {\r\n\t\t\tbuffer.push(base64IntToCharCode[this.channels[channelIndex].octave]);\r\n\t\t}\r\n\t\t\r\n\t\tfor (let channelIndex: number = 0; channelIndex < this.getChannelCount(); channelIndex++) {\r\n\t\t\tfor (let i: number = 0; i < this.channels[channelIndex].instruments.length; i++) {\r\n\t\t\t\tconst instrument: Instrument = this.channels[channelIndex].instruments[i];\r\n\t\t\t\tbuffer.push(SongTagCode.startInstrument, base64IntToCharCode[instrument.type]);\r\n\t\t\t\tbuffer.push(SongTagCode.volume, base64IntToCharCode[instrument.volume]);\r\n\t\t\t\tbuffer.push(SongTagCode.preset, base64IntToCharCode[instrument.preset >> 6], base64IntToCharCode[instrument.preset & 63]);\r\n\t\t\t\t\r\n\t\t\t\tbuffer.push(SongTagCode.eqFilter, base64IntToCharCode[instrument.eqFilter.controlPointCount]);\r\n\t\t\t\tfor (let j: number = 0; j < instrument.eqFilter.controlPointCount; j++) {\r\n\t\t\t\t\tconst point: FilterControlPoint = instrument.eqFilter.controlPoints[j];\r\n\t\t\t\t\tbuffer.push(base64IntToCharCode[point.type], base64IntToCharCode[point.freq], base64IntToCharCode[point.gain]);\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\t// The list of enabled effects is represented as a 12-bit bitfield using two six-bit characters.\r\n\t\t\t\tbuffer.push(SongTagCode.effects, base64IntToCharCode[instrument.effects >> 6], base64IntToCharCode[instrument.effects & 63]);\r\n\t\t\t\tif (effectsIncludeNoteFilter(instrument.effects)) {\r\n\t\t\t\t\tbuffer.push(base64IntToCharCode[instrument.noteFilter.controlPointCount]);\r\n\t\t\t\t\tfor (let j: number = 0; j < instrument.noteFilter.controlPointCount; j++) {\r\n\t\t\t\t\t\tconst point: FilterControlPoint = instrument.noteFilter.controlPoints[j];\r\n\t\t\t\t\t\tbuffer.push(base64IntToCharCode[point.type], base64IntToCharCode[point.freq], base64IntToCharCode[point.gain]);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tif (effectsIncludeTransition(instrument.effects)) {\r\n\t\t\t\t\tbuffer.push(base64IntToCharCode[instrument.transition]);\r\n\t\t\t\t}\r\n\t\t\t\tif (effectsIncludeChord(instrument.effects)) {\r\n\t\t\t\t\tbuffer.push(base64IntToCharCode[instrument.chord]);\r\n\t\t\t\t}\r\n\t\t\t\tif (effectsIncludePitchShift(instrument.effects)) {\r\n\t\t\t\t\tbuffer.push(base64IntToCharCode[instrument.pitchShift]);\r\n\t\t\t\t}\r\n\t\t\t\tif (effectsIncludeDetune(instrument.effects)) {\r\n\t\t\t\t\tbuffer.push(base64IntToCharCode[instrument.detune]);\r\n\t\t\t\t}\r\n\t\t\t\tif (effectsIncludeVibrato(instrument.effects)) {\r\n\t\t\t\t\tbuffer.push(base64IntToCharCode[instrument.vibrato]);\r\n\t\t\t\t}\r\n\t\t\t\tif (effectsIncludeDistortion(instrument.effects)) {\r\n\t\t\t\t\tbuffer.push(base64IntToCharCode[instrument.distortion]);\r\n\t\t\t\t}\r\n\t\t\t\tif (effectsIncludeBitcrusher(instrument.effects)) {\r\n\t\t\t\t\tbuffer.push(base64IntToCharCode[instrument.bitcrusherFreq], base64IntToCharCode[instrument.bitcrusherQuantization]);\r\n\t\t\t\t}\r\n\t\t\t\tif (effectsIncludePanning(instrument.effects)) {\r\n\t\t\t\t\tbuffer.push(base64IntToCharCode[instrument.pan]);\r\n\t\t\t\t}\r\n\t\t\t\tif (effectsIncludeChorus(instrument.effects)) {\r\n\t\t\t\t\tbuffer.push(base64IntToCharCode[instrument.chorus]);\r\n\t\t\t\t}\r\n\t\t\t\tif (effectsIncludeEcho(instrument.effects)) {\r\n\t\t\t\t\tbuffer.push(base64IntToCharCode[instrument.echoSustain], base64IntToCharCode[instrument.echoDelay]);\r\n\t\t\t\t}\r\n\t\t\t\tif (effectsIncludeReverb(instrument.effects)) {\r\n\t\t\t\t\tbuffer.push(base64IntToCharCode[instrument.reverb]);\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tif (instrument.type != InstrumentType.drumset) {\r\n\t\t\t\t\tbuffer.push(SongTagCode.fadeInOut, base64IntToCharCode[instrument.fadeIn], base64IntToCharCode[instrument.fadeOut]);\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tif (instrument.type == InstrumentType.harmonics || instrument.type == InstrumentType.pickedString) {\r\n\t\t\t\t\tbuffer.push(SongTagCode.harmonics);\r\n\t\t\t\t\tconst harmonicsBits: BitFieldWriter = new BitFieldWriter();\r\n\t\t\t\t\tfor (let i: number = 0; i < Config.harmonicsControlPoints; i++) {\r\n\t\t\t\t\t\tharmonicsBits.write(Config.harmonicsControlPointBits, instrument.harmonicsWave.harmonics[i]);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tharmonicsBits.encodeBase64(buffer);\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tif (instrument.type == InstrumentType.chip) {\r\n\t\t\t\t\tbuffer.push(SongTagCode.wave, base64IntToCharCode[instrument.chipWave]);\r\n\t\t\t\t\tbuffer.push(SongTagCode.unison, base64IntToCharCode[instrument.unison]);\r\n\t\t\t\t} else if (instrument.type == InstrumentType.fm) {\r\n\t\t\t\t\tbuffer.push(SongTagCode.algorithm, base64IntToCharCode[instrument.algorithm]);\r\n\t\t\t\t\tbuffer.push(SongTagCode.feedbackType, base64IntToCharCode[instrument.feedbackType]);\r\n\t\t\t\t\tbuffer.push(SongTagCode.feedbackAmplitude, base64IntToCharCode[instrument.feedbackAmplitude]);\r\n\t\t\t\t\t\r\n\t\t\t\t\tbuffer.push(SongTagCode.operatorFrequencies);\r\n\t\t\t\t\tfor (let o: number = 0; o < Config.operatorCount; o++) {\r\n\t\t\t\t\t\tbuffer.push(base64IntToCharCode[instrument.operators[o].frequency]);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbuffer.push(SongTagCode.operatorAmplitudes);\r\n\t\t\t\t\tfor (let o: number = 0; o < Config.operatorCount; o++) {\r\n\t\t\t\t\t\tbuffer.push(base64IntToCharCode[instrument.operators[o].amplitude]);\r\n\t\t\t\t\t}\r\n\t\t\t\t} else if (instrument.type == InstrumentType.noise) {\r\n\t\t\t\t\tbuffer.push(SongTagCode.wave, base64IntToCharCode[instrument.chipNoise]);\r\n\t\t\t\t} else if (instrument.type == InstrumentType.spectrum) {\r\n\t\t\t\t\tbuffer.push(SongTagCode.spectrum);\r\n\t\t\t\t\tconst spectrumBits: BitFieldWriter = new BitFieldWriter();\r\n\t\t\t\t\tfor (let i: number = 0; i < Config.spectrumControlPoints; i++) {\r\n\t\t\t\t\t\tspectrumBits.write(Config.spectrumControlPointBits, instrument.spectrumWave.spectrum[i]);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tspectrumBits.encodeBase64(buffer);\r\n\t\t\t\t} else if (instrument.type == InstrumentType.drumset) {\r\n\t\t\t\t\tbuffer.push(SongTagCode.drumsetEnvelopes);\r\n\t\t\t\t\tfor (let j: number = 0; j < Config.drumCount; j++) {\r\n\t\t\t\t\t\tbuffer.push(base64IntToCharCode[instrument.drumsetEnvelopes[j]]);\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t\tbuffer.push(SongTagCode.spectrum);\r\n\t\t\t\t\tconst spectrumBits: BitFieldWriter = new BitFieldWriter();\r\n\t\t\t\t\tfor (let j: number = 0; j < Config.drumCount; j++) {\r\n\t\t\t\t\t\tfor (let i: number = 0; i < Config.spectrumControlPoints; i++) {\r\n\t\t\t\t\t\t\tspectrumBits.write(Config.spectrumControlPointBits, instrument.drumsetSpectrumWaves[j].spectrum[i]);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\tspectrumBits.encodeBase64(buffer);\r\n\t\t\t\t} else if (instrument.type == InstrumentType.harmonics) {\r\n\t\t\t\t\tbuffer.push(SongTagCode.unison, base64IntToCharCode[instrument.unison]);\r\n\t\t\t\t} else if (instrument.type == InstrumentType.pwm) {\r\n\t\t\t\t\tbuffer.push(SongTagCode.pulseWidth, base64IntToCharCode[instrument.pulseWidth]);\r\n\t\t\t\t} else if (instrument.type == InstrumentType.supersaw) {\r\n\t\t\t\t\tbuffer.push(SongTagCode.supersaw, base64IntToCharCode[instrument.supersawDynamism], base64IntToCharCode[instrument.supersawSpread], base64IntToCharCode[instrument.supersawShape]);\r\n\t\t\t\t\tbuffer.push(SongTagCode.pulseWidth, base64IntToCharCode[instrument.pulseWidth]);\r\n\t\t\t\t} else if (instrument.type == InstrumentType.pickedString) {\r\n\t\t\t\t\tbuffer.push(SongTagCode.unison, base64IntToCharCode[instrument.unison]);\r\n\t\t\t\t\tif (Config.stringSustainRange > 0x20 || SustainType.length > 2) {\r\n\t\t\t\t\t\tthrow new Error(\"Not enough bits to represent sustain value and type in same base64 character.\");\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbuffer.push(SongTagCode.stringSustain, base64IntToCharCode[instrument.stringSustain | (instrument.stringSustainType << 5)]);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthrow new Error(\"Unknown instrument type.\");\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tbuffer.push(SongTagCode.envelopes, base64IntToCharCode[instrument.envelopeCount]);\r\n\t\t\t\tfor (let envelopeIndex: number = 0; envelopeIndex < instrument.envelopeCount; envelopeIndex++) {\r\n\t\t\t\t\tbuffer.push(base64IntToCharCode[instrument.envelopes[envelopeIndex].target]);\r\n\t\t\t\t\tif (Config.instrumentAutomationTargets[instrument.envelopes[envelopeIndex].target].maxCount > 1) {\r\n\t\t\t\t\t\tbuffer.push(base64IntToCharCode[instrument.envelopes[envelopeIndex].index]);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbuffer.push(base64IntToCharCode[instrument.envelopes[envelopeIndex].envelope]);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tbuffer.push(SongTagCode.bars);\r\n\t\tbits = new BitFieldWriter();\r\n\t\tlet neededBits: number = 0;\r\n\t\twhile ((1 << neededBits) < this.patternsPerChannel + 1) neededBits++;\r\n\t\tfor (let channelIndex: number = 0; channelIndex < this.getChannelCount(); channelIndex++) for (let i: number = 0; i < this.barCount; i++) {\r\n\t\t\tbits.write(neededBits, this.channels[channelIndex].bars[i]);\r\n\t\t}\r\n\t\tbits.encodeBase64(buffer);\r\n\t\t\r\n\t\tbuffer.push(SongTagCode.patterns);\r\n\t\tbits = new BitFieldWriter();\r\n\t\tconst shapeBits: BitFieldWriter = new BitFieldWriter();\r\n\t\tconst bitsPerNoteSize: number = Song.getNeededBits(Config.noteSizeMax);\r\n\t\tfor (let channelIndex: number = 0; channelIndex < this.getChannelCount(); channelIndex++) {\r\n\t\t\tconst channel: Channel = this.channels[channelIndex];\r\n\t\t\tconst maxInstrumentsPerPattern: number = this.getMaxInstrumentsPerPattern(channelIndex);\r\n\t\t\tconst neededInstrumentCountBits: number = Song.getNeededBits(maxInstrumentsPerPattern - Config.instrumentCountMin);\r\n\t\t\tconst neededInstrumentIndexBits: number = Song.getNeededBits(channel.instruments.length - 1);\r\n\t\t\tconst isNoiseChannel: boolean = this.getChannelIsNoise(channelIndex);\r\n\t\t\tconst octaveOffset: number = isNoiseChannel ? 0 : channel.octave * Config.pitchesPerOctave;\r\n\t\t\tlet lastPitch: number = (isNoiseChannel ? 4 : octaveOffset);\r\n\t\t\tconst recentPitches: number[] = isNoiseChannel ? [4,6,7,2,3,8,0,10] : [0, 7, 12, 19, 24, -5, -12];\r\n\t\t\tconst recentShapes: string[] = [];\r\n\t\t\tfor (let i: number = 0; i < recentPitches.length; i++) {\r\n\t\t\t\trecentPitches[i] += octaveOffset;\r\n\t\t\t}\r\n\t\t\tfor (const pattern of channel.patterns) {\r\n\t\t\t\tif (this.patternInstruments) {\r\n\t\t\t\t\tconst instrumentCount: number = validateRange(Config.instrumentCountMin, maxInstrumentsPerPattern, pattern.instruments.length);\r\n\t\t\t\t\tbits.write(neededInstrumentCountBits, instrumentCount - Config.instrumentCountMin);\r\n\t\t\t\t\tfor (let i: number = 0; i < instrumentCount; i++) {\r\n\t\t\t\t\t\tbits.write(neededInstrumentIndexBits, pattern.instruments[i]);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tif (pattern.notes.length > 0) {\r\n\t\t\t\t\tbits.write(1, 1);\r\n\t\t\t\t\t\r\n\t\t\t\t\tlet curPart: number = 0;\r\n\t\t\t\t\tfor (const note of pattern.notes) {\r\n\t\t\t\t\t\tif (note.start > curPart) {\r\n\t\t\t\t\t\t\tbits.write(2, 0); // rest\r\n\t\t\t\t\t\t\tbits.writePartDuration(note.start - curPart);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tshapeBits.clear();\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t// 0: 1 pitch, 10: 2 pitches, 110: 3 pitches, 111: 4 pitches\r\n\t\t\t\t\t\tfor (let i: number = 1; i < note.pitches.length; i++) shapeBits.write(1,1);\r\n\t\t\t\t\t\tif (note.pitches.length < Config.maxChordSize) shapeBits.write(1,0);\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tshapeBits.writePinCount(note.pins.length - 1);\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tshapeBits.write(bitsPerNoteSize, note.pins[0].size);\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tlet shapePart: number = 0;\r\n\t\t\t\t\t\tlet startPitch: number = note.pitches[0];\r\n\t\t\t\t\t\tlet currentPitch: number = startPitch;\r\n\t\t\t\t\t\tconst pitchBends: number[] = [];\r\n\t\t\t\t\t\tfor (let i: number = 1; i < note.pins.length; i++) {\r\n\t\t\t\t\t\t\tconst pin: NotePin = note.pins[i];\r\n\t\t\t\t\t\t\tconst nextPitch: number = startPitch + pin.interval;\r\n\t\t\t\t\t\t\tif (currentPitch != nextPitch) {\r\n\t\t\t\t\t\t\t\tshapeBits.write(1, 1);\r\n\t\t\t\t\t\t\t\tpitchBends.push(nextPitch);\r\n\t\t\t\t\t\t\t\tcurrentPitch = nextPitch;\r\n\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\tshapeBits.write(1, 0);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tshapeBits.writePartDuration(pin.time - shapePart);\r\n\t\t\t\t\t\t\tshapePart = pin.time;\r\n\t\t\t\t\t\t\tshapeBits.write(bitsPerNoteSize, pin.size);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tconst shapeString: string = String.fromCharCode.apply(null, shapeBits.encodeBase64([]));\r\n\t\t\t\t\t\tconst shapeIndex: number = recentShapes.indexOf(shapeString);\r\n\t\t\t\t\t\tif (shapeIndex == -1) {\r\n\t\t\t\t\t\t\tbits.write(2, 1); // new shape\r\n\t\t\t\t\t\t\tbits.concat(shapeBits);\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\tbits.write(1, 1); // old shape\r\n\t\t\t\t\t\t\tbits.writeLongTail(0, 0, shapeIndex);\r\n\t\t\t\t\t\t\trecentShapes.splice(shapeIndex, 1);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\trecentShapes.unshift(shapeString);\r\n\t\t\t\t\t\tif (recentShapes.length > 10) recentShapes.pop();\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tconst allPitches: number[] = note.pitches.concat(pitchBends);\r\n\t\t\t\t\t\tfor (let i: number = 0; i < allPitches.length; i++) {\r\n\t\t\t\t\t\t\tconst pitch: number = allPitches[i];\r\n\t\t\t\t\t\t\tconst pitchIndex: number = recentPitches.indexOf(pitch);\r\n\t\t\t\t\t\t\tif (pitchIndex == -1) {\r\n\t\t\t\t\t\t\t\tlet interval: number = 0;\r\n\t\t\t\t\t\t\t\tlet pitchIter: number = lastPitch;\r\n\t\t\t\t\t\t\t\tif (pitchIter < pitch) {\r\n\t\t\t\t\t\t\t\t\twhile (pitchIter != pitch) {\r\n\t\t\t\t\t\t\t\t\t\tpitchIter++;\r\n\t\t\t\t\t\t\t\t\t\tif (recentPitches.indexOf(pitchIter) == -1) interval++;\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\t\twhile (pitchIter != pitch) {\r\n\t\t\t\t\t\t\t\t\t\tpitchIter--;\r\n\t\t\t\t\t\t\t\t\t\tif (recentPitches.indexOf(pitchIter) == -1) interval--;\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\tbits.write(1, 0);\r\n\t\t\t\t\t\t\t\tbits.writePitchInterval(interval);\r\n\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\tbits.write(1, 1);\r\n\t\t\t\t\t\t\t\tbits.write(3, pitchIndex);\r\n\t\t\t\t\t\t\t\trecentPitches.splice(pitchIndex, 1);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\trecentPitches.unshift(pitch);\r\n\t\t\t\t\t\t\tif (recentPitches.length > 8) recentPitches.pop();\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tif (i == note.pitches.length - 1) {\r\n\t\t\t\t\t\t\t\tlastPitch = note.pitches[0];\r\n\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\tlastPitch = pitch;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tif (note.start == 0) {\r\n\t\t\t\t\t\t\tbits.write(1, note.continuesLastPattern ? 1 : 0);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tcurPart = note.end;\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t\tif (curPart < this.beatsPerBar * Config.partsPerBeat) {\r\n\t\t\t\t\t\tbits.write(2, 0); // rest\r\n\t\t\t\t\t\tbits.writePartDuration(this.beatsPerBar * Config.partsPerBeat - curPart);\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\tbits.write(1, 0);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\tlet stringLength: number = bits.lengthBase64();\r\n\t\tlet digits: number[] = [];\r\n\t\twhile (stringLength > 0) {\r\n\t\t\tdigits.unshift(base64IntToCharCode[stringLength & 0x3f]);\r\n\t\t\tstringLength = stringLength >> 6;\r\n\t\t}\r\n\t\tbuffer.push(base64IntToCharCode[digits.length]);\r\n\t\tArray.prototype.push.apply(buffer, digits); // append digits to buffer.\r\n\t\tbits.encodeBase64(buffer);\r\n\t\t\r\n\t\tconst maxApplyArgs: number = 64000;\r\n\t\tif (buffer.length < maxApplyArgs) {\r\n\t\t\t// Note: Function.apply may break for long argument lists. \r\n\t\t\treturn String.fromCharCode.apply(null, buffer);\r\n\t\t} else {\r\n\t\t\tlet result: string = \"\";\r\n\t\t\tfor (let i: number = 0; i < buffer.length; i += maxApplyArgs) {\r\n\t\t\t\tresult += String.fromCharCode.apply(null, buffer.slice(i, i + maxApplyArgs));\r\n\t\t\t}\r\n\t\t\treturn result;\r\n\t\t}\r\n\t}\r\n\t\r\n\tprivate static _envelopeFromLegacyIndex(legacyIndex: number): Envelope {\r\n\t\t// I swapped the order of \"custom\"/\"steady\", now \"none\"/\"note size\".\r\n\t\tif (legacyIndex == 0) legacyIndex = 1; else if (legacyIndex == 1) legacyIndex = 0;\r\n\t\treturn Config.envelopes[clamp(0, Config.envelopes.length, legacyIndex)];\r\n\t}\r\n\t\r\n\tpublic fromBase64String(compressed: string): void {\r\n\t\tif (compressed == null || compressed == \"\") {\r\n\t\t\tthis.initToDefault(true);\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tlet charIndex: number = 0;\r\n\t\t// skip whitespace.\r\n\t\twhile (compressed.charCodeAt(charIndex) <= CharCode.SPACE) charIndex++;\r\n\t\t// skip hash mark.\r\n\t\tif (compressed.charCodeAt(charIndex) == CharCode.HASH) charIndex++;\r\n\t\t// if it starts with curly brace, treat it as JSON.\r\n\t\tif (compressed.charCodeAt(charIndex) == CharCode.LEFT_CURLY_BRACE) {\r\n\t\t\tthis.fromJsonObject(JSON.parse(charIndex == 0 ? compressed : compressed.substring(charIndex)));\r\n\t\t\treturn;\r\n\t\t}\r\n\t\t\r\n\t\tconst version: number = base64CharCodeToInt[compressed.charCodeAt(charIndex++)];\r\n\t\tif (version == -1 || version > Song._latestVersion || version < Song._oldestVersion) return;\r\n\t\tconst beforeThree: boolean = version < 3;\r\n\t\tconst beforeFour:  boolean = version < 4;\r\n\t\tconst beforeFive:  boolean = version < 5;\r\n\t\tconst beforeSix:   boolean = version < 6;\r\n\t\tconst beforeSeven: boolean = version < 7;\r\n\t\tconst beforeEight: boolean = version < 8;\r\n\t\tconst beforeNine:  boolean = version < 9;\r\n\t\tthis.initToDefault(beforeNine);\r\n\t\t\r\n\t\tif (beforeThree) {\r\n\t\t\t// Originally, the only instrument transition was \"instant\" and the only drum wave was \"retro\".\r\n\t\t\tfor (const channel of this.channels) {\r\n\t\t\t\tchannel.instruments[0].transition = Config.transitions.dictionary[\"interrupt\"].index;\r\n\t\t\t\tchannel.instruments[0].effects |= 1 << EffectType.transition;\r\n\t\t\t}\r\n\t\t\tthis.channels[3].instruments[0].chipNoise = 0;\r\n\t\t}\r\n\t\t\r\n\t\tlet legacySettingsCache: LegacySettings[][] | null = null;\r\n\t\tif (beforeNine) {\r\n\t\t\t// Unfortunately, old versions of BeepBox had a variety of different ways of saving\r\n\t\t\t// filter-and-envelope-related parameters in the URL, and none of them directly\r\n\t\t\t// correspond to the new way of saving these parameters. We can approximate the old\r\n\t\t\t// settings by collecting all the old settings for an instrument and passing them to\r\n\t\t\t// convertLegacySettings(), so I use this data structure to collect the settings\r\n\t\t\t// for each instrument if necessary.\r\n\t\t\tlegacySettingsCache = [];\r\n\t\t\tfor (let i: number = legacySettingsCache.length; i < this.getChannelCount(); i++) {\r\n\t\t\t\tlegacySettingsCache[i] = [];\r\n\t\t\t\tfor (let j: number = 0; j < Config.instrumentCountMin; j++) legacySettingsCache[i][j] = {};\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tlet legacyGlobalReverb: number = 0; // beforeNine reverb was song-global, record that reverb here and adapt it to instruments as needed.\r\n\t\t\r\n\t\tlet instrumentChannelIterator: number = 0;\r\n\t\tlet instrumentIndexIterator: number = -1;\r\n\t\tlet command: SongTagCode;\r\n\t\twhile (charIndex < compressed.length) switch(command = compressed.charCodeAt(charIndex++)) {\r\n\t\t\tcase SongTagCode.channelCount: {\r\n\t\t\t\tthis.pitchChannelCount = base64CharCodeToInt[compressed.charCodeAt(charIndex++)];\r\n\t\t\t\tthis.noiseChannelCount = base64CharCodeToInt[compressed.charCodeAt(charIndex++)];\r\n\t\t\t\tthis.pitchChannelCount = validateRange(Config.pitchChannelCountMin, Config.pitchChannelCountMax, this.pitchChannelCount);\r\n\t\t\t\tthis.noiseChannelCount = validateRange(Config.noiseChannelCountMin, Config.noiseChannelCountMax, this.noiseChannelCount);\r\n\t\t\t\tfor (let channelIndex = this.channels.length; channelIndex < this.getChannelCount(); channelIndex++) {\r\n\t\t\t\t\tthis.channels[channelIndex] = new Channel();\r\n\t\t\t\t}\r\n\t\t\t\tthis.channels.length = this.getChannelCount();\r\n\t\t\t\tif (beforeNine) {\r\n\t\t\t\t\tfor (let i: number = legacySettingsCache!.length; i < this.getChannelCount(); i++) {\r\n\t\t\t\t\t\tlegacySettingsCache![i] = [];\r\n\t\t\t\t\t\tfor (let j: number = 0; j < Config.instrumentCountMin; j++) legacySettingsCache![i][j] = {};\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t} break;\r\n\t\t\tcase SongTagCode.scale: {\r\n\t\t\t\tthis.scale = base64CharCodeToInt[compressed.charCodeAt(charIndex++)];\r\n\t\t\t\tif (beforeThree && this.scale == 10) this.scale = 11;\r\n\t\t\t} break;\r\n\t\t\tcase SongTagCode.key: {\r\n\t\t\t\tif (beforeSeven) {\r\n\t\t\t\t\tthis.key = clamp(0, Config.keys.length, 11 - base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis.key = clamp(0, Config.keys.length, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n\t\t\t\t}\r\n\t\t\t} break;\r\n\t\t\tcase SongTagCode.loopStart: {\r\n\t\t\t\tif (beforeFive) {\r\n\t\t\t\t\tthis.loopStart = base64CharCodeToInt[compressed.charCodeAt(charIndex++)];\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis.loopStart = (base64CharCodeToInt[compressed.charCodeAt(charIndex++)] << 6) + base64CharCodeToInt[compressed.charCodeAt(charIndex++)];\r\n\t\t\t\t}\r\n\t\t\t} break;\r\n\t\t\tcase SongTagCode.loopEnd: {\r\n\t\t\t\tif (beforeFive) {\r\n\t\t\t\t\tthis.loopLength = base64CharCodeToInt[compressed.charCodeAt(charIndex++)];\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis.loopLength = (base64CharCodeToInt[compressed.charCodeAt(charIndex++)] << 6) + base64CharCodeToInt[compressed.charCodeAt(charIndex++)] + 1;\r\n\t\t\t\t}\r\n\t\t\t} break;\r\n\t\t\tcase SongTagCode.tempo: {\r\n\t\t\t\tif (beforeFour) {\r\n\t\t\t\t\tthis.tempo = [95, 120, 151, 190][base64CharCodeToInt[compressed.charCodeAt(charIndex++)]];\r\n\t\t\t\t} else if (beforeSeven) {\r\n\t\t\t\t\tthis.tempo = [88, 95, 103, 111, 120, 130, 140, 151, 163, 176, 190, 206, 222, 240, 259][base64CharCodeToInt[compressed.charCodeAt(charIndex++)]];\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis.tempo = (base64CharCodeToInt[compressed.charCodeAt(charIndex++)] << 6) | (base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n\t\t\t\t}\r\n\t\t\t\tthis.tempo = clamp(Config.tempoMin, Config.tempoMax + 1, this.tempo);\r\n\t\t\t} break;\r\n\t\t\tcase SongTagCode.reverb: {\r\n\t\t\t\tif (beforeNine) {\r\n\t\t\t\t\tlegacyGlobalReverb = base64CharCodeToInt[compressed.charCodeAt(charIndex++)];\r\n\t\t\t\t\tlegacyGlobalReverb = clamp(0, 4, legacyGlobalReverb);\r\n\t\t\t\t} else {\r\n\t\t\t\t\t// Do nothing? This song tag code is deprecated for now.\r\n\t\t\t\t}\r\n\t\t\t} break;\r\n\t\t\tcase SongTagCode.beatCount: {\r\n\t\t\t\tif (beforeThree) {\r\n\t\t\t\t\tthis.beatsPerBar = [6, 7, 8, 9, 10][base64CharCodeToInt[compressed.charCodeAt(charIndex++)]];\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis.beatsPerBar = base64CharCodeToInt[compressed.charCodeAt(charIndex++)] + 1;\r\n\t\t\t\t}\r\n\t\t\t\tthis.beatsPerBar = Math.max(Config.beatsPerBarMin, Math.min(Config.beatsPerBarMax, this.beatsPerBar));\r\n\t\t\t} break;\r\n\t\t\tcase SongTagCode.barCount: {\r\n\t\t\t\tconst barCount: number = (base64CharCodeToInt[compressed.charCodeAt(charIndex++)] << 6) + base64CharCodeToInt[compressed.charCodeAt(charIndex++)] + 1;\r\n\t\t\t\tthis.barCount = validateRange(Config.barCountMin, Config.barCountMax, barCount);\r\n\t\t\t\tfor (let channelIndex: number = 0; channelIndex < this.getChannelCount(); channelIndex++) {\r\n\t\t\t\t\tfor (let bar = this.channels[channelIndex].bars.length; bar < this.barCount; bar++) {\r\n\t\t\t\t\t\tthis.channels[channelIndex].bars[bar] = 1;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tthis.channels[channelIndex].bars.length = this.barCount;\r\n\t\t\t\t}\r\n\t\t\t} break;\r\n\t\t\tcase SongTagCode.patternCount: {\r\n\t\t\t\tlet patternsPerChannel: number;\r\n\t\t\t\tif (beforeEight) {\r\n\t\t\t\t\tpatternsPerChannel = base64CharCodeToInt[compressed.charCodeAt(charIndex++)] + 1;\r\n\t\t\t\t} else {\r\n\t\t\t\t\tpatternsPerChannel = (base64CharCodeToInt[compressed.charCodeAt(charIndex++)] << 6) + base64CharCodeToInt[compressed.charCodeAt(charIndex++)] + 1;\r\n\t\t\t\t}\r\n\t\t\t\tthis.patternsPerChannel = validateRange(1, Config.barCountMax, patternsPerChannel);\r\n\t\t\t\tconst channelCount: number = this.getChannelCount();\r\n\t\t\t\tfor (let channelIndex: number = 0; channelIndex < channelCount; channelIndex++) {\r\n\t\t\t\t\tconst patterns: Pattern[] = this.channels[channelIndex].patterns;\r\n\t\t\t\t\tfor (let pattern = patterns.length; pattern < this.patternsPerChannel; pattern++) {\r\n\t\t\t\t\t\tpatterns[pattern] = new Pattern();\r\n\t\t\t\t\t}\r\n\t\t\t\t\tpatterns.length = this.patternsPerChannel;\r\n\t\t\t\t}\r\n\t\t\t} break;\r\n\t\t\tcase SongTagCode.instrumentCount: {\r\n\t\t\t\tif (beforeNine) {\r\n\t\t\t\t\tconst instrumentsPerChannel: number = validateRange(Config.instrumentCountMin, Config.patternInstrumentCountMax, base64CharCodeToInt[compressed.charCodeAt(charIndex++)] + Config.instrumentCountMin);\r\n\t\t\t\t\tthis.layeredInstruments = false;\r\n\t\t\t\t\tthis.patternInstruments = (instrumentsPerChannel > 1);\r\n\t\t\t\t\t\r\n\t\t\t\t\tfor (let channelIndex: number = 0; channelIndex < this.getChannelCount(); channelIndex++) {\r\n\t\t\t\t\t\tconst isNoiseChannel: boolean = channelIndex >= this.pitchChannelCount;\r\n\t\t\t\t\t\tfor (let instrumentIndex: number = this.channels[channelIndex].instruments.length; instrumentIndex < instrumentsPerChannel; instrumentIndex++) {\r\n\t\t\t\t\t\t\tthis.channels[channelIndex].instruments[instrumentIndex] = new Instrument(isNoiseChannel);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tthis.channels[channelIndex].instruments.length = instrumentsPerChannel;\r\n\t\t\t\t\t\tif (beforeSix) {\r\n\t\t\t\t\t\t\tfor (let instrumentIndex: number = 0; instrumentIndex < instrumentsPerChannel; instrumentIndex++) {\r\n\t\t\t\t\t\t\t\tthis.channels[channelIndex].instruments[instrumentIndex].setTypeAndReset(isNoiseChannel ? InstrumentType.noise : InstrumentType.chip, isNoiseChannel);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tfor (let j: number = legacySettingsCache![channelIndex].length; j < instrumentsPerChannel; j++) {\r\n\t\t\t\t\t\t\tlegacySettingsCache![channelIndex][j] = {};\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\tconst instrumentsFlagBits: number = base64CharCodeToInt[compressed.charCodeAt(charIndex++)];\r\n\t\t\t\t\tthis.layeredInstruments = (instrumentsFlagBits & (1 << 1)) != 0;\r\n\t\t\t\t\tthis.patternInstruments = (instrumentsFlagBits & (1 << 0)) != 0;\r\n\t\t\t\t\tfor (let channelIndex: number = 0; channelIndex < this.getChannelCount(); channelIndex++) {\r\n\t\t\t\t\t\tlet instrumentCount: number = 1;\r\n\t\t\t\t\t\tif (this.layeredInstruments || this.patternInstruments) {\r\n\t\t\t\t\t\t\tinstrumentCount = validateRange(Config.instrumentCountMin, this.getMaxInstrumentsPerChannel(), base64CharCodeToInt[compressed.charCodeAt(charIndex++)] + Config.instrumentCountMin);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tconst channel: Channel = this.channels[channelIndex];\r\n\t\t\t\t\t\tconst isNoiseChannel: boolean = this.getChannelIsNoise(channelIndex);\r\n\t\t\t\t\t\tfor (let i: number = channel.instruments.length; i < instrumentCount; i++) {\r\n\t\t\t\t\t\t\tchannel.instruments[i] = new Instrument(isNoiseChannel);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tchannel.instruments.length = instrumentCount;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t} break;\r\n\t\t\tcase SongTagCode.rhythm: {\r\n\t\t\t\tthis.rhythm = base64CharCodeToInt[compressed.charCodeAt(charIndex++)];\r\n\t\t\t} break;\r\n\t\t\tcase SongTagCode.channelOctave: {\r\n\t\t\t\tif (beforeThree) {\r\n\t\t\t\t\tconst channelIndex: number = base64CharCodeToInt[compressed.charCodeAt(charIndex++)];\r\n\t\t\t\t\tthis.channels[channelIndex].octave = clamp(0, Config.pitchOctaves, base64CharCodeToInt[compressed.charCodeAt(charIndex++)] + 1);\r\n\t\t\t\t\tif (channelIndex >= this.pitchChannelCount) this.channels[channelIndex].octave = 0;\r\n\t\t\t\t} else if (beforeNine) {\r\n\t\t\t\t\tfor (let channelIndex: number = 0; channelIndex < this.getChannelCount(); channelIndex++) {\r\n\t\t\t\t\t\tthis.channels[channelIndex].octave = clamp(0, Config.pitchOctaves, base64CharCodeToInt[compressed.charCodeAt(charIndex++)] + 1);\r\n\t\t\t\t\t\tif (channelIndex >= this.pitchChannelCount) this.channels[channelIndex].octave = 0;\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\tfor (let channelIndex: number = 0; channelIndex < this.pitchChannelCount; channelIndex++) {\r\n\t\t\t\t\t\tthis.channels[channelIndex].octave = clamp(0, Config.pitchOctaves, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tfor (let channelIndex: number = this.pitchChannelCount; channelIndex < this.getChannelCount(); channelIndex++) {\r\n\t\t\t\t\t\tthis.channels[channelIndex].octave = 0;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t} break;\r\n\t\t\tcase SongTagCode.startInstrument: {\r\n\t\t\t\tinstrumentIndexIterator++;\r\n\t\t\t\tif (instrumentIndexIterator >= this.channels[instrumentChannelIterator].instruments.length) {\r\n\t\t\t\t\tinstrumentChannelIterator++;\r\n\t\t\t\t\tinstrumentIndexIterator = 0;\r\n\t\t\t\t}\r\n\t\t\t\tvalidateRange(0, this.channels.length - 1, instrumentChannelIterator);\r\n\t\t\t\tconst instrument: Instrument = this.channels[instrumentChannelIterator].instruments[instrumentIndexIterator];\r\n\t\t\t\tconst instrumentType: number = validateRange(0, InstrumentType.length - 1, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n\t\t\t\tinstrument.setTypeAndReset(instrumentType, instrumentChannelIterator >= this.pitchChannelCount);\r\n\t\t\t\t\r\n\t\t\t\tif (beforeSeven) {\r\n\t\t\t\t\tinstrument.effects = 0;\r\n\t\t\t\t\t// the reverb effect was applied to all pitched instruments if nonzero but never explicitly enabled if beforeSeven, so enable it here.\r\n\t\t\t\t\tif (legacyGlobalReverb > 0 && !this.getChannelIsNoise(instrumentChannelIterator)) {\r\n\t\t\t\t\t\tinstrument.reverb = legacyGlobalReverb;\r\n\t\t\t\t\t\tinstrument.effects |= 1 << EffectType.reverb;\r\n\t\t\t\t\t}\r\n\t\t\t\t\t// Chip/noise instruments had arpeggio and FM had custom interval but neither\r\n\t\t\t\t\t// explicitly saved the chorus setting beforeSeven so enable it here.\r\n\t\t\t\t\tif (instrument.chord != Config.chords.dictionary[\"simultaneous\"].index) {\r\n\t\t\t\t\t\t// Enable chord if it was used.\r\n\t\t\t\t\t\tinstrument.effects |= 1 << EffectType.chord;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t} break;\r\n\t\t\tcase SongTagCode.preset: {\r\n\t\t\t\tconst presetValue: number = (base64CharCodeToInt[compressed.charCodeAt(charIndex++)] << 6) | (base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n\t\t\t\tthis.channels[instrumentChannelIterator].instruments[instrumentIndexIterator].preset = presetValue;\r\n\t\t\t} break;\r\n\t\t\tcase SongTagCode.wave: {\r\n\t\t\t\tif (beforeThree) {\r\n\t\t\t\t\tconst legacyWaves: number[] = [1, 2, 3, 4, 5, 6, 7, 8, 0];\r\n\t\t\t\t\tconst channelIndex: number = base64CharCodeToInt[compressed.charCodeAt(charIndex++)];\r\n\t\t\t\t\tconst instrument: Instrument = this.channels[channelIndex].instruments[0];\r\n\t\t\t\t\tinstrument.chipWave = clamp(0, Config.chipWaves.length, legacyWaves[base64CharCodeToInt[compressed.charCodeAt(charIndex++)]] | 0);\r\n\t\t\t\t\t\r\n\t\t\t\t\t// Version 2 didn't save any settings for settings for filters, or envelopes,\r\n\t\t\t\t\t// just waves, so initialize them here I guess.\r\n\t\t\t\t\tinstrument.convertLegacySettings(legacySettingsCache![channelIndex][0]);\r\n\t\t\t\t\t\r\n\t\t\t\t} else if (beforeSix) {\r\n\t\t\t\t\tconst legacyWaves: number[] = [1, 2, 3, 4, 5, 6, 7, 8, 0];\r\n\t\t\t\t\tfor (let channelIndex: number = 0; channelIndex < this.getChannelCount(); channelIndex++) {\r\n\t\t\t\t\t\tfor (const instrument of this.channels[channelIndex].instruments) {\r\n\t\t\t\t\t\t\tif (channelIndex >= this.pitchChannelCount) {\r\n\t\t\t\t\t\t\t\tinstrument.chipNoise = clamp(0, Config.chipNoises.length, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\tinstrument.chipWave = clamp(0, Config.chipWaves.length, legacyWaves[base64CharCodeToInt[compressed.charCodeAt(charIndex++)]] | 0);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t} else if (beforeSeven) {\r\n\t\t\t\t\tconst legacyWaves: number[] = [1, 2, 3, 4, 5, 6, 7, 8, 0];\r\n\t\t\t\t\tif (instrumentChannelIterator >= this.pitchChannelCount) {\r\n\t\t\t\t\t\tthis.channels[instrumentChannelIterator].instruments[instrumentIndexIterator].chipNoise = clamp(0, Config.chipNoises.length, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tthis.channels[instrumentChannelIterator].instruments[instrumentIndexIterator].chipWave = clamp(0, Config.chipWaves.length, legacyWaves[base64CharCodeToInt[compressed.charCodeAt(charIndex++)]] | 0);\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\tif (instrumentChannelIterator >= this.pitchChannelCount) {\r\n\t\t\t\t\t\tthis.channels[instrumentChannelIterator].instruments[instrumentIndexIterator].chipNoise = clamp(0, Config.chipNoises.length, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tthis.channels[instrumentChannelIterator].instruments[instrumentIndexIterator].chipWave = clamp(0, Config.chipWaves.length, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t} break;\r\n\t\t\tcase SongTagCode.eqFilter: {\r\n\t\t\t\tif (beforeNine) {\r\n\t\t\t\t\tif (beforeSeven) {\r\n\t\t\t\t\t\tconst legacyToCutoff: number[] = [10, 6, 3, 0, 8, 5, 2];\r\n\t\t\t\t\t\tconst legacyToEnvelope: string[] = [\"none\", \"none\", \"none\", \"none\", \"decay 1\", \"decay 2\", \"decay 3\"];\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tif (beforeThree) {\r\n\t\t\t\t\t\t\tconst channelIndex: number = base64CharCodeToInt[compressed.charCodeAt(charIndex++)];\r\n\t\t\t\t\t\t\tconst instrument: Instrument = this.channels[channelIndex].instruments[0];\r\n\t\t\t\t\t\t\tconst legacySettings: LegacySettings = legacySettingsCache![channelIndex][0];\r\n\t\t\t\t\t\t\tconst legacyFilter: number = [1, 3, 4, 5][clamp(0, legacyToCutoff.length, base64CharCodeToInt[compressed.charCodeAt(charIndex++)])];\r\n\t\t\t\t\t\t\tlegacySettings.filterCutoff = legacyToCutoff[legacyFilter];\r\n\t\t\t\t\t\t\tlegacySettings.filterResonance = 0;\r\n\t\t\t\t\t\t\tlegacySettings.filterEnvelope = Config.envelopes.dictionary[legacyToEnvelope[legacyFilter]];\r\n\t\t\t\t\t\t\tinstrument.convertLegacySettings(legacySettings);\r\n\t\t\t\t\t\t} else if (beforeSix) {\r\n\t\t\t\t\t\t\tfor (let channelIndex: number = 0; channelIndex < this.getChannelCount(); channelIndex++) {\r\n\t\t\t\t\t\t\t\tfor (let i: number = 0; i < this.channels[channelIndex].instruments.length; i++) {\r\n\t\t\t\t\t\t\t\t\tconst instrument: Instrument = this.channels[channelIndex].instruments[i];\r\n\t\t\t\t\t\t\t\t\tconst legacySettings: LegacySettings = legacySettingsCache![channelIndex][i];\r\n\t\t\t\t\t\t\t\t\tconst legacyFilter: number = clamp(0, legacyToCutoff.length, base64CharCodeToInt[compressed.charCodeAt(charIndex++)] + 1);\r\n\t\t\t\t\t\t\t\t\tif (channelIndex < this.pitchChannelCount) {\r\n\t\t\t\t\t\t\t\t\t\tlegacySettings.filterCutoff = legacyToCutoff[legacyFilter];\r\n\t\t\t\t\t\t\t\t\t\tlegacySettings.filterResonance = 0;\r\n\t\t\t\t\t\t\t\t\t\tlegacySettings.filterEnvelope = Config.envelopes.dictionary[legacyToEnvelope[legacyFilter]];\r\n\t\t\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\t\t\tlegacySettings.filterCutoff = 10;\r\n\t\t\t\t\t\t\t\t\t\tlegacySettings.filterResonance = 0;\r\n\t\t\t\t\t\t\t\t\t\tlegacySettings.filterEnvelope = Config.envelopes.dictionary[\"none\"];\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\tinstrument.convertLegacySettings(legacySettings);\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\tconst legacyFilter: number = clamp(0, legacyToCutoff.length, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n\t\t\t\t\t\t\tconst instrument: Instrument = this.channels[instrumentChannelIterator].instruments[instrumentIndexIterator];\r\n\t\t\t\t\t\t\tconst legacySettings: LegacySettings = legacySettingsCache![instrumentChannelIterator][instrumentIndexIterator];\r\n\t\t\t\t\t\t\tlegacySettings.filterCutoff = legacyToCutoff[legacyFilter];\r\n\t\t\t\t\t\t\tlegacySettings.filterResonance = 0;\r\n\t\t\t\t\t\t\tlegacySettings.filterEnvelope = Config.envelopes.dictionary[legacyToEnvelope[legacyFilter]];\r\n\t\t\t\t\t\t\tinstrument.convertLegacySettings(legacySettings);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tconst filterCutoffRange: number = 11;\r\n\t\t\t\t\t\tconst instrument: Instrument = this.channels[instrumentChannelIterator].instruments[instrumentIndexIterator];\r\n\t\t\t\t\t\tconst legacySettings: LegacySettings = legacySettingsCache![instrumentChannelIterator][instrumentIndexIterator];\r\n\t\t\t\t\t\tlegacySettings.filterCutoff = clamp(0, filterCutoffRange, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n\t\t\t\t\t\tinstrument.convertLegacySettings(legacySettings);\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\tconst instrument: Instrument = this.channels[instrumentChannelIterator].instruments[instrumentIndexIterator];\r\n\t\t\t\t\tconst originalControlPointCount: number = base64CharCodeToInt[compressed.charCodeAt(charIndex++)];\r\n\t\t\t\t\tinstrument.eqFilter.controlPointCount = clamp(0, Config.filterMaxPoints + 1, originalControlPointCount);\r\n\t\t\t\t\tfor (let i: number = instrument.eqFilter.controlPoints.length; i < instrument.eqFilter.controlPointCount; i++) {\r\n\t\t\t\t\t\tinstrument.eqFilter.controlPoints[i] = new FilterControlPoint();\r\n\t\t\t\t\t}\r\n\t\t\t\t\tfor (let i: number = 0; i < instrument.eqFilter.controlPointCount; i++) {\r\n\t\t\t\t\t\tconst point: FilterControlPoint = instrument.eqFilter.controlPoints[i];\r\n\t\t\t\t\t\tpoint.type = clamp(0, FilterType.length, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n\t\t\t\t\t\tpoint.freq = clamp(0, Config.filterFreqRange, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n\t\t\t\t\t\tpoint.gain = clamp(0, Config.filterGainRange, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tfor (let i: number = instrument.eqFilter.controlPointCount; i < originalControlPointCount; i++) {\r\n\t\t\t\t\t\tcharIndex += 3;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t} break;\r\n\t\t\tcase SongTagCode.filterResonance: {\r\n\t\t\t\tif (beforeNine) {\r\n\t\t\t\t\tconst filterResonanceRange: number = 8;\r\n\t\t\t\t\tconst instrument: Instrument = this.channels[instrumentChannelIterator].instruments[instrumentIndexIterator];\r\n\t\t\t\t\tconst legacySettings: LegacySettings = legacySettingsCache![instrumentChannelIterator][instrumentIndexIterator];\r\n\t\t\t\t\tlegacySettings.filterResonance = clamp(0, filterResonanceRange, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n\t\t\t\t\tinstrument.convertLegacySettings(legacySettings);\r\n\t\t\t\t} else {\r\n\t\t\t\t\t// Do nothing? This song tag code is deprecated for now.\r\n\t\t\t\t}\r\n\t\t\t} break;\r\n\t\t\tcase SongTagCode.drumsetEnvelopes: {\r\n\t\t\t\tconst instrument: Instrument = this.channels[instrumentChannelIterator].instruments[instrumentIndexIterator];\r\n\t\t\t\tif (beforeNine) {\r\n\t\t\t\t\tif (instrument.type == InstrumentType.drumset) {\r\n\t\t\t\t\t\tfor (let i: number = 0; i < Config.drumCount; i++) {\r\n\t\t\t\t\t\t\tinstrument.drumsetEnvelopes[i] = Song._envelopeFromLegacyIndex(base64CharCodeToInt[compressed.charCodeAt(charIndex++)]).index;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\t// This used to be used for general filter envelopes.\r\n\t\t\t\t\t\t// The presence of an envelope affects how convertLegacySettings\r\n\t\t\t\t\t\t// decides the closest possible approximation, so update it.\r\n\t\t\t\t\t\tconst legacySettings: LegacySettings = legacySettingsCache![instrumentChannelIterator][instrumentIndexIterator];\r\n\t\t\t\t\t\tlegacySettings.filterEnvelope = Song._envelopeFromLegacyIndex(base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n\t\t\t\t\t\tinstrument.convertLegacySettings(legacySettings);\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\t// This tag is now only used for drumset filter envelopes.\r\n\t\t\t\t\tfor (let i: number = 0; i < Config.drumCount; i++) {\r\n\t\t\t\t\t\tinstrument.drumsetEnvelopes[i] = clamp(0, Config.envelopes.length, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t} break;\r\n\t\t\tcase SongTagCode.pulseWidth: {\r\n\t\t\t\tconst instrument: Instrument = this.channels[instrumentChannelIterator].instruments[instrumentIndexIterator];\r\n\t\t\t\tinstrument.pulseWidth = clamp(0, Config.pulseWidthRange, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n\t\t\t\t\r\n\t\t\t\tif (beforeNine) {\r\n\t\t\t\t\tconst legacySettings: LegacySettings = legacySettingsCache![instrumentChannelIterator][instrumentIndexIterator];\r\n\t\t\t\t\tlegacySettings.pulseEnvelope = Song._envelopeFromLegacyIndex(base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n\t\t\t\t\tinstrument.convertLegacySettings(legacySettings);\r\n\t\t\t\t}\r\n\t\t\t} break;\r\n\t\t\tcase SongTagCode.supersaw: {\r\n\t\t\t\tconst instrument: Instrument = this.channels[instrumentChannelIterator].instruments[instrumentIndexIterator];\r\n\t\t\t\tinstrument.supersawDynamism = clamp(0, Config.supersawDynamismMax + 1, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n\t\t\t\tinstrument.supersawSpread = clamp(0, Config.supersawSpreadMax + 1, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n\t\t\t\tinstrument.supersawShape = clamp(0, Config.supersawShapeMax + 1, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n\t\t\t} break;\r\n\t\t\tcase SongTagCode.stringSustain: {\r\n\t\t\t\tconst instrument: Instrument = this.channels[instrumentChannelIterator].instruments[instrumentIndexIterator];\r\n\t\t\t\tconst sustainValue: number = base64CharCodeToInt[compressed.charCodeAt(charIndex++)];\r\n\t\t\t\tinstrument.stringSustain = clamp(0, Config.stringSustainRange, sustainValue & 0x1F);\r\n\t\t\t\tinstrument.stringSustainType = Config.enableAcousticSustain ? clamp(0, SustainType.length, sustainValue >> 5) : SustainType.bright;\r\n\t\t\t} break;\r\n\t\t\tcase SongTagCode.fadeInOut: {\r\n\t\t\t\tif (beforeNine) {\r\n\t\t\t\t\t// this tag was used for a combination of transition and fade in/out.\r\n\t\t\t\t\tconst legacySettings = [\r\n\t\t\t\t\t\t{transition: \"interrupt\", fadeInSeconds: 0.0,    fadeOutTicks: -1},\r\n\t\t\t\t\t\t{transition: \"normal\",    fadeInSeconds: 0.0,    fadeOutTicks: -3},\r\n\t\t\t\t\t\t{transition: \"normal\",    fadeInSeconds: 0.025,  fadeOutTicks: -3},\r\n\t\t\t\t\t\t{transition: \"slide in pattern\", fadeInSeconds: 0.025,  fadeOutTicks: -3},\r\n\t\t\t\t\t\t{transition: \"normal\",    fadeInSeconds: 0.04,   fadeOutTicks:  6},\r\n\t\t\t\t\t\t{transition: \"normal\",    fadeInSeconds: 0.0,    fadeOutTicks: 48},\r\n\t\t\t\t\t\t{transition: \"normal\",    fadeInSeconds: 0.0125, fadeOutTicks: 72},\r\n\t\t\t\t\t\t{transition: \"normal\",    fadeInSeconds: 0.06,   fadeOutTicks: 96},\r\n\t\t\t\t\t];\r\n\t\t\t\t\tif (beforeThree) {\r\n\t\t\t\t\t\tconst channelIndex: number = base64CharCodeToInt[compressed.charCodeAt(charIndex++)];\r\n\t\t\t\t\t\tconst settings = legacySettings[clamp(0, legacySettings.length, base64CharCodeToInt[compressed.charCodeAt(charIndex++)])];\r\n\t\t\t\t\t\tconst instrument: Instrument = this.channels[channelIndex].instruments[0];\r\n\t\t\t\t\t\tinstrument.fadeIn = Synth.secondsToFadeInSetting(settings.fadeInSeconds);\r\n\t\t\t\t\t\tinstrument.fadeOut = Synth.ticksToFadeOutSetting(settings.fadeOutTicks);\r\n\t\t\t\t\t\tinstrument.transition = Config.transitions.dictionary[settings.transition].index;\r\n\t\t\t\t\t\tif (instrument.transition != Config.transitions.dictionary[\"normal\"].index) {\r\n\t\t\t\t\t\t\t// Enable transition if it was used.\r\n\t\t\t\t\t\t\tinstrument.effects |= 1 << EffectType.transition;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t} else if (beforeSix) {\r\n\t\t\t\t\t\tfor (let channelIndex: number = 0; channelIndex < this.getChannelCount(); channelIndex++) {\r\n\t\t\t\t\t\t\tfor (const instrument of this.channels[channelIndex].instruments) {\r\n\t\t\t\t\t\t\t\tconst settings = legacySettings[clamp(0, legacySettings.length, base64CharCodeToInt[compressed.charCodeAt(charIndex++)])];\r\n\t\t\t\t\t\t\t\tinstrument.fadeIn = Synth.secondsToFadeInSetting(settings.fadeInSeconds);\r\n\t\t\t\t\t\t\t\tinstrument.fadeOut = Synth.ticksToFadeOutSetting(settings.fadeOutTicks);\r\n\t\t\t\t\t\t\t\tinstrument.transition = Config.transitions.dictionary[settings.transition].index;\r\n\t\t\t\t\t\t\t\tif (instrument.transition != Config.transitions.dictionary[\"normal\"].index) {\r\n\t\t\t\t\t\t\t\t\t// Enable transition if it was used.\r\n\t\t\t\t\t\t\t\t\tinstrument.effects |= 1 << EffectType.transition;\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tconst settings = legacySettings[clamp(0, legacySettings.length, base64CharCodeToInt[compressed.charCodeAt(charIndex++)])];\r\n\t\t\t\t\t\tconst instrument: Instrument = this.channels[instrumentChannelIterator].instruments[instrumentIndexIterator];\r\n\t\t\t\t\t\tinstrument.fadeIn = Synth.secondsToFadeInSetting(settings.fadeInSeconds);\r\n\t\t\t\t\t\tinstrument.fadeOut = Synth.ticksToFadeOutSetting(settings.fadeOutTicks);\r\n\t\t\t\t\t\tinstrument.transition = Config.transitions.dictionary[settings.transition].index;\r\n\t\t\t\t\t\tif (instrument.transition != Config.transitions.dictionary[\"normal\"].index) {\r\n\t\t\t\t\t\t\t// Enable transition if it was used.\r\n\t\t\t\t\t\t\tinstrument.effects |= 1 << EffectType.transition;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\tconst instrument: Instrument = this.channels[instrumentChannelIterator].instruments[instrumentIndexIterator];\r\n\t\t\t\t\tinstrument.fadeIn = clamp(0, Config.fadeInRange, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n\t\t\t\t\tinstrument.fadeOut = clamp(0, Config.fadeOutTicks.length, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n\t\t\t\t}\r\n\t\t\t} break;\r\n\t\t\tcase SongTagCode.vibrato: {\r\n\t\t\t\tif (beforeNine) {\r\n\t\t\t\t\tif (beforeSeven) {\r\n\t\t\t\t\t\tif (beforeThree) {\r\n\t\t\t\t\t\t\tconst legacyEffects: number[] = [0, 3, 2, 0];\r\n\t\t\t\t\t\t\tconst legacyEnvelopes: string[] = [\"none\", \"none\", \"none\", \"tremolo2\"];\r\n\t\t\t\t\t\t\tconst channelIndex: number = base64CharCodeToInt[compressed.charCodeAt(charIndex++)];\r\n\t\t\t\t\t\t\tconst effect: number = clamp(0, legacyEffects.length, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n\t\t\t\t\t\t\tconst instrument: Instrument = this.channels[channelIndex].instruments[0];\r\n\t\t\t\t\t\t\tconst legacySettings: LegacySettings = legacySettingsCache![channelIndex][0];\r\n\t\t\t\t\t\t\tinstrument.vibrato = legacyEffects[effect];\r\n\t\t\t\t\t\t\tif (legacySettings.filterEnvelope == undefined || legacySettings.filterEnvelope.type == EnvelopeType.none) {\r\n\t\t\t\t\t\t\t\t// Imitate the legacy tremolo with a filter envelope.\r\n\t\t\t\t\t\t\t\tlegacySettings.filterEnvelope = Config.envelopes.dictionary[legacyEnvelopes[effect]];\r\n\t\t\t\t\t\t\t\tinstrument.convertLegacySettings(legacySettings);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tif (instrument.vibrato != Config.vibratos.dictionary[\"none\"].index) {\r\n\t\t\t\t\t\t\t\t// Enable vibrato if it was used.\r\n\t\t\t\t\t\t\t\tinstrument.effects |= 1 << EffectType.vibrato;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t} else if (beforeSix) {\r\n\t\t\t\t\t\t\tconst legacyEffects: number[] = [0, 1, 2, 3, 0, 0];\r\n\t\t\t\t\t\t\tconst legacyEnvelopes: string[] = [\"none\", \"none\", \"none\", \"none\", \"tremolo5\", \"tremolo2\"];\r\n\t\t\t\t\t\t\tfor (let channelIndex: number = 0; channelIndex < this.getChannelCount(); channelIndex++) {\r\n\t\t\t\t\t\t\t\tfor (let i: number = 0; i < this.channels[channelIndex].instruments.length; i++) {\r\n\t\t\t\t\t\t\t\t\tconst effect: number = clamp(0, legacyEffects.length, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n\t\t\t\t\t\t\t\t\tconst instrument: Instrument = this.channels[channelIndex].instruments[i];\r\n\t\t\t\t\t\t\t\t\tconst legacySettings: LegacySettings = legacySettingsCache![channelIndex][i];\r\n\t\t\t\t\t\t\t\t\tinstrument.vibrato = legacyEffects[effect];\r\n\t\t\t\t\t\t\t\t\tif (legacySettings.filterEnvelope == undefined || legacySettings.filterEnvelope.type == EnvelopeType.none) {\r\n\t\t\t\t\t\t\t\t\t\t// Imitate the legacy tremolo with a filter envelope.\r\n\t\t\t\t\t\t\t\t\t\tlegacySettings.filterEnvelope = Config.envelopes.dictionary[legacyEnvelopes[effect]];\r\n\t\t\t\t\t\t\t\t\t\tinstrument.convertLegacySettings(legacySettings);\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\tif (instrument.vibrato != Config.vibratos.dictionary[\"none\"].index) {\r\n\t\t\t\t\t\t\t\t\t\t// Enable vibrato if it was used.\r\n\t\t\t\t\t\t\t\t\t\tinstrument.effects |= 1 << EffectType.vibrato;\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\tif (legacyGlobalReverb != 0 && !this.getChannelIsNoise(channelIndex)) {\r\n\t\t\t\t\t\t\t\t\t\t// Enable reverb if it was used globaly before. (Global reverb was added before the effects option so I need to pick somewhere else to initialize instrument reverb, and I picked the vibrato command.)\r\n\t\t\t\t\t\t\t\t\t\tinstrument.effects |= 1 << EffectType.reverb;\r\n\t\t\t\t\t\t\t\t\t\tinstrument.reverb = legacyGlobalReverb;\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\tconst legacyEffects: number[] = [0, 1, 2, 3, 0, 0];\r\n\t\t\t\t\t\t\tconst legacyEnvelopes: string[] = [\"none\", \"none\", \"none\", \"none\", \"tremolo5\", \"tremolo2\"];\r\n\t\t\t\t\t\t\tconst effect: number = clamp(0, legacyEffects.length, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n\t\t\t\t\t\t\tconst instrument: Instrument = this.channels[instrumentChannelIterator].instruments[instrumentIndexIterator];\r\n\t\t\t\t\t\t\tconst legacySettings: LegacySettings = legacySettingsCache![instrumentChannelIterator][instrumentIndexIterator];\r\n\t\t\t\t\t\t\tinstrument.vibrato = legacyEffects[effect];\r\n\t\t\t\t\t\t\tif (legacySettings.filterEnvelope == undefined || legacySettings.filterEnvelope.type == EnvelopeType.none) {\r\n\t\t\t\t\t\t\t\t// Imitate the legacy tremolo with a filter envelope.\r\n\t\t\t\t\t\t\t\tlegacySettings.filterEnvelope = Config.envelopes.dictionary[legacyEnvelopes[effect]];\r\n\t\t\t\t\t\t\t\tinstrument.convertLegacySettings(legacySettings);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tif (instrument.vibrato != Config.vibratos.dictionary[\"none\"].index) {\r\n\t\t\t\t\t\t\t\t// Enable vibrato if it was used.\r\n\t\t\t\t\t\t\t\tinstrument.effects |= 1 << EffectType.vibrato;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tif (legacyGlobalReverb != 0) {\r\n\t\t\t\t\t\t\t\t// Enable reverb if it was used globaly before. (Global reverb was added before the effects option so I need to pick somewhere else to initialize instrument reverb, and I picked the vibrato command.)\r\n\t\t\t\t\t\t\t\tinstrument.effects |= 1 << EffectType.reverb;\r\n\t\t\t\t\t\t\t\tinstrument.reverb = legacyGlobalReverb;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tconst instrument: Instrument = this.channels[instrumentChannelIterator].instruments[instrumentIndexIterator];\r\n\t\t\t\t\t\tconst vibrato: number = clamp(0, Config.vibratos.length, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n\t\t\t\t\t\tinstrument.vibrato = vibrato;\r\n\t\t\t\t\t\tif (instrument.vibrato != Config.vibratos.dictionary[\"none\"].index) {\r\n\t\t\t\t\t\t\t// Enable vibrato if it was used.\r\n\t\t\t\t\t\t\tinstrument.effects |= 1 << EffectType.vibrato;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\t// Do nothing? This song tag code is deprecated for now.\r\n\t\t\t\t}\r\n\t\t\t} break;\r\n\t\t\tcase SongTagCode.unison: {\r\n\t\t\t\tif (beforeThree) {\r\n\t\t\t\t\tconst channelIndex: number = base64CharCodeToInt[compressed.charCodeAt(charIndex++)];\r\n\t\t\t\t\tthis.channels[channelIndex].instruments[0].unison = clamp(0, Config.unisons.length, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n\t\t\t\t} else if (beforeSix) {\r\n\t\t\t\t\tfor (let channelIndex: number = 0; channelIndex < this.getChannelCount(); channelIndex++) {\r\n\t\t\t\t\t\tfor (const instrument of this.channels[channelIndex].instruments) {\r\n\t\t\t\t\t\t\tconst originalValue: number = base64CharCodeToInt[compressed.charCodeAt(charIndex++)];\r\n\t\t\t\t\t\t\tlet unison: number = clamp(0, Config.unisons.length, originalValue);\r\n\t\t\t\t\t\t\tif (originalValue == 8) {\r\n\t\t\t\t\t\t\t\t// original \"custom harmony\" now maps to \"hum\" and \"custom interval\".\r\n\t\t\t\t\t\t\t\tunison = 2;\r\n\t\t\t\t\t\t\t\tinstrument.chord = 3;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tinstrument.unison = unison;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t} else if (beforeSeven) {\r\n\t\t\t\t\tconst originalValue: number = base64CharCodeToInt[compressed.charCodeAt(charIndex++)];\r\n\t\t\t\t\tlet unison: number = clamp(0, Config.unisons.length, originalValue);\r\n\t\t\t\t\tif (originalValue == 8) {\r\n\t\t\t\t\t\t// original \"custom harmony\" now maps to \"hum\" and \"custom interval\".\r\n\t\t\t\t\t\tunison = 2;\r\n\t\t\t\t\t\tthis.channels[instrumentChannelIterator].instruments[instrumentIndexIterator].chord = 3;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tthis.channels[instrumentChannelIterator].instruments[instrumentIndexIterator].unison = unison;\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis.channels[instrumentChannelIterator].instruments[instrumentIndexIterator].unison = clamp(0, Config.unisons.length, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n\t\t\t\t}\r\n\t\t\t} break;\r\n\t\t\tcase SongTagCode.chord: {\r\n\t\t\t\tif (beforeNine) {\r\n\t\t\t\t\tconst instrument: Instrument = this.channels[instrumentChannelIterator].instruments[instrumentIndexIterator];\r\n\t\t\t\t\tinstrument.chord = clamp(0, Config.chords.length, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n\t\t\t\t\tif (instrument.chord != Config.chords.dictionary[\"simultaneous\"].index) {\r\n\t\t\t\t\t\t// Enable chord if it was used.\r\n\t\t\t\t\t\tinstrument.effects |= 1 << EffectType.chord;\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\t// Do nothing? This song tag code is deprecated for now.\r\n\t\t\t\t}\r\n\t\t\t} break;\r\n\t\t\tcase SongTagCode.effects: {\r\n\t\t\t\tconst instrument: Instrument = this.channels[instrumentChannelIterator].instruments[instrumentIndexIterator];\r\n\t\t\t\tif (beforeNine) {\r\n\t\t\t\t\tinstrument.effects = (base64CharCodeToInt[compressed.charCodeAt(charIndex++)] & ((1 << EffectType.length) - 1));\r\n\t\t\t\t\tif (legacyGlobalReverb == 0) {\r\n\t\t\t\t\t\t// Disable reverb if legacy song reverb was zero.\r\n\t\t\t\t\t\tinstrument.effects &= ~(1 << EffectType.reverb);\r\n\t\t\t\t\t} else if (effectsIncludeReverb(instrument.effects)) {\r\n\t\t\t\t\t\tinstrument.reverb = legacyGlobalReverb;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (instrument.pan != Config.panCenter) {\r\n\t\t\t\t\t\t// Enable panning if panning slider isn't centered.\r\n\t\t\t\t\t\tinstrument.effects |= 1 << EffectType.panning;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (instrument.vibrato != Config.vibratos.dictionary[\"none\"].index) {\r\n\t\t\t\t\t\t// Enable vibrato if it was used.\r\n\t\t\t\t\t\tinstrument.effects |= 1 << EffectType.panning;\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t\t// convertLegacySettings may need to force-enable note filter, call\r\n\t\t\t\t\t// it again here to make sure that this override takes precedence.\r\n\t\t\t\t\tconst legacySettings: LegacySettings = legacySettingsCache![instrumentChannelIterator][instrumentIndexIterator];\r\n\t\t\t\t\tinstrument.convertLegacySettings(legacySettings);\r\n\t\t\t\t} else {\r\n\t\t\t\t\t// BeepBox currently uses two base64 characters at 6 bits each for a bitfield representing all the enabled effects.\r\n\t\t\t\t\tif (EffectType.length > 12) throw new Error();\r\n\t\t\t\t\tinstrument.effects = (base64CharCodeToInt[compressed.charCodeAt(charIndex++)] << 6) | (base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n\t\t\t\t\t\r\n\t\t\t\t\tif (effectsIncludeNoteFilter(instrument.effects)) {\r\n\t\t\t\t\t\tconst originalControlPointCount: number = base64CharCodeToInt[compressed.charCodeAt(charIndex++)];\r\n\t\t\t\t\t\tinstrument.noteFilter.controlPointCount = clamp(0, Config.filterMaxPoints + 1, originalControlPointCount);\r\n\t\t\t\t\t\tfor (let i: number = instrument.noteFilter.controlPoints.length; i < instrument.noteFilter.controlPointCount; i++) {\r\n\t\t\t\t\t\t\tinstrument.noteFilter.controlPoints[i] = new FilterControlPoint();\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tfor (let i: number = 0; i < instrument.noteFilter.controlPointCount; i++) {\r\n\t\t\t\t\t\t\tconst point: FilterControlPoint = instrument.noteFilter.controlPoints[i];\r\n\t\t\t\t\t\t\tpoint.type = clamp(0, FilterType.length, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n\t\t\t\t\t\t\tpoint.freq = clamp(0, Config.filterFreqRange, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n\t\t\t\t\t\t\tpoint.gain = clamp(0, Config.filterGainRange, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tfor (let i: number = instrument.noteFilter.controlPointCount; i < originalControlPointCount; i++) {\r\n\t\t\t\t\t\t\tcharIndex += 3;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (effectsIncludeTransition(instrument.effects)) {\r\n\t\t\t\t\t\tinstrument.transition = clamp(0, Config.transitions.length, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (effectsIncludeChord(instrument.effects)) {\r\n\t\t\t\t\t\tinstrument.chord = clamp(0, Config.chords.length, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (effectsIncludePitchShift(instrument.effects)) {\r\n\t\t\t\t\t\tinstrument.pitchShift = clamp(0, Config.pitchShiftRange, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (effectsIncludeDetune(instrument.effects)) {\r\n\t\t\t\t\t\tinstrument.detune = clamp(0, Config.detuneMax + 1, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (effectsIncludeVibrato(instrument.effects)) {\r\n\t\t\t\t\t\tinstrument.vibrato = clamp(0, Config.vibratos.length, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (effectsIncludeDistortion(instrument.effects)) {\r\n\t\t\t\t\t\tinstrument.distortion = clamp(0, Config.distortionRange, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (effectsIncludeBitcrusher(instrument.effects)) {\r\n\t\t\t\t\t\tinstrument.bitcrusherFreq = clamp(0, Config.bitcrusherFreqRange, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n\t\t\t\t\t\tinstrument.bitcrusherQuantization = clamp(0, Config.bitcrusherQuantizationRange, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (effectsIncludePanning(instrument.effects)) {\r\n\t\t\t\t\t\tinstrument.pan = clamp(0, Config.panMax + 1, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (effectsIncludeChorus(instrument.effects)) {\r\n\t\t\t\t\t\tinstrument.chorus = clamp(0, Config.chorusRange, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (effectsIncludeEcho(instrument.effects)) {\r\n\t\t\t\t\t\tinstrument.echoSustain = clamp(0, Config.echoSustainRange, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n\t\t\t\t\t\tinstrument.echoDelay = clamp(0, Config.echoDelayRange, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (effectsIncludeReverb(instrument.effects)) {\r\n\t\t\t\t\t\tinstrument.reverb = clamp(0, Config.reverbRange, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\t// Clamp the range.\r\n\t\t\t\tinstrument.effects &= (1 << EffectType.length) - 1;\r\n\t\t\t} break;\r\n\t\t\tcase SongTagCode.volume: {\r\n\t\t\t\tif (beforeThree) {\r\n\t\t\t\t\tconst channelIndex: number = base64CharCodeToInt[compressed.charCodeAt(charIndex++)];\r\n\t\t\t\t\tconst instrument: Instrument = this.channels[channelIndex].instruments[0];\r\n\t\t\t\t\tinstrument.volume = clamp(0, Config.volumeRange, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n\t\t\t\t\t// legacy mute value:\r\n\t\t\t\t\tif (instrument.volume == 5) instrument.volume = Config.volumeRange - 1;\r\n\t\t\t\t} else if (beforeSix) {\r\n\t\t\t\t\tfor (let channelIndex: number = 0; channelIndex < this.getChannelCount(); channelIndex++) {\r\n\t\t\t\t\t\tfor (const instrument of this.channels[channelIndex].instruments) {\r\n\t\t\t\t\t\t\tinstrument.volume = clamp(0, Config.volumeRange, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n\t\t\t\t\t\t\t// legacy mute value:\r\n\t\t\t\t\t\t\tif (instrument.volume == 5) instrument.volume = Config.volumeRange - 1;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t} else if (beforeSeven) {\r\n\t\t\t\t\tconst instrument: Instrument = this.channels[instrumentChannelIterator].instruments[instrumentIndexIterator];\r\n\t\t\t\t\tinstrument.volume = clamp(0, Config.volumeRange, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n\t\t\t\t\t// legacy mute value:\r\n\t\t\t\t\tif (instrument.volume == 5) instrument.volume = Config.volumeRange - 1;\r\n\t\t\t\t} else {\r\n\t\t\t\t\tconst instrument: Instrument = this.channels[instrumentChannelIterator].instruments[instrumentIndexIterator];\r\n\t\t\t\t\tinstrument.volume = clamp(0, Config.volumeRange, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n\t\t\t\t}\r\n\t\t\t} break;\r\n\t\t\tcase SongTagCode.pan: {\r\n\t\t\t\tif (beforeNine) {\r\n\t\t\t\t\tconst instrument: Instrument = this.channels[instrumentChannelIterator].instruments[instrumentIndexIterator];\r\n\t\t\t\t\tinstrument.pan = clamp(0, Config.panMax + 1, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n\t\t\t\t} else {\r\n\t\t\t\t\t// Do nothing? This song tag code is deprecated for now.\r\n\t\t\t\t}\r\n\t\t\t} break;\r\n\t\t\tcase SongTagCode.algorithm: {\r\n\t\t\t\tconst instrument: Instrument = this.channels[instrumentChannelIterator].instruments[instrumentIndexIterator];\r\n\t\t\t\tinstrument.algorithm = clamp(0, Config.algorithms.length, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n\t\t\t\tif (beforeNine) {\r\n\t\t\t\t\t// The algorithm determines the carrier count, which affects how legacy settings are imported.\r\n\t\t\t\t\tconst legacySettings: LegacySettings = legacySettingsCache![instrumentChannelIterator][instrumentIndexIterator];\r\n\t\t\t\t\tinstrument.convertLegacySettings(legacySettings);\r\n\t\t\t\t}\r\n\t\t\t} break;\r\n\t\t\tcase SongTagCode.feedbackType: {\r\n\t\t\t\tthis.channels[instrumentChannelIterator].instruments[instrumentIndexIterator].feedbackType = clamp(0, Config.feedbacks.length, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n\t\t\t} break;\r\n\t\t\tcase SongTagCode.feedbackAmplitude: {\r\n\t\t\t\tthis.channels[instrumentChannelIterator].instruments[instrumentIndexIterator].feedbackAmplitude = clamp(0, Config.operatorAmplitudeMax + 1, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n\t\t\t} break;\r\n\t\t\tcase SongTagCode.feedbackEnvelope: {\r\n\t\t\t\tif (beforeNine) {\r\n\t\t\t\t\tconst instrument: Instrument = this.channels[instrumentChannelIterator].instruments[instrumentIndexIterator];\r\n\t\t\t\t\tconst legacySettings: LegacySettings = legacySettingsCache![instrumentChannelIterator][instrumentIndexIterator];\r\n\t\t\t\t\tlegacySettings.feedbackEnvelope = Song._envelopeFromLegacyIndex(base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n\t\t\t\t\tinstrument.convertLegacySettings(legacySettings);\r\n\t\t\t\t} else {\r\n\t\t\t\t\t// Do nothing? This song tag code is deprecated for now.\r\n\t\t\t\t}\r\n\t\t\t} break;\r\n\t\t\tcase SongTagCode.operatorFrequencies: {\r\n\t\t\t\tfor (let o: number = 0; o < Config.operatorCount; o++) {\r\n\t\t\t\t\tthis.channels[instrumentChannelIterator].instruments[instrumentIndexIterator].operators[o].frequency = clamp(0, Config.operatorFrequencies.length, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n\t\t\t\t}\r\n\t\t\t} break;\r\n\t\t\tcase SongTagCode.operatorAmplitudes: {\r\n\t\t\t\tfor (let o: number = 0; o < Config.operatorCount; o++) {\r\n\t\t\t\t\tthis.channels[instrumentChannelIterator].instruments[instrumentIndexIterator].operators[o].amplitude = clamp(0, Config.operatorAmplitudeMax + 1, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n\t\t\t\t}\r\n\t\t\t} break;\r\n\t\t\tcase SongTagCode.envelopes: {\r\n\t\t\t\tconst instrument: Instrument = this.channels[instrumentChannelIterator].instruments[instrumentIndexIterator];\r\n\t\t\t\tif (beforeNine) {\r\n\t\t\t\t\tconst legacySettings: LegacySettings = legacySettingsCache![instrumentChannelIterator][instrumentIndexIterator];\r\n\t\t\t\t\tlegacySettings.operatorEnvelopes = [];\r\n\t\t\t\t\tfor (let o: number = 0; o < Config.operatorCount; o++) {\r\n\t\t\t\t\t\tlegacySettings.operatorEnvelopes[o] = Song._envelopeFromLegacyIndex(base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tinstrument.convertLegacySettings(legacySettings);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tconst envelopeCount: number = clamp(0, Config.maxEnvelopeCount + 1, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n\t\t\t\t\tfor (let i: number = 0; i < envelopeCount; i++) {\r\n\t\t\t\t\t\tconst target: number = clamp(0, Config.instrumentAutomationTargets.length, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n\t\t\t\t\t\tlet index: number = 0;\r\n\t\t\t\t\t\tconst maxCount: number = Config.instrumentAutomationTargets[target].maxCount;\r\n\t\t\t\t\t\tif (maxCount > 1) {\r\n\t\t\t\t\t\t\tindex = clamp(0, maxCount, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tconst envelope: number = clamp(0, Config.envelopes.length, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n\t\t\t\t\t\tinstrument.addEnvelope(target, index, envelope);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t} break;\r\n\t\t\tcase SongTagCode.spectrum: {\r\n\t\t\t\tconst instrument: Instrument = this.channels[instrumentChannelIterator].instruments[instrumentIndexIterator];\r\n\t\t\t\tif (instrument.type == InstrumentType.spectrum) {\r\n\t\t\t\t\tconst byteCount: number = Math.ceil(Config.spectrumControlPoints * Config.spectrumControlPointBits / 6)\r\n\t\t\t\t\tconst bits: BitFieldReader = new BitFieldReader(compressed, charIndex, charIndex + byteCount);\r\n\t\t\t\t\tfor (let i: number = 0; i < Config.spectrumControlPoints; i++) {\r\n\t\t\t\t\t\tinstrument.spectrumWave.spectrum[i] = bits.read(Config.spectrumControlPointBits);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tinstrument.spectrumWave.markCustomWaveDirty();\r\n\t\t\t\t\tcharIndex += byteCount;\r\n\t\t\t\t} else if (instrument.type == InstrumentType.drumset) {\r\n\t\t\t\t\tconst byteCount: number = Math.ceil(Config.drumCount * Config.spectrumControlPoints * Config.spectrumControlPointBits / 6)\r\n\t\t\t\t\tconst bits: BitFieldReader = new BitFieldReader(compressed, charIndex, charIndex + byteCount);\r\n\t\t\t\t\tfor (let j: number = 0; j < Config.drumCount; j++) {\r\n\t\t\t\t\t\tfor (let i: number = 0; i < Config.spectrumControlPoints; i++) {\r\n\t\t\t\t\t\t\tinstrument.drumsetSpectrumWaves[j].spectrum[i] = bits.read(Config.spectrumControlPointBits);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tinstrument.drumsetSpectrumWaves[j].markCustomWaveDirty();\r\n\t\t\t\t\t}\r\n\t\t\t\t\tcharIndex += byteCount;\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthrow new Error(\"Unhandled instrument type for spectrum song tag code.\");\r\n\t\t\t\t}\r\n\t\t\t} break;\r\n\t\t\tcase SongTagCode.harmonics: {\r\n\t\t\t\tconst instrument: Instrument = this.channels[instrumentChannelIterator].instruments[instrumentIndexIterator];\r\n\t\t\t\tconst byteCount: number = Math.ceil(Config.harmonicsControlPoints * Config.harmonicsControlPointBits / 6)\r\n\t\t\t\tconst bits: BitFieldReader = new BitFieldReader(compressed, charIndex, charIndex + byteCount);\r\n\t\t\t\tfor (let i: number = 0; i < Config.harmonicsControlPoints; i++) {\r\n\t\t\t\t\tinstrument.harmonicsWave.harmonics[i] = bits.read(Config.harmonicsControlPointBits);\r\n\t\t\t\t}\r\n\t\t\t\tinstrument.harmonicsWave.markCustomWaveDirty();\r\n\t\t\t\tcharIndex += byteCount;\r\n\t\t\t} break;\r\n\t\t\tcase SongTagCode.bars: {\r\n\t\t\t\tlet subStringLength: number;\r\n\t\t\t\tif (beforeThree) {\r\n\t\t\t\t\tconst channelIndex: number = base64CharCodeToInt[compressed.charCodeAt(charIndex++)];\r\n\t\t\t\t\tconst barCount: number = base64CharCodeToInt[compressed.charCodeAt(charIndex++)];\r\n\t\t\t\t\tsubStringLength = Math.ceil(barCount * 0.5);\r\n\t\t\t\t\tconst bits: BitFieldReader = new BitFieldReader(compressed, charIndex, charIndex + subStringLength);\r\n\t\t\t\t\tfor (let i: number = 0; i < barCount; i++) {\r\n\t\t\t\t\t\tthis.channels[channelIndex].bars[i] = bits.read(3) + 1;\r\n\t\t\t\t\t}\r\n\t\t\t\t} else if (beforeFive) {\r\n\t\t\t\t\tlet neededBits: number = 0;\r\n\t\t\t\t\twhile ((1 << neededBits) < this.patternsPerChannel) neededBits++;\r\n\t\t\t\t\tsubStringLength = Math.ceil(this.getChannelCount() * this.barCount * neededBits / 6);\r\n\t\t\t\t\tconst bits: BitFieldReader = new BitFieldReader(compressed, charIndex, charIndex + subStringLength);\r\n\t\t\t\t\tfor (let channelIndex: number = 0; channelIndex < this.getChannelCount(); channelIndex++) {\r\n\t\t\t\t\t\tfor (let i: number = 0; i < this.barCount; i++) {\r\n\t\t\t\t\t\t\tthis.channels[channelIndex].bars[i] = bits.read(neededBits) + 1;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\tlet neededBits: number = 0;\r\n\t\t\t\t\twhile ((1 << neededBits) < this.patternsPerChannel + 1) neededBits++;\r\n\t\t\t\t\tsubStringLength = Math.ceil(this.getChannelCount() * this.barCount * neededBits / 6);\r\n\t\t\t\t\tconst bits: BitFieldReader = new BitFieldReader(compressed, charIndex, charIndex + subStringLength);\r\n\t\t\t\t\tfor (let channelIndex: number = 0; channelIndex < this.getChannelCount(); channelIndex++) {\r\n\t\t\t\t\t\tfor (let i: number = 0; i < this.barCount; i++) {\r\n\t\t\t\t\t\t\tthis.channels[channelIndex].bars[i] = bits.read(neededBits);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tcharIndex += subStringLength;\r\n\t\t\t} break;\r\n\t\t\tcase SongTagCode.patterns: {\r\n\t\t\t\tlet bitStringLength: number = 0;\r\n\t\t\t\tlet channelIndex: number;\r\n\t\t\t\tif (beforeThree) {\r\n\t\t\t\t\tchannelIndex = base64CharCodeToInt[compressed.charCodeAt(charIndex++)];\r\n\t\t\t\t\t\r\n\t\t\t\t\t// The old format used the next character to represent the number of patterns in the channel, which is usually eight, the default. \r\n\t\t\t\t\tcharIndex++; //let patternCount: number = base64CharCodeToInt[compressed.charCodeAt(charIndex++)];\r\n\t\t\t\t\t\r\n\t\t\t\t\tbitStringLength = base64CharCodeToInt[compressed.charCodeAt(charIndex++)];\r\n\t\t\t\t\tbitStringLength = bitStringLength << 6;\r\n\t\t\t\t\tbitStringLength += base64CharCodeToInt[compressed.charCodeAt(charIndex++)];\r\n\t\t\t\t} else {\r\n\t\t\t\t\tchannelIndex = 0;\r\n\t\t\t\t\tlet bitStringLengthLength: number = validateRange(1, 4, base64CharCodeToInt[compressed.charCodeAt(charIndex++)]);\r\n\t\t\t\t\twhile (bitStringLengthLength > 0) {\r\n\t\t\t\t\t\tbitStringLength = bitStringLength << 6;\r\n\t\t\t\t\t\tbitStringLength += base64CharCodeToInt[compressed.charCodeAt(charIndex++)];\r\n\t\t\t\t\t\tbitStringLengthLength--;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tconst bits: BitFieldReader = new BitFieldReader(compressed, charIndex, charIndex + bitStringLength);\r\n\t\t\t\tcharIndex += bitStringLength;\r\n\t\t\t\t\r\n\t\t\t\tconst bitsPerNoteSize: number = Song.getNeededBits(Config.noteSizeMax);\r\n\t\t\t\twhile (true) {\r\n\t\t\t\t\tconst channel: Channel = this.channels[channelIndex];\r\n\t\t\t\t\tconst isNoiseChannel: boolean = this.getChannelIsNoise(channelIndex);\r\n\t\t\t\t\tconst maxInstrumentsPerPattern: number = this.getMaxInstrumentsPerPattern(channelIndex);\r\n\t\t\t\t\tconst neededInstrumentCountBits: number = Song.getNeededBits(maxInstrumentsPerPattern - Config.instrumentCountMin);\r\n\t\t\t\t\tconst neededInstrumentIndexBits: number = Song.getNeededBits(channel.instruments.length - 1);\r\n\t\t\t\t\t\r\n\t\t\t\t\tconst octaveOffset: number = isNoiseChannel ? 0 : channel.octave * 12;\r\n\t\t\t\t\tlet lastPitch: number = (isNoiseChannel ? 4 : octaveOffset);\r\n\t\t\t\t\tconst recentPitches: number[] = isNoiseChannel ? [4,6,7,2,3,8,0,10] : [0, 7, 12, 19, 24, -5, -12];\r\n\t\t\t\t\tconst recentShapes: any[] = [];\r\n\t\t\t\t\tfor (let i: number = 0; i < recentPitches.length; i++) {\r\n\t\t\t\t\t\trecentPitches[i] += octaveOffset;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tfor (let i: number = 0; i < this.patternsPerChannel; i++) {\r\n\t\t\t\t\t\tconst newPattern: Pattern = channel.patterns[i];\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tif (beforeNine) {\r\n\t\t\t\t\t\t\tnewPattern.instruments[0] = validateRange(0, channel.instruments.length - 1, bits.read(neededInstrumentIndexBits));\r\n\t\t\t\t\t\t\tnewPattern.instruments.length = 1;\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\tif (this.patternInstruments) {\r\n\t\t\t\t\t\t\t\tconst instrumentCount: number = validateRange(Config.instrumentCountMin, maxInstrumentsPerPattern, bits.read(neededInstrumentCountBits) + Config.instrumentCountMin);\r\n\t\t\t\t\t\t\t\tfor (let j: number = 0; j < instrumentCount; j++) {\r\n\t\t\t\t\t\t\t\t\tnewPattern.instruments[j] = validateRange(0, channel.instruments.length - 1, bits.read(neededInstrumentIndexBits));\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\tnewPattern.instruments.length = instrumentCount;\r\n\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\tnewPattern.instruments[0] = 0;\r\n\t\t\t\t\t\t\t\tnewPattern.instruments.length = Config.instrumentCountMin;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tif (!beforeThree && bits.read(1) == 0) {\r\n\t\t\t\t\t\t\tnewPattern.notes.length = 0;\r\n\t\t\t\t\t\t\tcontinue;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tlet curPart: number = 0;\r\n\t\t\t\t\t\tconst newNotes: Note[] = newPattern.notes;\r\n\t\t\t\t\t\tlet noteCount: number = 0;\r\n\t\t\t\t\t\twhile (curPart < this.beatsPerBar * Config.partsPerBeat) {\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tconst useOldShape: boolean = bits.read(1) == 1;\r\n\t\t\t\t\t\t\tlet newNote: boolean = false;\r\n\t\t\t\t\t\t\tlet shapeIndex: number = 0;\r\n\t\t\t\t\t\t\tif (useOldShape) {\r\n\t\t\t\t\t\t\t\tshapeIndex = validateRange(0, recentShapes.length - 1, bits.readLongTail(0, 0));\r\n\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\tnewNote = bits.read(1) == 1;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tif (!useOldShape && !newNote) {\r\n\t\t\t\t\t\t\t\tconst restLength: number = beforeSeven\r\n\t\t\t\t\t\t\t\t\t? bits.readLegacyPartDuration() * Config.partsPerBeat / Config.rhythms[this.rhythm].stepsPerBeat\r\n\t\t\t\t\t\t\t\t\t: bits.readPartDuration();\r\n\t\t\t\t\t\t\t\tcurPart += restLength;\r\n\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\tlet shape: any;\r\n\t\t\t\t\t\t\t\tif (useOldShape) {\r\n\t\t\t\t\t\t\t\t\tshape = recentShapes[shapeIndex];\r\n\t\t\t\t\t\t\t\t\trecentShapes.splice(shapeIndex, 1);\r\n\t\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\t\tshape = {};\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tshape.pitchCount = 1;\r\n\t\t\t\t\t\t\t\t\twhile (shape.pitchCount < Config.maxChordSize && bits.read(1) == 1) shape.pitchCount++;\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tshape.pinCount = bits.readPinCount();\r\n\t\t\t\t\t\t\t\t\tshape.initialSize = bits.read(bitsPerNoteSize);\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tshape.pins = [];\r\n\t\t\t\t\t\t\t\t\tshape.length = 0;\r\n\t\t\t\t\t\t\t\t\tshape.bendCount = 0;\r\n\t\t\t\t\t\t\t\t\tfor (let j: number = 0; j < shape.pinCount; j++) {\r\n\t\t\t\t\t\t\t\t\t\tlet pinObj: any = {};\r\n\t\t\t\t\t\t\t\t\t\tpinObj.pitchBend = bits.read(1) == 1;\r\n\t\t\t\t\t\t\t\t\t\tif (pinObj.pitchBend) shape.bendCount++;\r\n\t\t\t\t\t\t\t\t\t\tshape.length += beforeSeven\r\n\t\t\t\t\t\t\t\t\t\t\t? bits.readLegacyPartDuration() * Config.partsPerBeat / Config.rhythms[this.rhythm].stepsPerBeat\r\n\t\t\t\t\t\t\t\t\t\t\t: bits.readPartDuration();\r\n\t\t\t\t\t\t\t\t\t\tpinObj.time = shape.length;\r\n\t\t\t\t\t\t\t\t\t\tpinObj.size = bits.read(bitsPerNoteSize);\r\n\t\t\t\t\t\t\t\t\t\tshape.pins.push(pinObj);\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\trecentShapes.unshift(shape);\r\n\t\t\t\t\t\t\t\tif (recentShapes.length > 10) recentShapes.pop(); // TODO: Use Deque?\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tlet note: Note;\r\n\t\t\t\t\t\t\t\tif (newNotes.length <= noteCount) {\r\n\t\t\t\t\t\t\t\t\tnote = new Note(0, curPart, curPart + shape.length, shape.initialSize);\r\n\t\t\t\t\t\t\t\t\tnewNotes[noteCount++] = note;\r\n\t\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\t\tnote = newNotes[noteCount++];\r\n\t\t\t\t\t\t\t\t\tnote.start = curPart;\r\n\t\t\t\t\t\t\t\t\tnote.end = curPart + shape.length;\r\n\t\t\t\t\t\t\t\t\tnote.pins[0].size = shape.initialSize;\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tlet pitch: number;\r\n\t\t\t\t\t\t\t\tlet pitchCount: number = 0;\r\n\t\t\t\t\t\t\t\tconst pitchBends: number[] = []; // TODO: allocate this array only once! keep separate length and iterator index. Use Deque?\r\n\t\t\t\t\t\t\t\tfor (let j: number = 0; j < shape.pitchCount + shape.bendCount; j++) {\r\n\t\t\t\t\t\t\t\t\tconst useOldPitch: boolean = bits.read(1) == 1;\r\n\t\t\t\t\t\t\t\t\tif (!useOldPitch) {\r\n\t\t\t\t\t\t\t\t\t\tconst interval: number = bits.readPitchInterval();\r\n\t\t\t\t\t\t\t\t\t\tpitch = lastPitch;\r\n\t\t\t\t\t\t\t\t\t\tlet intervalIter: number = interval;\r\n\t\t\t\t\t\t\t\t\t\twhile (intervalIter > 0) {\r\n\t\t\t\t\t\t\t\t\t\t\tpitch++;\r\n\t\t\t\t\t\t\t\t\t\t\twhile (recentPitches.indexOf(pitch) != -1) pitch++;\r\n\t\t\t\t\t\t\t\t\t\t\tintervalIter--;\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\twhile (intervalIter < 0) {\r\n\t\t\t\t\t\t\t\t\t\t\tpitch--;\r\n\t\t\t\t\t\t\t\t\t\t\twhile (recentPitches.indexOf(pitch) != -1) pitch--;\r\n\t\t\t\t\t\t\t\t\t\t\tintervalIter++;\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\t\t\tconst pitchIndex: number = validateRange(0, recentPitches.length - 1, bits.read(3));\r\n\t\t\t\t\t\t\t\t\t\tpitch = recentPitches[pitchIndex];\r\n\t\t\t\t\t\t\t\t\t\trecentPitches.splice(pitchIndex, 1);\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\trecentPitches.unshift(pitch);\r\n\t\t\t\t\t\t\t\t\tif (recentPitches.length > 8) recentPitches.pop();\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tif (j < shape.pitchCount) {\r\n\t\t\t\t\t\t\t\t\t\tnote.pitches[pitchCount++] = pitch;\r\n\t\t\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\t\t\tpitchBends.push(pitch);\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tif (j == shape.pitchCount - 1) {\r\n\t\t\t\t\t\t\t\t\t\tlastPitch = note.pitches[0];\r\n\t\t\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\t\t\tlastPitch = pitch;\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\tnote.pitches.length = pitchCount;\r\n\t\t\t\t\t\t\t\tpitchBends.unshift(note.pitches[0]); // TODO: Use Deque?\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tlet pinCount: number = 1;\r\n\t\t\t\t\t\t\t\tfor (const pinObj of shape.pins) {\r\n\t\t\t\t\t\t\t\t\tif (pinObj.pitchBend) pitchBends.shift();\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tconst interval: number = pitchBends[0] - note.pitches[0];\r\n\t\t\t\t\t\t\t\t\tif (note.pins.length <= pinCount) {\r\n\t\t\t\t\t\t\t\t\t\tnote.pins[pinCount++] = makeNotePin(interval, pinObj.time, pinObj.size);\r\n\t\t\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\t\t\tconst pin: NotePin = note.pins[pinCount++];\r\n\t\t\t\t\t\t\t\t\t\tpin.interval = interval;\r\n\t\t\t\t\t\t\t\t\t\tpin.time = pinObj.time;\r\n\t\t\t\t\t\t\t\t\t\tpin.size = pinObj.size;\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\tnote.pins.length = pinCount;\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tif (note.start == 0 && !beforeNine) {\r\n\t\t\t\t\t\t\t\t\tnote.continuesLastPattern = (bits.read(1) == 1);\r\n\t\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\t\tnote.continuesLastPattern = false;\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tcurPart = validateRange(0, this.beatsPerBar * Config.partsPerBeat, note.end);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tnewNotes.length = noteCount;\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t\tif (beforeThree) {\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tchannelIndex++;\r\n\t\t\t\t\t\tif (channelIndex >= this.getChannelCount()) break;\r\n\t\t\t\t\t}\r\n\t\t\t\t} // while (true)\r\n\t\t\t} break;\r\n\t\t\tdefault: {\r\n\t\t\t\tthrow new Error(\"Unrecognized song tag code \" + String.fromCharCode(command) + \" at index \" + (charIndex - 1));\r\n\t\t\t} break;\r\n\t\t}\r\n\t}\r\n\t\r\n\tpublic toJsonObject(enableIntro: boolean = true, loopCount: number = 1, enableOutro: boolean = true): Object {\r\n\t\tconst channelArray: Object[] = [];\r\n\t\tfor (let channelIndex: number = 0; channelIndex < this.getChannelCount(); channelIndex++) {\r\n\t\t\tconst channel: Channel = this.channels[channelIndex];\r\n\t\t\tconst instrumentArray: Object[] = [];\r\n\t\t\tconst isNoiseChannel: boolean = this.getChannelIsNoise(channelIndex);\r\n\t\t\tfor (const instrument of channel.instruments) {\r\n\t\t\t\tinstrumentArray.push(instrument.toJsonObject());\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tconst patternArray: Object[] = [];\r\n\t\t\tfor (const pattern of channel.patterns) {\r\n\t\t\t\tpatternArray.push(pattern.toJsonObject(this));\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tconst sequenceArray: number[] = [];\r\n\t\t\tif (enableIntro) for (let i: number = 0; i < this.loopStart; i++) {\r\n\t\t\t\tsequenceArray.push(channel.bars[i]);\r\n\t\t\t}\r\n\t\t\tfor (let l: number = 0; l < loopCount; l++) for (let i: number = this.loopStart; i < this.loopStart + this.loopLength; i++) {\r\n\t\t\t\tsequenceArray.push(channel.bars[i]);\r\n\t\t\t}\r\n\t\t\tif (enableOutro) for (let i: number = this.loopStart + this.loopLength; i < this.barCount; i++) {\r\n\t\t\t\tsequenceArray.push(channel.bars[i]);\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tconst channelObject: any = {\r\n\t\t\t\t\"type\": isNoiseChannel ? \"drum\" : \"pitch\",\r\n\t\t\t\t\"instruments\": instrumentArray,\r\n\t\t\t\t\"patterns\": patternArray,\r\n\t\t\t\t\"sequence\": sequenceArray,\r\n\t\t\t};\r\n\t\t\tif (!isNoiseChannel) {\r\n\t\t\t\t// For compatibility with old versions the octave is offset by one.\r\n\t\t\t\tchannelObject[\"octaveScrollBar\"] = channel.octave - 1;\r\n\t\t\t}\r\n\t\t\tchannelArray.push(channelObject);\r\n\t\t}\r\n\t\t\r\n\t\treturn {\r\n\t\t\t\"format\": Song._format,\r\n\t\t\t\"version\": Song._latestVersion,\r\n\t\t\t\"scale\": Config.scales[this.scale].name,\r\n\t\t\t\"key\": Config.keys[this.key].name,\r\n\t\t\t\"introBars\": this.loopStart,\r\n\t\t\t\"loopBars\": this.loopLength,\r\n\t\t\t\"beatsPerBar\": this.beatsPerBar,\r\n\t\t\t\"ticksPerBeat\": Config.rhythms[this.rhythm].stepsPerBeat,\r\n\t\t\t\"beatsPerMinute\": this.tempo,\r\n\t\t\t//\"patternCount\": this.patternsPerChannel, // derive this from pattern arrays.\r\n\t\t\t\"layeredInstruments\": this.layeredInstruments,\r\n\t\t\t\"patternInstruments\": this.patternInstruments,\r\n\t\t\t\"channels\": channelArray,\r\n\t\t};\r\n\t}\r\n\t\r\n\tpublic fromJsonObject(jsonObject: any): void {\r\n\t\tthis.initToDefault(true);\r\n\t\tif (!jsonObject) return;\r\n\t\t\r\n\t\t//const version: number = jsonObject[\"version\"] | 0;\r\n\t\t//if (version > Song._latestVersion) return; // Go ahead and try to parse something from the future I guess? JSON is pretty easy-going!\r\n\t\t\r\n\t\tthis.scale = 11; // default to expert.\r\n\t\tif (jsonObject[\"scale\"] != undefined) {\r\n\t\t\tconst oldScaleNames: Dictionary<string> = {\r\n\t\t\t\t\"romani :)\": \"double harmonic :)\",\r\n\t\t\t\t\"romani :(\": \"double harmonic :(\",\r\n\t\t\t\t\"dbl harmonic :)\": \"double harmonic :)\",\r\n\t\t\t\t\"dbl harmonic :(\": \"double harmonic :(\",\r\n\t\t\t\t\"enigma\": \"strange\",\r\n\t\t\t};\r\n\t\t\tconst scaleName: string = (oldScaleNames[jsonObject[\"scale\"]] != undefined) ? oldScaleNames[jsonObject[\"scale\"]] : jsonObject[\"scale\"];\r\n\t\t\tconst scale: number = Config.scales.findIndex(scale => scale.name == scaleName);\r\n\t\t\tif (scale != -1) this.scale = scale;\r\n\t\t}\r\n\t\t\r\n\t\tif (jsonObject[\"key\"] != undefined) {\r\n\t\t\tif (typeof(jsonObject[\"key\"]) == \"number\") {\r\n\t\t\t\tthis.key = ((jsonObject[\"key\"] + 1200) >>> 0) % Config.keys.length;\r\n\t\t\t} else if (typeof(jsonObject[\"key\"]) == \"string\") {\r\n\t\t\t\tconst key: string = jsonObject[\"key\"];\r\n\t\t\t\tconst letter: string = key.charAt(0).toUpperCase();\r\n\t\t\t\tconst symbol: string = key.charAt(1).toLowerCase();\r\n\t\t\t\tconst letterMap: Readonly<Dictionary<number>> = {\"C\": 0, \"D\": 2, \"E\": 4, \"F\": 5, \"G\": 7, \"A\": 9, \"B\": 11};\r\n\t\t\t\tconst accidentalMap: Readonly<Dictionary<number>> = {\"#\": 1, \"\": 1, \"b\": -1, \"\": -1};\r\n\t\t\t\tlet index: number | undefined = letterMap[letter];\r\n\t\t\t\tconst offset: number | undefined = accidentalMap[symbol];\r\n\t\t\t\tif (index != undefined) {\r\n\t\t\t\t\tif (offset != undefined) index += offset;\r\n\t\t\t\t\tif (index < 0) index += 12;\r\n\t\t\t\t\tindex = index % 12;\r\n\t\t\t\t\tthis.key = index;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tif (jsonObject[\"beatsPerMinute\"] != undefined) {\r\n\t\t\tthis.tempo = clamp(Config.tempoMin, Config.tempoMax + 1, jsonObject[\"beatsPerMinute\"] | 0);\r\n\t\t}\r\n\t\t\r\n\t\tlet legacyGlobalReverb: number = 0; // In older songs, reverb was song-global, record that here and pass it to Instrument.fromJsonObject() for context.\r\n\t\tif (jsonObject[\"reverb\"] != undefined) {\r\n\t\t\tlegacyGlobalReverb = clamp(0, 4, jsonObject[\"reverb\"] | 0);\r\n\t\t}\r\n\t\t\r\n\t\tif (jsonObject[\"beatsPerBar\"] != undefined) {\r\n\t\t\tthis.beatsPerBar = Math.max(Config.beatsPerBarMin, Math.min(Config.beatsPerBarMax, jsonObject[\"beatsPerBar\"] | 0));\r\n\t\t}\r\n\t\t\r\n\t\tlet importedPartsPerBeat: number = 4;\r\n\t\tif (jsonObject[\"ticksPerBeat\"] != undefined) {\r\n\t\t\timportedPartsPerBeat = (jsonObject[\"ticksPerBeat\"] | 0) || 4;\r\n\t\t\tthis.rhythm = Config.rhythms.findIndex(rhythm=>rhythm.stepsPerBeat==importedPartsPerBeat);\r\n\t\t\tif (this.rhythm == -1) {\r\n\t\t\t\tthis.rhythm = 1;\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tlet maxInstruments: number = 1;\r\n\t\tlet maxPatterns: number = 1;\r\n\t\tlet maxBars: number = 1;\r\n\t\tif (jsonObject[\"channels\"] != undefined) {\r\n\t\t\tfor (const channelObject of jsonObject[\"channels\"]) {\r\n\t\t\t\tif (channelObject[\"instruments\"]) maxInstruments = Math.max(maxInstruments, channelObject[\"instruments\"].length | 0);\r\n\t\t\t\tif (channelObject[\"patterns\"]) maxPatterns = Math.max(maxPatterns, channelObject[\"patterns\"].length | 0);\r\n\t\t\t\tif (channelObject[\"sequence\"]) maxBars = Math.max(maxBars, channelObject[\"sequence\"].length | 0);\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tif (jsonObject[\"layeredInstruments\"] != undefined) {\r\n\t\t\tthis.layeredInstruments = !!jsonObject[\"layeredInstruments\"];\r\n\t\t} else {\r\n\t\t\tthis.layeredInstruments = false;\r\n\t\t}\r\n\t\tif (jsonObject[\"patternInstruments\"] != undefined) {\r\n\t\t\tthis.patternInstruments = !!jsonObject[\"patternInstruments\"];\r\n\t\t} else {\r\n\t\t\tthis.patternInstruments = (maxInstruments > 1);\r\n\t\t}\r\n\t\tthis.patternsPerChannel = Math.min(maxPatterns, Config.barCountMax);\r\n\t\tthis.barCount = Math.min(maxBars, Config.barCountMax);\r\n\t\t\r\n\t\tif (jsonObject[\"introBars\"] != undefined) {\r\n\t\t\tthis.loopStart = clamp(0, this.barCount, jsonObject[\"introBars\"] | 0);\r\n\t\t}\r\n\t\tif (jsonObject[\"loopBars\"] != undefined) {\r\n\t\t\tthis.loopLength = clamp(1, this.barCount - this.loopStart + 1, jsonObject[\"loopBars\"] | 0);\r\n\t\t}\r\n\t\t\r\n\t\tconst newPitchChannels: Channel[] = [];\r\n\t\tconst newNoiseChannels: Channel[] = [];\r\n\t\tif (jsonObject[\"channels\"] != undefined) {\r\n\t\t\tfor (let channelIndex: number = 0; channelIndex < jsonObject[\"channels\"].length; channelIndex++) {\r\n\t\t\t\tlet channelObject: any = jsonObject[\"channels\"][channelIndex];\r\n\t\t\t\t\r\n\t\t\t\tconst channel: Channel = new Channel();\r\n\t\t\t\t\r\n\t\t\t\tlet isNoiseChannel: boolean = false;\r\n\t\t\t\tif (channelObject[\"type\"] != undefined) {\r\n\t\t\t\t\tisNoiseChannel = (channelObject[\"type\"] == \"drum\");\r\n\t\t\t\t} else {\r\n\t\t\t\t\t// for older files, assume drums are channel 3.\r\n\t\t\t\t\tisNoiseChannel = (channelIndex >= 3);\r\n\t\t\t\t}\r\n\t\t\t\tif (isNoiseChannel) {\r\n\t\t\t\t\tnewNoiseChannels.push(channel);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tnewPitchChannels.push(channel);\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tif (channelObject[\"octaveScrollBar\"] != undefined) {\r\n\t\t\t\t\tchannel.octave = clamp(0, Config.pitchOctaves, (channelObject[\"octaveScrollBar\"] | 0) + 1);\r\n\t\t\t\t\tif (isNoiseChannel) channel.octave = 0;\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tif (Array.isArray(channelObject[\"instruments\"])) {\r\n\t\t\t\t\tconst instrumentObjects: any[] = channelObject[\"instruments\"];\r\n\t\t\t\t\tfor (let i: number = 0; i < instrumentObjects.length; i++) {\r\n\t\t\t\t\t\tif (i >= this.getMaxInstrumentsPerChannel()) break;\r\n\t\t\t\t\t\tconst instrument: Instrument = new Instrument(isNoiseChannel);\r\n\t\t\t\t\t\tchannel.instruments[i] = instrument;\r\n\t\t\t\t\t\tinstrument.fromJsonObject(instrumentObjects[i], isNoiseChannel, legacyGlobalReverb);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tfor (let i: number = 0; i < this.patternsPerChannel; i++) {\r\n\t\t\t\t\tconst pattern: Pattern = new Pattern();\r\n\t\t\t\t\tchannel.patterns[i] = pattern;\r\n\t\t\t\t\t\r\n\t\t\t\t\tlet patternObject: any = undefined;\r\n\t\t\t\t\tif (channelObject[\"patterns\"]) patternObject = channelObject[\"patterns\"][i];\r\n\t\t\t\t\tif (patternObject == undefined) continue;\r\n\t\t\t\t\t\r\n\t\t\t\t\tpattern.fromJsonObject(patternObject, this, channel, importedPartsPerBeat, isNoiseChannel);\r\n\t\t\t\t}\r\n\t\t\t\tchannel.patterns.length = this.patternsPerChannel;\r\n\t\t\t\t\r\n\t\t\t\tfor (let i: number = 0; i < this.barCount; i++) {\r\n\t\t\t\t\tchannel.bars[i] = (channelObject[\"sequence\"] != undefined) ? Math.min(this.patternsPerChannel, channelObject[\"sequence\"][i] >>> 0) : 0;\r\n\t\t\t\t}\r\n\t\t\t\tchannel.bars.length = this.barCount;\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tif (newPitchChannels.length > Config.pitchChannelCountMax) newPitchChannels.length = Config.pitchChannelCountMax;\r\n\t\tif (newNoiseChannels.length > Config.noiseChannelCountMax) newNoiseChannels.length = Config.noiseChannelCountMax;\r\n\t\tthis.pitchChannelCount = newPitchChannels.length;\r\n\t\tthis.noiseChannelCount = newNoiseChannels.length;\r\n\t\tthis.channels.length = 0;\r\n\t\tArray.prototype.push.apply(this.channels, newPitchChannels);\r\n\t\tArray.prototype.push.apply(this.channels, newNoiseChannels);\r\n\t}\r\n\t\r\n\tpublic getPattern(channelIndex: number, bar: number): Pattern | null {\r\n\t\tif (bar < 0 || bar >= this.barCount) return null;\r\n\t\tconst patternIndex: number = this.channels[channelIndex].bars[bar];\r\n\t\tif (patternIndex == 0) return null;\r\n\t\treturn this.channels[channelIndex].patterns[patternIndex - 1];\r\n\t}\r\n\t\r\n\tpublic getBeatsPerMinute(): number {\r\n\t\treturn this.tempo;\r\n\t}\r\n\t\r\n\tpublic static getNeededBits(maxValue: number): number {\r\n\t\treturn 32 - Math.clz32(Math.ceil(maxValue + 1) - 1);\r\n\t}\r\n}\r\n\r\nclass PickedString {\r\n\tpublic delayLine: Float32Array | null = null;\r\n\tpublic delayIndex: number;\r\n\tpublic allPassSample: number;\r\n\tpublic allPassPrevInput: number;\r\n\tpublic sustainFilterSample: number;\r\n\tpublic sustainFilterPrevOutput2: number;\r\n\tpublic sustainFilterPrevInput1: number;\r\n\tpublic sustainFilterPrevInput2: number;\r\n\tpublic fractionalDelaySample: number;\r\n\tpublic prevDelayLength: number;\r\n\tpublic delayLengthDelta: number;\r\n\tpublic delayResetOffset: number;\r\n\t\r\n\tpublic allPassG: number = 0.0;\r\n\tpublic allPassGDelta: number = 0.0;\r\n\tpublic sustainFilterA1: number = 0.0;\r\n\tpublic sustainFilterA1Delta: number = 0.0;\r\n\tpublic sustainFilterA2: number = 0.0;\r\n\tpublic sustainFilterA2Delta: number = 0.0;\r\n\tpublic sustainFilterB0: number = 0.0;\r\n\tpublic sustainFilterB0Delta: number = 0.0;\r\n\tpublic sustainFilterB1: number = 0.0;\r\n\tpublic sustainFilterB1Delta: number = 0.0;\r\n\tpublic sustainFilterB2: number = 0.0;\r\n\tpublic sustainFilterB2Delta: number = 0.0;\r\n\t\r\n\tconstructor() {\r\n\t\tthis.reset();\r\n\t}\r\n\t\r\n\tpublic reset(): void {\r\n\t\tthis.delayIndex = -1;\r\n\t\tthis.allPassSample = 0.0;\r\n\t\tthis.allPassPrevInput = 0.0;\r\n\t\tthis.sustainFilterSample = 0.0;\r\n\t\tthis.sustainFilterPrevOutput2 = 0.0;\r\n\t\tthis.sustainFilterPrevInput1 = 0.0;\r\n\t\tthis.sustainFilterPrevInput2 = 0.0;\r\n\t\tthis.fractionalDelaySample = 0.0;\r\n\t\tthis.prevDelayLength = -1.0;\r\n\t\tthis.delayResetOffset = 0;\r\n\t}\r\n\t\r\n\tpublic update(synth: Synth, instrumentState: InstrumentState, tone: Tone, stringIndex: number, roundedSamplesPerTick: number, stringDecayStart: number, stringDecayEnd: number, sustainType: SustainType): void {\r\n\t\tconst allPassCenter: number = 2.0 * Math.PI * Config.pickedStringDispersionCenterFreq / synth.samplesPerSecond;\r\n\t\t\r\n\t\tconst prevDelayLength: number = this.prevDelayLength;\r\n\t\t\r\n\t\tconst phaseDeltaStart: number = tone.phaseDeltas[stringIndex];\r\n\t\tconst phaseDeltaScale: number = tone.phaseDeltaScales[stringIndex];\r\n\t\tconst phaseDeltaEnd: number = phaseDeltaStart * Math.pow(phaseDeltaScale, roundedSamplesPerTick);\r\n\t\t\r\n\t\tconst radiansPerSampleStart: number = Math.PI * 2.0 * phaseDeltaStart;\r\n\t\tconst radiansPerSampleEnd: number   = Math.PI * 2.0 * phaseDeltaEnd;\r\n\t\t\r\n\t\tconst centerHarmonicStart: number = radiansPerSampleStart * 2.0;\r\n\t\tconst centerHarmonicEnd: number   = radiansPerSampleEnd * 2.0;\r\n\t\t\r\n\t\tconst allPassRadiansStart: number = Math.min(Math.PI, radiansPerSampleStart * Config.pickedStringDispersionFreqMult * Math.pow(allPassCenter / radiansPerSampleStart, Config.pickedStringDispersionFreqScale));\r\n\t\tconst allPassRadiansEnd: number = Math.min(Math.PI, radiansPerSampleEnd * Config.pickedStringDispersionFreqMult * Math.pow(allPassCenter / radiansPerSampleEnd, Config.pickedStringDispersionFreqScale));\r\n\t\t\r\n\t\tconst shelfRadians: number = 2.0 * Math.PI * Config.pickedStringShelfHz / synth.samplesPerSecond;\r\n\t\tconst decayCurveStart: number = (Math.pow(100.0, stringDecayStart) - 1.0) / 99.0;\r\n\t\tconst decayCurveEnd: number   = (Math.pow(100.0, stringDecayEnd  ) - 1.0) / 99.0;\r\n\t\tconst register: number = sustainType == SustainType.acoustic ? 0.25 : 0.0;\r\n\t\tconst registerShelfCenter: number = 15.6;\r\n\t\tconst registerLowpassCenter: number = 3.0 * synth.samplesPerSecond / 48000;\r\n\t\t//const decayRateStart: number = Math.pow(0.5, decayCurveStart * shelfRadians / radiansPerSampleStart);\r\n\t\t//const decayRateEnd: number   = Math.pow(0.5, decayCurveEnd   * shelfRadians / radiansPerSampleEnd);\r\n\t\tconst decayRateStart: number = Math.pow(0.5, decayCurveStart * Math.pow(shelfRadians / (radiansPerSampleStart * registerShelfCenter), (1.0 + 2.0 * register)) * registerShelfCenter);\r\n\t\tconst decayRateEnd:   number = Math.pow(0.5, decayCurveEnd   * Math.pow(shelfRadians / (radiansPerSampleEnd   * registerShelfCenter), (1.0 + 2.0 * register)) * registerShelfCenter);\r\n\t\t\r\n\t\tconst expressionDecayStart: number = Math.pow(decayRateStart, 0.002);\r\n\t\tconst expressionDecayEnd: number   = Math.pow(decayRateEnd,   0.002);\r\n\t\t\r\n\t\tSynth.tempFilterStartCoefficients.allPass1stOrderInvertPhaseAbove(allPassRadiansStart);\r\n\t\tsynth.tempFrequencyResponse.analyze(Synth.tempFilterStartCoefficients, centerHarmonicStart);\r\n\t\tconst allPassGStart: number = Synth.tempFilterStartCoefficients.b[0]; /* same as a[1] */\r\n\t\tconst allPassPhaseDelayStart: number = -synth.tempFrequencyResponse.angle() / centerHarmonicStart;\r\n\t\t\r\n\t\tSynth.tempFilterEndCoefficients.allPass1stOrderInvertPhaseAbove(allPassRadiansEnd);\r\n\t\tsynth.tempFrequencyResponse.analyze(Synth.tempFilterEndCoefficients, centerHarmonicEnd);\r\n\t\tconst allPassGEnd: number = Synth.tempFilterEndCoefficients.b[0]; /* same as a[1] */\r\n\t\tconst allPassPhaseDelayEnd: number = -synth.tempFrequencyResponse.angle() / centerHarmonicEnd;\r\n\t\t\r\n\t\t// 1st order shelf filters and 2nd order lowpass filters have differently shaped frequency\r\n\t\t// responses, as well as adjustable shapes. I originally picked a 1st order shelf filter,\r\n\t\t// but I kinda prefer 2nd order lowpass filters now and I designed a couple settings:\r\n\t\tconst enum PickedStringBrightnessType {\r\n\t\t\tbright, // 1st order shelf\r\n\t\t\tnormal, // 2nd order lowpass, rounded corner\r\n\t\t\tresonant, // 3rd order lowpass, harder corner\r\n\t\t}\r\n\t\tconst brightnessType: PickedStringBrightnessType = <any> sustainType == SustainType.bright ? PickedStringBrightnessType.bright : PickedStringBrightnessType.normal;\r\n\t\tif (brightnessType == PickedStringBrightnessType.bright) {\r\n\t\t\tconst shelfGainStart: number = Math.pow(decayRateStart, Config.stringDecayRate);\r\n\t\t\tconst shelfGainEnd: number   = Math.pow(decayRateEnd,   Config.stringDecayRate);\r\n\t\t\tSynth.tempFilterStartCoefficients.highShelf2ndOrder(shelfRadians, shelfGainStart, 0.5);\r\n\t\t\tSynth.tempFilterEndCoefficients.highShelf2ndOrder(shelfRadians, shelfGainEnd, 0.5);\r\n\t\t} else {\r\n\t\t\tconst cornerHardness: number = Math.pow(brightnessType == PickedStringBrightnessType.normal ? 0.0 : 1.0, 0.25);\r\n\t\t\tconst lowpass1stOrderCutoffRadiansStart: number = Math.pow(registerLowpassCenter * registerLowpassCenter * radiansPerSampleStart * 3.3 * 48000 / synth.samplesPerSecond, 0.5 + register) / registerLowpassCenter / Math.pow(decayCurveStart, .5);\r\n\t\t\tconst lowpass1stOrderCutoffRadiansEnd:   number = Math.pow(registerLowpassCenter * registerLowpassCenter * radiansPerSampleEnd   * 3.3 * 48000 / synth.samplesPerSecond, 0.5 + register) / registerLowpassCenter / Math.pow(decayCurveEnd,   .5);\r\n\t\t\tconst lowpass2ndOrderCutoffRadiansStart: number = lowpass1stOrderCutoffRadiansStart * Math.pow(2.0, 0.5 - 1.75 * (1.0 - Math.pow(1.0 - cornerHardness, 0.85)));\r\n\t\t\tconst lowpass2ndOrderCutoffRadiansEnd:   number = lowpass1stOrderCutoffRadiansEnd   * Math.pow(2.0, 0.5 - 1.75 * (1.0 - Math.pow(1.0 - cornerHardness, 0.85)));\r\n\t\t\tconst lowpass2ndOrderGainStart: number = Math.pow(2.0, -Math.pow(2.0, -Math.pow(cornerHardness, 0.9)));\r\n\t\t\tconst lowpass2ndOrderGainEnd:   number = Math.pow(2.0, -Math.pow(2.0, -Math.pow(cornerHardness, 0.9)));\r\n\t\t\tSynth.tempFilterStartCoefficients.lowPass2ndOrderButterworth(warpInfinityToNyquist(lowpass2ndOrderCutoffRadiansStart), lowpass2ndOrderGainStart);\r\n\t\t\tSynth.tempFilterEndCoefficients  .lowPass2ndOrderButterworth(warpInfinityToNyquist(lowpass2ndOrderCutoffRadiansEnd),   lowpass2ndOrderGainEnd);\r\n\t\t}\r\n\t\t\r\n\t\tsynth.tempFrequencyResponse.analyze(Synth.tempFilterStartCoefficients, centerHarmonicStart);\r\n\t\tconst sustainFilterA1Start: number = Synth.tempFilterStartCoefficients.a[1];\r\n\t\tconst sustainFilterA2Start: number = Synth.tempFilterStartCoefficients.a[2];\r\n\t\tconst sustainFilterB0Start: number = Synth.tempFilterStartCoefficients.b[0] * expressionDecayStart;\r\n\t\tconst sustainFilterB1Start: number = Synth.tempFilterStartCoefficients.b[1] * expressionDecayStart;\r\n\t\tconst sustainFilterB2Start: number = Synth.tempFilterStartCoefficients.b[2] * expressionDecayStart;\r\n\t\tconst sustainFilterPhaseDelayStart: number = -synth.tempFrequencyResponse.angle() / centerHarmonicStart;\r\n\t\t\r\n\t\tsynth.tempFrequencyResponse.analyze(Synth.tempFilterEndCoefficients, centerHarmonicEnd);\r\n\t\tconst sustainFilterA1End: number = Synth.tempFilterEndCoefficients.a[1];\r\n\t\tconst sustainFilterA2End: number = Synth.tempFilterEndCoefficients.a[2];\r\n\t\tconst sustainFilterB0End: number = Synth.tempFilterEndCoefficients.b[0] * expressionDecayEnd;\r\n\t\tconst sustainFilterB1End: number = Synth.tempFilterEndCoefficients.b[1] * expressionDecayEnd;\r\n\t\tconst sustainFilterB2End: number = Synth.tempFilterEndCoefficients.b[2] * expressionDecayEnd;\r\n\t\tconst sustainFilterPhaseDelayEnd: number = -synth.tempFrequencyResponse.angle() / centerHarmonicEnd;\r\n\t\t\r\n\t\tconst periodLengthStart: number = 1.0 / phaseDeltaStart;\r\n\t\tconst periodLengthEnd: number = 1.0 / phaseDeltaEnd;\r\n\t\tconst minBufferLength: number = Math.ceil(Math.max(periodLengthStart, periodLengthEnd) * 2);\r\n\t\tconst delayLength: number = periodLengthStart - allPassPhaseDelayStart - sustainFilterPhaseDelayStart;\r\n\t\tconst delayLengthEnd: number = periodLengthEnd - allPassPhaseDelayEnd - sustainFilterPhaseDelayEnd;\r\n\t\t\r\n\t\tthis.prevDelayLength = delayLength;\r\n\t\tthis.delayLengthDelta = (delayLengthEnd - delayLength) / roundedSamplesPerTick;\r\n\t\tthis.allPassG = allPassGStart;\r\n\t\tthis.sustainFilterA1 = sustainFilterA1Start;\r\n\t\tthis.sustainFilterA2 = sustainFilterA2Start;\r\n\t\tthis.sustainFilterB0 = sustainFilterB0Start;\r\n\t\tthis.sustainFilterB1 = sustainFilterB1Start;\r\n\t\tthis.sustainFilterB2 = sustainFilterB2Start;\r\n\t\tthis.allPassGDelta = (allPassGEnd - allPassGStart) / roundedSamplesPerTick;\r\n\t\tthis.sustainFilterA1Delta = (sustainFilterA1End - sustainFilterA1Start) / roundedSamplesPerTick;\r\n\t\tthis.sustainFilterA2Delta = (sustainFilterA2End - sustainFilterA2Start) / roundedSamplesPerTick;\r\n\t\tthis.sustainFilterB0Delta = (sustainFilterB0End - sustainFilterB0Start) / roundedSamplesPerTick;\r\n\t\tthis.sustainFilterB1Delta = (sustainFilterB1End - sustainFilterB1Start) / roundedSamplesPerTick;\r\n\t\tthis.sustainFilterB2Delta = (sustainFilterB2End - sustainFilterB2Start) / roundedSamplesPerTick;\r\n\t\t\r\n\t\tconst pitchChanged: boolean = Math.abs(Math.log2(delayLength / prevDelayLength)) > 0.01;\r\n\t\t\r\n\t\tconst reinitializeImpulse: boolean = (this.delayIndex == -1 || pitchChanged);\r\n\t\tif (this.delayLine == null || this.delayLine.length <= minBufferLength) {\r\n\t\t\t// The delay line buffer will get reused for other tones so might as well\r\n\t\t\t// start off with a buffer size that is big enough for most notes.\r\n\t\t\tconst likelyMaximumLength: number = Math.ceil(2 * synth.samplesPerSecond / Instrument.frequencyFromPitch(12));\r\n\t\t\tconst newDelayLine: Float32Array = new Float32Array(Synth.fittingPowerOfTwo(Math.max(likelyMaximumLength, minBufferLength)));\r\n\t\t\tif (!reinitializeImpulse && this.delayLine != null) {\r\n\t\t\t\t// If the tone has already started but the buffer needs to be reallocated,\r\n\t\t\t\t// transfer the old data to the new buffer.\r\n\t\t\t\tconst oldDelayBufferMask: number = (this.delayLine.length - 1) >> 0;\r\n\t\t\t\tconst startCopyingFromIndex: number = this.delayIndex + this.delayResetOffset;\r\n\t\t\t\tthis.delayIndex = this.delayLine.length - this.delayResetOffset;\r\n\t\t\t\tfor (let i: number = 0; i < this.delayLine.length; i++) {\r\n\t\t\t\t\tnewDelayLine[i] = this.delayLine[(startCopyingFromIndex + i) & oldDelayBufferMask];\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tthis.delayLine = newDelayLine;\r\n\t\t}\r\n\t\tconst delayLine: Float32Array = this.delayLine;\r\n\t\tconst delayBufferMask: number = (delayLine.length - 1) >> 0;\r\n\t\t\r\n\t\tif (reinitializeImpulse) {\r\n\t\t\t// -1 delay index means the tone was reset.\r\n\t\t\t// Also, if the pitch changed suddenly (e.g. from seamless or arpeggio) then reset the wave.\r\n\t\t\t\r\n\t\t\tthis.delayIndex = 0;\r\n\t\t\tthis.allPassSample = 0.0;\r\n\t\t\tthis.allPassPrevInput = 0.0;\r\n\t\t\tthis.sustainFilterSample = 0.0;\r\n\t\t\tthis.sustainFilterPrevOutput2 = 0.0;\r\n\t\t\tthis.sustainFilterPrevInput1 = 0.0;\r\n\t\t\tthis.sustainFilterPrevInput2 = 0.0;\r\n\t\t\tthis.fractionalDelaySample = 0.0;\r\n\t\t\t\r\n\t\t\t// Clear away a region of the delay buffer for the new impulse.\r\n\t\t\tconst startImpulseFrom: number = -delayLength;\r\n\t\t\tconst startZerosFrom: number = Math.floor(startImpulseFrom - periodLengthStart / 2);\r\n\t\t\tconst stopZerosAt: number = Math.ceil(startZerosFrom + periodLengthStart * 2);\r\n\t\t\tthis.delayResetOffset = stopZerosAt; // And continue clearing the area in front of the delay line.\r\n\t\t\tfor (let i: number = startZerosFrom; i <= stopZerosAt; i++) {\r\n\t\t\t\tdelayLine[i & delayBufferMask] = 0.0;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tconst impulseWave: Float32Array = instrumentState.wave!;\r\n\t\t\tconst impulseWaveLength: number = impulseWave.length - 1; // The first sample is duplicated at the end, don't double-count it.\r\n\t\t\tconst impulsePhaseDelta: number = impulseWaveLength / periodLengthStart;\r\n\t\t\t\r\n\t\t\tconst fadeDuration: number = Math.min(periodLengthStart * 0.2, synth.samplesPerSecond * 0.003);\r\n\t\t\tconst startImpulseFromSample: number = Math.ceil(startImpulseFrom);\r\n\t\t\tconst stopImpulseAt: number = startImpulseFrom + periodLengthStart + fadeDuration;\r\n\t\t\tconst stopImpulseAtSample: number = stopImpulseAt;\r\n\t\t\tlet impulsePhase: number = (startImpulseFromSample - startImpulseFrom) * impulsePhaseDelta;\r\n\t\t\tlet prevWaveIntegral: number = 0.0;\r\n\t\t\tfor (let i: number = startImpulseFromSample; i <= stopImpulseAtSample; i++) {\r\n\t\t\t\tconst impulsePhaseInt: number = impulsePhase|0;\r\n\t\t\t\tconst index: number = impulsePhaseInt % impulseWaveLength;\r\n\t\t\t\tlet nextWaveIntegral: number = impulseWave[index];\r\n\t\t\t\tconst phaseRatio: number = impulsePhase - impulsePhaseInt;\r\n\t\t\t\tnextWaveIntegral += (impulseWave[index+1] - nextWaveIntegral) * phaseRatio;\r\n\t\t\t\tconst sample: number = (nextWaveIntegral - prevWaveIntegral) / impulsePhaseDelta;\r\n\t\t\t\tconst fadeIn: number = Math.min(1.0, (i - startImpulseFrom) / fadeDuration);\r\n\t\t\t\tconst fadeOut: number = Math.min(1.0, (stopImpulseAt - i) / fadeDuration);\r\n\t\t\t\tconst combinedFade: number = fadeIn * fadeOut;\r\n\t\t\t\tconst curvedFade: number = combinedFade * combinedFade * (3.0 - 2.0 * combinedFade); // A cubic sigmoid from 0 to 1.\r\n\t\t\t\tdelayLine[i & delayBufferMask] += sample * curvedFade;\r\n\t\t\t\tprevWaveIntegral = nextWaveIntegral;\r\n\t\t\t\timpulsePhase += impulsePhaseDelta;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n\r\nclass EnvelopeComputer {\r\n\tpublic noteSecondsStart: number = 0.0;\r\n\tpublic noteSecondsEnd: number = 0.0;\r\n\tpublic noteTicksStart: number = 0.0;\r\n\tpublic noteTicksEnd: number = 0.0;\r\n\tpublic noteSizeStart: number = Config.noteSizeMax;\r\n\tpublic noteSizeEnd: number = Config.noteSizeMax;\r\n\tpublic prevNoteSize: number = Config.noteSizeMax;\r\n\tpublic nextNoteSize: number = Config.noteSizeMax;\r\n\tprivate _noteSizeFinal: number = Config.noteSizeMax;\r\n\tpublic prevNoteSecondsStart: number = 0.0;\r\n\tpublic prevNoteSecondsEnd: number = 0.0;\r\n\tpublic prevNoteTicksStart: number = 0.0;\r\n\tpublic prevNoteTicksEnd: number = 0.0;\r\n\tprivate _prevNoteSizeFinal: number = Config.noteSizeMax;\r\n\t\r\n\tpublic prevSlideStart: boolean = false;\r\n\tpublic prevSlideEnd: boolean = false;\r\n\tpublic nextSlideStart: boolean = false;\r\n\tpublic nextSlideEnd: boolean = false;\r\n\tpublic prevSlideRatioStart: number = 0.0;\r\n\tpublic prevSlideRatioEnd: number = 0.0;\r\n\tpublic nextSlideRatioStart: number = 0.0;\r\n\tpublic nextSlideRatioEnd: number = 0.0;\r\n\t\r\n\tpublic readonly envelopeStarts: number[] = [];\r\n\tpublic readonly envelopeEnds: number[] = [];\r\n\tprivate readonly _modifiedEnvelopeIndices: number[] = [];\r\n\tprivate _modifiedEnvelopeCount: number = 0;\r\n\tpublic lowpassCutoffDecayVolumeCompensation: number = 1.0;\r\n\t\r\n\tconstructor(/*private _perNote: boolean*/) {\r\n\t\t//const length: number = this._perNote ? EnvelopeComputeIndex.length : InstrumentAutomationIndex.length;\r\n\t\tconst length: number = EnvelopeComputeIndex.length;\r\n\t\tfor (let i: number = 0; i < length; i++) {\r\n\t\t\tthis.envelopeStarts[i] = 1.0;\r\n\t\t\tthis.envelopeEnds[i] = 1.0;\r\n\t\t}\r\n\t\t\r\n\t\tthis.reset();\r\n\t}\r\n\t\r\n\tpublic reset(): void {\r\n\t\tthis.noteSecondsEnd = 0.0;\r\n\t\tthis.noteTicksEnd = 0.0;\r\n\t\tthis._noteSizeFinal = Config.noteSizeMax;\r\n\t\tthis.prevNoteSecondsEnd = 0.0;\r\n\t\tthis.prevNoteTicksEnd = 0.0;\r\n\t\tthis._prevNoteSizeFinal = Config.noteSizeMax;\r\n\t\tthis._modifiedEnvelopeCount = 0;\r\n\t}\r\n\t\r\n\tpublic computeEnvelopes(instrument: Instrument, currentPart: number, tickTimeStart: number, secondsPerTick: number, tone: Tone | null): void {\r\n\t\tconst transition: Transition = instrument.getTransition();\r\n\t\tif (tone != null && tone.atNoteStart && !transition.continues && !tone.forceContinueAtStart) {\r\n\t\t\tthis.prevNoteSecondsEnd = this.noteSecondsEnd;\r\n\t\t\tthis.prevNoteTicksEnd = this.noteTicksEnd;\r\n\t\t\tthis._prevNoteSizeFinal = this._noteSizeFinal;\r\n\t\t\tthis.noteSecondsEnd = 0.0;\r\n\t\t\tthis.noteTicksEnd = 0.0;\r\n\t\t}\r\n\t\tif (tone != null) {\r\n\t\t\tif (tone.note != null) {\r\n\t\t\t\tthis._noteSizeFinal = tone.note.pins[tone.note.pins.length - 1].size;\r\n\t\t\t} else {\r\n\t\t\t\tthis._noteSizeFinal = Config.noteSizeMax;\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tconst tickTimeEnd: number = tickTimeStart + 1.0;\r\n\t\tconst noteSecondsStart: number = this.noteSecondsEnd;\r\n\t\tconst noteSecondsEnd: number = noteSecondsStart + secondsPerTick;\r\n\t\tconst noteTicksStart: number = this.noteTicksEnd;\r\n\t\tconst noteTicksEnd: number = noteTicksStart + 1.0;\r\n\t\tconst prevNoteSecondsStart: number = this.prevNoteSecondsEnd;\r\n\t\tconst prevNoteSecondsEnd: number = prevNoteSecondsStart + secondsPerTick;\r\n\t\tconst prevNoteTicksStart: number = this.prevNoteTicksEnd;\r\n\t\tconst prevNoteTicksEnd: number = prevNoteTicksStart + 1.0;\r\n\t\t\r\n\t\tconst beatsPerTick: number = 1.0 / (Config.ticksPerPart * Config.partsPerBeat);\r\n\t\tconst beatTimeStart: number = beatsPerTick * tickTimeStart;\r\n\t\tconst beatTimeEnd:   number = beatsPerTick * tickTimeEnd;\r\n\t\t\r\n\t\tlet noteSizeStart: number = this._noteSizeFinal;\r\n\t\tlet noteSizeEnd: number = this._noteSizeFinal;\r\n\t\tlet prevNoteSize: number = this._prevNoteSizeFinal;\r\n\t\tlet nextNoteSize: number = 0;\r\n\t\tlet prevSlideStart: boolean = false;\r\n\t\tlet prevSlideEnd: boolean = false;\r\n\t\tlet nextSlideStart: boolean = false;\r\n\t\tlet nextSlideEnd: boolean = false;\r\n\t\tlet prevSlideRatioStart: number = 0.0;\r\n\t\tlet prevSlideRatioEnd: number = 0.0;\r\n\t\tlet nextSlideRatioStart: number = 0.0;\r\n\t\tlet nextSlideRatioEnd: number = 0.0;\r\n\t\tif (tone != null && tone.note != null && !tone.passedEndOfNote) {\r\n\t\t\tconst endPinIndex: number = tone.note.getEndPinIndex(currentPart);\r\n\t\t\tconst startPin: NotePin = tone.note.pins[endPinIndex-1];\r\n\t\t\tconst endPin:   NotePin = tone.note.pins[endPinIndex];\r\n\t\t\tconst startPinTick: number = (tone.note.start + startPin.time) * Config.ticksPerPart;\r\n\t\t\tconst endPinTick:   number = (tone.note.start + endPin.time)   * Config.ticksPerPart;\r\n\t\t\tconst ratioStart: number = (tickTimeStart - startPinTick) / (endPinTick - startPinTick);\r\n\t\t\tconst ratioEnd:   number = (tickTimeEnd   - startPinTick) / (endPinTick - startPinTick);\r\n\t\t\tnoteSizeStart = startPin.size + (endPin.size - startPin.size) * ratioStart;\r\n\t\t\tnoteSizeEnd   = startPin.size + (endPin.size - startPin.size) * ratioEnd;\r\n\t\t\t\r\n\t\t\tif (transition.slides) {\r\n\t\t\t\tconst noteStartTick: number = tone.noteStartPart * Config.ticksPerPart;\r\n\t\t\t\tconst noteEndTick:   number = tone.noteEndPart   * Config.ticksPerPart;\r\n\t\t\t\tconst noteLengthTicks: number = noteEndTick - noteStartTick;\r\n\t\t\t\tconst maximumSlideTicks: number = noteLengthTicks * 0.5;\r\n\t\t\t\tconst slideTicks: number = Math.min(maximumSlideTicks, transition.slideTicks);\r\n\t\t\t\tif (tone.prevNote != null && !tone.forceContinueAtStart) {\r\n\t\t\t\t\tif (tickTimeStart - noteStartTick < slideTicks) {\r\n\t\t\t\t\t\tprevSlideStart = true;\r\n\t\t\t\t\t\tprevSlideRatioStart = 0.5 * (1.0 - (tickTimeStart - noteStartTick) / slideTicks);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (tickTimeEnd - noteStartTick < slideTicks) {\r\n\t\t\t\t\t\tprevSlideEnd = true;\r\n\t\t\t\t\t\tprevSlideRatioEnd = 0.5 * (1.0 - (tickTimeEnd - noteStartTick) / slideTicks);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tif (tone.nextNote != null && !tone.forceContinueAtEnd) {\r\n\t\t\t\t\tnextNoteSize = tone.nextNote.pins[0].size\r\n\t\t\t\t\tif (noteEndTick - tickTimeStart < slideTicks) {\r\n\t\t\t\t\t\tnextSlideStart = true;\r\n\t\t\t\t\t\tnextSlideRatioStart = 0.5 * (1.0 - (noteEndTick - tickTimeStart) / slideTicks);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (noteEndTick - tickTimeEnd < slideTicks) {\r\n\t\t\t\t\t\tnextSlideEnd = true;\r\n\t\t\t\t\t\tnextSlideRatioEnd = 0.5 * (1.0 - (noteEndTick - tickTimeEnd) / slideTicks);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tlet lowpassCutoffDecayVolumeCompensation: number = 1.0;\r\n\t\tlet usedNoteSize: boolean = false;\r\n\t\tfor (let envelopeIndex: number = 0; envelopeIndex <= instrument.envelopeCount; envelopeIndex++) {\r\n\t\t\tlet automationTarget: AutomationTarget;\r\n\t\t\tlet targetIndex: number;\r\n\t\t\tlet envelope: Envelope;\r\n\t\t\tif (envelopeIndex == instrument.envelopeCount) {\r\n\t\t\t\tif (usedNoteSize /*|| !this._perNote*/) break;\r\n\t\t\t\t// Special case: if no other envelopes used note size, default to applying it to note volume.\r\n\t\t\t\tautomationTarget = Config.instrumentAutomationTargets.dictionary[\"noteVolume\"];\r\n\t\t\t\ttargetIndex = 0;\r\n\t\t\t\tenvelope = Config.envelopes.dictionary[\"note size\"];\r\n\t\t\t} else {\r\n\t\t\t\tlet envelopeSettings: EnvelopeSettings = instrument.envelopes[envelopeIndex];\r\n\t\t\t\tautomationTarget = Config.instrumentAutomationTargets[envelopeSettings.target];\r\n\t\t\t\ttargetIndex = envelopeSettings.index;\r\n\t\t\t\tenvelope = Config.envelopes[envelopeSettings.envelope];\r\n\t\t\t\tif (envelope.type == EnvelopeType.noteSize) usedNoteSize = true;\r\n\t\t\t}\r\n\t\t\tif (/*automationTarget.perNote == this._perNote &&*/ automationTarget.computeIndex != null) {\r\n\t\t\t\tconst computeIndex: number = automationTarget.computeIndex + targetIndex;\r\n\t\t\t\tlet envelopeStart: number = EnvelopeComputer.computeEnvelope(envelope, noteSecondsStart, beatTimeStart, noteSizeStart);\r\n\t\t\t\tlet envelopeEnd:   number = EnvelopeComputer.computeEnvelope(envelope, noteSecondsEnd,   beatTimeEnd,   noteSizeEnd);\r\n\t\t\t\t\r\n\t\t\t\tif (prevSlideStart) {\r\n\t\t\t\t\tconst other: number = EnvelopeComputer.computeEnvelope(envelope, prevNoteSecondsStart, beatTimeStart, prevNoteSize);\r\n\t\t\t\t\tenvelopeStart += (other - envelopeStart) * prevSlideRatioStart;\r\n\t\t\t\t}\r\n\t\t\t\tif (prevSlideEnd) {\r\n\t\t\t\t\tconst other: number = EnvelopeComputer.computeEnvelope(envelope, prevNoteSecondsEnd, beatTimeEnd, prevNoteSize);\r\n\t\t\t\t\tenvelopeEnd += (other - envelopeEnd) * prevSlideRatioEnd;\r\n\t\t\t\t}\r\n\t\t\t\tif (nextSlideStart) {\r\n\t\t\t\t\tconst other: number = EnvelopeComputer.computeEnvelope(envelope, 0.0, beatTimeStart, nextNoteSize);\r\n\t\t\t\t\tenvelopeStart += (other - envelopeStart) * nextSlideRatioStart;\r\n\t\t\t\t}\r\n\t\t\t\tif (nextSlideEnd) {\r\n\t\t\t\t\tconst other: number = EnvelopeComputer.computeEnvelope(envelope, 0.0, beatTimeEnd, nextNoteSize);\r\n\t\t\t\t\tenvelopeEnd += (other - envelopeEnd) * nextSlideRatioEnd;\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tthis.envelopeStarts[computeIndex] *= envelopeStart;\r\n\t\t\t\tthis.envelopeEnds[computeIndex]   *= envelopeEnd;\r\n\t\t\t\tthis._modifiedEnvelopeIndices[this._modifiedEnvelopeCount++] = computeIndex;\r\n\t\t\t\t\r\n\t\t\t\tif (automationTarget.isFilter) {\r\n\t\t\t\t\tconst filterSettings: FilterSettings = /*this._perNote ?*/ instrument.noteFilter /*: instrument.eqFilter*/;\r\n\t\t\t\t\tif (filterSettings.controlPointCount > targetIndex && filterSettings.controlPoints[targetIndex].type == FilterType.lowPass) {\r\n\t\t\t\t\t\tlowpassCutoffDecayVolumeCompensation = Math.max(lowpassCutoffDecayVolumeCompensation, EnvelopeComputer.getLowpassCutoffDecayVolumeCompensation(envelope));\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tthis.noteSecondsStart = noteSecondsStart;\r\n\t\tthis.noteSecondsEnd = noteSecondsEnd;\r\n\t\tthis.noteTicksStart = noteTicksStart;\r\n\t\tthis.noteTicksEnd = noteTicksEnd;\r\n\t\tthis.prevNoteSecondsStart = prevNoteSecondsStart;\r\n\t\tthis.prevNoteSecondsEnd = prevNoteSecondsEnd;\r\n\t\tthis.prevNoteTicksStart = prevNoteTicksStart;\r\n\t\tthis.prevNoteTicksEnd = prevNoteTicksEnd;\r\n\t\tthis.prevNoteSize = prevNoteSize;\r\n\t\tthis.nextNoteSize = nextNoteSize;\r\n\t\tthis.noteSizeStart = noteSizeStart;\r\n\t\tthis.noteSizeEnd = noteSizeEnd;\r\n\t\tthis.prevSlideStart = prevSlideStart;\r\n\t\tthis.prevSlideEnd = prevSlideEnd;\r\n\t\tthis.nextSlideStart = nextSlideStart;\r\n\t\tthis.nextSlideEnd = nextSlideEnd;\r\n\t\tthis.prevSlideRatioStart = prevSlideRatioStart;\r\n\t\tthis.prevSlideRatioEnd = prevSlideRatioEnd;\r\n\t\tthis.nextSlideRatioStart = nextSlideRatioStart;\r\n\t\tthis.nextSlideRatioEnd = nextSlideRatioEnd;\r\n\t\tthis.lowpassCutoffDecayVolumeCompensation = lowpassCutoffDecayVolumeCompensation;\r\n\t}\r\n\t\r\n\tpublic clearEnvelopes(): void {\r\n\t\tfor (let envelopeIndex: number = 0; envelopeIndex < this._modifiedEnvelopeCount; envelopeIndex++) {\r\n\t\t\tconst computeIndex: number = this._modifiedEnvelopeIndices[envelopeIndex];\r\n\t\t\tthis.envelopeStarts[computeIndex] = 1.0;\r\n\t\t\tthis.envelopeEnds[computeIndex]   = 1.0;\r\n\t\t}\r\n\t\tthis._modifiedEnvelopeCount = 0;\r\n\t}\r\n\t\r\n\tpublic static computeEnvelope(envelope: Envelope, time: number, beats: number, noteSize: number): number {\r\n\t\tswitch(envelope.type) {\r\n\t\t\tcase EnvelopeType.noteSize: return Synth.noteSizeToVolumeMult(noteSize);\r\n\t\t\tcase EnvelopeType.none:     return 1.0;\r\n\t\t\tcase EnvelopeType.twang:    return 1.0 / (1.0 + time * envelope.speed);\r\n\t\t\tcase EnvelopeType.swell:    return 1.0 - 1.0 / (1.0 + time * envelope.speed);\r\n\t\t\tcase EnvelopeType.tremolo:  return 0.5 - Math.cos(beats * 2.0 * Math.PI * envelope.speed) * 0.5;\r\n\t\t\tcase EnvelopeType.tremolo2: return 0.75 - Math.cos(beats * 2.0 * Math.PI * envelope.speed) * 0.25;\r\n\t\t\tcase EnvelopeType.punch:    return Math.max(1.0, 2.0 - time * 10.0);\r\n\t\t\tcase EnvelopeType.flare:    const attack: number = 0.25 / Math.sqrt(envelope.speed); return time < attack ? time / attack : 1.0 / (1.0 + (time - attack) * envelope.speed);\r\n\t\t\tcase EnvelopeType.decay:    return Math.pow(2, -envelope.speed * time);\r\n\t\t\tdefault: throw new Error(\"Unrecognized operator envelope type.\");\r\n\t\t}\r\n\t}\r\n\t\r\n\tpublic static getLowpassCutoffDecayVolumeCompensation(envelope: Envelope): number {\r\n\t\t// This is a little hokey in the details, but I designed it a while ago and keep it \r\n\t\t// around for compatibility. This decides how much to increase the volume (or\r\n\t\t// expression) to compensate for a decaying lowpass cutoff to maintain perceived\r\n\t\t// volume overall.\r\n\t\tif (envelope.type == EnvelopeType.decay) return 1.25 + 0.025 * envelope.speed;\r\n\t\tif (envelope.type == EnvelopeType.twang) return 1.0  + 0.02  * envelope.speed;\r\n\t\treturn 1.0;\r\n\t}\r\n}\r\n\r\nclass Tone {\r\n\tpublic instrumentIndex: number;\r\n\tpublic readonly pitches: number[] = Array(Config.maxChordSize).fill(0);\r\n\tpublic pitchCount: number = 0;\r\n\tpublic chordSize: number = 0;\r\n\tpublic drumsetPitch: number | null = null;\r\n\tpublic note: Note | null = null;\r\n\tpublic prevNote: Note | null = null;\r\n\tpublic nextNote: Note | null = null;\r\n\tpublic prevNotePitchIndex: number = 0;\r\n\tpublic nextNotePitchIndex: number = 0;\r\n\tpublic freshlyAllocated: boolean = true;\r\n\tpublic atNoteStart: boolean = false;\r\n\tpublic isOnLastTick: boolean = false; // Whether the tone is finished fading out and ready to be freed.\r\n\tpublic passedEndOfNote: boolean = false;\r\n\tpublic forceContinueAtStart: boolean = false;\r\n\tpublic forceContinueAtEnd: boolean = false;\r\n\tpublic noteStartPart: number = 0;\r\n\tpublic noteEndPart: number = 0;\r\n\tpublic ticksSinceReleased: number = 0;\r\n\tpublic liveInputSamplesHeld: number = 0;\r\n\tpublic lastInterval: number = 0;\r\n\tpublic noiseSample: number = 0.0;\r\n\tpublic readonly phases: number[] = [];\r\n\tpublic readonly phaseDeltas: number[] = [];\r\n\tpublic readonly phaseDeltaScales: number[] = [];\r\n\tpublic expression: number = 0.0;\r\n\tpublic expressionDelta: number = 0.0;\r\n\tpublic readonly operatorExpressions: number[] = [];\r\n\tpublic readonly operatorExpressionDeltas: number[] = [];\r\n\tpublic readonly prevPitchExpressions: Array<number | null> = Array(Config.maxPitchOrOperatorCount).fill(null);\r\n\tpublic prevVibrato: number | null = null;\r\n\tpublic prevStringDecay: number | null = null;\r\n\tpublic pulseWidth: number = 0.0;\r\n\tpublic pulseWidthDelta: number = 0.0;\r\n\tpublic supersawDynamism: number = 0.0;\r\n\tpublic supersawDynamismDelta: number = 0.0;\r\n\tpublic supersawUnisonDetunes: number[] = []; // These can change over time, but slowly enough that I'm not including corresponding delta values within a tick run.\r\n\tpublic supersawShape: number = 0.0;\r\n\tpublic supersawShapeDelta: number = 0.0;\r\n\tpublic supersawDelayLength: number = 0.0;\r\n\tpublic supersawDelayLengthDelta: number = 0.0;\r\n\tpublic supersawDelayLine: Float32Array | null = null;\r\n\tpublic supersawDelayIndex: number = -1;\r\n\tpublic supersawPrevPhaseDelta: number | null = null;\r\n\tpublic readonly pickedStrings: PickedString[] = [];\r\n\t\r\n\tpublic readonly noteFilters: DynamicBiquadFilter[] = [];\r\n\tpublic noteFilterCount: number = 0;\r\n\tpublic initialNoteFilterInput1: number = 0.0;\r\n\tpublic initialNoteFilterInput2: number = 0.0;\r\n\t\r\n\tpublic specialIntervalExpressionMult: number = 1.0;\r\n\tpublic readonly feedbackOutputs: number[] = [];\r\n\tpublic feedbackMult: number = 0.0;\r\n\tpublic feedbackDelta: number = 0.0;\r\n\t\r\n\tpublic readonly envelopeComputer: EnvelopeComputer = new EnvelopeComputer(/*true*/);\r\n\t\r\n\tconstructor() {\r\n\t\tthis.reset();\r\n\t}\r\n\t\r\n\tpublic reset(): void {\r\n\t\tthis.noiseSample = 0.0;\r\n\t\tfor (let i: number = 0; i < Config.maxPitchOrOperatorCount; i++) {\r\n\t\t\tthis.phases[i] = 0.0;\r\n\t\t\tthis.feedbackOutputs[i] = 0.0;\r\n\t\t\tthis.prevPitchExpressions[i] = null;\r\n\t\t}\r\n\t\tfor (let i: number = 0; i < this.noteFilterCount; i++) {\r\n\t\t\tthis.noteFilters[i].resetOutput();\r\n\t\t}\r\n\t\tthis.noteFilterCount = 0;\r\n\t\tthis.initialNoteFilterInput1 = 0.0;\r\n\t\tthis.initialNoteFilterInput2 = 0.0;\r\n\t\tthis.liveInputSamplesHeld = 0;\r\n\t\tthis.supersawDelayIndex = -1;\r\n\t\tfor (const pickedString of this.pickedStrings) {\r\n\t\t\tpickedString.reset();\r\n\t\t}\r\n\t\tthis.envelopeComputer.reset();\r\n\t\tthis.prevVibrato = null;\r\n\t\tthis.prevStringDecay = null;\r\n\t\tthis.supersawPrevPhaseDelta = null;\r\n\t\tthis.drumsetPitch = null;\r\n\t}\r\n}\r\n\r\nclass InstrumentState {\r\n\tpublic awake: boolean = false; // Whether the instrument's effects-processing loop should continue.\r\n\tpublic computed: boolean = false; // Whether the effects-processing parameters are up-to-date for the current synth run.\r\n\tpublic tonesAddedInThisTick: boolean = false; // Whether any instrument tones are currently active.\r\n\tpublic flushingDelayLines: boolean = false; // If no tones were active recently, enter a mode where the delay lines are filled with zeros to reset them for later use.\r\n\tpublic deactivateAfterThisTick: boolean = false; // Whether the instrument is ready to be deactivated because the delay lines, if any, are fully zeroed.\r\n\tpublic attentuationProgress: number = 0.0; // How long since an active tone introduced an input signal to the delay lines, normalized from 0 to 1 based on how long to wait until the delay lines signal will have audibly dissapated.\r\n\tpublic flushedSamples: number = 0; // How many delay line samples have been flushed to zero.\r\n\tpublic readonly activeTones: Deque<Tone> = new Deque<Tone>();\r\n\tpublic readonly releasedTones: Deque<Tone> = new Deque<Tone>(); // Tones that are in the process of fading out after the corresponding notes ended.\r\n\tpublic readonly liveInputTones: Deque<Tone> = new Deque<Tone>(); // Tones that are initiated by a source external to the loaded song data.\r\n\t\r\n\tpublic type: InstrumentType = InstrumentType.chip;\r\n\tpublic synthesizer: Function | null = null;\r\n\tpublic wave: Float32Array | null = null;\r\n\tpublic noisePitchFilterMult: number = 1.0;\r\n\tpublic unison: Unison | null = null;\r\n\tpublic chord: Chord | null = null;\r\n\tpublic effects: number = 0;\r\n\t\r\n\tpublic eqFilterVolume: number = 1.0;\r\n\tpublic eqFilterVolumeDelta: number = 0.0;\r\n\tpublic mixVolume: number = 1.0;\r\n\tpublic mixVolumeDelta: number = 0.0;\r\n\tpublic delayInputMult: number = 0.0;\r\n\tpublic delayInputMultDelta: number = 0.0;\r\n\t\r\n\tpublic distortion: number = 0.0;\r\n\tpublic distortionDelta: number = 0.0;\r\n\tpublic distortionDrive: number = 0.0;\r\n\tpublic distortionDriveDelta: number = 0.0;\r\n\tpublic distortionFractionalInput1: number = 0.0;\r\n\tpublic distortionFractionalInput2: number = 0.0;\r\n\tpublic distortionFractionalInput3: number = 0.0;\r\n\tpublic distortionPrevInput: number = 0.0;\r\n\tpublic distortionNextOutput: number = 0.0;\r\n\t\r\n\tpublic bitcrusherPrevInput: number = 0.0;\r\n\tpublic bitcrusherCurrentOutput: number = 0.0;\r\n\tpublic bitcrusherPhase: number = 1.0;\r\n\tpublic bitcrusherPhaseDelta: number = 0.0;\r\n\tpublic bitcrusherPhaseDeltaScale: number = 1.0;\r\n\tpublic bitcrusherScale: number = 1.0;\r\n\tpublic bitcrusherScaleScale: number = 1.0;\r\n\tpublic bitcrusherFoldLevel: number = 1.0;\r\n\tpublic bitcrusherFoldLevelScale: number = 1.0;\r\n\t\r\n\tpublic readonly eqFilters: DynamicBiquadFilter[] = [];\r\n\tpublic eqFilterCount: number = 0;\r\n\tpublic initialEqFilterInput1: number = 0.0;\r\n\tpublic initialEqFilterInput2: number = 0.0;\r\n\t\r\n\tpublic panningDelayLine: Float32Array | null = null;\r\n\tpublic panningDelayPos: number = 0;\r\n\tpublic panningVolumeL: number = 0.0;\r\n\tpublic panningVolumeR: number = 0.0;\r\n\tpublic panningVolumeDeltaL: number = 0.0;\r\n\tpublic panningVolumeDeltaR: number = 0.0;\r\n\tpublic panningOffsetL: number = 0.0;\r\n\tpublic panningOffsetR: number = 0.0;\r\n\tpublic panningOffsetDeltaL: number = 0.0;\r\n\tpublic panningOffsetDeltaR: number = 0.0;\r\n\t\r\n\tpublic chorusDelayLineL: Float32Array | null = null;\r\n\tpublic chorusDelayLineR: Float32Array | null = null;\r\n\tpublic chorusDelayLineDirty: boolean = false;\r\n\tpublic chorusDelayPos: number = 0;\r\n\tpublic chorusPhase: number = 0;\r\n\tpublic chorusVoiceMult: number = 0;\r\n\tpublic chorusVoiceMultDelta: number = 0;\r\n\tpublic chorusCombinedMult: number = 0;\r\n\tpublic chorusCombinedMultDelta: number = 0;\r\n\t\r\n\tpublic echoDelayLineL: Float32Array | null = null;\r\n\tpublic echoDelayLineR: Float32Array | null = null;\r\n\tpublic echoDelayLineDirty: boolean = false;\r\n\tpublic echoDelayPos: number = 0;\r\n\tpublic echoDelayOffsetStart: number = 0;\r\n\tpublic echoDelayOffsetEnd: number | null = null;\r\n\tpublic echoDelayOffsetRatio: number = 0.0;\r\n\tpublic echoDelayOffsetRatioDelta: number = 0.0;\r\n\tpublic echoMult: number = 0.0;\r\n\tpublic echoMultDelta: number = 0.0;\r\n\tpublic echoShelfA1: number = 0.0;\r\n\tpublic echoShelfB0: number = 0.0;\r\n\tpublic echoShelfB1: number = 0.0;\r\n\tpublic echoShelfSampleL: number = 0.0;\r\n\tpublic echoShelfSampleR: number = 0.0;\r\n\tpublic echoShelfPrevInputL: number = 0.0;\r\n\tpublic echoShelfPrevInputR: number = 0.0;\r\n\t\r\n\tpublic reverbDelayLine: Float32Array | null = null;\r\n\tpublic reverbDelayLineDirty: boolean = false;\r\n\tpublic reverbDelayPos: number = 0;\r\n\tpublic reverbMult: number = 0.0;\r\n\tpublic reverbMultDelta: number = 0.0;\r\n\tpublic reverbShelfA1: number = 0.0;\r\n\tpublic reverbShelfB0: number = 0.0;\r\n\tpublic reverbShelfB1: number = 0.0;\r\n\tpublic reverbShelfSample0: number = 0.0;\r\n\tpublic reverbShelfSample1: number = 0.0;\r\n\tpublic reverbShelfSample2: number = 0.0;\r\n\tpublic reverbShelfSample3: number = 0.0;\r\n\tpublic reverbShelfPrevInput0: number = 0.0;\r\n\tpublic reverbShelfPrevInput1: number = 0.0;\r\n\tpublic reverbShelfPrevInput2: number = 0.0;\r\n\tpublic reverbShelfPrevInput3: number = 0.0;\r\n\t\r\n\t//public readonly envelopeComputer: EnvelopeComputer = new EnvelopeComputer(false);\r\n\t\r\n\tpublic readonly spectrumWave: SpectrumWaveState = new SpectrumWaveState();\r\n\tpublic readonly harmonicsWave: HarmonicsWaveState = new HarmonicsWaveState();\r\n\tpublic readonly drumsetSpectrumWaves: SpectrumWaveState[] = [];\r\n\t\r\n\tconstructor() {\r\n\t\tfor (let i: number = 0; i < Config.drumCount; i++) {\r\n\t\t\tthis.drumsetSpectrumWaves[i] = new SpectrumWaveState();\r\n\t\t}\r\n\t}\r\n\t\r\n\tpublic allocateNecessaryBuffers(synth: Synth, instrument: Instrument, samplesPerTick: number): void {\r\n\t\tif (effectsIncludePanning(instrument.effects)) {\r\n\t\t\tif (this.panningDelayLine == null || this.panningDelayLine.length < synth.panningDelayBufferSize) {\r\n\t\t\t\tthis.panningDelayLine = new Float32Array(synth.panningDelayBufferSize);\r\n\t\t\t}\r\n\t\t}\r\n\t\tif (effectsIncludeChorus(instrument.effects)) {\r\n\t\t\tif (this.chorusDelayLineL == null || this.chorusDelayLineL.length < synth.chorusDelayBufferSize) {\r\n\t\t\t\tthis.chorusDelayLineL = new Float32Array(synth.chorusDelayBufferSize);\r\n\t\t\t}\r\n\t\t\tif (this.chorusDelayLineR == null || this.chorusDelayLineR.length < synth.chorusDelayBufferSize) {\r\n\t\t\t\tthis.chorusDelayLineR = new Float32Array(synth.chorusDelayBufferSize);\r\n\t\t\t}\r\n\t\t}\r\n\t\tif (effectsIncludeEcho(instrument.effects)) {\r\n\t\t\t// account for tempo and delay automation changing delay length during a tick?\r\n\t\t\tconst safeEchoDelaySteps: number = Math.max(Config.echoDelayRange >> 1, (instrument.echoDelay + 1)); // The delay may be very short now, but if it increases later make sure we have enough sample history.\r\n\t\t\tconst baseEchoDelayBufferSize: number = Synth.fittingPowerOfTwo(safeEchoDelaySteps * Config.echoDelayStepTicks * samplesPerTick);\r\n\t\t\tconst safeEchoDelayBufferSize: number = baseEchoDelayBufferSize * 2; // If the tempo or delay changes and we suddenly need a longer delay, make sure that we have enough sample history to accomodate the longer delay.\r\n\t\t\t\r\n\t\t\tif (this.echoDelayLineL == null || this.echoDelayLineR == null) {\r\n\t\t\t\tthis.echoDelayLineL = new Float32Array(safeEchoDelayBufferSize);\r\n\t\t\t\tthis.echoDelayLineR = new Float32Array(safeEchoDelayBufferSize);\r\n\t\t\t} else if (this.echoDelayLineL.length < safeEchoDelayBufferSize || this.echoDelayLineR.length < safeEchoDelayBufferSize) {\r\n\t\t\t\t// The echo delay length may change whlie the song is playing if tempo changes,\r\n\t\t\t\t// so buffers may need to be reallocated, but we don't want to lose any echoes\r\n\t\t\t\t// so we need to copy the contents of the old buffer to the new one.\r\n\t\t\t\tconst newDelayLineL: Float32Array = new Float32Array(safeEchoDelayBufferSize);\r\n\t\t\t\tconst newDelayLineR: Float32Array = new Float32Array(safeEchoDelayBufferSize);\r\n\t\t\t\tconst oldMask: number = this.echoDelayLineL.length - 1;\r\n\t\t\t\t\r\n\t\t\t\tfor (let i = 0; i < this.echoDelayLineL.length; i++) {\r\n\t\t\t\t\tnewDelayLineL[i] = this.echoDelayLineL[(this.echoDelayPos + i) & oldMask];\r\n\t\t\t\t\tnewDelayLineR[i] = this.echoDelayLineL[(this.echoDelayPos + i) & oldMask];\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tthis.echoDelayPos = this.echoDelayLineL.length;\r\n\t\t\t\tthis.echoDelayLineL = newDelayLineL;\r\n\t\t\t\tthis.echoDelayLineR = newDelayLineR;\r\n\t\t\t}\r\n\t\t}\r\n\t\tif (effectsIncludeReverb(instrument.effects)) {\r\n\t\t\t// TODO: Make reverb delay line sample rate agnostic. Maybe just double buffer size for 96KHz? Adjust attenuation and shelf cutoff appropriately?\r\n\t\t\tif (this.reverbDelayLine == null) {\r\n\t\t\t\tthis.reverbDelayLine = new Float32Array(Config.reverbDelayBufferSize);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\t\r\n\tpublic deactivate(): void {\r\n\t\tthis.bitcrusherPrevInput = 0.0;\r\n\t\tthis.bitcrusherCurrentOutput = 0.0;\r\n\t\tthis.bitcrusherPhase = 1.0;\r\n\t\tfor (let i: number = 0; i < this.eqFilterCount; i++) {\r\n\t\t\tthis.eqFilters[i].resetOutput();\r\n\t\t}\r\n\t\tthis.eqFilterCount = 0;\r\n\t\tthis.initialEqFilterInput1 = 0.0;\r\n\t\tthis.initialEqFilterInput2 = 0.0;\r\n\t\tthis.distortionFractionalInput1 = 0.0;\r\n\t\tthis.distortionFractionalInput2 = 0.0;\r\n\t\tthis.distortionFractionalInput3 = 0.0;\r\n\t\tthis.distortionPrevInput = 0.0;\r\n\t\tthis.distortionNextOutput = 0.0;\r\n\t\tthis.panningDelayPos = 0;\r\n\t\tif (this.panningDelayLine != null) for (let i: number = 0; i < this.panningDelayLine.length; i++) this.panningDelayLine[i] = 0.0;\r\n\t\tthis.echoDelayOffsetEnd = null;\r\n\t\tthis.echoShelfSampleL = 0.0;\r\n\t\tthis.echoShelfSampleR = 0.0;\r\n\t\tthis.echoShelfPrevInputL = 0.0;\r\n\t\tthis.echoShelfPrevInputR = 0.0;\r\n\t\tthis.reverbShelfSample0 = 0.0;\r\n\t\tthis.reverbShelfSample1 = 0.0;\r\n\t\tthis.reverbShelfSample2 = 0.0;\r\n\t\tthis.reverbShelfSample3 = 0.0;\r\n\t\tthis.reverbShelfPrevInput0 = 0.0;\r\n\t\tthis.reverbShelfPrevInput1 = 0.0;\r\n\t\tthis.reverbShelfPrevInput2 = 0.0;\r\n\t\tthis.reverbShelfPrevInput3 = 0.0;\r\n\t\t\r\n\t\tthis.awake = false;\r\n\t\tthis.flushingDelayLines = false;\r\n\t\tthis.deactivateAfterThisTick = false;\r\n\t\tthis.attentuationProgress = 0.0;\r\n\t\tthis.flushedSamples = 0;\r\n\t}\r\n\t\r\n\tpublic resetAllEffects(): void {\r\n\t\tthis.deactivate();\r\n\t\t\r\n\t\tif (this.chorusDelayLineDirty) {\r\n\t\t\tfor (let i: number = 0; i < this.chorusDelayLineL!.length; i++) this.chorusDelayLineL![i] = 0.0;\r\n\t\t\tfor (let i: number = 0; i < this.chorusDelayLineR!.length; i++) this.chorusDelayLineR![i] = 0.0;\r\n\t\t}\r\n\t\tif (this.echoDelayLineDirty) {\r\n\t\t\tfor (let i: number = 0; i < this.echoDelayLineL!.length; i++) this.echoDelayLineL![i] = 0.0;\r\n\t\t\tfor (let i: number = 0; i < this.echoDelayLineR!.length; i++) this.echoDelayLineR![i] = 0.0;\r\n\t\t}\r\n\t\tif (this.reverbDelayLineDirty) {\r\n\t\t\tfor (let i: number = 0; i < this.reverbDelayLine!.length; i++) this.reverbDelayLine![i] = 0.0;\r\n\t\t}\r\n\t\t\r\n\t\tthis.chorusPhase = 0.0;\r\n\t}\r\n\t\r\n\tpublic compute(synth: Synth, instrument: Instrument, samplesPerTick: number, roundedSamplesPerTick: number, tone: Tone | null): void {\r\n\t\tthis.computed = true;\r\n\t\t\r\n\t\tthis.type = instrument.type;\r\n\t\tthis.synthesizer = Synth.getInstrumentSynthFunction(instrument);\r\n\t\tthis.unison = Config.unisons[instrument.unison];\r\n\t\tthis.chord = instrument.getChord();\r\n\t\tthis.noisePitchFilterMult = Config.chipNoises[instrument.chipNoise].pitchFilterMult;\r\n\t\t\r\n\t\t// Force effects to be disabled if the corresponding slider is at zero (and automation isn't involved).\r\n\t\tlet effects: number = instrument.effects;\r\n\t\tif (instrument.distortion  == 0)        effects &= ~(1 << EffectType.distortion);\r\n\t\tif (instrument.pan == Config.panCenter) effects &= ~(1 << EffectType.panning);\r\n\t\tif (instrument.chorus      == 0)        effects &= ~(1 << EffectType.chorus);\r\n\t\tif (instrument.echoSustain == 0)        effects &= ~(1 << EffectType.echo);\r\n\t\tif (instrument.reverb      == 0)        effects &= ~(1 << EffectType.reverb);\r\n\t\tthis.effects = effects;\r\n\t\t\r\n\t\tthis.allocateNecessaryBuffers(synth, instrument, samplesPerTick);\r\n\t\t\r\n\t\tconst samplesPerSecond: number = synth.samplesPerSecond;\r\n\t\t\r\n\t\tthis.updateWaves(instrument, samplesPerSecond);\r\n\t\t\r\n\t\t//const ticksIntoBar: number = synth.getTicksIntoBar();\r\n\t\t//const tickTimeStart: number = ticksIntoBar;\r\n\t\t//const tickTimeEnd:   number = ticksIntoBar + 1.0;\r\n\t\t//const secondsPerTick: number = samplesPerTick / synth.samplesPerSecond;\r\n\t\t//const currentPart: number = synth.getCurrentPart();\r\n\t\t//this.envelopeComputer.computeEnvelopes(instrument, currentPart, tickTimeStart, secondsPerTick, tone);\r\n\t\t//const envelopeStarts: number[] = this.envelopeComputer.envelopeStarts;\r\n\t\t//const envelopeEnds: number[] = this.envelopeComputer.envelopeEnds;\r\n\t\t\r\n\t\tconst usesDistortion: boolean = effectsIncludeDistortion(effects);\r\n\t\tconst usesBitcrusher: boolean = effectsIncludeBitcrusher(effects);\r\n\t\tconst usesPanning:    boolean = effectsIncludePanning(effects);\r\n\t\tconst usesChorus:     boolean = effectsIncludeChorus(effects);\r\n\t\tconst usesEcho:       boolean = effectsIncludeEcho(effects);\r\n\t\tconst usesReverb:     boolean = effectsIncludeReverb(effects);\r\n\t\t\r\n\t\tif (usesDistortion) {\r\n\t\t\tconst distortionSliderStart: number = Math.min(1.0, /*envelopeStarts[InstrumentAutomationIndex.distortion] **/ instrument.distortion / (Config.distortionRange - 1));\r\n\t\t\tconst distortionSliderEnd:   number = Math.min(1.0, /*envelopeEnds[  InstrumentAutomationIndex.distortion] **/ instrument.distortion / (Config.distortionRange - 1));\r\n\t\t\tconst distortionStart: number = Math.pow(1.0 - 0.895 * (Math.pow(20.0, distortionSliderStart) - 1.0) / 19.0, 2.0);\r\n\t\t\tconst distortionEnd:   number = Math.pow(1.0 - 0.895 * (Math.pow(20.0, distortionSliderEnd  ) - 1.0) / 19.0, 2.0);\r\n\t\t\tconst distortionDriveStart: number = (1.0 + 2.0 * distortionSliderStart) / Config.distortionBaseVolume;\r\n\t\t\tconst distortionDriveEnd:   number = (1.0 + 2.0 * distortionSliderEnd)   / Config.distortionBaseVolume;\r\n\t\t\tthis.distortion = distortionStart;\r\n\t\t\tthis.distortionDelta = (distortionEnd - distortionStart) / roundedSamplesPerTick;\r\n\t\t\tthis.distortionDrive = distortionDriveStart;\r\n\t\t\tthis.distortionDriveDelta = (distortionDriveEnd - distortionDriveStart) / roundedSamplesPerTick;\r\n\t\t}\r\n\t\t\r\n\t\tif (usesBitcrusher) {\r\n\t\t\tconst freqSettingStart: number = instrument.bitcrusherFreq /** Math.sqrt(envelopeStarts[InstrumentAutomationIndex.bitcrusherFrequency])*/;\r\n\t\t\tconst freqSettingEnd:   number = instrument.bitcrusherFreq /** Math.sqrt(envelopeEnds[  InstrumentAutomationIndex.bitcrusherFrequency])*/;\r\n\t\t\tconst quantizationSettingStart: number = instrument.bitcrusherQuantization /** Math.sqrt(envelopeStarts[InstrumentAutomationIndex.bitcrusherQuantization])*/;\r\n\t\t\tconst quantizationSettingEnd:   number = instrument.bitcrusherQuantization /** Math.sqrt(envelopeEnds[  InstrumentAutomationIndex.bitcrusherQuantization])*/;\r\n\t\t\t\r\n\t\t\tconst basePitch: number = Config.keys[synth.song!.key].basePitch; // TODO: What if there's a key change mid-song?\r\n\t\t\tconst freqStart: number = Instrument.frequencyFromPitch(basePitch + 60) * Math.pow(2.0, (Config.bitcrusherFreqRange - 1 - freqSettingStart) * Config.bitcrusherOctaveStep);\r\n\t\t\tconst freqEnd:   number = Instrument.frequencyFromPitch(basePitch + 60) * Math.pow(2.0, (Config.bitcrusherFreqRange - 1 - freqSettingEnd)   * Config.bitcrusherOctaveStep);\r\n\t\t\tconst phaseDeltaStart: number = Math.min(1.0, freqStart / samplesPerSecond);\r\n\t\t\tconst phaseDeltaEnd:   number = Math.min(1.0, freqEnd   / samplesPerSecond);\r\n\t\t\tthis.bitcrusherPhaseDelta = phaseDeltaStart;\r\n\t\t\tthis.bitcrusherPhaseDeltaScale = Math.pow(phaseDeltaEnd / phaseDeltaStart, 1.0 / roundedSamplesPerTick);\r\n\t\t\t\r\n\t\t\tconst scaleStart: number = 2.0 * Config.bitcrusherBaseVolume * Math.pow(2.0, 1.0 - Math.pow(2.0, (Config.bitcrusherQuantizationRange - 1 - quantizationSettingStart) * 0.5));\r\n\t\t\tconst scaleEnd:   number = 2.0 * Config.bitcrusherBaseVolume * Math.pow(2.0, 1.0 - Math.pow(2.0, (Config.bitcrusherQuantizationRange - 1 - quantizationSettingEnd)   * 0.5));\r\n\t\t\tthis.bitcrusherScale = scaleStart;\r\n\t\t\tthis.bitcrusherScaleScale = Math.pow(scaleEnd / scaleStart, 1.0 / roundedSamplesPerTick);\r\n\t\t\t\r\n\t\t\tconst foldLevelStart: number = 2.0 * Config.bitcrusherBaseVolume * Math.pow(1.5, Config.bitcrusherQuantizationRange - 1 - quantizationSettingStart);\r\n\t\t\tconst foldLevelEnd:   number = 2.0 * Config.bitcrusherBaseVolume * Math.pow(1.5, Config.bitcrusherQuantizationRange - 1 - quantizationSettingEnd);\r\n\t\t\tthis.bitcrusherFoldLevel = foldLevelStart;\r\n\t\t\tthis.bitcrusherFoldLevelScale = Math.pow(foldLevelEnd / foldLevelStart, 1.0 / roundedSamplesPerTick);\r\n\t\t}\r\n\t\t\r\n\t\tlet eqFilterVolume: number = 1.0; //this.envelopeComputer.lowpassCutoffDecayVolumeCompensation;\r\n\t\tconst eqFilterSettings: FilterSettings = instrument.eqFilter;\r\n\t\t//const eqAllFreqsEnvelopeStart: number = envelopeStarts[InstrumentAutomationIndex.eqFilterAllFreqs];\r\n\t\t//const eqAllFreqsEnvelopeEnd:   number = envelopeEnds[  InstrumentAutomationIndex.eqFilterAllFreqs];\r\n\t\tfor (let i: number = 0; i < eqFilterSettings.controlPointCount; i++) {\r\n\t\t\t//const eqFreqEnvelopeStart: number = envelopeStarts[InstrumentAutomationIndex.eqFilterFreq0 + i];\r\n\t\t\t//const eqFreqEnvelopeEnd:   number = envelopeEnds[  InstrumentAutomationIndex.eqFilterFreq0 + i];\r\n\t\t\t//const eqPeakEnvelopeStart: number = envelopeStarts[InstrumentAutomationIndex.eqFilterGain0 + i];\r\n\t\t\t//const eqPeakEnvelopeEnd:   number = envelopeEnds[  InstrumentAutomationIndex.eqFilterGain0 + i];\r\n\t\t\tconst point: FilterControlPoint = eqFilterSettings.controlPoints[i];\r\n\t\t\tpoint.toCoefficients(Synth.tempFilterStartCoefficients, samplesPerSecond, /*eqAllFreqsEnvelopeStart * eqFreqEnvelopeStart*/ 1.0, /*eqPeakEnvelopeStart*/ 1.0);\r\n\t\t\tpoint.toCoefficients(Synth.tempFilterEndCoefficients,   samplesPerSecond, /*eqAllFreqsEnvelopeEnd   * eqFreqEnvelopeEnd*/   1.0, /*eqPeakEnvelopeEnd*/   1.0);\r\n\t\t\tif (this.eqFilters.length <= i) this.eqFilters[i] = new DynamicBiquadFilter();\r\n\t\t\tthis.eqFilters[i].loadCoefficientsWithGradient(Synth.tempFilterStartCoefficients, Synth.tempFilterEndCoefficients, 1.0 / roundedSamplesPerTick, point.type == FilterType.lowPass);\r\n\t\t\teqFilterVolume *= point.getVolumeCompensationMult();\r\n\t\t}\r\n\t\tthis.eqFilterCount = eqFilterSettings.controlPointCount;\r\n\t\teqFilterVolume = Math.min(3.0, eqFilterVolume);\r\n\t\t\r\n\t\tconst mainInstrumentVolume: number = Synth.instrumentVolumeToVolumeMult(instrument.volume);\r\n\t\tthis.mixVolume = mainInstrumentVolume /** envelopeStarts[InstrumentAutomationIndex.mixVolume]*/;\r\n\t\tconst mixVolumeEnd  = mainInstrumentVolume /** envelopeEnds[  InstrumentAutomationIndex.mixVolume]*/;\r\n\t\tthis.mixVolumeDelta = (mixVolumeEnd - this.mixVolume) / roundedSamplesPerTick;\r\n\t\t\r\n\t\tlet eqFilterVolumeStart: number = eqFilterVolume;\r\n\t\tlet eqFilterVolumeEnd: number = eqFilterVolume;\r\n\t\tlet delayInputMultStart: number = 1.0;\r\n\t\tlet delayInputMultEnd: number = 1.0;\r\n\t\t\r\n\t\tif (usesPanning) {\r\n\t\t\t//const panEnvelopeStart: number = envelopeStarts[InstrumentAutomationIndex.panning] * 2.0 - 1.0;\r\n\t\t\t//const panEnvelopeEnd:   number = envelopeEnds[  InstrumentAutomationIndex.panning] * 2.0 - 1.0;\r\n\t\t\tconst pan: number = (instrument.pan - Config.panCenter) / Config.panCenter;\r\n\t\t\tconst panStart: number = Math.max(-1.0, Math.min(1.0, pan /** panEnvelopeStart*/));\r\n\t\t\tconst panEnd:   number = Math.max(-1.0, Math.min(1.0, pan /** panEnvelopeEnd  */));\r\n\t\t\tconst volumeStartL: number = Math.cos((1 + panStart) * Math.PI * 0.25) * 1.414;\r\n\t\t\tconst volumeStartR: number = Math.cos((1 - panStart) * Math.PI * 0.25) * 1.414;\r\n\t\t\tconst volumeEndL:   number = Math.cos((1 + panEnd)   * Math.PI * 0.25) * 1.414;\r\n\t\t\tconst volumeEndR:   number = Math.cos((1 - panEnd)   * Math.PI * 0.25) * 1.414;\r\n\t\t\tconst maxDelaySamples: number = samplesPerSecond * Config.panDelaySecondsMax;\r\n\t\t\tconst delayStart: number = panStart * maxDelaySamples;\r\n\t\t\tconst delayEnd:   number = panEnd   * maxDelaySamples;\r\n\t\t\tconst delayStartL: number = Math.max(0.0,  delayStart);\r\n\t\t\tconst delayStartR: number = Math.max(0.0, -delayStart);\r\n\t\t\tconst delayEndL:   number = Math.max(0.0,  delayEnd);\r\n\t\t\tconst delayEndR:   number = Math.max(0.0, -delayEnd);\r\n\t\t\t\r\n\t\t\tthis.panningVolumeL = volumeStartL;\r\n\t\t\tthis.panningVolumeR = volumeStartR;\r\n\t\t\tthis.panningVolumeDeltaL = (volumeEndL - volumeStartL) / roundedSamplesPerTick;\r\n\t\t\tthis.panningVolumeDeltaR = (volumeEndR - volumeStartR) / roundedSamplesPerTick;\r\n\t\t\tthis.panningOffsetL = this.panningDelayPos - delayStartL + synth.panningDelayBufferSize;\r\n\t\t\tthis.panningOffsetR = this.panningDelayPos - delayStartR + synth.panningDelayBufferSize;\r\n\t\t\tthis.panningOffsetDeltaL = (delayEndL - delayStartL) / roundedSamplesPerTick;\r\n\t\t\tthis.panningOffsetDeltaR = (delayEndR - delayStartR) / roundedSamplesPerTick;\r\n\t\t}\r\n\t\t\r\n\t\tif (usesChorus) {\r\n\t\t\t//const chorusEnvelopeStart: number = envelopeStarts[InstrumentAutomationIndex.chorus];\r\n\t\t\t//const chorusEnvelopeEnd:   number = envelopeEnds[  InstrumentAutomationIndex.chorus];\r\n\t\t\tlet chorusStart: number = Math.min(1.0, /*chorusEnvelopeStart **/ instrument.chorus / (Config.chorusRange - 1));\r\n\t\t\tlet chorusEnd:   number = Math.min(1.0, /*chorusEnvelopeEnd   **/ instrument.chorus / (Config.chorusRange - 1));\r\n\t\t\tchorusStart = chorusStart * 0.6 + (Math.pow(chorusStart, 6.0)) * 0.4;\r\n\t\t\tchorusEnd   = chorusEnd   * 0.6 + (Math.pow(chorusEnd,   6.0)) * 0.4;\r\n\t\t\tconst chorusCombinedMultStart = 1.0 / Math.sqrt(3.0 * chorusStart * chorusStart + 1.0);\r\n\t\t\tconst chorusCombinedMultEnd = 1.0 / Math.sqrt(3.0 * chorusEnd * chorusEnd + 1.0);\r\n\t\t\tthis.chorusVoiceMult = chorusStart;\r\n\t\t\tthis.chorusVoiceMultDelta = (chorusEnd - chorusStart) / roundedSamplesPerTick;\r\n\t\t\tthis.chorusCombinedMult = chorusCombinedMultStart;\r\n\t\t\tthis.chorusCombinedMultDelta = (chorusCombinedMultEnd - chorusCombinedMultStart) / roundedSamplesPerTick;\r\n\t\t}\r\n\t\t\r\n\t\tlet maxEchoMult = 0.0;\r\n\t\tlet averageEchoDelaySeconds: number = 0.0;\r\n\t\tif (usesEcho) {\r\n\t\t\t//const echoSustainEnvelopeStart: number = envelopeStarts[InstrumentAutomationIndex.echoSustain];\r\n\t\t\t//const echoSustainEnvelopeEnd:   number = envelopeEnds[  InstrumentAutomationIndex.echoSustain];\r\n\t\t\tconst echoMultStart: number = Math.min(1.0, Math.pow(/*echoSustainEnvelopeStart **/ instrument.echoSustain / Config.echoSustainRange, 1.1)) * 0.9;\r\n\t\t\tconst echoMultEnd:   number = Math.min(1.0, Math.pow(/*echoSustainEnvelopeEnd   **/ instrument.echoSustain / Config.echoSustainRange, 1.1)) * 0.9;\r\n\t\t\tthis.echoMult = echoMultStart;\r\n\t\t\tthis.echoMultDelta = (echoMultEnd - echoMultStart) / roundedSamplesPerTick;\r\n\t\t\tmaxEchoMult = Math.max(echoMultStart, echoMultEnd);\r\n\t\t\t\r\n\t\t\t// TODO: After computing a tick's settings once for multiple run lengths (which is\r\n\t\t\t// good for audio worklet threads), compute the echo delay envelopes at tick (or\r\n\t\t\t// part) boundaries to interpolate between two delay taps.\r\n\t\t\t//const echoDelayEnvelopeStart:   number = envelopeStarts[InstrumentAutomationIndex.echoDelay];\r\n\t\t\t//const echoDelayEnvelopeEnd:     number = envelopeEnds[  InstrumentAutomationIndex.echoDelay];\r\n\t\t\tconst echoDelayOffset: number = Math.round((instrument.echoDelay + 1) * Config.echoDelayStepTicks * samplesPerTick);\r\n\t\t\tif (this.echoDelayOffsetEnd != null) {\r\n\t\t\t\tthis.echoDelayOffsetStart = this.echoDelayOffsetEnd;\r\n\t\t\t} else {\r\n\t\t\t\tthis.echoDelayOffsetStart = echoDelayOffset;\r\n\t\t\t}\r\n\t\t\tthis.echoDelayOffsetEnd = echoDelayOffset;\r\n\t\t\taverageEchoDelaySeconds = (this.echoDelayOffsetStart + this.echoDelayOffsetEnd) * 0.5 / samplesPerSecond;\r\n\t\t\t\r\n\t\t\tthis.echoDelayOffsetRatio = 0.0;\r\n\t\t\tthis.echoDelayOffsetRatioDelta = 1.0 / roundedSamplesPerTick;\r\n\t\t\t\r\n\t\t\tconst shelfRadians: number = 2.0 * Math.PI * Config.echoShelfHz / synth.samplesPerSecond;\r\n\t\t\tSynth.tempFilterStartCoefficients.highShelf1stOrder(shelfRadians, Config.echoShelfGain);\r\n\t\t\tthis.echoShelfA1 = Synth.tempFilterStartCoefficients.a[1];\r\n\t\t\tthis.echoShelfB0 = Synth.tempFilterStartCoefficients.b[0];\r\n\t\t\tthis.echoShelfB1 = Synth.tempFilterStartCoefficients.b[1];\r\n\t\t}\r\n\t\t\r\n\t\tlet maxReverbMult = 0.0;\r\n\t\tif (usesReverb) {\r\n\t\t\t//const reverbEnvelopeStart: number = envelopeStarts[InstrumentAutomationIndex.reverb];\r\n\t\t\t//const reverbEnvelopeEnd:   number = envelopeEnds[  InstrumentAutomationIndex.reverb];\r\n\t\t\tconst reverbStart: number = Math.min(1.0, Math.pow(/*reverbEnvelopeStart **/ instrument.reverb / Config.reverbRange, 0.667)) * 0.425;\r\n\t\t\tconst reverbEnd:   number = Math.min(1.0, Math.pow(/*reverbEnvelopeEnd   **/ instrument.reverb / Config.reverbRange, 0.667)) * 0.425;\r\n\t\t\tthis.reverbMult = reverbStart;\r\n\t\t\tthis.reverbMultDelta = (reverbEnd - reverbStart) / roundedSamplesPerTick;\r\n\t\t\tmaxReverbMult = Math.max(reverbStart, reverbEnd);\r\n\t\t\t\r\n\t\t\tconst shelfRadians: number = 2.0 * Math.PI * Config.reverbShelfHz / synth.samplesPerSecond;\r\n\t\t\tSynth.tempFilterStartCoefficients.highShelf1stOrder(shelfRadians, Config.reverbShelfGain);\r\n\t\t\tthis.reverbShelfA1 = Synth.tempFilterStartCoefficients.a[1];\r\n\t\t\tthis.reverbShelfB0 = Synth.tempFilterStartCoefficients.b[0];\r\n\t\t\tthis.reverbShelfB1 = Synth.tempFilterStartCoefficients.b[1];\r\n\t\t}\r\n\t\t\r\n\t\tif (this.tonesAddedInThisTick) {\r\n\t\t\tthis.attentuationProgress = 0.0;\r\n\t\t\tthis.flushedSamples = 0;\r\n\t\t\tthis.flushingDelayLines = false;\r\n\t\t} else if (!this.flushingDelayLines) {\r\n\t\t\t// If this instrument isn't playing tones anymore, the volume can fade out by the\r\n\t\t\t// end of the first tick. It's possible for filters and the panning delay line to\r\n\t\t\t// continue past the end of the tone but they should have mostly dissipated by the\r\n\t\t\t// end of the tick anyway.\r\n\t\t\tif (this.attentuationProgress == 0.0) {\r\n\t\t\t\teqFilterVolumeEnd = 0.0;\r\n\t\t\t} else {\r\n\t\t\t\teqFilterVolumeStart = 0.0;\r\n\t\t\t\teqFilterVolumeEnd = 0.0;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tconst attenuationThreshold: number = 1.0 / 256.0; // when the delay line signal has attenuated this much, it should be inaudible and should be flushed to zero.\r\n\t\t\tconst halfLifeMult: number = -Math.log2(attenuationThreshold);\r\n\t\t\tlet delayDuration: number = 0.0;\r\n\t\t\t\r\n\t\t\tif (usesChorus) {\r\n\t\t\t\tdelayDuration += Config.chorusMaxDelay;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tif (usesEcho) {\r\n\t\t\t\tconst attenuationPerSecond: number = Math.pow(maxEchoMult, 1.0 / averageEchoDelaySeconds);\r\n\t\t\t\tconst halfLife: number = -1.0 / Math.log2(attenuationPerSecond);\r\n\t\t\t\tconst echoDuration: number = halfLife * halfLifeMult;\r\n\t\t\t\tdelayDuration += echoDuration;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tif (usesReverb) {\r\n\t\t\t\tconst averageMult: number = maxReverbMult * 2.0;\r\n\t\t\t\tconst averageReverbDelaySeconds: number = (Config.reverbDelayBufferSize / 4.0) / samplesPerSecond;\r\n\t\t\t\tconst attenuationPerSecond: number = Math.pow(averageMult, 1.0 / averageReverbDelaySeconds);\r\n\t\t\t\tconst halfLife: number = -1.0 / Math.log2(attenuationPerSecond);\r\n\t\t\t\tconst reverbDuration: number = halfLife * halfLifeMult;\r\n\t\t\t\tdelayDuration += reverbDuration;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tconst secondsInTick: number = samplesPerTick / samplesPerSecond;\r\n\t\t\tconst progressInTick: number = secondsInTick / delayDuration;\r\n\t\t\tconst progressAtEndOfTick: number = this.attentuationProgress + progressInTick;\r\n\t\t\tif (progressAtEndOfTick >= 1.0) {\r\n\t\t\t\tdelayInputMultEnd = 0.0;\r\n\t\t\t}\r\n\t\t\tthis.attentuationProgress = progressAtEndOfTick;\r\n\t\t\tif (this.attentuationProgress >= 1.0) {\r\n\t\t\t\tthis.flushingDelayLines = true;\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\t// Flushing delay lines to zero since the signal has mostly dissipated.\r\n\t\t\teqFilterVolumeStart = 0.0;\r\n\t\t\teqFilterVolumeEnd = 0.0;\r\n\t\t\tdelayInputMultStart = 0.0;\r\n\t\t\tdelayInputMultEnd = 0.0;\r\n\t\t\t\r\n\t\t\tlet totalDelaySamples: number = 0;\r\n\t\t\tif (usesChorus) totalDelaySamples += synth.chorusDelayBufferSize;\r\n\t\t\tif (usesEcho) totalDelaySamples += this.echoDelayLineL!.length;\r\n\t\t\tif (usesReverb) totalDelaySamples += Config.reverbDelayBufferSize;\r\n\t\t\t\r\n\t\t\tthis.flushedSamples += roundedSamplesPerTick;\r\n\t\t\tif (this.flushedSamples >= totalDelaySamples) {\r\n\t\t\t\tthis.deactivateAfterThisTick = true;\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tthis.eqFilterVolume = eqFilterVolumeStart;\r\n\t\tthis.eqFilterVolumeDelta = (eqFilterVolumeEnd - eqFilterVolumeStart) / roundedSamplesPerTick;\r\n\t\tthis.delayInputMult = delayInputMultStart;\r\n\t\tthis.delayInputMultDelta = (delayInputMultEnd - delayInputMultStart) / roundedSamplesPerTick;\r\n\t}\r\n\t\r\n\tpublic updateWaves(instrument: Instrument, samplesPerSecond: number): void {\r\n\t\tif (instrument.type == InstrumentType.chip) {\r\n\t\t\tthis.wave = Config.chipWaves[instrument.chipWave].samples;\r\n\t\t} else if (instrument.type == InstrumentType.noise) {\r\n\t\t\tthis.wave = getDrumWave(instrument.chipNoise, inverseRealFourierTransform, scaleElementsByFactor);\r\n\t\t} else if (instrument.type == InstrumentType.harmonics) {\r\n\t\t\tthis.wave = this.harmonicsWave.getCustomWave(instrument.harmonicsWave, instrument.type);\r\n\t\t} else if (instrument.type == InstrumentType.pickedString) {\r\n\t\t\tthis.wave = this.harmonicsWave.getCustomWave(instrument.harmonicsWave, instrument.type);\r\n\t\t} else if (instrument.type == InstrumentType.spectrum) {\r\n\t\t\tthis.wave = this.spectrumWave.getCustomWave(instrument.spectrumWave, 8);\r\n\t\t} else if (instrument.type == InstrumentType.drumset) {\r\n\t\t\tfor (let i: number = 0; i < Config.drumCount; i++) {\r\n\t\t\t\tthis.drumsetSpectrumWaves[i].getCustomWave(instrument.drumsetSpectrumWaves[i], InstrumentState._drumsetIndexToSpectrumOctave(i));\r\n\t\t\t}\r\n\t\t\tthis.wave = null;\r\n\t\t} else {\r\n\t\t\tthis.wave = null;\r\n\t\t}\r\n\t}\r\n\t\r\n\tpublic getDrumsetWave(pitch: number): Float32Array {\r\n\t\tif (this.type == InstrumentType.drumset) {\r\n\t\t\treturn this.drumsetSpectrumWaves[pitch].wave!;\r\n\t\t} else {\r\n\t\t\tthrow new Error(\"Unhandled instrument type in getDrumsetWave\");\r\n\t\t}\r\n\t}\r\n\t\r\n\tpublic static drumsetIndexReferenceDelta(index: number): number {\r\n\t\treturn Instrument.frequencyFromPitch(Config.spectrumBasePitch + index * 6) / 44100;\r\n\t}\r\n\t\r\n\tprivate static _drumsetIndexToSpectrumOctave(index: number): number {\r\n\t\treturn 15 + Math.log2(InstrumentState.drumsetIndexReferenceDelta(index));\r\n\t}\r\n}\r\n\r\nclass ChannelState {\r\n\tpublic readonly instruments: InstrumentState[] = [];\r\n\tpublic muted: boolean = false;\r\n\tpublic singleSeamlessInstrument: number | null = null; // Seamless tones from a pattern with a single instrument can be transferred to a different single seamless instrument in the next pattern.\r\n}\r\n\r\nexport class Synth {\r\n\r\n\tprivate syncSongState(): void {\r\n\t\tconst channelCount: number = this.song!.getChannelCount();\r\n\t\tfor (let i: number = this.channels.length; i < channelCount; i++) {\r\n\t\t\tthis.channels[i] = new ChannelState();\r\n\t\t}\r\n\t\tthis.channels.length = channelCount;\r\n\t\tfor (let i: number = 0; i < channelCount; i++) {\r\n\t\t\tconst channel: Channel = this.song!.channels[i];\r\n\t\t\tconst channelState: ChannelState = this.channels[i];\r\n\t\t\tfor (let j: number = channelState.instruments.length; j < channel.instruments.length; j++) {\r\n\t\t\t\tchannelState.instruments[j] = new InstrumentState();\r\n\t\t\t}\r\n\t\t\tchannelState.instruments.length = channel.instruments.length;\r\n\t\t\t\r\n\t\t\tif (channelState.muted != channel.muted) {\r\n\t\t\t\tchannelState.muted = channel.muted;\r\n\t\t\t\tif (channelState.muted) {\r\n\t\t\t\t\tfor (const instrumentState of channelState.instruments) {\r\n\t\t\t\t\t\tinstrumentState.resetAllEffects();\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\t\r\n\tprivate warmUpSynthesizer(song: Song | null): void {\r\n\t\tif (song != null) {\r\n\t\t\tthis.syncSongState();\r\n\t\t\tconst samplesPerTick: number = this.getSamplesPerTick();\r\n\t\t\tfor (let j: number = 0; j < song.getChannelCount(); j++) {\r\n\t\t\t\tfor (let i: number = 0; i < song.channels[j].instruments.length; i++) {\r\n\t\t\t\t\tconst instrument: Instrument = song.channels[j].instruments[i];\r\n\t\t\t\t\tconst instrumentState: InstrumentState = this.channels[j].instruments[i];\r\n\t\t\t\t\tSynth.getInstrumentSynthFunction(instrument);\r\n\t\t\t\t\tinstrumentState.updateWaves(instrument, this.samplesPerSecond);\r\n\t\t\t\t\tinstrumentState.allocateNecessaryBuffers(this, instrument, samplesPerTick);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\t/*\r\n\t\t// JummBox needed to run synth functions for at least one sample (for JIT purposes)\r\n\t\t// before starting audio callbacks to avoid skipping the initial output.\r\n\t\tvar dummyArray = new Float32Array(1);\r\n\t\tthis.synthesize(dummyArray, dummyArray, 1, true);\r\n\t\t*/\r\n\t}\r\n\t\r\n\tprivate static operatorAmplitudeCurve(amplitude: number): number {\r\n\t\treturn (Math.pow(16.0, amplitude / 15.0) - 1.0) / 15.0;\r\n\t}\r\n\t\r\n\tpublic samplesPerSecond: number = 44100;\r\n\tpublic panningDelayBufferSize: number;\r\n\tpublic panningDelayBufferMask: number;\r\n\tpublic chorusDelayBufferSize: number;\r\n\tpublic chorusDelayBufferMask: number;\r\n\t// TODO: reverb\r\n\t\r\n\tpublic song: Song | null = null;\r\n\tpublic preferLowerLatency: boolean = false; // enable when recording performances from keyboard or MIDI. Takes effect next time you activate audio.\r\n\tpublic anticipatePoorPerformance: boolean = false; // enable on mobile devices to reduce audio stutter glitches. Takes effect next time you activate audio.\r\n\tpublic liveInputDuration: number = 0;\r\n\tpublic liveInputStarted: boolean = false;\r\n\tpublic liveInputPitches: number[] = [];\r\n\tpublic liveInputChannel: number = 0;\r\n\tpublic liveInputInstruments: number[] = [];\r\n\tpublic loopRepeatCount: number = -1;\r\n\tpublic volume: number = 1.0;\r\n\tpublic enableMetronome: boolean = false;\r\n\tpublic countInMetronome: boolean = false;\r\n\t\r\n\tprivate playheadInternal: number = 0.0;\r\n\tprivate bar: number = 0;\r\n\tprivate prevBar: number | null = null;\r\n\tprivate nextBar: number | null = null;\r\n\tprivate beat: number = 0;\r\n\tprivate part: number = 0;\r\n\tprivate tick: number = 0;\r\n\tpublic isAtStartOfTick: boolean = true;\r\n\tpublic tickSampleCountdown: number = 0;\r\n\tprivate isPlayingSong: boolean = false;\r\n\tprivate isRecording: boolean = false;\r\n\tprivate liveInputEndTime: number = 0.0;\r\n\tprivate browserAutomaticallyClearsAudioBuffer: boolean = true; // Assume true until proven otherwise. Older Chrome does not clear the buffer so it needs to be cleared manually.\r\n\t\r\n\tpublic static readonly tempFilterStartCoefficients: FilterCoefficients = new FilterCoefficients();\r\n\tpublic static readonly tempFilterEndCoefficients: FilterCoefficients = new FilterCoefficients();\r\n\tprivate tempDrumSetControlPoint: FilterControlPoint = new FilterControlPoint();\r\n\tpublic tempFrequencyResponse: FrequencyResponse = new FrequencyResponse();\r\n\t\r\n\tprivate static readonly fmSynthFunctionCache: Dictionary<Function> = {};\r\n\tprivate static readonly effectsFunctionCache: Function[] = Array(1 << 7).fill(undefined); // keep in sync with the number of post-process effects.\r\n\tprivate static readonly pickedStringFunctionCache: Function[] = Array(3).fill(undefined); // keep in sync with the number of unison voices.\r\n\t\r\n\tprivate readonly channels: ChannelState[] = [];\r\n\tprivate readonly tonePool: Deque<Tone> = new Deque<Tone>();\r\n\tprivate readonly tempMatchedPitchTones: Array<Tone | null> = Array(Config.maxChordSize).fill(null);\r\n\t\r\n\tprivate startedMetronome: boolean = false;\r\n\tprivate metronomeSamplesRemaining: number = -1;\r\n\tprivate metronomeAmplitude: number = 0.0;\r\n\tprivate metronomePrevAmplitude: number = 0.0;\r\n\tprivate metronomeFilter: number = 0.0;\r\n\tprivate limit: number = 0.0;\r\n\t\r\n\tprivate tempMonoInstrumentSampleBuffer: Float32Array | null = null;\r\n\t\r\n\tprivate audioCtx: any | null = null;\r\n\tprivate scriptNode: any | null = null;\r\n\t\r\n\tpublic get playing(): boolean {\r\n\t\treturn this.isPlayingSong;\r\n\t}\r\n\t\r\n\tpublic get recording(): boolean {\r\n\t\treturn this.isRecording;\r\n\t}\r\n\t\r\n\tpublic get playhead(): number {\r\n\t\treturn this.playheadInternal;\r\n\t}\r\n\t\r\n\tpublic set playhead(value: number) {\r\n\t\tif (this.song != null) {\r\n\t\t\tthis.playheadInternal = Math.max(0, Math.min(this.song.barCount, value));\r\n\t\t\tlet remainder: number = this.playheadInternal;\r\n\t\t\tthis.bar = Math.floor(remainder);\r\n\t\t\tremainder = this.song.beatsPerBar * (remainder - this.bar);\r\n\t\t\tthis.beat = Math.floor(remainder);\r\n\t\t\tremainder = Config.partsPerBeat * (remainder - this.beat);\r\n\t\t\tthis.part = Math.floor(remainder);\r\n\t\t\tremainder = Config.ticksPerPart * (remainder - this.part);\r\n\t\t\tthis.tick = Math.floor(remainder);\r\n\t\t\tthis.tickSampleCountdown = 0;\r\n\t\t\tthis.isAtStartOfTick = true;\r\n\t\t\tthis.prevBar = null;\r\n\t\t}\r\n\t}\r\n\t\r\n\tpublic getSamplesPerBar(): number {\r\n\t\tif (this.song == null) throw new Error();\r\n\t\treturn this.getSamplesPerTick() * Config.ticksPerPart * Config.partsPerBeat * this.song.beatsPerBar;\r\n\t}\r\n\t\r\n\tpublic getTicksIntoBar(): number {\r\n\t\treturn (this.beat * Config.partsPerBeat + this.part) * Config.ticksPerPart + this.tick;\r\n\t}\r\n\tpublic getCurrentPart(): number {\r\n\t\treturn (this.beat * Config.partsPerBeat + this.part);\r\n\t}\r\n\t\r\n\tpublic getTotalBars(enableIntro: boolean, enableOutro: boolean): number {\r\n\t\tif (this.song == null) throw new Error();\r\n\t\tlet bars: number = this.song.loopLength * (this.loopRepeatCount + 1);\r\n\t\tif (enableIntro) bars += this.song.loopStart;\r\n\t\tif (enableOutro) bars += this.song.barCount - (this.song.loopStart + this.song.loopLength);\r\n\t\treturn bars;\r\n\t}\r\n\t\r\n\tconstructor(song: Song | string | null = null) {\r\n\t\tthis.computeDelayBufferSizes();\r\n\t\tif (song != null) this.setSong(song);\r\n\t}\r\n\t\r\n\tpublic setSong(song: Song | string): void {\r\n\t\tif (typeof(song) == \"string\") {\r\n\t\t\tthis.song = new Song(song);\r\n\t\t} else if (song instanceof Song) {\r\n\t\t\tthis.song = song;\r\n\t\t}\r\n\t\tthis.prevBar = null;\r\n\t}\r\n\t\r\n\tprivate computeDelayBufferSizes(): void {\r\n\t\tthis.panningDelayBufferSize = Synth.fittingPowerOfTwo(this.samplesPerSecond * Config.panDelaySecondsMax);\r\n\t\tthis.panningDelayBufferMask = this.panningDelayBufferSize - 1;\r\n\t\tthis.chorusDelayBufferSize = Synth.fittingPowerOfTwo(this.samplesPerSecond * Config.chorusMaxDelay);\r\n\t\tthis.chorusDelayBufferMask = this.chorusDelayBufferSize - 1;\r\n\t}\r\n\t\r\n\tprivate activateAudio(): void {\r\n\t\tconst bufferSize: number = this.anticipatePoorPerformance ? (this.preferLowerLatency ? 2048 : 4096) : (this.preferLowerLatency ? 512 : 2048);\r\n\t\tif (this.audioCtx == null || this.scriptNode == null || this.scriptNode.bufferSize != bufferSize) {\r\n\t\t\tif (this.scriptNode != null) this.deactivateAudio();\r\n\t\t\tconst latencyHint: string = this.anticipatePoorPerformance ? (this.preferLowerLatency ? \"balanced\" : \"playback\") : (this.preferLowerLatency ? \"interactive\" : \"balanced\");\r\n\t\t\tthis.audioCtx = this.audioCtx || new (window.AudioContext || window.webkitAudioContext)({latencyHint: latencyHint});\r\n\t\t\tthis.samplesPerSecond = this.audioCtx.sampleRate;\r\n\t\t\tthis.scriptNode = this.audioCtx.createScriptProcessor ? this.audioCtx.createScriptProcessor(bufferSize, 0, 2) : this.audioCtx.createJavaScriptNode(bufferSize, 0, 2); // bufferSize samples per callback buffer, 0 input channels, 2 output channels (left/right)\r\n\t\t\tthis.scriptNode.onaudioprocess = this.audioProcessCallback;\r\n\t\t\tthis.scriptNode.channelCountMode = 'explicit';\r\n\t\t\tthis.scriptNode.channelInterpretation = 'speakers';\r\n\t\t\tthis.scriptNode.connect(this.audioCtx.destination);\r\n\t\t\t\r\n\t\t\tthis.computeDelayBufferSizes();\r\n\t\t}\r\n\t\tthis.audioCtx.resume();\r\n\t}\r\n\t\r\n\tprivate deactivateAudio(): void {\r\n\t\tif (this.audioCtx != null && this.scriptNode != null) {\r\n\t\t\tthis.scriptNode.disconnect(this.audioCtx.destination);\r\n\t\t\tthis.scriptNode = null;\r\n\t\t\tif (this.audioCtx.close) this.audioCtx.close(); // firefox is missing this function?\r\n\t\t\tthis.audioCtx = null;\r\n\t\t}\r\n\t}\r\n\t\r\n\tpublic maintainLiveInput(): void {\r\n\t\tthis.activateAudio();\r\n\t\tthis.liveInputEndTime = performance.now() + 10000.0;\r\n\t}\r\n\t\r\n\tpublic play(): void {\r\n\t\tif (this.isPlayingSong) return;\r\n\t\tthis.isPlayingSong = true;\r\n\t\tthis.warmUpSynthesizer(this.song);\r\n\t\tthis.activateAudio();\r\n\t}\r\n\t\r\n\tpublic pause(): void {\r\n\t\tif (!this.isPlayingSong) return;\r\n\t\tthis.isPlayingSong = false;\r\n\t\tthis.isRecording = false;\r\n\t}\r\n\t\r\n\tpublic startRecording(): void {\r\n\t\tthis.preferLowerLatency = true;\r\n\t\tthis.isRecording = true;\r\n\t\tthis.play();\r\n\t}\r\n\t\r\n\tpublic snapToStart(): void {\r\n\t\tthis.bar = 0;\r\n\t\tthis.snapToBar();\r\n\t}\r\n\t\r\n\tpublic goToBar(bar: number): void {\r\n\t\tthis.bar = bar;\r\n\t\tthis.playheadInternal = this.bar;\r\n\t\tthis.prevBar = null;\r\n\t}\r\n\t\r\n\tpublic snapToBar(): void {\r\n\t\tthis.playheadInternal = this.bar;\r\n\t\tthis.beat = 0;\r\n\t\tthis.part = 0;\r\n\t\tthis.tick = 0;\r\n\t\tthis.tickSampleCountdown = 0;\r\n\t\tthis.isAtStartOfTick = true;\r\n\t\tthis.prevBar = null;\r\n\t}\r\n\t\r\n\tpublic resetEffects(): void {\r\n\t\tthis.limit = 0.0;\r\n\t\tthis.freeAllTones();\r\n\t\tif (this.song != null) {\r\n\t\t\tfor (const channelState of this.channels) {\r\n\t\t\t\tfor (const instrumentState of channelState.instruments) {\r\n\t\t\t\t\tinstrumentState.resetAllEffects();\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\t\r\n\tpublic jumpIntoLoop(): void {\r\n\t\tif (!this.song) return;\r\n\t\tif (this.bar < this.song.loopStart || this.bar >= this.song.loopStart + this.song.loopLength) {\r\n\t\t\tconst oldBar: number = this.bar;\r\n\t\t\tthis.bar = this.song.loopStart;\r\n\t\t\tthis.playheadInternal += this.bar - oldBar;\r\n\t\t\tthis.prevBar = null;\r\n\t\t}\r\n\t}\r\n\t\r\n\tpublic goToNextBar(): void {\r\n\t\tif (!this.song) return;\r\n\t\tthis.prevBar = this.bar;\r\n\t\tconst oldBar: number = this.bar;\r\n\t\tthis.bar++;\r\n\t\tif (this.bar >= this.song.barCount) {\r\n\t\t\tthis.bar = 0;\r\n\t\t}\r\n\t\tthis.playheadInternal += this.bar - oldBar;\r\n\t}\r\n\t\r\n\tpublic goToPrevBar(): void {\r\n\t\tif (!this.song) return;\r\n\t\tthis.prevBar = null;\r\n\t\tconst oldBar: number = this.bar;\r\n\t\tthis.bar--;\r\n\t\tif (this.bar < 0 || this.bar >= this.song.barCount) {\r\n\t\t\tthis.bar = this.song.barCount - 1;\r\n\t\t}\r\n\t\tthis.playheadInternal += this.bar - oldBar;\r\n\t}\r\n\t\r\n\tprivate getNextBar(): number {\r\n\t\tlet nextBar: number = this.bar + 1;\r\n\t\tif (this.isRecording) {\r\n\t\t\tif (nextBar >= this.song!.barCount) {\r\n\t\t\t\tnextBar = this.song!.barCount - 1;\r\n\t\t\t}\r\n\t\t} else if (this.loopRepeatCount != 0 && nextBar == this.song!.loopStart + this.song!.loopLength) {\r\n\t\t\tnextBar = this.song!.loopStart;\r\n\t\t}\r\n\t\treturn nextBar;\r\n\t}\r\n\t\r\n\tprivate audioProcessCallback = (audioProcessingEvent: any): void => {\r\n\t\tconst outputBuffer = audioProcessingEvent.outputBuffer;\r\n\t\tconst outputDataL: Float32Array = outputBuffer.getChannelData(0);\r\n\t\tconst outputDataR: Float32Array = outputBuffer.getChannelData(1);\r\n\t\t\r\n\t\tif (this.browserAutomaticallyClearsAudioBuffer && (outputDataL[0] != 0.0 || outputDataR[0] != 0.0 || outputDataL[outputBuffer.length-1] != 0.0 || outputDataR[outputBuffer.length-1] != 0.0)) {\r\n\t\t\t// If the buffer is ever initially nonzero, then this must be an older browser that doesn't automatically clear the audio buffer.\r\n\t\t\tthis.browserAutomaticallyClearsAudioBuffer = false;\r\n\t\t}\r\n\t\tif (!this.browserAutomaticallyClearsAudioBuffer) {\r\n\t\t\t// If this browser does not clear the buffer automatically, do so manually before continuing.\r\n\t\t\tconst length: number = outputBuffer.length;\r\n\t\t\tfor (let i: number = 0; i < length; i++) {\r\n\t\t\t\toutputDataL[i] = 0.0;\r\n\t\t\t\toutputDataR[i] = 0.0;\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tif (!this.isPlayingSong && performance.now() >= this.liveInputEndTime) {\r\n\t\t\tthis.deactivateAudio();\r\n\t\t} else {\r\n\t\t\tthis.synthesize(outputDataL, outputDataR, outputBuffer.length, this.isPlayingSong);\r\n\t\t}\r\n\t}\r\n\t\r\n\tpublic synthesize(outputDataL: Float32Array, outputDataR: Float32Array, outputBufferLength: number, playSong: boolean = true): void {\r\n\t\tif (this.song == null) {\r\n\t\t\tfor (let i: number = 0; i < outputBufferLength; i++) {\r\n\t\t\t\toutputDataL[i] = 0.0;\r\n\t\t\t\toutputDataR[i] = 0.0;\r\n\t\t\t}\r\n\t\t\tthis.deactivateAudio();\r\n\t\t\treturn;\r\n\t\t}\r\n\t\t\r\n\t\tconst song: Song = this.song;\r\n\t\tconst samplesPerTick: number = this.getSamplesPerTick();\r\n\t\tlet ended: boolean = false;\r\n\t\t\r\n\t\t// Check the bounds of the playhead:\r\n\t\tif (this.tickSampleCountdown <= 0 || this.tickSampleCountdown > samplesPerTick) {\r\n\t\t\tthis.tickSampleCountdown = samplesPerTick;\r\n\t\t\tthis.isAtStartOfTick = true;\r\n\t\t}\r\n\t\tif (playSong) {\r\n\t\t\tif (this.beat >= song.beatsPerBar) {\r\n\t\t\t\tthis.beat = 0;\r\n\t\t\t\tthis.part = 0;\r\n\t\t\t\tthis.tick = 0;\r\n\t\t\t\tthis.tickSampleCountdown = samplesPerTick;\r\n\t\t\t\tthis.isAtStartOfTick = true;\r\n\t\t\t\t\r\n\t\t\t\tthis.prevBar = this.bar;\r\n\t\t\t\tthis.bar = this.getNextBar();\r\n\t\t\t\tif (this.bar <= this.prevBar && this.loopRepeatCount > 0) this.loopRepeatCount--;\r\n\t\t\t}\r\n\t\t\tif (this.bar >= song.barCount) {\r\n\t\t\t\tthis.bar = 0;\r\n\t\t\t\tif (this.loopRepeatCount != -1) {\r\n\t\t\t\t\tended = true;\r\n\t\t\t\t\tthis.pause();\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\t//const synthStartTime: number = performance.now();\r\n\t\t\r\n\t\tthis.syncSongState();\r\n\t\t\r\n\t\tif (this.tempMonoInstrumentSampleBuffer == null || this.tempMonoInstrumentSampleBuffer.length < outputBufferLength) {\r\n\t\t\tthis.tempMonoInstrumentSampleBuffer = new Float32Array(outputBufferLength);\r\n\t\t}\r\n\t\t\r\n\t\t// Post processing parameters:\r\n\t\tconst volume: number = +this.volume;\r\n\t\tconst limitDecay: number = 1.0 - Math.pow(0.5, 4.0 / this.samplesPerSecond);\r\n\t\tconst limitRise: number = 1.0 - Math.pow(0.5, 4000.0 / this.samplesPerSecond);\r\n\t\tlet limit: number = +this.limit;\r\n\t\t\r\n\t\tlet bufferIndex: number = 0;\r\n\t\twhile (bufferIndex < outputBufferLength && !ended) {\r\n\t\t\t\r\n\t\t\tthis.nextBar = this.getNextBar();\r\n\t\t\tif (this.nextBar >= song.barCount) this.nextBar = null;\r\n\t\t\t\r\n\t\t\tconst samplesLeftInBuffer: number = outputBufferLength - bufferIndex;\r\n\t\t\tconst samplesLeftInTick: number = Math.ceil(this.tickSampleCountdown);\r\n\t\t\tconst runLength: number = Math.min(samplesLeftInTick, samplesLeftInBuffer);\r\n\t\t\tconst runEnd: number = bufferIndex + runLength;\r\n\t\t\tfor (let channelIndex: number = 0; channelIndex < song.getChannelCount(); channelIndex++) {\r\n\t\t\t\tconst channel: Channel = song.channels[channelIndex];\r\n\t\t\t\tconst channelState: ChannelState = this.channels[channelIndex];\r\n\t\t\t\t\r\n\t\t\t\tif (this.isAtStartOfTick) {\r\n\t\t\t\t\tthis.determineCurrentActiveTones(song, channelIndex, samplesPerTick, playSong && !this.countInMetronome);\r\n\t\t\t\t\tthis.determineLiveInputTones(song, channelIndex, samplesPerTick);\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tfor (let instrumentIndex: number = 0; instrumentIndex < channel.instruments.length; instrumentIndex++) {\r\n\t\t\t\t\tconst instrument: Instrument = channel.instruments[instrumentIndex];\r\n\t\t\t\t\tconst instrumentState: InstrumentState = channelState.instruments[instrumentIndex];\r\n\t\t\t\t\t\r\n\t\t\t\t\tif (this.isAtStartOfTick) {\r\n\t\t\t\t\t\tlet tonesPlayedInThisInstrument: number = instrumentState.activeTones.count() + instrumentState.liveInputTones.count();\r\n\t\t\t\t\t\tfor (let i: number = 0; i < instrumentState.releasedTones.count(); i++) {\r\n\t\t\t\t\t\t\tconst tone: Tone = instrumentState.releasedTones.get(i);\r\n\t\t\t\t\t\t\tif (tone.ticksSinceReleased >= Math.abs(instrument.getFadeOutTicks())) {\r\n\t\t\t\t\t\t\t\tthis.freeReleasedTone(instrumentState, i);\r\n\t\t\t\t\t\t\t\ti--;\r\n\t\t\t\t\t\t\t\tcontinue;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tconst shouldFadeOutFast: boolean = (tonesPlayedInThisInstrument >= Config.maximumTonesPerChannel);\r\n\t\t\t\t\t\t\tthis.computeTone(song, channelIndex, samplesPerTick, tone, true, shouldFadeOutFast);\r\n\t\t\t\t\t\t\ttonesPlayedInThisInstrument++;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tif (instrumentState.awake) {\r\n\t\t\t\t\t\t\tif (!instrumentState.computed) {\r\n\t\t\t\t\t\t\t\tinstrumentState.compute(this, instrument, samplesPerTick, Math.ceil(samplesPerTick), null);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tinstrumentState.computed = false;\r\n\t\t\t\t\t\t\t//instrumentState.envelopeComputer.clearEnvelopes();\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t\tfor (let i: number = 0; i < instrumentState.activeTones.count(); i++) {\r\n\t\t\t\t\t\tconst tone: Tone = instrumentState.activeTones.get(i);\r\n\t\t\t\t\t\tthis.playTone(channelIndex, bufferIndex, runLength, tone);\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t\tfor (let i: number = 0; i < instrumentState.liveInputTones.count(); i++) {\r\n\t\t\t\t\t\tconst tone: Tone = instrumentState.liveInputTones.get(i);\r\n\t\t\t\t\t\tthis.playTone(channelIndex, bufferIndex, runLength, tone);\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t\tfor (let i: number = 0; i < instrumentState.releasedTones.count(); i++) {\r\n\t\t\t\t\t\tconst tone: Tone = instrumentState.releasedTones.get(i);\r\n\t\t\t\t\t\tthis.playTone(channelIndex, bufferIndex, runLength, tone);\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t\tif (instrumentState.awake) {\r\n\t\t\t\t\t\tSynth.effectsSynth(this, outputDataL, outputDataR, bufferIndex, runLength, instrumentState);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tif (this.enableMetronome || this.countInMetronome) {\r\n\t\t\t\tif (this.part == 0) {\r\n\t\t\t\t\tif (!this.startedMetronome) {\r\n\t\t\t\t\t\tconst midBeat: boolean = (song.beatsPerBar > 4 && (song.beatsPerBar % 2 == 0) && this.beat == song.beatsPerBar / 2);\r\n\t\t\t\t\t\tconst periods:   number = (this.beat == 0) ? 8 : midBeat ? 6 : 4;\r\n\t\t\t\t\t\tconst hz:        number = (this.beat == 0) ? 1600 : midBeat ? 1200 : 800;\r\n\t\t\t\t\t\tconst amplitude: number = (this.beat == 0) ? 0.06 : midBeat ? 0.05 : 0.04;\r\n\t\t\t\t\t\tconst samplesPerPeriod: number = this.samplesPerSecond / hz;\r\n\t\t\t\t\t\tconst radiansPerSample: number = Math.PI * 2.0 / samplesPerPeriod;\r\n\t\t\t\t\t\tthis.metronomeSamplesRemaining = Math.floor(samplesPerPeriod * periods);\r\n\t\t\t\t\t\tthis.metronomeFilter = 2.0 * Math.cos(radiansPerSample);\r\n\t\t\t\t\t\tthis.metronomeAmplitude = amplitude * Math.sin(radiansPerSample);\r\n\t\t\t\t\t\tthis.metronomePrevAmplitude = 0.0;\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tthis.startedMetronome = true;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (this.metronomeSamplesRemaining > 0) {\r\n\t\t\t\t\t\tconst stopIndex: number = Math.min(runEnd, bufferIndex + this.metronomeSamplesRemaining);\r\n\t\t\t\t\t\tthis.metronomeSamplesRemaining -= stopIndex - bufferIndex;\r\n\t\t\t\t\t\tfor (let i: number = bufferIndex; i < stopIndex; i++) {\r\n\t\t\t\t\t\t\toutputDataL[i] += this.metronomeAmplitude;\r\n\t\t\t\t\t\t\toutputDataR[i] += this.metronomeAmplitude;\r\n\t\t\t\t\t\t\tconst tempAmplitude: number = this.metronomeFilter * this.metronomeAmplitude - this.metronomePrevAmplitude;\r\n\t\t\t\t\t\t\tthis.metronomePrevAmplitude = this.metronomeAmplitude;\r\n\t\t\t\t\t\t\tthis.metronomeAmplitude = tempAmplitude;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis.startedMetronome = false;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t// Post processing:\r\n\t\t\tfor (let i: number = bufferIndex; i < runEnd; i++) {\r\n\t\t\t\t// A compressor/limiter.\r\n\t\t\t\tconst sampleL = outputDataL[i];\r\n\t\t\t\tconst sampleR = outputDataR[i];\r\n\t\t\t\tconst abs: number = Math.max(Math.abs(sampleL), Math.abs(sampleR));\r\n\t\t\t\tlimit += (abs - limit) * (limit < abs ? limitRise : limitDecay * (1.0 + limit));\r\n\t\t\t\tconst limitedVolume = volume / (limit >= 1 ? limit * 1.05 : limit * 0.8 + 0.25);\r\n\t\t\t\toutputDataL[i] = sampleL * limitedVolume;\r\n\t\t\t\toutputDataR[i] = sampleR * limitedVolume;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tbufferIndex += runLength;\r\n\t\t\t\r\n\t\t\tthis.isAtStartOfTick = false;\r\n\t\t\tthis.tickSampleCountdown -= runLength;\r\n\t\t\tif (this.tickSampleCountdown <= 0) {\r\n\t\t\t\tthis.isAtStartOfTick = true;\r\n\t\t\t\t\r\n\t\t\t\t// Track how long tones have been released, and free ones that are marked as ending.\r\n\t\t\t\t// Also reset awake InstrumentStates that didn't have any Tones during this tick.\r\n\t\t\t\tfor (const channelState of this.channels) {\r\n\t\t\t\t\tfor (const instrumentState of channelState.instruments) {\r\n\t\t\t\t\t\tfor (let i: number = 0; i < instrumentState.releasedTones.count(); i++) {\r\n\t\t\t\t\t\t\tconst tone: Tone = instrumentState.releasedTones.get(i);\r\n\t\t\t\t\t\t\tif (tone.isOnLastTick) {\r\n\t\t\t\t\t\t\t\tthis.freeReleasedTone(instrumentState, i);\r\n\t\t\t\t\t\t\t\ti--;\r\n\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\ttone.ticksSinceReleased++;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif (instrumentState.deactivateAfterThisTick) {\r\n\t\t\t\t\t\t\tinstrumentState.deactivate();\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tinstrumentState.tonesAddedInThisTick = false;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tthis.tick++;\r\n\t\t\t\tthis.tickSampleCountdown += samplesPerTick;\r\n\t\t\t\tif (this.tick == Config.ticksPerPart) {\r\n\t\t\t\t\tthis.tick = 0;\r\n\t\t\t\t\tthis.part++;\r\n\t\t\t\t\tthis.liveInputDuration--;\r\n\t\t\t\t\t\r\n\t\t\t\t\tif (this.part == Config.partsPerBeat) {\r\n\t\t\t\t\t\tthis.part = 0;\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tif (playSong) {\r\n\t\t\t\t\t\t\tthis.beat++;\r\n\t\t\t\t\t\t\tif (this.beat == song.beatsPerBar) {\r\n\t\t\t\t\t\t\t\t// bar changed, reset for next bar:\r\n\t\t\t\t\t\t\t\tthis.beat = 0;\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tif (this.countInMetronome) {\r\n\t\t\t\t\t\t\t\t\tthis.countInMetronome = false;\r\n\t\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\t\tthis.prevBar = this.bar;\r\n\t\t\t\t\t\t\t\t\tthis.bar = this.getNextBar();\r\n\t\t\t\t\t\t\t\t\tif (this.bar <= this.prevBar && this.loopRepeatCount > 0) this.loopRepeatCount--;\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tif (this.bar >= song.barCount) {\r\n\t\t\t\t\t\t\t\t\t\tthis.bar = 0;\r\n\t\t\t\t\t\t\t\t\t\tif (this.loopRepeatCount != -1) {\r\n\t\t\t\t\t\t\t\t\t\t\tended = true;\r\n\t\t\t\t\t\t\t\t\t\t\tthis.resetEffects();\r\n\t\t\t\t\t\t\t\t\t\t\tthis.pause();\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\t// Avoid persistent denormal or NaN values.\r\n\t\tif (!Number.isFinite(limit) || Math.abs(limit) < epsilon) limit = 0.0;\r\n\t\tthis.limit = limit;\r\n\t\t\r\n\t\tif (playSong && !this.countInMetronome) {\r\n\t\t\tthis.playheadInternal = (((this.tick + 1.0 - this.tickSampleCountdown / samplesPerTick) / 2.0 + this.part) / Config.partsPerBeat + this.beat) / song.beatsPerBar + this.bar;\r\n\t\t}\r\n\t\t\r\n\t\t/*\r\n\t\tconst synthDuration: number = performance.now() - synthStartTime;\r\n\t\t// Performance measurements:\r\n\t\tsamplesAccumulated += outputBufferLength;\r\n\t\tsamplePerformance += synthDuration;\r\n\t\t\r\n\t\tif (samplesAccumulated >= 44100 * 4) {\r\n\t\t\tconst secondsGenerated = samplesAccumulated / 44100;\r\n\t\t\tconst secondsRequired = samplePerformance / 1000;\r\n\t\t\tconst ratio = secondsRequired / secondsGenerated;\r\n\t\t\tconsole.log(ratio);\r\n\t\t\tsamplePerformance = 0;\r\n\t\t\tsamplesAccumulated = 0;\r\n\t\t}\r\n\t\t*/\r\n\t}\r\n\t\r\n\tprivate freeTone(tone: Tone): void {\r\n\t\tthis.tonePool.pushBack(tone);\r\n\t}\r\n\t\r\n\tprivate newTone(): Tone {\r\n\t\tif (this.tonePool.count() > 0) {\r\n\t\t\tconst tone: Tone = this.tonePool.popBack();\r\n\t\t\ttone.freshlyAllocated = true;\r\n\t\t\treturn tone;\r\n\t\t}\r\n\t\treturn new Tone();\r\n\t}\r\n\t\r\n\tprivate releaseTone(instrumentState: InstrumentState, tone: Tone): void {\r\n\t\tinstrumentState.releasedTones.pushFront(tone);\r\n\t\ttone.atNoteStart = false;\r\n\t\ttone.passedEndOfNote = true;\r\n\t}\r\n\t\r\n\tprivate freeReleasedTone(instrumentState: InstrumentState, toneIndex: number): void {\r\n\t\tthis.freeTone(instrumentState.releasedTones.get(toneIndex));\r\n\t\tinstrumentState.releasedTones.remove(toneIndex);\r\n\t}\r\n\t\r\n\tpublic freeAllTones(): void {\r\n\t\tfor (const channelState of this.channels) {\r\n\t\t\tfor (const instrumentState of channelState.instruments) {\r\n\t\t\t\twhile (instrumentState.activeTones.count()    > 0) this.freeTone(instrumentState.activeTones.popBack());\r\n\t\t\t\twhile (instrumentState.releasedTones.count()  > 0) this.freeTone(instrumentState.releasedTones.popBack());\r\n\t\t\t\twhile (instrumentState.liveInputTones.count() > 0) this.freeTone(instrumentState.liveInputTones.popBack());\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\t\r\n\tprivate determineLiveInputTones(song: Song, channelIndex: number, samplesPerTick: number): void {\r\n\t\tconst channel: Channel = song.channels[channelIndex];\r\n\t\tconst channelState: ChannelState = this.channels[channelIndex];\r\n\t\tconst pitches: number[] = this.liveInputPitches;\r\n\t\t\r\n\t\tfor (let instrumentIndex: number = 0; instrumentIndex < channel.instruments.length; instrumentIndex++) {\r\n\t\t\tconst instrumentState: InstrumentState = channelState.instruments[instrumentIndex];\r\n\t\t\tconst toneList: Deque<Tone> = instrumentState.liveInputTones;\r\n\t\t\tlet toneCount: number = 0;\r\n\t\t\tif (this.liveInputDuration > 0 && channelIndex == this.liveInputChannel && pitches.length > 0 && this.liveInputInstruments.indexOf(instrumentIndex) != -1) {\r\n\t\t\t\tconst instrument: Instrument = channel.instruments[instrumentIndex];\r\n\t\t\t\t\r\n\t\t\t\tif (instrument.getChord().singleTone) {\r\n\t\t\t\t\tlet tone: Tone;\r\n\t\t\t\t\tif (toneList.count() <= toneCount) {\r\n\t\t\t\t\t\ttone = this.newTone();\r\n\t\t\t\t\t\ttoneList.pushBack(tone);\r\n\t\t\t\t\t} else if (!instrument.getTransition().isSeamless && this.liveInputStarted) {\r\n\t\t\t\t\t\tthis.releaseTone(instrumentState, toneList.get(toneCount));\r\n\t\t\t\t\t\ttone = this.newTone();\r\n\t\t\t\t\t\ttoneList.set(toneCount, tone);\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\ttone = toneList.get(toneCount);\r\n\t\t\t\t\t}\r\n\t\t\t\t\ttoneCount++;\r\n\t\t\t\t\t\r\n\t\t\t\t\tfor (let i: number = 0; i < pitches.length; i++) {\r\n\t\t\t\t\t\ttone.pitches[i] = pitches[i];\r\n\t\t\t\t\t}\r\n\t\t\t\t\ttone.pitchCount = pitches.length;\r\n\t\t\t\t\ttone.chordSize = 1;\r\n\t\t\t\t\ttone.instrumentIndex = instrumentIndex;\r\n\t\t\t\t\ttone.note = tone.prevNote = tone.nextNote = null;\r\n\t\t\t\t\ttone.atNoteStart = this.liveInputStarted;\r\n\t\t\t\t\ttone.forceContinueAtStart = false;\r\n\t\t\t\t\ttone.forceContinueAtEnd = false;\r\n\t\t\t\t\tthis.computeTone(song, channelIndex, samplesPerTick, tone, false, false);\r\n\t\t\t\t} else {\r\n\t\t\t\t\t//const transition: Transition = instrument.getTransition();\r\n\t\t\t\t\t\r\n\t\t\t\t\tthis.moveTonesIntoOrderedTempMatchedList(toneList, pitches);\r\n\t\t\t\t\t\r\n\t\t\t\t\tfor (let i: number = 0; i < pitches.length; i++) {\r\n\t\t\t\t\t\t//const strumOffsetParts: number = i * instrument.getChord().strumParts;\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tlet tone: Tone;\r\n\t\t\t\t\t\tif (this.tempMatchedPitchTones[toneCount] != null) {\r\n\t\t\t\t\t\t\ttone = this.tempMatchedPitchTones[toneCount]!;\r\n\t\t\t\t\t\t\tthis.tempMatchedPitchTones[toneCount] = null;\r\n\t\t\t\t\t\t\tif (tone.pitchCount != 1 || tone.pitches[0] != pitches[i]) {\r\n\t\t\t\t\t\t\t\tthis.releaseTone(instrumentState, tone);\r\n\t\t\t\t\t\t\t\ttone = this.newTone();\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\ttoneList.pushBack(tone);\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\ttone = this.newTone();\r\n\t\t\t\t\t\t\ttoneList.pushBack(tone);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\ttoneCount++;\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\ttone.pitches[0] = pitches[i];\r\n\t\t\t\t\t\ttone.pitchCount = 1;\r\n\t\t\t\t\t\ttone.chordSize = pitches.length;\r\n\t\t\t\t\t\ttone.instrumentIndex = instrumentIndex;\r\n\t\t\t\t\t\ttone.note = tone.prevNote = tone.nextNote = null;\r\n\t\t\t\t\t\ttone.atNoteStart = this.liveInputStarted;\r\n\t\t\t\t\t\ttone.forceContinueAtStart = false;\r\n\t\t\t\t\t\ttone.forceContinueAtEnd = false;\r\n\t\t\t\t\t\tthis.computeTone(song, channelIndex, samplesPerTick, tone, false, false);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\twhile (toneList.count() > toneCount) {\r\n\t\t\t\tthis.releaseTone(instrumentState, toneList.popBack());\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tthis.clearTempMatchedPitchTones(toneCount, instrumentState);\r\n\t\t}\r\n\t\t\r\n\t\tthis.liveInputStarted = false;\r\n\t}\r\n\t\r\n\t// Returns the chord type of the instrument in the adjacent pattern if it is compatible for a\r\n\t// seamless transition across patterns, otherwise returns null.\r\n\tprivate adjacentPatternHasCompatibleInstrumentTransition(song: Song, channel: Channel, pattern: Pattern, otherPattern: Pattern, instrumentIndex: number, transition: Transition, chord: Chord, note: Note, otherNote: Note, forceContinue: boolean): Chord | null {\r\n\t\tif (song.patternInstruments && otherPattern.instruments.indexOf(instrumentIndex) == -1) {\r\n\t\t\t// The adjacent pattern does not contain the same instrument as the current pattern.\r\n\t\t\t\r\n\t\t\tif (pattern.instruments.length > 1 || otherPattern.instruments.length > 1) {\r\n\t\t\t\t// The current or adjacent pattern contains more than one instrument, don't bother\r\n\t\t\t\t// trying to connect them.\r\n\t\t\t\treturn null;\r\n\t\t\t}\r\n\t\t\t// Otherwise, the two patterns each contain one instrument, but not the same instrument.\r\n\t\t\t// Try to connect them.\r\n\t\t\tconst otherInstrument: Instrument = channel.instruments[otherPattern.instruments[0]];\r\n\t\t\t\r\n\t\t\tif (forceContinue) {\r\n\t\t\t\t// Even non-seamless instruments can be connected across patterns if forced.\r\n\t\t\t\treturn otherInstrument.getChord();\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t// Otherwise, check that both instruments are seamless across patterns.\r\n\t\t\tconst otherTransition: Transition = otherInstrument.getTransition();\r\n\t\t\tif (transition.includeAdjacentPatterns && otherTransition.includeAdjacentPatterns && otherTransition.slides == transition.slides) {\r\n\t\t\t\treturn otherInstrument.getChord();\r\n\t\t\t} else {\r\n\t\t\t\treturn null;\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\t// If both patterns contain the same instrument, check that it is seamless across patterns.\r\n\t\t\treturn (forceContinue || transition.includeAdjacentPatterns) ? chord : null;\r\n\t\t}\r\n\t}\r\n\t\r\n\tpublic static adjacentNotesHaveMatchingPitches(firstNote: Note, secondNote: Note): boolean {\r\n\t\tif (firstNote.pitches.length != secondNote.pitches.length) return false;\r\n\t\tconst firstNoteInterval: number = firstNote.pins[firstNote.pins.length - 1].interval;\r\n\t\tfor (const pitch of firstNote.pitches) {\r\n\t\t\tif (secondNote.pitches.indexOf(pitch + firstNoteInterval) == -1) return false;\r\n\t\t}\r\n\t\treturn true;\r\n\t}\r\n\r\n\tprivate moveTonesIntoOrderedTempMatchedList(toneList: Deque<Tone>, notePitches: number[]): void {\r\n\t\t// The tones are about to seamlessly transition to a new note. The pitches\r\n\t\t// from the old note may or may not match any of the pitches in the new\r\n\t\t// note, and not necessarily in order, but if any do match, they'll sound\r\n\t\t// better if those tones continue to have the same pitch. Attempt to find\r\n\t\t// the right spot for each old tone in the new chord if possible.\r\n\t\t\r\n\t\tfor (let i: number = 0; i < toneList.count(); i++) {\r\n\t\t\tconst tone: Tone = toneList.get(i);\r\n\t\t\tconst pitch: number = tone.pitches[0] + tone.lastInterval;\r\n\t\t\tfor (let j: number = 0; j < notePitches.length; j++) {\r\n\t\t\t\tif (notePitches[j] == pitch) {\r\n\t\t\t\t\tthis.tempMatchedPitchTones[j] = tone;\r\n\t\t\t\t\ttoneList.remove(i);\r\n\t\t\t\t\ti--;\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\t// Any tones that didn't get matched should just fill in the gaps.\r\n\t\twhile (toneList.count() > 0) {\r\n\t\t\tconst tone: Tone = toneList.popFront();\r\n\t\t\tfor (let j: number = 0; j < this.tempMatchedPitchTones.length; j++) {\r\n\t\t\t\tif (this.tempMatchedPitchTones[j] == null) {\r\n\t\t\t\t\tthis.tempMatchedPitchTones[j] = tone;\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\t\r\n\tprivate determineCurrentActiveTones(song: Song, channelIndex: number, samplesPerTick: number, playSong: boolean): void {\r\n\t\tconst channel: Channel = song.channels[channelIndex];\r\n\t\tconst channelState: ChannelState = this.channels[channelIndex];\r\n\t\tconst pattern: Pattern | null = song.getPattern(channelIndex, this.bar);\r\n\t\tconst currentPart: number = this.getCurrentPart();\r\n\t\tconst currentTick: number = this.tick + Config.ticksPerPart * currentPart;\r\n\t\tlet note: Note | null = null;\r\n\t\tlet prevNote: Note | null = null;\r\n\t\tlet nextNote: Note | null = null;\r\n\t\t\r\n\t\tif (playSong && pattern != null && !channel.muted && (!this.isRecording || this.liveInputChannel != channelIndex)) {\r\n\t\t\tfor (let i: number = 0; i < pattern.notes.length; i++) {\r\n\t\t\t\tif (pattern.notes[i].end <= currentPart) {\r\n\t\t\t\t\tprevNote = pattern.notes[i];\r\n\t\t\t\t} else if (pattern.notes[i].start <= currentPart && pattern.notes[i].end > currentPart) {\r\n\t\t\t\t\tnote = pattern.notes[i];\r\n\t\t\t\t} else if (pattern.notes[i].start > currentPart) {\r\n\t\t\t\t\tnextNote = pattern.notes[i];\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tif (note != null) {\r\n\t\t\t\tif (prevNote != null && prevNote.end != note.start) prevNote = null;\r\n\t\t\t\tif (nextNote != null && nextNote.start != note.end) nextNote = null;\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\t// Seamless tones from a pattern with a single instrument can be transferred to a different single seamless instrument in the next pattern.\r\n\t\tif (pattern != null && (!song.layeredInstruments || channel.instruments.length == 1 || (song.patternInstruments && pattern.instruments.length == 1))) {\r\n\t\t\tconst newInstrumentIndex: number = song.patternInstruments ? pattern.instruments[0] : 0;\r\n\t\t\tif (channelState.singleSeamlessInstrument != null && channelState.singleSeamlessInstrument != newInstrumentIndex && channelState.singleSeamlessInstrument < channelState.instruments.length) {\r\n\t\t\t\tconst sourceInstrumentState: InstrumentState = channelState.instruments[channelState.singleSeamlessInstrument];\r\n\t\t\t\tconst destInstrumentState: InstrumentState = channelState.instruments[newInstrumentIndex];\r\n\t\t\t\twhile (sourceInstrumentState.activeTones.count() > 0) {\r\n\t\t\t\t\tdestInstrumentState.activeTones.pushFront(sourceInstrumentState.activeTones.popBack());\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tchannelState.singleSeamlessInstrument = newInstrumentIndex;\r\n\t\t} else {\r\n\t\t\tchannelState.singleSeamlessInstrument = null;\r\n\t\t}\r\n\t\t\r\n\t\tfor (let instrumentIndex: number = 0; instrumentIndex < channel.instruments.length; instrumentIndex++) {\r\n\t\t\tconst instrumentState: InstrumentState = channelState.instruments[instrumentIndex];\r\n\t\t\tconst toneList: Deque<Tone> = instrumentState.activeTones;\r\n\t\t\tlet toneCount: number = 0;\r\n\t\t\tif ((note != null) && (!song.patternInstruments || (pattern!.instruments.indexOf(instrumentIndex) != -1))) {\r\n\t\t\t\tconst instrument: Instrument = channel.instruments[instrumentIndex];\r\n\t\t\t\tlet prevNoteForThisInstrument: Note | null = prevNote;\r\n\t\t\t\tlet nextNoteForThisInstrument: Note | null = nextNote;\r\n\t\t\t\t\r\n\t\t\t\tconst partsPerBar: Number = Config.partsPerBeat * song.beatsPerBar;\r\n\t\t\t\tconst transition: Transition = instrument.getTransition();\r\n\t\t\t\tconst chord: Chord = instrument.getChord();\r\n\t\t\t\tlet forceContinueAtStart: boolean = false;\r\n\t\t\t\tlet forceContinueAtEnd: boolean = false;\r\n\t\t\t\tlet tonesInPrevNote: number = 0;\r\n\t\t\t\tlet tonesInNextNote: number = 0;\r\n\t\t\t\tif (note.start == 0) {\r\n\t\t\t\t\t// If the beginning of the note coincides with the beginning of the pattern,\r\n\t\t\t\t\t// look for an adjacent note at the end of the previous pattern.\r\n\t\t\t\t\tlet prevPattern: Pattern | null = (this.prevBar == null) ? null : song.getPattern(channelIndex, this.prevBar);\r\n\t\t\t\t\tif (prevPattern != null) {\r\n\t\t\t\t\t\tconst lastNote: Note | null = (prevPattern.notes.length <= 0) ? null : prevPattern.notes[prevPattern.notes.length - 1];\r\n\t\t\t\t\t\tif (lastNote != null && lastNote.end == partsPerBar) {\r\n\t\t\t\t\t\t\tconst patternForcesContinueAtStart: boolean = note.continuesLastPattern && Synth.adjacentNotesHaveMatchingPitches(lastNote, note);\r\n\t\t\t\t\t\t\tconst chordOfCompatibleInstrument: Chord | null = this.adjacentPatternHasCompatibleInstrumentTransition(song, channel, pattern!, prevPattern, instrumentIndex, transition, chord, note, lastNote, patternForcesContinueAtStart);\r\n\t\t\t\t\t\t\tif (chordOfCompatibleInstrument != null) {\r\n\t\t\t\t\t\t\t\tprevNoteForThisInstrument = lastNote;\r\n\t\t\t\t\t\t\t\ttonesInPrevNote = chordOfCompatibleInstrument.singleTone ? 1 : prevNoteForThisInstrument.pitches.length\r\n\t\t\t\t\t\t\t\tforceContinueAtStart = patternForcesContinueAtStart;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t} else if (prevNoteForThisInstrument != null) {\r\n\t\t\t\t\ttonesInPrevNote = chord.singleTone ? 1 : prevNoteForThisInstrument.pitches.length\r\n\t\t\t\t}\r\n\t\t\t\tif (note.end == partsPerBar) {\r\n\t\t\t\t\t// If the end of the note coincides with the end of the pattern, look for an\r\n\t\t\t\t\t// adjacent note at the beginning of the next pattern.\r\n\t\t\t\t\tlet nextPattern: Pattern | null = (this.nextBar == null) ? null : song.getPattern(channelIndex, this.nextBar);\r\n\t\t\t\t\tif (nextPattern != null) {\r\n\t\t\t\t\t\tconst firstNote: Note | null = (nextPattern.notes.length <= 0) ? null : nextPattern.notes[0];\r\n\t\t\t\t\t\tif (firstNote != null && firstNote.start == 0) {\r\n\t\t\t\t\t\t\tconst nextPatternForcesContinueAtStart: boolean = firstNote.continuesLastPattern && Synth.adjacentNotesHaveMatchingPitches(note, firstNote);\r\n\t\t\t\t\t\t\tconst chordOfCompatibleInstrument: Chord | null = this.adjacentPatternHasCompatibleInstrumentTransition(song, channel, pattern!, nextPattern, instrumentIndex, transition, chord, note, firstNote, nextPatternForcesContinueAtStart);\r\n\t\t\t\t\t\t\tif (chordOfCompatibleInstrument != null) {\r\n\t\t\t\t\t\t\t\tnextNoteForThisInstrument = firstNote;\r\n\t\t\t\t\t\t\t\ttonesInNextNote = chordOfCompatibleInstrument.singleTone ? 1 : nextNoteForThisInstrument.pitches.length\r\n\t\t\t\t\t\t\t\tforceContinueAtEnd = nextPatternForcesContinueAtStart;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t} else if (nextNoteForThisInstrument != null) {\r\n\t\t\t\t\ttonesInNextNote = chord.singleTone ? 1 : nextNoteForThisInstrument.pitches.length\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tif (chord.singleTone) {\r\n\t\t\t\t\tconst atNoteStart: boolean = (Config.ticksPerPart * note.start == currentTick);\r\n\t\t\t\t\tlet tone: Tone;\r\n\t\t\t\t\tif (toneList.count() <= toneCount) {\r\n\t\t\t\t\t\ttone = this.newTone();\r\n\t\t\t\t\t\ttoneList.pushBack(tone);\r\n\t\t\t\t\t} else if (atNoteStart && ((!transition.isSeamless && !forceContinueAtStart) || prevNoteForThisInstrument == null)) {\r\n\t\t\t\t\t\tconst oldTone: Tone = toneList.get(toneCount);\r\n\t\t\t\t\t\tif (oldTone.isOnLastTick) {\r\n\t\t\t\t\t\t\tthis.freeTone(oldTone);\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\tthis.releaseTone(instrumentState, oldTone);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\ttone = this.newTone();\r\n\t\t\t\t\t\ttoneList.set(toneCount, tone);\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\ttone = toneList.get(toneCount);\r\n\t\t\t\t\t}\r\n\t\t\t\t\ttoneCount++;\r\n\t\t\t\t\t\r\n\t\t\t\t\tfor (let i: number = 0; i < note.pitches.length; i++) {\r\n\t\t\t\t\t\ttone.pitches[i] = note.pitches[i];\r\n\t\t\t\t\t}\r\n\t\t\t\t\ttone.pitchCount = note.pitches.length;\r\n\t\t\t\t\ttone.chordSize = 1;\r\n\t\t\t\t\ttone.instrumentIndex = instrumentIndex;\r\n\t\t\t\t\ttone.note = note;\r\n\t\t\t\t\ttone.noteStartPart = note.start;\r\n\t\t\t\t\ttone.noteEndPart = note.end;\r\n\t\t\t\t\ttone.prevNote = prevNoteForThisInstrument;\r\n\t\t\t\t\ttone.nextNote = nextNoteForThisInstrument;\r\n\t\t\t\t\ttone.prevNotePitchIndex = 0;\r\n\t\t\t\t\ttone.nextNotePitchIndex = 0;\r\n\t\t\t\t\ttone.atNoteStart = atNoteStart;\r\n\t\t\t\t\ttone.passedEndOfNote = false;\r\n\t\t\t\t\ttone.forceContinueAtStart = forceContinueAtStart;\r\n\t\t\t\t\ttone.forceContinueAtEnd = forceContinueAtEnd;\r\n\t\t\t\t\tthis.computeTone(song, channelIndex, samplesPerTick, tone, false, false);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tconst transition: Transition = instrument.getTransition();\r\n\t\t\t\t\t\r\n\t\t\t\t\tif (((transition.isSeamless && !transition.slides && chord.strumParts == 0) || forceContinueAtStart) && (Config.ticksPerPart * note.start == currentTick) && prevNoteForThisInstrument != null) {\r\n\t\t\t\t\t\tthis.moveTonesIntoOrderedTempMatchedList(toneList, note.pitches);\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t\tlet strumOffsetParts: number = 0;\r\n\t\t\t\t\tfor (let i: number = 0; i < note.pitches.length; i++) {\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tlet prevNoteForThisTone: Note | null = (tonesInPrevNote > i) ? prevNoteForThisInstrument : null;\r\n\t\t\t\t\t\tlet noteForThisTone: Note = note;\r\n\t\t\t\t\t\tlet nextNoteForThisTone: Note | null = (tonesInNextNote > i) ? nextNoteForThisInstrument : null;\r\n\t\t\t\t\t\tlet noteStartPart: number = noteForThisTone.start + strumOffsetParts;\r\n\t\t\t\t\t\tlet passedEndOfNote: boolean = false;\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t// Strumming may mean that a note's actual start time may be after the\r\n\t\t\t\t\t\t// note's displayed start time. If the note start hasn't been reached yet,\r\n\t\t\t\t\t\t// carry over the previous tone if available and seamless, otherwise skip\r\n\t\t\t\t\t\t// the new tone until it is ready to start.\r\n\t\t\t\t\t\tif (noteStartPart > currentPart) {\r\n\t\t\t\t\t\t\tif (toneList.count() > i && (transition.isSeamless || forceContinueAtStart) && prevNoteForThisTone != null) {\r\n\t\t\t\t\t\t\t\t// Continue the previous note's chord until the current one takes over.\r\n\t\t\t\t\t\t\t\tnextNoteForThisTone = noteForThisTone;\r\n\t\t\t\t\t\t\t\tnoteForThisTone = prevNoteForThisTone;\r\n\t\t\t\t\t\t\t\tprevNoteForThisTone = null;\r\n\t\t\t\t\t\t\t\tnoteStartPart = noteForThisTone.start + strumOffsetParts;\r\n\t\t\t\t\t\t\t\tpassedEndOfNote = true;\r\n\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\t// This and the rest of the tones in the chord shouldn't start yet.\r\n\t\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tlet noteEndPart: number = noteForThisTone.end;\r\n\t\t\t\t\t\tif ((transition.isSeamless || forceContinueAtStart) && nextNoteForThisTone != null) {\r\n\t\t\t\t\t\t\tnoteEndPart = Math.min(Config.partsPerBeat * this.song!.beatsPerBar, noteEndPart + strumOffsetParts);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif ((!transition.continues && !forceContinueAtStart) || prevNoteForThisTone == null) {\r\n\t\t\t\t\t\t\tstrumOffsetParts += chord.strumParts;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tconst atNoteStart: boolean = (Config.ticksPerPart * noteStartPart == currentTick);\r\n\t\t\t\t\t\tlet tone: Tone;\r\n\t\t\t\t\t\tif (this.tempMatchedPitchTones[toneCount] != null) {\r\n\t\t\t\t\t\t\ttone = this.tempMatchedPitchTones[toneCount]!;\r\n\t\t\t\t\t\t\tthis.tempMatchedPitchTones[toneCount] = null;\r\n\t\t\t\t\t\t\ttoneList.pushBack(tone);\r\n\t\t\t\t\t\t} else if (toneList.count() <= toneCount) {\r\n\t\t\t\t\t\t\ttone = this.newTone();\r\n\t\t\t\t\t\t\ttoneList.pushBack(tone);\r\n\t\t\t\t\t\t} else if (atNoteStart && ((!transition.isSeamless && !forceContinueAtStart) || prevNoteForThisTone == null)) {\r\n\t\t\t\t\t\t\tconst oldTone: Tone = toneList.get(toneCount);\r\n\t\t\t\t\t\t\tif (oldTone.isOnLastTick) {\r\n\t\t\t\t\t\t\t\tthis.freeTone(oldTone);\r\n\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\tthis.releaseTone(instrumentState, oldTone);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\ttone = this.newTone();\r\n\t\t\t\t\t\t\ttoneList.set(toneCount, tone);\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\ttone = toneList.get(toneCount);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\ttoneCount++;\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\ttone.pitches[0] = noteForThisTone.pitches[i];\r\n\t\t\t\t\t\ttone.pitchCount = 1;\r\n\t\t\t\t\t\ttone.chordSize = noteForThisTone.pitches.length;\r\n\t\t\t\t\t\ttone.instrumentIndex = instrumentIndex;\r\n\t\t\t\t\t\ttone.note = noteForThisTone;\r\n\t\t\t\t\t\ttone.noteStartPart = noteStartPart;\r\n\t\t\t\t\t\ttone.noteEndPart = noteEndPart;\r\n\t\t\t\t\t\ttone.prevNote = prevNoteForThisTone;\r\n\t\t\t\t\t\ttone.nextNote = nextNoteForThisTone;\r\n\t\t\t\t\t\ttone.prevNotePitchIndex = i;\r\n\t\t\t\t\t\ttone.nextNotePitchIndex = i;\r\n\t\t\t\t\t\ttone.atNoteStart = atNoteStart;\r\n\t\t\t\t\t\ttone.passedEndOfNote = passedEndOfNote;\r\n\t\t\t\t\t\ttone.forceContinueAtStart = forceContinueAtStart && prevNoteForThisTone != null;\r\n\t\t\t\t\t\ttone.forceContinueAtEnd = forceContinueAtEnd && nextNoteForThisTone != null;\r\n\t\t\t\t\t\tthis.computeTone(song, channelIndex, samplesPerTick, tone, false, false);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t// Automatically free or release seamless tones if there's no new note to take over.\r\n\t\t\twhile (toneList.count() > toneCount) {\r\n\t\t\t\tconst tone: Tone = toneList.popBack();\r\n\t\t\t\tconst channel: Channel = song.channels[channelIndex];\r\n\t\t\t\tif (tone.instrumentIndex < channel.instruments.length && !tone.isOnLastTick) {\r\n\t\t\t\t\tconst instrumentState: InstrumentState = channelState.instruments[tone.instrumentIndex];\r\n\t\t\t\t\tthis.releaseTone(instrumentState, tone);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis.freeTone(tone);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tthis.clearTempMatchedPitchTones(toneCount, instrumentState);\r\n\t\t}\r\n\t}\r\n\t\r\n\tprivate clearTempMatchedPitchTones(toneCount: number, instrumentState: InstrumentState): void {\r\n\t\tfor (let i: number = toneCount; i < this.tempMatchedPitchTones.length; i++) {\r\n\t\t\tconst oldTone: Tone | null = this.tempMatchedPitchTones[i];\r\n\t\t\tif (oldTone != null) {\r\n\t\t\t\tif (oldTone.isOnLastTick) {\r\n\t\t\t\t\tthis.freeTone(oldTone);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis.releaseTone(instrumentState, oldTone);\r\n\t\t\t\t}\r\n\t\t\t\tthis.tempMatchedPitchTones[i] = null;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\t\r\n\tprivate playTone(channelIndex: number, bufferIndex: number, runLength: number, tone: Tone): void {\r\n\t\tconst channelState: ChannelState = this.channels[channelIndex];\r\n\t\tconst instrumentState: InstrumentState = channelState.instruments[tone.instrumentIndex];\r\n\t\t\r\n\t\tinstrumentState.synthesizer!(this, bufferIndex, runLength, tone, instrumentState);\r\n\t\ttone.envelopeComputer.clearEnvelopes();\r\n\t}\r\n\t\r\n\tprivate static computeChordExpression(chordSize: number): number {\r\n\t\treturn 1.0 / ((chordSize - 1) * 0.25 + 1.0);\r\n\t}\r\n\t\r\n\tprivate computeTone(song: Song, channelIndex: number, samplesPerTick: number, tone: Tone, released: boolean, shouldFadeOutFast: boolean): void {\r\n\t\tconst roundedSamplesPerTick: number = Math.ceil(samplesPerTick);\r\n\t\tconst channel: Channel = song.channels[channelIndex];\r\n\t\tconst channelState: ChannelState = this.channels[channelIndex];\r\n\t\tconst instrument: Instrument = channel.instruments[tone.instrumentIndex];\r\n\t\tconst instrumentState: InstrumentState = channelState.instruments[tone.instrumentIndex];\r\n\t\tinstrumentState.awake = true;\r\n\t\tinstrumentState.tonesAddedInThisTick = true;\r\n\t\tif (!instrumentState.computed) {\r\n\t\t\tinstrumentState.compute(this, instrument, samplesPerTick, roundedSamplesPerTick, tone);\r\n\t\t}\r\n\t\tconst isNoiseChannel: boolean = song.getChannelIsNoise(channelIndex);\r\n\t\tconst transition: Transition = instrument.getTransition();\r\n\t\tconst chord: Chord = instrument.getChord();\r\n\t\tconst chordExpression: number = chord.singleTone ? 1.0 : Synth.computeChordExpression(tone.chordSize);\r\n\t\tconst intervalScale: number = isNoiseChannel ? Config.noiseInterval : 1;\r\n\t\tconst secondsPerPart: number = Config.ticksPerPart * samplesPerTick / this.samplesPerSecond;\r\n\t\tconst sampleTime: number = 1.0 / this.samplesPerSecond;\r\n\t\tconst beatsPerPart: number = 1.0 / Config.partsPerBeat;\r\n\t\tconst ticksIntoBar: number = this.getTicksIntoBar();\r\n\t\tconst partTimeStart: number = (ticksIntoBar      ) / Config.ticksPerPart;\r\n\t\tconst partTimeEnd: number   = (ticksIntoBar + 1.0) / Config.ticksPerPart;\r\n\t\tconst currentPart: number = this.getCurrentPart();\r\n\t\t\r\n\t\tlet specialIntervalMult: number = 1.0;\r\n\t\ttone.specialIntervalExpressionMult = 1.0;\r\n\t\t\r\n\t\tlet toneIsOnLastTick: boolean = shouldFadeOutFast;\r\n\t\tlet intervalStart: number = 0.0;\r\n\t\tlet intervalEnd: number = 0.0;\r\n\t\tlet fadeExpressionStart: number = 1.0;\r\n\t\tlet fadeExpressionEnd: number = 1.0;\r\n\t\tlet chordExpressionStart: number = chordExpression;\r\n\t\tlet chordExpressionEnd:   number = chordExpression;\r\n\t\t\r\n\t\tlet expressionReferencePitch: number = 16; // A low \"E\" as a MIDI pitch.\r\n\t\tlet basePitch: number = Config.keys[song.key].basePitch;\r\n\t\tlet baseExpression: number = 1.0;\r\n\t\tlet pitchDamping: number = 48;\r\n\t\tif (instrument.type == InstrumentType.spectrum) {\r\n\t\t\tbaseExpression = Config.spectrumBaseExpression;\r\n\t\t\tif (isNoiseChannel) {\r\n\t\t\t\tbasePitch = Config.spectrumBasePitch;\r\n\t\t\t\tbaseExpression *= 2.0; // Note: spectrum is louder for drum channels than pitch channels!\r\n\t\t\t}\r\n\t\t\texpressionReferencePitch = Config.spectrumBasePitch;\r\n\t\t\tpitchDamping = 28;\r\n\t\t} else if (instrument.type == InstrumentType.drumset) {\r\n\t\t\tbasePitch = Config.spectrumBasePitch;\r\n\t\t\tbaseExpression = Config.drumsetBaseExpression;\r\n\t\t\texpressionReferencePitch = basePitch;\r\n\t\t} else if (instrument.type == InstrumentType.noise) {\r\n\t\t\tbasePitch = Config.chipNoises[instrument.chipNoise].basePitch;\r\n\t\t\tbaseExpression = Config.noiseBaseExpression;\r\n\t\t\texpressionReferencePitch = basePitch;\r\n\t\t\tpitchDamping = Config.chipNoises[instrument.chipNoise].isSoft ? 24.0 : 60.0;\r\n\t\t} else if (instrument.type == InstrumentType.fm) {\r\n\t\t\tbaseExpression = Config.fmBaseExpression;\r\n\t\t} else if (instrument.type == InstrumentType.chip) {\r\n\t\t\tbaseExpression = Config.chipBaseExpression;\r\n\t\t} else if (instrument.type == InstrumentType.harmonics) {\r\n\t\t\tbaseExpression = Config.harmonicsBaseExpression;\r\n\t\t} else if (instrument.type == InstrumentType.pwm) {\r\n\t\t\tbaseExpression = Config.pwmBaseExpression;\r\n\t\t} else if (instrument.type == InstrumentType.supersaw) {\r\n\t\t\tbaseExpression = Config.supersawBaseExpression;\r\n\t\t} else if (instrument.type == InstrumentType.pickedString) {\r\n\t\t\tbaseExpression = Config.pickedStringBaseExpression;\r\n\t\t} else {\r\n\t\t\tthrow new Error(\"Unknown instrument type in computeTone.\");\r\n\t\t}\r\n\t\t\r\n\t\tif ((tone.atNoteStart && !transition.isSeamless && !tone.forceContinueAtStart) || tone.freshlyAllocated) {\r\n\t\t\ttone.reset();\r\n\t\t}\r\n\t\ttone.freshlyAllocated = false;\r\n\t\t\r\n\t\tfor (let i: number = 0; i < Config.maxPitchOrOperatorCount; i++) {\r\n\t\t\ttone.phaseDeltas[i] = 0.0;\r\n\t\t\ttone.phaseDeltaScales[i] = 0.0;\r\n\t\t\ttone.operatorExpressions[i]      = 0.0;\r\n\t\t\ttone.operatorExpressionDeltas[i] = 0.0;\r\n\t\t}\r\n\t\ttone.expression = 0.0;\r\n\t\ttone.expressionDelta = 0.0;\r\n\r\n\t\tif (released) {\r\n\t\t\tconst startTicksSinceReleased: number = tone.ticksSinceReleased;\r\n\t\t\tconst endTicksSinceReleased:   number = tone.ticksSinceReleased + 1.0;\r\n\t\t\tintervalStart = intervalEnd = tone.lastInterval;\r\n\t\t\tconst fadeOutTicks: number = Math.abs(instrument.getFadeOutTicks());\r\n\t\t\tfadeExpressionStart = Synth.noteSizeToVolumeMult((1.0 - startTicksSinceReleased / fadeOutTicks) * Config.noteSizeMax);\r\n\t\t\tfadeExpressionEnd   = Synth.noteSizeToVolumeMult((1.0 - endTicksSinceReleased / fadeOutTicks) * Config.noteSizeMax);\r\n\t\t\t\r\n\t\t\tif (shouldFadeOutFast) {\r\n\t\t\t\tfadeExpressionEnd = 0.0;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tif (tone.ticksSinceReleased + 1 >= fadeOutTicks) toneIsOnLastTick = true;\r\n\t\t} else if (tone.note == null) {\r\n\t\t\tfadeExpressionStart = fadeExpressionEnd = 1.0;\r\n\t\t\ttone.lastInterval = 0;\r\n\t\t\ttone.ticksSinceReleased = 0;\r\n\t\t\ttone.liveInputSamplesHeld += roundedSamplesPerTick;\r\n\t\t} else {\r\n\t\t\tconst note: Note = tone.note;\r\n\t\t\tconst nextNote: Note | null = tone.nextNote;\r\n\r\n\t\t\tconst noteStartPart: number = tone.noteStartPart;\r\n\t\t\tconst noteEndPart: number = tone.noteEndPart;\r\n\t\t\t\r\n\t\t\tconst endPinIndex: number = note.getEndPinIndex(currentPart);\r\n\t\t\tconst startPin: NotePin = note.pins[endPinIndex-1];\r\n\t\t\tconst endPin: NotePin = note.pins[endPinIndex];\r\n\t\t\tconst noteStartTick: number = noteStartPart * Config.ticksPerPart;\r\n\t\t\tconst noteEndTick:   number = noteEndPart   * Config.ticksPerPart;\r\n\t\t\tconst pinStart: number  = (note.start + startPin.time) * Config.ticksPerPart;\r\n\t\t\tconst pinEnd:   number  = (note.start +   endPin.time) * Config.ticksPerPart;\r\n\t\t\t\r\n\t\t\ttone.ticksSinceReleased = 0;\r\n\t\t\t\r\n\t\t\tconst tickTimeStart: number = currentPart * Config.ticksPerPart + this.tick;\r\n\t\t\tconst tickTimeEnd:   number = tickTimeStart + 1.0;\r\n\t\t\tconst noteTicksPassedTickStart: number = tickTimeStart - noteStartTick;\r\n\t\t\tconst noteTicksPassedTickEnd:   number = tickTimeEnd - noteStartTick;\r\n\t\t\tconst pinRatioStart: number = Math.min(1.0, (tickTimeStart - pinStart) / (pinEnd - pinStart));\r\n\t\t\tconst pinRatioEnd:   number = Math.min(1.0, (tickTimeEnd   - pinStart) / (pinEnd - pinStart));\r\n\t\t\tfadeExpressionStart = 1.0;\r\n\t\t\tfadeExpressionEnd   = 1.0;\r\n\t\t\tintervalStart = startPin.interval + (endPin.interval - startPin.interval) * pinRatioStart;\r\n\t\t\tintervalEnd   = startPin.interval + (endPin.interval - startPin.interval) * pinRatioEnd;\r\n\t\t\ttone.lastInterval = intervalEnd;\r\n\t\t\t\r\n\t\t\tif ((!transition.isSeamless && !tone.forceContinueAtEnd) || nextNote == null) {\r\n\t\t\t\tconst fadeOutTicks: number = -instrument.getFadeOutTicks();\r\n\t\t\t\tif (fadeOutTicks > 0.0) {\r\n\t\t\t\t\t// If the tone should fade out before the end of the note, do so here.\r\n\t\t\t\t\tconst noteLengthTicks: number = noteEndTick - noteStartTick;\r\n\t\t\t\t\tfadeExpressionStart *= Math.min(1.0, (noteLengthTicks - noteTicksPassedTickStart) / fadeOutTicks);\r\n\t\t\t\t\tfadeExpressionEnd   *= Math.min(1.0, (noteLengthTicks - noteTicksPassedTickEnd) / fadeOutTicks);\r\n\t\t\t\t\tif (tickTimeEnd >= noteStartTick + noteLengthTicks) toneIsOnLastTick = true;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\ttone.isOnLastTick = toneIsOnLastTick;\r\n\t\t\r\n\t\t// Compute envelopes *after* resetting the tone, otherwise the envelope computer gets reset too!\r\n\t\tconst envelopeComputer: EnvelopeComputer = tone.envelopeComputer;\r\n\t\tenvelopeComputer.computeEnvelopes(instrument, currentPart, Config.ticksPerPart * partTimeStart, samplesPerTick / this.samplesPerSecond, tone);\r\n\t\tconst envelopeStarts: number[] = tone.envelopeComputer.envelopeStarts;\r\n\t\tconst envelopeEnds: number[] = tone.envelopeComputer.envelopeEnds;\r\n\t\t\r\n\t\tif (tone.note != null && transition.slides) {\r\n\t\t\t// Slide interval and chordExpression at the start and/or end of the note if necessary.\r\n\t\t\tconst prevNote: Note | null = tone.prevNote;\r\n\t\t\tconst nextNote: Note | null = tone.nextNote;\r\n\t\t\tif (prevNote != null) {\r\n\t\t\t\tconst intervalDiff: number = prevNote.pitches[tone.prevNotePitchIndex] + prevNote.pins[prevNote.pins.length-1].interval - tone.pitches[0];\r\n\t\t\t\tif (envelopeComputer.prevSlideStart) intervalStart += intervalDiff * envelopeComputer.prevSlideRatioStart;\r\n\t\t\t\tif (envelopeComputer.prevSlideEnd)   intervalEnd   += intervalDiff * envelopeComputer.prevSlideRatioEnd;\r\n\t\t\t\tif (!chord.singleTone) {\r\n\t\t\t\t\tconst chordSizeDiff: number = prevNote.pitches.length - tone.chordSize;\r\n\t\t\t\t\tif (envelopeComputer.prevSlideStart) chordExpressionStart = Synth.computeChordExpression(tone.chordSize + chordSizeDiff * envelopeComputer.prevSlideRatioStart);\r\n\t\t\t\t\tif (envelopeComputer.prevSlideEnd)   chordExpressionEnd   = Synth.computeChordExpression(tone.chordSize + chordSizeDiff * envelopeComputer.prevSlideRatioEnd);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tif (nextNote != null) {\r\n\t\t\t\tconst intervalDiff: number = nextNote.pitches[tone.nextNotePitchIndex] - (tone.pitches[0] + tone.note.pins[tone.note.pins.length-1].interval);\r\n\t\t\t\tif (envelopeComputer.nextSlideStart) intervalStart += intervalDiff * envelopeComputer.nextSlideRatioStart;\r\n\t\t\t\tif (envelopeComputer.nextSlideEnd)   intervalEnd   += intervalDiff * envelopeComputer.nextSlideRatioEnd;\r\n\t\t\t\tif (!chord.singleTone) {\r\n\t\t\t\t\tconst chordSizeDiff: number = nextNote.pitches.length - tone.chordSize;\r\n\t\t\t\t\tif (envelopeComputer.nextSlideStart) chordExpressionStart = Synth.computeChordExpression(tone.chordSize + chordSizeDiff * envelopeComputer.nextSlideRatioStart);\r\n\t\t\t\t\tif (envelopeComputer.nextSlideEnd)   chordExpressionEnd   = Synth.computeChordExpression(tone.chordSize + chordSizeDiff * envelopeComputer.nextSlideRatioEnd);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tif (effectsIncludePitchShift(instrument.effects)) {\r\n\t\t\tconst pitchShift: number = Config.justIntonationSemitones[instrument.pitchShift] / intervalScale;\r\n\t\t\tconst envelopeStart: number = envelopeStarts[EnvelopeComputeIndex.pitchShift];\r\n\t\t\tconst envelopeEnd:   number = envelopeEnds[  EnvelopeComputeIndex.pitchShift];\r\n\t\t\tintervalStart += pitchShift * envelopeStart;\r\n\t\t\tintervalEnd   += pitchShift * envelopeEnd;\r\n\t\t}\r\n\t\tif (effectsIncludeDetune(instrument.effects)) {\r\n\t\t\tconst envelopeStart: number = envelopeStarts[EnvelopeComputeIndex.detune];\r\n\t\t\tconst envelopeEnd:   number = envelopeEnds[  EnvelopeComputeIndex.detune];\r\n\t\t\tintervalStart += Synth.detuneToCents((instrument.detune - Config.detuneCenter) * envelopeStart) * Config.pitchesPerOctave / (12.0 * 100.0);\r\n\t\t\tintervalEnd   += Synth.detuneToCents((instrument.detune - Config.detuneCenter) * envelopeEnd  ) * Config.pitchesPerOctave / (12.0 * 100.0);\r\n\t\t}\r\n\t\t\r\n\t\tif (effectsIncludeVibrato(instrument.effects)) {\r\n\t\t\tconst delayTicks: number = Config.vibratos[instrument.vibrato].delayTicks;\r\n\t\t\tconst vibratoAmplitude: number = Config.vibratos[instrument.vibrato].amplitude;\r\n\t\t\t\r\n\t\t\t// To maintain pitch continuity, (mostly for picked string which retriggers impulse\r\n\t\t\t// otherwise) remember the vibrato at the end of this run and reuse it at the start\r\n\t\t\t// of the next run if available.\r\n\t\t\tlet vibratoStart: number;\r\n\t\t\tif (tone.prevVibrato != null) {\r\n\t\t\t\tvibratoStart = tone.prevVibrato;\r\n\t\t\t} else {\r\n\t\t\t\tlet lfoStart: number = Synth.getLFOAmplitude(instrument, secondsPerPart * partTimeStart);\r\n\t\t\t\tconst vibratoDepthEnvelopeStart: number = envelopeStarts[EnvelopeComputeIndex.vibratoDepth];\r\n\t\t\t\tvibratoStart = vibratoAmplitude * lfoStart * vibratoDepthEnvelopeStart;\r\n\t\t\t\tif (delayTicks > 0.0) {\r\n\t\t\t\t\tconst ticksUntilVibratoStart: number = delayTicks - envelopeComputer.noteTicksStart;\r\n\t\t\t\t\tvibratoStart *= Math.max(0.0, Math.min(1.0, 1.0 - ticksUntilVibratoStart / 2.0));\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tlet lfoEnd:   number = Synth.getLFOAmplitude(instrument, secondsPerPart * partTimeEnd);\r\n\t\t\tconst vibratoDepthEnvelopeEnd:   number = envelopeEnds[  EnvelopeComputeIndex.vibratoDepth];\r\n\t\t\tlet vibratoEnd:   number = vibratoAmplitude * lfoEnd   * vibratoDepthEnvelopeEnd;\r\n\t\t\tif (delayTicks > 0.0) {\r\n\t\t\t\tconst ticksUntilVibratoEnd:   number = delayTicks - envelopeComputer.noteTicksEnd;\r\n\t\t\t\tvibratoEnd   *= Math.max(0.0, Math.min(1.0, 1.0 - ticksUntilVibratoEnd   / 2.0));\r\n\t\t\t}\r\n\t\t\ttone.prevVibrato = vibratoEnd;\r\n\t\t\t\r\n\t\t\tintervalStart += vibratoStart;\r\n\t\t\tintervalEnd   += vibratoEnd;\r\n\t\t}\r\n\t\t\r\n\t\tif ((!transition.isSeamless && !tone.forceContinueAtStart) || tone.prevNote == null) {\r\n\t\t\t// Fade in the beginning of the note.\r\n\t\t\tconst fadeInSeconds: number = instrument.getFadeInSeconds();\r\n\t\t\tif (fadeInSeconds > 0.0) {\r\n\t\t\t\tfadeExpressionStart *= Math.min(1.0, envelopeComputer.noteSecondsStart / fadeInSeconds);\r\n\t\t\t\tfadeExpressionEnd   *= Math.min(1.0, envelopeComputer.noteSecondsEnd   / fadeInSeconds);\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tif (instrument.type == InstrumentType.drumset && tone.drumsetPitch == null) {\r\n\t\t\t// It's possible that the note will change while the user is editing it,\r\n\t\t\t// but the tone's pitches don't get updated because the tone has already\r\n\t\t\t// ended and is fading out. To avoid an array index out of bounds error, clamp the pitch.\r\n\t\t\ttone.drumsetPitch = tone.pitches[0];\r\n\t\t\tif (tone.note != null) tone.drumsetPitch += tone.note.pickMainInterval();\r\n\t\t\ttone.drumsetPitch = Math.max(0, Math.min(Config.drumCount - 1, tone.drumsetPitch));\r\n\t\t}\r\n\t\t\r\n\t\tlet noteFilterExpression: number = envelopeComputer.lowpassCutoffDecayVolumeCompensation;\r\n\t\tif (!effectsIncludeNoteFilter(instrument.effects)) {\r\n\t\t\ttone.noteFilterCount = 0;\r\n\t\t} else {\r\n\t\t\tconst noteFilterSettings: FilterSettings = instrument.noteFilter;\r\n\t\t\t\r\n\t\t\tconst noteAllFreqsEnvelopeStart: number = envelopeStarts[EnvelopeComputeIndex.noteFilterAllFreqs];\r\n\t\t\tconst noteAllFreqsEnvelopeEnd:   number = envelopeEnds[  EnvelopeComputeIndex.noteFilterAllFreqs];\r\n\t\t\tfor (let i: number = 0; i < noteFilterSettings.controlPointCount; i++) {\r\n\t\t\t\tconst noteFreqEnvelopeStart: number = envelopeStarts[EnvelopeComputeIndex.noteFilterFreq0 + i];\r\n\t\t\t\tconst noteFreqEnvelopeEnd:   number = envelopeEnds[  EnvelopeComputeIndex.noteFilterFreq0 + i];\r\n\t\t\t\tconst notePeakEnvelopeStart: number = envelopeStarts[EnvelopeComputeIndex.noteFilterGain0 + i];\r\n\t\t\t\tconst notePeakEnvelopeEnd:   number = envelopeEnds[  EnvelopeComputeIndex.noteFilterGain0 + i];\r\n\t\t\t\tconst point: FilterControlPoint = noteFilterSettings.controlPoints[i];\r\n\t\t\t\tpoint.toCoefficients(Synth.tempFilterStartCoefficients, this.samplesPerSecond, noteAllFreqsEnvelopeStart * noteFreqEnvelopeStart, notePeakEnvelopeStart);\r\n\t\t\t\tpoint.toCoefficients(Synth.tempFilterEndCoefficients,   this.samplesPerSecond, noteAllFreqsEnvelopeEnd   * noteFreqEnvelopeEnd,   notePeakEnvelopeEnd);\r\n\t\t\t\tif (tone.noteFilters.length <= i) tone.noteFilters[i] = new DynamicBiquadFilter();\r\n\t\t\t\ttone.noteFilters[i].loadCoefficientsWithGradient(Synth.tempFilterStartCoefficients, Synth.tempFilterEndCoefficients, 1.0 / roundedSamplesPerTick, point.type == FilterType.lowPass);\r\n\t\t\t\tnoteFilterExpression *= point.getVolumeCompensationMult();\r\n\t\t\t}\r\n\t\t\ttone.noteFilterCount = noteFilterSettings.controlPointCount;\r\n\t\t}\r\n\t\t\r\n\t\tif (instrument.type == InstrumentType.drumset) {\r\n\t\t\tconst drumsetFilterEnvelope: Envelope = instrument.getDrumsetEnvelope(tone.drumsetPitch!);\r\n\t\t\t// If the drumset lowpass cutoff decays, compensate by increasing expression.\r\n\t\t\tnoteFilterExpression *= EnvelopeComputer.getLowpassCutoffDecayVolumeCompensation(drumsetFilterEnvelope)\r\n\t\t\t\r\n\t\t\t// Drumset filters use the same envelope timing as the rest of the envelopes, but do not include support for slide transitions.\r\n\t\t\tlet drumsetFilterEnvelopeStart: number = EnvelopeComputer.computeEnvelope(drumsetFilterEnvelope, envelopeComputer.noteSecondsStart, beatsPerPart * partTimeStart, envelopeComputer.noteSizeStart);\r\n\t\t\tlet drumsetFilterEnvelopeEnd:   number = EnvelopeComputer.computeEnvelope(drumsetFilterEnvelope, envelopeComputer.noteSecondsEnd,   beatsPerPart * partTimeEnd,   envelopeComputer.noteSizeEnd);\r\n\t\t\t\r\n\t\t\t// Apply slide interpolation to drumset envelope.\r\n\t\t\tif (envelopeComputer.prevSlideStart) {\r\n\t\t\t\tconst other: number = EnvelopeComputer.computeEnvelope(drumsetFilterEnvelope, envelopeComputer.prevNoteSecondsStart, beatsPerPart * partTimeStart, envelopeComputer.prevNoteSize);\r\n\t\t\t\tdrumsetFilterEnvelopeStart += (other - drumsetFilterEnvelopeStart) * envelopeComputer.prevSlideRatioStart;\r\n\t\t\t}\r\n\t\t\tif (envelopeComputer.prevSlideEnd) {\r\n\t\t\t\tconst other: number = EnvelopeComputer.computeEnvelope(drumsetFilterEnvelope, envelopeComputer.prevNoteSecondsEnd, beatsPerPart * partTimeEnd, envelopeComputer.prevNoteSize);\r\n\t\t\t\tdrumsetFilterEnvelopeEnd += (other - drumsetFilterEnvelopeEnd) * envelopeComputer.prevSlideRatioEnd;\r\n\t\t\t}\r\n\t\t\tif (envelopeComputer.nextSlideStart) {\r\n\t\t\t\tconst other: number = EnvelopeComputer.computeEnvelope(drumsetFilterEnvelope, 0.0, beatsPerPart * partTimeStart, envelopeComputer.nextNoteSize);\r\n\t\t\t\tdrumsetFilterEnvelopeStart += (other - drumsetFilterEnvelopeStart) * envelopeComputer.nextSlideRatioStart;\r\n\t\t\t}\r\n\t\t\tif (envelopeComputer.nextSlideEnd) {\r\n\t\t\t\tconst other: number = EnvelopeComputer.computeEnvelope(drumsetFilterEnvelope, 0.0, beatsPerPart * partTimeEnd, envelopeComputer.nextNoteSize);\r\n\t\t\t\tdrumsetFilterEnvelopeEnd += (other - drumsetFilterEnvelopeEnd) * envelopeComputer.nextSlideRatioEnd;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tconst point: FilterControlPoint = this.tempDrumSetControlPoint;\r\n\t\t\tpoint.type = FilterType.lowPass;\r\n\t\t\tpoint.gain = FilterControlPoint.getRoundedSettingValueFromLinearGain(0.5);\r\n\t\t\tpoint.freq = FilterControlPoint.getRoundedSettingValueFromHz(8000.0);\r\n\t\t\t// Drumset envelopes are warped to better imitate the legacy simplified 2nd order lowpass at ~48000Hz that I used to use.\r\n\t\t\tpoint.toCoefficients(Synth.tempFilterStartCoefficients, this.samplesPerSecond, drumsetFilterEnvelopeStart * (1.0 + drumsetFilterEnvelopeStart), 1.0);\r\n\t\t\tpoint.toCoefficients(Synth.tempFilterEndCoefficients, this.samplesPerSecond, drumsetFilterEnvelopeEnd * (1.0 + drumsetFilterEnvelopeEnd), 1.0);\r\n\t\t\tif (tone.noteFilters.length == tone.noteFilterCount) tone.noteFilters[tone.noteFilterCount] = new DynamicBiquadFilter();\r\n\t\t\ttone.noteFilters[tone.noteFilterCount].loadCoefficientsWithGradient(Synth.tempFilterStartCoefficients, Synth.tempFilterEndCoefficients, 1.0 / roundedSamplesPerTick, true);\r\n\t\t\ttone.noteFilterCount++;\r\n\t\t}\r\n\t\t\r\n\t\tnoteFilterExpression = Math.min(3.0, noteFilterExpression);\r\n\t\t\r\n\t\tif (instrument.type == InstrumentType.fm) {\r\n\t\t\t// phase modulation!\r\n\t\t\t\r\n\t\t\tlet sineExpressionBoost: number = 1.0;\r\n\t\t\tlet totalCarrierExpression: number = 0.0;\r\n\r\n\t\t\tlet arpeggioInterval: number = 0;\r\n\t\t\tconst arpeggiates: boolean = chord.arpeggiates;\r\n\t\t\tif (tone.pitchCount > 1 && arpeggiates) {\r\n\t\t\t\tconst arpeggio: number = Math.floor((this.tick + this.part * Config.ticksPerPart) / Config.rhythms[song.rhythm].ticksPerArpeggio);\r\n\t\t\t\tarpeggioInterval = tone.pitches[getArpeggioPitchIndex(tone.pitchCount, song.rhythm, arpeggio)] - tone.pitches[0];\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tconst carrierCount: number = Config.algorithms[instrument.algorithm].carrierCount;\r\n\t\t\tfor (let i: number = 0; i < Config.operatorCount; i++) {\r\n\t\t\t\tconst associatedCarrierIndex: number = Config.algorithms[instrument.algorithm].associatedCarrier[i] - 1;\r\n\t\t\t\tconst pitch: number = tone.pitches[arpeggiates ? 0 : ((i < tone.pitchCount) ? i : ((associatedCarrierIndex < tone.pitchCount) ? associatedCarrierIndex : 0))];\r\n\t\t\t\tconst freqMult = Config.operatorFrequencies[instrument.operators[i].frequency].mult;\r\n\t\t\t\tconst interval = Config.operatorCarrierInterval[associatedCarrierIndex] + arpeggioInterval;\r\n\t\t\t\tconst pitchStart: number = basePitch + (pitch + intervalStart) * intervalScale + interval;\r\n\t\t\t\tconst pitchEnd: number = basePitch + (pitch + intervalEnd) * intervalScale + interval;\r\n\t\t\t\tconst baseFreqStart: number = Instrument.frequencyFromPitch(pitchStart);\r\n\t\t\t\tconst baseFreqEnd:   number = Instrument.frequencyFromPitch(pitchEnd);\r\n\t\t\t\tconst hzOffset: number = Config.operatorFrequencies[instrument.operators[i].frequency].hzOffset;\r\n\t\t\t\tconst targetFreqStart: number = freqMult * baseFreqStart + hzOffset;\r\n\t\t\t\tconst targetFreqEnd:   number = freqMult * baseFreqEnd   + hzOffset;\r\n\t\t\t\t\r\n\t\t\t\tconst freqEnvelopeStart: number = envelopeStarts[EnvelopeComputeIndex.operatorFrequency0 + i];\r\n\t\t\t\tconst freqEnvelopeEnd:   number = envelopeEnds[  EnvelopeComputeIndex.operatorFrequency0 + i];\r\n\t\t\t\tlet freqStart: number;\r\n\t\t\t\tlet freqEnd:   number;\r\n\t\t\t\tif (freqEnvelopeStart != 1.0 || freqEnvelopeEnd != 1.0) {\r\n\t\t\t\t\tfreqStart = Math.pow(2.0, Math.log2(targetFreqStart / baseFreqStart) * freqEnvelopeStart) * baseFreqStart;\r\n\t\t\t\t\tfreqEnd   = Math.pow(2.0, Math.log2(targetFreqEnd   / baseFreqEnd)   * freqEnvelopeEnd)   * baseFreqEnd;\r\n\t\t\t\t} else {\r\n\t\t\t\t\tfreqStart = targetFreqStart;\r\n\t\t\t\t\tfreqEnd   = targetFreqEnd;\r\n\t\t\t\t}\r\n\t\t\t\ttone.phaseDeltas[i] = freqStart * sampleTime;\r\n\t\t\t\ttone.phaseDeltaScales[i] = Math.pow(freqEnd / freqStart, 1.0 / roundedSamplesPerTick);\r\n\t\t\t\t\r\n\t\t\t\tconst amplitudeCurve: number = Synth.operatorAmplitudeCurve(instrument.operators[i].amplitude);\r\n\t\t\t\tconst amplitudeMult: number = amplitudeCurve * Config.operatorFrequencies[instrument.operators[i].frequency].amplitudeSign;\r\n\t\t\t\tlet expressionStart: number = amplitudeMult;\r\n\t\t\t\tlet expressionEnd: number = amplitudeMult;\r\n\t\t\t\tif (i < carrierCount) {\r\n\t\t\t\t\t// carrier\r\n\t\t\t\t\tlet pitchExpressionStart: number;\r\n\t\t\t\t\tif (tone.prevPitchExpressions[i] != null) {\r\n\t\t\t\t\t\tpitchExpressionStart = tone.prevPitchExpressions[i]!;\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tpitchExpressionStart = Math.pow(2.0, -(pitchStart - expressionReferencePitch) / pitchDamping);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tconst pitchExpressionEnd: number   = Math.pow(2.0, -(pitchEnd   - expressionReferencePitch) / pitchDamping);\r\n\t\t\t\t\ttone.prevPitchExpressions[i] = pitchExpressionEnd;\r\n\t\t\t\t\texpressionStart *= pitchExpressionStart;\r\n\t\t\t\t\texpressionEnd   *= pitchExpressionEnd;\r\n\t\t\t\t\t\r\n\t\t\t\t\ttotalCarrierExpression += amplitudeCurve;\r\n\t\t\t\t} else {\r\n\t\t\t\t\t// modulator\r\n\t\t\t\t\texpressionStart *= Config.sineWaveLength * 1.5;\r\n\t\t\t\t\texpressionEnd   *= Config.sineWaveLength * 1.5;\r\n\t\t\t\t\t\r\n\t\t\t\t\tsineExpressionBoost *= 1.0 - Math.min(1.0, instrument.operators[i].amplitude / 15);\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\texpressionStart *= envelopeStarts[EnvelopeComputeIndex.operatorAmplitude0 + i];\r\n\t\t\t\texpressionEnd   *= envelopeEnds[  EnvelopeComputeIndex.operatorAmplitude0 + i];\r\n\t\t\t\t\r\n\t\t\t\ttone.operatorExpressions[i] = expressionStart;\r\n\t\t\t\ttone.operatorExpressionDeltas[i] = (expressionEnd - expressionStart) / roundedSamplesPerTick;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tsineExpressionBoost *= (Math.pow(2.0, (2.0 - 1.4 * instrument.feedbackAmplitude / 15.0)) - 1.0) / 3.0;\r\n\t\t\tsineExpressionBoost *= 1.0 - Math.min(1.0, Math.max(0.0, totalCarrierExpression - 1) / 2.0);\r\n\t\t\tsineExpressionBoost = 1.0 + sineExpressionBoost * 3.0;\r\n\t\t\tconst expressionStart: number = baseExpression * sineExpressionBoost * noteFilterExpression * fadeExpressionStart * chordExpressionStart * envelopeStarts[EnvelopeComputeIndex.noteVolume];\r\n\t\t\tconst expressionEnd:   number = baseExpression * sineExpressionBoost * noteFilterExpression * fadeExpressionEnd * chordExpressionEnd * envelopeEnds[  EnvelopeComputeIndex.noteVolume];\r\n\t\t\ttone.expression = expressionStart;\r\n\t\t\ttone.expressionDelta = (expressionEnd - expressionStart) / roundedSamplesPerTick;\r\n\t\t\t\r\n\t\t\tconst feedbackAmplitude: number = Config.sineWaveLength * 0.3 * instrument.feedbackAmplitude / 15.0;\r\n\t\t\tlet feedbackStart: number = feedbackAmplitude * envelopeStarts[EnvelopeComputeIndex.feedbackAmplitude];\r\n\t\t\tlet feedbackEnd:   number = feedbackAmplitude * envelopeEnds[  EnvelopeComputeIndex.feedbackAmplitude];\r\n\t\t\ttone.feedbackMult = feedbackStart;\r\n\t\t\ttone.feedbackDelta = (feedbackEnd - feedbackStart) / roundedSamplesPerTick;\r\n\t\t} else {\r\n\t\t\tconst freqEndRatio: number = Math.pow(2.0, (intervalEnd - intervalStart) * intervalScale / 12.0);\r\n\t\t\tconst basePhaseDeltaScale: number = Math.pow(freqEndRatio, 1.0 / roundedSamplesPerTick);\r\n\t\t\t\r\n\t\t\tlet pitch: number = tone.pitches[0];\r\n\t\t\tif (tone.pitchCount > 1 && (chord.arpeggiates || chord.customInterval)) {\r\n\t\t\t\tconst arpeggio: number = Math.floor((this.tick + this.part * Config.ticksPerPart) / Config.rhythms[song.rhythm].ticksPerArpeggio);\r\n\t\t\t\tif (chord.customInterval) {\r\n\t\t\t\t\tconst intervalOffset: number = tone.pitches[1 + getArpeggioPitchIndex(tone.pitchCount - 1, song.rhythm, arpeggio)] - tone.pitches[0];\r\n\t\t\t\t\tspecialIntervalMult = Math.pow(2.0, intervalOffset / 12.0);\r\n\t\t\t\t\ttone.specialIntervalExpressionMult = Math.pow(2.0, -intervalOffset / pitchDamping);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tpitch = tone.pitches[getArpeggioPitchIndex(tone.pitchCount, song.rhythm, arpeggio)];\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tconst startPitch: number = basePitch + (pitch + intervalStart) * intervalScale;\r\n\t\t\tconst endPitch:   number = basePitch + (pitch + intervalEnd)   * intervalScale;\r\n\t\t\tlet pitchExpressionStart: number;\r\n\t\t\t// TODO: use the second element of prevPitchExpressions for the unison voice, compute a separate expression delta for it.\r\n\t\t\tif (tone.prevPitchExpressions[0] != null) {\r\n\t\t\t\tpitchExpressionStart = tone.prevPitchExpressions[0]!;\r\n\t\t\t} else {\r\n\t\t\t\tpitchExpressionStart = Math.pow(2.0, -(startPitch - expressionReferencePitch) / pitchDamping);\r\n\t\t\t}\r\n\t\t\tconst pitchExpressionEnd:   number = Math.pow(2.0,   -(endPitch - expressionReferencePitch) / pitchDamping);\r\n\t\t\ttone.prevPitchExpressions[0] = pitchExpressionEnd;\r\n\t\t\tlet settingsExpressionMult: number = baseExpression * noteFilterExpression;\r\n\t\t\t\r\n\t\t\tif (instrument.type == InstrumentType.noise) {\r\n\t\t\t\tsettingsExpressionMult *= Config.chipNoises[instrument.chipNoise].expression;\r\n\t\t\t}\r\n\t\t\tif (instrument.type == InstrumentType.chip) {\r\n\t\t\t\tsettingsExpressionMult *= Config.chipWaves[instrument.chipWave].expression;\r\n\t\t\t}\r\n\t\t\tif (instrument.type == InstrumentType.pwm) {\r\n\t\t\t\tconst basePulseWidth: number = getPulseWidthRatio(instrument.pulseWidth);\r\n\t\t\t\tconst pulseWidthStart: number = basePulseWidth * envelopeStarts[EnvelopeComputeIndex.pulseWidth];\r\n\t\t\t\tconst pulseWidthEnd:   number = basePulseWidth * envelopeEnds[  EnvelopeComputeIndex.pulseWidth];\r\n\t\t\t\ttone.pulseWidth = pulseWidthStart;\r\n\t\t\t\ttone.pulseWidthDelta = (pulseWidthEnd - pulseWidthStart) / roundedSamplesPerTick;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tif (instrument.type == InstrumentType.pickedString) {\r\n\t\t\t\t// Increase expression to compensate for string decay.\r\n\t\t\t\tsettingsExpressionMult *= Math.pow(2.0, 0.7 * (1.0 - instrument.stringSustain / (Config.stringSustainRange - 1)));\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tconst startFreq: number = Instrument.frequencyFromPitch(startPitch);\r\n\t\t\tif (instrument.type == InstrumentType.chip || instrument.type == InstrumentType.harmonics || instrument.type == InstrumentType.pickedString) {\r\n\t\t\t\t// These instruments have two waves at different frequencies for the unison feature.\r\n\t\t\t\tconst unison: Unison = Config.unisons[instrument.unison];\r\n\t\t\t\tconst voiceCountExpression: number = (instrument.type == InstrumentType.pickedString) ? 1 : unison.voices / 2.0;\r\n\t\t\t\tsettingsExpressionMult *= unison.expression * voiceCountExpression;\r\n\t\t\t\tconst unisonEnvelopeStart = envelopeStarts[EnvelopeComputeIndex.unison];\r\n\t\t\t\tconst unisonEnvelopeEnd   = envelopeEnds[  EnvelopeComputeIndex.unison];\r\n\t\t\t\tconst unisonAStart: number = Math.pow(2.0, (unison.offset + unison.spread) * unisonEnvelopeStart / 12.0);\r\n\t\t\t\tconst unisonAEnd:   number = Math.pow(2.0, (unison.offset + unison.spread) * unisonEnvelopeEnd   / 12.0);\r\n\t\t\t\tconst unisonBStart: number = Math.pow(2.0, (unison.offset - unison.spread) * unisonEnvelopeStart / 12.0) * specialIntervalMult;\r\n\t\t\t\tconst unisonBEnd:   number = Math.pow(2.0, (unison.offset - unison.spread) * unisonEnvelopeEnd   / 12.0) * specialIntervalMult;\r\n\t\t\t\ttone.phaseDeltas[0] = startFreq * sampleTime * unisonAStart;\r\n\t\t\t\ttone.phaseDeltas[1] = startFreq * sampleTime * unisonBStart;\r\n\t\t\t\ttone.phaseDeltaScales[0] = basePhaseDeltaScale * Math.pow(unisonAEnd / unisonAStart, 1.0 / roundedSamplesPerTick);\r\n\t\t\t\ttone.phaseDeltaScales[1] = basePhaseDeltaScale * Math.pow(unisonBEnd / unisonBStart, 1.0 / roundedSamplesPerTick);\r\n\t\t\t} else {\r\n\t\t\t\ttone.phaseDeltas[0] = startFreq * sampleTime;\r\n\t\t\t\ttone.phaseDeltaScales[0] = basePhaseDeltaScale;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t// TODO: make expressionStart and expressionEnd variables earlier and modify those\r\n\t\t\t// instead of these supersawExpression variables.\r\n\t\t\tlet supersawExpressionStart: number = 1.0;\r\n\t\t\tlet supersawExpressionEnd: number = 1.0;\r\n\t\t\tif (instrument.type == InstrumentType.supersaw) {\r\n\t\t\t\tconst minFirstVoiceAmplitude: number = 1.0 / Math.sqrt(Config.supersawVoiceCount);\r\n\t\t\t\tconst baseDynamismSlider: number = instrument.supersawDynamism / Config.supersawDynamismMax;\r\n\t\t\t\tconst curvedDynamismStart: number = 1.0 - Math.pow(Math.max(0.0, 1.0 - baseDynamismSlider * envelopeStarts[EnvelopeComputeIndex.supersawDynamism]), 0.2);\r\n\t\t\t\tconst curvedDynamismEnd:   number = 1.0 - Math.pow(Math.max(0.0, 1.0 - baseDynamismSlider * envelopeEnds[  EnvelopeComputeIndex.supersawDynamism]), 0.2);\r\n\t\t\t\tconst firstVoiceAmplitudeStart: number = Math.pow(2.0, Math.log2(minFirstVoiceAmplitude) * curvedDynamismStart);\r\n\t\t\t\tconst firstVoiceAmplitudeEnd:   number = Math.pow(2.0, Math.log2(minFirstVoiceAmplitude) * curvedDynamismEnd);\r\n\t\t\t\t// TODO: automation\r\n\t\t\t\tconst dynamismStart: number = Math.sqrt((1.0 / Math.pow(firstVoiceAmplitudeStart, 2.0) - 1.0) / (Config.supersawVoiceCount - 1.0));\r\n\t\t\t\tconst dynamismEnd:   number = Math.sqrt((1.0 / Math.pow(firstVoiceAmplitudeEnd, 2.0) - 1.0) / (Config.supersawVoiceCount - 1.0));\r\n\t\t\t\ttone.supersawDynamism = dynamismStart;\r\n\t\t\t\ttone.supersawDynamismDelta = (dynamismEnd - dynamismStart) / roundedSamplesPerTick;\r\n\t\t\t\t\r\n\t\t\t\tconst initializeSupersaw: boolean = (tone.supersawDelayIndex == -1);\r\n\t\t\t\tif (initializeSupersaw) {\r\n\t\t\t\t\t// Goal: generate sawtooth phases such that the combined initial amplitude\r\n\t\t\t\t\t// cancel out to minimize pop. Algorithm: generate sorted phases, iterate over\r\n\t\t\t\t\t// their sawtooth drop points to find a combined zero crossing, then offset the\r\n\t\t\t\t\t// phases so they start there.\r\n\t\t\t\t\t\r\n\t\t\t\t\t// Generate random phases in ascending order by adding positive randomly\r\n\t\t\t\t\t// sized gaps between adjacent phases. For a proper distribution of random\r\n\t\t\t\t\t// events, the gaps sizes should be an \"exponential distribution\", which is\r\n\t\t\t\t\t// just: -Math.log(Math.random()). At the end, normalize the phases to a 0-1\r\n\t\t\t\t\t// range by dividing by the final value of the accumulator.\r\n\t\t\t\t\tlet accumulator: number = 0.0;\r\n\t\t\t\t\tfor (let i: number = 0; i < Config.supersawVoiceCount; i++) {\r\n\t\t\t\t\t\ttone.phases[i] = accumulator;\r\n\t\t\t\t\t\taccumulator += -Math.log(Math.random());\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t\tconst amplitudeSum: number = 1.0 + (Config.supersawVoiceCount - 1.0) * dynamismStart;\r\n\t\t\t\t\tconst slope: number = amplitudeSum;\r\n\t\t\t\t\t\r\n\t\t\t\t\t// Find the initial amplitude of the sum of sawtooths with the normalized\r\n\t\t\t\t\t// set of phases.\r\n\t\t\t\t\tlet sample: number = 0.0;\r\n\t\t\t\t\tfor (let i: number = 0; i < Config.supersawVoiceCount; i++) {\r\n\t\t\t\t\t\tconst amplitude: number = (i == 0) ? 1.0 : dynamismStart;\r\n\t\t\t\t\t\tconst normalizedPhase: number = tone.phases[i] / accumulator;\r\n\t\t\t\t\t\ttone.phases[i] = normalizedPhase;\r\n\t\t\t\t\t\tsample += (normalizedPhase - 0.5) * amplitude;\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t\t// Find the phase of the zero crossing of the sum of the sawtooths. You can\r\n\t\t\t\t\t// use a constant slope and the distance between sawtooth drops to determine if\r\n\t\t\t\t\t// the zero crossing occurs between them. Note that a small phase means that\r\n\t\t\t\t\t// the corresponding drop for that wave is far away, and a big phase means the\r\n\t\t\t\t\t// drop is nearby, so to iterate forward through the drops we iterate backward\r\n\t\t\t\t\t// through the phases.\r\n\t\t\t\t\tlet zeroCrossingPhase: number = 1.0;\r\n\t\t\t\t\tlet prevDrop: number = 0.0;\r\n\t\t\t\t\tfor (let i: number = Config.supersawVoiceCount - 1; i >= 0; i--) {\r\n\t\t\t\t\t\tconst nextDrop: number = 1.0 - tone.phases[i];\r\n\t\t\t\t\t\tconst phaseDelta: number = nextDrop - prevDrop;\r\n\t\t\t\t\t\tif (sample < 0.0) {\r\n\t\t\t\t\t\t\tconst distanceToZeroCrossing: number = -sample / slope;\r\n\t\t\t\t\t\t\tif (distanceToZeroCrossing < phaseDelta) {\r\n\t\t\t\t\t\t\t\tzeroCrossingPhase = prevDrop + distanceToZeroCrossing;\r\n\t\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tconst amplitude: number = (i == 0) ? 1.0 : dynamismStart;\r\n\t\t\t\t\t\tsample += phaseDelta * slope - amplitude;\r\n\t\t\t\t\t\tprevDrop = nextDrop;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tfor (let i: number = 0; i < Config.supersawVoiceCount; i++) {\r\n\t\t\t\t\t\ttone.phases[i] += zeroCrossingPhase;\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t\t// Randomize the (initially sorted) order of the phases (aside from the\r\n\t\t\t\t\t// first one) so that they don't correlate to the detunes that are also\r\n\t\t\t\t\t// based on index.\r\n\t\t\t\t\tfor (let i: number = 1; i < Config.supersawVoiceCount - 1; i++) {\r\n\t\t\t\t\t\tconst swappedIndex: number = i + Math.floor(Math.random() * (Config.supersawVoiceCount - i));\r\n\t\t\t\t\t\tconst temp: number = tone.phases[i];\r\n\t\t\t\t\t\ttone.phases[i] = tone.phases[swappedIndex];\r\n\t\t\t\t\t\ttone.phases[swappedIndex] = temp;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tconst baseSpreadSlider: number = instrument.supersawSpread / Config.supersawSpreadMax;\r\n\t\t\t\t// TODO: automation\r\n\t\t\t\tconst spreadSliderStart: number = baseSpreadSlider * envelopeStarts[EnvelopeComputeIndex.supersawSpread];\r\n\t\t\t\tconst spreadSliderEnd:   number = baseSpreadSlider * envelopeEnds[  EnvelopeComputeIndex.supersawSpread];\r\n\t\t\t\t// Just use the average detune for the current tick in the below loop.\r\n\t\t\t\tconst averageSpreadSlider: number = (spreadSliderStart + spreadSliderEnd) * 0.5;\r\n\t\t\t\tconst curvedSpread: number = Math.pow(1.0 - Math.sqrt(Math.max(0.0, 1.0 - averageSpreadSlider)), 1.75);\r\n\t\t\t\tfor (let i = 0; i < Config.supersawVoiceCount; i++) {\r\n\t\t\t\t\t// Spread out the detunes around the center;\r\n\t\t\t\t\tconst offset: number = (i == 0) ? 0.0 : Math.pow((((i + 1) >> 1) - 0.5 + 0.025 * ((i & 2) - 1)) / (Config.supersawVoiceCount >> 1), 1.1) * ((i & 1) * 2 - 1);\r\n\t\t\t\t\ttone.supersawUnisonDetunes[i] = Math.pow(2.0, curvedSpread * offset / 12.0);\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tconst baseShape: number = instrument.supersawShape / Config.supersawShapeMax;\r\n\t\t\t\t// TODO: automation\r\n\t\t\t\tconst shapeStart: number = baseShape * envelopeStarts[EnvelopeComputeIndex.supersawShape];\r\n\t\t\t\tconst shapeEnd:   number = baseShape * envelopeEnds[  EnvelopeComputeIndex.supersawShape];\r\n\t\t\t\ttone.supersawShape = shapeStart;\r\n\t\t\t\ttone.supersawShapeDelta = (shapeEnd - shapeStart) / roundedSamplesPerTick;\r\n\t\t\t\t\r\n\t\t\t\tconst basePulseWidth: number = getPulseWidthRatio(instrument.pulseWidth);\r\n\t\t\t\t// TODO: automation\r\n\t\t\t\tconst pulseWidthStart: number = basePulseWidth * envelopeStarts[EnvelopeComputeIndex.pulseWidth];\r\n\t\t\t\tconst pulseWidthEnd:   number = basePulseWidth * envelopeEnds[  EnvelopeComputeIndex.pulseWidth];\r\n\t\t\t\tconst phaseDeltaStart: number = (tone.supersawPrevPhaseDelta != null) ? tone.supersawPrevPhaseDelta : startFreq * sampleTime;\r\n\t\t\t\tconst phaseDeltaEnd: number = startFreq * sampleTime * freqEndRatio;\r\n\t\t\t\ttone.supersawPrevPhaseDelta = phaseDeltaEnd;\r\n\t\t\t\tconst delayLengthStart = pulseWidthStart / phaseDeltaStart;\r\n\t\t\t\tconst delayLengthEnd = pulseWidthEnd / phaseDeltaEnd;\r\n\t\t\t\ttone.supersawDelayLength = delayLengthStart;\r\n\t\t\t\ttone.supersawDelayLengthDelta = (delayLengthEnd - delayLengthStart) / roundedSamplesPerTick;\r\n\t\t\t\tconst minBufferLength: number = Math.ceil(Math.max(delayLengthStart, delayLengthEnd)) + 2;\r\n\t\t\t\t\r\n\t\t\t\tif (tone.supersawDelayLine == null || tone.supersawDelayLine.length <= minBufferLength) {\r\n\t\t\t\t\t// The delay line buffer will get reused for other tones so might as well\r\n\t\t\t\t\t// start off with a buffer size that is big enough for most notes.\r\n\t\t\t\t\tconst likelyMaximumLength: number = Math.ceil(0.5 * this.samplesPerSecond / Instrument.frequencyFromPitch(24));\r\n\t\t\t\t\tconst newDelayLine: Float32Array = new Float32Array(Synth.fittingPowerOfTwo(Math.max(likelyMaximumLength, minBufferLength)));\r\n\t\t\t\t\tif (!initializeSupersaw && tone.supersawDelayLine != null) {\r\n\t\t\t\t\t\t// If the tone has already started but the buffer needs to be reallocated,\r\n\t\t\t\t\t\t// transfer the old data to the new buffer.\r\n\t\t\t\t\t\tconst oldDelayBufferMask: number = (tone.supersawDelayLine.length - 1) >> 0;\r\n\t\t\t\t\t\tconst startCopyingFromIndex: number = tone.supersawDelayIndex;\r\n\t\t\t\t\t\tfor (let i: number = 0; i < tone.supersawDelayLine.length; i++) {\r\n\t\t\t\t\t\t\tnewDelayLine[i] = tone.supersawDelayLine[(startCopyingFromIndex + i) & oldDelayBufferMask];\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\ttone.supersawDelayLine = newDelayLine;\r\n\t\t\t\t\ttone.supersawDelayIndex = tone.supersawDelayLine.length;\r\n\t\t\t\t} else if (initializeSupersaw) {\r\n\t\t\t\t\ttone.supersawDelayLine.fill(0.0);\r\n\t\t\t\t\ttone.supersawDelayIndex = tone.supersawDelayLine.length;\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tconst pulseExpressionRatio: number = Config.pwmBaseExpression / Config.supersawBaseExpression;\r\n\t\t\t\tsupersawExpressionStart *= (1.0 + (pulseExpressionRatio - 1.0) * shapeStart) / Math.sqrt(1.0 + (Config.supersawVoiceCount - 1.0) * dynamismStart * dynamismStart);\r\n\t\t\t\tsupersawExpressionEnd *= (1.0 + (pulseExpressionRatio - 1.0) * shapeEnd) / Math.sqrt(1.0 + (Config.supersawVoiceCount - 1.0) * dynamismEnd * dynamismEnd);\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tconst expressionStart: number = settingsExpressionMult * fadeExpressionStart * chordExpressionStart * pitchExpressionStart * envelopeStarts[EnvelopeComputeIndex.noteVolume] * supersawExpressionStart;\r\n\t\t\tconst expressionEnd:   number = settingsExpressionMult * fadeExpressionEnd   * chordExpressionEnd   * pitchExpressionEnd   * envelopeEnds[  EnvelopeComputeIndex.noteVolume] * supersawExpressionEnd;\r\n\t\t\ttone.expression = expressionStart;\r\n\t\t\ttone.expressionDelta = (expressionEnd - expressionStart) / roundedSamplesPerTick;\r\n\t\t\t\r\n\t\t\tif (instrument.type == InstrumentType.pickedString) {\r\n\t\t\t\tlet stringDecayStart: number;\r\n\t\t\t\tif (tone.prevStringDecay != null) {\r\n\t\t\t\t\tstringDecayStart = tone.prevStringDecay;\r\n\t\t\t\t} else {\r\n\t\t\t\t\tconst sustainEnvelopeStart: number = tone.envelopeComputer.envelopeStarts[EnvelopeComputeIndex.stringSustain];\r\n\t\t\t\t\tstringDecayStart = 1.0 - Math.min(1.0, sustainEnvelopeStart * instrument.stringSustain / (Config.stringSustainRange - 1));\r\n\t\t\t\t}\r\n\t\t\t\tconst sustainEnvelopeEnd: number = tone.envelopeComputer.envelopeEnds[  EnvelopeComputeIndex.stringSustain];\r\n\t\t\t\tlet stringDecayEnd: number = 1.0 - Math.min(1.0, sustainEnvelopeEnd   * instrument.stringSustain / (Config.stringSustainRange - 1));\r\n\t\t\t\ttone.prevStringDecay = stringDecayEnd;\r\n\t\t\t\t\r\n\t\t\t\tconst unison: Unison = Config.unisons[instrument.unison];\r\n\t\t\t\tfor (let i: number = tone.pickedStrings.length; i < unison.voices; i++) {\r\n\t\t\t\t\ttone.pickedStrings[i] = new PickedString();\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tif (tone.atNoteStart && !transition.continues && !tone.forceContinueAtStart) {\r\n\t\t\t\t\tfor (const pickedString of tone.pickedStrings) {\r\n\t\t\t\t\t\t// Force the picked string to retrigger the attack impulse at the start of the note.\r\n\t\t\t\t\t\tpickedString.delayIndex = -1;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tfor (let i: number = 0; i < unison.voices; i++) {\r\n\t\t\t\t\ttone.pickedStrings[i].update(this, instrumentState, tone, i, roundedSamplesPerTick, stringDecayStart, stringDecayEnd, instrument.stringSustainType);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\t\r\n\tpublic static getLFOAmplitude(instrument: Instrument, secondsIntoBar: number): number {\r\n\t\tlet effect: number = 0.0;\r\n\t\tfor (const vibratoPeriodSeconds of Config.vibratos[instrument.vibrato].periodsSeconds) {\r\n\t\t\teffect += Math.sin(Math.PI * 2.0 * secondsIntoBar / vibratoPeriodSeconds);\r\n\t\t}\r\n\t\treturn effect;\r\n\t}\r\n\t\r\n\tpublic static getInstrumentSynthFunction(instrument: Instrument): Function {\r\n\t\tif (instrument.type == InstrumentType.fm) {\r\n\t\t\tconst fingerprint: string = instrument.algorithm + \"_\" + instrument.feedbackType;\r\n\t\t\tif (Synth.fmSynthFunctionCache[fingerprint] == undefined) {\r\n\t\t\t\tconst synthSource: string[] = [];\r\n\t\t\t\t\r\n\t\t\t\tfor (const line of Synth.fmSourceTemplate) {\r\n\t\t\t\t\tif (line.indexOf(\"// CARRIER OUTPUTS\") != -1) {\r\n\t\t\t\t\t\tconst outputs: string[] = [];\r\n\t\t\t\t\t\tfor (let j: number = 0; j < Config.algorithms[instrument.algorithm].carrierCount; j++) {\r\n\t\t\t\t\t\t\toutputs.push(\"operator\" + j + \"Scaled\");\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tsynthSource.push(line.replace(\"/*operator#Scaled*/\", outputs.join(\" + \")));\r\n\t\t\t\t\t} else if (line.indexOf(\"// INSERT OPERATOR COMPUTATION HERE\") != -1) {\r\n\t\t\t\t\t\tfor (let j: number = Config.operatorCount - 1; j >= 0; j--) {\r\n\t\t\t\t\t\t\tfor (const operatorLine of Synth.operatorSourceTemplate) {\r\n\t\t\t\t\t\t\t\tif (operatorLine.indexOf(\"/* + operator@Scaled*/\") != -1) {\r\n\t\t\t\t\t\t\t\t\tlet modulators = \"\";\r\n\t\t\t\t\t\t\t\t\tfor (const modulatorNumber of Config.algorithms[instrument.algorithm].modulatedBy[j]) {\r\n\t\t\t\t\t\t\t\t\t\tmodulators += \" + operator\" + (modulatorNumber - 1) + \"Scaled\";\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tconst feedbackIndices: ReadonlyArray<number> = Config.feedbacks[instrument.feedbackType].indices[j];\r\n\t\t\t\t\t\t\t\t\tif (feedbackIndices.length > 0) {\r\n\t\t\t\t\t\t\t\t\t\tmodulators += \" + feedbackMult * (\";\r\n\t\t\t\t\t\t\t\t\t\tconst feedbacks: string[] = [];\r\n\t\t\t\t\t\t\t\t\t\tfor (const modulatorNumber of feedbackIndices) {\r\n\t\t\t\t\t\t\t\t\t\t\tfeedbacks.push(\"operator\" + (modulatorNumber - 1) + \"Output\");\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\tmodulators += feedbacks.join(\" + \") + \")\";\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\tsynthSource.push(operatorLine.replace(/\\#/g, j + \"\").replace(\"/* + operator@Scaled*/\", modulators));\r\n\t\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\t\tsynthSource.push(operatorLine.replace(/\\#/g, j + \"\"));\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t} else if (line.indexOf(\"#\") != -1) {\r\n\t\t\t\t\t\tfor (let j: number = 0; j < Config.operatorCount; j++) {\r\n\t\t\t\t\t\t\tsynthSource.push(line.replace(/\\#/g, j + \"\"));\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tsynthSource.push(line);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\t//console.log(synthSource.join(\"\\n\"));\r\n\t\t\t\t\r\n\t\t\t\tconst wrappedFmSynth: string = \"return (synth, bufferIndex, runLength, tone, instrument) => {\" + synthSource.join(\"\\n\") + \"}\";\r\n\t\t\t\t\r\n\t\t\t\tSynth.fmSynthFunctionCache[fingerprint] = new Function(\"Config\", \"Synth\", wrappedFmSynth)(Config, Synth);\r\n\t\t\t}\r\n\t\t\treturn Synth.fmSynthFunctionCache[fingerprint];\r\n\t\t} else if (instrument.type == InstrumentType.chip) {\r\n\t\t\treturn Synth.chipSynth;\r\n\t\t} else if (instrument.type == InstrumentType.harmonics) {\r\n\t\t\treturn Synth.harmonicsSynth;\r\n\t\t} else if (instrument.type == InstrumentType.pwm) {\r\n\t\t\treturn Synth.pulseWidthSynth;\r\n\t\t} else if (instrument.type == InstrumentType.supersaw) {\r\n\t\t\treturn Synth.supersawSynth;\r\n\t\t} else if (instrument.type == InstrumentType.pickedString) {\r\n\t\t\treturn Synth.pickedStringSynth;\r\n\t\t} else if (instrument.type == InstrumentType.noise) {\r\n\t\t\treturn Synth.noiseSynth;\r\n\t\t} else if (instrument.type == InstrumentType.spectrum) {\r\n\t\t\treturn Synth.spectrumSynth;\r\n\t\t} else if (instrument.type == InstrumentType.drumset) {\r\n\t\t\treturn Synth.drumsetSynth;\r\n\t\t} else {\r\n\t\t\tthrow new Error(\"Unrecognized instrument type: \" + instrument.type);\r\n\t\t}\r\n\t}\r\n\t\r\n\tprivate static chipSynth(synth: Synth, bufferIndex: number, runLength: number, tone: Tone, instrumentState: InstrumentState): void {\r\n\t\tconst data: Float32Array = synth.tempMonoInstrumentSampleBuffer!;\r\n\t\tconst wave: Float32Array = instrumentState.wave!;\r\n\t\tconst waveLength: number = wave.length - 1; // The first sample is duplicated at the end, don't double-count it.\r\n\t\t\r\n\t\tconst unisonSign: number = tone.specialIntervalExpressionMult * instrumentState.unison!.sign;\r\n\t\tif (instrumentState.unison!.voices == 1 && !instrumentState.chord!.customInterval) tone.phases[1] = tone.phases[0];\r\n\t\tlet phaseDeltaA: number = tone.phaseDeltas[0] * waveLength;\r\n\t\tlet phaseDeltaB: number = tone.phaseDeltas[1] * waveLength;\r\n\t\tconst phaseDeltaScaleA: number = +tone.phaseDeltaScales[0];\r\n\t\tconst phaseDeltaScaleB: number = +tone.phaseDeltaScales[1];\r\n\t\tlet expression: number = +tone.expression;\r\n\t\tconst expressionDelta: number = +tone.expressionDelta;\r\n\t\tlet phaseA: number = (tone.phases[0] % 1) * waveLength;\r\n\t\tlet phaseB: number = (tone.phases[1] % 1) * waveLength;\r\n\t\t\r\n\t\tconst filters: DynamicBiquadFilter[] = tone.noteFilters;\r\n\t\tconst filterCount: number = tone.noteFilterCount|0;\r\n\t\tlet initialFilterInput1: number = +tone.initialNoteFilterInput1;\r\n\t\tlet initialFilterInput2: number = +tone.initialNoteFilterInput2;\r\n\t\tconst applyFilters: Function = Synth.applyFilters;\r\n\t\t\r\n\t\tconst phaseAInt: number = phaseA|0;\r\n\t\tconst phaseBInt: number = phaseB|0;\r\n\t\tconst indexA: number = phaseAInt % waveLength;\r\n\t\tconst indexB: number = phaseBInt % waveLength;\r\n\t\tconst phaseRatioA: number = phaseA - phaseAInt;\r\n\t\tconst phaseRatioB: number = phaseB - phaseBInt;\r\n\t\tlet prevWaveIntegralA: number = +wave[indexA];\r\n\t\tlet prevWaveIntegralB: number = +wave[indexB];\r\n\t\tprevWaveIntegralA += (wave[indexA+1] - prevWaveIntegralA) * phaseRatioA;\r\n\t\tprevWaveIntegralB += (wave[indexB+1] - prevWaveIntegralB) * phaseRatioB;\r\n\t\t\r\n\t\tconst stopIndex: number = bufferIndex + runLength;\r\n\t\tfor (let sampleIndex: number = bufferIndex; sampleIndex < stopIndex; sampleIndex++) {\r\n\t\t\t\r\n\t\t\tphaseA += phaseDeltaA;\r\n\t\t\tphaseB += phaseDeltaB;\r\n\t\t\t\r\n\t\t\tconst phaseAInt: number = phaseA|0;\r\n\t\t\tconst phaseBInt: number = phaseB|0;\r\n\t\t\tconst indexA: number = phaseAInt % waveLength;\r\n\t\t\tconst indexB: number = phaseBInt % waveLength;\r\n\t\t\tlet nextWaveIntegralA: number = wave[indexA];\r\n\t\t\tlet nextWaveIntegralB: number = wave[indexB];\r\n\t\t\tconst phaseRatioA: number = phaseA - phaseAInt;\r\n\t\t\tconst phaseRatioB: number = phaseB - phaseBInt;\r\n\t\t\tnextWaveIntegralA += (wave[indexA+1] - nextWaveIntegralA) * phaseRatioA;\r\n\t\t\tnextWaveIntegralB += (wave[indexB+1] - nextWaveIntegralB) * phaseRatioB;\r\n\t\t\tconst waveA: number = (nextWaveIntegralA - prevWaveIntegralA) / phaseDeltaA;\r\n\t\t\tconst waveB: number = (nextWaveIntegralB - prevWaveIntegralB) / phaseDeltaB;\r\n\t\t\tprevWaveIntegralA = nextWaveIntegralA;\r\n\t\t\tprevWaveIntegralB = nextWaveIntegralB;\r\n\t\t\t\r\n\t\t\tconst inputSample: number = waveA + waveB * unisonSign;\r\n\t\t\tconst sample: number = applyFilters(inputSample, initialFilterInput1, initialFilterInput2, filterCount, filters);\r\n\t\t\tinitialFilterInput2 = initialFilterInput1;\r\n\t\t\tinitialFilterInput1 = inputSample;\r\n\t\t\t\r\n\t\t\tphaseDeltaA *= phaseDeltaScaleA;\r\n\t\t\tphaseDeltaB *= phaseDeltaScaleB;\r\n\t\t\t\r\n\t\t\tconst output: number = sample * expression;\r\n\t\t\texpression += expressionDelta;\r\n\t\t\t\r\n\t\t\tdata[sampleIndex] += output;\r\n\t\t}\r\n\t\t\r\n\t\ttone.phases[0] = phaseA / waveLength;\r\n\t\ttone.phases[1] = phaseB / waveLength;\r\n\t\ttone.phaseDeltas[0] = phaseDeltaA / waveLength;\r\n\t\ttone.phaseDeltas[1] = phaseDeltaB / waveLength;\r\n\t\ttone.expression = expression;\r\n\t\t\r\n\t\tsynth.sanitizeFilters(filters);\r\n\t\ttone.initialNoteFilterInput1 = initialFilterInput1;\r\n\t\ttone.initialNoteFilterInput2 = initialFilterInput2;\r\n\t}\r\n\t\r\n\tprivate static harmonicsSynth(synth: Synth, bufferIndex: number, runLength: number, tone: Tone, instrumentState: InstrumentState): void {\r\n\t\tconst data: Float32Array = synth.tempMonoInstrumentSampleBuffer!;\r\n\t\tconst wave: Float32Array = instrumentState.wave!;\r\n\t\tconst waveLength: number = wave.length - 1; // The first sample is duplicated at the end, don't double-count it.\r\n\t\t\r\n\t\tconst unisonSign: number = tone.specialIntervalExpressionMult * instrumentState.unison!.sign;\r\n\t\tif (instrumentState.unison!.voices == 1 && !instrumentState.chord!.customInterval) tone.phases[1] = tone.phases[0];\r\n\t\tlet phaseDeltaA: number = tone.phaseDeltas[0] * waveLength;\r\n\t\tlet phaseDeltaB: number = tone.phaseDeltas[1] * waveLength;\r\n\t\tconst phaseDeltaScaleA: number = +tone.phaseDeltaScales[0];\r\n\t\tconst phaseDeltaScaleB: number = +tone.phaseDeltaScales[1];\r\n\t\tlet expression: number = +tone.expression;\r\n\t\tconst expressionDelta: number = +tone.expressionDelta;\r\n\t\tlet phaseA: number = (tone.phases[0] % 1) * waveLength;\r\n\t\tlet phaseB: number = (tone.phases[1] % 1) * waveLength;\r\n\t\t\r\n\t\tconst filters: DynamicBiquadFilter[] = tone.noteFilters;\r\n\t\tconst filterCount: number = tone.noteFilterCount|0;\r\n\t\tlet initialFilterInput1: number = +tone.initialNoteFilterInput1;\r\n\t\tlet initialFilterInput2: number = +tone.initialNoteFilterInput2;\r\n\t\tconst applyFilters: Function = Synth.applyFilters;\r\n\t\t\r\n\t\tconst phaseAInt: number = phaseA|0;\r\n\t\tconst phaseBInt: number = phaseB|0;\r\n\t\tconst indexA: number = phaseAInt % waveLength;\r\n\t\tconst indexB: number = phaseBInt % waveLength;\r\n\t\tconst phaseRatioA: number = phaseA - phaseAInt;\r\n\t\tconst phaseRatioB: number = phaseB - phaseBInt;\r\n\t\tlet prevWaveIntegralA: number = +wave[indexA];\r\n\t\tlet prevWaveIntegralB: number = +wave[indexB];\r\n\t\tprevWaveIntegralA += (wave[indexA+1] - prevWaveIntegralA) * phaseRatioA;\r\n\t\tprevWaveIntegralB += (wave[indexB+1] - prevWaveIntegralB) * phaseRatioB;\r\n\t\t\r\n\t\tconst stopIndex: number = bufferIndex + runLength;\r\n\t\tfor (let sampleIndex: number = bufferIndex; sampleIndex < stopIndex; sampleIndex++) {\r\n\t\t\t\r\n\t\t\tphaseA += phaseDeltaA;\r\n\t\t\tphaseB += phaseDeltaB;\r\n\t\t\t\r\n\t\t\tconst phaseAInt: number = phaseA|0;\r\n\t\t\tconst phaseBInt: number = phaseB|0;\r\n\t\t\tconst indexA: number = phaseAInt % waveLength;\r\n\t\t\tconst indexB: number = phaseBInt % waveLength;\r\n\t\t\tlet nextWaveIntegralA: number = wave[indexA];\r\n\t\t\tlet nextWaveIntegralB: number = wave[indexB];\r\n\t\t\tconst phaseRatioA: number = phaseA - phaseAInt;\r\n\t\t\tconst phaseRatioB: number = phaseB - phaseBInt;\r\n\t\t\tnextWaveIntegralA += (wave[indexA+1] - nextWaveIntegralA) * phaseRatioA;\r\n\t\t\tnextWaveIntegralB += (wave[indexB+1] - nextWaveIntegralB) * phaseRatioB;\r\n\t\t\tconst waveA: number = (nextWaveIntegralA - prevWaveIntegralA) / phaseDeltaA;\r\n\t\t\tconst waveB: number = (nextWaveIntegralB - prevWaveIntegralB) / phaseDeltaB;\r\n\t\t\tprevWaveIntegralA = nextWaveIntegralA;\r\n\t\t\tprevWaveIntegralB = nextWaveIntegralB;\r\n\t\t\t\r\n\t\t\tconst inputSample: number = waveA + waveB * unisonSign;\r\n\t\t\tconst sample: number = applyFilters(inputSample, initialFilterInput1, initialFilterInput2, filterCount, filters);\r\n\t\t\tinitialFilterInput2 = initialFilterInput1;\r\n\t\t\tinitialFilterInput1 = inputSample;\r\n\t\t\t\r\n\t\t\tphaseDeltaA *= phaseDeltaScaleA;\r\n\t\t\tphaseDeltaB *= phaseDeltaScaleB;\r\n\t\t\t\r\n\t\t\tconst output: number = sample * expression;\r\n\t\t\texpression += expressionDelta;\r\n\t\t\t\r\n\t\t\tdata[sampleIndex] += output;\r\n\t\t}\r\n\t\t\r\n\t\ttone.phases[0] = phaseA / waveLength;\r\n\t\ttone.phases[1] = phaseB / waveLength;\r\n\t\ttone.phaseDeltas[0] = phaseDeltaA / waveLength;\r\n\t\ttone.phaseDeltas[1] = phaseDeltaB / waveLength;\r\n\t\ttone.expression = expression;\r\n\t\t\r\n\t\tsynth.sanitizeFilters(filters);\r\n\t\ttone.initialNoteFilterInput1 = initialFilterInput1;\r\n\t\ttone.initialNoteFilterInput2 = initialFilterInput2;\r\n\t}\r\n\t\r\n\tprivate static pickedStringSynth(synth: Synth, bufferIndex: number, runLength: number, tone: Tone, instrumentState: InstrumentState): void {\r\n\t\t// This algorithm is similar to the Karpluss-Strong algorithm in principle, but with an\r\n\t\t// all-pass filter for dispersion and with more control over the impulse harmonics.\r\n\t\t// The source code is processed as a string before being compiled, in order to\r\n\t\t// handle the unison feature. If unison is disabled or set to none, then only one\r\n\t\t// string voice is required, otherwise two string voices are required. We only want\r\n\t\t// to compute the minimum possible number of string voices, so omit the code for\r\n\t\t// processing extra ones if possible. Any line containing a \"#\" is duplicated for\r\n\t\t// each required voice, replacing the \"#\" with the voice index.\r\n\t\t\r\n\t\tconst voiceCount: number = instrumentState.unison!.voices;\r\n\t\tlet pickedStringFunction: Function = Synth.pickedStringFunctionCache[voiceCount];\r\n\t\tif (pickedStringFunction == undefined) {\r\n\t\t\tlet pickedStringSource: string = \"return (synth, bufferIndex, runLength, tone, instrumentState) => {\";\r\n\t\t\t\r\n\t\t\tpickedStringSource += `\r\n\t\t\t\tconst data = synth.tempMonoInstrumentSampleBuffer;\r\n\t\t\t\t\r\n\t\t\t\tlet pickedString# = tone.pickedStrings[#];\r\n\t\t\t\tlet allPassSample# = +pickedString#.allPassSample;\r\n\t\t\t\tlet allPassPrevInput# = +pickedString#.allPassPrevInput;\r\n\t\t\t\tlet sustainFilterSample# = +pickedString#.sustainFilterSample;\r\n\t\t\t\tlet sustainFilterPrevOutput2# = +pickedString#.sustainFilterPrevOutput2;\r\n\t\t\t\tlet sustainFilterPrevInput1# = +pickedString#.sustainFilterPrevInput1;\r\n\t\t\t\tlet sustainFilterPrevInput2# = +pickedString#.sustainFilterPrevInput2;\r\n\t\t\t\tlet fractionalDelaySample# = +pickedString#.fractionalDelaySample;\r\n\t\t\t\tconst delayLine# = pickedString#.delayLine;\r\n\t\t\t\tconst delayBufferMask# = (delayLine#.length - 1) >> 0;\r\n\t\t\t\tlet delayIndex# = pickedString#.delayIndex|0;\r\n\t\t\t\tdelayIndex# = (delayIndex# & delayBufferMask#) + delayLine#.length;\r\n\t\t\t\tlet delayLength# = +pickedString#.prevDelayLength;\r\n\t\t\t\tconst delayLengthDelta# = +pickedString#.delayLengthDelta;\r\n\t\t\t\tlet allPassG# = +pickedString#.allPassG;\r\n\t\t\t\tlet sustainFilterA1# = +pickedString#.sustainFilterA1;\r\n\t\t\t\tlet sustainFilterA2# = +pickedString#.sustainFilterA2;\r\n\t\t\t\tlet sustainFilterB0# = +pickedString#.sustainFilterB0;\r\n\t\t\t\tlet sustainFilterB1# = +pickedString#.sustainFilterB1;\r\n\t\t\t\tlet sustainFilterB2# = +pickedString#.sustainFilterB2;\r\n\t\t\t\tconst allPassGDelta# = +pickedString#.allPassGDelta;\r\n\t\t\t\tconst sustainFilterA1Delta# = +pickedString#.sustainFilterA1Delta;\r\n\t\t\t\tconst sustainFilterA2Delta# = +pickedString#.sustainFilterA2Delta;\r\n\t\t\t\tconst sustainFilterB0Delta# = +pickedString#.sustainFilterB0Delta;\r\n\t\t\t\tconst sustainFilterB1Delta# = +pickedString#.sustainFilterB1Delta;\r\n\t\t\t\tconst sustainFilterB2Delta# = +pickedString#.sustainFilterB2Delta;\r\n\t\t\t\t\r\n\t\t\t\tlet expression = +tone.expression;\r\n\t\t\t\tconst expressionDelta = +tone.expressionDelta;\r\n\t\t\t\t\r\n\t\t\t\tconst unisonSign = tone.specialIntervalExpressionMult * instrumentState.unison.sign;\r\n\t\t\t\tconst delayResetOffset# = pickedString#.delayResetOffset|0;\r\n\t\t\t\t\r\n\t\t\t\tconst filters = tone.noteFilters;\r\n\t\t\t\tconst filterCount = tone.noteFilterCount|0;\r\n\t\t\t\tlet initialFilterInput1 = +tone.initialNoteFilterInput1;\r\n\t\t\t\tlet initialFilterInput2 = +tone.initialNoteFilterInput2;\r\n\t\t\t\tconst applyFilters = Synth.applyFilters;\r\n\t\t\t\t\r\n\t\t\t\tconst stopIndex = bufferIndex + runLength;\r\n\t\t\t\tfor (let sampleIndex = bufferIndex; sampleIndex < stopIndex; sampleIndex++) {\r\n\t\t\t\t\tconst targetSampleTime# = delayIndex# - delayLength#;\r\n\t\t\t\t\tconst lowerIndex# = (targetSampleTime# + 0.125) | 0; // Offset to improve stability of all-pass filter.\r\n\t\t\t\t\tconst upperIndex# = lowerIndex# + 1;\r\n\t\t\t\t\tconst fractionalDelay# = upperIndex# - targetSampleTime#;\r\n\t\t\t\t\tconst fractionalDelayG# = (1.0 - fractionalDelay#) / (1.0 + fractionalDelay#); // Inlined version of FilterCoefficients.prototype.allPass1stOrderFractionalDelay\r\n\t\t\t\t\tconst prevInput# = delayLine#[lowerIndex# & delayBufferMask#];\r\n\t\t\t\t\tconst input# = delayLine#[upperIndex# & delayBufferMask#];\r\n\t\t\t\t\tfractionalDelaySample# = fractionalDelayG# * input# + prevInput# - fractionalDelayG# * fractionalDelaySample#;\r\n\t\t\t\t\t\r\n\t\t\t\t\tallPassSample# = fractionalDelaySample# * allPassG# + allPassPrevInput# - allPassG# * allPassSample#;\r\n\t\t\t\t\tallPassPrevInput# = fractionalDelaySample#;\r\n\t\t\t\t\t\r\n\t\t\t\t\tconst sustainFilterPrevOutput1# = sustainFilterSample#;\r\n\t\t\t\t\tsustainFilterSample# = sustainFilterB0# * allPassSample# + sustainFilterB1# * sustainFilterPrevInput1# + sustainFilterB2# * sustainFilterPrevInput2# - sustainFilterA1# * sustainFilterSample# - sustainFilterA2# * sustainFilterPrevOutput2#;\r\n\t\t\t\t\tsustainFilterPrevOutput2# = sustainFilterPrevOutput1#;\r\n\t\t\t\t\tsustainFilterPrevInput2# = sustainFilterPrevInput1#;\r\n\t\t\t\t\tsustainFilterPrevInput1# = allPassSample#;\r\n\t\t\t\t\t\r\n\t\t\t\t\tdelayLine#[delayIndex# & delayBufferMask#] += sustainFilterSample#;\r\n\t\t\t\t\tdelayLine#[(delayIndex# + delayResetOffset#) & delayBufferMask#] = 0.0;\r\n\t\t\t\t\tdelayIndex#++;\r\n\t\t\t\t\t\r\n\t\t\t\t\tconst inputSample = (`\r\n\t\t\t\r\n\t\t\tconst sampleList: string[] = [];\r\n\t\t\tfor (let voice: number = 0; voice < voiceCount; voice++) {\r\n\t\t\t\tsampleList.push(\"fractionalDelaySample\" + voice + (voice == 1 ? \" * unisonSign\" : \"\"));\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tpickedStringSource += sampleList.join(\" + \");\r\n\t\t\t\r\n\t\t\tpickedStringSource += `) * expression;\r\n\t\t\t\t\tconst sample = applyFilters(inputSample, initialFilterInput1, initialFilterInput2, filterCount, filters);\r\n\t\t\t\t\tinitialFilterInput2 = initialFilterInput1;\r\n\t\t\t\t\tinitialFilterInput1 = inputSample;\r\n\t\t\t\t\tdata[sampleIndex] += sample;\r\n\t\t\t\t\t\r\n\t\t\t\t\texpression += expressionDelta;\r\n\t\t\t\t\tdelayLength# += delayLengthDelta#;\r\n\t\t\t\t\tallPassG# += allPassGDelta#;\r\n\t\t\t\t\tsustainFilterA1# += sustainFilterA1Delta#;\r\n\t\t\t\t\tsustainFilterA2# += sustainFilterA2Delta#;\r\n\t\t\t\t\tsustainFilterB0# += sustainFilterB0Delta#;\r\n\t\t\t\t\tsustainFilterB1# += sustainFilterB1Delta#;\r\n\t\t\t\t\tsustainFilterB2# += sustainFilterB2Delta#;\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\t// Avoid persistent denormal or NaN values in the delay buffers and filter history.\r\n\t\t\t\tconst epsilon = (1.0e-24);\r\n\t\t\t\tif (!Number.isFinite(allPassSample#) || Math.abs(allPassSample#) < epsilon) allPassSample# = 0.0;\r\n\t\t\t\tif (!Number.isFinite(allPassPrevInput#) || Math.abs(allPassPrevInput#) < epsilon) allPassPrevInput# = 0.0;\r\n\t\t\t\tif (!Number.isFinite(sustainFilterSample#) || Math.abs(sustainFilterSample#) < epsilon) sustainFilterSample# = 0.0;\r\n\t\t\t\tif (!Number.isFinite(sustainFilterPrevOutput2#) || Math.abs(sustainFilterPrevOutput2#) < epsilon) sustainFilterPrevOutput2# = 0.0;\r\n\t\t\t\tif (!Number.isFinite(sustainFilterPrevInput1#) || Math.abs(sustainFilterPrevInput1#) < epsilon) sustainFilterPrevInput1# = 0.0;\r\n\t\t\t\tif (!Number.isFinite(sustainFilterPrevInput2#) || Math.abs(sustainFilterPrevInput2#) < epsilon) sustainFilterPrevInput2# = 0.0;\r\n\t\t\t\tif (!Number.isFinite(fractionalDelaySample#) || Math.abs(fractionalDelaySample#) < epsilon) fractionalDelaySample# = 0.0;\r\n\t\t\t\tpickedString#.allPassSample = allPassSample#;\r\n\t\t\t\tpickedString#.allPassPrevInput = allPassPrevInput#;\r\n\t\t\t\tpickedString#.sustainFilterSample = sustainFilterSample#;\r\n\t\t\t\tpickedString#.sustainFilterPrevOutput2 = sustainFilterPrevOutput2#;\r\n\t\t\t\tpickedString#.sustainFilterPrevInput1 = sustainFilterPrevInput1#;\r\n\t\t\t\tpickedString#.sustainFilterPrevInput2 = sustainFilterPrevInput2#;\r\n\t\t\t\tpickedString#.fractionalDelaySample = fractionalDelaySample#;\r\n\t\t\t\tpickedString#.delayIndex = delayIndex#;\r\n\t\t\t\tpickedString#.prevDelayLength = delayLength#;\r\n\t\t\t\tpickedString#.allPassG = allPassG#;\r\n\t\t\t\tpickedString#.sustainFilterA1 = sustainFilterA1#;\r\n\t\t\t\tpickedString#.sustainFilterA2 = sustainFilterA2#;\r\n\t\t\t\tpickedString#.sustainFilterB0 = sustainFilterB0#;\r\n\t\t\t\tpickedString#.sustainFilterB1 = sustainFilterB1#;\r\n\t\t\t\tpickedString#.sustainFilterB2 = sustainFilterB2#;\r\n\t\t\t\t\r\n\t\t\t\ttone.expression = expression;\r\n\t\t\t\t\r\n\t\t\t\tsynth.sanitizeFilters(filters);\r\n\t\t\t\ttone.initialNoteFilterInput1 = initialFilterInput1;\r\n\t\t\t\ttone.initialNoteFilterInput2 = initialFilterInput2;\r\n\t\t\t}`\r\n\t\t\t\r\n\t\t\t// Duplicate lines containing \"#\" for each voice and replace the \"#\" with the voice index.\r\n\t\t\tpickedStringSource = pickedStringSource.replace(/^.*\\#.*$/mg, line => {\r\n\t\t\t\tconst lines = [];\r\n\t\t\t\tfor (let voice: number = 0; voice < voiceCount; voice++) {\r\n\t\t\t\t\tlines.push(line.replace(/\\#/g, String(voice)));\r\n\t\t\t\t}\r\n\t\t\t\treturn lines.join(\"\\n\");\r\n\t\t\t});\r\n\t\t\t\r\n\t\t\t//console.log(pickedStringSource);\r\n\t\t\tpickedStringFunction = new Function(\"Config\", \"Synth\", pickedStringSource)(Config, Synth);\r\n\t\t\tSynth.pickedStringFunctionCache[voiceCount] = pickedStringFunction;\r\n\t\t}\r\n\t\t\r\n\t\tpickedStringFunction(synth, bufferIndex, runLength, tone, instrumentState);\r\n\t}\r\n\t\r\n\tprivate static effectsSynth(synth: Synth, outputDataL: Float32Array, outputDataR: Float32Array, bufferIndex: number, runLength: number, instrumentState: InstrumentState): void {\r\n\t\t// TODO: If automation is involved, don't assume sliders will stay at zero.\r\n\t\tconst usesDistortion: boolean = effectsIncludeDistortion(instrumentState.effects);\r\n\t\tconst usesBitcrusher: boolean = effectsIncludeBitcrusher(instrumentState.effects);\r\n\t\tconst usesEqFilter: boolean = instrumentState.eqFilterCount > 0;\r\n\t\tconst usesPanning: boolean = effectsIncludePanning(instrumentState.effects);\r\n\t\tconst usesChorus: boolean = effectsIncludeChorus(instrumentState.effects);\r\n\t\tconst usesEcho: boolean = effectsIncludeEcho(instrumentState.effects);\r\n\t\tconst usesReverb: boolean = effectsIncludeReverb(instrumentState.effects);\r\n\t\tlet signature: number = 0;  if (usesDistortion) signature = signature | 1;\r\n\t\tsignature = signature << 1; if (usesBitcrusher) signature = signature | 1;\r\n\t\tsignature = signature << 1; if (usesEqFilter) signature = signature | 1;\r\n\t\tsignature = signature << 1; if (usesPanning) signature = signature | 1;\r\n\t\tsignature = signature << 1; if (usesChorus) signature = signature | 1;\r\n\t\tsignature = signature << 1; if (usesEcho) signature = signature | 1;\r\n\t\tsignature = signature << 1; if (usesReverb) signature = signature | 1;\r\n\t\t\r\n\t\tlet effectsFunction: Function = Synth.effectsFunctionCache[signature];\r\n\t\tif (effectsFunction == undefined) {\r\n\t\t\tlet effectsSource: string = \"return (synth, outputDataL, outputDataR, bufferIndex, runLength, instrumentState) => {\";\r\n\t\t\t\r\n\t\t\tconst usesDelays: boolean = usesChorus || usesReverb || usesEcho;\r\n\t\t\t\r\n\t\t\teffectsSource += `\r\n\t\t\t\tconst tempMonoInstrumentSampleBuffer = synth.tempMonoInstrumentSampleBuffer;\r\n\t\t\t\t\r\n\t\t\t\tlet mixVolume = +instrumentState.mixVolume;\r\n\t\t\t\tconst mixVolumeDelta = +instrumentState.mixVolumeDelta;`\r\n\t\t\t\r\n\t\t\tif (usesDelays) {\r\n\t\t\t\teffectsSource += `\r\n\t\t\t\t\r\n\t\t\t\tlet delayInputMult = +instrumentState.delayInputMult;\r\n\t\t\t\tconst delayInputMultDelta = +instrumentState.delayInputMultDelta;`\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tif (usesDistortion) {\r\n\t\t\t\t// Distortion can sometimes create noticeable aliasing.\r\n\t\t\t\t// It seems the established industry best practice for distortion antialiasing\r\n\t\t\t\t// is to upsample the inputs (\"zero stuffing\" followed by a brick wall lowpass\r\n\t\t\t\t// at the original nyquist frequency), perform the distortion, then downsample\r\n\t\t\t\t// (the lowpass again followed by dropping in-between samples). This is\r\n\t\t\t\t// \"mathematically correct\" in that it preserves only the intended frequencies,\r\n\t\t\t\t// but it has several unfortunate tradeoffs depending on the choice of filter,\r\n\t\t\t\t// introducing latency and/or time smearing, since no true brick wall filter\r\n\t\t\t\t// exists. For the time being, I've opted to instead generate in-between input\r\n\t\t\t\t// samples using fractional delay all-pass filters, and after distorting them,\r\n\t\t\t\t// I \"downsample\" these with a simple weighted sum.\r\n\t\t\t\t\r\n\t\t\t\teffectsSource += `\r\n\t\t\t\t\r\n\t\t\t\tconst distortionBaseVolume = +Config.distortionBaseVolume;\r\n\t\t\t\tlet distortion = instrumentState.distortion;\r\n\t\t\t\tconst distortionDelta = instrumentState.distortionDelta;\r\n\t\t\t\tlet distortionDrive = instrumentState.distortionDrive;\r\n\t\t\t\tconst distortionDriveDelta = instrumentState.distortionDriveDelta;\r\n\t\t\t\tconst distortionFractionalResolution = 4.0;\r\n\t\t\t\tconst distortionOversampleCompensation = distortionBaseVolume / distortionFractionalResolution;\r\n\t\t\t\tconst distortionFractionalDelay1 = 1.0 / distortionFractionalResolution;\r\n\t\t\t\tconst distortionFractionalDelay2 = 2.0 / distortionFractionalResolution;\r\n\t\t\t\tconst distortionFractionalDelay3 = 3.0 / distortionFractionalResolution;\r\n\t\t\t\tconst distortionFractionalDelayG1 = (1.0 - distortionFractionalDelay1) / (1.0 + distortionFractionalDelay1); // Inlined version of FilterCoefficients.prototype.allPass1stOrderFractionalDelay\r\n\t\t\t\tconst distortionFractionalDelayG2 = (1.0 - distortionFractionalDelay2) / (1.0 + distortionFractionalDelay2); // Inlined version of FilterCoefficients.prototype.allPass1stOrderFractionalDelay\r\n\t\t\t\tconst distortionFractionalDelayG3 = (1.0 - distortionFractionalDelay3) / (1.0 + distortionFractionalDelay3); // Inlined version of FilterCoefficients.prototype.allPass1stOrderFractionalDelay\r\n\t\t\t\tconst distortionNextOutputWeight1 = Math.cos(Math.PI * distortionFractionalDelay1) * 0.5 + 0.5;\r\n\t\t\t\tconst distortionNextOutputWeight2 = Math.cos(Math.PI * distortionFractionalDelay2) * 0.5 + 0.5;\r\n\t\t\t\tconst distortionNextOutputWeight3 = Math.cos(Math.PI * distortionFractionalDelay3) * 0.5 + 0.5;\r\n\t\t\t\tconst distortionPrevOutputWeight1 = 1.0 - distortionNextOutputWeight1;\r\n\t\t\t\tconst distortionPrevOutputWeight2 = 1.0 - distortionNextOutputWeight2;\r\n\t\t\t\tconst distortionPrevOutputWeight3 = 1.0 - distortionNextOutputWeight3;\r\n\t\t\t\t\r\n\t\t\t\tlet distortionFractionalInput1 = +instrumentState.distortionFractionalInput1;\r\n\t\t\t\tlet distortionFractionalInput2 = +instrumentState.distortionFractionalInput2;\r\n\t\t\t\tlet distortionFractionalInput3 = +instrumentState.distortionFractionalInput3;\r\n\t\t\t\tlet distortionPrevInput = +instrumentState.distortionPrevInput;\r\n\t\t\t\tlet distortionNextOutput = +instrumentState.distortionNextOutput;`\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tif (usesBitcrusher) {\r\n\t\t\t\teffectsSource += `\r\n\t\t\t\t\r\n\t\t\t\tlet bitcrusherPrevInput = +instrumentState.bitcrusherPrevInput;\r\n\t\t\t\tlet bitcrusherCurrentOutput = +instrumentState.bitcrusherCurrentOutput;\r\n\t\t\t\tlet bitcrusherPhase = +instrumentState.bitcrusherPhase;\r\n\t\t\t\tlet bitcrusherPhaseDelta = +instrumentState.bitcrusherPhaseDelta;\r\n\t\t\t\tconst bitcrusherPhaseDeltaScale = +instrumentState.bitcrusherPhaseDeltaScale;\r\n\t\t\t\tlet bitcrusherScale = +instrumentState.bitcrusherScale;\r\n\t\t\t\tconst bitcrusherScaleScale = +instrumentState.bitcrusherScaleScale;\r\n\t\t\t\tlet bitcrusherFoldLevel = +instrumentState.bitcrusherFoldLevel;\r\n\t\t\t\tconst bitcrusherFoldLevelScale = +instrumentState.bitcrusherFoldLevelScale;`\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tif (usesEqFilter) {\r\n\t\t\t\teffectsSource += `\r\n\t\t\t\t\r\n\t\t\t\tlet filters = instrumentState.eqFilters;\r\n\t\t\t\tconst filterCount = instrumentState.eqFilterCount|0;\r\n\t\t\t\tlet initialFilterInput1 = +instrumentState.initialEqFilterInput1;\r\n\t\t\t\tlet initialFilterInput2 = +instrumentState.initialEqFilterInput2;\r\n\t\t\t\tconst applyFilters = Synth.applyFilters;`\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t// The eq filter volume is also used to fade out the instrument state, so always include it.\r\n\t\t\teffectsSource += `\r\n\t\t\t\t\r\n\t\t\t\tlet eqFilterVolume = +instrumentState.eqFilterVolume;\r\n\t\t\t\tconst eqFilterVolumeDelta = +instrumentState.eqFilterVolumeDelta;`\r\n\t\t\t\r\n\t\t\tif (usesPanning) {\r\n\t\t\t\teffectsSource += `\r\n\t\t\t\t\r\n\t\t\t\tconst panningMask = synth.panningDelayBufferMask >>> 0;\r\n\t\t\t\tconst panningDelayLine = instrumentState.panningDelayLine;\r\n\t\t\t\tlet panningDelayPos = instrumentState.panningDelayPos & panningMask;\r\n\t\t\t\tlet   panningVolumeL      = +instrumentState.panningVolumeL;\r\n\t\t\t\tlet   panningVolumeR      = +instrumentState.panningVolumeR;\r\n\t\t\t\tconst panningVolumeDeltaL = +instrumentState.panningVolumeDeltaL;\r\n\t\t\t\tconst panningVolumeDeltaR = +instrumentState.panningVolumeDeltaR;\r\n\t\t\t\tlet   panningOffsetL      = +instrumentState.panningOffsetL;\r\n\t\t\t\tlet   panningOffsetR      = +instrumentState.panningOffsetR;\r\n\t\t\t\tconst panningOffsetDeltaL = 1.0 - instrumentState.panningOffsetDeltaL;\r\n\t\t\t\tconst panningOffsetDeltaR = 1.0 - instrumentState.panningOffsetDeltaR;`\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tif (usesChorus) {\r\n\t\t\t\teffectsSource += `\r\n\t\t\t\t\r\n\t\t\t\tconst chorusMask = synth.chorusDelayBufferMask >>> 0;\r\n\t\t\t\tconst chorusDelayLineL = instrumentState.chorusDelayLineL;\r\n\t\t\t\tconst chorusDelayLineR = instrumentState.chorusDelayLineR;\r\n\t\t\t\tinstrumentState.chorusDelayLineDirty = true;\r\n\t\t\t\tlet chorusDelayPos = instrumentState.chorusDelayPos & chorusMask;\r\n\t\t\t\t\r\n\t\t\t\tlet chorusVoiceMult = +instrumentState.chorusVoiceMult;\r\n\t\t\t\tconst chorusVoiceMultDelta = +instrumentState.chorusVoiceMultDelta;\r\n\t\t\t\tlet chorusCombinedMult = +instrumentState.chorusCombinedMult;\r\n\t\t\t\tconst chorusCombinedMultDelta = +instrumentState.chorusCombinedMultDelta;\r\n\t\t\t\t\r\n\t\t\t\tconst chorusDuration = +Config.chorusPeriodSeconds;\r\n\t\t\t\tconst chorusAngle = Math.PI * 2.0 / (chorusDuration * synth.samplesPerSecond);\r\n\t\t\t\tconst chorusRange = synth.samplesPerSecond * Config.chorusDelayRange;\r\n\t\t\t\tconst chorusOffset0 = synth.chorusDelayBufferSize - Config.chorusDelayOffsets[0][0] * chorusRange;\r\n\t\t\t\tconst chorusOffset1 = synth.chorusDelayBufferSize - Config.chorusDelayOffsets[0][1] * chorusRange;\r\n\t\t\t\tconst chorusOffset2 = synth.chorusDelayBufferSize - Config.chorusDelayOffsets[0][2] * chorusRange;\r\n\t\t\t\tconst chorusOffset3 = synth.chorusDelayBufferSize - Config.chorusDelayOffsets[1][0] * chorusRange;\r\n\t\t\t\tconst chorusOffset4 = synth.chorusDelayBufferSize - Config.chorusDelayOffsets[1][1] * chorusRange;\r\n\t\t\t\tconst chorusOffset5 = synth.chorusDelayBufferSize - Config.chorusDelayOffsets[1][2] * chorusRange;\r\n\t\t\t\tlet chorusPhase = instrumentState.chorusPhase % (Math.PI * 2.0);\r\n\t\t\t\tlet chorusTap0Index = chorusDelayPos + chorusOffset0 - chorusRange * Math.sin(chorusPhase + Config.chorusPhaseOffsets[0][0]);\r\n\t\t\t\tlet chorusTap1Index = chorusDelayPos + chorusOffset1 - chorusRange * Math.sin(chorusPhase + Config.chorusPhaseOffsets[0][1]);\r\n\t\t\t\tlet chorusTap2Index = chorusDelayPos + chorusOffset2 - chorusRange * Math.sin(chorusPhase + Config.chorusPhaseOffsets[0][2]);\r\n\t\t\t\tlet chorusTap3Index = chorusDelayPos + chorusOffset3 - chorusRange * Math.sin(chorusPhase + Config.chorusPhaseOffsets[1][0]);\r\n\t\t\t\tlet chorusTap4Index = chorusDelayPos + chorusOffset4 - chorusRange * Math.sin(chorusPhase + Config.chorusPhaseOffsets[1][1]);\r\n\t\t\t\tlet chorusTap5Index = chorusDelayPos + chorusOffset5 - chorusRange * Math.sin(chorusPhase + Config.chorusPhaseOffsets[1][2]);\r\n\t\t\t\tchorusPhase += chorusAngle * runLength;\r\n\t\t\t\tconst chorusTap0End = chorusDelayPos + chorusOffset0 - chorusRange * Math.sin(chorusPhase + Config.chorusPhaseOffsets[0][0]) + runLength;\r\n\t\t\t\tconst chorusTap1End = chorusDelayPos + chorusOffset1 - chorusRange * Math.sin(chorusPhase + Config.chorusPhaseOffsets[0][1]) + runLength;\r\n\t\t\t\tconst chorusTap2End = chorusDelayPos + chorusOffset2 - chorusRange * Math.sin(chorusPhase + Config.chorusPhaseOffsets[0][2]) + runLength;\r\n\t\t\t\tconst chorusTap3End = chorusDelayPos + chorusOffset3 - chorusRange * Math.sin(chorusPhase + Config.chorusPhaseOffsets[1][0]) + runLength;\r\n\t\t\t\tconst chorusTap4End = chorusDelayPos + chorusOffset4 - chorusRange * Math.sin(chorusPhase + Config.chorusPhaseOffsets[1][1]) + runLength;\r\n\t\t\t\tconst chorusTap5End = chorusDelayPos + chorusOffset5 - chorusRange * Math.sin(chorusPhase + Config.chorusPhaseOffsets[1][2]) + runLength;\r\n\t\t\t\tconst chorusTap0Delta = (chorusTap0End - chorusTap0Index) / runLength;\r\n\t\t\t\tconst chorusTap1Delta = (chorusTap1End - chorusTap1Index) / runLength;\r\n\t\t\t\tconst chorusTap2Delta = (chorusTap2End - chorusTap2Index) / runLength;\r\n\t\t\t\tconst chorusTap3Delta = (chorusTap3End - chorusTap3Index) / runLength;\r\n\t\t\t\tconst chorusTap4Delta = (chorusTap4End - chorusTap4Index) / runLength;\r\n\t\t\t\tconst chorusTap5Delta = (chorusTap5End - chorusTap5Index) / runLength;`\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tif (usesEcho) {\r\n\t\t\t\teffectsSource += `\r\n\t\t\t\t\r\n\t\t\t\tlet echoMult = +instrumentState.echoMult;\r\n\t\t\t\tconst echoMultDelta = +instrumentState.echoMultDelta;\r\n\t\t\t\t\r\n\t\t\t\tconst echoDelayLineL = instrumentState.echoDelayLineL;\r\n\t\t\t\tconst echoDelayLineR = instrumentState.echoDelayLineR;\r\n\t\t\t\tconst echoMask = (echoDelayLineL.length - 1) >>> 0;\r\n\t\t\t\tinstrumentState.echoDelayLineDirty = true;\r\n\t\t\t\t\r\n\t\t\t\tlet echoDelayPos = instrumentState.echoDelayPos & echoMask;\r\n\t\t\t\tconst echoDelayOffsetStart = (echoDelayLineL.length - instrumentState.echoDelayOffsetStart) & echoMask;\r\n\t\t\t\tconst echoDelayOffsetEnd   = (echoDelayLineL.length - instrumentState.echoDelayOffsetEnd) & echoMask;\r\n\t\t\t\tlet echoDelayOffsetRatio = +instrumentState.echoDelayOffsetRatio;\r\n\t\t\t\tconst echoDelayOffsetRatioDelta = +instrumentState.echoDelayOffsetRatioDelta;\r\n\t\t\t\t\r\n\t\t\t\tconst echoShelfA1 = +instrumentState.echoShelfA1;\r\n\t\t\t\tconst echoShelfB0 = +instrumentState.echoShelfB0;\r\n\t\t\t\tconst echoShelfB1 = +instrumentState.echoShelfB1;\r\n\t\t\t\tlet echoShelfSampleL = +instrumentState.echoShelfSampleL;\r\n\t\t\t\tlet echoShelfSampleR = +instrumentState.echoShelfSampleR;\r\n\t\t\t\tlet echoShelfPrevInputL = +instrumentState.echoShelfPrevInputL;\r\n\t\t\t\tlet echoShelfPrevInputR = +instrumentState.echoShelfPrevInputR;`\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tif (usesReverb) {\r\n\t\t\t\teffectsSource += `\r\n\t\t\t\t\r\n\t\t\t\tconst reverbMask = Config.reverbDelayBufferMask >>> 0; //TODO: Dynamic reverb buffer size.\r\n\t\t\t\tconst reverbDelayLine = instrumentState.reverbDelayLine;\r\n\t\t\t\tinstrumentState.reverbDelayLineDirty = true;\r\n\t\t\t\tlet reverbDelayPos = instrumentState.reverbDelayPos & reverbMask;\r\n\t\t\t\t\r\n\t\t\t\tlet reverb = +instrumentState.reverbMult;\r\n\t\t\t\tconst reverbDelta = +instrumentState.reverbMultDelta;\r\n\t\t\t\t\r\n\t\t\t\tconst reverbShelfA1 = +instrumentState.reverbShelfA1;\r\n\t\t\t\tconst reverbShelfB0 = +instrumentState.reverbShelfB0;\r\n\t\t\t\tconst reverbShelfB1 = +instrumentState.reverbShelfB1;\r\n\t\t\t\tlet reverbShelfSample0 = +instrumentState.reverbShelfSample0;\r\n\t\t\t\tlet reverbShelfSample1 = +instrumentState.reverbShelfSample1;\r\n\t\t\t\tlet reverbShelfSample2 = +instrumentState.reverbShelfSample2;\r\n\t\t\t\tlet reverbShelfSample3 = +instrumentState.reverbShelfSample3;\r\n\t\t\t\tlet reverbShelfPrevInput0 = +instrumentState.reverbShelfPrevInput0;\r\n\t\t\t\tlet reverbShelfPrevInput1 = +instrumentState.reverbShelfPrevInput1;\r\n\t\t\t\tlet reverbShelfPrevInput2 = +instrumentState.reverbShelfPrevInput2;\r\n\t\t\t\tlet reverbShelfPrevInput3 = +instrumentState.reverbShelfPrevInput3;`\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\teffectsSource += `\r\n\t\t\t\t\r\n\t\t\t\tconst stopIndex = bufferIndex + runLength;\r\n\t\t\t\tfor (let sampleIndex = bufferIndex; sampleIndex < stopIndex; sampleIndex++) {\r\n\t\t\t\t\tlet sample = tempMonoInstrumentSampleBuffer[sampleIndex];\r\n\t\t\t\t\ttempMonoInstrumentSampleBuffer[sampleIndex] = 0.0;`\r\n\t\t\t\r\n\t\t\tif (usesDistortion) {\r\n\t\t\t\teffectsSource += `\r\n\t\t\t\t\t\r\n\t\t\t\t\tconst distortionReverse = 1.0 - distortion;\r\n\t\t\t\t\tconst distortionNextInput = sample * distortionDrive;\r\n\t\t\t\t\tsample = distortionNextOutput;\r\n\t\t\t\t\tdistortionNextOutput = distortionNextInput / (distortionReverse * Math.abs(distortionNextInput) + distortion);\r\n\t\t\t\t\tdistortionFractionalInput1 = distortionFractionalDelayG1 * distortionNextInput + distortionPrevInput - distortionFractionalDelayG1 * distortionFractionalInput1;\r\n\t\t\t\t\tdistortionFractionalInput2 = distortionFractionalDelayG2 * distortionNextInput + distortionPrevInput - distortionFractionalDelayG2 * distortionFractionalInput2;\r\n\t\t\t\t\tdistortionFractionalInput3 = distortionFractionalDelayG3 * distortionNextInput + distortionPrevInput - distortionFractionalDelayG3 * distortionFractionalInput3;\r\n\t\t\t\t\tconst distortionOutput1 = distortionFractionalInput1 / (distortionReverse * Math.abs(distortionFractionalInput1) + distortion);\r\n\t\t\t\t\tconst distortionOutput2 = distortionFractionalInput2 / (distortionReverse * Math.abs(distortionFractionalInput2) + distortion);\r\n\t\t\t\t\tconst distortionOutput3 = distortionFractionalInput3 / (distortionReverse * Math.abs(distortionFractionalInput3) + distortion);\r\n\t\t\t\t\tdistortionNextOutput += distortionOutput1 * distortionNextOutputWeight1 + distortionOutput2 * distortionNextOutputWeight2 + distortionOutput3 * distortionNextOutputWeight3;\r\n\t\t\t\t\tsample += distortionOutput1 * distortionPrevOutputWeight1 + distortionOutput2 * distortionPrevOutputWeight2 + distortionOutput3 * distortionPrevOutputWeight3;\r\n\t\t\t\t\tsample *= distortionOversampleCompensation;\r\n\t\t\t\t\tdistortionPrevInput = distortionNextInput;\r\n\t\t\t\t\tdistortion += distortionDelta;\r\n\t\t\t\t\tdistortionDrive += distortionDriveDelta;`\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tif (usesBitcrusher) {\r\n\t\t\t\teffectsSource += `\r\n\t\t\t\t\t\r\n\t\t\t\t\tbitcrusherPhase += bitcrusherPhaseDelta;\r\n\t\t\t\t\tif (bitcrusherPhase < 1.0) {\r\n\t\t\t\t\t\tbitcrusherPrevInput = sample;\r\n\t\t\t\t\t\tsample = bitcrusherCurrentOutput;\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tbitcrusherPhase = bitcrusherPhase % 1.0;\r\n\t\t\t\t\t\tconst ratio = bitcrusherPhase / bitcrusherPhaseDelta;\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tconst lerpedInput = sample + (bitcrusherPrevInput - sample) * ratio;\r\n\t\t\t\t\t\tbitcrusherPrevInput = sample;\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tconst bitcrusherWrapLevel = bitcrusherFoldLevel * 4.0;\r\n\t\t\t\t\t\tconst wrappedSample = (((lerpedInput + bitcrusherFoldLevel) % bitcrusherWrapLevel) + bitcrusherWrapLevel) % bitcrusherWrapLevel;\r\n\t\t\t\t\t\tconst foldedSample = bitcrusherFoldLevel - Math.abs(bitcrusherFoldLevel * 2.0 - wrappedSample);\r\n\t\t\t\t\t\tconst scaledSample = foldedSample / bitcrusherScale;\r\n\t\t\t\t\t\tconst oldValue = bitcrusherCurrentOutput;\r\n\t\t\t\t\t\tconst newValue = (((scaledSample > 0 ? scaledSample + 1 : scaledSample)|0)-.5) * bitcrusherScale;\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tsample = oldValue + (newValue - oldValue) * ratio;\r\n\t\t\t\t\t\tbitcrusherCurrentOutput = newValue;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbitcrusherPhaseDelta *= bitcrusherPhaseDeltaScale;\r\n\t\t\t\t\tbitcrusherScale *= bitcrusherScaleScale;\r\n\t\t\t\t\tbitcrusherFoldLevel *= bitcrusherFoldLevelScale;`\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tif (usesEqFilter) {\r\n\t\t\t\teffectsSource += `\r\n\t\t\t\t\t\r\n\t\t\t\t\tconst inputSample = sample;\r\n\t\t\t\t\tsample = applyFilters(inputSample, initialFilterInput1, initialFilterInput2, filterCount, filters);\r\n\t\t\t\t\tinitialFilterInput2 = initialFilterInput1;\r\n\t\t\t\t\tinitialFilterInput1 = inputSample;`\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t// The eq filter volume is also used to fade out the instrument state, so always include it.\r\n\t\t\teffectsSource += `\r\n\t\t\t\t\t\r\n\t\t\t\t\tsample *= eqFilterVolume;\r\n\t\t\t\t\teqFilterVolume += eqFilterVolumeDelta;`\r\n\t\t\t\r\n\t\t\tif (usesPanning) {\r\n\t\t\t\teffectsSource += `\r\n\t\t\t\t\t\r\n\t\t\t\t\tpanningDelayLine[panningDelayPos] = sample;\r\n\t\t\t\t\tconst panningRatioL  = panningOffsetL % 1;\r\n\t\t\t\t\tconst panningRatioR  = panningOffsetR % 1;\r\n\t\t\t\t\tconst panningTapLA   = panningDelayLine[(panningOffsetL) & panningMask];\r\n\t\t\t\t\tconst panningTapLB   = panningDelayLine[(panningOffsetL + 1) & panningMask];\r\n\t\t\t\t\tconst panningTapRA   = panningDelayLine[(panningOffsetR) & panningMask];\r\n\t\t\t\t\tconst panningTapRB   = panningDelayLine[(panningOffsetR + 1) & panningMask];\r\n\t\t\t\t\tconst panningTapL    = panningTapLA + (panningTapLB - panningTapLA) * panningRatioL;\r\n\t\t\t\t\tconst panningTapR    = panningTapRA + (panningTapRB - panningTapRA) * panningRatioR;\r\n\t\t\t\t\tlet sampleL = panningTapL * panningVolumeL;\r\n\t\t\t\t\tlet sampleR = panningTapR * panningVolumeR;\r\n\t\t\t\t\tpanningDelayPos = (panningDelayPos + 1) & panningMask;\r\n\t\t\t\t\tpanningVolumeL += panningVolumeDeltaL;\r\n\t\t\t\t\tpanningVolumeR += panningVolumeDeltaR;\r\n\t\t\t\t\tpanningOffsetL += panningOffsetDeltaL;\r\n\t\t\t\t\tpanningOffsetR += panningOffsetDeltaR;`\r\n\t\t\t} else {\r\n\t\t\t\teffectsSource += `\r\n\t\t\t\t\t\r\n\t\t\t\t\tlet sampleL = sample;\r\n\t\t\t\t\tlet sampleR = sample;`\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tif (usesChorus) {\r\n\t\t\t\teffectsSource += `\r\n\t\t\t\t\t\r\n\t\t\t\t\tconst chorusTap0Ratio = chorusTap0Index % 1;\r\n\t\t\t\t\tconst chorusTap1Ratio = chorusTap1Index % 1;\r\n\t\t\t\t\tconst chorusTap2Ratio = chorusTap2Index % 1;\r\n\t\t\t\t\tconst chorusTap3Ratio = chorusTap3Index % 1;\r\n\t\t\t\t\tconst chorusTap4Ratio = chorusTap4Index % 1;\r\n\t\t\t\t\tconst chorusTap5Ratio = chorusTap5Index % 1;\r\n\t\t\t\t\tconst chorusTap0A = chorusDelayLineL[(chorusTap0Index) & chorusMask];\r\n\t\t\t\t\tconst chorusTap0B = chorusDelayLineL[(chorusTap0Index + 1) & chorusMask];\r\n\t\t\t\t\tconst chorusTap1A = chorusDelayLineL[(chorusTap1Index) & chorusMask];\r\n\t\t\t\t\tconst chorusTap1B = chorusDelayLineL[(chorusTap1Index + 1) & chorusMask];\r\n\t\t\t\t\tconst chorusTap2A = chorusDelayLineL[(chorusTap2Index) & chorusMask];\r\n\t\t\t\t\tconst chorusTap2B = chorusDelayLineL[(chorusTap2Index + 1) & chorusMask];\r\n\t\t\t\t\tconst chorusTap3A = chorusDelayLineR[(chorusTap3Index) & chorusMask];\r\n\t\t\t\t\tconst chorusTap3B = chorusDelayLineR[(chorusTap3Index + 1) & chorusMask];\r\n\t\t\t\t\tconst chorusTap4A = chorusDelayLineR[(chorusTap4Index) & chorusMask];\r\n\t\t\t\t\tconst chorusTap4B = chorusDelayLineR[(chorusTap4Index + 1) & chorusMask];\r\n\t\t\t\t\tconst chorusTap5A = chorusDelayLineR[(chorusTap5Index) & chorusMask];\r\n\t\t\t\t\tconst chorusTap5B = chorusDelayLineR[(chorusTap5Index + 1) & chorusMask];\r\n\t\t\t\t\tconst chorusTap0 = chorusTap0A + (chorusTap0B - chorusTap0A) * chorusTap0Ratio;\r\n\t\t\t\t\tconst chorusTap1 = chorusTap1A + (chorusTap1B - chorusTap1A) * chorusTap1Ratio;\r\n\t\t\t\t\tconst chorusTap2 = chorusTap2A + (chorusTap2B - chorusTap2A) * chorusTap2Ratio;\r\n\t\t\t\t\tconst chorusTap3 = chorusTap3A + (chorusTap3B - chorusTap3A) * chorusTap3Ratio;\r\n\t\t\t\t\tconst chorusTap4 = chorusTap4A + (chorusTap4B - chorusTap4A) * chorusTap4Ratio;\r\n\t\t\t\t\tconst chorusTap5 = chorusTap5A + (chorusTap5B - chorusTap5A) * chorusTap5Ratio;\r\n\t\t\t\t\tchorusDelayLineL[chorusDelayPos] = sampleL * delayInputMult;\r\n\t\t\t\t\tchorusDelayLineR[chorusDelayPos] = sampleR * delayInputMult;\r\n\t\t\t\t\tsampleL = chorusCombinedMult * (sampleL + chorusVoiceMult * (chorusTap1 - chorusTap0 - chorusTap2));\r\n\t\t\t\t\tsampleR = chorusCombinedMult * (sampleR + chorusVoiceMult * (chorusTap4 - chorusTap3 - chorusTap5));\r\n\t\t\t\t\tchorusDelayPos = (chorusDelayPos + 1) & chorusMask;\r\n\t\t\t\t\tchorusTap0Index += chorusTap0Delta;\r\n\t\t\t\t\tchorusTap1Index += chorusTap1Delta;\r\n\t\t\t\t\tchorusTap2Index += chorusTap2Delta;\r\n\t\t\t\t\tchorusTap3Index += chorusTap3Delta;\r\n\t\t\t\t\tchorusTap4Index += chorusTap4Delta;\r\n\t\t\t\t\tchorusTap5Index += chorusTap5Delta;\r\n\t\t\t\t\tchorusVoiceMult += chorusVoiceMultDelta;\r\n\t\t\t\t\tchorusCombinedMult += chorusCombinedMultDelta;`\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tif (usesEcho) {\r\n\t\t\t\teffectsSource += `\r\n\t\t\t\t\t\r\n\t\t\t\t\tconst echoTapStartIndex = (echoDelayPos + echoDelayOffsetStart) & echoMask;\r\n\t\t\t\t\tconst echoTapEndIndex   = (echoDelayPos + echoDelayOffsetEnd  ) & echoMask;\r\n\t\t\t\t\tconst echoTapStartL = echoDelayLineL[echoTapStartIndex];\r\n\t\t\t\t\tconst echoTapEndL   = echoDelayLineL[echoTapEndIndex];\r\n\t\t\t\t\tconst echoTapStartR = echoDelayLineR[echoTapStartIndex];\r\n\t\t\t\t\tconst echoTapEndR   = echoDelayLineR[echoTapEndIndex];\r\n\t\t\t\t\tconst echoTapL = (echoTapStartL + (echoTapEndL - echoTapStartL) * echoDelayOffsetRatio) * echoMult;\r\n\t\t\t\t\tconst echoTapR = (echoTapStartR + (echoTapEndR - echoTapStartR) * echoDelayOffsetRatio) * echoMult;\r\n\t\t\t\t\t\r\n\t\t\t\t\techoShelfSampleL = echoShelfB0 * echoTapL + echoShelfB1 * echoShelfPrevInputL - echoShelfA1 * echoShelfSampleL;\r\n\t\t\t\t\techoShelfSampleR = echoShelfB0 * echoTapR + echoShelfB1 * echoShelfPrevInputR - echoShelfA1 * echoShelfSampleR;\r\n\t\t\t\t\techoShelfPrevInputL = echoTapL;\r\n\t\t\t\t\techoShelfPrevInputR = echoTapR;\r\n\t\t\t\t\tsampleL += echoShelfSampleL;\r\n\t\t\t\t\tsampleR += echoShelfSampleR;\r\n\t\t\t\t\t\r\n\t\t\t\t\techoDelayLineL[echoDelayPos] = sampleL * delayInputMult;\r\n\t\t\t\t\techoDelayLineR[echoDelayPos] = sampleR * delayInputMult;\r\n\t\t\t\t\techoDelayPos = (echoDelayPos + 1) & echoMask;\r\n\t\t\t\t\techoDelayOffsetRatio += echoDelayOffsetRatioDelta;\r\n\t\t\t\t\techoMult += echoMultDelta;`\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tif (usesReverb) {\r\n\t\t\t\teffectsSource += `\r\n\t\t\t\t\t\r\n\t\t\t\t\t// Reverb, implemented using a feedback delay network with a Hadamard matrix and lowpass filters.\r\n\t\t\t\t\t// good ratios:    0.555235 + 0.618033 + 0.818 +   1.0 = 2.991268\r\n\t\t\t\t\t// Delay lengths:  3041     + 3385     + 4481  +  5477 = 16384 = 2^14\r\n\t\t\t\t\t// Buffer offsets: 3041    -> 6426   -> 10907 -> 16384\r\n\t\t\t\t\tconst reverbDelayPos1 = (reverbDelayPos +  3041) & reverbMask;\r\n\t\t\t\t\tconst reverbDelayPos2 = (reverbDelayPos +  6426) & reverbMask;\r\n\t\t\t\t\tconst reverbDelayPos3 = (reverbDelayPos + 10907) & reverbMask;\r\n\t\t\t\t\tconst reverbSample0 = (reverbDelayLine[reverbDelayPos]);\r\n\t\t\t\t\tconst reverbSample1 = reverbDelayLine[reverbDelayPos1];\r\n\t\t\t\t\tconst reverbSample2 = reverbDelayLine[reverbDelayPos2];\r\n\t\t\t\t\tconst reverbSample3 = reverbDelayLine[reverbDelayPos3];\r\n\t\t\t\t\tconst reverbTemp0 = -(reverbSample0 + sampleL) + reverbSample1;\r\n\t\t\t\t\tconst reverbTemp1 = -(reverbSample0 + sampleR) - reverbSample1;\r\n\t\t\t\t\tconst reverbTemp2 = -reverbSample2 + reverbSample3;\r\n\t\t\t\t\tconst reverbTemp3 = -reverbSample2 - reverbSample3;\r\n\t\t\t\t\tconst reverbShelfInput0 = (reverbTemp0 + reverbTemp2) * reverb;\r\n\t\t\t\t\tconst reverbShelfInput1 = (reverbTemp1 + reverbTemp3) * reverb;\r\n\t\t\t\t\tconst reverbShelfInput2 = (reverbTemp0 - reverbTemp2) * reverb;\r\n\t\t\t\t\tconst reverbShelfInput3 = (reverbTemp1 - reverbTemp3) * reverb;\r\n\t\t\t\t\treverbShelfSample0 = reverbShelfB0 * reverbShelfInput0 + reverbShelfB1 * reverbShelfPrevInput0 - reverbShelfA1 * reverbShelfSample0;\r\n\t\t\t\t\treverbShelfSample1 = reverbShelfB0 * reverbShelfInput1 + reverbShelfB1 * reverbShelfPrevInput1 - reverbShelfA1 * reverbShelfSample1;\r\n\t\t\t\t\treverbShelfSample2 = reverbShelfB0 * reverbShelfInput2 + reverbShelfB1 * reverbShelfPrevInput2 - reverbShelfA1 * reverbShelfSample2;\r\n\t\t\t\t\treverbShelfSample3 = reverbShelfB0 * reverbShelfInput3 + reverbShelfB1 * reverbShelfPrevInput3 - reverbShelfA1 * reverbShelfSample3;\r\n\t\t\t\t\treverbShelfPrevInput0 = reverbShelfInput0;\r\n\t\t\t\t\treverbShelfPrevInput1 = reverbShelfInput1;\r\n\t\t\t\t\treverbShelfPrevInput2 = reverbShelfInput2;\r\n\t\t\t\t\treverbShelfPrevInput3 = reverbShelfInput3;\r\n\t\t\t\t\treverbDelayLine[reverbDelayPos1] = reverbShelfSample0 * delayInputMult;\r\n\t\t\t\t\treverbDelayLine[reverbDelayPos2] = reverbShelfSample1 * delayInputMult;\r\n\t\t\t\t\treverbDelayLine[reverbDelayPos3] = reverbShelfSample2 * delayInputMult;\r\n\t\t\t\t\treverbDelayLine[reverbDelayPos ] = reverbShelfSample3 * delayInputMult;\r\n\t\t\t\t\treverbDelayPos = (reverbDelayPos + 1) & reverbMask;\r\n\t\t\t\t\tsampleL += reverbSample1 + reverbSample2 + reverbSample3;\r\n\t\t\t\t\tsampleR += reverbSample0 + reverbSample2 - reverbSample3;\r\n\t\t\t\t\treverb += reverbDelta;`\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\teffectsSource += `\r\n\t\t\t\t\t\r\n\t\t\t\t\toutputDataL[sampleIndex] += sampleL * mixVolume;\r\n\t\t\t\t\toutputDataR[sampleIndex] += sampleR * mixVolume;\r\n\t\t\t\t\tmixVolume += mixVolumeDelta;`\r\n\t\t\t\r\n\t\t\tif (usesDelays) {\r\n\t\t\t\teffectsSource += `\r\n\t\t\t\t\t\r\n\t\t\t\t\tdelayInputMult += delayInputMultDelta;`\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\teffectsSource += `\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tinstrumentState.mixVolume = mixVolume;\r\n\t\t\t\tinstrumentState.eqFilterVolume = eqFilterVolume;\r\n\t\t\t\t\r\n\t\t\t\t// Avoid persistent denormal or NaN values in the delay buffers and filter history.\r\n\t\t\t\tconst epsilon = (1.0e-24);`\r\n\t\t\t\r\n\t\t\tif (usesDelays) {\r\n\t\t\t\teffectsSource += `\r\n\t\t\t\t\r\n\t\t\t\tinstrumentState.delayInputMult = delayInputMult;`\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tif (usesDistortion) {\r\n\t\t\t\teffectsSource += `\r\n\t\t\t\t\r\n\t\t\t\tinstrumentState.distortion = distortion;\r\n\t\t\t\tinstrumentState.distortionDrive = distortionDrive;\r\n\t\t\t\t\r\n\t\t\t\tif (!Number.isFinite(distortionFractionalInput1) || Math.abs(distortionFractionalInput1) < epsilon) distortionFractionalInput1 = 0.0;\r\n\t\t\t\tif (!Number.isFinite(distortionFractionalInput2) || Math.abs(distortionFractionalInput2) < epsilon) distortionFractionalInput2 = 0.0;\r\n\t\t\t\tif (!Number.isFinite(distortionFractionalInput3) || Math.abs(distortionFractionalInput3) < epsilon) distortionFractionalInput3 = 0.0;\r\n\t\t\t\tif (!Number.isFinite(distortionPrevInput) || Math.abs(distortionPrevInput) < epsilon) distortionPrevInput = 0.0;\r\n\t\t\t\tif (!Number.isFinite(distortionNextOutput) || Math.abs(distortionNextOutput) < epsilon) distortionNextOutput = 0.0;\r\n\t\t\t\t\r\n\t\t\t\tinstrumentState.distortionFractionalInput1 = distortionFractionalInput1;\r\n\t\t\t\tinstrumentState.distortionFractionalInput2 = distortionFractionalInput2;\r\n\t\t\t\tinstrumentState.distortionFractionalInput3 = distortionFractionalInput3;\r\n\t\t\t\tinstrumentState.distortionPrevInput = distortionPrevInput;\r\n\t\t\t\tinstrumentState.distortionNextOutput = distortionNextOutput;`\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tif (usesBitcrusher) {\r\n\t\t\t\teffectsSource += `\r\n\t\t\t\t\t\r\n\t\t\t\tif (Math.abs(bitcrusherPrevInput) < epsilon) bitcrusherPrevInput = 0.0;\r\n\t\t\t\tif (Math.abs(bitcrusherCurrentOutput) < epsilon) bitcrusherCurrentOutput = 0.0;\r\n\t\t\t\tinstrumentState.bitcrusherPrevInput = bitcrusherPrevInput;\r\n\t\t\t\tinstrumentState.bitcrusherCurrentOutput = bitcrusherCurrentOutput;\r\n\t\t\t\tinstrumentState.bitcrusherPhase = bitcrusherPhase;\r\n\t\t\t\tinstrumentState.bitcrusherPhaseDelta = bitcrusherPhaseDelta;\r\n\t\t\t\tinstrumentState.bitcrusherScale = bitcrusherScale;\r\n\t\t\t\tinstrumentState.bitcrusherFoldLevel = bitcrusherFoldLevel;`\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tif (usesEqFilter) {\r\n\t\t\t\teffectsSource += `\r\n\t\t\t\t\t\r\n\t\t\t\tsynth.sanitizeFilters(filters);\r\n\t\t\t\t// The filter input here is downstream from another filter so we\r\n\t\t\t\t// better make sure it's safe too.\r\n\t\t\t\tif (!(initialFilterInput1 < 100) || !(initialFilterInput2 < 100)) {\r\n\t\t\t\t\tinitialFilterInput1 = 0.0;\r\n\t\t\t\t\tinitialFilterInput2 = 0.0;\r\n\t\t\t\t}\r\n\t\t\t\tif (Math.abs(initialFilterInput1) < epsilon) initialFilterInput1 = 0.0;\r\n\t\t\t\tif (Math.abs(initialFilterInput2) < epsilon) initialFilterInput2 = 0.0;\r\n\t\t\t\tinstrumentState.initialEqFilterInput1 = initialFilterInput1;\r\n\t\t\t\tinstrumentState.initialEqFilterInput2 = initialFilterInput2;`\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tif (usesPanning) {\r\n\t\t\t\teffectsSource += `\r\n\t\t\t\t\r\n\t\t\t\tSynth.sanitizeDelayLine(panningDelayLine, panningDelayPos, panningMask);\r\n\t\t\t\tinstrumentState.panningDelayPos = panningDelayPos;\r\n\t\t\t\tinstrumentState.panningVolumeL = panningVolumeL;\r\n\t\t\t\tinstrumentState.panningVolumeR = panningVolumeR;\r\n\t\t\t\tinstrumentState.panningOffsetL = panningOffsetL;\r\n\t\t\t\tinstrumentState.panningOffsetR = panningOffsetR;`\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tif (usesChorus) {\r\n\t\t\t\teffectsSource += `\r\n\t\t\t\t\r\n\t\t\t\tSynth.sanitizeDelayLine(chorusDelayLineL, chorusDelayPos, chorusMask);\r\n\t\t\t\tSynth.sanitizeDelayLine(chorusDelayLineR, chorusDelayPos, chorusMask);\r\n\t\t\t\tinstrumentState.chorusPhase = chorusPhase;\r\n\t\t\t\tinstrumentState.chorusDelayPos = chorusDelayPos;\r\n\t\t\t\tinstrumentState.chorusVoiceMult = chorusVoiceMult;\r\n\t\t\t\tinstrumentState.chorusCombinedMult = chorusCombinedMult;`\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tif (usesEcho) {\r\n\t\t\t\teffectsSource += `\r\n\t\t\t\t\r\n\t\t\t\tSynth.sanitizeDelayLine(echoDelayLineL, echoDelayPos, echoMask);\r\n\t\t\t\tSynth.sanitizeDelayLine(echoDelayLineR, echoDelayPos, echoMask);\r\n\t\t\t\tinstrumentState.echoDelayPos = echoDelayPos;\r\n\t\t\t\tinstrumentState.echoMult = echoMult;\r\n\t\t\t\tinstrumentState.echoDelayOffsetRatio = echoDelayOffsetRatio;\r\n\t\t\t\t\r\n\t\t\t\tif (!Number.isFinite(echoShelfSampleL) || Math.abs(echoShelfSampleL) < epsilon) echoShelfSampleL = 0.0;\r\n\t\t\t\tif (!Number.isFinite(echoShelfSampleR) || Math.abs(echoShelfSampleR) < epsilon) echoShelfSampleR = 0.0;\r\n\t\t\t\tif (!Number.isFinite(echoShelfPrevInputL) || Math.abs(echoShelfPrevInputL) < epsilon) echoShelfPrevInputL = 0.0;\r\n\t\t\t\tif (!Number.isFinite(echoShelfPrevInputR) || Math.abs(echoShelfPrevInputR) < epsilon) echoShelfPrevInputR = 0.0;\r\n\t\t\t\tinstrumentState.echoShelfSampleL = echoShelfSampleL;\r\n\t\t\t\tinstrumentState.echoShelfSampleR = echoShelfSampleR;\r\n\t\t\t\tinstrumentState.echoShelfPrevInputL = echoShelfPrevInputL;\r\n\t\t\t\tinstrumentState.echoShelfPrevInputR = echoShelfPrevInputR;`\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tif (usesReverb) {\r\n\t\t\t\teffectsSource += `\r\n\t\t\t\t\r\n\t\t\t\tSynth.sanitizeDelayLine(reverbDelayLine, reverbDelayPos        , reverbMask);\r\n\t\t\t\tSynth.sanitizeDelayLine(reverbDelayLine, reverbDelayPos +  3041, reverbMask);\r\n\t\t\t\tSynth.sanitizeDelayLine(reverbDelayLine, reverbDelayPos +  6426, reverbMask);\r\n\t\t\t\tSynth.sanitizeDelayLine(reverbDelayLine, reverbDelayPos + 10907, reverbMask);\r\n\t\t\t\tinstrumentState.reverbDelayPos = reverbDelayPos;\r\n\t\t\t\tinstrumentState.reverbMult = reverb;\r\n\t\t\t\t\r\n\t\t\t\tif (!Number.isFinite(reverbShelfSample0) || Math.abs(reverbShelfSample0) < epsilon) reverbShelfSample0 = 0.0;\r\n\t\t\t\tif (!Number.isFinite(reverbShelfSample1) || Math.abs(reverbShelfSample1) < epsilon) reverbShelfSample1 = 0.0;\r\n\t\t\t\tif (!Number.isFinite(reverbShelfSample2) || Math.abs(reverbShelfSample2) < epsilon) reverbShelfSample2 = 0.0;\r\n\t\t\t\tif (!Number.isFinite(reverbShelfSample3) || Math.abs(reverbShelfSample3) < epsilon) reverbShelfSample3 = 0.0;\r\n\t\t\t\tif (!Number.isFinite(reverbShelfPrevInput0) || Math.abs(reverbShelfPrevInput0) < epsilon) reverbShelfPrevInput0 = 0.0;\r\n\t\t\t\tif (!Number.isFinite(reverbShelfPrevInput1) || Math.abs(reverbShelfPrevInput1) < epsilon) reverbShelfPrevInput1 = 0.0;\r\n\t\t\t\tif (!Number.isFinite(reverbShelfPrevInput2) || Math.abs(reverbShelfPrevInput2) < epsilon) reverbShelfPrevInput2 = 0.0;\r\n\t\t\t\tif (!Number.isFinite(reverbShelfPrevInput3) || Math.abs(reverbShelfPrevInput3) < epsilon) reverbShelfPrevInput3 = 0.0;\r\n\t\t\t\tinstrumentState.reverbShelfSample0 = reverbShelfSample0;\r\n\t\t\t\tinstrumentState.reverbShelfSample1 = reverbShelfSample1;\r\n\t\t\t\tinstrumentState.reverbShelfSample2 = reverbShelfSample2;\r\n\t\t\t\tinstrumentState.reverbShelfSample3 = reverbShelfSample3;\r\n\t\t\t\tinstrumentState.reverbShelfPrevInput0 = reverbShelfPrevInput0;\r\n\t\t\t\tinstrumentState.reverbShelfPrevInput1 = reverbShelfPrevInput1;\r\n\t\t\t\tinstrumentState.reverbShelfPrevInput2 = reverbShelfPrevInput2;\r\n\t\t\t\tinstrumentState.reverbShelfPrevInput3 = reverbShelfPrevInput3;`\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\teffectsSource += \"}\";\r\n\t\t\t\r\n\t\t\t//console.log(effectsSource);\r\n\t\t\teffectsFunction = new Function(\"Config\", \"Synth\", effectsSource)(Config, Synth);\r\n\t\t\tSynth.effectsFunctionCache[signature] = effectsFunction;\r\n\t\t}\r\n\t\t\r\n\t\teffectsFunction(synth, outputDataL, outputDataR, bufferIndex, runLength, instrumentState);\r\n\t}\r\n\t\r\n\tprivate static pulseWidthSynth(synth: Synth, bufferIndex: number, runLength: number, tone: Tone, instrumentState: InstrumentState): void {\r\n\t\tconst data: Float32Array = synth.tempMonoInstrumentSampleBuffer!;\r\n\t\t\r\n\t\tlet phaseDelta: number = tone.phaseDeltas[0];\r\n\t\tconst phaseDeltaScale: number = +tone.phaseDeltaScales[0];\r\n\t\tlet expression: number = +tone.expression;\r\n\t\tconst expressionDelta: number = +tone.expressionDelta;\r\n\t\tlet phase: number = (tone.phases[0] % 1);\r\n\t\t\r\n\t\tlet pulseWidth: number = tone.pulseWidth;\r\n\t\tconst pulseWidthDelta: number = tone.pulseWidthDelta;\r\n\t\t\r\n\t\tconst filters: DynamicBiquadFilter[] = tone.noteFilters;\r\n\t\tconst filterCount: number = tone.noteFilterCount|0;\r\n\t\tlet initialFilterInput1: number = +tone.initialNoteFilterInput1;\r\n\t\tlet initialFilterInput2: number = +tone.initialNoteFilterInput2;\r\n\t\tconst applyFilters: Function = Synth.applyFilters;\r\n\t\t\r\n\t\tconst stopIndex: number = bufferIndex + runLength;\r\n\t\tfor (let sampleIndex: number = bufferIndex; sampleIndex < stopIndex; sampleIndex++) {\r\n\t\t\t\r\n\t\t\tconst sawPhaseA: number = phase % 1;\r\n\t\t\tconst sawPhaseB: number = (phase + pulseWidth) % 1;\r\n\t\t\t\r\n\t\t\tlet pulseWave: number = sawPhaseB - sawPhaseA;\r\n\t\t\t\r\n\t\t\t// This is a PolyBLEP, which smooths out discontinuities at any frequency to reduce aliasing. \r\n\t\t\tif (sawPhaseA < phaseDelta) {\r\n\t\t\t\tvar t = sawPhaseA / phaseDelta;\r\n\t\t\t\tpulseWave += (t+t-t*t-1) * 0.5;\r\n\t\t\t} else if (sawPhaseA > 1.0 - phaseDelta) {\r\n\t\t\t\tvar t = (sawPhaseA - 1.0) / phaseDelta;\r\n\t\t\t\tpulseWave += (t+t+t*t+1) * 0.5;\r\n\t\t\t}\r\n\t\t\tif (sawPhaseB < phaseDelta) {\r\n\t\t\t\tvar t = sawPhaseB / phaseDelta;\r\n\t\t\t\tpulseWave -= (t+t-t*t-1) * 0.5;\r\n\t\t\t} else if (sawPhaseB > 1.0 - phaseDelta) {\r\n\t\t\t\tvar t = (sawPhaseB - 1.0) / phaseDelta;\r\n\t\t\t\tpulseWave -= (t+t+t*t+1) * 0.5;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tconst inputSample: number = pulseWave;\r\n\t\t\tconst sample: number = applyFilters(inputSample, initialFilterInput1, initialFilterInput2, filterCount, filters);\r\n\t\t\tinitialFilterInput2 = initialFilterInput1;\r\n\t\t\tinitialFilterInput1 = inputSample;\r\n\t\t\t\r\n\t\t\tphase += phaseDelta;\r\n\t\t\tphaseDelta *= phaseDeltaScale;\r\n\t\t\tpulseWidth += pulseWidthDelta;\r\n\t\t\t\r\n\t\t\tconst output: number = sample * expression;\r\n\t\t\texpression += expressionDelta;\r\n\t\t\t\r\n\t\t\tdata[sampleIndex] += output;\r\n\t\t}\r\n\t\t\r\n\t\ttone.phases[0] = phase;\r\n\t\ttone.phaseDeltas[0] = phaseDelta;\r\n\t\ttone.expression = expression;\r\n\t\ttone.pulseWidth = pulseWidth;\r\n\t\t\r\n\t\tsynth.sanitizeFilters(filters);\r\n\t\ttone.initialNoteFilterInput1 = initialFilterInput1;\r\n\t\ttone.initialNoteFilterInput2 = initialFilterInput2;\r\n\t}\r\n\t\r\n\tprivate static supersawSynth(synth: Synth, bufferIndex: number, runLength: number, tone: Tone, instrumentState: InstrumentState): void {\r\n\t\tconst data: Float32Array = synth.tempMonoInstrumentSampleBuffer!;\r\n\t\tconst voiceCount: number = Config.supersawVoiceCount|0;\r\n\t\t\r\n\t\tlet phaseDelta: number = tone.phaseDeltas[0];\r\n\t\tconst phaseDeltaScale: number = +tone.phaseDeltaScales[0];\r\n\t\tlet expression: number = +tone.expression;\r\n\t\tconst expressionDelta: number = +tone.expressionDelta;\r\n\t\tlet phases: number[] = tone.phases;\r\n\t\t\r\n\t\tlet dynamism: number = +tone.supersawDynamism;\r\n\t\tconst dynamismDelta: number = +tone.supersawDynamismDelta;\r\n\t\tconst unisonDetunes: number[] = tone.supersawUnisonDetunes;\r\n\t\tlet shape: number = +tone.supersawShape;\r\n\t\tconst shapeDelta: number = +tone.supersawShapeDelta;\r\n\t\tlet delayLength: number = +tone.supersawDelayLength;\r\n\t\tconst delayLengthDelta: number = +tone.supersawDelayLengthDelta;\r\n\t\tconst delayLine: Float32Array = tone.supersawDelayLine!;\r\n\t\tconst delayBufferMask: number = (delayLine.length - 1) >> 0;\r\n\t\tlet delayIndex: number = tone.supersawDelayIndex|0;\r\n\t\tdelayIndex = (delayIndex & delayBufferMask) + delayLine.length;\r\n\t\t\r\n\t\tconst filters: DynamicBiquadFilter[] = tone.noteFilters;\r\n\t\tconst filterCount: number = tone.noteFilterCount|0;\r\n\t\tlet initialFilterInput1: number = +tone.initialNoteFilterInput1;\r\n\t\tlet initialFilterInput2: number = +tone.initialNoteFilterInput2;\r\n\t\tconst applyFilters: Function = Synth.applyFilters;\r\n\t\t\r\n\t\tconst stopIndex: number = bufferIndex + runLength;\r\n\t\tfor (let sampleIndex: number = bufferIndex; sampleIndex < stopIndex; sampleIndex++) {\r\n\t\t\t// The phase initially starts at a zero crossing so apply\r\n\t\t\t// the delta before first sample to get a nonzero value.\r\n\t\t\tlet phase: number = (phases[0] + phaseDelta) % 1.0;\r\n\t\t\tlet supersawSample: number = phase - 0.5 * (1.0 + (voiceCount - 1.0) * dynamism);\r\n\t\t\t\r\n\t\t\t// This is a PolyBLEP, which smooths out discontinuities at any frequency to reduce aliasing. \r\n\t\t\tif (phase < phaseDelta) {\r\n\t\t\t\tvar t: number = phase / phaseDelta;\r\n\t\t\t\tsupersawSample -= (t+t-t*t-1) * 0.5;\r\n\t\t\t} else if (phase > 1.0 - phaseDelta) {\r\n\t\t\t\tvar t: number = (phase - 1.0) / phaseDelta;\r\n\t\t\t\tsupersawSample -= (t+t+t*t+1) * 0.5;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tphases[0] = phase;\r\n\t\t\t\r\n\t\t\tfor (let i: number = 1; i < voiceCount; i++) {\r\n\t\t\t\tconst detunedPhaseDelta: number = phaseDelta * unisonDetunes[i];\r\n\t\t\t\t// The phase initially starts at a zero crossing so apply\r\n\t\t\t\t// the delta before first sample to get a nonzero value.\r\n\t\t\t\tlet phase: number = (phases[i] + detunedPhaseDelta) % 1.0;\r\n\t\t\t\tsupersawSample += phase * dynamism;\r\n\t\t\t\t\r\n\t\t\t\t// This is a PolyBLEP, which smooths out discontinuities at any frequency to reduce aliasing. \r\n\t\t\t\tif (phase < detunedPhaseDelta) {\r\n\t\t\t\t\tconst t: number = phase / detunedPhaseDelta;\r\n\t\t\t\t\tsupersawSample -= (t+t-t*t-1) * 0.5 * dynamism;\r\n\t\t\t\t} else if (phase > 1.0 - detunedPhaseDelta) {\r\n\t\t\t\t\tconst t: number = (phase - 1.0) / detunedPhaseDelta;\r\n\t\t\t\t\tsupersawSample -= (t+t+t*t+1) * 0.5 * dynamism;\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tphases[i] = phase;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tdelayLine[delayIndex & delayBufferMask] = supersawSample;\r\n\t\t\tconst delaySampleTime: number = delayIndex - delayLength;\r\n\t\t\tconst lowerIndex: number = delaySampleTime | 0;\r\n\t\t\tconst upperIndex: number = lowerIndex + 1;\r\n\t\t\tconst delayRatio: number = delaySampleTime - lowerIndex;\r\n\t\t\tconst prevDelaySample: number = delayLine[lowerIndex & delayBufferMask];\r\n\t\t\tconst nextDelaySample: number = delayLine[upperIndex & delayBufferMask];\r\n\t\t\tconst delaySample: number = prevDelaySample + (nextDelaySample - prevDelaySample) * delayRatio;\r\n\t\t\tdelayIndex++;\r\n\t\t\t\r\n\t\t\tconst inputSample: number = supersawSample - delaySample * shape;\r\n\t\t\tconst sample: number = applyFilters(inputSample, initialFilterInput1, initialFilterInput2, filterCount, filters);\r\n\t\t\tinitialFilterInput2 = initialFilterInput1;\r\n\t\t\tinitialFilterInput1 = inputSample;\r\n\t\t\t\r\n\t\t\tphaseDelta *= phaseDeltaScale;\r\n\t\t\tdynamism += dynamismDelta;\r\n\t\t\tshape += shapeDelta;\r\n\t\t\tdelayLength += delayLengthDelta;\r\n\t\t\t\r\n\t\t\tconst output: number = sample * expression;\r\n\t\t\texpression += expressionDelta;\r\n\t\t\t\r\n\t\t\tdata[sampleIndex] += output;\r\n\t\t}\r\n\t\t\r\n\t\ttone.phaseDeltas[0] = phaseDelta;\r\n\t\ttone.expression = expression;\r\n\t\ttone.supersawDynamism = dynamism;\r\n\t\ttone.supersawShape = shape;\r\n\t\ttone.supersawDelayLength = delayLength;\r\n\t\ttone.supersawDelayIndex = delayIndex;\r\n\t\t\r\n\t\tsynth.sanitizeFilters(filters);\r\n\t\ttone.initialNoteFilterInput1 = initialFilterInput1;\r\n\t\ttone.initialNoteFilterInput2 = initialFilterInput2;\r\n\t}\r\n\t\r\n\tprivate static fmSourceTemplate: string[] = (`\r\n\t\tconst data = synth.tempMonoInstrumentSampleBuffer;\r\n\t\tconst sineWave = Config.sineWave;\r\n\t\t\r\n\t\t// I'm adding 1000 to the phase to ensure that it's never negative even when modulated by other waves because negative numbers don't work with the modulus operator very well.\r\n\t\tlet operator#Phase       = +((tone.phases[#] % 1) + 1000) * ` + Config.sineWaveLength + `;\r\n\t\tlet operator#PhaseDelta  = +tone.phaseDeltas[#] * ` + Config.sineWaveLength + `;\r\n\t\tlet operator#PhaseDeltaScale = +tone.phaseDeltaScales[#];\r\n\t\tlet operator#OutputMult  = +tone.operatorExpressions[#];\r\n\t\tconst operator#OutputDelta = +tone.operatorExpressionDeltas[#];\r\n\t\tlet operator#Output      = +tone.feedbackOutputs[#];\r\n\t\tlet feedbackMult         = +tone.feedbackMult;\r\n\t\tconst feedbackDelta      = +tone.feedbackDelta;\r\n\t\tlet expression = +tone.expression;\r\n\t\tconst expressionDelta = +tone.expressionDelta;\r\n\t\t\r\n\t\tconst filters = tone.noteFilters;\r\n\t\tconst filterCount = tone.noteFilterCount|0;\r\n\t\tlet initialFilterInput1 = +tone.initialNoteFilterInput1;\r\n\t\tlet initialFilterInput2 = +tone.initialNoteFilterInput2;\r\n\t\tconst applyFilters = Synth.applyFilters;\r\n\t\t\r\n\t\tconst stopIndex = bufferIndex + runLength;\r\n\t\tfor (let sampleIndex = bufferIndex; sampleIndex < stopIndex; sampleIndex++) {\r\n\t\t\t// INSERT OPERATOR COMPUTATION HERE\r\n\t\t\tconst fmOutput = (/*operator#Scaled*/); // CARRIER OUTPUTS\r\n\t\t\t\r\n\t\t\tconst inputSample = fmOutput;\r\n\t\t\tconst sample = applyFilters(inputSample, initialFilterInput1, initialFilterInput2, filterCount, filters);\r\n\t\t\tinitialFilterInput2 = initialFilterInput1;\r\n\t\t\tinitialFilterInput1 = inputSample;\r\n\t\t\t\r\n\t\t\tfeedbackMult += feedbackDelta;\r\n\t\t\toperator#OutputMult += operator#OutputDelta;\r\n\t\t\toperator#Phase += operator#PhaseDelta;\r\n\t\t\toperator#PhaseDelta *= operator#PhaseDeltaScale;\r\n\t\t\t\r\n\t\t\tconst output = sample * expression;\r\n\t\t\texpression += expressionDelta;\r\n\t\t\t\r\n\t\t\tdata[sampleIndex] += output;\r\n\t\t}\r\n\t\t\r\n\t\ttone.phases[#] = operator#Phase / ` + Config.sineWaveLength + `;\r\n\t\ttone.phaseDeltas[#] = operator#PhaseDelta / ` + Config.sineWaveLength + `;\r\n\t\ttone.operatorExpressions[#] = operator#OutputMult;\r\n\t\ttone.feedbackOutputs[#] = operator#Output;\r\n\t\ttone.feedbackMult = feedbackMult;\r\n\t\ttone.expression = expression;\r\n\t\t\r\n\t\tsynth.sanitizeFilters(filters);\r\n\t\ttone.initialNoteFilterInput1 = initialFilterInput1;\r\n\t\ttone.initialNoteFilterInput2 = initialFilterInput2;\r\n\t`).split(\"\\n\");\r\n\t\r\n\tprivate static operatorSourceTemplate: string[] = (`\r\n\t\t\tconst operator#PhaseMix = operator#Phase/* + operator@Scaled*/;\r\n\t\t\tconst operator#PhaseInt = operator#PhaseMix|0;\r\n\t\t\tconst operator#Index    = operator#PhaseInt & ` + Config.sineWaveMask + `;\r\n\t\t\tconst operator#Sample   = sineWave[operator#Index];\r\n\t\t\toperator#Output         = operator#Sample + (sineWave[operator#Index + 1] - operator#Sample) * (operator#PhaseMix - operator#PhaseInt);\r\n\t\t\tconst operator#Scaled   = operator#OutputMult * operator#Output;\r\n\t`).split(\"\\n\");\r\n\t\r\n\tprivate static noiseSynth(synth: Synth, bufferIndex: number, runLength: number, tone: Tone, instrumentState: InstrumentState): void {\r\n\t\tconst data: Float32Array = synth.tempMonoInstrumentSampleBuffer!;\r\n\t\tconst wave: Float32Array = instrumentState.wave!;\r\n\t\tlet phaseDelta: number = +tone.phaseDeltas[0];\r\n\t\tconst phaseDeltaScale: number = +tone.phaseDeltaScales[0];\r\n\t\tlet expression: number = +tone.expression;\r\n\t\tconst expressionDelta: number = +tone.expressionDelta;\r\n\t\tlet phase: number = (tone.phases[0] % 1) * Config.chipNoiseLength;\r\n\t\tif (tone.phases[0] == 0.0) {\r\n\t\t\t// Zero phase means the tone was reset, just give noise a random start phase instead.\r\n\t\t\tphase = Math.random() * Config.chipNoiseLength;\r\n\t\t}\r\n\t\tconst phaseMask: number = Config.chipNoiseLength - 1;\r\n\t\tlet noiseSample: number = +tone.noiseSample;\r\n\t\t\r\n\t\tconst filters: DynamicBiquadFilter[] = tone.noteFilters;\r\n\t\tconst filterCount: number = tone.noteFilterCount|0;\r\n\t\tlet initialFilterInput1: number = +tone.initialNoteFilterInput1;\r\n\t\tlet initialFilterInput2: number = +tone.initialNoteFilterInput2;\r\n\t\tconst applyFilters: Function = Synth.applyFilters;\r\n\t\t\r\n\t\t// This is for a \"legacy\" style simplified 1st order lowpass filter with\r\n\t\t// a cutoff frequency that is relative to the tone's fundamental frequency.\r\n\t\tconst pitchRelativefilter: number = Math.min(1.0, phaseDelta * instrumentState.noisePitchFilterMult);\r\n\t\t\r\n\t\tconst stopIndex: number = bufferIndex + runLength;\r\n\t\tfor (let sampleIndex: number = bufferIndex; sampleIndex < stopIndex; sampleIndex++) {\r\n\t\t\tconst waveSample: number = wave[phase & phaseMask];\r\n\t\t\t\r\n\t\t\tnoiseSample += (waveSample - noiseSample) * pitchRelativefilter;\r\n\t\t\t\r\n\t\t\tconst inputSample: number = noiseSample;\r\n\t\t\tconst sample: number = applyFilters(inputSample, initialFilterInput1, initialFilterInput2, filterCount, filters);\r\n\t\t\tinitialFilterInput2 = initialFilterInput1;\r\n\t\t\tinitialFilterInput1 = inputSample;\r\n\t\t\t\r\n\t\t\tphase += phaseDelta;\r\n\t\t\tphaseDelta *= phaseDeltaScale;\r\n\t\t\t\r\n\t\t\tconst output: number = sample * expression;\r\n\t\t\texpression += expressionDelta;\r\n\t\t\t\r\n\t\t\tdata[sampleIndex] += output;\r\n\t\t}\r\n\t\t\r\n\t\ttone.phases[0] = phase / Config.chipNoiseLength;\r\n\t\ttone.phaseDeltas[0] = phaseDelta;\r\n\t\ttone.expression = expression;\r\n\t\ttone.noiseSample = noiseSample;\r\n\t\t\r\n\t\tsynth.sanitizeFilters(filters);\r\n\t\ttone.initialNoteFilterInput1 = initialFilterInput1;\r\n\t\ttone.initialNoteFilterInput2 = initialFilterInput2;\r\n\t}\r\n\t\r\n\tprivate static spectrumSynth(synth: Synth, bufferIndex: number, runLength: number, tone: Tone, instrumentState: InstrumentState): void {\r\n\t\tconst data: Float32Array = synth.tempMonoInstrumentSampleBuffer!;\r\n\t\tconst wave: Float32Array = instrumentState.wave!;\r\n\t\tconst samplesInPeriod: number = (1 << 7);\r\n\t\tlet phaseDelta: number = tone.phaseDeltas[0] * samplesInPeriod;\r\n\t\tconst phaseDeltaScale: number = +tone.phaseDeltaScales[0];\r\n\t\tlet expression: number = +tone.expression;\r\n\t\tconst expressionDelta: number = +tone.expressionDelta;\r\n\t\tlet noiseSample: number = +tone.noiseSample;\r\n\t\t\r\n\t\tconst filters: DynamicBiquadFilter[] = tone.noteFilters;\r\n\t\tconst filterCount: number = tone.noteFilterCount|0;\r\n\t\tlet initialFilterInput1: number = +tone.initialNoteFilterInput1;\r\n\t\tlet initialFilterInput2: number = +tone.initialNoteFilterInput2;\r\n\t\tconst applyFilters: Function = Synth.applyFilters;\r\n\t\t\r\n\t\tlet phase: number = (tone.phases[0] % 1) * Config.spectrumNoiseLength;\r\n\t\t// Zero phase means the tone was reset, just give noise a random start phase instead.\r\n\t\tif (tone.phases[0] == 0.0) phase = Synth.findRandomZeroCrossing(wave, Config.spectrumNoiseLength) + phaseDelta;\r\n\t\tconst phaseMask: number = Config.spectrumNoiseLength - 1;\r\n\t\t\r\n\t\t// This is for a \"legacy\" style simplified 1st order lowpass filter with\r\n\t\t// a cutoff frequency that is relative to the tone's fundamental frequency.\r\n\t\tconst pitchRelativefilter: number = Math.min(1.0, phaseDelta);\r\n\t\t\r\n\t\tconst stopIndex: number = bufferIndex + runLength;\r\n\t\tfor (let sampleIndex: number = bufferIndex; sampleIndex < stopIndex; sampleIndex++) {\r\n\t\t\tconst phaseInt: number = phase|0;\r\n\t\t\tconst index: number = phaseInt & phaseMask;\r\n\t\t\tlet waveSample: number = wave[index];\r\n\t\t\tconst phaseRatio: number = phase - phaseInt;\r\n\t\t\twaveSample += (wave[index + 1] - waveSample) * phaseRatio;\r\n\t\t\t\r\n\t\t\tnoiseSample += (waveSample - noiseSample) * pitchRelativefilter;\r\n\t\t\t\r\n\t\t\tconst inputSample: number = noiseSample;\r\n\t\t\tconst sample: number = applyFilters(inputSample, initialFilterInput1, initialFilterInput2, filterCount, filters);\r\n\t\t\tinitialFilterInput2 = initialFilterInput1;\r\n\t\t\tinitialFilterInput1 = inputSample;\r\n\t\t\r\n\t\t\tphase += phaseDelta;\r\n\t\t\tphaseDelta *= phaseDeltaScale;\r\n\t\t\t\r\n\t\t\tconst output: number = sample * expression;\r\n\t\t\texpression += expressionDelta;\r\n\t\t\t\r\n\t\t\tdata[sampleIndex] += output;\r\n\t\t}\r\n\t\t\r\n\t\ttone.phases[0] = phase / Config.spectrumNoiseLength;\r\n\t\ttone.phaseDeltas[0] = phaseDelta / samplesInPeriod;\r\n\t\ttone.expression = expression;\r\n\t\ttone.noiseSample = noiseSample;\r\n\t\t\r\n\t\tsynth.sanitizeFilters(filters);\r\n\t\ttone.initialNoteFilterInput1 = initialFilterInput1;\r\n\t\ttone.initialNoteFilterInput2 = initialFilterInput2;\r\n\t}\r\n\t\r\n\tprivate static drumsetSynth(synth: Synth, bufferIndex: number, runLength: number, tone: Tone, instrumentState: InstrumentState): void {\r\n\t\tconst data: Float32Array = synth.tempMonoInstrumentSampleBuffer!;\r\n\t\tlet wave: Float32Array = instrumentState.getDrumsetWave(tone.drumsetPitch!);\r\n\t\tconst referenceDelta: number = InstrumentState.drumsetIndexReferenceDelta(tone.drumsetPitch!);\r\n\t\tlet phaseDelta: number = tone.phaseDeltas[0] / referenceDelta;\r\n\t\tconst phaseDeltaScale: number = +tone.phaseDeltaScales[0];\r\n\t\tlet expression: number = +tone.expression;\r\n\t\tconst expressionDelta: number = +tone.expressionDelta;\r\n\t\t\r\n\t\tconst filters: DynamicBiquadFilter[] = tone.noteFilters;\r\n\t\tconst filterCount: number = tone.noteFilterCount|0;\r\n\t\tlet initialFilterInput1: number = +tone.initialNoteFilterInput1;\r\n\t\tlet initialFilterInput2: number = +tone.initialNoteFilterInput2;\r\n\t\tconst applyFilters: Function = Synth.applyFilters;\r\n\t\t\r\n\t\tlet phase: number = (tone.phases[0] % 1) * Config.spectrumNoiseLength;\r\n\t\t// Zero phase means the tone was reset, just give noise a random start phase instead.\r\n\t\tif (tone.phases[0] == 0.0) phase = Synth.findRandomZeroCrossing(wave, Config.spectrumNoiseLength) + phaseDelta;\r\n\t\tconst phaseMask: number = Config.spectrumNoiseLength - 1;\r\n\t\t\r\n\t\tconst stopIndex: number = bufferIndex + runLength;\r\n\t\tfor (let sampleIndex: number = bufferIndex; sampleIndex < stopIndex; sampleIndex++) {\r\n\t\t\tconst phaseInt: number = phase|0;\r\n\t\t\tconst index: number = phaseInt & phaseMask;\r\n\t\t\tlet noiseSample: number = wave[index];\r\n\t\t\tconst phaseRatio: number = phase - phaseInt;\r\n\t\t\tnoiseSample += (wave[index + 1] - noiseSample) * phaseRatio;\r\n\t\t\t\r\n\t\t\tconst inputSample: number = noiseSample;\r\n\t\t\tconst sample: number = applyFilters(inputSample, initialFilterInput1, initialFilterInput2, filterCount, filters);\r\n\t\t\tinitialFilterInput2 = initialFilterInput1;\r\n\t\t\tinitialFilterInput1 = inputSample;\r\n\t\t\r\n\t\t\tphase += phaseDelta;\r\n\t\t\tphaseDelta *= phaseDeltaScale;\r\n\t\t\t\r\n\t\t\tconst output: number = sample * expression;\r\n\t\t\texpression += expressionDelta;\r\n\t\t\t\r\n\t\t\tdata[sampleIndex] += output;\r\n\t\t}\r\n\t\t\r\n\t\ttone.phases[0] = phase / Config.spectrumNoiseLength;\r\n\t\ttone.phaseDeltas[0] = phaseDelta * referenceDelta;\r\n\t\ttone.expression = expression;\r\n\t\t\r\n\t\tsynth.sanitizeFilters(filters);\r\n\t\ttone.initialNoteFilterInput1 = initialFilterInput1;\r\n\t\ttone.initialNoteFilterInput2 = initialFilterInput2;\r\n\t}\r\n\t\r\n\tprivate static findRandomZeroCrossing(wave: Float32Array, waveLength: number): number {\r\n\t\tlet phase: number = Math.random() * waveLength;\r\n\t\tconst phaseMask: number = waveLength - 1;\r\n\t\t\r\n\t\t// Spectrum and drumset waves sounds best when they start at a zero crossing,\r\n\t\t// otherwise they pop. Try to find a zero crossing.\r\n\t\tlet indexPrev: number = phase & phaseMask;\r\n\t\tlet wavePrev: number = wave[indexPrev];\r\n\t\tconst stride: number = 16;\r\n\t\tfor (let attemptsRemaining: number = 128; attemptsRemaining > 0; attemptsRemaining--) {\r\n\t\t\tconst indexNext: number = (indexPrev + stride) & phaseMask;\r\n\t\t\tconst waveNext: number = wave[indexNext];\r\n\t\t\tif (wavePrev * waveNext <= 0.0) {\r\n\t\t\t\t// Found a zero crossing! Now let's narrow it down to two adjacent sample indices.\r\n\t\t\t\tfor (let i: number = 0; i < stride; i++) {\r\n\t\t\t\t\tconst innerIndexNext: number = (indexPrev + 1) & phaseMask;\r\n\t\t\t\t\tconst innerWaveNext: number = wave[innerIndexNext];\r\n\t\t\t\t\tif (wavePrev * innerWaveNext <= 0.0) {\r\n\t\t\t\t\t\t// Found the zero crossing again! Now let's find the exact intersection.\r\n\t\t\t\t\t\tconst slope: number = innerWaveNext - wavePrev;\r\n\t\t\t\t\t\tphase = indexPrev;\r\n\t\t\t\t\t\tif (Math.abs(slope) > 0.00000001) {\r\n\t\t\t\t\t\t\tphase += -wavePrev / slope;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tphase = Math.max(0, phase) % waveLength;\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tindexPrev = innerIndexNext;\r\n\t\t\t\t\t\twavePrev = innerWaveNext;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\t\t\t} else {\r\n\t\t\t\tindexPrev = indexNext;\r\n\t\t\t\twavePrev = waveNext;\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\treturn phase;\r\n\t}\r\n\t\r\n\tpublic static instrumentVolumeToVolumeMult(instrumentVolume: number): number {\r\n\t\treturn (instrumentVolume == Config.volumeRange - 1) ? 0.0 : Math.pow(2, Config.volumeLogScale * instrumentVolume);\r\n\t}\r\n\tpublic static volumeMultToInstrumentVolume(volumeMult: number): number {\r\n\t\treturn (volumeMult <= 0.0) ? Config.volumeRange - 1 : Math.min(Config.volumeRange - 2, Math.log2(volumeMult) / Config.volumeLogScale);\r\n\t}\r\n\tpublic static noteSizeToVolumeMult(size: number): number {\r\n\t\treturn Math.pow(Math.max(0.0, size) / Config.noteSizeMax, 1.5);\r\n\t}\r\n\tpublic static volumeMultToNoteSize(volumeMult: number): number {\r\n\t\treturn Math.pow(Math.max(0.0, volumeMult), 1/1.5) * Config.noteSizeMax;\r\n\t}\r\n\t\r\n\tpublic static fadeInSettingToSeconds(setting: number): number {\r\n\t\treturn 0.0125 * (0.95 * setting + 0.05 * setting * setting);\r\n\t}\r\n\tpublic static secondsToFadeInSetting(seconds: number): number {\r\n\t\treturn clamp(0, Config.fadeInRange, Math.round((-0.95 + Math.sqrt(0.9025 + 0.2 * seconds / 0.0125)) / 0.1));\r\n\t}\r\n\tpublic static fadeOutSettingToTicks(setting: number): number {\r\n\t\treturn Config.fadeOutTicks[setting];\r\n\t}\r\n\tpublic static ticksToFadeOutSetting(ticks: number): number {\r\n\t\tlet lower: number = Config.fadeOutTicks[0];\r\n\t\tif (ticks <= lower) return 0;\r\n\t\tfor (let i: number = 1; i < Config.fadeOutTicks.length; i++) {\r\n\t\t\tlet upper: number = Config.fadeOutTicks[i];\r\n\t\t\tif (ticks <= upper) return (ticks < (lower + upper) / 2) ? i - 1 : i;\r\n\t\t\tlower = upper;\r\n\t\t}\r\n\t\treturn Config.fadeOutTicks.length - 1;\r\n\t}\r\n\t\r\n\tpublic static detuneToCents(detune: number): number {\r\n\t\treturn detune * (Math.abs(detune)+1) / 2;\r\n\t}\r\n\tpublic static centsToDetune(cents: number): number {\r\n\t\treturn Math.sign(cents) * (Math.sqrt(1 + 8 * Math.abs(cents)) - 1) / 2.0;\r\n\t}\r\n\t\r\n\tprivate getSamplesPerTick(): number {\r\n\t\tif (this.song == null) return 0;\r\n\t\tconst beatsPerMinute: number = this.song.getBeatsPerMinute();\r\n\t\tconst beatsPerSecond: number = beatsPerMinute / 60.0;\r\n\t\tconst partsPerSecond: number = Config.partsPerBeat * beatsPerSecond;\r\n\t\tconst tickPerSecond: number = Config.ticksPerPart * partsPerSecond;\r\n\t\treturn this.samplesPerSecond / tickPerSecond;\r\n\t}\r\n\t\r\n\tpublic static fittingPowerOfTwo(x: number): number {\r\n\t\treturn 1 << (32 - Math.clz32(Math.ceil(x) - 1));\r\n\t}\r\n\t\r\n\tprivate sanitizeFilters(filters: DynamicBiquadFilter[]): void {\r\n\t\tlet reset: boolean = false;\r\n\t\tfor (const filter of filters) {\r\n\t\t\tconst output1: number = Math.abs(filter.output1);\r\n\t\t\tconst output2: number = Math.abs(filter.output2);\r\n\t\t\t// If either is a large value, Infinity, or NaN, then just reset all filter history.\r\n\t\t\tif (!(output1 < 100) || !(output2 < 100)) {\r\n\t\t\t\treset = true;\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t\tif (output1 < epsilon) filter.output1 = 0.0;\r\n\t\t\tif (output2 < epsilon) filter.output2 = 0.0;\r\n\t\t}\r\n\t\tif (reset) {\r\n\t\t\tfor (const filter of filters) {\r\n\t\t\t\tfilter.output1 = 0.0;\r\n\t\t\t\tfilter.output2 = 0.0;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\t\r\n\tpublic static sanitizeDelayLine(delayLine: Float32Array, lastIndex: number, mask: number): void {\r\n\t\twhile (true) {\r\n\t\t\tlastIndex--;\r\n\t\t\tconst index: number = lastIndex & mask;\r\n\t\t\tconst sample: number = Math.abs(delayLine[index]);\r\n\t\t\tif (Number.isFinite(sample) && (sample == 0.0 || sample >= epsilon)) break;\r\n\t\t\tdelayLine[index] = 0.0;\r\n\t\t}\r\n\t}\r\n\t\r\n\tpublic static applyFilters(sample: number, input1: number, input2: number, filterCount: number, filters: DynamicBiquadFilter[]): number {\r\n\t\tfor (let i: number = 0; i < filterCount; i++) {\r\n\t\t\tconst filter: DynamicBiquadFilter = filters[i];\r\n\t\t\tconst output1: number = filter.output1;\r\n\t\t\tconst output2: number = filter.output2;\r\n\t\t\tconst a1: number = filter.a1;\r\n\t\t\tconst a2: number = filter.a2;\r\n\t\t\tconst b0: number = filter.b0;\r\n\t\t\tconst b1: number = filter.b1;\r\n\t\t\tconst b2: number = filter.b2;\r\n\t\t\tsample = b0 * sample + b1 * input1 + b2 * input2 - a1 * output1 - a2 * output2;\r\n\t\t\tfilter.a1 = a1 + filter.a1Delta;\r\n\t\t\tfilter.a2 = a2 + filter.a2Delta;\r\n\t\t\tif (filter.useMultiplicativeInputCoefficients) {\r\n\t\t\t\tfilter.b0 = b0 * filter.b0Delta;\r\n\t\t\t\tfilter.b1 = b1 * filter.b1Delta;\r\n\t\t\t\tfilter.b2 = b2 * filter.b2Delta;\r\n\t\t\t} else {\r\n\t\t\t\tfilter.b0 = b0 + filter.b0Delta;\r\n\t\t\t\tfilter.b1 = b1 + filter.b1Delta;\r\n\t\t\t\tfilter.b2 = b2 + filter.b2Delta;\r\n\t\t\t}\r\n\t\t\tfilter.output2 = output1;\r\n\t\t\tfilter.output1 = sample;\r\n\t\t\t// Updating the input values is waste if the next filter doesn't exist...\r\n\t\t\tinput2 = output2;\r\n\t\t\tinput1 = output1;\r\n\t\t}\r\n\t\treturn sample;\r\n\t}\r\n}\r\n\r\n// When compiling synth.ts as a standalone module named \"beepbox\", expose these imported classes as members to JavaScript:\r\nexport {Dictionary, DictionaryArray, FilterType, EnvelopeType, InstrumentType, Transition, Chord, Envelope, Config};\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nimport {HTML} from \"imperative-html/dist/esm/elements-strict\";\r\nimport {Prompt} from \"./Prompt\";\r\nimport {SongDocument} from \"./SongDocument\";\r\n\r\nconst {button, div, p, h2} = HTML;\r\n\r\nexport class TipPrompt implements Prompt {\r\n\tprivate readonly _closeButton: HTMLButtonElement = button({class: \"cancelButton\"});\r\n\t\r\n\tpublic readonly container: HTMLDivElement;\r\n\t\r\n\tconstructor(private _doc: SongDocument, type: string) {\r\n\t\tlet message: HTMLDivElement;\r\n\t\t\r\n\t\tswitch (type) {\r\n\t\t\tcase \"scale\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Scale\"),\r\n\t\t\t\t\tp(\"This setting limits the available pitches for adding notes. You may think that there's no point in limiting your choices, but the set of pitches you use has a strong influence on the mood and feel of your song, and these scales serve as guides to help you choose appropriate pitches. Don't worry, you can change the scale at any time, so you're not locked into it. Try making little melodies using all the available pitches of a scale to get a sense for how it sounds.\"),\r\n\t\t\t\t\tp(\"Most of the scales have a major version, marked with a smiley face, and a minor version, marked with a sad face. Assuming your song uses all pitches in the scale and especially \\\"tonic\\\" pitches (the brown rows in the pattern editor) then major scales tend to sound more playful or optimistic, whereas minor scales sound more serious or sad.\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"key\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Song Key\"),\r\n\t\t\t\t\tp(\"This setting can shift the frequency of every note in your entire song up or down, keeping the \\\"tonic\\\" pitches (the brown rows in the pattern editor) aligned with the selected \\\"key\\\" pitch.\"),\r\n\t\t\t\t\tp(\"If you've already placed some notes but they don't emphasize \\\"tonic\\\" pitches then the selected key isn't very meaningful. You can select the \\\"Detect Key\\\" option in the key menu to automatically align the most emphasized notes with \\\"tonic\\\" pitches.\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"tempo\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Song Tempo\"),\r\n\t\t\t\t\tp(\"This setting controls the speed of your song, measured in beats-per-minute. A \\\"beat\\\" is the duration of the little gray rectangles in the pattern editor. (In conventional music notation, a \\\"quarter note\\\" is usually equivalent to \\\"beat\\\".)\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"reverb\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Reverb\"),\r\n\t\t\t\t\tp(\"Reverb is like a continuous echo effect. A little bit helps instruments sound more natural. Adding a lot of reverb can add sense of depth or mystery, but too much reverb can kinda \\\"smear\\\" sounds so that it's harder to distinguish notes or instruments, especially for lower \\\"bass\\\" notes.\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"rhythm\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Rhythm\"),\r\n\t\t\t\t\tp(\"This setting determines how beats are divided. The pattern editor helps you align notes to fractions of a beat based on this setting.\"),\r\n\t\t\t\t\tp(\"If you've already placed some notes but they don't align with the selected rhythm, you can select the \\\"Snap Notes To Rhythm\\\" option in the rhythm menu to force the notes in the currently selected pattern(s) to align with the selected rhythm.\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"instrumentIndex\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Instrument Number\"),\r\n\t\t\t\t\tp(\"In the \\\"Channel Settings\\\" option from BeepBox's \\\"Edit\\\" menu, there are a few ways to enable multiple instruments per channel.\"),\r\n\t\t\t\t\tp(\"First, you could enable multiple simultaneous instruments per channel. All of the channel's instruments will play all of the notes in the channel at the same time, and you can click an instrument number to view and edit its settings.\"),\r\n\t\t\t\t\tp(\"Second, you could enable different instruments per pattern. Only one of the instruments will play at any given time, but you can click the instrument number to change which instrument is used for the currently selected pattern(s).\"),\r\n\t\t\t\t\tp(\"Finally, you can enable them both, in which case you can click an instrument number once to view it, and again to toggle whether the instrument is used for the currently selected pattern(s).\"),\r\n\t\t\t\t\tp(\"Either way, you can click the + button to add more instruments to a channel, and you can press shift and a number key on your keyboard to select an instrument as if you had clicked the corresponding button here.\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"instrumentVolume\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Instrument Volume\"),\r\n\t\t\t\t\tp(\"This setting controls the volume of the selected instrument without affecting the volume of the other instruments. This allows you to balance the loudness of each instrument relative to each other.\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"pan\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Instrument Panning\"),\r\n\t\t\t\t\tp(\"If you're listening through headphones or some other stereo sound system, this controls the position of the instrument and where the sound is coming from, ranging from left to right.\"),\r\n\t\t\t\t\tp(\"As a suggestion, composers often put lead melodies, drums, and basses in the center, and spread other instruments toward either side. If too many instruments seem like they're coming from the same place, it can feel crowded and harder to distinguish individual sounds, especially if they cover a similar pitch range.\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"instrumentType\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Instrument Type\"),\r\n\t\t\t\t\tp(\"BeepBox comes with many instrument presets, try them out! You can also create your own custom instruments!\"),\r\n\t\t\t\t\tp(\"There are also options for copying and pasting instrument settings and for generating random instruments at the top of the instrument type menu.\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"eqFilter\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"EQ Filter\"),\r\n\t\t\t\t\tp(\"Filters are a way of emphasizing or diminishing different parts of a sound. Musical notes have a fundamental (base) frequency, but the sound of a musical note also has parts at higher frequencies and filters can adjust the volume of each of these parts based on their frequency.\"),\r\n\t\t\t\t\tp(\"Click in the filter editor to insert, delete, or drag a filter control point. The horizontal position of the point determines which frequencies it affects, and the vertical position determines how the volume is affected at that frequency.\"),\r\n\t\t\t\t\tp(\"Insert a new point on the left side of the filter editor to add a \\\"high-pass\\\" filter point, which additionally reduces the volume of lower frequencies, or insert a new point on the right side to add a \\\"low-pass\\\" filter point which reduces the volume of higher frequencies.\"),\r\n\t\t\t\t\tp(\"You can also enable a \\\"Note Filter\\\" as an effect. EQ and note filters are mostly the same, but have different purposes. EQ filters are for overall adjustments, whereas note filters are for dynamic control and can be moved with envelopes. Note filters also change how the distortion effect sounds.\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"noteFilter\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Note Filter\"),\r\n\t\t\t\t\tp(\"Note filters are mostly the same as EQ filters, but have a different purpose. EQ filters are for overall adjustments, whereas note filters are for dynamic control and can be moved with envelopes. Note filters also change how the distortion effect sounds.\"),\r\n\t\t\t\t\tp(\"Filters are a way of emphasizing or diminishing different parts of a sound. Musical notes have a fundamental (base) frequency, but the sound of a musical note also has parts at higher frequencies and filters can adjust the volume of each of these parts based on their frequency.\"),\r\n\t\t\t\t\tp(\"Click in the filter editor to insert, delete, or drag a filter control point. The horizontal position of the point determines which frequencies it affects, and the vertical position determines how the volume is affected at that frequency.\"),\r\n\t\t\t\t\tp(\"Insert a new point on the left side of the filter editor to add a \\\"high-pass\\\" filter point, which additionally reduces the volume of lower frequencies, or insert a new point on the right side to add a \\\"low-pass\\\" filter point which reduces the volume of higher frequencies.\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"fadeInOut\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Fade In/Out\"),\r\n\t\t\t\t\tp(\"This setting controls how long it takes for notes to reach full volume at the beginning or decay to silence at the end.\"),\r\n\t\t\t\t\tp(\"An instant fade-in sounds like instruments that are played by hitting or plucking, whereas slower fade-ins sound like instruments that are played by blowing air.\"),\r\n\t\t\t\t\tp(\"You can also make the fade-out start before the note ends to leave a gap before the next note starts, or after the note ends to allow the sound of the end of the note to overlap with the start of the next note.\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"transition\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Transition\"),\r\n\t\t\t\t\tp(\"Usually, when one note ends at the same time another begins, the old note will fade out and the new note will fade in based on the fade in/out settings, but this setting can override that, connecting the end of one note to the beginning of the next.\"),\r\n\t\t\t\t\tp(\"The \\\"interrupt\\\" transition makes the wave suddenly change from the old note's frequency to the new note's frequency without any fading, but still restarts envelopes at the beginning of the new note. The \\\"continue\\\" transition is similar but it doesn't even restart envelopes, and can be used to make each of the notes in a chord start or stop at different times!\"),\r\n\t\t\t\t\tp(\"The \\\"slide\\\" transition makes the pitch shift quickly but not instantaneously from the old note's frequency to the new note's frequency, and softly restarts envelopes. The \\\"slide in pattern\\\" transition is the same except it doesn't connect the last note in a pattern to the first note in the next pattern.\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"chipWave\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Chip Wave\"),\r\n\t\t\t\t\tp(\"BeepBox comes with some sound waves based on classic electronic sound chips, as well as several unique waves. This is the basic source of the sound of the instrument, which is modified by the other instrument settings.\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"chipNoise\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Noise\"),\r\n\t\t\t\t\tp(\"BeepBox comes with several basic noise sounds. These do not have any distinct musical pitch, and can be used like drums to create beats and emphasize your song's rhythm.\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"supersawDynamism\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Supersaw Dynamism\"),\r\n\t\t\t\t\tp(\"A supersaw is a combination of many sawtooth waves, and this setting controls the contribution of extra sawtooth waves.\"),\r\n\t\t\t\t\tp(\"At the low end of the slider, only the first wave is contributing to the sound, which sounds like an ordinary static sawtooth wave. At the maximum setting, all of the waves are contributing equally and the resulting tone can randomly shift depending on how the waves line up with each other, similar to the \\\"unison\\\" and \\\"chorus\\\" settings.\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"supersawSpread\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Supersaw Spread\"),\r\n\t\t\t\t\tp(\"A supersaw is a combination of many sawtooth waves, and this setting controls the distance between their frequencies. The dynamism setting must be used for the extra waves to have any effect.\"),\r\n\t\t\t\t\tp(\"At the low end of the spread slider, all of the voices have the same frequency but random phase, resulting in a different sound every time a note starts. In the middle, the waves all have slightly different frequencies that shift in and out of phase over time similar to the \\\"unison\\\" and \\\"chorus\\\" settings, creating a classic supersaw sound. At the extreme end, the frequencies are so far apart they sound dissonant.\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"supersawShape\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Supersaw Shape\"),\r\n\t\t\t\t\tp(\"This supersaw instrument includes an option to change the shape of the waves from sawtooth waves to pulse waves. Use this setting to morph between the two shapes.\"),\r\n\t\t\t\t\tp(\"When a pulse wave shape is used, you can also control the pulse width with a separate setting.\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"pulseWidth\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Pulse Wave Width\"),\r\n\t\t\t\t\tp(\"This setting controls the shape and sound of a pulse wave. At the minimum width, it sounds light and buzzy. At the maximum width, it is shaped like a classic square wave.\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"unison\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Unison\"),\r\n\t\t\t\t\tp(\"This instrument can play two identical waves at different frequencies. When two waves play at slightly different frequencies, they move in and out of phase with each other over time as different parts of the waves line up. This creates a dynamic, shifting sound. Pianos are a common example of this kind of sound, because each piano key strikes multiple strings that are tuned to slightly different frequencies.\"),\r\n\t\t\t\t\tp(\"The distance between two frequencies is called an \\\"interval\\\", and this setting controls how large it is. If the interval is too wide, then the waves may sound out-of-tune and \\\"dissonant\\\". However, if the interval is even larger, then the two frequencies can even be distinct pitches.\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"chords\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Chords\"),\r\n\t\t\t\t\tp(\"When multiple different notes occur at the same time, this is called a chord. Chords can be created in BeepBox's pattern editor by adding notes above or below another note.\"),\r\n\t\t\t\t\tp(\"This setting determines how chords are played. The standard option is \\\"simultaneous\\\" which starts playing all of the pitches in a chord at the same instant. The \\\"strum\\\" option is similar, but plays the notes starting at slightly different times. The \\\"arpeggio\\\" option is used in \\\"chiptune\\\" style music and plays a single tone that rapidly alternates between all of the pitches in the chord.\"),\r\n\t\t\t\t\tp(\"Some BeepBox instruments have an option called \\\"custom interval\\\" which uses the chord notes to control the interval between the waves of a single tone. This can create strange sound effects when combined with FM modulators.\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"vibrato\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Vibrato\"),\r\n\t\t\t\t\tp(\"This setting causes the frequency of a note to wobble slightly. Singers and violinists often use vibrato.\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"algorithm\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"FM Algorithm\"),\r\n\t\t\t\t\tp('FM Synthesis is a mysterious but powerful technique for crafting sounds, popularized by Yamaha keyboards and the Sega Genesis/Mega Drive. It may seem confusing, but try playing around with the options until you get a feel for it, or check out some of the preset examples!'),\r\n\t\t\t\t\tp('This FM synthesizer uses up to four waves, numbered 1, 2, 3, and 4. Each wave may have its own frequency and volume.'),\r\n\t\t\t\t\tp('There are two kinds of waves: \"carrier\" waves play a tone out loud, but \"modulator\" waves distort other waves instead. Wave 1 is always a carrier and plays a tone, but other waves may distort it. The \"Algorithm\" setting determines which waves are modulators, and which other waves those modulators distort. For example, \"12\" means that wave 2 modulates wave 1, and wave 1 plays out loud.'),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"feedbackType\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Feedback Type\"),\r\n\t\t\t\t\tp('Modulators distort in one direction (like 12), but you can also use the feedback setting to make any wave distort in the opposite direction (12), or even itself (1).'),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"feedbackVolume\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Feedback Distortion\"),\r\n\t\t\t\t\tp(\"This setting controls the amount of feedback distortion based on the feedback type setting.\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"operatorFrequency\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Operator Frequency\"),\r\n\t\t\t\t\tp('This setting controls the frequency of an individual FM wave, relative to the fundamental frequency of the note. The multiplier 1 is the same as the fundamental frequency, whereas 2x would be an octave (12 semitones) above it. The frequencies with a \"~\" are slightly detuned and shift in and out of phase over time compared to the other frequencies.'),\r\n\t\t\t\t\tp('Try different combinations of a \"carrier\" wave and a \"modulator\" wave with different frequencies to get a feel for how they sound together.'),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"operatorVolume\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Operator Volume\"),\r\n\t\t\t\t\tp(\"This setting controls the volume of \\\"carrier\\\" waves, or the amount of distortion that \\\"modulator\\\" waves apply to other waves.\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"spectrum\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Spectrum\"),\r\n\t\t\t\t\tp(\"This setting allows you to draw your own noise spectrum! This is good for making drum sounds.\"),\r\n\t\t\t\t\tp(\"If you only use certain frequencies and a soft fade in/out, it's also possible to make howling wind sounds or even musical wind instruments.\"),\r\n\t\t\t\t\tp(\"The left side of the spectrum editor controls the noise energy at lower frequencies, and the right side controls higher frequencies.\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"harmonics\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Harmonics\"),\r\n\t\t\t\t\tp(\"This setting allows you to design your own sound wave! Most musical waves are actually a combination of sine waves at certain frequencies, and this lets you control the volume of each sine wave individually.\"),\r\n\t\t\t\t\tp(\"The left side of the harmonics editor controls the sine wave volumes at lower frequencies, and the right side controls higher frequencies.\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"effects\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Effects\"),\r\n\t\t\t\t\tp(\"BeepBox has many different kinds of special effects you can add to instruments. You can turn on multiple effects at once, and they can be configured individually. Try them all out!\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"drumsetEnvelope\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Drumset Envelope\"),\r\n\t\t\t\t\tp(\"This drumset comes with a low-pass filter, and this setting can dynamically change the low-pass filter frequency over time. Each row in the pattern editor can have a different envelope shape.\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"drumsetSpectrum\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Drumset Spectrum\"),\r\n\t\t\t\t\tp(\"This setting allows you to draw your own noise spectrum! This is good for making drumsets. Each row in the pattern editor gets its own spectrum.\"),\r\n\t\t\t\t\tp(\"The left side of the spectrum editor controls the noise energy at lower frequencies, and the right side controls higher frequencies.\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"chorus\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Chorus\"),\r\n\t\t\t\t\tp(\"The chorus effect combines multiple copies of the instrument's sound and adds a bit of vibrato to simulate an ensemble of instruments or voices. Drag the slider to control how much chorus is added.\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"echoSustain\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Echo Volume\"),\r\n\t\t\t\t\tp(\"The echo effect repeats the instrument's sound after a delay. Each echo is a little bit quieter than the last, and this setting controls how much quieter.\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"echoDelay\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Echo Delay\"),\r\n\t\t\t\t\tp(\"The echo effect repeats the instrument's sound after a delay, and this setting controls how long the delay is.\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"pitchShift\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Pitch Shift\"),\r\n\t\t\t\t\tp(\"This setting makes instruments play higher or lower pitches than the ones displayed in the pattern editor. Be careful that you don't confuse yourself!\"),\r\n\t\t\t\t\tp(\"You can combine this with envelopes to bend pitch over time, or play multiple simultaneous instruments with different pitch shifts for interesting layered sounds.\"),\r\n\t\t\t\t\tp(\"The intervals created by this setting are in \\\"just intonation\\\" which means they stay in phase with the original pitch instead of shifting in and out of phase over time. If you want the shifting, add the detune effect!\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"detune\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Detune\"),\r\n\t\t\t\t\tp(\"This setting slightly adjusts the frequency of notes played by the instrument. You can use a little bit to add a pleasing shifting sound similar to the \\\"unison\\\" feature when combined with other instruments. If you use too much, then the instrument may sound unpleasantly out-of-tune.\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"distortion\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Distortion\"),\r\n\t\t\t\t\tp(\"This is the famous electric guitar effect! However, there are some things to be aware of.\"),\r\n\t\t\t\t\tp(\"First, most chords don't sound right when combined with heavy distortion. The only chords commonly used with distorted electric guitars are \\\"power chords\\\" which consist of a root note, a \\\"fifth\\\" note above that, and/or any octaves of those two notes.\"),\r\n\t\t\t\t\tp(\"Second, the distortion sound depends a lot on filtering. In particular, I recommend enabling the note filter effect, and adding both high-pass and low-pass points to the note filter. (Note filters are applied first, then distortion which transforms the sound based on that filtering, then the EQ filter is applied last.)\"),\r\n\t\t\t\t\tp(\"Finally, I recommend adjusting the fade-out setting to allow the end of each note to overlap a little bit with the beginning of the next, but not too much!\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"bitcrusherQuantization\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Bitcrusher Quantization\"),\r\n\t\t\t\t\tp(\"This effect makes stuff sounds harsher, artificial, and \\\"low quality\\\", which is great if that's what you're going for!\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"bitcrusherFreq\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Frequency Quantization\"),\r\n\t\t\t\t\tp(\"The bitcrusher effect comes with an additional frequency quantization effect! This is a fun one to play with, especially when combined with the note filter effect.\"),\r\n\t\t\t\t\tp(\"Every other notch on this slider is aligned with the currently selected key of the song, and the in-between notches are aligned with the tritones of the key.\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tcase \"envelopes\": {\r\n\t\t\t\tmessage = div(\r\n\t\t\t\t\th2(\"Envelopes\"),\r\n\t\t\t\t\tp(\"Envelopes are a way to dynamically adjust various other settings over time, usually based on how long the note lasts. Press the + button to add an envelope, then use the menus below to select which setting to control and the curve of the envelope. Try different combinations to see how they sound!\"),\r\n\t\t\t\t\tp(\"Most envelope curves restart from the beginning every time a new note plays. The \\\"note size\\\" option is based on the note width as drawn in the pattern editor.\"),\r\n\t\t\t\t\tp(\"Envelope curves move in the range from 0 to 1 (or vice versa), where 0 means as quiet as possible and 1 is the same as the corresponding position selected in the instrument settings above. If multiple envelopes are targetting the same setting, they are multiplied before applying to the setting.\"),\r\n\t\t\t\t);\r\n\t\t\t} break;\r\n\t\t\tdefault: throw new Error(\"Unhandled TipPrompt type: \" + type);\r\n\t\t}\r\n\t\t\r\n\t\tthis.container = div({class: \"prompt\", style: \"width: 300px;\"},\r\n\t\t\tmessage,\r\n\t\t\tthis._closeButton,\r\n\t\t);\r\n\t\t\r\n\t\tsetTimeout(()=>this._closeButton.focus());\r\n\t\t\r\n\t\tthis._closeButton.addEventListener(\"click\", this._close);\r\n\t}\r\n\t\r\n\tprivate _close = (): void => { \r\n\t\tthis._doc.undo();\r\n\t}\r\n\t\r\n\tpublic cleanUp = (): void => { \r\n\t\tthis._closeButton.removeEventListener(\"click\", this._close);\r\n\t}\r\n}\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nexport class Change {\r\n\tprivate _noop: boolean = true;\r\n\t\r\n\tprotected _didSomething(): void {\r\n\t\tthis._noop = false;\r\n\t}\r\n\t\r\n\tpublic isNoop(): boolean {\r\n\t\treturn this._noop;\r\n\t}\r\n\t\r\n\tpublic commit(): void {}\r\n}\r\n\r\nexport class UndoableChange extends Change {\r\n\tprivate _reversed: boolean;\r\n\tprivate _doneForwards: boolean;\r\n\tconstructor(reversed: boolean) {\r\n\t\tsuper();\r\n\t\tthis._reversed = reversed;\r\n\t\tthis._doneForwards = !reversed;\r\n\t}\r\n\t\r\n\tpublic undo(): void {\r\n\t\tif (this._reversed) {\r\n\t\t\tthis._doForwards();\r\n\t\t\tthis._doneForwards = true;\r\n\t\t} else {\r\n\t\t\tthis._doBackwards();\r\n\t\t\tthis._doneForwards = false;\r\n\t\t}\r\n\t}\r\n\t\r\n\tpublic redo(): void {\r\n\t\tif (this._reversed) {\r\n\t\t\tthis._doBackwards();\r\n\t\t\tthis._doneForwards = false;\r\n\t\t} else {\r\n\t\t\tthis._doForwards();\r\n\t\t\tthis._doneForwards = true;\r\n\t\t}\r\n\t}\r\n\t\r\n\t// isDoneForwards() returns whether or not the Change was most recently \r\n\t// performed forwards or backwards. If the change created something, do not \r\n\t// delete it in the change destructor unless the Change was performed \r\n\t// backwards: \r\n\tprotected _isDoneForwards(): boolean {\r\n\t\treturn this._doneForwards;\r\n\t}\r\n\t\r\n\tprotected _doForwards(): void {\r\n\t\tthrow new Error(\"Change.doForwards(): Override me.\");\r\n\t}\r\n\t\r\n\tprotected _doBackwards(): void {\r\n\t\tthrow new Error(\"Change.doBackwards(): Override me.\");\r\n\t}\r\n}\r\n\r\nexport class ChangeGroup extends Change {\r\n\tconstructor() {\r\n\t\tsuper();\r\n\t}\r\n\t\r\n\tpublic append(change: Change): void {\r\n\t\tif (change.isNoop()) return;\r\n\t\tthis._didSomething();\r\n\t}\r\n}\r\n\r\nexport class ChangeSequence extends UndoableChange {\r\n\tprivate _changes: UndoableChange[];\r\n\tconstructor(changes?: UndoableChange[]) {\r\n\t\tsuper(false);\r\n\t\tif (changes == undefined) {\r\n\t\t\tthis._changes = [];\r\n\t\t} else {\r\n\t\t\tthis._changes = changes.concat();\r\n\t\t}\r\n\t}\r\n\t\r\n\tpublic append(change: UndoableChange): void {\r\n\t\tif (change.isNoop()) return;\r\n\t\tthis._changes[this._changes.length] = change;\r\n\t\tthis._didSomething();\r\n\t}\r\n\t\r\n\tprotected _doForwards(): void {\r\n\t\tfor (let i: number = 0; i < this._changes.length; i++) {\r\n\t\t\tthis._changes[i].redo();\r\n\t\t}\r\n\t}\r\n\t\r\n\tprotected _doBackwards(): void {\r\n\t\tfor (let i: number = this._changes.length-1; i >= 0 ; i--) {\r\n\t\t\tthis._changes[i].undo();\r\n\t\t}\r\n\t}\r\n}\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nimport {Algorithm, Dictionary, FilterType, SustainType, InstrumentType, EffectType, AutomationTarget, Config, effectsIncludePanning, effectsIncludeDistortion} from \"../synth/SynthConfig\";\r\nimport {NotePin, Note, makeNotePin, Pattern, FilterSettings, FilterControlPoint, SpectrumWave, HarmonicsWave, Instrument, Channel, Song, Synth} from \"../synth/synth\";\r\nimport {Preset, PresetCategory, EditorConfig} from \"./EditorConfig\";\r\nimport {Change, ChangeGroup, ChangeSequence, UndoableChange} from \"./Change\";\r\nimport {SongDocument} from \"./SongDocument\";\r\n\r\nexport function patternsContainSameInstruments(pattern1Instruments: number[], pattern2Instruments: number[]): boolean {\r\n\tconst pattern2Has1Instruments: boolean = pattern1Instruments.every(instrument => pattern2Instruments.indexOf(instrument) != -1);\r\n\tconst pattern1Has2Instruments: boolean = pattern2Instruments.every(instrument => pattern1Instruments.indexOf(instrument) != -1);\r\n\treturn pattern2Has1Instruments && pattern1Has2Instruments && pattern2Instruments.length == pattern1Instruments.length;\r\n}\r\n\r\nexport function discardInvalidPatternInstruments(instruments: number[], song: Song, channelIndex: number) {\r\n\tconst uniqueInstruments: Set<number> = new Set(instruments);\r\n\tinstruments.length = 0;\r\n\tinstruments.push(...uniqueInstruments);\r\n\tfor (let i: number = 0; i < instruments.length; i++) {\r\n\t\tif (instruments[i] >= song.channels[channelIndex].instruments.length) {\r\n\t\t\tinstruments.splice(i, 1);\r\n\t\t\ti--;\r\n\t\t}\r\n\t}\r\n\tif (instruments.length > song.getMaxInstrumentsPerPattern(channelIndex)) {\r\n\t\tinstruments.length = song.getMaxInstrumentsPerPattern(channelIndex);\r\n\t}\r\n\tif (instruments.length <= 0) {\r\n\t\tinstruments[0] = 0;\r\n\t}\r\n}\r\n\r\nexport function unionOfUsedNotes(pattern: Pattern, flags: boolean[]): void {\r\n\tfor (const note of pattern.notes) {\r\n\t\tfor (const pitch of note.pitches) {\r\n\t\t\tfor (const pin of note.pins) {\r\n\t\t\t\tconst key: number = (pitch + pin.interval) % 12;\r\n\t\t\t\tif (!flags[key]) {\r\n\t\t\t\t\tflags[key] = true;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport function generateScaleMap(oldScaleFlags: ReadonlyArray<boolean>, newScaleValue: number): number[] {\r\n\tconst newScaleFlags: ReadonlyArray<boolean> = Config.scales[newScaleValue].flags;\r\n\tconst oldScale: number[] = [];\r\n\tconst newScale: number[] = [];\r\n\tfor (let i: number = 0; i <  12; i++) {\r\n\t\tif (oldScaleFlags[i]) oldScale.push(i);\r\n\t\tif (newScaleFlags[i]) newScale.push(i);\r\n\t}\r\n\tconst largerToSmaller: boolean = oldScale.length > newScale.length;\r\n\tconst smallerScale: number[] = largerToSmaller ? newScale : oldScale;\r\n\tconst largerScale: number[] = largerToSmaller ? oldScale : newScale;\r\n\r\n\tconst roles: string[] = [\"root\", \"second\", \"second\", \"third\", \"third\", \"fourth\", \"tritone\", \"fifth\", \"sixth\", \"sixth\", \"seventh\", \"seventh\", \"root\"];\r\n\tlet bestScore: number = Number.MAX_SAFE_INTEGER;\r\n\tlet bestIndexMap: number[] = [];\r\n\tconst stack: number[][] = [[0]]; // Root always maps to root.\r\n\r\n\twhile (stack.length > 0) {\r\n\t\tconst indexMap: number[] = stack.pop()!;\r\n\r\n\t\tif (indexMap.length == smallerScale.length) {\r\n\t\t\t// Score this mapping.\r\n\t\t\tlet score: number = 0;\r\n\t\t\tfor (let i: number = 0; i < indexMap.length; i++) {\r\n\t\t\t\tscore += Math.abs(smallerScale[i] - largerScale[indexMap[i]]);\r\n\t\t\t\tif (roles[smallerScale[i]] != roles[largerScale[indexMap[i]]]) {\r\n\t\t\t\t\t// Penalize changing roles.\r\n\t\t\t\t\tscore += 0.75;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tif (bestScore > score) {\r\n\t\t\t\tbestScore = score;\r\n\t\t\t\tbestIndexMap = indexMap;\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\t// Recursively choose next indices for mapping.\r\n\t\t\tconst lowIndex: number = indexMap[indexMap.length - 1] + 1;\r\n\t\t\tconst highIndex: number = largerScale.length - smallerScale.length + indexMap.length;\r\n\t\t\tfor (let i: number = lowIndex; i <= highIndex; i++) {\r\n\t\t\t\tstack.push(indexMap.concat(i));\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tconst sparsePitchMap: number[][] = [];\r\n\tfor (let i: number = 0; i < bestIndexMap.length; i++) {\r\n\t\tconst smallerScalePitch = smallerScale[i];\r\n\t\tconst largerScalePitch = largerScale[bestIndexMap[i]];\r\n\t\tsparsePitchMap[i] = largerToSmaller\r\n\t\t\t? [largerScalePitch, smallerScalePitch]\r\n\t\t\t: [smallerScalePitch, largerScalePitch];\r\n\t}\r\n\r\n\t// To make it easier to wrap around.\r\n\tsparsePitchMap.push([12, 12]);\r\n\tnewScale.push(12);\r\n\r\n\tlet sparseIndex: number = 0;\r\n\tconst fullPitchMap: number[] = [];\r\n\tfor (let i: number = 0; i <  12; i++) {\r\n\t\tconst oldLow: number = sparsePitchMap[sparseIndex][0];\r\n\t\tconst newLow: number = sparsePitchMap[sparseIndex][1];\r\n\t\tconst oldHigh: number = sparsePitchMap[sparseIndex + 1][0];\r\n\t\tconst newHigh: number = sparsePitchMap[sparseIndex + 1][1];\r\n\t\tif (i == oldHigh - 1) sparseIndex++;\r\n\r\n\t\tconst transformedPitch: number = (i - oldLow) * (newHigh - newLow) / (oldHigh - oldLow) + newLow;\r\n\r\n\t\tlet nearestPitch: number = 0;\r\n\t\tlet nearestPitchDistance: number = Number.MAX_SAFE_INTEGER;\r\n\t\tfor (const newPitch of newScale) {\r\n\t\t\tlet distance: number = Math.abs(newPitch - transformedPitch);\r\n\t\t\tif (roles[newPitch] != roles[i]) {\r\n\t\t\t\t// Again, penalize changing roles.\r\n\t\t\t\tdistance += 0.1;\r\n\t\t\t}\r\n\t\t\tif (nearestPitchDistance > distance) {\r\n\t\t\t\tnearestPitchDistance = distance;\r\n\t\t\t\tnearestPitch = newPitch;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tfullPitchMap[i] = nearestPitch;\r\n\t}\r\n\t\r\n\treturn fullPitchMap;\r\n}\r\n\r\nfunction removeRedundantPins(pins: NotePin[]): void {\r\n\tfor (let i: number = 1; i < pins.length - 1; ) {\r\n\t\tconst prevPin: NotePin = pins[i-1];\r\n\t\tconst pin: NotePin = pins[i];\r\n\t\tconst nextPin: NotePin = pins[i+1];\r\n\t\tconst prevTimeSpan: number = pin.time - prevPin.time;\r\n\t\tconst nextTimeSpan: number = nextPin.time - pin.time;\r\n\t\tif ((pin.interval - prevPin.interval) * nextTimeSpan == (nextPin.interval - pin.interval) * prevTimeSpan &&\r\n\t\t\t(pin.size - prevPin.size) * nextTimeSpan == (nextPin.size - pin.size) * prevTimeSpan)\r\n\t\t{\r\n\t\t\tpins.splice(i, 1);\r\n\t\t} else {\r\n\t\t\ti++;\r\n\t\t}\r\n\t}\r\n}\r\n\r\nfunction projectNoteIntoBar(oldNote: Note, timeOffset: number, noteStartPart: number, noteEndPart: number, newNotes: Note[]): void {\r\n\t// Create a new note, and interpret the pitch bend and size events\r\n\t// to determine where we need to insert pins to control interval and volume.\r\n\tconst newNote: Note = new Note(-1, noteStartPart, noteEndPart, Config.noteSizeMax, false);\r\n\tnewNote.pins.length = 0;\r\n\tnewNote.pitches.length = 0;\r\n\tconst newNoteLength: number = noteEndPart - noteStartPart;\r\n\r\n\tfor (const pitch of oldNote.pitches) {\r\n\t\tnewNote.pitches.push(pitch);\r\n\t}\r\n\t\r\n\tfor (let pinIndex: number = 0; pinIndex < oldNote.pins.length; pinIndex++) {\r\n\t\tconst pin: NotePin = oldNote.pins[pinIndex];\r\n\t\tconst newPinTime: number = pin.time + timeOffset;\r\n\t\tif (newPinTime < 0) {\r\n\t\t\tif (pinIndex + 1 >= oldNote.pins.length) throw new Error(\"Error converting pins in note overflow.\");\r\n\t\t\tconst nextPin: NotePin = oldNote.pins[pinIndex + 1];\r\n\t\t\tconst nextPinTime: number = nextPin.time + timeOffset;\r\n\t\t\tif (nextPinTime > 0) {\r\n\t\t\t\t// Insert an interpolated pin at the start of the new note.\r\n\t\t\t\tconst ratio: number = (-newPinTime) / (nextPinTime - newPinTime);\r\n\t\t\t\tnewNote.pins.push(makeNotePin(Math.round(pin.interval + ratio * (nextPin.interval - pin.interval)), 0, Math.round(pin.size + ratio * (nextPin.size - pin.size))));\r\n\t\t\t}\r\n\t\t} else if (newPinTime <= newNoteLength) {\r\n\t\t\tnewNote.pins.push(makeNotePin(pin.interval, newPinTime, pin.size));\r\n\t\t} else {\r\n\t\t\tif (pinIndex < 1) throw new Error(\"Error converting pins in note overflow.\");\r\n\t\t\tconst prevPin: NotePin = oldNote.pins[pinIndex - 1];\r\n\t\t\tconst prevPinTime: number = prevPin.time + timeOffset;\r\n\t\t\tif (prevPinTime < newNoteLength) {\r\n\t\t\t\t// Insert an interpolated pin at the end of the new note.\r\n\t\t\t\tconst ratio: number = (newNoteLength - prevPinTime) / (newPinTime - prevPinTime);\r\n\t\t\t\tnewNote.pins.push(makeNotePin(Math.round(prevPin.interval + ratio * (pin.interval - prevPin.interval)), newNoteLength, Math.round(prevPin.size + ratio * (pin.size - prevPin.size))));\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\t\r\n\t// Fix from Jummbus: Ensure the first pin's interval is zero, adjust pitches and pins to compensate.\r\n\tconst offsetInterval: number = newNote.pins[0].interval;\r\n\tfor (let pitchIdx: number = 0; pitchIdx < newNote.pitches.length; pitchIdx++) {\r\n\t\tnewNote.pitches[pitchIdx] += offsetInterval;\r\n\t}\r\n\tfor (let pinIdx: number = 0; pinIdx < newNote.pins.length; pinIdx++) {\r\n\t\tnewNote.pins[pinIdx].interval -= offsetInterval;\r\n\t}\r\n\t\r\n\tlet joinedWithPrevNote: boolean = false;\r\n\tif (newNote.start == 0) {\r\n\t\tnewNote.continuesLastPattern = (timeOffset < 0 || oldNote.continuesLastPattern);\r\n\t} else {\r\n\t\tnewNote.continuesLastPattern = false;\r\n\t\tif (newNotes.length > 0 && oldNote.continuesLastPattern) {\r\n\t\t\tconst prevNote: Note = newNotes[newNotes.length - 1];\r\n\t\t\tif (prevNote.end == newNote.start && Synth.adjacentNotesHaveMatchingPitches(prevNote, newNote)) {\r\n\t\t\t\tjoinedWithPrevNote = true;\r\n\t\t\t\tconst newIntervalOffset: number = prevNote.pins[prevNote.pins.length - 1].interval;\r\n\t\t\t\tconst newTimeOffset: number = prevNote.end - prevNote.start;\r\n\t\t\t\tfor (let pinIndex: number = 1; pinIndex < newNote.pins.length; pinIndex++) {\r\n\t\t\t\t\tconst tempPin: NotePin = newNote.pins[pinIndex];\r\n\t\t\t\t\tconst transformedPin: NotePin = makeNotePin(tempPin.interval + newIntervalOffset, tempPin.time + newTimeOffset, tempPin.size);\r\n\t\t\t\t\tprevNote.pins.push(transformedPin);\r\n\t\t\t\t\tprevNote.end = prevNote.start + transformedPin.time;\r\n\t\t\t\t}\r\n\t\t\t\tremoveRedundantPins(prevNote.pins);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\tif (!joinedWithPrevNote) {\r\n\t\tnewNotes.push(newNote);\r\n\t}\r\n}\r\n\r\nexport class ChangeMoveAndOverflowNotes extends ChangeGroup {\r\n\tconstructor(doc: SongDocument, newBeatsPerBar: number, partsToMove: number) {\r\n\t\tsuper();\r\n\t\t\r\n\t\tconst pitchChannels: Channel[] = [];\r\n\t\tconst noiseChannels: Channel[] = [];\r\n\t\t\r\n\t\tfor (let channelIndex: number = 0; channelIndex < doc.song.getChannelCount(); channelIndex++) {\r\n\t\t\tconst oldChannel: Channel = doc.song.channels[channelIndex];\r\n\t\t\tconst newChannel: Channel = new Channel();\r\n\t\t\tif (channelIndex < doc.song.pitchChannelCount) {\r\n\t\t\t\tpitchChannels.push(newChannel);\r\n\t\t\t} else {\r\n\t\t\t\tnoiseChannels.push(newChannel);\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tnewChannel.muted = oldChannel.muted;\r\n\t\t\tnewChannel.octave = oldChannel.octave;\r\n\t\t\tfor (const instrument of oldChannel.instruments) {\r\n\t\t\t\tnewChannel.instruments.push(instrument);\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tconst oldPartsPerBar: number = Config.partsPerBeat * doc.song.beatsPerBar;\r\n\t\t\tconst newPartsPerBar: number = Config.partsPerBeat * newBeatsPerBar;\r\n\t\t\tlet currentBar: number = -1;\r\n\t\t\tlet pattern: Pattern | null = null;\r\n\t\t\t\r\n\t\t\tfor (let oldBar: number = 0; oldBar < doc.song.barCount; oldBar++) {\r\n\t\t\t\tconst oldPattern: Pattern | null = doc.song.getPattern(channelIndex, oldBar);\r\n\t\t\t\tif (oldPattern != null) {\r\n\t\t\t\t\tconst oldBarStart: number = oldBar * oldPartsPerBar;\r\n\t\t\t\t\tfor (const oldNote of oldPattern.notes) {\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tconst absoluteNoteStart: number = oldNote.start + oldBarStart + partsToMove;\r\n\t\t\t\t\t\tconst absoluteNoteEnd: number = oldNote.end + oldBarStart + partsToMove;\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tconst startBar: number = Math.floor(absoluteNoteStart / newPartsPerBar);\r\n\t\t\t\t\t\tconst endBar: number = Math.ceil(absoluteNoteEnd / newPartsPerBar);\r\n\t\t\t\t\t\tfor (let bar: number = startBar; bar < endBar; bar++) {\r\n\t\t\t\t\t\t\tconst barStartPart: number = bar * newPartsPerBar;\r\n\t\t\t\t\t\t\tconst noteStartPart: number = Math.max(0, absoluteNoteStart - barStartPart);\r\n\t\t\t\t\t\t\tconst noteEndPart: number = Math.min(newPartsPerBar, absoluteNoteEnd - barStartPart);\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tif (noteStartPart < noteEndPart) {\r\n\t\t\t\t\t\t\t\t// Ensure a pattern exists for the current bar before inserting notes into it.\r\n\t\t\t\t\t\t\t\tif (currentBar != bar || pattern == null) {\r\n\t\t\t\t\t\t\t\t\tcurrentBar++;\r\n\t\t\t\t\t\t\t\t\twhile (currentBar < bar) {\r\n\t\t\t\t\t\t\t\t\t\tnewChannel.bars[currentBar] = 0;\r\n\t\t\t\t\t\t\t\t\t\tcurrentBar++;\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\tpattern = new Pattern();\r\n\t\t\t\t\t\t\t\t\tnewChannel.patterns.push(pattern);\r\n\t\t\t\t\t\t\t\t\tnewChannel.bars[currentBar] = newChannel.patterns.length;\r\n\t\t\t\t\t\t\t\t\tpattern.instruments.length = 0;\r\n\t\t\t\t\t\t\t\t\tpattern.instruments.push(...oldPattern.instruments);\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tprojectNoteIntoBar(oldNote, absoluteNoteStart - barStartPart - noteStartPart, noteStartPart, noteEndPart, pattern.notes);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\r\n\t\tremoveDuplicatePatterns(pitchChannels);\r\n\t\tremoveDuplicatePatterns(noiseChannels);\r\n\t\tthis.append(new ChangeReplacePatterns(doc, pitchChannels, noiseChannels));\r\n\t}\r\n}\r\n\r\nclass ChangePins extends UndoableChange {\r\n\tprotected _oldStart: number;\r\n\tprotected _newStart: number;\r\n\tprotected _oldEnd: number;\r\n\tprotected _newEnd: number;\r\n\tprotected _oldPins: NotePin[];\r\n\tprotected _newPins: NotePin[];\r\n\tprotected _oldPitches: number[];\r\n\tprotected _newPitches: number[];\r\n\tprotected _oldContinuesLastPattern: boolean;\r\n\tprotected _newContinuesLastPattern: boolean;\r\n\tconstructor(protected _doc: SongDocument | null, protected _note: Note) {\r\n\t\tsuper(false);\r\n\t\tthis._oldStart = this._note.start;\r\n\t\tthis._oldEnd   = this._note.end;\r\n\t\tthis._newStart = this._note.start;\r\n\t\tthis._newEnd   = this._note.end;\r\n\t\tthis._oldPins = this._note.pins;\r\n\t\tthis._newPins = [];\r\n\t\tthis._oldPitches = this._note.pitches;\r\n\t\tthis._newPitches = [];\r\n\t\tthis._oldContinuesLastPattern = this._note.continuesLastPattern;\r\n\t\tthis._newContinuesLastPattern = this._note.continuesLastPattern;\r\n\t}\r\n\t\r\n\tprotected _finishSetup(continuesLastPattern?: boolean): void {\r\n\t\tfor (let i: number = 0; i < this._newPins.length - 1; ) {\r\n\t\t\tif (this._newPins[i].time >= this._newPins[i+1].time) {\r\n\t\t\t\tthis._newPins.splice(i, 1);\r\n\t\t\t} else {\r\n\t\t\t\ti++;\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tremoveRedundantPins(this._newPins);\r\n\t\t\r\n\t\tconst firstInterval: number = this._newPins[0].interval;\r\n\t\tconst firstTime: number = this._newPins[0].time;\r\n\t\tfor (let i: number = 0; i < this._oldPitches.length; i++) {\r\n\t\t\tthis._newPitches[i] = this._oldPitches[i] + firstInterval;\r\n\t\t}\r\n\t\tfor (let i: number = 0; i < this._newPins.length; i++) {\r\n\t\t\tthis._newPins[i].interval -= firstInterval;\r\n\t\t\tthis._newPins[i].time -= firstTime;\r\n\t\t}\r\n\t\tthis._newStart = this._oldStart + firstTime;\r\n\t\tthis._newEnd   = this._newStart + this._newPins[this._newPins.length-1].time;\r\n\t\t\r\n\t\tif (continuesLastPattern != undefined) {\r\n\t\t\tthis._newContinuesLastPattern = continuesLastPattern;\r\n\t\t}\r\n\t\tif (this._newStart != 0) {\r\n\t\t\tthis._newContinuesLastPattern = false;\r\n\t\t}\r\n\t\t\r\n\t\tthis._doForwards();\r\n\t\tthis._didSomething();\r\n\t}\r\n\t\r\n\tprotected _doForwards(): void {\r\n\t\tthis._note.pins = this._newPins;\r\n\t\tthis._note.pitches = this._newPitches;\r\n\t\tthis._note.start = this._newStart;\r\n\t\tthis._note.end = this._newEnd;\r\n\t\tthis._note.continuesLastPattern = this._newContinuesLastPattern;\r\n\t\tif (this._doc != null) this._doc.notifier.changed();\r\n\t}\r\n\t\r\n\tprotected _doBackwards(): void {\r\n\t\tthis._note.pins = this._oldPins;\r\n\t\tthis._note.pitches = this._oldPitches;\r\n\t\tthis._note.start = this._oldStart;\r\n\t\tthis._note.end = this._oldEnd;\r\n\t\tthis._note.continuesLastPattern = this._oldContinuesLastPattern;\r\n\t\tif (this._doc != null) this._doc.notifier.changed();\r\n\t}\r\n}\r\n\r\nexport class ChangeCustomizeInstrument extends Change {\r\n\tconstructor(doc: SongDocument) {\r\n\t\tsuper();\r\n\t\tconst instrument: Instrument = doc.song.channels[doc.channel].instruments[doc.getCurrentInstrument()];\r\n\t\tif (instrument.preset != instrument.type) {\r\n\t\t\tinstrument.preset = instrument.type;\r\n\t\t\tdoc.notifier.changed();\r\n\t\t\tthis._didSomething();\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport class ChangePreset extends Change {\r\n\tconstructor(doc: SongDocument, newValue: number) {\r\n\t\tsuper();\r\n\t\tconst instrument: Instrument = doc.song.channels[doc.channel].instruments[doc.getCurrentInstrument()];\r\n\t\tconst oldValue: number = instrument.preset;\r\n\t\tif (oldValue != newValue) {\r\n\t\t\tconst preset: Preset | null = EditorConfig.valueToPreset(newValue);\r\n\t\t\tif (preset != null) {\r\n\t\t\t\tif (preset.customType != undefined) {\r\n\t\t\t\t\tinstrument.type = preset.customType;\r\n\t\t\t\t\tif (!Config.instrumentTypeHasSpecialInterval[instrument.type] && Config.chords[instrument.chord].customInterval) {\r\n\t\t\t\t\t\tinstrument.chord = 0;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tinstrument.clearInvalidEnvelopeTargets();\r\n\t\t\t\t} else if (preset.settings != undefined) {\r\n\t\t\t\t\tconst tempVolume: number = instrument.volume;\r\n\t\t\t\t\tconst tempPan: number = instrument.pan;\r\n\t\t\t\t\tconst usesPanning: boolean = effectsIncludePanning(instrument.effects);\r\n\t\t\t\t\tinstrument.fromJsonObject(preset.settings, doc.song.getChannelIsNoise(doc.channel), 1);\r\n\t\t\t\t\t// Reset the volume and panning effect to be whatever they were before loading a preset. The presets shouldn't override these.\r\n\t\t\t\t\tinstrument.volume = tempVolume;\r\n\t\t\t\t\tinstrument.pan = tempPan;\r\n\t\t\t\t\tif (usesPanning && instrument.pan != Config.panCenter) {\r\n\t\t\t\t\t\tinstrument.effects = (instrument.effects | (1 << EffectType.panning));\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tinstrument.preset = newValue;\r\n\t\t\tdoc.notifier.changed();\r\n\t\t\tthis._didSomething();\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport class ChangeRandomGeneratedInstrument extends Change {\r\n\tconstructor(doc: SongDocument) {\r\n\t\tsuper();\r\n\t\t\r\n\t\tinterface ItemWeight<T> {\r\n\t\t\treadonly item: T;\r\n\t\t\treadonly weight: number;\r\n\t\t}\r\n\t\tfunction selectWeightedRandom<T>(entries: ReadonlyArray<ItemWeight<T>>): T {\r\n\t\t\tlet total: number = 0;\r\n\t\t\tfor (const entry of entries) {\r\n\t\t\t\ttotal += entry.weight;\r\n\t\t\t}\r\n\t\t\tlet random: number = Math.random() * total;\r\n\t\t\tfor (const entry of entries) {\r\n\t\t\t\trandom -= entry.weight;\r\n\t\t\t\tif (random <= 0.0) return entry.item;\r\n\t\t\t}\r\n\t\t\treturn entries[(Math.random() * entries.length)|0].item;\r\n\t\t}\r\n\t\tfunction selectCurvedDistribution(min: number, max: number, peak: number, width: number): number {\r\n\t\t\tconst entries: Array<ItemWeight<number>> = [];\r\n\t\t\tfor (let i: number = min; i <= max; i++) {\r\n\t\t\t\tentries.push({item: i, weight: 1.0 / (Math.pow((i - peak) / width, 2.0) + 1.0)});\r\n\t\t\t}\r\n\t\t\treturn selectWeightedRandom(entries);\r\n\t\t}\r\n\t\t\r\n\t\tclass PotentialFilterPoint {\r\n\t\t\tconstructor(\r\n\t\t\t\tpublic readonly chance: number,\r\n\t\t\t\tpublic readonly type: FilterType,\r\n\t\t\t\tpublic readonly minFreq: number,\r\n\t\t\t\tpublic readonly maxFreq: number,\r\n\t\t\t\tpublic readonly centerHz: number,\r\n\t\t\t\tpublic readonly centerGain: number,\r\n\t\t\t) {};\r\n\t\t}\r\n\t\tfunction applyFilterPoints(filter: FilterSettings, potentialPoints: ReadonlyArray<PotentialFilterPoint>): void {\r\n\t\t\tfilter.reset();\r\n\t\t\tconst usedFreqs: number[] = [];\r\n\t\t\tfor (const potentialPoint of potentialPoints) {\r\n\t\t\t\tif (Math.random() > potentialPoint.chance) continue;\r\n\t\t\t\tconst point: FilterControlPoint = new FilterControlPoint();\r\n\t\t\t\tpoint.type = potentialPoint.type;\r\n\t\t\t\tpoint.freq = selectCurvedDistribution(potentialPoint.minFreq, potentialPoint.maxFreq, FilterControlPoint.getRoundedSettingValueFromHz(potentialPoint.centerHz), 1.0 / Config.filterFreqStep);\r\n\t\t\t\tpoint.gain = selectCurvedDistribution(0, Config.filterGainRange - 1, Config.filterGainCenter + potentialPoint.centerGain, 2.0 / Config.filterGainStep);\r\n\t\t\t\tif (point.type == FilterType.peak && point.gain == Config.filterGainCenter) continue; // skip pointless points. :P\r\n\t\t\t\tif (usedFreqs.includes(point.freq)) continue;\r\n\t\t\t\tusedFreqs.push(point.freq);\r\n\t\t\t\tfilter.controlPoints[filter.controlPointCount] = point;\r\n\t\t\t\tfilter.controlPointCount++;\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tconst isNoise: boolean = doc.song.getChannelIsNoise(doc.channel);\r\n\t\tconst instrument: Instrument = doc.song.channels[doc.channel].instruments[doc.getCurrentInstrument()];\r\n\t\tinstrument.effects &= 1 << EffectType.panning; // disable all existing effects except panning.\r\n\t\tinstrument.envelopeCount = 0;\r\n\t\t\r\n\t\tconst midFreq: number = FilterControlPoint.getRoundedSettingValueFromHz(700.0);\r\n\t\tconst maxFreq: number = Config.filterFreqRange - 1;\r\n\t\tapplyFilterPoints(instrument.eqFilter, [\r\n\t\t\tnew PotentialFilterPoint(0.8, FilterType.lowPass,  midFreq, maxFreq,     4000.0, -1),\r\n\t\t\tnew PotentialFilterPoint(0.4, FilterType.highPass, 0,       midFreq - 1,  250.0, -1),\r\n\t\t\tnew PotentialFilterPoint(0.5, FilterType.peak,     0,       maxFreq,     2000.0,  0),\r\n\t\t\tnew PotentialFilterPoint(0.4, FilterType.peak,     0,       maxFreq,     1400.0,  0),\r\n\t\t\tnew PotentialFilterPoint(0.3, FilterType.peak,     0,       maxFreq,     1000.0,  0),\r\n\t\t\tnew PotentialFilterPoint(0.2, FilterType.peak,     0,       maxFreq,      500.0,  0),\r\n\t\t]);\r\n\t\t\r\n\t\tif (isNoise) {\r\n\t\t\tconst type: InstrumentType = selectWeightedRandom([\r\n\t\t\t\t{item: InstrumentType.noise,    weight: 1},\r\n\t\t\t\t{item: InstrumentType.spectrum, weight: 3},\r\n\t\t\t]);\r\n\t\t\tinstrument.preset = instrument.type = type;\r\n\t\t\t\r\n\t\t\tinstrument.fadeIn = (Math.random() < 0.8) ? 0 : selectCurvedDistribution(0, Config.fadeInRange - 1, 0, 2);\r\n\t\t\tinstrument.fadeOut = selectCurvedDistribution(0, Config.fadeOutTicks.length - 1, Config.fadeOutNeutral, 2);\r\n\t\t\t\r\n\t\t\tif (Math.random() < 0.1) {\r\n\t\t\t\tinstrument.effects |= 1 << EffectType.transition;\r\n\t\t\t\tinstrument.transition = Config.transitions.dictionary[selectWeightedRandom([\r\n\t\t\t\t\t{item: \"normal\"     , weight: 30},\r\n\t\t\t\t\t{item: \"interrupt\"  , weight: 1},\r\n\t\t\t\t\t{item: \"slide\"      , weight: 2},\r\n\t\t\t\t])].index;\r\n\t\t\t}\r\n\t\t\tif (Math.random() < 0.2) {\r\n\t\t\t\tinstrument.effects |= 1 << EffectType.chord;\r\n\t\t\t\tinstrument.chord = Config.chords.dictionary[selectWeightedRandom([\r\n\t\t\t\t\t{item: \"strum\"   , weight: 2},\r\n\t\t\t\t\t{item: \"arpeggio\", weight: 1},\r\n\t\t\t\t])].index;\r\n\t\t\t}\r\n\t\t\tif (Math.random() < 0.1) {\r\n\t\t\t\tinstrument.pitchShift = selectCurvedDistribution(0, Config.pitchShiftRange - 1, Config.pitchShiftCenter, 2);\r\n\t\t\t\tif (instrument.pitchShift != Config.pitchShiftCenter) {\r\n\t\t\t\t\tinstrument.effects |= 1 << EffectType.pitchShift;\r\n\t\t\t\t\tinstrument.addEnvelope(Config.instrumentAutomationTargets.dictionary[\"pitchShift\"].index, 0, Config.envelopes.dictionary[selectWeightedRandom([\r\n\t\t\t\t\t\t{item: \"flare 1\" , weight: 2},\r\n\t\t\t\t\t\t{item: \"flare 2\" , weight: 1},\r\n\t\t\t\t\t\t{item: \"flare 3\" , weight: 1},\r\n\t\t\t\t\t\t{item: \"twang 1\" , weight: 16},\r\n\t\t\t\t\t\t{item: \"twang 2\" , weight: 8},\r\n\t\t\t\t\t\t{item: \"twang 3\" , weight: 4},\r\n\t\t\t\t\t\t{item: \"tremolo1\", weight: 1},\r\n\t\t\t\t\t\t{item: \"tremolo2\", weight: 1},\r\n\t\t\t\t\t\t{item: \"tremolo3\", weight: 1},\r\n\t\t\t\t\t\t{item: \"decay 1\" , weight: 4},\r\n\t\t\t\t\t\t{item: \"decay 2\" , weight: 2},\r\n\t\t\t\t\t\t{item: \"decay 3\" , weight: 1},\r\n\t\t\t\t\t])].index);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tif (Math.random() < 0.1) {\r\n\t\t\t\tinstrument.effects |= 1 << EffectType.vibrato;\r\n\t\t\t\tinstrument.vibrato = selectCurvedDistribution(0, Config.echoSustainRange - 1, Config.echoSustainRange >> 1, 2);\r\n\t\t\t\tinstrument.vibrato = Config.vibratos.dictionary[selectWeightedRandom([\r\n\t\t\t\t\t{item: \"light\"  , weight: 2},\r\n\t\t\t\t\t{item: \"delayed\", weight: 2},\r\n\t\t\t\t\t{item: \"heavy\"  , weight: 1},\r\n\t\t\t\t\t{item: \"shaky\"  , weight: 2},\r\n\t\t\t\t])].index;\r\n\t\t\t}\r\n\t\t\tif (Math.random() < 0.8) {\r\n\t\t\t\tinstrument.effects |= 1 << EffectType.noteFilter;\r\n\t\t\t\tapplyFilterPoints(instrument.noteFilter, [\r\n\t\t\t\t\tnew PotentialFilterPoint(1.0, FilterType.lowPass,  midFreq, maxFreq, 8000.0, -1),\r\n\t\t\t\t]);\r\n\t\t\t\tinstrument.addEnvelope(Config.instrumentAutomationTargets.dictionary[\"noteFilterAllFreqs\"].index, 0, Config.envelopes.dictionary[selectWeightedRandom([\r\n\t\t\t\t\t{item: \"punch\"   , weight: 4},\r\n\t\t\t\t\t{item: \"flare 1\" , weight: 2},\r\n\t\t\t\t\t{item: \"flare 2\" , weight: 2},\r\n\t\t\t\t\t{item: \"flare 3\" , weight: 2},\r\n\t\t\t\t\t{item: \"twang 1\" , weight: 8},\r\n\t\t\t\t\t{item: \"twang 2\" , weight: 8},\r\n\t\t\t\t\t{item: \"twang 3\" , weight: 8},\r\n\t\t\t\t\t{item: \"swell 1\" , weight: 2},\r\n\t\t\t\t\t{item: \"swell 2\" , weight: 2},\r\n\t\t\t\t\t{item: \"swell 3\" , weight: 1},\r\n\t\t\t\t\t{item: \"tremolo1\", weight: 1},\r\n\t\t\t\t\t{item: \"tremolo2\", weight: 1},\r\n\t\t\t\t\t{item: \"tremolo3\", weight: 1},\r\n\t\t\t\t\t{item: \"tremolo4\", weight: 1},\r\n\t\t\t\t\t{item: \"tremolo5\", weight: 1},\r\n\t\t\t\t\t{item: \"tremolo6\", weight: 1},\r\n\t\t\t\t\t{item: \"decay 1\" , weight: 4},\r\n\t\t\t\t\t{item: \"decay 2\" , weight: 4},\r\n\t\t\t\t\t{item: \"decay 3\" , weight: 4},\r\n\t\t\t\t])].index);\r\n\t\t\t}\r\n\t\t\tif (Math.random() < 0.1) {\r\n\t\t\t\tinstrument.effects |= 1 << EffectType.distortion;\r\n\t\t\t\tinstrument.distortion = selectCurvedDistribution(1, Config.distortionRange - 1, Config.distortionRange - 1, 2);\r\n\t\t\t}\r\n\t\t\tif (Math.random() < 0.1) {\r\n\t\t\t\tinstrument.effects |= 1 << EffectType.bitcrusher;\r\n\t\t\t\tinstrument.bitcrusherFreq = selectCurvedDistribution(0, Config.bitcrusherFreqRange - 1, Config.bitcrusherFreqRange >> 1, 2);\r\n\t\t\t\tinstrument.bitcrusherQuantization = selectCurvedDistribution(0, Config.bitcrusherQuantizationRange - 1, Config.bitcrusherQuantizationRange >> 1, 2);\r\n\t\t\t}\r\n\t\t\tif (Math.random() < 0.1) {\r\n\t\t\t\tinstrument.effects |= 1 << EffectType.chorus;\r\n\t\t\t\tinstrument.chorus = selectCurvedDistribution(1, Config.chorusRange - 1, Config.chorusRange - 1, 1);\r\n\t\t\t}\r\n\t\t\tif (Math.random() < 0.1) {\r\n\t\t\t\tinstrument.echoSustain = selectCurvedDistribution(0, Config.echoSustainRange - 1, Config.echoSustainRange >> 1, 2);\r\n\t\t\t\tinstrument.echoDelay = selectCurvedDistribution(0, Config.echoDelayRange - 1, Config.echoDelayRange >> 1, 2);\r\n\t\t\t\tif (instrument.echoSustain != 0 || instrument.echoDelay != 0) {\r\n\t\t\t\t\tinstrument.effects |= 1 << EffectType.echo;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tif (Math.random() < 0.5) {\r\n\t\t\t\tinstrument.effects |= 1 << EffectType.reverb;\r\n\t\t\t\tinstrument.reverb = selectCurvedDistribution(1, Config.reverbRange - 1, 1, 1);\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tfunction normalize(harmonics: number[]): void {\r\n\t\t\t\tlet max: number = 0;\r\n\t\t\t\tfor (const value of harmonics) {\r\n\t\t\t\t\tif (value > max) max = value;\r\n\t\t\t\t}\r\n\t\t\t\tfor (let i: number = 0; i < harmonics.length; i++) {\r\n\t\t\t\t\tharmonics[i] = Config.harmonicsMax * harmonics[i] / max;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tswitch (type) {\r\n\t\t\t\tcase InstrumentType.noise: {\r\n\t\t\t\t\tinstrument.chipNoise = (Math.random() * Config.chipNoises.length)|0;\r\n\t\t\t\t} break;\r\n\t\t\t\tcase InstrumentType.spectrum: {\r\n\t\t\t\t\tconst spectrumGenerators: Function[] = [\r\n\t\t\t\t\t\t(): number[] => {\r\n\t\t\t\t\t\t\tconst spectrum: number[] = [];\r\n\t\t\t\t\t\t\tfor (let i: number = 0; i < Config.spectrumControlPoints; i++) {\r\n\t\t\t\t\t\t\t\tspectrum[i] = (Math.random() < 0.5) ? Math.random() : 0.0;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\treturn spectrum;\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t\t(): number[] => {\r\n\t\t\t\t\t\t\tlet current: number = 1.0;\r\n\t\t\t\t\t\t\tconst spectrum: number[] = [current];\r\n\t\t\t\t\t\t\tfor (let i = 1; i < Config.spectrumControlPoints; i++) {\r\n\t\t\t\t\t\t\t\tcurrent *= Math.pow(2, Math.random() - 0.52);\r\n\t\t\t\t\t\t\t\tspectrum[i] = current;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\treturn spectrum;\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t\t(): number[] => {\r\n\t\t\t\t\t\t\tlet current: number = 1.0;\r\n\t\t\t\t\t\t\tconst spectrum: number[] = [current];\r\n\t\t\t\t\t\t\tfor (let i = 1; i < Config.spectrumControlPoints; i++) {\r\n\t\t\t\t\t\t\t\tcurrent *= Math.pow(2, Math.random() - 0.52);\r\n\t\t\t\t\t\t\t\tspectrum[i] = current * Math.random();\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\treturn spectrum;\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t];\r\n\t\t\t\t\tconst generator = spectrumGenerators[(Math.random() * spectrumGenerators.length)|0];\r\n\t\t\t\t\tconst spectrum: number[] = generator();\r\n\t\t\t\t\tnormalize(spectrum);\r\n\t\t\t\t\tfor (let i: number = 0; i < Config.spectrumControlPoints; i++) {\r\n\t\t\t\t\t\tinstrument.spectrumWave.spectrum[i] = Math.round(spectrum[i]);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tinstrument.spectrumWave.markCustomWaveDirty();\r\n\t\t\t\t} break;\r\n\t\t\t\tdefault: throw new Error(\"Unhandled noise instrument type in random generator.\");\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tconst type: InstrumentType = selectWeightedRandom([\r\n\t\t\t\t{item: InstrumentType.chip,         weight: 4},\r\n\t\t\t\t{item: InstrumentType.pwm,          weight: 4},\r\n\t\t\t\t{item: InstrumentType.supersaw,     weight: 5},\r\n\t\t\t\t{item: InstrumentType.harmonics,    weight: 5},\r\n\t\t\t\t{item: InstrumentType.pickedString, weight: 5},\r\n\t\t\t\t{item: InstrumentType.spectrum,     weight: 1},\r\n\t\t\t\t{item: InstrumentType.fm,           weight: 5},\r\n\t\t\t]);\r\n\t\t\tinstrument.preset = instrument.type = type;\r\n\t\t\t\r\n\t\t\tinstrument.fadeIn = (Math.random() < 0.5) ? 0 : selectCurvedDistribution(0, Config.fadeInRange - 1, 0, 2);\r\n\t\t\tinstrument.fadeOut = selectCurvedDistribution(0, Config.fadeOutTicks.length - 1, Config.fadeOutNeutral, 2);\r\n\t\t\tif (type == InstrumentType.chip || type == InstrumentType.harmonics || type == InstrumentType.pickedString) {\r\n\t\t\t\tinstrument.unison = Config.unisons.dictionary[selectWeightedRandom([\r\n\t\t\t\t\t{item: \"none\"      , weight: 10},\r\n\t\t\t\t\t{item: \"shimmer\"   , weight: 5},\r\n\t\t\t\t\t{item: \"hum\"       , weight: 4},\r\n\t\t\t\t\t{item: \"honky tonk\", weight: 3},\r\n\t\t\t\t\t{item: \"dissonant\" , weight: 1},\r\n\t\t\t\t\t{item: \"fifth\"     , weight: 1},\r\n\t\t\t\t\t{item: \"octave\"    , weight: 2},\r\n\t\t\t\t\t{item: \"bowed\"     , weight: 2},\r\n\t\t\t\t\t{item: \"piano\"     , weight: 5},\r\n\t\t\t\t])].index;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tif (Math.random() < 0.1) {\r\n\t\t\t\tinstrument.effects |= 1 << EffectType.transition;\r\n\t\t\t\tinstrument.transition = Config.transitions.dictionary[selectWeightedRandom([\r\n\t\t\t\t\t{item: \"interrupt\"  , weight: 1},\r\n\t\t\t\t\t{item: \"slide\"      , weight: 2},\r\n\t\t\t\t])].index;\r\n\t\t\t}\r\n\t\t\tif (Math.random() < 0.2) {\r\n\t\t\t\tinstrument.effects |= 1 << EffectType.chord;\r\n\t\t\t\tinstrument.chord = Config.chords.dictionary[selectWeightedRandom([\r\n\t\t\t\t\t{item: \"strum\"   ,     weight: 2},\r\n\t\t\t\t\t{item: \"arpeggio\",     weight: 1},\r\n\t\t\t\t])].index;\r\n\t\t\t}\r\n\t\t\tif (Math.random() < 0.05) {\r\n\t\t\t\tinstrument.pitchShift = selectCurvedDistribution(0, Config.pitchShiftRange - 1, Config.pitchShiftCenter, 1);\r\n\t\t\t\tif (instrument.pitchShift != Config.pitchShiftCenter) {\r\n\t\t\t\t\tinstrument.effects |= 1 << EffectType.pitchShift;\r\n\t\t\t\t\tinstrument.addEnvelope(Config.instrumentAutomationTargets.dictionary[\"pitchShift\"].index, 0, Config.envelopes.dictionary[selectWeightedRandom([\r\n\t\t\t\t\t\t{item: \"flare 1\" , weight: 2},\r\n\t\t\t\t\t\t{item: \"flare 2\" , weight: 1},\r\n\t\t\t\t\t\t{item: \"flare 3\" , weight: 1},\r\n\t\t\t\t\t\t{item: \"twang 1\" , weight: 16},\r\n\t\t\t\t\t\t{item: \"twang 2\" , weight: 8},\r\n\t\t\t\t\t\t{item: \"twang 3\" , weight: 4},\r\n\t\t\t\t\t\t{item: \"decay 1\" , weight: 4},\r\n\t\t\t\t\t\t{item: \"decay 2\" , weight: 2},\r\n\t\t\t\t\t\t{item: \"decay 3\" , weight: 1},\r\n\t\t\t\t\t])].index);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tif (Math.random() < 0.25) {\r\n\t\t\t\tinstrument.effects |= 1 << EffectType.vibrato;\r\n\t\t\t\tinstrument.vibrato = selectCurvedDistribution(0, Config.echoSustainRange - 1, Config.echoSustainRange >> 1, 2);\r\n\t\t\t\tinstrument.vibrato = Config.vibratos.dictionary[selectWeightedRandom([\r\n\t\t\t\t\t{item: \"light\"  , weight: 2},\r\n\t\t\t\t\t{item: \"delayed\", weight: 2},\r\n\t\t\t\t\t{item: \"heavy\"  , weight: 1},\r\n\t\t\t\t\t{item: \"shaky\"  , weight: 2},\r\n\t\t\t\t])].index;\r\n\t\t\t}\r\n\t\t\tif (Math.random() < 0.1) {\r\n\t\t\t\tinstrument.effects |= 1 << EffectType.distortion;\r\n\t\t\t\tinstrument.distortion = selectCurvedDistribution(1, Config.distortionRange - 1, Config.distortionRange - 1, 2);\r\n\t\t\t}\r\n\t\t\tif (effectsIncludeDistortion(instrument.effects) && Math.random() < 0.8) {\r\n\t\t\t\tinstrument.effects |= 1 << EffectType.noteFilter;\r\n\t\t\t\tapplyFilterPoints(instrument.noteFilter, [\r\n\t\t\t\t\tnew PotentialFilterPoint(1.0, FilterType.lowPass,  midFreq, maxFreq,     2000.0, -1),\r\n\t\t\t\t\tnew PotentialFilterPoint(0.9, FilterType.highPass, 0,       midFreq - 1,  500.0, -1),\r\n\t\t\t\t\tnew PotentialFilterPoint(0.4, FilterType.peak,     0,       maxFreq,     1400.0,  0),\r\n\t\t\t\t]);\r\n\t\t\t} else if (Math.random() < 0.5) {\r\n\t\t\t\tinstrument.effects |= 1 << EffectType.noteFilter;\r\n\t\t\t\tapplyFilterPoints(instrument.noteFilter, [\r\n\t\t\t\t\tnew PotentialFilterPoint(1.0, FilterType.lowPass,  midFreq, maxFreq, 8000.0, -1),\r\n\t\t\t\t]);\r\n\t\t\t\tinstrument.addEnvelope(Config.instrumentAutomationTargets.dictionary[\"noteFilterAllFreqs\"].index, 0, Config.envelopes.dictionary[selectWeightedRandom([\r\n\t\t\t\t\t{item: \"punch\"   , weight: 6},\r\n\t\t\t\t\t{item: \"flare 1\" , weight: 2},\r\n\t\t\t\t\t{item: \"flare 2\" , weight: 4},\r\n\t\t\t\t\t{item: \"flare 3\" , weight: 2},\r\n\t\t\t\t\t{item: \"twang 1\" , weight: 2},\r\n\t\t\t\t\t{item: \"twang 2\" , weight: 4},\r\n\t\t\t\t\t{item: \"twang 3\" , weight: 4},\r\n\t\t\t\t\t{item: \"swell 1\" , weight: 4},\r\n\t\t\t\t\t{item: \"swell 2\" , weight: 2},\r\n\t\t\t\t\t{item: \"swell 3\" , weight: 1},\r\n\t\t\t\t\t{item: \"tremolo1\", weight: 1},\r\n\t\t\t\t\t{item: \"tremolo2\", weight: 1},\r\n\t\t\t\t\t{item: \"tremolo3\", weight: 1},\r\n\t\t\t\t\t{item: \"tremolo4\", weight: 1},\r\n\t\t\t\t\t{item: \"tremolo5\", weight: 1},\r\n\t\t\t\t\t{item: \"tremolo6\", weight: 1},\r\n\t\t\t\t\t{item: \"decay 1\" , weight: 1},\r\n\t\t\t\t\t{item: \"decay 2\" , weight: 2},\r\n\t\t\t\t\t{item: \"decay 3\" , weight: 2},\r\n\t\t\t\t])].index);\r\n\t\t\t}\r\n\t\t\tif (Math.random() < 0.1) {\r\n\t\t\t\tinstrument.effects |= 1 << EffectType.bitcrusher;\r\n\t\t\t\tinstrument.bitcrusherFreq = selectCurvedDistribution(0, Config.bitcrusherFreqRange - 1, 0, 2);\r\n\t\t\t\tinstrument.bitcrusherQuantization = selectCurvedDistribution(0, Config.bitcrusherQuantizationRange - 1, Config.bitcrusherQuantizationRange >> 1, 2);\r\n\t\t\t}\r\n\t\t\tif (Math.random() < 0.1) {\r\n\t\t\t\tinstrument.effects |= 1 << EffectType.chorus;\r\n\t\t\t\tinstrument.chorus = selectCurvedDistribution(1, Config.chorusRange - 1, Config.chorusRange - 1, 1);\r\n\t\t\t}\r\n\t\t\tif (Math.random() < 0.1) {\r\n\t\t\t\tinstrument.echoSustain = selectCurvedDistribution(0, Config.echoSustainRange - 1, Config.echoSustainRange >> 1, 2);\r\n\t\t\t\tinstrument.echoDelay = selectCurvedDistribution(0, Config.echoDelayRange - 1, Config.echoDelayRange >> 1, 2);\r\n\t\t\t\tif (instrument.echoSustain != 0 || instrument.echoDelay != 0) {\r\n\t\t\t\t\tinstrument.effects |= 1 << EffectType.echo;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tif (Math.random() < 0.5) {\r\n\t\t\t\tinstrument.effects |= 1 << EffectType.reverb;\r\n\t\t\t\tinstrument.reverb = selectCurvedDistribution(1, Config.reverbRange - 1, 1, 1);\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tfunction normalize(harmonics: number[]): void {\r\n\t\t\t\tlet max: number = 0;\r\n\t\t\t\tfor (const value of harmonics) {\r\n\t\t\t\t\tif (value > max) max = value;\r\n\t\t\t\t}\r\n\t\t\t\tfor (let i: number = 0; i < harmonics.length; i++) {\r\n\t\t\t\t\tharmonics[i] = Config.harmonicsMax * harmonics[i] / max;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tswitch (type) {\r\n\t\t\t\tcase InstrumentType.chip: {\r\n\t\t\t\t\tinstrument.chipWave = (Math.random() * Config.chipWaves.length)|0;\r\n\t\t\t\t} break;\r\n\t\t\t\tcase InstrumentType.pwm:\r\n\t\t\t\tcase InstrumentType.supersaw: {\r\n\t\t\t\t\tif (type == InstrumentType.supersaw) {\r\n\t\t\t\t\t\tinstrument.supersawDynamism = selectCurvedDistribution(0, Config.supersawDynamismMax, Config.supersawDynamismMax, 2);\r\n\t\t\t\t\t\tinstrument.supersawSpread = selectCurvedDistribution(0, Config.supersawSpreadMax, Math.ceil(Config.supersawSpreadMax / 3), 4);\r\n\t\t\t\t\t\tinstrument.supersawShape = selectCurvedDistribution(0, Config.supersawShapeMax, 0, 4);\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t\tinstrument.pulseWidth = selectCurvedDistribution(0, Config.pulseWidthRange - 1, Config.pulseWidthRange - 1, 2);\r\n\t\t\t\t\t\r\n\t\t\t\t\tif (Math.random() < 0.6) {\r\n\t\t\t\t\t\tinstrument.addEnvelope(Config.instrumentAutomationTargets.dictionary[\"pulseWidth\"].index, 0, Config.envelopes.dictionary[selectWeightedRandom([\r\n\t\t\t\t\t\t\t{item: \"punch\"   , weight: 6},\r\n\t\t\t\t\t\t\t{item: \"flare 1\" , weight: 2},\r\n\t\t\t\t\t\t\t{item: \"flare 2\" , weight: 4},\r\n\t\t\t\t\t\t\t{item: \"flare 3\" , weight: 2},\r\n\t\t\t\t\t\t\t{item: \"twang 1\" , weight: 2},\r\n\t\t\t\t\t\t\t{item: \"twang 2\" , weight: 4},\r\n\t\t\t\t\t\t\t{item: \"twang 3\" , weight: 4},\r\n\t\t\t\t\t\t\t{item: \"swell 1\" , weight: 4},\r\n\t\t\t\t\t\t\t{item: \"swell 2\" , weight: 2},\r\n\t\t\t\t\t\t\t{item: \"swell 3\" , weight: 1},\r\n\t\t\t\t\t\t\t{item: \"tremolo1\", weight: 1},\r\n\t\t\t\t\t\t\t{item: \"tremolo2\", weight: 1},\r\n\t\t\t\t\t\t\t{item: \"tremolo3\", weight: 1},\r\n\t\t\t\t\t\t\t{item: \"tremolo4\", weight: 1},\r\n\t\t\t\t\t\t\t{item: \"tremolo5\", weight: 1},\r\n\t\t\t\t\t\t\t{item: \"tremolo6\", weight: 1},\r\n\t\t\t\t\t\t\t{item: \"decay 1\" , weight: 1},\r\n\t\t\t\t\t\t\t{item: \"decay 2\" , weight: 2},\r\n\t\t\t\t\t\t\t{item: \"decay 3\" , weight: 2},\r\n\t\t\t\t\t\t])].index);\r\n\t\t\t\t\t}\r\n\t\t\t\t} break;\r\n\t\t\t\tcase InstrumentType.pickedString:\r\n\t\t\t\tcase InstrumentType.harmonics: {\r\n\t\t\t\t\tif (type == InstrumentType.pickedString) {\r\n\t\t\t\t\t\tinstrument.stringSustain = (Math.random() * Config.stringSustainRange)|0;\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t\tconst harmonicGenerators: Function[] = [\r\n\t\t\t\t\t\t(): number[] => {\r\n\t\t\t\t\t\t\tconst harmonics: number[] = [];\r\n\t\t\t\t\t\t\tfor (let i: number = 0; i < Config.harmonicsControlPoints; i++) {\r\n\t\t\t\t\t\t\t\tharmonics[i] = (Math.random() < 0.4) ? Math.random() : 0.0;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tharmonics[(Math.random() * 8)|0] = Math.pow(Math.random(), 0.25);\r\n\t\t\t\t\t\t\treturn harmonics;\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t\t(): number[] => {\r\n\t\t\t\t\t\t\tlet current: number = 1.0;\r\n\t\t\t\t\t\t\tconst harmonics: number[] = [current];\r\n\t\t\t\t\t\t\tfor (let i = 1; i < Config.harmonicsControlPoints; i++) {\r\n\t\t\t\t\t\t\t\tcurrent *= Math.pow(2, Math.random() - 0.55);\r\n\t\t\t\t\t\t\t\tharmonics[i] = current;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\treturn harmonics;\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t\t(): number[] => {\r\n\t\t\t\t\t\t\tlet current: number = 1.0;\r\n\t\t\t\t\t\t\tconst harmonics: number[] = [current];\r\n\t\t\t\t\t\t\tfor (let i = 1; i < Config.harmonicsControlPoints; i++) {\r\n\t\t\t\t\t\t\t\tcurrent *= Math.pow(2, Math.random() - 0.55);\r\n\t\t\t\t\t\t\t\tharmonics[i] = current * Math.random();\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\treturn harmonics;\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t];\r\n\t\t\t\t\tconst generator = harmonicGenerators[(Math.random() * harmonicGenerators.length)|0];\r\n\t\t\t\t\tconst harmonics: number[] = generator();\r\n\t\t\t\t\tnormalize(harmonics);\r\n\t\t\t\t\tfor (let i: number = 0; i < Config.harmonicsControlPoints; i++) {\r\n\t\t\t\t\t\tinstrument.harmonicsWave.harmonics[i] = Math.round(harmonics[i]);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tinstrument.harmonicsWave.markCustomWaveDirty();\r\n\t\t\t\t} break;\r\n\t\t\t\tcase InstrumentType.spectrum: {\r\n\t\t\t\t\tconst spectrum: number[] = [];\r\n\t\t\t\t\tfor (let i: number = 0; i < Config.spectrumControlPoints; i++) {\r\n\t\t\t\t\t\tconst isHarmonic: boolean = i==0 || i==7 || i==11 || i==14 || i==16 || i==18 || i==21;\r\n\t\t\t\t\t\tif (isHarmonic) {\r\n\t\t\t\t\t\t\tspectrum[i] = Math.pow(Math.random(), 0.25);\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\tspectrum[i] = Math.pow(Math.random(), 3) * 0.5;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\tnormalize(spectrum);\r\n\t\t\t\t\tfor (let i: number = 0; i < Config.spectrumControlPoints; i++) {\r\n\t\t\t\t\t\tinstrument.spectrumWave.spectrum[i] = Math.round(spectrum[i]);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tinstrument.spectrumWave.markCustomWaveDirty();\r\n\t\t\t\t} break;\r\n\t\t\t\tcase InstrumentType.fm: {\r\n\t\t\t\t\tinstrument.algorithm = (Math.random() * Config.algorithms.length)|0;\r\n\t\t\t\t\tinstrument.feedbackType = (Math.random() * Config.feedbacks.length)|0;\r\n\t\t\t\t\tconst algorithm: Algorithm = Config.algorithms[instrument.algorithm];\r\n\t\t\t\t\tfor (let i: number = 0; i < algorithm.carrierCount; i++) {\r\n\t\t\t\t\t\tinstrument.operators[i].frequency = selectCurvedDistribution(0, Config.operatorFrequencies.length - 1, 0, 3);\r\n\t\t\t\t\t\tinstrument.operators[i].amplitude = selectCurvedDistribution(0, Config.operatorAmplitudeMax, Config.operatorAmplitudeMax - 1, 2);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tfor (let i: number = algorithm.carrierCount; i < Config.operatorCount; i++) {\r\n\t\t\t\t\t\tinstrument.operators[i].frequency = selectCurvedDistribution(3, Config.operatorFrequencies.length - 1, 0, 3);\r\n\t\t\t\t\t\tinstrument.operators[i].amplitude = (Math.pow(Math.random(), 2) * Config.operatorAmplitudeMax)|0;\r\n\t\t\t\t\t\tif (instrument.envelopeCount < Config.maxEnvelopeCount && Math.random() < 0.4) {\r\n\t\t\t\t\t\t\tinstrument.addEnvelope(Config.instrumentAutomationTargets.dictionary[\"operatorAmplitude\"].index, i, Config.envelopes.dictionary[selectWeightedRandom([\r\n\t\t\t\t\t\t\t\t{item: \"punch\"   , weight: 2},\r\n\t\t\t\t\t\t\t\t{item: \"flare 1\" , weight: 2},\r\n\t\t\t\t\t\t\t\t{item: \"flare 2\" , weight: 2},\r\n\t\t\t\t\t\t\t\t{item: \"flare 3\" , weight: 2},\r\n\t\t\t\t\t\t\t\t{item: \"twang 1\" , weight: 2},\r\n\t\t\t\t\t\t\t\t{item: \"twang 2\" , weight: 2},\r\n\t\t\t\t\t\t\t\t{item: \"twang 3\" , weight: 2},\r\n\t\t\t\t\t\t\t\t{item: \"swell 1\" , weight: 2},\r\n\t\t\t\t\t\t\t\t{item: \"swell 2\" , weight: 2},\r\n\t\t\t\t\t\t\t\t{item: \"swell 3\" , weight: 2},\r\n\t\t\t\t\t\t\t\t{item: \"tremolo1\", weight: 1},\r\n\t\t\t\t\t\t\t\t{item: \"tremolo2\", weight: 1},\r\n\t\t\t\t\t\t\t\t{item: \"tremolo3\", weight: 1},\r\n\t\t\t\t\t\t\t\t{item: \"tremolo4\", weight: 1},\r\n\t\t\t\t\t\t\t\t{item: \"tremolo5\", weight: 1},\r\n\t\t\t\t\t\t\t\t{item: \"tremolo6\", weight: 1},\r\n\t\t\t\t\t\t\t\t{item: \"decay 1\" , weight: 1},\r\n\t\t\t\t\t\t\t\t{item: \"decay 2\" , weight: 1},\r\n\t\t\t\t\t\t\t\t{item: \"decay 3\" , weight: 1},\r\n\t\t\t\t\t\t\t])].index);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif (instrument.envelopeCount < Config.maxEnvelopeCount && Math.random() < 0.05) {\r\n\t\t\t\t\t\t\tinstrument.addEnvelope(Config.instrumentAutomationTargets.dictionary[\"operatorFrequency\"].index, i, Config.envelopes.dictionary[selectWeightedRandom([\r\n\t\t\t\t\t\t\t\t{item: \"punch\"   , weight: 4},\r\n\t\t\t\t\t\t\t\t{item: \"flare 1\" , weight: 4},\r\n\t\t\t\t\t\t\t\t{item: \"flare 2\" , weight: 2},\r\n\t\t\t\t\t\t\t\t{item: \"flare 3\" , weight: 1},\r\n\t\t\t\t\t\t\t\t{item: \"twang 1\" , weight: 16},\r\n\t\t\t\t\t\t\t\t{item: \"twang 2\" , weight: 2},\r\n\t\t\t\t\t\t\t\t{item: \"twang 3\" , weight: 1},\r\n\t\t\t\t\t\t\t\t{item: \"swell 1\" , weight: 4},\r\n\t\t\t\t\t\t\t\t{item: \"swell 2\" , weight: 2},\r\n\t\t\t\t\t\t\t\t{item: \"swell 3\" , weight: 1},\r\n\t\t\t\t\t\t\t\t{item: \"decay 1\" , weight: 2},\r\n\t\t\t\t\t\t\t\t{item: \"decay 2\" , weight: 1},\r\n\t\t\t\t\t\t\t\t{item: \"decay 3\" , weight: 1},\r\n\t\t\t\t\t\t\t])].index);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\tinstrument.feedbackAmplitude = (Math.pow(Math.random(), 3) * Config.operatorAmplitudeMax)|0;\r\n\t\t\t\t\tif (instrument.envelopeCount < Config.maxEnvelopeCount && Math.random() < 0.4) {\r\n\t\t\t\t\t\tinstrument.addEnvelope(Config.instrumentAutomationTargets.dictionary[\"feedbackAmplitude\"].index, 0, Config.envelopes.dictionary[selectWeightedRandom([\r\n\t\t\t\t\t\t\t{item: \"punch\"   , weight: 2},\r\n\t\t\t\t\t\t\t{item: \"flare 1\" , weight: 2},\r\n\t\t\t\t\t\t\t{item: \"flare 2\" , weight: 2},\r\n\t\t\t\t\t\t\t{item: \"flare 3\" , weight: 2},\r\n\t\t\t\t\t\t\t{item: \"twang 1\" , weight: 2},\r\n\t\t\t\t\t\t\t{item: \"twang 2\" , weight: 2},\r\n\t\t\t\t\t\t\t{item: \"twang 3\" , weight: 2},\r\n\t\t\t\t\t\t\t{item: \"swell 1\" , weight: 2},\r\n\t\t\t\t\t\t\t{item: \"swell 2\" , weight: 2},\r\n\t\t\t\t\t\t\t{item: \"swell 3\" , weight: 2},\r\n\t\t\t\t\t\t\t{item: \"tremolo1\", weight: 1},\r\n\t\t\t\t\t\t\t{item: \"tremolo2\", weight: 1},\r\n\t\t\t\t\t\t\t{item: \"tremolo3\", weight: 1},\r\n\t\t\t\t\t\t\t{item: \"tremolo4\", weight: 1},\r\n\t\t\t\t\t\t\t{item: \"tremolo5\", weight: 1},\r\n\t\t\t\t\t\t\t{item: \"tremolo6\", weight: 1},\r\n\t\t\t\t\t\t\t{item: \"decay 1\" , weight: 1},\r\n\t\t\t\t\t\t\t{item: \"decay 2\" , weight: 1},\r\n\t\t\t\t\t\t\t{item: \"decay 3\" , weight: 1},\r\n\t\t\t\t\t\t])].index);\r\n\t\t\t\t\t}\r\n\t\t\t\t} break;\r\n\t\t\t\tdefault: throw new Error(\"Unhandled pitched instrument type in random generator.\");\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tdoc.notifier.changed();\r\n\t\tthis._didSomething();\r\n\t}\r\n}\r\n\r\nexport class ChangeTransition extends Change {\r\n\tconstructor(doc: SongDocument, newValue: number) {\r\n\t\tsuper();\r\n\t\tconst instrument: Instrument = doc.song.channels[doc.channel].instruments[doc.getCurrentInstrument()];\r\n\t\tconst oldValue: number = instrument.transition;\r\n\t\tif (oldValue != newValue) {\r\n\t\t\tthis._didSomething();\r\n\t\t\tinstrument.transition = newValue;\r\n\t\t\tinstrument.preset = instrument.type;\r\n\t\t\tdoc.notifier.changed();\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport class ChangeToggleEffects extends Change {\r\n\tconstructor(doc: SongDocument, toggleFlag: number) {\r\n\t\tsuper();\r\n\t\tconst instrument: Instrument = doc.song.channels[doc.channel].instruments[doc.getCurrentInstrument()];\r\n\t\tconst oldValue: number = instrument.effects;\r\n\t\tconst wasSelected: boolean = ((oldValue & (1 << toggleFlag)) != 0);\r\n\t\tconst newValue: number = wasSelected ? (oldValue & (~(1 << toggleFlag))) : (oldValue | (1 << toggleFlag));\r\n\t\tinstrument.effects = newValue;\r\n\t\t// As a special case, toggling the panning effect doesn't remove the preset.\r\n\t\tif (toggleFlag != EffectType.panning) instrument.preset = instrument.type;\r\n\t\tif (wasSelected) instrument.clearInvalidEnvelopeTargets();\r\n\t\tthis._didSomething();\r\n\t\tdoc.notifier.changed();\r\n\t}\r\n}\r\n\r\nexport class ChangePatternNumbers extends Change {\r\n\tconstructor(doc: SongDocument, value: number, startBar: number, startChannel: number, width: number, height: number) {\r\n\t\tsuper();\r\n\t\tif (value > doc.song.patternsPerChannel) throw new Error(\"invalid pattern\");\r\n\t\t\r\n\t\tfor (let bar: number = startBar; bar < startBar + width; bar++) {\r\n\t\t\tfor (let channelIndex: number = startChannel; channelIndex < startChannel + height; channelIndex++) {\r\n\t\t\t\tif (doc.song.channels[channelIndex].bars[bar] != value) {\r\n\t\t\t\t\tdoc.song.channels[channelIndex].bars[bar] = value;\r\n\t\t\t\t\tthis._didSomething();\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tdoc.notifier.changed();\r\n\t}\r\n}\r\n\r\nexport class ChangeBarCount extends Change {\r\n\tconstructor(doc: SongDocument, newValue: number, atBeginning: boolean) {\r\n\t\tsuper();\r\n\t\tif (doc.song.barCount != newValue) {\r\n\t\t\tfor (const channel of doc.song.channels) {\r\n\t\t\t\tif (atBeginning) {\r\n\t\t\t\t\twhile (channel.bars.length < newValue) {\r\n\t\t\t\t\t\tchannel.bars.unshift(0);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (doc.song.barCount > newValue) {\r\n\t\t\t\t\t\tchannel.bars.splice(0, doc.song.barCount - newValue);\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\twhile (channel.bars.length < newValue) {\r\n\t\t\t\t\t\tchannel.bars.push(0);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tchannel.bars.length = newValue;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tif (atBeginning) {\r\n\t\t\t\tconst diff: number = newValue - doc.song.barCount;\r\n\t\t\t\tdoc.bar = Math.max(0, doc.bar + diff);\r\n\t\t\t\tif (diff < 0 || doc.barScrollPos > 0) {\r\n\t\t\t\t\tdoc.barScrollPos = Math.max(0, doc.barScrollPos + diff);\r\n\t\t\t\t}\r\n\t\t\t\tdoc.song.loopStart = Math.max(0, doc.song.loopStart + diff);\r\n\t\t\t}\r\n\t\t\tdoc.bar = Math.min(doc.bar, newValue - 1);\r\n\t\t\tdoc.song.loopLength = Math.min(newValue, doc.song.loopLength);\r\n\t\t\tdoc.song.loopStart = Math.min(newValue - doc.song.loopLength, doc.song.loopStart);\r\n\t\t\tdoc.song.barCount = newValue;\r\n\t\t\tdoc.notifier.changed();\r\n\t\t\t\r\n\t\t\tthis._didSomething();\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport class ChangeInsertBars extends Change {\r\n\tconstructor(doc: SongDocument, start: number, count: number) {\r\n\t\tsuper();\r\n\t\t\r\n\t\tconst newLength: number = Math.min(Config.barCountMax, doc.song.barCount + count);\r\n\t\tcount = newLength - doc.song.barCount;\r\n\t\tif (count == 0) return;\r\n\t\t\r\n\t\tfor (const channel of doc.song.channels) {\r\n\t\t\twhile (channel.bars.length < newLength) {\r\n\t\t\t\tchannel.bars.splice(start, 0, 0);\r\n\t\t\t}\r\n\t\t}\r\n\t\tdoc.song.barCount = newLength;\r\n\t\t\r\n\t\tdoc.bar += count;\r\n\t\tdoc.barScrollPos += count;\r\n\t\tif (doc.song.loopStart >= start) {\r\n\t\t\tdoc.song.loopStart += count;\r\n\t\t} else if (doc.song.loopStart + doc.song.loopLength >= start) {\r\n\t\t\tdoc.song.loopLength += count;\r\n\t\t}\r\n\t\t\r\n\t\tdoc.notifier.changed();\r\n\t\tthis._didSomething();\r\n\t}\r\n}\r\n\r\nexport class ChangeDeleteBars extends Change {\r\n\tconstructor(doc: SongDocument, start: number, count: number) {\r\n\t\tsuper();\r\n\t\t\r\n\t\tfor (const channel of doc.song.channels) {\r\n\t\t\tchannel.bars.splice(start, count);\r\n\t\t\tif (channel.bars.length == 0) channel.bars.push(0);\r\n\t\t}\r\n\t\tdoc.song.barCount = Math.max(1, doc.song.barCount - count);\r\n\t\t\r\n\t\tdoc.bar = Math.max(0, doc.bar - count);\r\n\t\tdoc.barScrollPos = Math.max(0, doc.barScrollPos - count);\r\n\t\tif (doc.song.loopStart >= start) {\r\n\t\t\tdoc.song.loopStart = Math.max(0, doc.song.loopStart - count);\r\n\t\t} else if (doc.song.loopStart + doc.song.loopLength > start) {\r\n\t\t\tdoc.song.loopLength -= count;\r\n\t\t}\r\n\t\tdoc.song.loopLength = Math.max(1, Math.min(doc.song.barCount - doc.song.loopStart, doc.song.loopLength));\r\n\t\t\r\n\t\tdoc.notifier.changed();\r\n\t\tthis._didSomething();\r\n\t}\r\n}\r\n\r\nexport class ChangeChannelOrder extends Change {\r\n\tconstructor(doc: SongDocument, selectionMin: number, selectionMax: number, offset: number) {\r\n\t\tsuper();\r\n\t\tdoc.song.channels.splice(selectionMin + offset, 0, ...doc.song.channels.splice(selectionMin, selectionMax - selectionMin + 1));\r\n\t\tdoc.notifier.changed();\r\n\t\tthis._didSomething();\r\n\t}\r\n}\r\n\r\nexport class ChangeChannelCount extends Change {\r\n\tconstructor(doc: SongDocument, newPitchChannelCount: number, newNoiseChannelCount: number) {\r\n\t\tsuper();\r\n\t\tif (doc.song.pitchChannelCount != newPitchChannelCount || doc.song.noiseChannelCount != newNoiseChannelCount) {\r\n\t\t\tconst newChannels: Channel[] = [];\r\n\t\t\t\r\n\t\t\tfunction changeGroup(newCount: number, oldCount: number, newStart: number, oldStart: number, octave: number, isNoise: boolean): void {\r\n\t\t\t\tfor (let i: number = 0; i < newCount; i++) {\r\n\t\t\t\t\tconst channelIndex = i + newStart;\r\n\t\t\t\t\tconst oldChannel = i + oldStart;\r\n\t\t\t\t\tif (i < oldCount) {\r\n\t\t\t\t\t\tnewChannels[channelIndex] = doc.song.channels[oldChannel]\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tnewChannels[channelIndex] = new Channel();\r\n\t\t\t\t\t\tnewChannels[channelIndex].octave = octave;\r\n\t\t\t\t\t\tfor (let j: number = 0; j < Config.instrumentCountMin; j++) {\r\n\t\t\t\t\t\t\tconst instrument: Instrument = new Instrument(isNoise);\r\n\t\t\t\t\t\t\tconst presetValue: number = pickRandomPresetValue(isNoise);\r\n\t\t\t\t\t\t\tconst preset: Preset = EditorConfig.valueToPreset(presetValue)!;\r\n\t\t\t\t\t\t\tinstrument.fromJsonObject(preset.settings, isNoise);\r\n\t\t\t\t\t\t\tinstrument.preset = presetValue;\r\n\t\t\t\t\t\t\tinstrument.volume = 1;\r\n\t\t\t\t\t\t\tnewChannels[channelIndex].instruments[j] = instrument;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tfor (let j: number = 0; j < doc.song.patternsPerChannel; j++) {\r\n\t\t\t\t\t\t\tnewChannels[channelIndex].patterns[j] = new Pattern();\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tfor (let j: number = 0; j < doc.song.barCount; j++) {\r\n\t\t\t\t\t\t\tnewChannels[channelIndex].bars[j] = 0;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tchangeGroup(newPitchChannelCount, doc.song.pitchChannelCount, 0, 0, 3, false);\r\n\t\t\tchangeGroup(newNoiseChannelCount, doc.song.noiseChannelCount, newPitchChannelCount, doc.song.pitchChannelCount, 0, true);\r\n\t\t\t\r\n\t\t\tdoc.song.pitchChannelCount = newPitchChannelCount;\r\n\t\t\tdoc.song.noiseChannelCount = newNoiseChannelCount;\r\n\t\t\tfor (let channelIndex: number = 0; channelIndex < doc.song.getChannelCount(); channelIndex++) {\r\n\t\t\t\tdoc.song.channels[channelIndex] = newChannels[channelIndex];\r\n\t\t\t}\r\n\t\t\tdoc.song.channels.length = doc.song.getChannelCount();\r\n\t\t\t\r\n\t\t\tdoc.channel = Math.min(doc.channel, newPitchChannelCount + newNoiseChannelCount - 1);\r\n\t\t\tdoc.notifier.changed();\r\n\t\t\t\r\n\t\t\tthis._didSomething();\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport class ChangeAddChannel extends ChangeGroup {\r\n\tconstructor(doc: SongDocument, index: number, isNoise: boolean) {\r\n\t\tsuper();\r\n\t\tconst newPitchChannelCount: number = doc.song.pitchChannelCount + (isNoise ? 0 : 1);\r\n\t\tconst newNoiseChannelCount: number = doc.song.noiseChannelCount + (isNoise ? 1 : 0);\r\n\t\tif (newPitchChannelCount <= Config.pitchChannelCountMax && newNoiseChannelCount <= Config.noiseChannelCountMax) {\r\n\t\t\tconst addedChannelIndex: number = isNoise ? doc.song.pitchChannelCount + doc.song.noiseChannelCount : doc.song.pitchChannelCount;\r\n\t\t\tthis.append(new ChangeChannelCount(doc, newPitchChannelCount, newNoiseChannelCount));\r\n\t\t\tthis.append(new ChangeChannelOrder(doc, index, addedChannelIndex - 1, 1));\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport class ChangeRemoveChannel extends ChangeGroup {\r\n\tconstructor(doc: SongDocument, minIndex: number, maxIndex: number) {\r\n\t\tsuper();\r\n\t\t\r\n\t\twhile (maxIndex >= minIndex) {\r\n\t\t\tconst isNoise: boolean = doc.song.getChannelIsNoise(maxIndex);\r\n\t\t\tdoc.song.channels.splice(maxIndex, 1);\r\n\t\t\tif (isNoise) {\r\n\t\t\t\tdoc.song.noiseChannelCount--;\r\n\t\t\t} else {\r\n\t\t\t\tdoc.song.pitchChannelCount--;\r\n\t\t\t}\r\n\t\t\tmaxIndex--;\r\n\t\t}\r\n\t\t\r\n\t\tif (doc.song.pitchChannelCount < Config.pitchChannelCountMin) {\r\n\t\t\tthis.append(new ChangeChannelCount(doc, Config.pitchChannelCountMin, doc.song.noiseChannelCount));\r\n\t\t}\r\n\t\t\r\n\t\tthis.append(new ChangeChannelBar(doc, Math.max(0, minIndex - 1), doc.bar));\r\n\t\t\r\n\t\tthis._didSomething();\r\n\t\tdoc.notifier.changed();\r\n\t}\r\n}\r\n\r\nexport class ChangeChannelBar extends Change {\r\n\tconstructor(doc: SongDocument, newChannel: number, newBar: number, silently: boolean = false) {\r\n\t\tsuper();\r\n\t\tconst oldChannel: number = doc.channel;\r\n\t\tconst oldBar: number = doc.bar;\r\n\t\tdoc.channel = newChannel;\r\n\t\tdoc.bar = newBar;\r\n\t\tif (!silently) {\r\n\t\t\tdoc.selection.scrollToSelectedPattern();\r\n\t\t}\r\n\t\tdoc.notifier.changed();\r\n\t\tif (oldChannel != newChannel || oldBar != newBar) {\r\n\t\t\tthis._didSomething();\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport class ChangeUnison extends Change {\r\n\tconstructor(doc: SongDocument, newValue: number) {\r\n\t\tsuper();\r\n\t\tconst instrument: Instrument = doc.song.channels[doc.channel].instruments[doc.getCurrentInstrument()];\r\n\t\tconst oldValue: number = instrument.unison;\r\n\t\tif (oldValue != newValue) {\r\n\t\t\tthis._didSomething();\r\n\t\t\tinstrument.unison = newValue;\r\n\t\t\tinstrument.preset = instrument.type;\r\n\t\t\tdoc.notifier.changed();\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport class ChangeChord extends Change {\r\n\tconstructor(doc: SongDocument, newValue: number) {\r\n\t\tsuper();\r\n\t\tconst instrument: Instrument = doc.song.channels[doc.channel].instruments[doc.getCurrentInstrument()];\r\n\t\tconst oldValue: number = instrument.chord;\r\n\t\tif (oldValue != newValue) {\r\n\t\t\tthis._didSomething();\r\n\t\t\tinstrument.chord = newValue;\r\n\t\t\tinstrument.preset = instrument.type;\r\n\t\t\tdoc.notifier.changed();\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport class ChangeVibrato extends Change {\r\n\tconstructor(doc: SongDocument, newValue: number) {\r\n\t\tsuper();\r\n\t\tconst instrument: Instrument = doc.song.channels[doc.channel].instruments[doc.getCurrentInstrument()];\r\n\t\tconst oldValue: number = instrument.vibrato;\r\n\t\tif (oldValue != newValue) {\r\n\t\t\tinstrument.vibrato = newValue;\r\n\t\t\tinstrument.preset = instrument.type;\r\n\t\t\tdoc.notifier.changed();\r\n\t\t\tthis._didSomething();\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport class ChangeSpectrum extends Change {\r\n\tconstructor(doc: SongDocument, instrument: Instrument, spectrumWave: SpectrumWave) {\r\n\t\tsuper();\r\n\t\tspectrumWave.markCustomWaveDirty();\r\n\t\tinstrument.preset = instrument.type;\r\n\t\tdoc.notifier.changed();\r\n\t\tthis._didSomething();\r\n\t}\r\n}\r\n\r\nexport class ChangeHarmonics extends Change {\r\n\tconstructor(doc: SongDocument, instrument: Instrument, harmonicsWave: HarmonicsWave) {\r\n\t\tsuper();\r\n\t\tharmonicsWave.markCustomWaveDirty();\r\n\t\tinstrument.preset = instrument.type;\r\n\t\tdoc.notifier.changed();\r\n\t\tthis._didSomething();\r\n\t}\r\n}\r\n\r\nexport class ChangeDrumsetEnvelope extends Change {\r\n\tconstructor(doc: SongDocument, drumIndex: number, newValue: number) {\r\n\t\tsuper();\r\n\t\tconst instrument: Instrument = doc.song.channels[doc.channel].instruments[doc.getCurrentInstrument()];\r\n\t\tconst oldValue: number = instrument.drumsetEnvelopes[drumIndex];\r\n\t\tif (oldValue != newValue) {\r\n\t\t\tinstrument.drumsetEnvelopes[drumIndex] = newValue;\r\n\t\t\tinstrument.preset = instrument.type;\r\n\t\t\tdoc.notifier.changed();\r\n\t\t\tthis._didSomething();\r\n\t\t}\r\n\t}\r\n}\r\n\r\nclass ChangeInstrumentSlider extends Change {\r\n\tprotected _instrument: Instrument;\r\n\tconstructor(private _doc: SongDocument) {\r\n\t\tsuper();\r\n\t\tthis._instrument = this._doc.song.channels[this._doc.channel].instruments[this._doc.getCurrentInstrument()];\r\n\t}\r\n\t\r\n\tpublic commit(): void {\r\n\t\tif (!this.isNoop()) {\r\n\t\t\tthis._instrument.preset = this._instrument.type;\r\n\t\t\tthis._doc.notifier.changed();\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport class ChangePulseWidth extends ChangeInstrumentSlider {\r\n\tconstructor(doc: SongDocument, oldValue: number, newValue: number) {\r\n\t\tsuper(doc);\r\n\t\tthis._instrument.pulseWidth = newValue;\r\n\t\tdoc.notifier.changed();\r\n\t\tif (oldValue != newValue) this._didSomething();\r\n\t}\r\n}\r\n\r\nexport class ChangeSupersawDynamism extends ChangeInstrumentSlider {\r\n\tconstructor(doc: SongDocument, oldValue: number, newValue: number) {\r\n\t\tsuper(doc);\r\n\t\tthis._instrument.supersawDynamism = newValue;\r\n\t\tdoc.notifier.changed();\r\n\t\tif (oldValue != newValue) this._didSomething();\r\n\t}\r\n}\r\nexport class ChangeSupersawSpread extends ChangeInstrumentSlider {\r\n\tconstructor(doc: SongDocument, oldValue: number, newValue: number) {\r\n\t\tsuper(doc);\r\n\t\tthis._instrument.supersawSpread = newValue;\r\n\t\tdoc.notifier.changed();\r\n\t\tif (oldValue != newValue) this._didSomething();\r\n\t}\r\n}\r\nexport class ChangeSupersawShape extends ChangeInstrumentSlider {\r\n\tconstructor(doc: SongDocument, oldValue: number, newValue: number) {\r\n\t\tsuper(doc);\r\n\t\tthis._instrument.supersawShape = newValue;\r\n\t\tdoc.notifier.changed();\r\n\t\tif (oldValue != newValue) this._didSomething();\r\n\t}\r\n}\r\n\r\nexport class ChangePitchShift extends ChangeInstrumentSlider {\r\n\tconstructor(doc: SongDocument, oldValue: number, newValue: number) {\r\n\t\tsuper(doc);\r\n\t\tthis._instrument.pitchShift = newValue;\r\n\t\tdoc.notifier.changed();\r\n\t\tif (oldValue != newValue) this._didSomething();\r\n\t}\r\n}\r\n\r\nexport class ChangeDetune extends ChangeInstrumentSlider {\r\n\tconstructor(doc: SongDocument, oldValue: number, newValue: number) {\r\n\t\tsuper(doc);\r\n\t\tthis._instrument.detune = newValue;\r\n\t\tdoc.notifier.changed();\r\n\t\tif (oldValue != newValue) this._didSomething();\r\n\t}\r\n}\r\n\r\nexport class ChangeDistortion extends ChangeInstrumentSlider {\r\n\tconstructor(doc: SongDocument, oldValue: number, newValue: number) {\r\n\t\tsuper(doc);\r\n\t\tthis._instrument.distortion = newValue;\r\n\t\tdoc.notifier.changed();\r\n\t\tif (oldValue != newValue) this._didSomething();\r\n\t}\r\n}\r\n\r\nexport class ChangeBitcrusherFreq extends ChangeInstrumentSlider {\r\n\tconstructor(doc: SongDocument, oldValue: number, newValue: number) {\r\n\t\tsuper(doc);\r\n\t\tthis._instrument.bitcrusherFreq = newValue;\r\n\t\tdoc.notifier.changed();\r\n\t\tif (oldValue != newValue) this._didSomething();\r\n\t}\r\n}\r\n\r\nexport class ChangeBitcrusherQuantization extends ChangeInstrumentSlider {\r\n\tconstructor(doc: SongDocument, oldValue: number, newValue: number) {\r\n\t\tsuper(doc);\r\n\t\tthis._instrument.bitcrusherQuantization = newValue;\r\n\t\tdoc.notifier.changed();\r\n\t\tif (oldValue != newValue) this._didSomething();\r\n\t}\r\n}\r\n\r\nexport class ChangeStringSustain extends ChangeInstrumentSlider {\r\n\tconstructor(doc: SongDocument, oldValue: number, newValue: number) {\r\n\t\tsuper(doc);\r\n\t\tthis._instrument.stringSustain = newValue;\r\n\t\tdoc.notifier.changed();\r\n\t\tif (oldValue != newValue) this._didSomething();\r\n\t}\r\n}\r\n\r\nexport class ChangeStringSustainType extends Change {\r\n\tconstructor(doc: SongDocument, newValue: SustainType) {\r\n\t\tsuper();\r\n\t\tconst instrument: Instrument = doc.song.channels[doc.channel].instruments[doc.getCurrentInstrument()];\r\n\t\tconst oldValue: SustainType = instrument.stringSustainType;\r\n\t\tif (oldValue != newValue) {\r\n\t\t\tinstrument.stringSustainType = newValue;\r\n\t\t\tinstrument.preset = instrument.type;\r\n\t\t\tdoc.notifier.changed();\r\n\t\t\tthis._didSomething();\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport class ChangeFilterAddPoint extends UndoableChange {\r\n\tprivate _doc: SongDocument;\r\n\tprivate _instrument: Instrument;\r\n\tprivate _instrumentPrevPreset: number;\r\n\tprivate _instrumentNextPreset: number;\r\n\tprivate _filterSettings: FilterSettings;\r\n\tprivate _point: FilterControlPoint;\r\n\tprivate _index: number;\r\n\tprivate _envelopeTargetsAdd: number[] = [];\r\n\tprivate _envelopeIndicesAdd: number[] = [];\r\n\tprivate _envelopeTargetsRemove: number[] = [];\r\n\tprivate _envelopeIndicesRemove: number[] = [];\r\n\tconstructor(doc: SongDocument, filterSettings: FilterSettings, point: FilterControlPoint, index: number, isNoteFilter: boolean, deletion: boolean = false) {\r\n\t\tsuper(deletion);\r\n\t\tthis._doc = doc;\r\n\t\tthis._instrument = this._doc.song.channels[this._doc.channel].instruments[this._doc.getCurrentInstrument()];\r\n\t\tthis._instrumentNextPreset = deletion ? this._instrument.preset : this._instrument.type;\r\n\t\tthis._instrumentPrevPreset = deletion ? this._instrument.type : this._instrument.preset;\r\n\t\tthis._filterSettings = filterSettings;\r\n\t\tthis._point = point;\r\n\t\tthis._index = index;\r\n\t\t\r\n\t\tfor (let envelopeIndex: number = 0; envelopeIndex < this._instrument.envelopeCount; envelopeIndex++) {\r\n\t\t\tlet target: number = this._instrument.envelopes[envelopeIndex].target;\r\n\t\t\tlet targetIndex: number = this._instrument.envelopes[envelopeIndex].index;\r\n\t\t\tthis._envelopeTargetsAdd.push(target);\r\n\t\t\tthis._envelopeIndicesAdd.push(targetIndex);\r\n\t\t\tif (deletion) {\r\n\t\t\t\t// When deleting a filter control point, find all envelopes that targeted that\r\n\t\t\t\t// point and clear them, and all envelopes that targeted later points and\r\n\t\t\t\t// decrement those to keep them in sync with the new list of points.\r\n\t\t\t\tconst automationTarget: AutomationTarget = Config.instrumentAutomationTargets[target];\r\n\t\t\t\tif (automationTarget.isFilter && (automationTarget.effect == EffectType.noteFilter) == isNoteFilter) {\r\n\t\t\t\t\tif (automationTarget.maxCount == Config.filterMaxPoints) {\r\n\t\t\t\t\t\tif (targetIndex == index) {\r\n\t\t\t\t\t\t\ttarget = Config.instrumentAutomationTargets.dictionary[\"none\"].index;\r\n\t\t\t\t\t\t\ttargetIndex = 0;\r\n\t\t\t\t\t\t} else if (targetIndex > index) {\r\n\t\t\t\t\t\t\ttargetIndex--;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tif (filterSettings.controlPointCount <= 1) {\r\n\t\t\t\t\t\t\ttarget = Config.instrumentAutomationTargets.dictionary[\"none\"].index;\r\n\t\t\t\t\t\t\ttargetIndex = 0;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tthis._envelopeTargetsRemove.push(target);\r\n\t\t\tthis._envelopeIndicesRemove.push(targetIndex);\r\n\t\t}\r\n\t\t\r\n\t\tthis._didSomething();\r\n\t\tthis.redo();\r\n\t}\r\n\t\r\n\tprotected _doForwards(): void {\r\n\t\tthis._filterSettings.controlPoints.splice(this._index, 0, this._point);\r\n\t\tthis._filterSettings.controlPointCount++;\r\n\t\tthis._filterSettings.controlPoints.length = this._filterSettings.controlPointCount;\r\n\t\tthis._instrument.preset = this._instrumentNextPreset;\r\n\t\tfor (let envelopeIndex: number = 0; envelopeIndex < this._instrument.envelopeCount; envelopeIndex++) {\r\n\t\t\tthis._instrument.envelopes[envelopeIndex].target = this._envelopeTargetsAdd[envelopeIndex];\r\n\t\t\tthis._instrument.envelopes[envelopeIndex].index  = this._envelopeIndicesAdd[envelopeIndex];\r\n\t\t}\r\n\t\tthis._doc.notifier.changed();\r\n\t}\r\n\t\r\n\tprotected _doBackwards(): void {\r\n\t\tthis._filterSettings.controlPoints.splice(this._index, 1);\r\n\t\tthis._filterSettings.controlPointCount--;\r\n\t\tthis._filterSettings.controlPoints.length = this._filterSettings.controlPointCount;\r\n\t\tthis._instrument.preset = this._instrumentPrevPreset;\r\n\t\tfor (let envelopeIndex: number = 0; envelopeIndex < this._instrument.envelopeCount; envelopeIndex++) {\r\n\t\t\tthis._instrument.envelopes[envelopeIndex].target = this._envelopeTargetsRemove[envelopeIndex];\r\n\t\t\tthis._instrument.envelopes[envelopeIndex].index  = this._envelopeIndicesRemove[envelopeIndex];\r\n\t\t}\r\n\t\tthis._doc.notifier.changed();\r\n\t}\r\n}\r\n\r\nexport class ChangeFilterMovePoint extends UndoableChange {\r\n\tprivate _doc: SongDocument;\r\n\tprivate _instrument: Instrument;\r\n\tprivate _instrumentPrevPreset: number;\r\n\tprivate _instrumentNextPreset: number;\r\n\tprivate _point: FilterControlPoint;\r\n\tprivate _oldFreq: number;\r\n\tprivate _newFreq: number;\r\n\tprivate _oldGain: number;\r\n\tprivate _newGain: number;\r\n\tconstructor(doc: SongDocument, point: FilterControlPoint, oldFreq: number, newFreq: number, oldGain: number, newGain: number) {\r\n\t\tsuper(false);\r\n\t\tthis._doc = doc;\r\n\t\tthis._instrument = this._doc.song.channels[this._doc.channel].instruments[this._doc.getCurrentInstrument()];\r\n\t\tthis._instrumentNextPreset = this._instrument.type;\r\n\t\tthis._instrumentPrevPreset = this._instrument.preset;\r\n\t\tthis._point = point;\r\n\t\tthis._oldFreq = oldFreq;\r\n\t\tthis._newFreq = newFreq;\r\n\t\tthis._oldGain = oldGain;\r\n\t\tthis._newGain = newGain;\r\n\t\tthis._didSomething();\r\n\t\tthis.redo();\r\n\t}\r\n\t\r\n\tprotected _doForwards(): void {\r\n\t\tthis._point.freq = this._newFreq;\r\n\t\tthis._point.gain = this._newGain;\r\n\t\tthis._instrument.preset = this._instrumentNextPreset;\r\n\t\tthis._doc.notifier.changed();\r\n\t}\r\n\t\r\n\tprotected _doBackwards(): void {\r\n\t\tthis._point.freq = this._oldFreq;\r\n\t\tthis._point.gain = this._oldGain;\r\n\t\tthis._instrument.preset = this._instrumentPrevPreset;\r\n\t\tthis._doc.notifier.changed();\r\n\t}\r\n}\r\n\r\nexport class ChangeFadeInOut extends UndoableChange {\r\n\tprivate _doc: SongDocument;\r\n\tprivate _instrument: Instrument;\r\n\tprivate _instrumentPrevPreset: number;\r\n\tprivate _instrumentNextPreset: number;\r\n\tprivate _oldFadeIn: number;\r\n\tprivate _oldFadeOut: number;\r\n\tprivate _newFadeIn: number;\r\n\tprivate _newFadeOut: number;\r\n\tconstructor(doc: SongDocument, fadeIn: number, fadeOut: number) {\r\n\t\tsuper(false);\r\n\t\tthis._doc = doc;\r\n\t\tthis._instrument = this._doc.song.channels[this._doc.channel].instruments[this._doc.getCurrentInstrument()];\r\n\t\tthis._instrumentNextPreset = this._instrument.type;\r\n\t\tthis._instrumentPrevPreset = this._instrument.preset;\r\n\t\tthis._oldFadeIn = this._instrument.fadeIn;\r\n\t\tthis._oldFadeOut = this._instrument.fadeOut;\r\n\t\tthis._newFadeIn = fadeIn;\r\n\t\tthis._newFadeOut = fadeOut;\r\n\t\tthis._didSomething();\r\n\t\tthis.redo();\r\n\t}\r\n\t\r\n\tprotected _doForwards(): void {\r\n\t\tthis._instrument.fadeIn = this._newFadeIn;\r\n\t\tthis._instrument.fadeOut = this._newFadeOut;\r\n\t\tthis._instrument.preset = this._instrumentNextPreset;\r\n\t\tthis._doc.notifier.changed();\r\n\t}\r\n\t\r\n\tprotected _doBackwards(): void {\r\n\t\tthis._instrument.fadeIn = this._oldFadeIn;\r\n\t\tthis._instrument.fadeOut = this._oldFadeOut;\r\n\t\tthis._instrument.preset = this._instrumentPrevPreset;\r\n\t\tthis._doc.notifier.changed();\r\n\t}\r\n}\r\n\r\nexport class ChangeAlgorithm extends Change {\r\n\tconstructor(doc: SongDocument, newValue: number) {\r\n\t\tsuper();\r\n\t\tconst instrument: Instrument = doc.song.channels[doc.channel].instruments[doc.getCurrentInstrument()];\r\n\t\tconst oldValue: number = instrument.algorithm;\r\n\t\tif (oldValue != newValue) {\r\n\t\t\tinstrument.algorithm = newValue;\r\n\t\t\tinstrument.preset = instrument.type;\r\n\t\t\tdoc.notifier.changed();\r\n\t\t\tthis._didSomething();\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport class ChangeFeedbackType extends Change {\r\n\tconstructor(doc: SongDocument, newValue: number) {\r\n\t\tsuper();\r\n\t\tconst instrument: Instrument = doc.song.channels[doc.channel].instruments[doc.getCurrentInstrument()];\r\n\t\tconst oldValue: number = instrument.feedbackType;\r\n\t\tif (oldValue != newValue) {\r\n\t\t\tinstrument.feedbackType = newValue;\r\n\t\t\tinstrument.preset = instrument.type;\r\n\t\t\tdoc.notifier.changed();\r\n\t\t\tthis._didSomething();\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport class ChangeOperatorFrequency extends Change {\r\n\tconstructor(doc: SongDocument, operatorIndex: number, newValue: number) {\r\n\t\tsuper();\r\n\t\tconst instrument: Instrument = doc.song.channels[doc.channel].instruments[doc.getCurrentInstrument()];\r\n\t\tconst oldValue: number = instrument.operators[operatorIndex].frequency;\r\n\t\tif (oldValue != newValue) {\r\n\t\t\tinstrument.operators[operatorIndex].frequency = newValue;\r\n\t\t\tinstrument.preset = instrument.type;\r\n\t\t\tdoc.notifier.changed();\r\n\t\t\tthis._didSomething();\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport class ChangeOperatorAmplitude extends ChangeInstrumentSlider {\r\n\tconstructor(doc: SongDocument, operatorIndex: number, oldValue: number, newValue: number) {\r\n\t\tsuper(doc);\r\n\t\tthis._instrument.operators[operatorIndex].amplitude = newValue;\r\n\t\tdoc.notifier.changed();\r\n\t\tif (oldValue != newValue) this._didSomething();\r\n\t}\r\n}\r\n\r\nexport class ChangeFeedbackAmplitude extends ChangeInstrumentSlider {\r\n\tconstructor(doc: SongDocument, oldValue: number, newValue: number) {\r\n\t\tsuper(doc);\r\n\t\tthis._instrument.feedbackAmplitude = newValue;\r\n\t\tdoc.notifier.changed();\r\n\t\tif (oldValue != newValue) this._didSomething();\r\n\t}\r\n}\r\n\r\nexport class ChangeAddChannelInstrument extends Change {\r\n\tconstructor(doc: SongDocument) {\r\n\t\tsuper();\r\n\t\tconst channel: Channel = doc.song.channels[doc.channel];\r\n\t\tconst isNoise: boolean = doc.song.getChannelIsNoise(doc.channel);\r\n\t\tconst maxInstruments: number = doc.song.getMaxInstrumentsPerChannel();\r\n\t\tif (channel.instruments.length >= maxInstruments) return;\r\n\t\tconst presetValue: number = pickRandomPresetValue(isNoise);\r\n\t\tconst preset: Preset = EditorConfig.valueToPreset(presetValue)!;\r\n\t\tconst instrument: Instrument = new Instrument(isNoise);\r\n\t\tinstrument.fromJsonObject(preset.settings, isNoise, 1);\r\n\t\tinstrument.preset = presetValue;\r\n\t\tinstrument.volume = 1;\r\n\t\tchannel.instruments.push(instrument);\r\n\t\tdoc.viewedInstrument[doc.channel] = channel.instruments.length - 1;\r\n\t\tdoc.notifier.changed();\r\n\t\tthis._didSomething();\r\n\t}\r\n}\r\n\r\nexport class ChangeRemoveChannelInstrument extends Change {\r\n\tconstructor(doc: SongDocument) {\r\n\t\tsuper();\r\n\t\tconst channel: Channel = doc.song.channels[doc.channel];\r\n\t\tif (channel.instruments.length <= Config.instrumentCountMin) return;\r\n\t\tconst removedIndex: number = doc.viewedInstrument[doc.channel];\r\n\t\tchannel.instruments.splice(removedIndex, 1);\r\n\t\tif (doc.song.patternInstruments) {\r\n\t\t\tfor (const pattern of channel.patterns) {\r\n\t\t\t\tfor (let i: number = 0; i < pattern.instruments.length; i++) {\r\n\t\t\t\t\tif (pattern.instruments[i] == removedIndex) {\r\n\t\t\t\t\t\tpattern.instruments.splice(i, 1);\r\n\t\t\t\t\t\ti--;\r\n\t\t\t\t\t} else if (pattern.instruments[i] > removedIndex) {\r\n\t\t\t\t\t\tpattern.instruments[i]--;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tif (pattern.instruments.length <= 0) {\r\n\t\t\t\t\tpattern.instruments[0] = 0;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\tdoc.notifier.changed();\r\n\t\tthis._didSomething();\r\n\t}\r\n}\r\n\r\nexport class ChangeViewInstrument extends Change {\r\n\tconstructor(doc: SongDocument, index: number) {\r\n\t\tsuper();\r\n\t\tif (doc.viewedInstrument[doc.channel] != index) {\r\n\t\t\tdoc.viewedInstrument[doc.channel] = index;\r\n\t\t\tdoc.notifier.changed();\r\n\t\t\tthis._didSomething();\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport class ChangeInstrumentsFlags extends Change {\r\n\tconstructor(doc: SongDocument, newLayeredInstruments: boolean, newPatternInstruments: boolean) {\r\n\t\tsuper();\r\n\t\tconst oldLayeredInstruments: boolean = doc.song.layeredInstruments;\r\n\t\tconst oldPatternInstruments: boolean = doc.song.patternInstruments;\r\n\t\tif (oldLayeredInstruments == newLayeredInstruments && oldPatternInstruments == newPatternInstruments) return;\r\n\t\tdoc.song.layeredInstruments = newLayeredInstruments;\r\n\t\tdoc.song.patternInstruments = newPatternInstruments;\r\n\t\t\r\n\t\tfor (let channelIndex: number = 0; channelIndex < doc.song.getChannelCount(); channelIndex++) {\r\n\t\t\tconst channel: Channel = doc.song.channels[channelIndex];\r\n\t\t\tif (channel.instruments.length > doc.song.getMaxInstrumentsPerChannel()) {\r\n\t\t\t\tchannel.instruments.length = doc.song.getMaxInstrumentsPerChannel();\r\n\t\t\t}\r\n\t\t\tfor (let j: number = 0; j < doc.song.patternsPerChannel; j++) {\r\n\t\t\t\tconst pattern: Pattern = channel.patterns[j];\r\n\t\t\t\tif (!oldPatternInstruments && newPatternInstruments) {\r\n\t\t\t\t\t// patternInstruments was enabled, set up pattern instruments as appropriate.\r\n\t\t\t\t\tfor (let i: number = 0; i < channel.instruments.length; i++) {\r\n\t\t\t\t\t\tpattern.instruments[i] = i;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tpattern.instruments.length = channel.instruments.length;\r\n\t\t\t\t}\r\n\t\t\t\tdiscardInvalidPatternInstruments(pattern.instruments, doc.song, channelIndex);\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tdoc.notifier.changed();\r\n\t\tthis._didSomething();\r\n\t}\r\n}\r\n\r\nexport class ChangeKey extends Change {\r\n\tconstructor(doc: SongDocument, newValue: number) {\r\n\t\tsuper();\r\n\t\tif (doc.song.key != newValue) {\r\n\t\t\tdoc.song.key = newValue;\r\n\t\t\tdoc.notifier.changed();\r\n\t\t\tthis._didSomething();\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport class ChangeLoop extends Change {\r\n\tconstructor(private _doc: SongDocument, public oldStart: number, public oldLength: number, public newStart: number, public newLength: number) {\r\n\t\tsuper();\r\n\t\tthis._doc.song.loopStart = this.newStart;\r\n\t\tthis._doc.song.loopLength = this.newLength;\r\n\t\tthis._doc.notifier.changed();\r\n\t\tif (this.oldStart != this.newStart || this.oldLength != this.newLength) {\r\n\t\t\tthis._didSomething();\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport class ChangePitchAdded extends UndoableChange {\r\n\tprivate _doc: SongDocument;\r\n\tprivate _note: Note;\r\n\tprivate _pitch: number;\r\n\tprivate _index: number;\r\n\tconstructor(doc: SongDocument, note: Note, pitch: number, index: number, deletion: boolean = false) {\r\n\t\tsuper(deletion);\r\n\t\tthis._doc = doc;\r\n\t\tthis._note = note;\r\n\t\tthis._pitch = pitch;\r\n\t\tthis._index = index;\r\n\t\tthis._didSomething();\r\n\t\tthis.redo();\r\n\t}\r\n\t\r\n\tprotected _doForwards(): void {\r\n\t\tthis._note.pitches.splice(this._index, 0, this._pitch);\r\n\t\tthis._doc.notifier.changed();\r\n\t}\r\n\t\r\n\tprotected _doBackwards(): void {\r\n\t\tthis._note.pitches.splice(this._index, 1);\r\n\t\tthis._doc.notifier.changed();\r\n\t}\r\n}\r\n\r\nexport class ChangeOctave extends Change {\r\n\tconstructor(doc: SongDocument, public oldValue: number, newValue: number) {\r\n\t\tsuper();\r\n\t\tdoc.song.channels[doc.channel].octave = newValue;\r\n\t\tdoc.notifier.changed();\r\n\t\tif (oldValue != newValue) this._didSomething();\r\n\t}\r\n}\r\n\r\nexport class ChangeRhythm extends ChangeGroup {\r\n\tconstructor(doc: SongDocument, newValue: number) {\r\n\t\tsuper();\r\n\t\t\r\n\t\tif (doc.song.rhythm != newValue) {\r\n\t\t\tdoc.song.rhythm = newValue;\r\n\t\t\tdoc.notifier.changed();\r\n\t\t\tthis._didSomething();\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport class ChangePaste extends ChangeGroup {\r\n\tconstructor(doc: SongDocument, pattern: Pattern, notes: any[], selectionStart: number, selectionEnd: number, oldPartDuration: number) {\r\n\t\tsuper();\r\n\t\t\r\n\t\t// Erase the current contents of the selection:\r\n\t\tthis.append(new ChangeNoteTruncate(doc, pattern, selectionStart, selectionEnd));\r\n\t\t\r\n\t\tlet noteInsertionIndex: number = 0;\r\n\t\tfor (let i: number = 0; i < pattern.notes.length; i++) {\r\n\t\t\tif (pattern.notes[i].start < selectionStart) {\r\n\t\t\t\tif (pattern.notes[i].end > selectionStart) throw new Error();\r\n\t\t\t\t\r\n\t\t\t\tnoteInsertionIndex = i + 1;\r\n\t\t\t} else if (pattern.notes[i].start < selectionEnd) {\r\n\t\t\t\tthrow new Error();\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\twhile (selectionStart < selectionEnd) {\r\n\t\t\tfor (const noteObject of notes) {\r\n\t\t\t\tconst noteStart: number = noteObject[\"start\"] + selectionStart;\r\n\t\t\t\tconst noteEnd: number = noteObject[\"end\"] + selectionStart;\r\n\t\t\t\tif (noteStart >= selectionEnd) break;\r\n\t\t\t\tconst note: Note = new Note(noteObject[\"pitches\"][0], noteStart, noteEnd, noteObject[\"pins\"][0][\"size\"], false);\r\n\t\t\t\tnote.pitches.length = 0;\r\n\t\t\t\tfor (const pitch of noteObject[\"pitches\"]) {\r\n\t\t\t\t\tnote.pitches.push(pitch);\r\n\t\t\t\t}\r\n\t\t\t\tnote.pins.length = 0;\r\n\t\t\t\tfor (const pin of noteObject[\"pins\"]) {\r\n\t\t\t\t\tnote.pins.push(makeNotePin(pin.interval, pin.time, pin.size));\r\n\t\t\t\t}\r\n\t\t\t\tnote.continuesLastPattern = (noteObject[\"continuesLastPattern\"] === true) && (note.start == 0);\r\n\t\t\t\tpattern.notes.splice(noteInsertionIndex++, 0, note);\r\n\t\t\t\tif (note.end > selectionEnd) {\r\n\t\t\t\t\tthis.append(new ChangeNoteLength(doc, note, note.start, selectionEnd));\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tselectionStart += oldPartDuration;\r\n\t\t}\r\n\t\t\r\n\t\tdoc.notifier.changed();\r\n\t\tthis._didSomething();\r\n\t}\r\n}\r\n\r\nexport class ChangePasteInstrument extends ChangeGroup {\r\n\tconstructor(doc: SongDocument, instrument: Instrument, instrumentCopy: any) {\r\n\t\tsuper();\r\n\t\tinstrument.fromJsonObject(instrumentCopy, instrumentCopy[\"isDrum\"]);\r\n\t\tdoc.notifier.changed();\r\n\t\tthis._didSomething();\r\n\t}\r\n}\r\n\r\nexport class ChangeSetPatternInstruments extends Change {\r\n\tconstructor(doc: SongDocument, channelIndex: number, instruments: number[], pattern: Pattern) {\r\n\t\tsuper();\r\n\t\tif (!patternsContainSameInstruments(instruments, pattern.instruments)) {\r\n\t\t\tpattern.instruments.length = 0;\r\n\t\t\tpattern.instruments.push(...instruments);\r\n\t\t\tdiscardInvalidPatternInstruments(pattern.instruments, doc.song, channelIndex);\r\n\t\t\tthis._didSomething();\r\n\t\t\tdoc.notifier.changed();\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport class ChangePatternsPerChannel extends Change {\r\n\tconstructor(doc: SongDocument, newValue: number) {\r\n\t\tsuper();\r\n\t\tif (doc.song.patternsPerChannel != newValue) {\r\n\t\t\tfor (let i: number = 0; i < doc.song.getChannelCount(); i++) {\r\n\t\t\t\tconst channelBars: number[] = doc.song.channels[i].bars;\r\n\t\t\t\tconst channelPatterns: Pattern[] = doc.song.channels[i].patterns;\r\n\t\t\t\tfor (let j: number = 0; j < channelBars.length; j++) {\r\n\t\t\t\t\tif (channelBars[j] > newValue) channelBars[j] = 0;\r\n\t\t\t\t}\r\n\t\t\t\tfor (let j: number = channelPatterns.length; j < newValue; j++) {\r\n\t\t\t\t\tchannelPatterns[j] = new Pattern();\r\n\t\t\t\t}\r\n\t\t\t\tchannelPatterns.length = newValue;\r\n\t\t\t}\r\n\t\t\tdoc.song.patternsPerChannel = newValue;\r\n\t\t\tdoc.notifier.changed();\r\n\t\t\tthis._didSomething();\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport class ChangeEnsurePatternExists extends UndoableChange {\r\n\tprivate _doc: SongDocument;\r\n\tprivate _bar: number;\r\n\tprivate _channelIndex: number;\r\n\tprivate _patternIndex: number;\r\n\tprivate _patternOldNotes: Note[] | null = null;\r\n\tprivate _oldPatternCount: number;\r\n\tprivate _newPatternCount: number;\r\n\tprivate _oldPatternInstruments: number[] | null = null;\r\n\tprivate _newPatternInstruments: number[];\r\n\t\r\n\tconstructor(doc: SongDocument, channelIndex: number, bar: number) {\r\n\t\tsuper(false);\r\n\t\tconst song: Song = doc.song;\r\n\t\tif (song.channels[channelIndex].bars[bar] != 0) return;\r\n\t\t\r\n\t\tthis._doc = doc;\r\n\t\tthis._bar = bar;\r\n\t\tthis._channelIndex = channelIndex;\r\n\t\tthis._oldPatternCount = song.patternsPerChannel;\r\n\t\tthis._newPatternCount = song.patternsPerChannel;\r\n\t\tthis._newPatternInstruments = doc.recentPatternInstruments[channelIndex].concat();\r\n\t\t\r\n\t\tlet firstEmptyUnusedIndex: number | null = null;\r\n\t\tlet firstUnusedIndex: number | null = null;\r\n\t\tfor (let patternIndex: number = 1; patternIndex <= song.patternsPerChannel; patternIndex++) {\r\n\t\t\tlet used = false;\r\n\t\t\tfor (let barIndex: number = 0; barIndex < song.barCount; barIndex++) {\r\n\t\t\t\tif (song.channels[channelIndex].bars[barIndex] == patternIndex) {\r\n\t\t\t\t\tused = true;\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tif (used) continue;\r\n\t\t\tif (firstUnusedIndex == null) {\r\n\t\t\t\tfirstUnusedIndex = patternIndex;\r\n\t\t\t}\r\n\t\t\tconst pattern: Pattern = song.channels[channelIndex].patterns[patternIndex - 1];\r\n\t\t\tif (pattern.notes.length == 0) {\r\n\t\t\t\tfirstEmptyUnusedIndex = patternIndex;\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tif (firstEmptyUnusedIndex != null) {\r\n\t\t\tthis._patternIndex = firstEmptyUnusedIndex;\r\n\t\t\tthis._oldPatternInstruments = song.channels[channelIndex].patterns[firstEmptyUnusedIndex - 1].instruments.concat();\r\n\t\t} else if (song.patternsPerChannel < song.barCount) {\r\n\t\t\tthis._newPatternCount = song.patternsPerChannel + 1;\r\n\t\t\tthis._patternIndex = song.patternsPerChannel + 1;\r\n\t\t} else if (firstUnusedIndex != null) {\r\n\t\t\tthis._patternIndex = firstUnusedIndex;\r\n\t\t\tthis._patternOldNotes = song.channels[channelIndex].patterns[firstUnusedIndex - 1].notes;\r\n\t\t\tthis._oldPatternInstruments = song.channels[channelIndex].patterns[firstUnusedIndex - 1].instruments.concat();\r\n\t\t} else {\r\n\t\t\tthrow new Error();\r\n\t\t}\r\n\t\t\r\n\t\tthis._didSomething();\r\n\t\tthis._doForwards();\r\n\t}\r\n\t\r\n\tprotected _doForwards(): void {\r\n\t\tconst song: Song = this._doc.song;\r\n\t\tfor (let j: number = song.patternsPerChannel; j < this._newPatternCount; j++) {\r\n\t\t\tfor (let i: number = 0; i < song.getChannelCount(); i++) {\r\n\t\t\t\tsong.channels[i].patterns[j] = new Pattern();\r\n\t\t\t}\r\n\t\t}\r\n\t\tsong.patternsPerChannel = this._newPatternCount;\r\n\t\tconst pattern: Pattern = song.channels[this._channelIndex].patterns[this._patternIndex - 1];\r\n\t\tpattern.notes = [];\r\n\t\tpattern.instruments.length = 0;\r\n\t\tpattern.instruments.push(...this._newPatternInstruments);\r\n\t\tsong.channels[this._channelIndex].bars[this._bar] = this._patternIndex;\r\n\t\tthis._doc.notifier.changed();\r\n\t}\r\n\t\r\n\tprotected _doBackwards(): void {\r\n\t\tconst song: Song = this._doc.song;\r\n\t\tconst pattern: Pattern = song.channels[this._channelIndex].patterns[this._patternIndex - 1];\r\n\t\tif (this._patternOldNotes != null) pattern.notes = this._patternOldNotes;\r\n\t\tif (this._oldPatternInstruments != null) {\r\n\t\t\tpattern.instruments.length = 0;\r\n\t\t\tpattern.instruments.push(...this._oldPatternInstruments);\r\n\t\t}\r\n\t\tsong.channels[this._channelIndex].bars[this._bar] = 0;\r\n\t\tfor (let i: number = 0; i < song.getChannelCount(); i++) {\r\n\t\t\tsong.channels[i].patterns.length = this._oldPatternCount;\r\n\t\t}\r\n\t\tsong.patternsPerChannel = this._oldPatternCount;\r\n\t\tthis._doc.notifier.changed();\r\n\t}\r\n}\r\n\r\nexport class ChangePinTime extends ChangePins {\r\n\tconstructor(doc: SongDocument | null, note: Note, pinIndex: number, shiftedTime: number, continuesLastPattern: boolean) {\r\n\t\tsuper(doc, note);\r\n\t\t\r\n\t\tshiftedTime -= this._oldStart;\r\n\t\tconst originalTime: number = this._oldPins[pinIndex].time;\r\n\t\tconst skipStart: number = Math.min(originalTime, shiftedTime);\r\n\t\tconst skipEnd: number = Math.max(originalTime, shiftedTime);\r\n\t\tlet setPin: boolean = false;\r\n\t\tfor (let i: number = 0; i < this._oldPins.length; i++) {\r\n\t\t\tconst oldPin: NotePin = note.pins[i];\r\n\t\t\tconst time: number = oldPin.time;\r\n\t\t\tif (time < skipStart) {\r\n\t\t\t\tthis._newPins.push(makeNotePin(oldPin.interval, time, oldPin.size));\r\n\t\t\t} else if (time > skipEnd) {\r\n\t\t\t\tif (!setPin) {\r\n\t\t\t\t\tif (this._newPins.length > 0) continuesLastPattern = note.continuesLastPattern;\r\n\t\t\t\t\tthis._newPins.push(makeNotePin(this._oldPins[pinIndex].interval, shiftedTime, this._oldPins[pinIndex].size));\r\n\t\t\t\t\tsetPin = true;\r\n\t\t\t\t}\r\n\t\t\t\tthis._newPins.push(makeNotePin(oldPin.interval, time, oldPin.size));\r\n\t\t\t}\r\n\t\t}\r\n\t\tif (!setPin) {\r\n\t\t\tcontinuesLastPattern = note.continuesLastPattern;\r\n\t\t\tthis._newPins.push(makeNotePin(this._oldPins[pinIndex].interval, shiftedTime, this._oldPins[pinIndex].size));\r\n\t\t}\r\n\t\t\r\n\t\tthis._finishSetup(continuesLastPattern);\r\n\t}\r\n}\r\n\r\nexport class ChangePitchBend extends ChangePins {\r\n\tconstructor(doc: SongDocument | null, note: Note, bendStart: number, bendEnd: number, bendTo: number, pitchIndex: number) {\r\n\t\tsuper(doc, note);\r\n\t\t\r\n\t\tbendStart -= this._oldStart;\r\n\t\tbendEnd   -= this._oldStart;\r\n\t\tbendTo    -= note.pitches[pitchIndex];\r\n\t\t\r\n\t\tlet setStart: boolean = false;\r\n\t\tlet setEnd: boolean   = false;\r\n\t\tlet prevInterval: number = 0;\r\n\t\tlet prevSize: number = Config.noteSizeMax;\r\n\t\tlet persist: boolean = true;\r\n\t\tlet i: number;\r\n\t\tlet direction: number;\r\n\t\tlet stop: number;\r\n\t\tlet push: (item: NotePin)=>void;\r\n\t\tif (bendEnd > bendStart) {\r\n\t\t\ti = 0;\r\n\t\t\tdirection = 1;\r\n\t\t\tstop = note.pins.length;\r\n\t\t\tpush = (item: NotePin)=>{ this._newPins.push(item); };\r\n\t\t} else {\r\n\t\t\ti = note.pins.length - 1;\r\n\t\t\tdirection = -1;\r\n\t\t\tstop = -1;\r\n\t\t\tpush = (item: NotePin)=>{ this._newPins.unshift(item); };\r\n\t\t}\r\n\t\tfor (; i != stop; i += direction) {\r\n\t\t\tconst oldPin: NotePin = note.pins[i];\r\n\t\t\tconst time: number = oldPin.time;\r\n\t\t\tfor (;;) {\r\n\t\t\t\tif (!setStart) {\r\n\t\t\t\t\tif (time * direction <= bendStart * direction) {\r\n\t\t\t\t\t\tprevInterval = oldPin.interval;\r\n\t\t\t\t\t\tprevSize = oldPin.size;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (time * direction < bendStart * direction) {\r\n\t\t\t\t\t\tpush(makeNotePin(oldPin.interval, time, oldPin.size));\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tpush(makeNotePin(prevInterval, bendStart, prevSize));\r\n\t\t\t\t\t\tsetStart = true;\r\n\t\t\t\t\t}\r\n\t\t\t\t} else if (!setEnd) {\r\n\t\t\t\t\tif (time * direction <= bendEnd * direction) {\r\n\t\t\t\t\t\tprevInterval = oldPin.interval;\r\n\t\t\t\t\t\tprevSize = oldPin.size;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (time * direction < bendEnd * direction) {\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tpush(makeNotePin(bendTo, bendEnd, prevSize));\r\n\t\t\t\t\t\tsetEnd = true;\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\tif (time * direction == bendEnd * direction) {\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tif (oldPin.interval != prevInterval) persist = false;\r\n\t\t\t\t\t\tpush(makeNotePin(persist ? bendTo : oldPin.interval, time, oldPin.size));\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\tif (!setEnd) {\r\n\t\t\tpush(makeNotePin(bendTo, bendEnd, prevSize));\r\n\t\t}\r\n\t\t\r\n\t\tthis._finishSetup();\r\n\t}\r\n}\r\n\r\nexport class ChangePatternRhythm extends ChangeSequence {\r\n\tconstructor(doc: SongDocument, pattern: Pattern) {\r\n\t\tsuper();\r\n\t\tconst minDivision: number = Config.partsPerBeat / Config.rhythms[doc.song.rhythm].stepsPerBeat;\r\n\t\t\r\n\t\tconst changeRhythm: (oldTime:number)=>number = function(oldTime: number): number {\r\n\t\t\tlet thresholds: number[] | null = Config.rhythms[doc.song.rhythm].roundUpThresholds;\r\n\t\t\tif (thresholds != null) {\r\n\t\t\t\tconst beatStart: number = Math.floor(oldTime / Config.partsPerBeat) * Config.partsPerBeat;\r\n\t\t\t\tconst remainder: number = oldTime - beatStart;\r\n\t\t\t\tlet newTime: number = beatStart;\r\n\t\t\t\tfor (const threshold of thresholds) {\r\n\t\t\t\t\tif (remainder >= threshold) {\r\n\t\t\t\t\t\tnewTime += minDivision;\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\treturn newTime;\r\n\t\t\t} else {\r\n\t\t\t\treturn Math.round(oldTime / minDivision) * minDivision;\r\n\t\t\t}\r\n\t\t};\r\n\t\t\r\n\t\tlet i: number = 0;\r\n\t\twhile (i < pattern.notes.length) {\r\n\t\t\tconst note: Note = pattern.notes[i];\r\n\t\t\tif (changeRhythm(note.start) >= changeRhythm(note.end)) {\r\n\t\t\t\tthis.append(new ChangeNoteAdded(doc, pattern, note, i, true));\r\n\t\t\t} else {\r\n\t\t\t\tthis.append(new ChangeRhythmNote(doc, note, changeRhythm));\r\n\t\t\t\ti++;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n\r\nclass ChangeRhythmNote extends ChangePins {\r\n\tconstructor(doc: SongDocument | null, note: Note, changeRhythm: (oldTime:number)=>number) {\r\n\t\tsuper(doc, note);\r\n\t\t\r\n\t\tfor (const oldPin of this._oldPins) {\r\n\t\t\tthis._newPins.push(makeNotePin(oldPin.interval, changeRhythm(oldPin.time + this._oldStart) - this._oldStart, oldPin.size));\r\n\t\t}\r\n\t\t\r\n\t\tthis._finishSetup();\r\n\t}\r\n}\r\n\r\nexport class ChangeMoveNotesSideways extends ChangeGroup {\r\n\tconstructor(doc: SongDocument, beatsToMove: number, strategy: string) {\r\n\t\tsuper();\r\n\t\tlet partsToMove: number = Math.round((beatsToMove % doc.song.beatsPerBar) * Config.partsPerBeat);\r\n\t\tif (partsToMove < 0) partsToMove += doc.song.beatsPerBar * Config.partsPerBeat;\r\n\t\tif (partsToMove == 0.0) return;\r\n\t\t\r\n\t\tswitch (strategy) {\r\n\t\t\tcase \"wrapAround\": {\r\n\t\t\t\tconst partsPerBar: number = Config.partsPerBeat * doc.song.beatsPerBar;\r\n\t\t\t\tfor (const channel of doc.song.channels) {\r\n\t\t\t\t\tfor (const pattern of channel.patterns) {\r\n\t\t\t\t\t\tconst newNotes: Note[] = [];\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tfor (let bar: number = 1; bar >= 0; bar--) {\r\n\t\t\t\t\t\t\tconst barStartPart: number = bar * partsPerBar;\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tfor (const oldNote of pattern.notes) {\r\n\t\t\t\t\t\t\t\tconst absoluteNoteStart: number = oldNote.start + partsToMove;\r\n\t\t\t\t\t\t\t\tconst absoluteNoteEnd: number = oldNote.end + partsToMove;\r\n\t\t\t\t\t\t\t\tconst noteStartPart: number = Math.max(0, absoluteNoteStart - barStartPart);\r\n\t\t\t\t\t\t\t\tconst noteEndPart: number = Math.min(partsPerBar, absoluteNoteEnd - barStartPart);\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tif (noteStartPart < noteEndPart) {\r\n\t\t\t\t\t\t\t\t\tprojectNoteIntoBar(oldNote, absoluteNoteStart - barStartPart - noteStartPart, noteStartPart, noteEndPart, newNotes);\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tpattern.notes = newNotes;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t} break;\r\n\t\t\tcase \"overflow\": {\r\n\t\t\t\tlet originalBarCount: number = doc.song.barCount;\r\n\t\t\t\tlet originalLoopStart: number = doc.song.loopStart;\r\n\t\t\t\tlet originalLoopLength: number = doc.song.loopLength;\r\n\t\t\t\t\r\n\t\t\t\tthis.append(new ChangeMoveAndOverflowNotes(doc, doc.song.beatsPerBar, partsToMove));\r\n\t\t\t\t\r\n\t\t\t\tif (beatsToMove < 0) {\r\n\t\t\t\t\tlet firstBarIsEmpty: boolean = true;\r\n\t\t\t\t\tfor (const channel of doc.song.channels) {\r\n\t\t\t\t\t\tif (channel.bars[0] != 0) firstBarIsEmpty = false;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (firstBarIsEmpty) {\r\n\t\t\t\t\t\tfor (const channel of doc.song.channels) {\r\n\t\t\t\t\t\t\tchannel.bars.shift();\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tdoc.song.barCount--;\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\toriginalBarCount++;\r\n\t\t\t\t\t\toriginalLoopStart++;\r\n\t\t\t\t\t\tdoc.bar++;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\twhile (doc.song.barCount < originalBarCount) {\r\n\t\t\t\t\tfor (const channel of doc.song.channels) {\r\n\t\t\t\t\t\tchannel.bars.push(0);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tdoc.song.barCount++;\r\n\t\t\t\t}\r\n\t\t\t\tdoc.song.loopStart = originalLoopStart;\r\n\t\t\t\tdoc.song.loopLength = originalLoopLength;\r\n\t\t\t} break;\r\n\t\t\tdefault: throw new Error(\"Unrecognized beats-per-bar conversion strategy.\");\r\n\t\t}\r\n\r\n\t\tdoc.notifier.changed();\r\n\t\tthis._didSomething();\r\n\t}\r\n}\r\n\r\nexport class ChangeBeatsPerBar extends ChangeGroup {\r\n\tconstructor(doc: SongDocument, newValue: number, strategy: string) {\r\n\t\tsuper();\r\n\t\tif (doc.song.beatsPerBar != newValue) {\r\n\t\t\tswitch (strategy) {\r\n\t\t\t\tcase \"splice\": {\r\n\t\t\t\t\tif (doc.song.beatsPerBar > newValue) {\r\n\t\t\t\t\t\tconst sequence: ChangeSequence = new ChangeSequence();\r\n\t\t\t\t\t\tfor (let i: number = 0; i < doc.song.getChannelCount(); i++) {\r\n\t\t\t\t\t\t\tfor (let j: number = 0; j < doc.song.channels[i].patterns.length; j++) {\r\n\t\t\t\t\t\t\t\tsequence.append(new ChangeNoteTruncate(doc, doc.song.channels[i].patterns[j], newValue * Config.partsPerBeat, doc.song.beatsPerBar * Config.partsPerBeat));\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t} break;\r\n\t\t\t\tcase \"stretch\": {\r\n\t\t\t\t\tconst changeRhythm = function(oldTime: number): number {\r\n\t\t\t\t\t\treturn Math.round(oldTime * newValue / doc.song.beatsPerBar);\r\n\t\t\t\t\t};\r\n\t\t\t\t\tfor (let channelIndex: number = 0; channelIndex < doc.song.getChannelCount(); channelIndex++) {\r\n\t\t\t\t\t\tfor (let patternIndex: number = 0; patternIndex < doc.song.channels[channelIndex].patterns.length; patternIndex++) {\r\n\t\t\t\t\t\t\tconst pattern: Pattern = doc.song.channels[channelIndex].patterns[patternIndex]; \r\n\t\t\t\t\t\t\tlet noteIndex: number = 0;\r\n\t\t\t\t\t\t\twhile (noteIndex < pattern.notes.length) {\r\n\t\t\t\t\t\t\t\tconst note: Note = pattern.notes[noteIndex];\r\n\t\t\t\t\t\t\t\tif (changeRhythm(note.start) >= changeRhythm(note.end)) {\r\n\t\t\t\t\t\t\t\t\tthis.append(new ChangeNoteAdded(doc, pattern, note, noteIndex, true));\r\n\t\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\t\tthis.append(new ChangeRhythmNote(doc, note, changeRhythm));\r\n\t\t\t\t\t\t\t\t\tnoteIndex++;\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\tthis.append(new ChangeTempo(doc, doc.song.tempo, doc.song.tempo * newValue / doc.song.beatsPerBar));\r\n\t\t\t\t} break;\r\n\t\t\t\tcase \"overflow\": {\r\n\t\t\t\t\tthis.append(new ChangeMoveAndOverflowNotes(doc, newValue, 0));\r\n\t\t\t\t\tdoc.song.loopStart = 0;\r\n\t\t\t\t\tdoc.song.loopLength = doc.song.barCount;\r\n\t\t\t\t} break;\r\n\t\t\t\tdefault: throw new Error(\"Unrecognized beats-per-bar conversion strategy.\");\r\n\t\t\t}\r\n\r\n\t\t\tdoc.song.beatsPerBar = newValue;\r\n\t\t\tdoc.notifier.changed();\r\n\t\t\tthis._didSomething();\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport class ChangeScale extends ChangeGroup {\r\n\tconstructor(doc: SongDocument, newValue: number) {\r\n\t\tsuper();\r\n\t\tif (doc.song.scale != newValue) {\r\n\t\t\tdoc.song.scale = newValue;\r\n\t\t\tdoc.notifier.changed();\r\n\t\t\tthis._didSomething();\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport class ChangeDetectKey extends ChangeGroup {\r\n\tconstructor(doc: SongDocument) {\r\n\t\tsuper();\r\n\t\tconst song: Song = doc.song;\r\n\t\tconst basePitch: number = Config.keys[song.key].basePitch;\r\n\t\tconst keyWeights: number[] = [0,0,0,0,0,0,0,0,0,0,0,0];\r\n\t\tfor (let channelIndex: number = 0; channelIndex < song.pitchChannelCount; channelIndex++) {\r\n\t\t\tfor (let barIndex: number = 0; barIndex < song.barCount; barIndex++) {\r\n\t\t\t\tconst pattern: Pattern | null = song.getPattern(channelIndex, barIndex);\r\n\t\t\t\tif (pattern != null) {\r\n\t\t\t\t\tfor (const note of pattern.notes) {\r\n\t\t\t\t\t\tconst prevPin: NotePin = note.pins[0];\r\n\t\t\t\t\t\tfor (let pinIndex: number = 1; pinIndex < note.pins.length; pinIndex++) {\r\n\t\t\t\t\t\t\tconst nextPin: NotePin = note.pins[pinIndex];\r\n\t\t\t\t\t\t\tif (prevPin.interval == nextPin.interval) {\r\n\t\t\t\t\t\t\t\tlet weight: number = nextPin.time - prevPin.time;\r\n\t\t\t\t\t\t\t\tweight += Math.max(0, Math.min(Config.partsPerBeat, nextPin.time + note.start) - (prevPin.time + note.start));\r\n\t\t\t\t\t\t\t\tweight *= nextPin.size + prevPin.size;\r\n\t\t\t\t\t\t\t\tfor (const pitch of note.pitches) {\r\n\t\t\t\t\t\t\t\t\tconst key = (basePitch + prevPin.interval + pitch) % 12;\r\n\t\t\t\t\t\t\t\t\tkeyWeights[key] += weight;\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tlet bestKey: number = 0;\r\n\t\tlet bestKeyWeight: number = 0;\r\n\t\tfor (let key: number = 0; key < 12; key++) {\r\n\t\t\t// Look for the root of the most prominent major or minor chord.\r\n\t\t\tconst keyWeight: number = keyWeights[key] * (3 * keyWeights[(key + 7) % 12] + keyWeights[(key + 4) % 12] + keyWeights[(key + 3) % 12]);\r\n\t\t\tif (bestKeyWeight < keyWeight) {\r\n\t\t\t\tbestKeyWeight = keyWeight;\r\n\t\t\t\tbestKey = key;\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tif (bestKey != song.key) {\r\n\t\t\tconst diff: number = song.key - bestKey;\r\n\t\t\tconst absoluteDiff: number = Math.abs(diff);\r\n\t\t\t\r\n\t\t\tfor (let channelIndex: number = 0; channelIndex < song.pitchChannelCount; channelIndex++) {\r\n\t\t\t\tfor (const pattern of song.channels[channelIndex].patterns) {\r\n\t\t\t\t\tfor (let i: number = 0; i < absoluteDiff; i++) {\r\n\t\t\t\t\t\tthis.append(new ChangeTranspose(doc, channelIndex, pattern, diff > 0, true));\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tsong.key = bestKey;\r\n\t\t\tdoc.notifier.changed();\r\n\t\t\tthis._didSomething();\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport function pickRandomPresetValue(isNoise: boolean): number {\r\n\tconst eligiblePresetValues: number[] = [];\r\n\tfor (let categoryIndex: number = 0; categoryIndex < EditorConfig.presetCategories.length; categoryIndex++) {\r\n\t\tconst category: PresetCategory = EditorConfig.presetCategories[categoryIndex];\r\n\t\tif (category.name == \"Novelty Presets\") continue;\r\n\t\tfor (let presetIndex: number = 0; presetIndex < category.presets.length; presetIndex++) {\r\n\t\t\tconst preset: Preset = category.presets[presetIndex];\r\n\t\t\tif (preset.settings != undefined && (preset.isNoise == true) == isNoise) {\r\n\t\t\t\teligiblePresetValues.push((categoryIndex << 6) + presetIndex);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\treturn eligiblePresetValues[(Math.random() * eligiblePresetValues.length)|0];\r\n}\r\n\r\nexport function setDefaultInstruments(song: Song): void {\r\n\tfor (let channelIndex: number = 0; channelIndex < song.channels.length; channelIndex++) {\r\n\t\tfor (const instrument of song.channels[channelIndex].instruments) {\r\n\t\t\tconst isNoise: boolean = song.getChannelIsNoise(channelIndex);\r\n\t\t\tconst presetValue: number = (channelIndex == song.pitchChannelCount) ? EditorConfig.nameToPresetValue(Math.random() > 0.5 ? \"chip noise\" : \"standard drumset\")! : pickRandomPresetValue(isNoise);\r\n\t\t\tconst preset: Preset = EditorConfig.valueToPreset(presetValue)!;\r\n\t\t\tinstrument.fromJsonObject(preset.settings, isNoise, 1);\r\n\t\t\tinstrument.preset = presetValue;\r\n\t\t\tinstrument.volume = 1;\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport class ChangeSong extends ChangeGroup {\r\n\tconstructor(doc: SongDocument, newHash: string) {\r\n\t\tsuper();\r\n\t\tdoc.song.fromBase64String(newHash);\r\n\t\tif (newHash == \"\") {\r\n\t\t\tthis.append(new ChangePatternSelection(doc, 0, 0));\r\n\t\t\tdoc.selection.resetBoxSelection();\r\n\t\t\tsetDefaultInstruments(doc.song);\r\n\t\t\tdoc.song.scale = doc.prefs.defaultScale;\r\n\t\t\t\r\n\t\t\tfor (let i: number = 0; i <= doc.song.channels.length; i++) {\r\n\t\t\t\tdoc.viewedInstrument[i] = 0;\r\n\t\t\t\tdoc.recentPatternInstruments[i] = [0];\r\n\t\t\t}\r\n\t\t\tdoc.viewedInstrument.length = doc.song.channels.length;\r\n\t\t} else {\r\n\t\t\tthis.append(new ChangeValidateTrackSelection(doc));\r\n\t\t}\r\n\t\tdoc.notifier.changed();\r\n\t\tthis._didSomething();\r\n\t}\r\n}\r\n\r\nexport class ChangeValidateTrackSelection extends Change {\r\n\tconstructor(doc: SongDocument) {\r\n\t\tsuper();\r\n\t\tconst channelIndex: number = Math.min(doc.channel, doc.song.getChannelCount() - 1);\r\n\t\tconst bar: number = Math.max(0, Math.min(doc.song.barCount - 1, doc.bar));\r\n\t\tif (doc.channel != channelIndex || doc.bar != bar) {\r\n\t\t\tdoc.bar = bar;\r\n\t\t\tdoc.channel = channelIndex;\r\n\t\t\tthis._didSomething();\r\n\t\t}\r\n\t\tdoc.selection.scrollToSelectedPattern();\r\n\t\tdoc.notifier.changed();\r\n\t}\r\n}\r\n\r\nexport class ChangeReplacePatterns extends ChangeGroup {\r\n\tconstructor(doc: SongDocument, pitchChannels: Channel[], noiseChannels: Channel[]) {\r\n\t\tsuper();\r\n\t\t\r\n\t\tconst song: Song = doc.song;\r\n\t\t\r\n\t\tfunction removeExtraSparseChannels(channels: Channel[], maxLength: number): void {\r\n\t\t\twhile (channels.length > maxLength) {\r\n\t\t\t\tlet sparsestIndex: number = channels.length - 1;\r\n\t\t\t\tlet mostZeroes: number = 0;\r\n\t\t\t\tfor (let channelIndex: number = 0; channelIndex < channels.length - 1; channelIndex++) {\r\n\t\t\t\t\tlet zeroes: number = 0;\r\n\t\t\t\t\tfor (const bar of channels[channelIndex].bars) {\r\n\t\t\t\t\t\tif (bar == 0) zeroes++;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (zeroes >= mostZeroes) {\r\n\t\t\t\t\t\tsparsestIndex = channelIndex;\r\n\t\t\t\t\t\tmostZeroes = zeroes;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tchannels.splice(sparsestIndex, 1);\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tremoveExtraSparseChannels(pitchChannels, Config.pitchChannelCountMax);\r\n\t\tremoveExtraSparseChannels(noiseChannels, Config.noiseChannelCountMax);\r\n\t\t\r\n\t\twhile (pitchChannels.length < Config.pitchChannelCountMin) pitchChannels.push(new Channel());\r\n\t\twhile (noiseChannels.length < Config.noiseChannelCountMin) noiseChannels.push(new Channel());\r\n\t\t\r\n\t\t// Set minimum counts.\r\n\t\tsong.barCount = 1;\r\n\t\tsong.patternsPerChannel = 8;\r\n\t\tconst combinedChannels: Channel[] = pitchChannels.concat(noiseChannels);\r\n\t\tfor (let channelIndex: number = 0; channelIndex < combinedChannels.length; channelIndex++) {\r\n\t\t\tconst channel: Channel = combinedChannels[channelIndex];\r\n\t\t\tsong.barCount = Math.max(song.barCount, channel.bars.length);\r\n\t\t\tsong.patternsPerChannel = Math.max(song.patternsPerChannel, channel.patterns.length);\r\n\t\t\tsong.channels[channelIndex] = channel;\r\n\t\t}\r\n\t\tsong.channels.length = combinedChannels.length;\r\n\t\tsong.pitchChannelCount = pitchChannels.length;\r\n\t\tsong.noiseChannelCount = noiseChannels.length;\r\n\t\t\r\n\t\tsong.barCount = Math.min(Config.barCountMax, song.barCount);\r\n\t\tsong.patternsPerChannel = Math.min(Config.barCountMax, song.patternsPerChannel);\r\n\t\tfor (let channelIndex: number = 0; channelIndex < song.channels.length; channelIndex++) {\r\n\t\t\tconst channel: Channel = song.channels[channelIndex];\r\n\t\t\t\r\n\t\t\tfor (let barIndex: number = 0; barIndex < channel.bars.length; barIndex++) {\r\n\t\t\t\tif (channel.bars[barIndex] > song.patternsPerChannel || channel.bars[barIndex] < 0) {\r\n\t\t\t\t\tchannel.bars[barIndex] = 0;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\twhile (channel.bars.length < song.barCount) {\r\n\t\t\t\tchannel.bars.push(0);\r\n\t\t\t}\r\n\t\t\tchannel.bars.length = song.barCount;\r\n\t\t\t\r\n\t\t\tif (channel.instruments.length > song.getMaxInstrumentsPerChannel()) {\r\n\t\t\t\tchannel.instruments.length = song.getMaxInstrumentsPerChannel();\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tfor (const pattern of channel.patterns) {\r\n\t\t\t\tdiscardInvalidPatternInstruments(pattern.instruments, song, channelIndex);\r\n\t\t\t}\r\n\t\t\twhile (channel.patterns.length < song.patternsPerChannel) {\r\n\t\t\t\tchannel.patterns.push(new Pattern());\r\n\t\t\t}\r\n\t\t\tchannel.patterns.length = song.patternsPerChannel;\r\n\t\t}\r\n\t\t\r\n\t\tsong.loopStart = Math.max(0, Math.min(song.barCount - 1, song.loopStart));\r\n\t\tsong.loopLength = Math.min(song.barCount - song.loopStart, song.loopLength);\r\n\t\t\r\n\t\tthis.append(new ChangeValidateTrackSelection(doc));\r\n\t\tdoc.notifier.changed();\r\n\t\tthis._didSomething();\r\n\t}\r\n}\r\n\r\nexport function comparePatternNotes(a: Note[], b: Note[]): boolean {\r\n\tif (a.length != b.length) return false;\r\n\t\r\n\tfor (let noteIndex: number = 0; noteIndex < a.length; noteIndex++) {\r\n\t\tconst oldNote: Note = a[noteIndex];\r\n\t\tconst newNote: Note = b[noteIndex];\r\n\t\tif (newNote.start != oldNote.start || newNote.end != oldNote.end || newNote.pitches.length != oldNote.pitches.length || newNote.pins.length != oldNote.pins.length) {\r\n\t\t\treturn false;\r\n\t\t}\r\n\t\t\r\n\t\tfor (let pitchIndex: number = 0; pitchIndex < oldNote.pitches.length; pitchIndex++) {\r\n\t\t\tif (newNote.pitches[pitchIndex] != oldNote.pitches[pitchIndex]) {\r\n\t\t\t\treturn false;\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tfor (let pinIndex: number = 0; pinIndex < oldNote.pins.length; pinIndex++) {\r\n\t\t\tif (newNote.pins[pinIndex].interval != oldNote.pins[pinIndex].interval || newNote.pins[pinIndex].time != oldNote.pins[pinIndex].time || newNote.pins[pinIndex].size != oldNote.pins[pinIndex].size) {\r\n\t\t\t\treturn false;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\t\r\n\treturn true;\r\n}\r\n\r\nexport function removeDuplicatePatterns(channels: Channel[]): void {\r\n\tfor (const channel of channels) {\r\n\t\tconst newPatterns: Pattern[] = [];\r\n\t\tfor (let bar: number = 0; bar < channel.bars.length; bar++) {\r\n\t\t\tif (channel.bars[bar] == 0) continue;\r\n\t\t\t\r\n\t\t\tconst oldPattern: Pattern = channel.patterns[channel.bars[bar] - 1];\r\n\t\t\t\r\n\t\t\tlet foundMatchingPattern: boolean = false;\r\n\t\t\tfor (let newPatternIndex: number = 0; newPatternIndex < newPatterns.length; newPatternIndex++) {\r\n\t\t\t\tconst newPattern: Pattern = newPatterns[newPatternIndex];\r\n\t\t\t\t\r\n\t\t\t\tif (!patternsContainSameInstruments(oldPattern.instruments, newPattern.instruments) || newPattern.notes.length != oldPattern.notes.length) {\r\n\t\t\t\t\tcontinue;\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tif (comparePatternNotes(oldPattern.notes, newPattern.notes)) {\r\n\t\t\t\t\tfoundMatchingPattern = true;\r\n\t\t\t\t\tchannel.bars[bar] = newPatternIndex + 1;\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tif (!foundMatchingPattern) {\r\n\t\t\t\tnewPatterns.push(oldPattern);\r\n\t\t\t\tchannel.bars[bar] = newPatterns.length;\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tfor (let patternIndex: number = 0; patternIndex < newPatterns.length; patternIndex++) {\r\n\t\t\tchannel.patterns[patternIndex] = newPatterns[patternIndex];\r\n\t\t}\r\n\t\tchannel.patterns.length = newPatterns.length;\r\n\t}\r\n}\r\n\r\nexport class ChangeTempo extends Change {\r\n\tconstructor(doc: SongDocument, oldValue: number, newValue: number) {\r\n\t\tsuper();\r\n\t\tdoc.song.tempo = Math.max(Config.tempoMin, Math.min(Config.tempoMax, Math.round(newValue)));\r\n\t\tdoc.notifier.changed();\r\n\t\tif (oldValue != newValue) this._didSomething();\r\n\t}\r\n}\r\n\r\nexport class ChangeEchoDelay extends ChangeInstrumentSlider {\r\n\tconstructor(doc: SongDocument, oldValue: number, newValue: number) {\r\n\t\tsuper(doc);\r\n\t\tthis._instrument.echoDelay = newValue;\r\n\t\tdoc.notifier.changed();\r\n\t\tif (oldValue != newValue) this._didSomething();\r\n\t}\r\n}\r\n\r\nexport class ChangeEchoSustain extends ChangeInstrumentSlider {\r\n\tconstructor(doc: SongDocument, oldValue: number, newValue: number) {\r\n\t\tsuper(doc);\r\n\t\tthis._instrument.echoSustain = newValue;\r\n\t\tdoc.notifier.changed();\r\n\t\tif (oldValue != newValue) this._didSomething();\r\n\t}\r\n}\r\n\r\nexport class ChangeChorus extends ChangeInstrumentSlider {\r\n\tconstructor(doc: SongDocument, oldValue: number, newValue: number) {\r\n\t\tsuper(doc);\r\n\t\tthis._instrument.chorus = newValue;\r\n\t\tdoc.notifier.changed();\r\n\t\tif (oldValue != newValue) this._didSomething();\r\n\t}\r\n}\r\n\r\nexport class ChangeReverb extends ChangeInstrumentSlider {\r\n\tconstructor(doc: SongDocument, oldValue: number, newValue: number) {\r\n\t\tsuper(doc);\r\n\t\tthis._instrument.reverb = newValue;\r\n\t\tdoc.notifier.changed();\r\n\t\tif (oldValue != newValue) this._didSomething();\r\n\t}\r\n}\r\n\r\nexport class ChangeNoteAdded extends UndoableChange {\r\n\tprivate _doc: SongDocument;\r\n\tprivate _pattern: Pattern;\r\n\tprivate _note: Note;\r\n\tprivate _index: number;\r\n\tconstructor(doc: SongDocument, pattern: Pattern, note: Note, index: number, deletion: boolean = false) {\r\n\t\tsuper(deletion);\r\n\t\tthis._doc = doc;\r\n\t\tthis._pattern = pattern;\r\n\t\tthis._note = note;\r\n\t\tthis._index = index;\r\n\t\tthis._didSomething();\r\n\t\tthis.redo();\r\n\t}\r\n\t\r\n\tprotected _doForwards(): void {\r\n\t\tthis._pattern.notes.splice(this._index, 0, this._note);\r\n\t\tthis._doc.notifier.changed();\r\n\t}\r\n\t\r\n\tprotected _doBackwards(): void {\r\n\t\tthis._pattern.notes.splice(this._index, 1);\r\n\t\tthis._doc.notifier.changed();\r\n\t}\r\n}\r\n\r\nexport class ChangeNoteLength extends ChangePins {\r\n\tconstructor(doc: SongDocument | null, note: Note, truncStart: number, truncEnd: number) {\r\n\t\tsuper(doc, note);\r\n\t\tconst continuesLastPattern: boolean = ((this._oldStart < 0 || note.continuesLastPattern) && truncStart == 0);\r\n\t\t\r\n\t\ttruncStart -= this._oldStart;\r\n\t\ttruncEnd   -= this._oldStart;\r\n\t\tlet setStart: boolean = false;\r\n\t\tlet prevSize: number = this._oldPins[0].size;\r\n\t\tlet prevInterval: number = this._oldPins[0].interval;\r\n\t\tlet pushLastPin: boolean = true;\r\n\t\tlet i: number;\r\n\t\tfor (i = 0; i < this._oldPins.length; i++) {\r\n\t\t\tconst oldPin: NotePin = this._oldPins[i];\r\n\t\t\tif (oldPin.time < truncStart) {\r\n\t\t\t\tprevSize = oldPin.size;\r\n\t\t\t\tprevInterval = oldPin.interval;\r\n\t\t\t} else {\r\n\t\t\t\tif (oldPin.time > truncStart && !setStart) {\r\n\t\t\t\t\tthis._newPins.push(makeNotePin(prevInterval, truncStart, prevSize));\r\n\t\t\t\t\tsetStart = true;\r\n\t\t\t\t}\r\n\t\t\t\tif (oldPin.time <= truncEnd) {\r\n\t\t\t\t\tthis._newPins.push(makeNotePin(oldPin.interval, oldPin.time, oldPin.size));\r\n\t\t\t\t\tif (oldPin.time == truncEnd) {\r\n\t\t\t\t\t\tpushLastPin = false;\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t\r\n\t\t}\r\n\t\t\r\n\t\tif (pushLastPin) this._newPins.push(makeNotePin(this._oldPins[i].interval, truncEnd, this._oldPins[i].size));\r\n\t\t\r\n\t\tthis._finishSetup(continuesLastPattern);\r\n\t}\r\n}\r\n\r\nexport class ChangeNoteTruncate extends ChangeSequence {\r\n\tconstructor(doc: SongDocument, pattern: Pattern, start: number, end: number, skipNote?: Note) {\r\n\t\tsuper();\r\n\t\tlet i: number = 0;\r\n\t\twhile (i < pattern.notes.length) {\r\n\t\t\tconst note: Note = pattern.notes[i];\r\n\t\t\tif (note == skipNote && skipNote != undefined) {\r\n\t\t\t\ti++;\r\n\t\t\t} else if (note.end <= start) {\r\n\t\t\t\ti++;\r\n\t\t\t} else if (note.start >= end) {\r\n\t\t\t\tbreak;\r\n\t\t\t} else if (note.start < start && note.end > end) {\r\n\t\t\t\tconst copy: Note = note.clone();\r\n\t\t\t\tthis.append(new ChangeNoteLength(doc, note, note.start, start));\r\n\t\t\t\ti++;\r\n\t\t\t\tthis.append(new ChangeNoteAdded(doc, pattern, copy, i, false));\r\n\t\t\t\tthis.append(new ChangeNoteLength(doc, copy, end, copy.end));\r\n\t\t\t\ti++;\r\n\t\t\t} else if (note.start < start) {\r\n\t\t\t\tthis.append(new ChangeNoteLength(doc, note, note.start, start));\r\n\t\t\t\ti++;\r\n\t\t\t} else if (note.end > end) {\r\n\t\t\t\tthis.append(new ChangeNoteLength(doc, note, end, note.end));\r\n\t\t\t\ti++;\r\n\t\t\t} else {\r\n\t\t\t\tthis.append(new ChangeNoteAdded(doc, pattern, note, i, true));\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n\r\nclass ChangeSplitNotesAtSelection extends ChangeSequence {\r\n\tconstructor(doc: SongDocument, pattern: Pattern) {\r\n\t\tsuper();\r\n\t\tlet i: number = 0;\r\n\t\twhile (i < pattern.notes.length) {\r\n\t\t\tconst note: Note = pattern.notes[i];\r\n\t\t\tif (note.start < doc.selection.patternSelectionStart && doc.selection.patternSelectionStart < note.end) {\r\n\t\t\t\tconst copy: Note = note.clone();\r\n\t\t\t\tthis.append(new ChangeNoteLength(doc, note, note.start, doc.selection.patternSelectionStart));\r\n\t\t\t\ti++;\r\n\t\t\t\tthis.append(new ChangeNoteAdded(doc, pattern, copy, i, false));\r\n\t\t\t\tthis.append(new ChangeNoteLength(doc, copy, doc.selection.patternSelectionStart, copy.end));\r\n\t\t\t\t// i++; // The second note might be split again at the end of the selection. Check it again.\r\n\t\t\t} else if (note.start < doc.selection.patternSelectionEnd && doc.selection.patternSelectionEnd < note.end) {\r\n\t\t\t\tconst copy: Note = note.clone();\r\n\t\t\t\tthis.append(new ChangeNoteLength(doc, note, note.start, doc.selection.patternSelectionEnd));\r\n\t\t\t\ti++;\r\n\t\t\t\tthis.append(new ChangeNoteAdded(doc, pattern, copy, i, false));\r\n\t\t\t\tthis.append(new ChangeNoteLength(doc, copy, doc.selection.patternSelectionEnd, copy.end));\r\n\t\t\t\ti++;\r\n\t\t\t} else {\r\n\t\t\t\ti++;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n\r\nclass ChangeTransposeNote extends UndoableChange {\r\n\tprotected _doc: SongDocument;\r\n\tprotected _note: Note;\r\n\tprotected _oldStart: number;\r\n\tprotected _newStart: number;\r\n\tprotected _oldEnd: number;\r\n\tprotected _newEnd: number;\r\n\tprotected _oldPins: NotePin[];\r\n\tprotected _newPins: NotePin[];\r\n\tprotected _oldPitches: number[];\r\n\tprotected _newPitches: number[];\r\n\tconstructor(doc: SongDocument, channelIndex: number, note: Note, upward: boolean, ignoreScale: boolean = false, octave: boolean = false) {\r\n\t\tsuper(false);\r\n\t\tthis._doc = doc;\r\n\t\tthis._note = note;\r\n\t\tthis._oldPins = note.pins;\r\n\t\tthis._newPins = [];\r\n\t\tthis._oldPitches = note.pitches;\r\n\t\tthis._newPitches = [];\r\n\t\t\r\n\t\t// I'm disabling pitch transposing for noise channels to avoid\r\n\t\t// accidentally messing up noise channels when pitch shifting all\r\n\t\t// channels at once.\r\n\t\tconst isNoise: boolean = doc.song.getChannelIsNoise(channelIndex);\r\n\t\tif (isNoise != doc.song.getChannelIsNoise(doc.channel)) return;\r\n\t\t\r\n\t\tconst maxPitch: number = (isNoise ? Config.drumCount - 1 : Config.maxPitch);\r\n\t\t\r\n\t\tfor (let i: number = 0; i < this._oldPitches.length; i++) {\r\n\t\t\tlet pitch: number = this._oldPitches[i];\r\n\t\t\tif (octave && !isNoise) {\r\n\t\t\t\tif (upward) {\r\n\t\t\t\t\tpitch = Math.min(maxPitch, pitch + 12);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tpitch = Math.max(0, pitch - 12);\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\tif (upward) {\r\n\t\t\t\t\tfor (let j: number = pitch + 1; j <= maxPitch; j++) {\r\n\t\t\t\t\t\tif (isNoise || ignoreScale || Config.scales[doc.song.scale].flags[j%12]) {\r\n\t\t\t\t\t\t\tpitch = j;\r\n\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\tfor (let j: number = pitch - 1; j >= 0; j--) {\r\n\t\t\t\t\t\tif (isNoise || ignoreScale || Config.scales[doc.song.scale].flags[j%12]) {\r\n\t\t\t\t\t\t\tpitch = j;\r\n\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tlet foundMatch: boolean = false;\r\n\t\t\tfor (let j: number = 0; j < this._newPitches.length; j++) {\r\n\t\t\t\tif (this._newPitches[j] == pitch) {\r\n\t\t\t\t\tfoundMatch = true;\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tif (!foundMatch) this._newPitches.push(pitch);\r\n\t\t}\r\n\t\t\r\n\t\tlet min: number = 0;\r\n\t\tlet max: number = maxPitch;\r\n\t\t\r\n\t\tfor (let i: number = 1; i < this._newPitches.length; i++) {\r\n\t\t\tconst diff: number = this._newPitches[0] - this._newPitches[i];\r\n\t\t\tif (min < diff) min = diff;\r\n\t\t\tif (max > diff + maxPitch) max = diff + maxPitch;\r\n\t\t}\r\n\t\t\r\n\t\tfor (const oldPin of this._oldPins) {\r\n\t\t\tlet interval: number = oldPin.interval + this._oldPitches[0];\r\n\t\t\t\r\n\t\t\tif (interval < min) interval = min;\r\n\t\t\tif (interval > max) interval = max;\r\n\t\t\tif (octave && !isNoise) {\r\n\t\t\t\tif (upward) {\r\n\t\t\t\t\tinterval = Math.min(max, interval + 12);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tinterval = Math.max(min, interval - 12);\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\tif (upward) {\r\n\t\t\t\t\tfor (let i: number = interval + 1; i <= max; i++) {\r\n\t\t\t\t\t\tif (isNoise || ignoreScale || Config.scales[doc.song.scale].flags[i%12]) {\r\n\t\t\t\t\t\t\tinterval = i;\r\n\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\tfor (let i: number = interval - 1; i >= min; i--) {\r\n\t\t\t\t\t\tif (isNoise || ignoreScale || Config.scales[doc.song.scale].flags[i%12]) {\r\n\t\t\t\t\t\t\tinterval = i;\r\n\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tinterval -= this._newPitches[0];\r\n\t\t\tthis._newPins.push(makeNotePin(interval, oldPin.time, oldPin.size));\r\n\t\t}\r\n\t\t\r\n\t\tif (this._newPins[0].interval != 0) throw new Error(\"wrong pin start interval\");\r\n\t\t\r\n\t\tfor (let i: number = 1; i < this._newPins.length - 1; ) {\r\n\t\t\tif (this._newPins[i-1].interval == this._newPins[i].interval &&\r\n\t\t\t\tthis._newPins[i].interval == this._newPins[i+1].interval &&\r\n\t\t\t\tthis._newPins[i-1].size == this._newPins[i].size &&\r\n\t\t\t\tthis._newPins[i].size == this._newPins[i+1].size)\r\n\t\t\t{\r\n\t\t\t\tthis._newPins.splice(i, 1);\r\n\t\t\t} else {\r\n\t\t\t\ti++;\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tthis._doForwards();\r\n\t\tthis._didSomething();\r\n\t}\r\n\t\r\n\tprotected _doForwards(): void {\r\n\t\tthis._note.pins = this._newPins;\r\n\t\tthis._note.pitches = this._newPitches;\r\n\t\tthis._doc.notifier.changed();\r\n\t}\r\n\t\r\n\tprotected _doBackwards(): void {\r\n\t\tthis._note.pins = this._oldPins;\r\n\t\tthis._note.pitches = this._oldPitches;\r\n\t\tthis._doc.notifier.changed();\r\n\t}\r\n}\r\n\r\nexport class ChangeTranspose extends ChangeSequence {\r\n\tconstructor(doc: SongDocument, channelIndex: number, pattern: Pattern, upward: boolean, ignoreScale: boolean = false, octave: boolean = false) {\r\n\t\tsuper();\r\n\t\tif (doc.selection.patternSelectionActive) {\r\n\t\t\tthis.append(new ChangeSplitNotesAtSelection(doc, pattern));\r\n\t\t}\r\n\t\tfor (const note of pattern.notes) {\r\n\t\t\tif (doc.selection.patternSelectionActive && (note.end <= doc.selection.patternSelectionStart || note.start >= doc.selection.patternSelectionEnd)) {\r\n\t\t\t\tcontinue;\r\n\t\t\t}\r\n\t\t\tthis.append(new ChangeTransposeNote(doc, channelIndex, note, upward, ignoreScale, octave));\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport class ChangeTrackSelection extends Change {\r\n\tconstructor(doc: SongDocument, newX0: number, newX1: number, newY0: number, newY1: number) {\r\n\t\tsuper();\r\n\t\tdoc.selection.boxSelectionX0 = newX0;\r\n\t\tdoc.selection.boxSelectionX1 = newX1;\r\n\t\tdoc.selection.boxSelectionY0 = newY0;\r\n\t\tdoc.selection.boxSelectionY1 = newY1;\r\n\t\tdoc.notifier.changed();\r\n\t\tthis._didSomething();\r\n\t}\r\n}\r\n\r\nexport class ChangePatternSelection extends UndoableChange {\r\n\tprivate _doc: SongDocument;\r\n\tprivate _oldStart: number;\r\n\tprivate _oldEnd: number;\r\n\tprivate _oldActive: boolean;\r\n\tprivate _newStart: number;\r\n\tprivate _newEnd: number;\r\n\tprivate _newActive: boolean;\r\n\t\r\n\tconstructor(doc: SongDocument, newStart: number, newEnd: number) {\r\n\t\tsuper(false);\r\n\t\tthis._doc = doc;\r\n\t\tthis._oldStart = doc.selection.patternSelectionStart;\r\n\t\tthis._oldEnd = doc.selection.patternSelectionEnd;\r\n\t\tthis._oldActive = doc.selection.patternSelectionActive;\r\n\t\tthis._newStart = newStart;\r\n\t\tthis._newEnd = newEnd;\r\n\t\tthis._newActive = newStart < newEnd;\r\n\t\tthis._doForwards();\r\n\t\tthis._didSomething();\r\n\t}\r\n\t\r\n\tprotected _doForwards(): void {\r\n\t\tthis._doc.selection.patternSelectionStart = this._newStart;\r\n\t\tthis._doc.selection.patternSelectionEnd = this._newEnd;\r\n\t\tthis._doc.selection.patternSelectionActive = this._newActive;\r\n\t\tthis._doc.notifier.changed();\r\n\t}\r\n\t\r\n\tprotected _doBackwards(): void {\r\n\t\tthis._doc.selection.patternSelectionStart = this._oldStart;\r\n\t\tthis._doc.selection.patternSelectionEnd = this._oldEnd;\r\n\t\tthis._doc.selection.patternSelectionActive = this._oldActive;\r\n\t\tthis._doc.notifier.changed();\r\n\t}\r\n}\r\n\r\nexport class ChangeDragSelectedNotes extends ChangeSequence {\r\n\tconstructor(doc: SongDocument, channelIndex: number, pattern: Pattern, parts: number, transpose: number) {\r\n\t\tsuper();\r\n\t\t\r\n\t\tif (parts == 0 && transpose == 0) return;\r\n\t\tif (doc.selection.patternSelectionActive) {\r\n\t\t\tthis.append(new ChangeSplitNotesAtSelection(doc, pattern));\r\n\t\t}\r\n\t\t\r\n\t\tconst oldStart: number = doc.selection.patternSelectionStart;\r\n\t\tconst oldEnd: number = doc.selection.patternSelectionEnd;\r\n\t\tconst newStart: number = Math.max(0, Math.min(doc.song.beatsPerBar * Config.partsPerBeat, oldStart + parts));\r\n\t\tconst newEnd: number = Math.max(0, Math.min(doc.song.beatsPerBar * Config.partsPerBeat, oldEnd + parts));\r\n\t\tif (newStart == newEnd) {\r\n\t\t\t// Just erase the current contents of the selection:\r\n\t\t\tthis.append(new ChangeNoteTruncate(doc, pattern, oldStart, oldEnd));\r\n\t\t} else if (parts < 0) {\r\n\t\t\t// Clear space for the dragged notes:\r\n\t\t\tthis.append(new ChangeNoteTruncate(doc, pattern, newStart, Math.min(oldStart, newEnd)));\r\n\t\t} else {\r\n\t\t\t// Clear space for the dragged notes:\r\n\t\t\tthis.append(new ChangeNoteTruncate(doc, pattern, Math.max(oldEnd, newStart), newEnd));\r\n\t\t}\r\n\t\t\r\n\t\tthis.append(new ChangePatternSelection(doc, newStart, newEnd));\r\n\t\tconst draggedNotes = [];\r\n\t\tlet noteInsertionIndex: number = 0;\r\n\t\tlet i: number = 0;\r\n\t\twhile (i < pattern.notes.length) {\r\n\t\t\tconst note: Note = pattern.notes[i];\r\n\t\t\tif (note.end <= oldStart || note.start >= oldEnd) {\r\n\t\t\t\ti++;\r\n\t\t\t\tif (note.end <= newStart) noteInsertionIndex = i;\r\n\t\t\t} else {\r\n\t\t\t\tdraggedNotes.push(note.clone());\r\n\t\t\t\tthis.append(new ChangeNoteAdded(doc, pattern, note, i, true));\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tfor (const note of draggedNotes) {\r\n\t\t\tnote.start += parts;\r\n\t\t\tnote.end += parts;\r\n\t\t\tif (note.end <= newStart) continue;\r\n\t\t\tif (note.start >= newEnd) continue;\r\n\t\t\t\r\n\t\t\tthis.append(new ChangeNoteAdded(doc, pattern, note, noteInsertionIndex++, false));\r\n\t\t\t\r\n\t\t\tthis.append(new ChangeNoteLength(doc, note, Math.max(note.start, newStart), Math.min(newEnd, note.end)));\r\n\t\t\t\r\n\t\t\tfor (let i: number = 0; i < Math.abs(transpose); i++) {\r\n\t\t\t\tthis.append(new ChangeTransposeNote(doc, channelIndex, note, transpose > 0, doc.prefs.notesOutsideScale));\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport class ChangeDuplicateSelectedReusedPatterns extends ChangeGroup {\r\n\tconstructor(doc: SongDocument, barStart: number, barWidth: number, channelStart: number, channelHeight: number) {\r\n\t\tsuper();\r\n\t\tfor (let channelIndex: number = channelStart; channelIndex < channelStart + channelHeight; channelIndex++) {\r\n\t\t\tconst reusablePatterns: Dictionary<number> = {};\r\n\t\t\t\r\n\t\t\tfor (let bar: number = barStart; bar < barStart + barWidth; bar++) {\r\n\t\t\t\tconst currentPatternIndex: number = doc.song.channels[channelIndex].bars[bar];\r\n\t\t\t\tif (currentPatternIndex == 0) continue;\r\n\t\t\t\t\r\n\t\t\t\tif (reusablePatterns[String(currentPatternIndex)] == undefined) {\r\n\t\t\t\t\tlet isUsedElsewhere = false;\r\n\t\t\t\t\tfor (let bar2: number = 0; bar2 < doc.song.barCount; bar2++) {\r\n\t\t\t\t\t\tif (bar2 < barStart || bar2 >= barStart + barWidth) {\r\n\t\t\t\t\t\t\tif (doc.song.channels[channelIndex].bars[bar2] == currentPatternIndex) {\r\n\t\t\t\t\t\t\t\tisUsedElsewhere = true;\r\n\t\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (isUsedElsewhere) {\r\n\t\t\t\t\t\t// Need to duplicate the pattern.\r\n\t\t\t\t\t\tconst copiedPattern: Pattern = doc.song.getPattern(channelIndex, bar)!;\r\n\t\t\t\t\t\tthis.append(new ChangePatternNumbers(doc, 0, bar, channelIndex, 1, 1));\r\n\t\t\t\t\t\tthis.append(new ChangeEnsurePatternExists(doc, channelIndex, bar));\r\n\t\t\t\t\t\tconst newPattern: Pattern | null = doc.song.getPattern(channelIndex, bar);\r\n\t\t\t\t\t\tif (newPattern == null) throw new Error();\r\n\t\t\t\t\t\tthis.append(new ChangePaste(doc, newPattern, copiedPattern.notes, 0, Config.partsPerBeat * doc.song.beatsPerBar, Config.partsPerBeat * doc.song.beatsPerBar));\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t// Copy the instruments into the new pattern.\r\n\t\t\t\t\t\tnewPattern.instruments.length = 0;\r\n\t\t\t\t\t\tnewPattern.instruments.push(...copiedPattern.instruments);\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\treusablePatterns[String(currentPatternIndex)] = doc.song.channels[channelIndex].bars[bar];\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\treusablePatterns[String(currentPatternIndex)] = currentPatternIndex;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tthis.append(new ChangePatternNumbers(doc, reusablePatterns[String(currentPatternIndex)], bar, channelIndex, 1, 1));\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport class ChangePatternScale extends Change {\r\n\tconstructor(doc: SongDocument, pattern: Pattern, scaleMap: number[]) {\r\n\t\tsuper();\r\n\t\tif (doc.selection.patternSelectionActive) {\r\n\t\t\tnew ChangeSplitNotesAtSelection(doc, pattern);\r\n\t\t}\r\n\t\tconst maxPitch: number = Config.maxPitch;\r\n\t\tfor (const note of pattern.notes) {\r\n\t\t\tif (doc.selection.patternSelectionActive && (note.end <= doc.selection.patternSelectionStart || note.start >= doc.selection.patternSelectionEnd)) {\r\n\t\t\t\tcontinue;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tconst newPitches: number[] = [];\r\n\t\t\tconst newPins: NotePin[] = [];\r\n\t\t\tfor (let i: number = 0; i < note.pitches.length; i++) {\r\n\t\t\t\tconst pitch: number = note.pitches[i];\r\n\t\t\t\tconst transformedPitch: number = scaleMap[pitch % 12] + (pitch - (pitch % 12));\r\n\t\t\t\tif (newPitches.indexOf(transformedPitch) == -1) {\r\n\t\t\t\t\tnewPitches.push(transformedPitch);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tlet min: number = 0;\r\n\t\t\tlet max: number = maxPitch;\r\n\t\t\t\r\n\t\t\tfor (let i: number = 1; i < newPitches.length; i++) {\r\n\t\t\t\tconst diff: number = newPitches[0] - newPitches[i];\r\n\t\t\t\tif (min < diff) min = diff;\r\n\t\t\t\tif (max > diff + maxPitch) max = diff + maxPitch;\r\n\t\t\t}\r\n\t\t\r\n\t\t\tfor (const oldPin of note.pins) {\r\n\t\t\t\tlet interval: number = oldPin.interval + note.pitches[0];\r\n\t\t\t\tif (interval < min) interval = min;\r\n\t\t\t\tif (interval > max) interval = max;\r\n\t\t\t\tconst transformedInterval: number = scaleMap[interval % 12] + (interval - (interval % 12));\r\n\t\t\t\tnewPins.push(makeNotePin(transformedInterval - newPitches[0], oldPin.time, oldPin.size));\r\n\t\t\t}\r\n\t\t\r\n\t\t\tif (newPins[0].interval != 0) throw new Error(\"wrong pin start interval\");\r\n\t\t\r\n\t\t\tfor (let i: number = 1; i < newPins.length - 1; ) {\r\n\t\t\t\tif (newPins[i-1].interval == newPins[i].interval &&\r\n\t\t\t\t\tnewPins[i].interval == newPins[i+1].interval &&\r\n\t\t\t\t\tnewPins[i-1].size == newPins[i].size &&\r\n\t\t\t\t\tnewPins[i].size == newPins[i+1].size)\r\n\t\t\t\t{\r\n\t\t\t\t\tnewPins.splice(i, 1);\r\n\t\t\t\t} else {\r\n\t\t\t\t\ti++;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tnote.pitches = newPitches;\r\n\t\t\tnote.pins = newPins;\r\n\t\t}\r\n\t\tthis._didSomething();\r\n\t\tdoc.notifier.changed();\r\n\t}\r\n}\r\n\r\nexport class ChangeVolume extends Change {\r\n\tconstructor(doc: SongDocument, oldValue: number, newValue: number) {\r\n\t\tsuper();\r\n\t\tdoc.song.channels[doc.channel].instruments[doc.getCurrentInstrument()].volume = newValue;\r\n\t\tdoc.notifier.changed();\r\n\t\tif (oldValue != newValue) this._didSomething();\r\n\t}\r\n}\r\n\r\nexport class ChangePan extends Change {\r\n\tconstructor(doc: SongDocument, oldValue: number, newValue: number) {\r\n\t\tsuper();\r\n\t\tdoc.song.channels[doc.channel].instruments[doc.getCurrentInstrument()].pan = newValue;\r\n\t\tdoc.notifier.changed();\r\n\t\tif (oldValue != newValue) this._didSomething();\r\n\t}\r\n}\r\n\r\nexport class ChangeSizeBend extends UndoableChange {\r\n\tprivate _doc: SongDocument;\r\n\tprivate _note: Note;\r\n\tprivate _oldPins: NotePin[];\r\n\tprivate _newPins: NotePin[];\r\n\tconstructor(doc: SongDocument, note: Note, bendPart: number, bendSize: number, bendInterval: number, uniformSize: boolean) {\r\n\t\tsuper(false);\r\n\t\tthis._doc = doc;\r\n\t\tthis._note = note;\r\n\t\tthis._oldPins = note.pins;\r\n\t\tthis._newPins = [];\r\n\t\t\r\n\t\tlet inserted: boolean = false;\r\n\t\t\r\n\t\tfor (const pin of note.pins) {\r\n\t\t\tif (pin.time < bendPart) {\r\n\t\t\t\tif (uniformSize) {\r\n\t\t\t\t\tthis._newPins.push(makeNotePin(pin.interval, pin.time, bendSize));\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis._newPins.push(pin);\r\n\t\t\t\t}\r\n\t\t\t} else if (pin.time == bendPart) {\r\n\t\t\t\tthis._newPins.push(makeNotePin(bendInterval, bendPart, bendSize));\r\n\t\t\t\tinserted = true;\r\n\t\t\t} else {\r\n\t\t\t\tif (!uniformSize && !inserted) {\r\n\t\t\t\t\tthis._newPins.push(makeNotePin(bendInterval, bendPart, bendSize));\r\n\t\t\t\t\tinserted = true;\r\n\t\t\t\t}\r\n\t\t\t\tif (uniformSize) {\r\n\t\t\t\t\tthis._newPins.push(makeNotePin(pin.interval, pin.time, bendSize));\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis._newPins.push(pin);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tremoveRedundantPins(this._newPins);\r\n\t\t\r\n\t\tthis._doForwards();\r\n\t\tthis._didSomething();\r\n\t}\r\n\t\r\n\tprotected _doForwards(): void {\r\n\t\tthis._note.pins = this._newPins;\r\n\t\tthis._doc.notifier.changed();\r\n\t}\r\n\t\r\n\tprotected _doBackwards(): void {\r\n\t\tthis._note.pins = this._oldPins;\r\n\t\tthis._doc.notifier.changed();\r\n\t}\r\n}\r\n\r\nexport class ChangeChipWave extends Change {\r\n\tconstructor(doc: SongDocument, newValue: number) {\r\n\t\tsuper();\r\n\t\tconst instrument: Instrument = doc.song.channels[doc.channel].instruments[doc.getCurrentInstrument()];\r\n\t\tif (instrument.chipWave != newValue) {\r\n\t\t\tinstrument.chipWave = newValue;\r\n\t\t\tinstrument.preset = instrument.type;\r\n\t\t\tdoc.notifier.changed();\r\n\t\t\tthis._didSomething();\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport class ChangeNoiseWave extends Change {\r\n\tconstructor(doc: SongDocument, newValue: number) {\r\n\t\tsuper();\r\n\t\tconst instrument: Instrument = doc.song.channels[doc.channel].instruments[doc.getCurrentInstrument()];\r\n\t\tif (instrument.chipNoise != newValue) {\r\n\t\t\tinstrument.chipNoise = newValue;\r\n\t\t\tinstrument.preset = instrument.type;\r\n\t\t\tdoc.notifier.changed();\r\n\t\t\tthis._didSomething();\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport class ChangeAddEnvelope extends Change {\r\n\tconstructor(doc: SongDocument) {\r\n\t\tsuper();\r\n\t\tconst instrument: Instrument = doc.song.channels[doc.channel].instruments[doc.getCurrentInstrument()];\r\n\t\tinstrument.addEnvelope(0,0,0);\r\n\t\tinstrument.preset = instrument.type;\r\n\t\tdoc.notifier.changed();\r\n\t\tthis._didSomething();\r\n\t}\r\n}\r\n\r\nexport class ChangeRemoveEnvelope extends Change {\r\n\tconstructor(doc: SongDocument, index: number) {\r\n\t\tsuper();\r\n\t\tconst instrument: Instrument = doc.song.channels[doc.channel].instruments[doc.getCurrentInstrument()];\r\n\t\tinstrument.envelopeCount--;\r\n\t\tfor (let i: number = index; i < instrument.envelopeCount; i++) {\r\n\t\t\tinstrument.envelopes[i].target   = instrument.envelopes[i+1].target;\r\n\t\t\tinstrument.envelopes[i].index    = instrument.envelopes[i+1].index;\r\n\t\t\tinstrument.envelopes[i].envelope = instrument.envelopes[i+1].envelope;\r\n\t\t}\r\n\t\t// TODO: Shift any envelopes that were targeting other envelope indices after the removed one.\r\n\t\tinstrument.preset = instrument.type;\r\n\t\tdoc.notifier.changed();\r\n\t\tthis._didSomething();\r\n\t}\r\n}\r\n\r\nexport class ChangeSetEnvelopeTarget extends Change {\r\n\tconstructor(doc: SongDocument, envelopeIndex: number, target: number, targetIndex: number) {\r\n\t\tsuper();\r\n\t\tconst instrument: Instrument = doc.song.channels[doc.channel].instruments[doc.getCurrentInstrument()];\r\n\t\tconst oldTarget: number = instrument.envelopes[envelopeIndex].target;\r\n\t\tconst oldIndex: number = instrument.envelopes[envelopeIndex].index;\r\n\t\tif (oldTarget != target || oldIndex != targetIndex) {\r\n\t\t\tinstrument.envelopes[envelopeIndex].target = target;\r\n\t\t\tinstrument.envelopes[envelopeIndex].index = targetIndex;\r\n\t\t\tinstrument.preset = instrument.type;\r\n\t\t\tdoc.notifier.changed();\r\n\t\t\tthis._didSomething();\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport class ChangeSetEnvelopeType extends Change {\r\n\tconstructor(doc: SongDocument, envelopeIndex: number, newValue: number) {\r\n\t\tsuper();\r\n\t\tconst instrument: Instrument = doc.song.channels[doc.channel].instruments[doc.getCurrentInstrument()];\r\n\t\tconst oldValue: number = instrument.envelopes[envelopeIndex].envelope;\r\n\t\tif (oldValue != newValue) {\r\n\t\t\tinstrument.envelopes[envelopeIndex].envelope = newValue;\r\n\t\t\tinstrument.preset = instrument.type;\r\n\t\t\tdoc.notifier.changed();\r\n\t\t\tthis._didSomething();\r\n\t\t}\r\n\t}\r\n}\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nimport {Chord, Transition, Config} from \"../synth/SynthConfig\";\r\nimport {NotePin, Note, makeNotePin, Pattern, Instrument} from \"../synth/synth\";\r\nimport {ColorConfig} from \"./ColorConfig\";\r\nimport {SongDocument} from \"./SongDocument\";\r\nimport {HTML, SVG} from \"imperative-html/dist/esm/elements-strict\";\r\nimport {ChangeSequence, UndoableChange} from \"./Change\";\r\nimport {ChangeChannelBar, ChangeDragSelectedNotes, ChangeEnsurePatternExists, ChangeNoteTruncate, ChangeNoteAdded, ChangePatternSelection, ChangePinTime, ChangeSizeBend, ChangePitchBend, ChangePitchAdded} from \"./changes\";\r\nimport {prettyNumber} from \"./EditorConfig\";\r\n\r\nfunction makeEmptyReplacementElement<T extends Node>(node: T): T {\r\n\tconst clone: T = <T> node.cloneNode(false);\r\n\tnode.parentNode!.replaceChild(clone, node);\r\n\treturn clone;\r\n}\r\n\r\nclass PatternCursor {\r\n\tpublic valid:        boolean = false;\r\n\tpublic prevNote:     Note | null = null;\r\n\tpublic curNote:      Note | null = null;\r\n\tpublic nextNote:     Note | null = null;\r\n\tpublic pitch:        number = 0;\r\n\tpublic pitchIndex:   number = -1;\r\n\tpublic curIndex:     number = 0;\r\n\tpublic start:        number = 0;\r\n\tpublic end:          number = 0;\r\n\tpublic part:         number = 0;\r\n\tpublic exactPart:    number = 0;\r\n\tpublic nearPinIndex: number = 0;\r\n\tpublic pins:         NotePin[] = [];\r\n}\r\n\r\nexport class PatternEditor {\r\n\tprivate readonly _svgNoteBackground: SVGPatternElement = SVG.pattern({id: \"patternEditorNoteBackground\" + this._barOffset, x: \"0\", y: \"0\", patternUnits: \"userSpaceOnUse\"});\r\n\tprivate readonly _svgDrumBackground: SVGPatternElement = SVG.pattern({id: \"patternEditorDrumBackground\" + this._barOffset, x: \"0\", y: \"0\", patternUnits: \"userSpaceOnUse\"});\r\n\tprivate readonly _svgBackground: SVGRectElement = SVG.rect({x: \"0\", y: \"0\", \"pointer-events\": \"none\", fill: \"url(#patternEditorNoteBackground\" + this._barOffset + \")\"});\r\n\tprivate _svgNoteContainer: SVGSVGElement = SVG.svg();\r\n\tprivate readonly _svgPlayhead: SVGRectElement = SVG.rect({x: \"0\", y: \"0\", width: \"4\", fill: ColorConfig.playhead, \"pointer-events\": \"none\"});\r\n\tprivate readonly _selectionRect: SVGRectElement = SVG.rect({fill: ColorConfig.boxSelectionFill, stroke: ColorConfig.hoverPreview, \"stroke-width\": 2, \"stroke-dasharray\": \"5, 3\", \"pointer-events\": \"none\", visibility: \"hidden\"});\r\n\tprivate readonly _svgPreview: SVGPathElement = SVG.path({fill: \"none\", stroke: ColorConfig.hoverPreview, \"stroke-width\": \"2\", \"pointer-events\": \"none\"});\r\n\tprivate readonly _svg: SVGSVGElement = SVG.svg({style: `background-color: ${ColorConfig.editorBackground}; touch-action: none; position: absolute;`, width: \"100%\", height: \"100%\"},\r\n\t\tSVG.defs(\r\n\t\t\tthis._svgNoteBackground,\r\n\t\t\tthis._svgDrumBackground,\r\n\t\t),\r\n\t\tthis._svgBackground,\r\n\t\tthis._selectionRect,\r\n\t\tthis._svgNoteContainer,\r\n\t\tthis._svgPreview,\r\n\t\tthis._svgPlayhead,\r\n\t);\r\n\tpublic readonly container: HTMLDivElement = HTML.div({style: \"height: 100%; overflow:hidden; position: relative; flex-grow: 1;\"}, this._svg);\r\n\t\r\n\tprivate readonly _backgroundPitchRows: SVGRectElement[] = [];\r\n\tprivate readonly _backgroundDrumRow: SVGRectElement = SVG.rect();\r\n\t\r\n\tprivate _editorWidth: number;\r\n\tprivate _editorHeight: number;\r\n\tprivate _partWidth: number;\r\n\tprivate _pitchHeight: number = -1;\r\n\tprivate _pitchCount: number;\r\n\tprivate _mouseX: number = 0;\r\n\tprivate _mouseY: number = 0;\r\n\tprivate _mouseDown: boolean = false;\r\n\tprivate _mouseOver: boolean = false;\r\n\tprivate _mouseDragging: boolean = false;\r\n\tprivate _mouseHorizontal: boolean = false;\r\n\tprivate _usingTouch: boolean = false;\r\n\tprivate _copiedPinChannels: NotePin[][] = [];\r\n\tprivate _copiedPins: NotePin[];\r\n\tprivate _mouseXStart: number = 0;\r\n\tprivate _mouseYStart: number = 0;\r\n\tprivate _ctrlHeld: boolean = false;\r\n\tprivate _shiftHeld: boolean = false;\r\n\tprivate _touchTime: number = 0;\r\n\tprivate _draggingStartOfSelection: boolean = false;\r\n\tprivate _draggingEndOfSelection: boolean = false;\r\n\tprivate _draggingSelectionContents: boolean = false;\r\n\tprivate _dragTime: number = 0;\r\n\tprivate _dragPitch: number = 0;\r\n\tprivate _dragSize: number = 0;\r\n\tprivate _dragVisible: boolean = false;\r\n\tprivate _dragChange: UndoableChange | null = null;\r\n\tprivate _changePatternSelection: UndoableChange | null = null;\r\n\tprivate _lastChangeWasPatternSelection: boolean = false;\r\n\tprivate _cursor: PatternCursor = new PatternCursor();\r\n\tprivate _pattern: Pattern | null = null;\r\n\tprivate _playheadX: number = 0.0;\r\n\tprivate _octaveOffset: number = 0;\r\n\tprivate _renderedWidth: number = -1;\r\n\tprivate _renderedHeight: number = -1;\r\n\tprivate _renderedBeatWidth: number = -1;\r\n\tprivate _renderedPitchHeight: number = -1;\r\n\tprivate _renderedFifths: boolean = false;\r\n\tprivate _renderedDrums: boolean = false;\r\n\tprivate _renderedRhythm: number = -1;\r\n\tprivate _renderedPitchChannelCount: number = -1;\r\n\tprivate _renderedNoiseChannelCount: number = -1;\r\n\tprivate _followPlayheadBar: number = -1;\r\n\t\r\n\tconstructor(private _doc: SongDocument, private _interactive: boolean, private _barOffset: number) {\r\n\t\tfor (let i: number = 0; i < Config.pitchesPerOctave; i++) {\r\n\t\t\tconst rectangle: SVGRectElement = SVG.rect();\r\n\t\t\trectangle.setAttribute(\"x\", \"1\");\r\n\t\t\trectangle.setAttribute(\"fill\", (i == 0) ? ColorConfig.tonic : ColorConfig.pitchBackground);\r\n\t\t\tthis._svgNoteBackground.appendChild(rectangle);\r\n\t\t\tthis._backgroundPitchRows[i] = rectangle;\r\n\t\t}\r\n\r\n\t\tthis._backgroundDrumRow.setAttribute(\"x\", \"1\");\r\n\t\tthis._backgroundDrumRow.setAttribute(\"y\", \"1\");\r\n\t\tthis._backgroundDrumRow.setAttribute(\"fill\", ColorConfig.pitchBackground);\r\n\t\tthis._svgDrumBackground.appendChild(this._backgroundDrumRow);\r\n\t\t\r\n\t\tif (this._interactive) {\r\n\t\t\tthis._updateCursorStatus();\r\n\t\t\tthis._updatePreview();\r\n\t\t\twindow.requestAnimationFrame(this._animatePlayhead);\r\n\t\t\tthis._svg.addEventListener(\"mousedown\", this._whenMousePressed);\r\n\t\t\tdocument.addEventListener(\"mousemove\", this._whenMouseMoved);\r\n\t\t\tdocument.addEventListener(\"mouseup\", this._whenCursorReleased);\r\n\t\t\tthis._svg.addEventListener(\"mouseover\", this._whenMouseOver);\r\n\t\t\tthis._svg.addEventListener(\"mouseout\", this._whenMouseOut);\r\n\t\t\r\n\t\t\tthis._svg.addEventListener(\"touchstart\", this._whenTouchPressed);\r\n\t\t\tthis._svg.addEventListener(\"touchmove\", this._whenTouchMoved);\r\n\t\t\tthis._svg.addEventListener(\"touchend\", this._whenCursorReleased);\r\n\t\t\tthis._svg.addEventListener(\"touchcancel\", this._whenCursorReleased);\r\n\t\t} else {\r\n\t\t\tthis._svgPlayhead.style.display = \"none\";\r\n\t\t\tthis._svg.appendChild(SVG.rect({x: 0, y: 0, width: 10000, height: 10000, fill: ColorConfig.editorBackground, style: \"opacity: 0.5;\"}));\r\n\t\t}\r\n\t\t\r\n\t\tthis.resetCopiedPins();\r\n\t}\r\n\t\r\n\tprivate _getMaxPitch(): number {\r\n\t\treturn this._doc.song.getChannelIsNoise(this._doc.channel) ? Config.drumCount - 1 : Config.maxPitch;\r\n\t}\r\n\t\r\n\tprivate _getMaxDivision(): number {\r\n\t\tconst rhythmStepsPerBeat: number = Config.rhythms[this._doc.song.rhythm].stepsPerBeat;\r\n\t\tif (rhythmStepsPerBeat % 4 == 0) {\r\n\t\t\t// Beat is divisible by 2 (and 4).\r\n\t\t\treturn Config.partsPerBeat / 2;\r\n\t\t} else if (rhythmStepsPerBeat % 3 == 0) {\r\n\t\t\t// Beat is divisible by 3.\r\n\t\t\treturn Config.partsPerBeat / 3;\r\n\t\t} else if (rhythmStepsPerBeat % 2 == 0) {\r\n\t\t\t// Beat is divisible by 2.\r\n\t\t\treturn Config.partsPerBeat / 2;\r\n\t\t}\r\n\t\treturn Config.partsPerBeat;\r\n\t}\r\n\t\r\n\tprivate _getMinDivision(): number {\r\n\t\treturn Config.partsPerBeat / Config.rhythms[this._doc.song.rhythm].stepsPerBeat;\r\n\t}\r\n\t\r\n\tprivate _snapToMinDivision(input: number): number {\r\n\t\tconst minDivision: number = this._getMinDivision();\r\n\t\treturn Math.floor(input / minDivision) * minDivision;\r\n\t}\r\n\t\r\n\tprivate _updateCursorStatus(): void {\r\n\t\tthis._cursor = new PatternCursor();\r\n\t\t\r\n\t\tif (this._mouseX < 0 || this._mouseX > this._editorWidth || this._mouseY < 0 || this._mouseY > this._editorHeight || this._pitchHeight <= 0) return;\r\n\t\t\r\n\t\tconst minDivision: number = this._getMinDivision();\r\n\t\tthis._cursor.exactPart = this._mouseX / this._partWidth;\r\n\t\tthis._cursor.part =\r\n\t\t\tMath.floor(\r\n\t\t\t\tMath.max(0,\r\n\t\t\t\t\tMath.min(this._doc.song.beatsPerBar * Config.partsPerBeat - minDivision, this._cursor.exactPart)\r\n\t\t\t\t)\r\n\t\t\t/ minDivision) * minDivision;\r\n\t\t\r\n\t\tif (this._pattern != null) {\r\n\t\t\tfor (const note of this._pattern.notes) {\r\n\t\t\t\tif (note.end <= this._cursor.exactPart) {\r\n\t\t\t\t\tthis._cursor.prevNote = note;\r\n\t\t\t\t\tthis._cursor.curIndex++;\r\n\t\t\t\t} else if (note.start <= this._cursor.exactPart && note.end > this._cursor.exactPart) {\r\n\t\t\t\t\tthis._cursor.curNote = note;\r\n\t\t\t\t} else if (note.start > this._cursor.exactPart) {\r\n\t\t\t\t\tthis._cursor.nextNote = note;\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tlet mousePitch: number = this._findMousePitch(this._mouseY);\r\n\t\t\r\n\t\tif (this._cursor.curNote != null) {\r\n\t\t\tthis._cursor.start = this._cursor.curNote.start;\r\n\t\t\tthis._cursor.end   = this._cursor.curNote.end;\r\n\t\t\tthis._cursor.pins  = this._cursor.curNote.pins;\r\n\t\t\t\r\n\t\t\tlet interval: number = 0;\r\n\t\t\tlet error: number = 0;\r\n\t\t\tlet prevPin: NotePin;\r\n\t\t\tlet nextPin: NotePin = this._cursor.curNote.pins[0];\r\n\t\t\tfor (let j: number = 1; j < this._cursor.curNote.pins.length; j++) {\r\n\t\t\t\tprevPin = nextPin;\r\n\t\t\t\tnextPin = this._cursor.curNote.pins[j];\r\n\t\t\t\tconst leftSide:    number = this._partWidth * (this._cursor.curNote.start + prevPin.time);\r\n\t\t\t\tconst rightSide:   number = this._partWidth * (this._cursor.curNote.start + nextPin.time);\r\n\t\t\t\tif (this._mouseX > rightSide) continue;\r\n\t\t\t\tif (this._mouseX < leftSide) throw new Error();\r\n\t\t\t\tconst intervalRatio: number = (this._mouseX - leftSide) / (rightSide - leftSide);\r\n\t\t\t\tconst arc: number = Math.sqrt(1.0 / Math.sqrt(4.0) - Math.pow(intervalRatio - 0.5, 2.0)) - 0.5;\r\n\t\t\t\tconst bendHeight: number = Math.abs(nextPin.interval - prevPin.interval);\r\n\t\t\t\tinterval = prevPin.interval * (1.0 - intervalRatio) + nextPin.interval * intervalRatio;\r\n\t\t\t\terror = arc * bendHeight + 0.95;\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tlet minInterval: number = Number.MAX_VALUE;\r\n\t\t\tlet maxInterval: number = -Number.MAX_VALUE;\r\n\t\t\tlet bestDistance: number = Number.MAX_VALUE;\r\n\t\t\tfor (const pin of this._cursor.curNote.pins) {\r\n\t\t\t\tif (minInterval > pin.interval) minInterval = pin.interval;\r\n\t\t\t\tif (maxInterval < pin.interval) maxInterval = pin.interval;\r\n\t\t\t\tconst pinDistance: number = Math.abs(this._cursor.curNote.start + pin.time - this._mouseX / this._partWidth);\r\n\t\t\t\tif (bestDistance > pinDistance) {\r\n\t\t\t\t\tbestDistance = pinDistance;\r\n\t\t\t\t\tthis._cursor.nearPinIndex = this._cursor.curNote.pins.indexOf(pin);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tmousePitch -= interval;\r\n\t\t\tthis._cursor.pitch = this._snapToPitch(mousePitch, -minInterval, this._getMaxPitch() - maxInterval);\r\n\t\t\t\r\n\t\t\t// Snap to nearby existing note if present.\r\n\t\t\tif (!this._doc.song.getChannelIsNoise(this._doc.channel)) {\r\n\t\t\t\tlet nearest: number = error;\r\n\t\t\t\tfor (let i: number = 0; i < this._cursor.curNote.pitches.length; i++) {\r\n\t\t\t\t\tconst distance: number = Math.abs(this._cursor.curNote.pitches[i] - mousePitch + 0.5);\r\n\t\t\t\t\tif (distance > nearest) continue;\r\n\t\t\t\t\tnearest = distance;\r\n\t\t\t\t\tthis._cursor.pitch = this._cursor.curNote.pitches[i];\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tfor (let i: number = 0; i < this._cursor.curNote.pitches.length; i++) {\r\n\t\t\t\tif (this._cursor.curNote.pitches[i] == this._cursor.pitch) {\r\n\t\t\t\t\tthis._cursor.pitchIndex = i;\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tthis._cursor.pitch = this._snapToPitch(mousePitch, 0, this._getMaxPitch());\r\n\t\t\tconst defaultLength: number = this._copiedPins[this._copiedPins.length-1].time;\r\n\t\t\tconst fullBeats: number = Math.floor(this._cursor.part / Config.partsPerBeat);\r\n\t\t\tconst maxDivision: number = this._getMaxDivision();\r\n\t\t\tconst modMouse: number = this._cursor.part % Config.partsPerBeat;\r\n\t\t\tif (defaultLength == 1) {\r\n\t\t\t\tthis._cursor.start = this._cursor.part;\r\n\t\t\t} else if (defaultLength > Config.partsPerBeat) {\r\n\t\t\t\tthis._cursor.start = fullBeats * Config.partsPerBeat;\r\n\t\t\t} else if (defaultLength == Config.partsPerBeat) {\r\n\t\t\t\tthis._cursor.start = fullBeats * Config.partsPerBeat;\r\n\t\t\t\tif (maxDivision < Config.partsPerBeat && modMouse > maxDivision) {\r\n\t\t\t\t\tthis._cursor.start += Math.floor(modMouse / maxDivision) * maxDivision;\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\tthis._cursor.start = fullBeats * Config.partsPerBeat;\r\n\t\t\t\tlet division = Config.partsPerBeat % defaultLength == 0 ? defaultLength : Math.min(defaultLength, maxDivision);\r\n\t\t\t\twhile (division < maxDivision && Config.partsPerBeat % division != 0) {\r\n\t\t\t\t\tdivision++;\r\n\t\t\t\t}\r\n\t\t\t\tthis._cursor.start += Math.floor(modMouse / division) * division;\r\n\t\t\t}\r\n\t\t\tthis._cursor.end = this._cursor.start + defaultLength;\r\n\t\t\tlet forceStart: number = 0;\r\n\t\t\tlet forceEnd: number = this._doc.song.beatsPerBar * Config.partsPerBeat;\r\n\t\t\tif (this._cursor.prevNote != null) {\r\n\t\t\t\tforceStart = this._cursor.prevNote.end;\r\n\t\t\t}\r\n\t\t\tif (this._cursor.nextNote != null) {\r\n\t\t\t\tforceEnd   = this._cursor.nextNote.start;\r\n\t\t\t}\r\n\t\t\tif (this._cursor.start < forceStart) {\r\n\t\t\t\tthis._cursor.start = forceStart;\r\n\t\t\t\tthis._cursor.end = this._cursor.start + defaultLength;\r\n\t\t\t\tif (this._cursor.end > forceEnd) {\r\n\t\t\t\t\tthis._cursor.end = forceEnd;\r\n\t\t\t\t}\r\n\t\t\t} else if (this._cursor.end > forceEnd) {\r\n\t\t\t\tthis._cursor.end = forceEnd;\r\n\t\t\t\tthis._cursor.start = this._cursor.end - defaultLength;\r\n\t\t\t\tif (this._cursor.start < forceStart) {\r\n\t\t\t\t\tthis._cursor.start = forceStart;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tif (this._cursor.end - this._cursor.start == defaultLength) {\r\n\t\t\t\tthis._cursor.pins = this._copiedPins;\r\n\t\t\t} else {\r\n\t\t\t\tthis._cursor.pins = [];\r\n\t\t\t\tfor (const oldPin of this._copiedPins) {\r\n\t\t\t\t\tif (oldPin.time <= this._cursor.end - this._cursor.start) {\r\n\t\t\t\t\t\tthis._cursor.pins.push(makeNotePin(0, oldPin.time, oldPin.size));\r\n\t\t\t\t\t\tif (oldPin.time == this._cursor.end - this._cursor.start) break;\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tthis._cursor.pins.push(makeNotePin(0, this._cursor.end - this._cursor.start, oldPin.size));\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tthis._cursor.valid = true;\r\n\t}\r\n\t\r\n\tprivate _cursorIsInSelection(): boolean {\r\n\t\treturn this._cursor.valid && this._doc.selection.patternSelectionActive && this._doc.selection.patternSelectionStart <= this._cursor.exactPart && this._cursor.exactPart <= this._doc.selection.patternSelectionEnd;\r\n\t}\r\n\t\r\n\tprivate _cursorAtStartOfSelection(): boolean {\r\n\t\treturn this._cursor.valid && this._doc.selection.patternSelectionActive && this._cursor.pitchIndex == -1 && this._doc.selection.patternSelectionStart - 3 <= this._cursor.exactPart && this._cursor.exactPart <= this._doc.selection.patternSelectionStart + 1.25;\r\n\t}\r\n\t\r\n\tprivate _cursorAtEndOfSelection(): boolean {\r\n\t\treturn this._cursor.valid && this._doc.selection.patternSelectionActive && this._cursor.pitchIndex == -1 && this._doc.selection.patternSelectionEnd - 1.25 <= this._cursor.exactPart && this._cursor.exactPart <= this._doc.selection.patternSelectionEnd + 3;\r\n\t}\r\n\t\r\n\tprivate _findMousePitch(pixelY: number): number {\r\n\t\treturn Math.max(0, Math.min(this._pitchCount - 1, this._pitchCount - (pixelY / this._pitchHeight))) + this._octaveOffset;\r\n\t}\r\n\t\r\n\tprivate _snapToPitch(guess: number, min: number, max: number): number {\r\n\t\tif (guess < min) guess = min;\r\n\t\tif (guess > max) guess = max;\r\n\t\tconst scale: ReadonlyArray<boolean> = this._doc.prefs.notesOutsideScale ? Config.scales.dictionary[\"expert\"].flags : Config.scales[this._doc.song.scale].flags;\r\n\t\tif (scale[Math.floor(guess) % Config.pitchesPerOctave] || this._doc.song.getChannelIsNoise(this._doc.channel)) {\r\n\t\t\treturn Math.floor(guess);\r\n\t\t} else {\r\n\t\t\tlet topPitch: number = Math.floor(guess) + 1;\r\n\t\t\tlet bottomPitch: number = Math.floor(guess) - 1;\r\n\t\t\twhile (!scale[topPitch % Config.pitchesPerOctave]) {\r\n\t\t\t\ttopPitch++;\r\n\t\t\t}\r\n\t\t\twhile (!scale[(bottomPitch) % Config.pitchesPerOctave]) {\r\n\t\t\t\tbottomPitch--;\r\n\t\t\t}\r\n\t\t\tif (topPitch > max) {\r\n\t\t\t\tif (bottomPitch < min) {\r\n\t\t\t\t\treturn min;\r\n\t\t\t\t} else {\r\n\t\t\t\t\treturn bottomPitch;\r\n\t\t\t\t}\r\n\t\t\t} else if (bottomPitch < min) {\r\n\t\t\t\treturn topPitch;\r\n\t\t\t}\r\n\t\t\tlet topRange: number = topPitch;\r\n\t\t\tlet bottomRange: number = bottomPitch + 1;\r\n\t\t\tif (topPitch % Config.pitchesPerOctave == 0 || topPitch % Config.pitchesPerOctave == 7) {\r\n\t\t\t\ttopRange -= 0.5;\r\n\t\t\t}\r\n\t\t\tif (bottomPitch % Config.pitchesPerOctave == 0 || bottomPitch % Config.pitchesPerOctave == 7) {\r\n\t\t\t\tbottomRange += 0.5;\r\n\t\t\t}\r\n\t\t\treturn guess - bottomRange > topRange - guess ? topPitch : bottomPitch;\r\n\t\t}\r\n\t}\r\n\t\r\n\tprivate _copyPins(note: Note): void {\r\n\t\tthis._copiedPins = [];\r\n\t\tfor (const oldPin of note.pins) {\r\n\t\t\tthis._copiedPins.push(makeNotePin(0, oldPin.time, oldPin.size));\r\n\t\t}\r\n\t\tfor (let i: number = 1; i < this._copiedPins.length - 1; ) {\r\n\t\t\tif (this._copiedPins[i-1].size == this._copiedPins[i].size && \r\n\t\t\t\tthis._copiedPins[i].size == this._copiedPins[i+1].size)\r\n\t\t\t{\r\n\t\t\t\tthis._copiedPins.splice(i, 1);\r\n\t\t\t} else {\r\n\t\t\t\ti++;\r\n\t\t\t}\r\n\t\t}\r\n\t\tthis._copiedPinChannels[this._doc.channel] = this._copiedPins;\r\n\t}\r\n\t\r\n\tpublic movePlayheadToMouse(): boolean {\r\n\t\tif (this._mouseOver) {\r\n\t\t\tthis._doc.synth.playhead = this._doc.bar + this._barOffset + (this._mouseX / this._editorWidth);\r\n\t\t\treturn true;\r\n\t\t}\r\n\t\treturn false;\r\n\t}\r\n\t\r\n\tpublic resetCopiedPins = (): void => {\r\n\t\tconst maxDivision: number = this._getMaxDivision();\r\n\t\tthis._copiedPinChannels.length = this._doc.song.getChannelCount();\r\n\t\tfor (let i: number = 0; i < this._doc.song.pitchChannelCount; i++) {\r\n\t\t\tthis._copiedPinChannels[i] = [makeNotePin(0, 0, Config.noteSizeMax), makeNotePin(0, maxDivision, Config.noteSizeMax)];\r\n\t\t}\r\n\t\tfor (let i: number = this._doc.song.pitchChannelCount; i < this._doc.song.getChannelCount(); i++) {\r\n\t\t\tthis._copiedPinChannels[i] = [makeNotePin(0, 0, Config.noteSizeMax), makeNotePin(0, maxDivision, 0)];\r\n\t\t}\r\n\t}\r\n\t\r\n\tprivate _animatePlayhead = (timestamp: number): void => {\r\n\t\t\r\n\t\tif (this._usingTouch && !this._shiftHeld && !this._mouseDragging && this._mouseDown && performance.now() > this._touchTime + 1000 && this._cursor.valid && this._doc.lastChangeWas(this._dragChange)) {\r\n\t\t\t// On a mobile device, the pattern editor supports using a long stationary touch to activate selection.\r\n\t\t\tthis._dragChange!.undo();\r\n\t\t\tthis._shiftHeld = true;\r\n\t\t\tthis._whenCursorPressed();\r\n\t\t\t// The full interface is usually only rerendered in response to user input events, not animation events, but in this case go ahead and rerender everything.\r\n\t\t\tthis._doc.notifier.notifyWatchers();\r\n\t\t}\r\n\t\t\r\n\t\tconst playheadBar: number = Math.floor(this._doc.synth.playhead);\r\n\t\t\r\n\t\tif (this._doc.synth.playing && ((this._pattern != null && this._doc.song.getPattern(this._doc.channel, Math.floor(this._doc.synth.playhead)) == this._pattern) || Math.floor(this._doc.synth.playhead) == this._doc.bar + this._barOffset)) {\r\n\t\t\tthis._svgPlayhead.setAttribute(\"visibility\", \"visible\");\r\n\t\t\tconst modPlayhead: number = this._doc.synth.playhead - playheadBar;\r\n\t\t\tif (Math.abs(modPlayhead - this._playheadX) > 0.1) {\r\n\t\t\t\tthis._playheadX = modPlayhead;\r\n\t\t\t} else {\r\n\t\t\t\tthis._playheadX += (modPlayhead - this._playheadX) * 0.2;\r\n\t\t\t}\r\n\t\t\tthis._svgPlayhead.setAttribute(\"x\", \"\" + prettyNumber(this._playheadX * this._editorWidth - 2));\r\n\t\t} else {\r\n\t\t\tthis._svgPlayhead.setAttribute(\"visibility\", \"hidden\");\r\n\t\t}\r\n\t\t\r\n\t\tif (this._doc.synth.playing && (this._doc.synth.recording || this._doc.prefs.autoFollow) && this._followPlayheadBar != playheadBar) {\r\n\t\t\t// When autofollow is enabled, select the current bar (but don't record it in undo history).\r\n\t\t\tnew ChangeChannelBar(this._doc, this._doc.channel, playheadBar);\r\n\t\t\t// The full interface is usually only rerendered in response to user input events, not animation events, but in this case go ahead and rerender everything.\r\n\t\t\tthis._doc.notifier.notifyWatchers();\r\n\t\t}\r\n\t\tthis._followPlayheadBar = playheadBar;\r\n\t\t\r\n\t\tif (this._doc.currentPatternIsDirty) {\r\n\t\t\tthis._redrawNotePatterns();\r\n\t\t}\r\n\t\t\r\n\t\twindow.requestAnimationFrame(this._animatePlayhead);\r\n\t}\r\n\t\r\n\tprivate _whenMouseOver = (event: MouseEvent): void => {\r\n\t\tif (this._mouseOver) return;\r\n\t\tthis._mouseOver = true;\r\n\t\tthis._usingTouch = false;\r\n\t}\r\n\t\r\n\tprivate _whenMouseOut = (event: MouseEvent): void => {\r\n\t\tif (!this._mouseOver) return;\r\n\t\tthis._mouseOver = false;\r\n\t}\r\n\t\r\n\tprivate _whenMousePressed = (event: MouseEvent): void => {\r\n\t\tevent.preventDefault();\r\n\t\tconst boundingRect: ClientRect = this._svg.getBoundingClientRect();\r\n\t\tthis._mouseX = ((event.clientX || event.pageX) - boundingRect.left) * this._editorWidth / (boundingRect.right - boundingRect.left);\r\n\t\tthis._mouseY = ((event.clientY || event.pageY) - boundingRect.top) * this._editorHeight / (boundingRect.bottom - boundingRect.top);\r\n\t\tif (isNaN(this._mouseX)) this._mouseX = 0;\r\n\t\tif (isNaN(this._mouseY)) this._mouseY = 0;\r\n\t\tthis._usingTouch = false;\r\n\t\tthis._ctrlHeld = event.ctrlKey || event.metaKey;\r\n\t\tthis._shiftHeld = event.shiftKey;\r\n\t\tthis._whenCursorPressed();\r\n\t}\r\n\t\r\n\tprivate _whenTouchPressed = (event: TouchEvent): void => {\r\n\t\tevent.preventDefault();\r\n\t\tconst boundingRect: ClientRect = this._svg.getBoundingClientRect();\r\n\t\tthis._mouseX = (event.touches[0].clientX - boundingRect.left) * this._editorWidth / (boundingRect.right - boundingRect.left);\r\n\t\tthis._mouseY = (event.touches[0].clientY - boundingRect.top) * this._editorHeight / (boundingRect.bottom - boundingRect.top);\r\n\t\tif (isNaN(this._mouseX)) this._mouseX = 0;\r\n\t\tif (isNaN(this._mouseY)) this._mouseY = 0;\r\n\t\tthis._usingTouch = true;\r\n\t\tthis._ctrlHeld = event.ctrlKey || event.metaKey;\r\n\t\tthis._shiftHeld = event.shiftKey;\r\n\t\tthis._touchTime = performance.now();\r\n\t\tthis._whenCursorPressed();\r\n\t}\r\n\t\r\n\tprivate _whenCursorPressed(): void {\r\n\t\tif (this._doc.prefs.enableNotePreview) this._doc.synth.maintainLiveInput();\r\n\t\tthis._mouseDown = true;\r\n\t\tthis._mouseXStart = this._mouseX;\r\n\t\tthis._mouseYStart = this._mouseY;\r\n\t\tthis._updateCursorStatus();\r\n\t\tthis._updatePreview();\r\n\t\tconst sequence: ChangeSequence = new ChangeSequence();\r\n\t\tthis._dragChange = sequence;\r\n\t\tthis._lastChangeWasPatternSelection = this._doc.lastChangeWas(this._changePatternSelection);\r\n\t\tthis._doc.setProspectiveChange(this._dragChange);\r\n\t\t\r\n\t\tif (this._cursorAtStartOfSelection()) {\r\n\t\t\tthis._draggingStartOfSelection = true;\r\n\t\t} else if (this._cursorAtEndOfSelection()) {\r\n\t\t\tthis._draggingEndOfSelection = true;\r\n\t\t} else if (this._shiftHeld) {\r\n\t\t\tif ((this._doc.selection.patternSelectionActive && this._cursor.pitchIndex == -1) || this._cursorIsInSelection()) {\r\n\t\t\t\tsequence.append(new ChangePatternSelection(this._doc, 0, 0));\r\n\t\t\t} else {\r\n\t\t\t\tif (this._cursor.curNote != null) {\r\n\t\t\t\t\tsequence.append(new ChangePatternSelection(this._doc, this._cursor.curNote.start, this._cursor.curNote.end));\r\n\t\t\t\t} else {\r\n\t\t\t\t\tconst start: number = Math.max(0, Math.min((this._doc.song.beatsPerBar - 1) * Config.partsPerBeat, Math.floor(this._cursor.exactPart / Config.partsPerBeat) * Config.partsPerBeat));\r\n\t\t\t\t\tconst end: number = start + Config.partsPerBeat;\r\n\t\t\t\t\tsequence.append(new ChangePatternSelection(this._doc, start, end));\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t} else if (this._cursorIsInSelection()) {\r\n\t\t\tthis._draggingSelectionContents = true;\r\n\t\t} else if (this._cursor.valid && this._cursor.curNote == null) {\r\n\t\t\tsequence.append(new ChangePatternSelection(this._doc, 0, 0));\r\n\t\t\t\r\n\t\t\t// If clicking in empty space, the result will be adding a note,\r\n\t\t\t// so we can safely add it immediately. Note that if clicking on\r\n\t\t\t// or near an existing note, the result will depend on whether\r\n\t\t\t// a drag follows, so we couldn't add the note yet without being\r\n\t\t\t// confusing.\r\n\t\t\t\r\n\t\t\tconst note: Note = new Note(this._cursor.pitch, this._cursor.start, this._cursor.end, Config.noteSizeMax, this._doc.song.getChannelIsNoise(this._doc.channel));\r\n\t\t\tnote.pins = [];\r\n\t\t\tfor (const oldPin of this._cursor.pins) {\r\n\t\t\t\tnote.pins.push(makeNotePin(0, oldPin.time, oldPin.size));\r\n\t\t\t}\r\n\t\t\tsequence.append(new ChangeEnsurePatternExists(this._doc, this._doc.channel, this._doc.bar));\r\n\t\t\tconst pattern: Pattern | null = this._doc.getCurrentPattern(this._barOffset);\r\n\t\t\tif (pattern == null) throw new Error();\r\n\t\t\tsequence.append(new ChangeNoteAdded(this._doc, pattern, note, this._cursor.curIndex));\r\n\t\t\t\r\n\t\t\tif (this._doc.prefs.enableNotePreview && !this._doc.synth.playing) {\r\n\t\t\t\t// Play the new note out loud if enabled.\r\n\t\t\t\tconst duration: number = Math.min(Config.partsPerBeat, this._cursor.end - this._cursor.start);\r\n\t\t\t\tthis._doc.performance.setTemporaryPitches([this._cursor.pitch], duration);\r\n\t\t\t}\r\n\t\t}\r\n\t\tthis._updateSelection();\r\n\t}\r\n\t\r\n\tprivate _whenMouseMoved = (event: MouseEvent): void => {\r\n\t\tconst boundingRect: ClientRect = this._svg.getBoundingClientRect();\r\n\t\tthis._mouseX = ((event.clientX || event.pageX) - boundingRect.left) * this._editorWidth / (boundingRect.right - boundingRect.left);\r\n\t\tthis._mouseY = ((event.clientY || event.pageY) - boundingRect.top) * this._editorHeight / (boundingRect.bottom - boundingRect.top);\r\n\t\tif (isNaN(this._mouseX)) this._mouseX = 0;\r\n\t\tif (isNaN(this._mouseY)) this._mouseY = 0;\r\n\t\tthis._usingTouch = false;\r\n\t\tthis._whenCursorMoved();\r\n\t}\r\n\t\r\n\tprivate _whenTouchMoved = (event: TouchEvent): void => {\r\n\t\tif (!this._mouseDown) return;\r\n\t\tevent.preventDefault();\r\n\t\tconst boundingRect: ClientRect = this._svg.getBoundingClientRect();\r\n\t\tthis._mouseX = (event.touches[0].clientX - boundingRect.left) * this._editorWidth / (boundingRect.right - boundingRect.left);\r\n\t\tthis._mouseY = (event.touches[0].clientY - boundingRect.top) * this._editorHeight / (boundingRect.bottom - boundingRect.top);\r\n\t\tif (isNaN(this._mouseX)) this._mouseX = 0;\r\n\t\tif (isNaN(this._mouseY)) this._mouseY = 0;\r\n\t\tthis._whenCursorMoved();\r\n\t}\r\n\t\r\n\tprivate _whenCursorMoved(): void {\r\n\t\tif (this._doc.prefs.enableNotePreview && this._mouseOver) this._doc.synth.maintainLiveInput();\r\n\t\t\r\n\t\t// HACK: Undoable pattern changes rely on persistent instance\r\n\t\t// references. Loading song from hash via undo/redo breaks that,\r\n\t\t// so changes are no longer undoable and the cursor status may be\r\n\t\t// invalid. Abort further drag changes until the mouse is released.\r\n\t\tconst continuousState: boolean = this._doc.lastChangeWas(this._dragChange);\r\n\t\t\r\n\t\tif (!this._mouseDragging && this._mouseDown && this._cursor.valid && continuousState) {\r\n\t\t\tconst dx: number = this._mouseX - this._mouseXStart;\r\n\t\t\tconst dy: number = this._mouseY - this._mouseYStart;\r\n\t\t\tif (Math.sqrt(dx * dx + dy * dy) > 5) {\r\n\t\t\t\tthis._mouseDragging = true;\r\n\t\t\t\tthis._mouseHorizontal = Math.abs(dx) >= Math.abs(dy);\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tif (this._mouseDragging && this._mouseDown && this._cursor.valid && continuousState) {\r\n\t\t\tthis._dragChange!.undo();\r\n\t\t\tconst sequence: ChangeSequence = new ChangeSequence();\r\n\t\t\tthis._dragChange = sequence;\r\n\t\t\tthis._doc.setProspectiveChange(this._dragChange);\r\n\t\t\t\r\n\t\t\tconst minDivision: number = this._getMinDivision();\r\n\t\t\tconst currentPart: number = this._snapToMinDivision(this._mouseX / this._partWidth);\r\n\t\t\tif (this._draggingStartOfSelection) {\r\n\t\t\t\tsequence.append(new ChangePatternSelection(this._doc, Math.max(0, Math.min(this._doc.song.beatsPerBar * Config.partsPerBeat, currentPart)), this._doc.selection.patternSelectionEnd));\r\n\t\t\t\tthis._updateSelection();\r\n\t\t\t} else if (this._draggingEndOfSelection) {\r\n\t\t\t\tsequence.append(new ChangePatternSelection(this._doc, this._doc.selection.patternSelectionStart, Math.max(0, Math.min(this._doc.song.beatsPerBar * Config.partsPerBeat, currentPart))));\r\n\t\t\t\tthis._updateSelection();\r\n\t\t\t} else if (this._draggingSelectionContents) {\r\n\t\t\t\tconst pattern: Pattern | null = this._doc.getCurrentPattern(this._barOffset);\r\n\t\t\t\tif (this._mouseDragging && pattern != null) {\r\n\t\t\t\t\tthis._dragChange!.undo();\r\n\t\t\t\t\tconst sequence: ChangeSequence = new ChangeSequence();\r\n\t\t\t\t\tthis._dragChange = sequence;\r\n\t\t\t\t\tthis._doc.setProspectiveChange(this._dragChange);\r\n\t\t\t\t\t\r\n\t\t\t\t\tconst notesInScale: number = Config.scales[this._doc.song.scale].flags.filter(x=>x).length;\r\n\t\t\t\t\tconst pitchRatio: number = this._doc.song.getChannelIsNoise(this._doc.channel) ? 1 : 12 / notesInScale;\r\n\t\t\t\t\tconst draggedParts: number = Math.round((this._mouseX - this._mouseXStart) / (this._partWidth * minDivision)) * minDivision;\r\n\t\t\t\t\tconst draggedTranspose: number = Math.round((this._mouseYStart - this._mouseY) / (this._pitchHeight * pitchRatio));\r\n\t\t\t\t\tsequence.append(new ChangeDragSelectedNotes(this._doc, this._doc.channel, pattern, draggedParts, draggedTranspose));\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t} else if (this._shiftHeld) {\r\n\t\t\t\t\r\n\t\t\t\tif (this._mouseDragging) {\r\n\t\t\t\t\tlet start: number = Math.max(0, Math.min((this._doc.song.beatsPerBar - 1) * Config.partsPerBeat, Math.floor(this._cursor.exactPart / Config.partsPerBeat) * Config.partsPerBeat));\r\n\t\t\t\t\tlet end: number = start + Config.partsPerBeat;\r\n\t\t\t\t\tif (this._cursor.curNote != null) {\r\n\t\t\t\t\t\tstart = Math.max(start, this._cursor.curNote.start);\r\n\t\t\t\t\t\tend = Math.min(end, this._cursor.curNote.end);\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t\t// Todo: The following two conditional blocks could maybe be refactored.\r\n\t\t\t\t\tif (currentPart < start) {\r\n\t\t\t\t\t\tstart = 0;\r\n\t\t\t\t\t\tconst pattern: Pattern | null = this._doc.getCurrentPattern(this._barOffset);\r\n\t\t\t\t\t\tif (pattern != null) {\r\n\t\t\t\t\t\t\tfor (let i: number = 0; i < pattern.notes.length; i++) {\r\n\t\t\t\t\t\t\t\tif (pattern.notes[i].start <= currentPart) {\r\n\t\t\t\t\t\t\t\t\tstart = pattern.notes[i].start;\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\tif (pattern.notes[i].end <= currentPart) {\r\n\t\t\t\t\t\t\t\t\tstart = pattern.notes[i].end;\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tfor (let beat: number = 0; beat <= this._doc.song.beatsPerBar; beat++) {\r\n\t\t\t\t\t\t\tconst part: number = beat * Config.partsPerBeat;\r\n\t\t\t\t\t\t\tif (start <= part && part <= currentPart) {\r\n\t\t\t\t\t\t\t\tstart = part;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t\tif (currentPart > end) {\r\n\t\t\t\t\t\tend = Config.partsPerBeat * this._doc.song.beatsPerBar;\r\n\t\t\t\t\t\tconst pattern: Pattern | null = this._doc.getCurrentPattern(this._barOffset);\r\n\t\t\t\t\t\tif (pattern != null) {\r\n\t\t\t\t\t\t\tfor (let i: number = 0; i < pattern.notes.length; i++) {\r\n\t\t\t\t\t\t\t\tif (pattern.notes[i].start >= currentPart) {\r\n\t\t\t\t\t\t\t\t\tend = pattern.notes[i].start;\r\n\t\t\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\tif (pattern.notes[i].end >= currentPart) {\r\n\t\t\t\t\t\t\t\t\tend = pattern.notes[i].end;\r\n\t\t\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tfor (let beat: number = 0; beat <= this._doc.song.beatsPerBar; beat++) {\r\n\t\t\t\t\t\t\tconst part: number = beat * Config.partsPerBeat;\r\n\t\t\t\t\t\t\tif (currentPart < part && part < end) {\r\n\t\t\t\t\t\t\t\tend = part;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t\tsequence.append(new ChangePatternSelection(this._doc, start, end));\r\n\t\t\t\t\tthis._updateSelection();\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\t\r\n\t\t\t\tif (this._cursor.curNote == null) {\r\n\t\t\t\t\tsequence.append(new ChangePatternSelection(this._doc, 0, 0));\r\n\t\t\t\t\t\r\n\t\t\t\t\tlet backwards: boolean;\r\n\t\t\t\t\tlet directLength: number;\r\n\t\t\t\t\tif (currentPart < this._cursor.start) {\r\n\t\t\t\t\t\tbackwards = true;\r\n\t\t\t\t\t\tdirectLength = this._cursor.start - currentPart;\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tbackwards = false;\r\n\t\t\t\t\t\tdirectLength = currentPart - this._cursor.start + minDivision;\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t\tlet defaultLength: number = minDivision;\r\n\t\t\t\t\tfor (let i: number = minDivision; i <= this._doc.song.beatsPerBar * Config.partsPerBeat; i += minDivision) {\r\n\t\t\t\t\t\tif (minDivision == 1) {\r\n\t\t\t\t\t\t\tif (i < 5) {\r\n\t\t\t\t\t\t\t\t// Allow small lengths.\r\n\t\t\t\t\t\t\t} else if (i <= Config.partsPerBeat / 2.0) {\r\n\t\t\t\t\t\t\t\tif (i % 3 != 0 && i % 4 != 0) {\r\n\t\t\t\t\t\t\t\t\tcontinue;\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t} else if (i <= Config.partsPerBeat * 1.5) {\r\n\t\t\t\t\t\t\t\tif (i % 6 != 0 && i % 8 != 0) {\r\n\t\t\t\t\t\t\t\t\tcontinue;\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t} else if (i % Config.partsPerBeat != 0) {\r\n\t\t\t\t\t\t\t\tcontinue;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\tif (i >= 5 * minDivision &&\r\n\t\t\t\t\t\t\t\ti % Config.partsPerBeat != 0 &&\r\n\t\t\t\t\t\t\t\ti != Config.partsPerBeat * 3.0 / 4.0 &&\r\n\t\t\t\t\t\t\t\ti != Config.partsPerBeat * 3.0 / 2.0 &&\r\n\t\t\t\t\t\t\t\ti != Config.partsPerBeat * 4.0 / 3.0)\r\n\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\tcontinue;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tconst blessedLength: number = i;\r\n\t\t\t\t\t\tif (blessedLength == directLength) {\r\n\t\t\t\t\t\t\tdefaultLength = blessedLength;\r\n\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif (blessedLength < directLength) {\r\n\t\t\t\t\t\t\tdefaultLength = blessedLength;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tif (blessedLength > directLength) {\r\n\t\t\t\t\t\t\tif (defaultLength < directLength - minDivision) {\r\n\t\t\t\t\t\t\t\tdefaultLength = blessedLength;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t\tlet start: number;\r\n\t\t\t\t\tlet end: number;\r\n\t\t\t\t\tif (backwards) {\r\n\t\t\t\t\t\tend = this._cursor.start;\r\n\t\t\t\t\t\tstart = end - defaultLength;\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tstart = this._cursor.start;\r\n\t\t\t\t\t\tend = start + defaultLength;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tconst continuesLastPattern: boolean = (start < 0);\r\n\t\t\t\t\tif (start < 0) start = 0;\r\n\t\t\t\t\tif (end > this._doc.song.beatsPerBar * Config.partsPerBeat) end = this._doc.song.beatsPerBar * Config.partsPerBeat;\r\n\t\t\t\t\t\r\n\t\t\t\t\tif (start < end) {\r\n\t\t\t\t\t\tsequence.append(new ChangeEnsurePatternExists(this._doc, this._doc.channel, this._doc.bar));\r\n\t\t\t\t\t\tconst pattern: Pattern | null = this._doc.getCurrentPattern(this._barOffset);\r\n\t\t\t\t\t\tif (pattern == null) throw new Error();\r\n\t\t\t\t\t\tsequence.append(new ChangeNoteTruncate(this._doc, pattern, start, end));\r\n\t\t\t\t\t\tlet i: number;\r\n\t\t\t\t\t\tfor (i = 0; i < pattern.notes.length; i++) {\r\n\t\t\t\t\t\t\tif (pattern.notes[i].start >= end) break;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tconst theNote: Note = new Note(this._cursor.pitch, start, end, Config.noteSizeMax, this._doc.song.getChannelIsNoise(this._doc.channel));\r\n\t\t\t\t\t\ttheNote.continuesLastPattern = continuesLastPattern;\r\n\t\t\t\t\t\tsequence.append(new ChangeNoteAdded(this._doc, pattern, theNote, i));\r\n\t\t\t\t\t\tthis._copyPins(theNote);\r\n\t\t\t\t\t\r\n\t\t\t\t\t\tthis._dragTime = backwards ? start : end;\r\n\t\t\t\t\t\tthis._dragPitch = this._cursor.pitch;\r\n\t\t\t\t\t\tthis._dragSize = theNote.pins[backwards ? 0 : 1].size;\r\n\t\t\t\t\t\tthis._dragVisible = true;\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t\tthis._pattern = this._doc.getCurrentPattern(this._barOffset);\r\n\t\t\t\t} else if (this._mouseHorizontal) {\r\n\t\t\t\t\tsequence.append(new ChangePatternSelection(this._doc, 0, 0));\r\n\t\t\t\t\t\r\n\t\t\t\t\tconst shift: number = (this._mouseX - this._mouseXStart) / this._partWidth;\r\n\t\t\t\t\t\r\n\t\t\t\t\tconst shiftedPin: NotePin = this._cursor.curNote.pins[this._cursor.nearPinIndex];\r\n\t\t\t\t\tlet shiftedTime: number = Math.round((this._cursor.curNote.start + shiftedPin.time + shift) / minDivision) * minDivision;\r\n\t\t\t\t\tconst continuesLastPattern: boolean = (shiftedTime < 0.0);\r\n\t\t\t\t\tif (shiftedTime < 0) shiftedTime = 0;\r\n\t\t\t\t\tif (shiftedTime > this._doc.song.beatsPerBar * Config.partsPerBeat) shiftedTime = this._doc.song.beatsPerBar * Config.partsPerBeat;\r\n\t\t\t\t\t\r\n\t\t\t\t\tif (this._pattern == null) throw new Error();\r\n\t\t\t\t\t\r\n\t\t\t\t\tif (shiftedTime <= this._cursor.curNote.start && this._cursor.nearPinIndex == this._cursor.curNote.pins.length - 1 ||\r\n\t\t\t\t\t\tshiftedTime >= this._cursor.curNote.end   && this._cursor.nearPinIndex == 0)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tsequence.append(new ChangeNoteAdded(this._doc, this._pattern, this._cursor.curNote, this._cursor.curIndex, true));\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tthis._dragVisible = false;\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tconst start: number = Math.min(this._cursor.curNote.start, shiftedTime);\r\n\t\t\t\t\t\tconst   end: number = Math.max(this._cursor.curNote.end,   shiftedTime);\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tthis._dragTime = shiftedTime;\r\n\t\t\t\t\t\tthis._dragPitch = this._cursor.curNote.pitches[this._cursor.pitchIndex == -1 ? 0 : this._cursor.pitchIndex] + this._cursor.curNote.pins[this._cursor.nearPinIndex].interval;\r\n\t\t\t\t\t\tthis._dragSize = this._cursor.curNote.pins[this._cursor.nearPinIndex].size;\r\n\t\t\t\t\t\tthis._dragVisible = true;\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tsequence.append(new ChangeNoteTruncate(this._doc, this._pattern, start, end, this._cursor.curNote));\r\n\t\t\t\t\t\tsequence.append(new ChangePinTime(this._doc, this._cursor.curNote, this._cursor.nearPinIndex, shiftedTime, continuesLastPattern));\r\n\t\t\t\t\t\tthis._copyPins(this._cursor.curNote);\r\n\t\t\t\t\t}\r\n\t\t\t\t} else if (this._cursor.pitchIndex == -1) {\r\n\t\t\t\t\tsequence.append(new ChangePatternSelection(this._doc, 0, 0));\r\n\t\t\t\t\t\r\n\t\t\t\t\tconst bendPart: number = \r\n\t\t\t\t\t\tMath.max(this._cursor.curNote.start,\r\n\t\t\t\t\t\t\tMath.min(this._cursor.curNote.end,\r\n\t\t\t\t\t\t\t\tMath.round(this._mouseX / (this._partWidth * minDivision)) * minDivision\r\n\t\t\t\t\t\t\t)\r\n\t\t\t\t\t\t) - this._cursor.curNote.start;\r\n\t\t\t\t\t\r\n\t\t\t\t\tlet prevPin: NotePin;\r\n\t\t\t\t\tlet nextPin: NotePin = this._cursor.curNote.pins[0];\r\n\t\t\t\t\tlet bendSize: number = 0;\r\n\t\t\t\t\tlet bendInterval: number = 0;\r\n\t\t\t\t\tfor (let i: number = 1; i < this._cursor.curNote.pins.length; i++) {\r\n\t\t\t\t\t\tprevPin = nextPin;\r\n\t\t\t\t\t\tnextPin = this._cursor.curNote.pins[i];\r\n\t\t\t\t\t\tif (bendPart > nextPin.time) continue;\r\n\t\t\t\t\t\tif (bendPart < prevPin.time) throw new Error();\r\n\t\t\t\t\t\tconst sizeRatio: number = (bendPart - prevPin.time) / (nextPin.time - prevPin.time);\r\n\t\t\t\t\t\tbendSize = Math.round(prevPin.size * (1.0 - sizeRatio) + nextPin.size * sizeRatio + ((this._mouseYStart - this._mouseY) / (75.0 / Config.noteSizeMax)));\r\n\t\t\t\t\t\tif (bendSize < 0) bendSize = 0;\r\n\t\t\t\t\t\tif (bendSize > Config.noteSizeMax) bendSize = Config.noteSizeMax;\r\n\t\t\t\t\t\tbendInterval = this._snapToPitch(Math.round(prevPin.interval * (1.0 - sizeRatio) + nextPin.interval * sizeRatio + this._cursor.curNote.pitches[0]), 0, this._getMaxPitch()) - this._cursor.curNote.pitches[0];\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t\tthis._dragTime = this._cursor.curNote.start + bendPart;\r\n\t\t\t\t\tthis._dragPitch = this._cursor.curNote.pitches[this._cursor.pitchIndex == -1 ? 0 : this._cursor.pitchIndex] + bendInterval;\r\n\t\t\t\t\tthis._dragSize = bendSize;\r\n\t\t\t\t\tthis._dragVisible = true;\r\n\t\t\t\t\t\r\n\t\t\t\t\tsequence.append(new ChangeSizeBend(this._doc, this._cursor.curNote, bendPart, bendSize, bendInterval, this._ctrlHeld));\r\n\t\t\t\t\tthis._copyPins(this._cursor.curNote);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tsequence.append(new ChangePatternSelection(this._doc, 0, 0));\r\n\t\t\t\t\t\r\n\t\t\t\t\tthis._dragSize = this._cursor.curNote.pins[this._cursor.nearPinIndex].size;\r\n\t\t\t\t\t\r\n\t\t\t\t\tif (this._pattern == null) throw new Error();\r\n\t\t\t\t\t\r\n\t\t\t\t\tlet bendStart: number;\r\n\t\t\t\t\tlet bendEnd: number;\r\n\t\t\t\t\tif (this._mouseX >= this._mouseXStart) {\r\n\t\t\t\t\t\tbendStart = Math.max(this._cursor.curNote.start, this._cursor.part);\r\n\t\t\t\t\t\tbendEnd   = currentPart + minDivision;\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tbendStart = Math.min(this._cursor.curNote.end, this._cursor.part + minDivision);\r\n\t\t\t\t\t\tbendEnd   = currentPart;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (bendEnd < 0) bendEnd = 0;\r\n\t\t\t\t\tif (bendEnd > this._doc.song.beatsPerBar * Config.partsPerBeat) bendEnd = this._doc.song.beatsPerBar * Config.partsPerBeat;\r\n\t\t\t\t\tif (bendEnd > this._cursor.curNote.end) {\r\n\t\t\t\t\t\tsequence.append(new ChangeNoteTruncate(this._doc, this._pattern, this._cursor.curNote.start, bendEnd, this._cursor.curNote));\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (bendEnd < this._cursor.curNote.start) {\r\n\t\t\t\t\t\tsequence.append(new ChangeNoteTruncate(this._doc, this._pattern, bendEnd, this._cursor.curNote.end, this._cursor.curNote));\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t\tlet minPitch: number = Number.MAX_VALUE;\r\n\t\t\t\t\tlet maxPitch: number = -Number.MAX_VALUE;\r\n\t\t\t\t\tfor (const pitch of this._cursor.curNote.pitches) {\r\n\t\t\t\t\t\tif (minPitch > pitch) minPitch = pitch;\r\n\t\t\t\t\t\tif (maxPitch < pitch) maxPitch = pitch;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tminPitch -= this._cursor.curNote.pitches[this._cursor.pitchIndex];\r\n\t\t\t\t\tmaxPitch -= this._cursor.curNote.pitches[this._cursor.pitchIndex];\r\n\t\t\t\t\tconst bendTo: number = this._snapToPitch(this._findMousePitch(this._mouseY), -minPitch, this._getMaxPitch() - maxPitch);\r\n\t\t\t\t\tsequence.append(new ChangePitchBend(this._doc, this._cursor.curNote, bendStart, bendEnd, bendTo, this._cursor.pitchIndex));\r\n\t\t\t\t\tthis._copyPins(this._cursor.curNote);\r\n\t\t\t\t\t\r\n\t\t\t\t\tthis._dragTime = bendEnd;\r\n\t\t\t\t\tthis._dragPitch = bendTo;\r\n\t\t\t\t\tthis._dragVisible = true;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tif (!(this._mouseDown && this._cursor.valid && continuousState)) {\r\n\t\t\tthis._updateCursorStatus();\r\n\t\t\tthis._updatePreview();\r\n\t\t}\r\n\t}\r\n\t\r\n\tprivate _whenCursorReleased = (event: Event | null): void => {\r\n\t\tif (!this._cursor.valid) return;\r\n\t\t\r\n\t\tconst continuousState: boolean = this._doc.lastChangeWas(this._dragChange);\r\n\t\tif (this._mouseDown && continuousState && this._dragChange != null) {\r\n\t\t\t\r\n\t\t\tif (this._draggingSelectionContents) {\r\n\t\t\t\tthis._doc.record(this._dragChange);\r\n\t\t\t\tthis._dragChange = null;\r\n\t\t\t} else if (this._draggingStartOfSelection || this._draggingEndOfSelection || this._shiftHeld) {\r\n\t\t\t\tthis._setPatternSelection(this._dragChange);\r\n\t\t\t\tthis._dragChange = null;\r\n\t\t\t} else if (this._mouseDragging || this._cursor.curNote == null || !this._dragChange.isNoop() || this._draggingStartOfSelection || this._draggingEndOfSelection || this._draggingSelectionContents || this._shiftHeld) {\r\n\t\t\t\tthis._doc.record(this._dragChange);\r\n\t\t\t\tthis._dragChange = null;\r\n\t\t\t} else {\r\n\t\t\t\tif (this._pattern == null) throw new Error();\r\n\t\t\t\t\r\n\t\t\t\tconst sequence: ChangeSequence = new ChangeSequence();\r\n\t\t\t\tsequence.append(new ChangePatternSelection(this._doc, 0, 0));\r\n\t\t\t\t\r\n\t\t\t\tif (this._cursor.pitchIndex == -1) {\r\n\t\t\t\t\tif (this._cursor.curNote.pitches.length == Config.maxChordSize) {\r\n\t\t\t\t\t\tsequence.append(new ChangePitchAdded(this._doc, this._cursor.curNote, this._cursor.curNote.pitches[0], 0, true));\r\n\t\t\t\t\t}\r\n\t\t\t\t\tsequence.append(new ChangePitchAdded(this._doc, this._cursor.curNote, this._cursor.pitch, this._cursor.curNote.pitches.length));\r\n\t\t\t\t\tthis._copyPins(this._cursor.curNote);\r\n\t\t\t\t\t\r\n\t\t\t\t\tif (this._doc.prefs.enableNotePreview && !this._doc.synth.playing) {\r\n\t\t\t\t\t\tconst duration: number = Math.min(Config.partsPerBeat, this._cursor.end - this._cursor.start);\r\n\t\t\t\t\t\tthis._doc.performance.setTemporaryPitches(this._cursor.curNote.pitches, duration);\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\tif (this._cursor.curNote.pitches.length == 1) {\r\n\t\t\t\t\t\tsequence.append(new ChangeNoteAdded(this._doc, this._pattern, this._cursor.curNote, this._cursor.curIndex, true));\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tsequence.append(new ChangePitchAdded(this._doc, this._cursor.curNote, this._cursor.pitch, this._cursor.curNote.pitches.indexOf(this._cursor.pitch), true));\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tthis._doc.record(sequence);\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tthis._mouseDown = false;\r\n\t\tthis._mouseDragging = false;\r\n\t\tthis._draggingStartOfSelection = false;\r\n\t\tthis._draggingEndOfSelection = false;\r\n\t\tthis._draggingSelectionContents = false;\r\n\t\tthis._lastChangeWasPatternSelection = false;\r\n\t\tthis._updateCursorStatus();\r\n\t\tthis._updatePreview();\r\n\t}\r\n\t\r\n\tprivate _setPatternSelection(change: UndoableChange): void {\r\n\t\tthis._changePatternSelection = change;\r\n\t\t// Don't erase existing redo history just to change pattern selection.\r\n\t\tif (!this._doc.hasRedoHistory()) {\r\n\t\t\tthis._doc.record(this._changePatternSelection, this._lastChangeWasPatternSelection);\r\n\t\t}\r\n\t}\r\n\t\r\n\tprivate _updatePreview(): void {\r\n\t\tif (this._usingTouch) {\r\n\t\t\tif (!this._mouseDown || !this._cursor.valid  || !this._mouseDragging || !this._dragVisible || this._shiftHeld || this._draggingStartOfSelection || this._draggingEndOfSelection || this._draggingSelectionContents) {\r\n\t\t\t\tthis._svgPreview.setAttribute(\"visibility\", \"hidden\");\r\n\t\t\t} else {\r\n\t\t\t\tthis._svgPreview.setAttribute(\"visibility\", \"visible\");\r\n\t\t\t\t\r\n\t\t\t\tconst x: number = this._partWidth * this._dragTime;\r\n\t\t\t\tconst y: number = this._pitchToPixelHeight(this._dragPitch - this._octaveOffset);\r\n\t\t\t\tconst radius: number = this._pitchHeight / 2;\r\n\t\t\t\tconst width: number = 80;\r\n\t\t\t\tconst height: number = 60;\r\n\t\t\t\t//this._drawNote(this._svgPreview, this._cursor.pitch, this._cursor.start, this._cursor.pins, this._pitchHeight / 2 + 1, true, this._octaveOffset);\r\n\t\t\t\t\r\n\t\t\t\tlet pathString: string = \"\";\r\n\t\t\t\t\r\n\t\t\t\tconst sizeMax: number = Config.noteSizeMax;\r\n\t\t\t\tpathString += \"M \" + prettyNumber(x)         + \" \" + prettyNumber(y - radius * (this._dragSize / sizeMax)) + \" \";\r\n\t\t\t\tpathString += \"L \" + prettyNumber(x)         + \" \" + prettyNumber(y - radius * (this._dragSize / sizeMax) - height) + \" \";\r\n\t\t\t\tpathString += \"M \" + prettyNumber(x)         + \" \" + prettyNumber(y + radius * (this._dragSize / sizeMax)) + \" \";\r\n\t\t\t\tpathString += \"L \" + prettyNumber(x)         + \" \" + prettyNumber(y + radius * (this._dragSize / sizeMax) + height) + \" \";\r\n\t\t\t\tpathString += \"M \" + prettyNumber(x)         + \" \" + prettyNumber(y - radius * (this._dragSize / sizeMax)) + \" \";\r\n\t\t\t\tpathString += \"L \" + prettyNumber(x + width) + \" \" + prettyNumber(y - radius * (this._dragSize / sizeMax)) + \" \";\r\n\t\t\t\tpathString += \"M \" + prettyNumber(x)         + \" \" + prettyNumber(y + radius * (this._dragSize / sizeMax)) + \" \";\r\n\t\t\t\tpathString += \"L \" + prettyNumber(x + width) + \" \" + prettyNumber(y + radius * (this._dragSize / sizeMax)) + \" \";\r\n\t\t\t\tpathString += \"M \" + prettyNumber(x)         + \" \" + prettyNumber(y - radius * (this._dragSize / sizeMax)) + \" \";\r\n\t\t\t\tpathString += \"L \" + prettyNumber(x - width) + \" \" + prettyNumber(y - radius * (this._dragSize / sizeMax)) + \" \";\r\n\t\t\t\tpathString += \"M \" + prettyNumber(x)         + \" \" + prettyNumber(y + radius * (this._dragSize / sizeMax)) + \" \";\r\n\t\t\t\tpathString += \"L \" + prettyNumber(x - width) + \" \" + prettyNumber(y + radius * (this._dragSize / sizeMax)) + \" \";\r\n\t\t\t\t\r\n\t\t\t\tthis._svgPreview.setAttribute(\"d\", pathString);\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tif (!this._mouseOver || this._mouseDown || !this._cursor.valid) {\r\n\t\t\t\tthis._svgPreview.setAttribute(\"visibility\", \"hidden\");\r\n\t\t\t} else {\r\n\t\t\t\tthis._svgPreview.setAttribute(\"visibility\", \"visible\");\r\n\t\t\t\t\r\n\t\t\t\tif (this._cursorAtStartOfSelection()) {\r\n\t\t\t\t\tconst center: number = this._partWidth * this._doc.selection.patternSelectionStart;\r\n\t\t\t\t\tconst left: string = prettyNumber(center - 4);\r\n\t\t\t\t\tconst right: string = prettyNumber(center + 4);\r\n\t\t\t\t\tconst bottom: number = this._pitchToPixelHeight(-0.5);\r\n\t\t\t\t\tthis._svgPreview.setAttribute(\"d\", \"M \" + left + \" 0 L \" + left + \" \" + bottom + \" L \" + right + \" \" + bottom + \" L \" + right + \" 0 z\");\r\n\t\t\t\t} else if (this._cursorAtEndOfSelection()) {\r\n\t\t\t\t\tconst center: number = this._partWidth * this._doc.selection.patternSelectionEnd;\r\n\t\t\t\t\tconst left: string = prettyNumber(center - 4);\r\n\t\t\t\t\tconst right: string = prettyNumber(center + 4);\r\n\t\t\t\t\tconst bottom: number = this._pitchToPixelHeight(-0.5);\r\n\t\t\t\t\tthis._svgPreview.setAttribute(\"d\", \"M \" + left + \" 0 L \" + left + \" \" + bottom + \" L \" + right + \" \" + bottom + \" L \" + right + \" 0 z\");\r\n\t\t\t\t} else if (this._cursorIsInSelection()) {\r\n\t\t\t\t\tconst left: string = prettyNumber(this._partWidth * this._doc.selection.patternSelectionStart - 2);\r\n\t\t\t\t\tconst right: string = prettyNumber(this._partWidth * this._doc.selection.patternSelectionEnd + 2);\r\n\t\t\t\t\tconst bottom: number = this._pitchToPixelHeight(-0.5);\r\n\t\t\t\t\tthis._svgPreview.setAttribute(\"d\", \"M \" + left + \" 0 L \" + left + \" \" + bottom + \" L \" + right + \" \" + bottom + \" L \" + right + \" 0 z\");\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis._drawNote(this._svgPreview, this._cursor.pitch, this._cursor.start, this._cursor.pins, this._pitchHeight / 2 + 1, true, this._octaveOffset);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\t\r\n\tprivate _updateSelection(): void {\r\n\t\tif (this._doc.selection.patternSelectionActive) {\r\n\t\t\tthis._selectionRect.setAttribute(\"visibility\", \"visible\");\r\n\t\t\tthis._selectionRect.setAttribute(\"x\", String(this._partWidth * this._doc.selection.patternSelectionStart));\r\n\t\t\tthis._selectionRect.setAttribute(\"width\", String(this._partWidth * (this._doc.selection.patternSelectionEnd - this._doc.selection.patternSelectionStart)));\r\n\t\t} else {\r\n\t\t\tthis._selectionRect.setAttribute(\"visibility\", \"hidden\");\r\n\t\t}\r\n\t}\r\n\t\r\n\tpublic render(): void {\r\n\t\tconst nextPattern: Pattern | null = this._doc.getCurrentPattern(this._barOffset);\r\n\t\tif (this._pattern != nextPattern && this._pattern != null) {\r\n\t\t\tthis._dragChange = null;\r\n\t\t\tthis._whenCursorReleased(null);\r\n\t\t}\r\n\t\tthis._pattern = nextPattern;\r\n\t\t\r\n\t\tthis._editorWidth = this.container.clientWidth;\r\n\t\tthis._editorHeight = this.container.clientHeight;\r\n\t\tthis._partWidth = this._editorWidth / (this._doc.song.beatsPerBar * Config.partsPerBeat);\r\n\t\tthis._pitchCount = this._doc.song.getChannelIsNoise(this._doc.channel) ? Config.drumCount : this._doc.getVisiblePitchCount();\r\n\t\tthis._pitchHeight = this._editorHeight / this._pitchCount;\r\n\t\tthis._octaveOffset = this._doc.getBaseVisibleOctave(this._doc.channel) * Config.pitchesPerOctave;\r\n\t\t\r\n\t\tif (this._renderedRhythm != this._doc.song.rhythm || \r\n\t\t\tthis._renderedPitchChannelCount != this._doc.song.pitchChannelCount || \r\n\t\t\tthis._renderedNoiseChannelCount != this._doc.song.noiseChannelCount)\r\n\t\t{\r\n\t\t\tthis._renderedRhythm = this._doc.song.rhythm;\r\n\t\t\tthis._renderedPitchChannelCount = this._doc.song.pitchChannelCount;\r\n\t\t\tthis._renderedNoiseChannelCount = this._doc.song.noiseChannelCount;\r\n\t\t\tthis.resetCopiedPins();\r\n\t\t}\r\n\t\t\r\n\t\tthis._copiedPins = this._copiedPinChannels[this._doc.channel];\r\n\t\t\r\n\t\tif (this._renderedWidth != this._editorWidth || this._renderedHeight != this._editorHeight) {\r\n\t\t\tthis._renderedWidth = this._editorWidth;\r\n\t\t\tthis._renderedHeight = this._editorHeight;\r\n\t\t\tthis._svgBackground.setAttribute(\"width\", \"\" + this._editorWidth);\r\n\t\t\tthis._svgBackground.setAttribute(\"height\", \"\" + this._editorHeight);\r\n\t\t\tthis._svgPlayhead.setAttribute(\"height\", \"\" + this._editorHeight);\r\n\t\t\tthis._selectionRect.setAttribute(\"y\", \"0\");\r\n\t\t\tthis._selectionRect.setAttribute(\"height\", \"\" + this._editorHeight);\r\n\t\t}\r\n\t\t\r\n\t\tconst beatWidth = this._editorWidth / this._doc.song.beatsPerBar;\r\n\t\tif (this._renderedBeatWidth != beatWidth || this._renderedPitchHeight != this._pitchHeight) {\r\n\t\t\tthis._renderedBeatWidth = beatWidth;\r\n\t\t\tthis._renderedPitchHeight = this._pitchHeight;\r\n\t\t\tthis._svgNoteBackground.setAttribute(\"width\", \"\" + beatWidth);\r\n\t\t\tthis._svgNoteBackground.setAttribute(\"height\", \"\" + (this._pitchHeight * Config.pitchesPerOctave));\r\n\t\t\tthis._svgDrumBackground.setAttribute(\"width\", \"\" + beatWidth);\r\n\t\t\tthis._svgDrumBackground.setAttribute(\"height\", \"\" + this._pitchHeight);\r\n\t\t\tthis._backgroundDrumRow.setAttribute(\"width\", \"\" + (beatWidth - 2));\r\n\t\t\tthis._backgroundDrumRow.setAttribute(\"height\", \"\" + (this._pitchHeight - 2));\r\n\t\t\tfor (let j: number = 0; j < Config.pitchesPerOctave; j++) {\r\n\t\t\t\tconst rectangle: SVGRectElement = this._backgroundPitchRows[j];\r\n\t\t\t\tconst y: number = (Config.pitchesPerOctave - j) % Config.pitchesPerOctave;\r\n\t\t\t\trectangle.setAttribute(\"width\", \"\" + (beatWidth - 2));\r\n\t\t\t\trectangle.setAttribute(\"y\", \"\" + (y * this._pitchHeight + 1));\r\n\t\t\t\trectangle.setAttribute(\"height\", \"\" + (this._pitchHeight - 2));\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tif (this._interactive) {\r\n\t\t\tif (!this._mouseDown) this._updateCursorStatus();\r\n\t\t\tthis._updatePreview();\r\n\t\t\tthis._updateSelection();\r\n\t\t}\r\n\t\t\r\n\t\tif (this._renderedFifths != this._doc.prefs.showFifth) {\r\n\t\t\tthis._renderedFifths = this._doc.prefs.showFifth;\r\n\t\t\tthis._backgroundPitchRows[7].setAttribute(\"fill\", this._doc.prefs.showFifth ? ColorConfig.fifthNote : ColorConfig.pitchBackground);\r\n\t\t}\r\n\t\t\r\n\t\tfor (let j: number = 0; j < Config.pitchesPerOctave; j++) {\r\n\t\t\tthis._backgroundPitchRows[j].style.visibility = Config.scales[this._doc.song.scale].flags[j] ? \"visible\" : \"hidden\";\r\n\t\t}\r\n\t\t\r\n\t\tif (this._doc.song.getChannelIsNoise(this._doc.channel)) {\r\n\t\t\tif (!this._renderedDrums) {\r\n\t\t\t\tthis._renderedDrums = true;\r\n\t\t\t\tthis._svgBackground.setAttribute(\"fill\", \"url(#patternEditorDrumBackground\" + this._barOffset + \")\");\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tif (this._renderedDrums) {\r\n\t\t\t\tthis._renderedDrums = false;\r\n\t\t\t\tthis._svgBackground.setAttribute(\"fill\", \"url(#patternEditorNoteBackground\" + this._barOffset + \")\");\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tthis._redrawNotePatterns();\r\n\t}\r\n\t\r\n\tprivate _redrawNotePatterns(): void {\r\n\t\tthis._svgNoteContainer = makeEmptyReplacementElement(this._svgNoteContainer);\r\n\t\t\r\n\t\tif (this._doc.prefs.showChannels) {\r\n\t\t\tfor (let channel: number = this._doc.song.getChannelCount() - 1; channel >= 0; channel--) {\r\n\t\t\t\tif (channel == this._doc.channel) continue;\r\n\t\t\t\tif (this._doc.song.getChannelIsNoise(channel) != this._doc.song.getChannelIsNoise(this._doc.channel)) continue;\r\n\t\t\t\t\r\n\t\t\t\tconst pattern2: Pattern | null = this._doc.song.getPattern(channel, this._doc.bar + this._barOffset);\r\n\t\t\t\tif (pattern2 == null) continue;\r\n\t\t\t\t\r\n\t\t\t\tconst octaveOffset: number = this._doc.getBaseVisibleOctave(channel) * Config.pitchesPerOctave;\r\n\t\t\t\tfor (const note of pattern2.notes) {\r\n\t\t\t\t\tfor (const pitch of note.pitches) {\r\n\t\t\t\t\t\tconst notePath: SVGPathElement = SVG.path();\r\n\t\t\t\t\t\tnotePath.setAttribute(\"fill\", ColorConfig.getChannelColor(this._doc.song, channel).secondaryNote);\r\n\t\t\t\t\t\tnotePath.setAttribute(\"pointer-events\", \"none\");\r\n\t\t\t\t\t\tthis._drawNote(notePath, pitch, note.start, note.pins, this._pitchHeight * 0.19, false, octaveOffset);\r\n\t\t\t\t\t\tthis._svgNoteContainer.appendChild(notePath);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tif (this._pattern != null) {\r\n\t\t\tconst instrument: Instrument = this._doc.song.channels[this._doc.channel].instruments[this._doc.getCurrentInstrument()];\r\n\t\t\tconst chord: Chord = instrument.getChord();\r\n\t\t\tconst transition: Transition = instrument.getTransition();\r\n\t\t\tconst displayNumberedChords: boolean = chord.customInterval || chord.arpeggiates || chord.strumParts > 0 || transition.slides;\r\n\t\t\tfor (const note of this._pattern.notes) {\r\n\t\t\t\tfor (let i: number = 0; i < note.pitches.length; i++) {\r\n\t\t\t\t\tconst pitch: number = note.pitches[i];\r\n\t\t\t\t\tlet notePath: SVGPathElement = SVG.path();\r\n\t\t\t\t\tnotePath.setAttribute(\"fill\", ColorConfig.getChannelColor(this._doc.song, this._doc.channel).secondaryNote);\r\n\t\t\t\t\tnotePath.setAttribute(\"pointer-events\", \"none\");\r\n\t\t\t\t\tthis._drawNote(notePath, pitch, note.start, note.pins, this._pitchHeight / 2 + 1, false, this._octaveOffset);\r\n\t\t\t\t\tthis._svgNoteContainer.appendChild(notePath);\r\n\t\t\t\t\tnotePath = SVG.path();\r\n\t\t\t\t\tnotePath.setAttribute(\"fill\", ColorConfig.getChannelColor(this._doc.song, this._doc.channel).primaryNote);\r\n\t\t\t\t\tnotePath.setAttribute(\"pointer-events\", \"none\");\r\n\t\t\t\t\tthis._drawNote(notePath, pitch, note.start, note.pins, this._pitchHeight / 2 + 1, true, this._octaveOffset);\r\n\t\t\t\t\tthis._svgNoteContainer.appendChild(notePath);\r\n\t\t\t\t\t\r\n\t\t\t\t\tlet indicatorOffset: number = 2;\r\n\t\t\t\t\tif (note.continuesLastPattern) {\r\n\t\t\t\t\t\tconst arrowHeight: number = Math.min(this._pitchHeight, 20);\r\n\t\t\t\t\t\tlet arrowPath: string;\r\n\t\t\t\t\t\tarrowPath  = \"M \" + prettyNumber(this._partWidth * note.start + indicatorOffset)      + \" \" + prettyNumber(this._pitchToPixelHeight(pitch - this._octaveOffset) - 0.1 * arrowHeight);\r\n\t\t\t\t\t\tarrowPath += \"L \" + prettyNumber(this._partWidth * note.start + indicatorOffset)      + \" \" + prettyNumber(this._pitchToPixelHeight(pitch - this._octaveOffset) + 0.1 * arrowHeight);\r\n\t\t\t\t\t\tarrowPath += \"L \" + prettyNumber(this._partWidth * note.start + indicatorOffset + 4)  + \" \" + prettyNumber(this._pitchToPixelHeight(pitch - this._octaveOffset) + 0.1 * arrowHeight);\r\n\t\t\t\t\t\tarrowPath += \"L \" + prettyNumber(this._partWidth * note.start + indicatorOffset + 4)  + \" \" + prettyNumber(this._pitchToPixelHeight(pitch - this._octaveOffset) + 0.3 * arrowHeight);\r\n\t\t\t\t\t\tarrowPath += \"L \" + prettyNumber(this._partWidth * note.start + indicatorOffset + 12) + \" \" + prettyNumber(this._pitchToPixelHeight(pitch - this._octaveOffset));\r\n\t\t\t\t\t\tarrowPath += \"L \" + prettyNumber(this._partWidth * note.start + indicatorOffset + 4)  + \" \" + prettyNumber(this._pitchToPixelHeight(pitch - this._octaveOffset) - 0.3 * arrowHeight);\r\n\t\t\t\t\t\tarrowPath += \"L \" + prettyNumber(this._partWidth * note.start + indicatorOffset + 4)  + \" \" + prettyNumber(this._pitchToPixelHeight(pitch - this._octaveOffset) - 0.1 * arrowHeight);\r\n\t\t\t\t\t\tconst arrow: SVGPathElement = SVG.path();\r\n\t\t\t\t\t\tarrow.setAttribute(\"d\", arrowPath);\r\n\t\t\t\t\t\tarrow.setAttribute(\"fill\", ColorConfig.invertedText);\r\n\t\t\t\t\t\tthis._svgNoteContainer.appendChild(arrow);\r\n\t\t\t\t\t\tindicatorOffset += 12;\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t\tif (note.pitches.length > 1) {\r\n\t\t\t\t\t\tif (displayNumberedChords) {\r\n\t\t\t\t\t\t\tconst oscillatorLabel: SVGTextElement = SVG.text();\r\n\t\t\t\t\t\t\toscillatorLabel.setAttribute(\"x\", \"\" + prettyNumber(this._partWidth * note.start + indicatorOffset));\r\n\t\t\t\t\t\t\toscillatorLabel.setAttribute(\"y\", \"\" + prettyNumber(this._pitchToPixelHeight(pitch - this._octaveOffset)));\r\n\t\t\t\t\t\t\toscillatorLabel.setAttribute(\"width\", \"30\");\r\n\t\t\t\t\t\t\toscillatorLabel.setAttribute(\"fill\", ColorConfig.invertedText);\r\n\t\t\t\t\t\t\toscillatorLabel.setAttribute(\"text-anchor\", \"start\");\r\n\t\t\t\t\t\t\toscillatorLabel.setAttribute(\"dominant-baseline\", \"central\");\r\n\t\t\t\t\t\t\toscillatorLabel.setAttribute(\"pointer-events\", \"none\");\r\n\t\t\t\t\t\t\toscillatorLabel.textContent = \"\" + (i + 1);\r\n\t\t\t\t\t\t\tthis._svgNoteContainer.appendChild(oscillatorLabel);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tthis._doc.currentPatternIsDirty = false;\r\n\t}\r\n\t\r\n\tprivate _drawNote(svgElement: SVGPathElement, pitch: number, start: number, pins: NotePin[], radius: number, showSize: boolean, offset: number): void {\r\n\t\tconst totalWidth: number = this._partWidth * (pins[pins.length - 1].time + pins[0].time);\r\n\t\tconst endOffset: number = 0.5 * Math.min(2, totalWidth - 1);\r\n\t\t\r\n\t\tlet nextPin: NotePin = pins[0];\r\n\t\t\r\n\t\tlet pathString: string = \"M \" + prettyNumber(this._partWidth * (start + nextPin.time) + endOffset) + \" \" + prettyNumber(this._pitchToPixelHeight(pitch - offset) + radius * (showSize ? nextPin.size / Config.noteSizeMax : 1.0)) + \" \";\r\n\t\tfor (let i: number = 1; i < pins.length; i++) {\r\n\t\t\tlet prevPin: NotePin = nextPin;\r\n\t\t\tnextPin = pins[i];\r\n\t\t\tlet prevSide: number = this._partWidth * (start + prevPin.time) + (i == 1 ? endOffset : 0);\r\n\t\t\tlet nextSide: number = this._partWidth * (start + nextPin.time) - (i == pins.length - 1 ? endOffset : 0);\r\n\t\t\tlet prevHeight: number = this._pitchToPixelHeight(pitch + prevPin.interval - offset);\r\n\t\t\tlet nextHeight: number = this._pitchToPixelHeight(pitch + nextPin.interval - offset);\r\n\t\t\tlet prevSize: number = showSize ? prevPin.size / Config.noteSizeMax : 1.0;\r\n\t\t\tlet nextSize: number = showSize ? nextPin.size / Config.noteSizeMax : 1.0;\r\n\t\t\tpathString += \"L \" + prettyNumber(prevSide) + \" \" + prettyNumber(prevHeight - radius * prevSize) + \" \";\r\n\t\t\tif (prevPin.interval > nextPin.interval) pathString += \"L \" + prettyNumber(prevSide + 1) + \" \" + prettyNumber(prevHeight - radius * prevSize) + \" \";\r\n\t\t\tif (prevPin.interval < nextPin.interval) pathString += \"L \" + prettyNumber(nextSide - 1) + \" \" + prettyNumber(nextHeight - radius * nextSize) + \" \";\r\n\t\t\tpathString += \"L \" + prettyNumber(nextSide) + \" \" + prettyNumber(nextHeight - radius * nextSize) + \" \";\r\n\t\t}\r\n\t\tfor (let i: number = pins.length - 2; i >= 0; i--) {\r\n\t\t\tlet prevPin: NotePin = nextPin;\r\n\t\t\tnextPin = pins[i];\r\n\t\t\tlet prevSide: number = this._partWidth * (start + prevPin.time) - (i == pins.length - 2 ? endOffset : 0);\r\n\t\t\tlet nextSide: number = this._partWidth * (start + nextPin.time) + (i == 0 ? endOffset : 0);\r\n\t\t\tlet prevHeight: number = this._pitchToPixelHeight(pitch + prevPin.interval - offset);\r\n\t\t\tlet nextHeight: number = this._pitchToPixelHeight(pitch + nextPin.interval - offset);\r\n\t\t\tlet prevSize: number = showSize ? prevPin.size / Config.noteSizeMax : 1.0;\r\n\t\t\tlet nextSize: number = showSize ? nextPin.size / Config.noteSizeMax : 1.0;\r\n\t\t\tpathString += \"L \" + prettyNumber(prevSide) + \" \" + prettyNumber(prevHeight + radius * prevSize) + \" \";\r\n\t\t\tif (prevPin.interval < nextPin.interval) pathString += \"L \" + prettyNumber(prevSide - 1) + \" \" + prettyNumber(prevHeight + radius * prevSize) + \" \";\r\n\t\t\tif (prevPin.interval > nextPin.interval) pathString += \"L \" + prettyNumber(nextSide + 1) + \" \" + prettyNumber(nextHeight + radius * nextSize) + \" \";\r\n\t\t\tpathString += \"L \" + prettyNumber(nextSide) + \" \" + prettyNumber(nextHeight + radius * nextSize) + \" \";\r\n\t\t}\r\n\t\tpathString += \"z\";\r\n\t\t\r\n\t\tsvgElement.setAttribute(\"d\", pathString);\r\n\t}\r\n\t\r\n\tprivate _pitchToPixelHeight(pitch: number): number {\r\n\t\treturn this._pitchHeight * (this._pitchCount - (pitch) - 0.5);\r\n\t}\r\n}\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nimport {InstrumentType, Config} from \"../synth/SynthConfig\";\r\nimport {Instrument} from \"../synth/synth\";\r\nimport {SongDocument} from \"./SongDocument\";\r\nimport {ChangeSetEnvelopeTarget, ChangeSetEnvelopeType, ChangeRemoveEnvelope} from \"./changes\";\r\nimport {HTML} from \"imperative-html/dist/esm/elements-strict\";\r\n\r\nexport class EnvelopeEditor {\r\n\tpublic readonly container: HTMLElement = HTML.div({class: \"envelopeEditor\"});\r\n\t\r\n\tprivate readonly _rows: HTMLDivElement[] = [];\r\n\tprivate readonly _targetSelects: HTMLSelectElement[] = [];\r\n\tprivate readonly _envelopeSelects: HTMLSelectElement[] = [];\r\n\tprivate readonly _deleteButtons: HTMLButtonElement[] = [];\r\n\tprivate _renderedEnvelopeCount: number = 0;\r\n\tprivate _renderedEqFilterCount: number = -1;\r\n\tprivate _renderedNoteFilterCount: number = -1;\r\n\tprivate _renderedInstrumentType: InstrumentType;\r\n\tprivate _renderedEffects: number = 0;\r\n\t\r\n\tconstructor(private _doc: SongDocument) {\r\n\t\tthis.container.addEventListener(\"change\", this._onChange);\r\n\t\tthis.container.addEventListener(\"click\", this._onClick);\r\n\t}\r\n\t\r\n\tprivate _onChange = (event: Event): void => {\r\n\t\tconst targetSelectIndex: number = this._targetSelects.indexOf(<any> event.target);\r\n\t\tconst envelopeSelectIndex: number = this._envelopeSelects.indexOf(<any> event.target);\r\n\t\tif (targetSelectIndex != -1) {\r\n\t\t\tconst combinedValue: number = parseInt(this._targetSelects[targetSelectIndex].value);\r\n\t\t\tconst target: number = combinedValue % Config.instrumentAutomationTargets.length;\r\n\t\t\tconst index: number = (combinedValue / Config.instrumentAutomationTargets.length) >>> 0;\r\n\t\t\tthis._doc.record(new ChangeSetEnvelopeTarget(this._doc, targetSelectIndex, target, index));\r\n\t\t} else if (envelopeSelectIndex != -1) {\r\n\t\t\tthis._doc.record(new ChangeSetEnvelopeType(this._doc, envelopeSelectIndex, this._envelopeSelects[envelopeSelectIndex].selectedIndex));\r\n\t\t}\r\n\t}\r\n\t\r\n\tprivate _onClick = (event: MouseEvent): void => {\r\n\t\tconst index: number = this._deleteButtons.indexOf(<any> event.target);\r\n\t\tif (index != -1) {\r\n\t\t\tthis._doc.record(new ChangeRemoveEnvelope(this._doc, index));\r\n\t\t}\r\n\t}\r\n\t\r\n\tprivate _makeOption(target: number, index: number): HTMLOptionElement {\r\n\t\tlet displayName = Config.instrumentAutomationTargets[target].displayName;\r\n\t\tif (Config.instrumentAutomationTargets[target].maxCount > 1) {\r\n\t\t\tif (displayName.indexOf(\"#\") != -1) {\r\n\t\t\t\tdisplayName = displayName.replace(\"#\", String(index+1));\r\n\t\t\t} else {\r\n\t\t\t\tdisplayName += \" \" + (index+1);\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn HTML.option({value: target + index * Config.instrumentAutomationTargets.length}, displayName);\r\n\t}\r\n\t\r\n\tprivate _updateTargetOptionVisibility(menu: HTMLSelectElement, instrument: Instrument): void {\r\n\t\tfor (let optionIndex: number = 0; optionIndex < menu.childElementCount; optionIndex++) {\r\n\t\t\tconst option: HTMLOptionElement = <HTMLOptionElement> menu.children[optionIndex];\r\n\t\t\tconst combinedValue: number = parseInt(option.value);\r\n\t\t\tconst target: number = combinedValue % Config.instrumentAutomationTargets.length;\r\n\t\t\tconst index: number = (combinedValue / Config.instrumentAutomationTargets.length) >>> 0;\r\n\t\t\toption.hidden = !instrument.supportsEnvelopeTarget(target, index);\r\n\t\t}\r\n\t}\r\n\t\r\n\tpublic render(): void {\r\n\t\tconst instrument: Instrument = this._doc.song.channels[this._doc.channel].instruments[this._doc.getCurrentInstrument()];\r\n\t\tif (!this._doc.prefs.alwaysShowSettings && instrument.preset != instrument.type) return;\r\n\t\t\r\n\t\tfor (let envelopeIndex: number = this._rows.length; envelopeIndex < instrument.envelopeCount; envelopeIndex++) {\r\n\t\t\tconst targetSelect: HTMLSelectElement = HTML.select();\r\n\t\t\tfor (let target: number = 0; target < Config.instrumentAutomationTargets.length; target++) {\r\n\t\t\t\tconst interleaved: boolean = (Config.instrumentAutomationTargets[target].interleave);\r\n\t\t\t\tfor (let index: number = 0; index < Config.instrumentAutomationTargets[target].maxCount; index++) {\r\n\t\t\t\t\ttargetSelect.appendChild(this._makeOption(target, index));\r\n\t\t\t\t\tif (interleaved) {\r\n\t\t\t\t\t\ttargetSelect.appendChild(this._makeOption(target + 1, index));\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tif (interleaved) target++;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tconst envelopeSelect: HTMLSelectElement = HTML.select();\r\n\t\t\tfor (let envelope: number = 0; envelope < Config.envelopes.length; envelope++) {\r\n\t\t\t\tenvelopeSelect.appendChild(HTML.option({value: envelope}, Config.envelopes[envelope].name));\r\n\t\t\t} \r\n\t\t\t\r\n\t\t\tconst deleteButton: HTMLButtonElement = HTML.button({type: \"button\", class: \"delete-envelope\"});\r\n\t\t\t\r\n\t\t\tconst row: HTMLDivElement = HTML.div({class: \"envelope-row\"},\r\n\t\t\t\tHTML.div({class: \"selectContainer\", style: \"width: 0; flex: 1;\"}, targetSelect),\r\n\t\t\t\tHTML.div({class: \"selectContainer\", style: \"width: 0; flex: 0.7;\"}, envelopeSelect),\r\n\t\t\t\tdeleteButton,\r\n\t\t\t);\r\n\t\t\t\r\n\t\t\tthis.container.appendChild(row);\r\n\t\t\tthis._rows[envelopeIndex] = row;\r\n\t\t\tthis._targetSelects[envelopeIndex] = targetSelect;\r\n\t\t\tthis._envelopeSelects[envelopeIndex] = envelopeSelect;\r\n\t\t\tthis._deleteButtons[envelopeIndex] = deleteButton;\r\n\t\t}\r\n\t\t\r\n\t\tfor (let envelopeIndex: number = this._renderedEnvelopeCount; envelopeIndex < instrument.envelopeCount; envelopeIndex++) {\r\n\t\t\tthis._rows[envelopeIndex].style.display = \"\";\r\n\t\t\t// For newly visible rows, update target option visibiliy.\r\n\t\t\tthis._updateTargetOptionVisibility(this._targetSelects[envelopeIndex], instrument);\r\n\t\t}\r\n\t\t\r\n\t\tfor (let envelopeIndex: number = instrument.envelopeCount; envelopeIndex < this._renderedEnvelopeCount; envelopeIndex++) {\r\n\t\t\tthis._rows[envelopeIndex].style.display = \"none\";\r\n\t\t}\r\n\t\t\r\n\t\tif (this._renderedEqFilterCount != instrument.eqFilter.controlPointCount ||\r\n\t\t\tthis._renderedNoteFilterCount != instrument.noteFilter.controlPointCount ||\r\n\t\t\tthis._renderedInstrumentType != instrument.type ||\r\n\t\t\tthis._renderedEffects != instrument.effects)\r\n\t\t{\r\n\t\t\t// Update target option visibility for previously visible rows.\r\n\t\t\tfor (let envelopeIndex: number = 0; envelopeIndex < this._renderedEnvelopeCount; envelopeIndex++) {\r\n\t\t\t\tthis._updateTargetOptionVisibility(this._targetSelects[envelopeIndex], instrument);\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tfor (let envelopeIndex: number = 0; envelopeIndex < instrument.envelopeCount; envelopeIndex++) {\r\n\t\t\tthis._targetSelects[envelopeIndex].value = String(instrument.envelopes[envelopeIndex].target + instrument.envelopes[envelopeIndex].index * Config.instrumentAutomationTargets.length);\r\n\t\t\tthis._envelopeSelects[envelopeIndex].selectedIndex = instrument.envelopes[envelopeIndex].envelope;\r\n\t\t}\r\n\t\t\r\n\t\tthis._renderedEnvelopeCount = instrument.envelopeCount;\r\n\t\tthis._renderedEqFilterCount = instrument.eqFilter.controlPointCount;\r\n\t\tthis._renderedNoteFilterCount = instrument.noteFilter.controlPointCount;\r\n\t\tthis._renderedInstrumentType = instrument.type;\r\n\t\tthis._renderedEffects = instrument.effects;\r\n\t}\r\n}\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nimport {Config} from \"../synth/SynthConfig\";\r\nimport {clamp, Instrument, Synth} from \"../synth/synth\";\r\nimport {SongDocument} from \"./SongDocument\";\r\nimport {HTML, SVG} from \"imperative-html/dist/esm/elements-strict\";\r\nimport {ColorConfig} from \"./ColorConfig\";\r\nimport {ChangeSequence, UndoableChange} from \"./Change\";\r\nimport {ChangeFadeInOut} from \"./changes\";\r\n\r\nexport class FadeInOutEditor {\r\n\tprivate readonly _editorWidth: number = 120;\r\n\tprivate readonly _editorHeight: number = 26;\r\n\tprivate readonly _fadeCurve: SVGPathElement = SVG.path({fill: ColorConfig.uiWidgetBackground, \"pointer-events\": \"none\"});\r\n\tprivate readonly _dottedLinePath: SVGPathElement = SVG.path({fill: \"none\", stroke: \"currentColor\", \"stroke-width\": 1, \"stroke-dasharray\": \"3, 2\", \"pointer-events\": \"none\"});\r\n\tprivate readonly _controlCurve: SVGPathElement = SVG.path({fill: \"none\", stroke: \"currentColor\", \"stroke-width\": 2, \"pointer-events\": \"none\"});\r\n\tprivate readonly _svg: SVGSVGElement = SVG.svg({style: `background-color: ${ColorConfig.editorBackground}; touch-action: none; cursor: crosshair;`, width: \"100%\", height: \"100%\", viewBox: \"0 0 \"+this._editorWidth+\" \"+this._editorHeight, preserveAspectRatio: \"none\"},\r\n\t\tthis._fadeCurve,\r\n\t\tthis._dottedLinePath,\r\n\t\tthis._controlCurve,\r\n\t);\r\n\tpublic readonly container: HTMLElement = HTML.div({class: \"fadeInOut\", style: \"height: 100%;\"}, this._svg);\r\n\t\r\n\tprivate _mouseX: number = 0;\r\n\tprivate _mouseXStart: number = 0;\r\n\tprivate _mouseDown: boolean = false;\r\n\tprivate _mouseDragging: boolean = false;\r\n\tprivate _draggingFadeIn: boolean = false;\r\n\tprivate _dragChange: UndoableChange | null = null;\r\n\tprivate _renderedFadeIn: number = -1;\r\n\tprivate _renderedFadeOut: number = -1;\r\n\t\r\n\tconstructor(private _doc: SongDocument) {\r\n\t\tconst dottedLineX: number = this._fadeOutToX(Config.fadeOutNeutral);\r\n\t\tthis._dottedLinePath.setAttribute(\"d\", `M ${dottedLineX} 0 L ${dottedLineX} ${this._editorHeight}`);\r\n\t\t\r\n\t\tthis.container.addEventListener(\"mousedown\", this._whenMousePressed);\r\n\t\tdocument.addEventListener(\"mousemove\", this._whenMouseMoved);\r\n\t\tdocument.addEventListener(\"mouseup\", this._whenCursorReleased);\r\n\t\tthis.container.addEventListener(\"touchstart\", this._whenTouchPressed);\r\n\t\tthis.container.addEventListener(\"touchmove\", this._whenTouchMoved);\r\n\t\tthis.container.addEventListener(\"touchend\", this._whenCursorReleased);\r\n\t\tthis.container.addEventListener(\"touchcancel\", this._whenCursorReleased);\r\n\t}\r\n\t\r\n\tprivate _fadeInToX(fadeIn: number) {\r\n\t\treturn 1.0 + (this._editorWidth - 2.0) * 0.4 * fadeIn / (Config.fadeInRange - 1);\r\n\t}\r\n\tprivate _xToFadeIn(x: number) {\r\n\t\treturn clamp(0, Config.fadeInRange, Math.round((x - 1.0) * (Config.fadeInRange - 1) / (0.4 * this._editorWidth - 2.0)));\r\n\t}\r\n\tprivate _fadeOutToX(fadeOut: number) {\r\n\t\treturn 1.0 + (this._editorWidth - 2.0) * (0.5 + 0.5 * fadeOut / (Config.fadeOutTicks.length - 1));\r\n\t}\r\n\tprivate _xToFadeOut(x: number) {\r\n\t\treturn clamp(0, Config.fadeOutTicks.length, Math.round((Config.fadeOutTicks.length - 1) * ((x - 1.0) / (this._editorWidth - 2.0) - 0.5) / 0.5));\r\n\t}\r\n\t\r\n\tprivate _whenMousePressed = (event: MouseEvent): void => {\r\n\t\tevent.preventDefault();\r\n\t\tconst boundingRect: ClientRect = this._svg.getBoundingClientRect();\r\n\t\tthis._mouseX = ((event.clientX || event.pageX) - boundingRect.left);\r\n\t\tthis._whenCursorPressed();\r\n\t}\r\n\t\r\n\tprivate _whenTouchPressed = (event: TouchEvent): void => {\r\n\t\tevent.preventDefault();\r\n\t\tconst boundingRect: ClientRect = this._svg.getBoundingClientRect();\r\n\t\tthis._mouseX = (event.touches[0].clientX - boundingRect.left);\r\n\t\tthis._whenCursorPressed();\r\n\t}\r\n\t\r\n\tprivate _whenCursorPressed(): void {\r\n\t\tif (isNaN(this._mouseX)) this._mouseX = 0;\r\n\t\tthis._mouseXStart = this._mouseX;\r\n\t\tthis._mouseDown = true;\r\n\t\tthis._mouseDragging = false;\r\n\t\tconst instrument: Instrument = this._doc.song.channels[this._doc.channel].instruments[this._doc.getCurrentInstrument()];\r\n\t\tconst fadeInX: number = this._fadeInToX(instrument.fadeIn);\r\n\t\tconst fadeOutX: number = this._fadeOutToX(instrument.fadeOut);\r\n\t\tthis._draggingFadeIn = this._mouseXStart < (fadeInX + fadeOutX) / 2.0;\r\n\t\tthis._dragChange = new ChangeSequence();\r\n\t\tthis._doc.setProspectiveChange(this._dragChange);\r\n\t}\r\n\t\r\n\tprivate _whenMouseMoved = (event: MouseEvent): void => {\r\n\t\tif (this.container.offsetParent == null) return;\r\n\t\tconst boundingRect: ClientRect = this._svg.getBoundingClientRect();\r\n\t\tthis._mouseX = ((event.clientX || event.pageX) - boundingRect.left);\r\n\t\tif (isNaN(this._mouseX)) this._mouseX = 0;\r\n\t\tthis._whenCursorMoved();\r\n\t}\r\n\t\r\n\tprivate _whenTouchMoved = (event: TouchEvent): void => {\r\n\t\tif (this.container.offsetParent == null) return;\r\n\t\tif (!this._mouseDown) return;\r\n\t\tevent.preventDefault();\r\n\t\tconst boundingRect: ClientRect = this._svg.getBoundingClientRect();\r\n\t\tthis._mouseX = (event.touches[0].clientX - boundingRect.left);\r\n\t\tif (isNaN(this._mouseX)) this._mouseX = 0;\r\n\t\tthis._whenCursorMoved();\r\n\t}\r\n\t\r\n\tprivate _whenCursorMoved(): void {\r\n\t\tif (this._dragChange != null && this._doc.lastChangeWas(this._dragChange)) {\r\n\t\t\tthis._dragChange.undo();\r\n\t\t} else {\r\n\t\t\tthis._mouseDown = false;\r\n\t\t}\r\n\t\tthis._dragChange = null;\r\n\t\t\r\n\t\tif (this._mouseDown) {\r\n\t\t\tconst sequence: ChangeSequence = new ChangeSequence();\r\n\t\t\tthis._dragChange = sequence;\r\n\t\t\tthis._doc.setProspectiveChange(this._dragChange);\r\n\t\t\t\r\n\t\t\tif (Math.abs(this._mouseX - this._mouseXStart) > 4.0) {\r\n\t\t\t\tthis._mouseDragging = true;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tif (this._mouseDragging) {\r\n\t\t\t\tconst instrument: Instrument = this._doc.song.channels[this._doc.channel].instruments[this._doc.getCurrentInstrument()];\r\n\t\t\t\tif (this._draggingFadeIn) {\r\n\t\t\t\t\tsequence.append(new ChangeFadeInOut(this._doc, this._xToFadeIn(this._fadeInToX(instrument.fadeIn) + this._mouseX - this._mouseXStart), instrument.fadeOut));\r\n\t\t\t\t} else {\r\n\t\t\t\t\tsequence.append(new ChangeFadeInOut(this._doc, instrument.fadeIn, this._xToFadeOut(this._fadeOutToX(instrument.fadeOut) + this._mouseX - this._mouseXStart)));\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\t\r\n\tprivate _whenCursorReleased = (event: Event): void => {\r\n\t\tif (this.container.offsetParent == null) return;\r\n\t\tif (this._mouseDown && this._doc.lastChangeWas(this._dragChange) && this._dragChange != null) {\r\n\t\t\tif (!this._mouseDragging) {\r\n\t\t\t\tconst instrument: Instrument = this._doc.song.channels[this._doc.channel].instruments[this._doc.getCurrentInstrument()];\r\n\t\t\t\tif (this._draggingFadeIn) {\r\n\t\t\t\t\tthis._doc.record(new ChangeFadeInOut(this._doc, this._xToFadeIn(this._mouseX), instrument.fadeOut));\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis._doc.record(new ChangeFadeInOut(this._doc, instrument.fadeIn, this._xToFadeOut(this._mouseX)));\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\tthis._doc.record(this._dragChange);\r\n\t\t\t}\r\n\t\t}\r\n\t\tthis._dragChange = null;\r\n\t\tthis._mouseDragging = false;\r\n\t\tthis._mouseDown = false;\r\n\t}\r\n\t\r\n\tpublic render(): void {\r\n\t\tconst instrument: Instrument = this._doc.song.channels[this._doc.channel].instruments[this._doc.getCurrentInstrument()];\r\n\t\t\r\n\t\tif (this._renderedFadeIn == instrument.fadeIn && this._renderedFadeOut == instrument.fadeOut) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\t\r\n\t\tconst fadeInX: number = this._fadeInToX(instrument.fadeIn);\r\n\t\tconst fadeOutX: number = this._fadeOutToX(instrument.fadeOut);\r\n\t\tthis._controlCurve.setAttribute(\"d\", `M ${fadeInX} 0 L ${fadeInX} ${this._editorHeight} M ${fadeOutX} 0 L ${fadeOutX} ${this._editorHeight}`);\r\n\t\t\r\n\t\tconst dottedLineX: number = this._fadeOutToX(Config.fadeOutNeutral);\r\n\t\tlet fadePath: string = \"\";\r\n\t\tfadePath += `M 0 ${this._editorHeight} `;\r\n\t\tfadePath += `L ${fadeInX} 0 `;\r\n\t\tif (Synth.fadeOutSettingToTicks(instrument.fadeOut) > 0) {\r\n\t\t\tfadePath += `L ${dottedLineX} 0 `;\r\n\t\t\tfadePath += `L ${fadeOutX} ${this._editorHeight} `;\r\n\t\t} else {\r\n\t\t\tfadePath += `L ${fadeOutX} 0 `;\r\n\t\t\tfadePath += `L ${dottedLineX} ${this._editorHeight} `;\r\n\t\t}\r\n\t\tfadePath += \"z\";\r\n\t\tthis._fadeCurve.setAttribute(\"d\", fadePath);\r\n\t}\r\n}\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nimport {FilterCoefficients, FrequencyResponse} from \"../synth/filtering\";\r\nimport {FilterType, Config} from \"../synth/SynthConfig\";\r\nimport {FilterSettings, FilterControlPoint, Instrument} from \"../synth/synth\";\r\nimport {SongDocument} from \"./SongDocument\";\r\nimport {HTML, SVG} from \"imperative-html/dist/esm/elements-strict\";\r\nimport {ColorConfig} from \"./ColorConfig\";\r\nimport {ChangeSequence, UndoableChange} from \"./Change\";\r\nimport {ChangeFilterAddPoint, ChangeFilterMovePoint} from \"./changes\";\r\nimport {prettyNumber} from \"./EditorConfig\";\r\n\r\nexport class FilterEditor {\r\n\tprivate readonly _editorWidth: number = 120;\r\n\tprivate readonly _editorHeight: number = 26;\r\n\tprivate readonly _responsePath: SVGPathElement = SVG.path({fill: ColorConfig.uiWidgetBackground, \"pointer-events\": \"none\"});\r\n\t//private readonly _octaves: SVGSVGElement = SVG.svg({\"pointer-events\": \"none\", overflow: \"visible\"});\r\n\tprivate readonly _controlPointPath: SVGPathElement = SVG.path({fill: \"currentColor\", \"pointer-events\": \"none\"});\r\n\tprivate readonly _dottedLinePath: SVGPathElement = SVG.path({fill: \"none\", stroke: \"currentColor\", \"stroke-width\": 1, \"stroke-dasharray\": \"3, 2\", \"pointer-events\": \"none\"});\r\n\tprivate readonly _highlight: SVGCircleElement = SVG.circle({fill: \"white\", stroke: \"none\", \"pointer-events\": \"none\", r: 4});\r\n\tprivate readonly _svg: SVGSVGElement = SVG.svg({style: `background-color: ${ColorConfig.editorBackground}; touch-action: none;`, width: \"100%\", height: \"100%\", viewBox: \"0 0 \"+this._editorWidth+\" \"+this._editorHeight, preserveAspectRatio: \"none\"},\r\n\t\tthis._responsePath,\r\n\t\t//this._octaves,\r\n\t\tthis._dottedLinePath,\r\n\t\tthis._highlight,\r\n\t\tthis._controlPointPath,\r\n\t);\r\n\tprivate readonly _label: HTMLDivElement = HTML.div({style: \"position: absolute; bottom: 0; left: 2px; font-size: 8px; line-height: 1; pointer-events: none;\"});\r\n\t\r\n\tpublic readonly container: HTMLElement = HTML.div({class: \"filterEditor\", style: \"height: 100%; position: relative;\"},\r\n\t\tthis._svg,\r\n\t\tthis._label,\r\n\t);\r\n\tprivate readonly _pointRadius: number = 2;\r\n\t\r\n\tprivate _useNoteFilter: boolean = false;\r\n\tprivate _touchMode: boolean = false;\r\n\tprivate _mouseX: number = 0;\r\n\tprivate _mouseY: number = 0;\r\n\tprivate _mouseOver: boolean = false;\r\n\tprivate _mouseDown: boolean = false;\r\n\tprivate _mouseDragging: boolean = false;\r\n\tprivate _addingPoint: boolean = false;\r\n\tprivate _deletingPoint: boolean = false;\r\n\tprivate _addedType: FilterType = FilterType.peak;\r\n\tprivate _selectedIndex: number = 0;\r\n\tprivate _freqStart: number = 0;\r\n\tprivate _gainStart: number = 0;\r\n\tprivate _dragChange: UndoableChange | null = null;\r\n\t\r\n\tprivate _filterSettings: FilterSettings;\r\n\tprivate _renderedSelectedIndex: number = -1;\r\n\tprivate _renderedPointCount: number = -1;\r\n\tprivate _renderedPointTypes: number = -1;\r\n\tprivate _renderedPointFreqs: number = -1;\r\n\tprivate _renderedPointGains: number = -1;\r\n\t//private _renderedKey: number = -1;\r\n\t\r\n\tconstructor(private _doc: SongDocument, useNoteFilter: boolean = false) {\r\n\t\tthis._useNoteFilter = useNoteFilter;\r\n\t\t/*\r\n\t\tfor (let i: number = 0; i < Config.filterFreqRange * Config.filterFreqStep; i++) {\r\n\t\t\tthis._octaves.appendChild(SVG.rect({fill: ColorConfig.tonic, x: i * this._editorWidth / (Config.filterFreqRange * Config.filterFreqStep) - 0.5, y: 0, width: 1, height: this._editorHeight}));\r\n\t\t}\r\n\t\t*/\r\n\t\tthis.container.addEventListener(\"mousedown\", this._whenMousePressed);\r\n\t\tthis.container.addEventListener(\"mouseover\", this._whenMouseOver);\r\n\t\tthis.container.addEventListener(\"mouseout\", this._whenMouseOut);\r\n\t\tdocument.addEventListener(\"mousemove\", this._whenMouseMoved);\r\n\t\tdocument.addEventListener(\"mouseup\", this._whenCursorReleased);\r\n\t\t\r\n\t\tthis.container.addEventListener(\"touchstart\", this._whenTouchPressed);\r\n\t\tthis.container.addEventListener(\"touchmove\", this._whenTouchMoved);\r\n\t\tthis.container.addEventListener(\"touchend\", this._whenCursorReleased);\r\n\t\tthis.container.addEventListener(\"touchcancel\", this._whenCursorReleased);\r\n\t}\r\n\t\r\n\tprivate _xToFreq(x: number): number {\r\n\t\treturn Config.filterFreqRange * x / this._editorWidth - 0.5;\r\n\t}\r\n\tprivate _freqToX(freq: number): number {\r\n\t\treturn this._editorWidth * (freq + 0.5) / Config.filterFreqRange;\r\n\t}\r\n\tprivate _yToGain(y: number): number {\r\n\t\treturn (Config.filterGainRange - 1) * (1 - (y - .5) / (this._editorHeight - 1));\r\n\t}\r\n\tprivate _gainToY(gain: number): number {\r\n\t\treturn (this._editorHeight - 1) * (1 - gain / (Config.filterGainRange - 1)) + .5;\r\n\t}\r\n\t\r\n\tprivate _whenMouseOver = (event: MouseEvent): void => {\r\n\t\tthis._mouseOver = true;\r\n\t}\r\n\t\r\n\tprivate _whenMouseOut = (event: MouseEvent): void => {\r\n\t\tthis._mouseOver = false;\r\n\t\tthis._updatePath();\r\n\t}\r\n\t\r\n\tprivate _whenMousePressed = (event: MouseEvent): void => {\r\n\t\tevent.preventDefault();\r\n\t\tthis._touchMode = false;\r\n\t\tconst boundingRect: ClientRect = this._svg.getBoundingClientRect();\r\n\t\tthis._mouseX = ((event.clientX || event.pageX) - boundingRect.left) * this._editorWidth / (boundingRect.right - boundingRect.left);\r\n\t\tthis._mouseY = ((event.clientY || event.pageY) - boundingRect.top) * this._editorHeight / (boundingRect.bottom - boundingRect.top);\r\n\t\tif (isNaN(this._mouseX)) this._mouseX = 0;\r\n\t\tif (isNaN(this._mouseY)) this._mouseY = 0;\r\n\t\tthis._whenCursorPressed();\r\n\t}\r\n\t\r\n\tprivate _whenTouchPressed = (event: TouchEvent): void => {\r\n\t\tevent.preventDefault();\r\n\t\tthis._touchMode = true;\r\n\t\tconst boundingRect: ClientRect = this._svg.getBoundingClientRect();\r\n\t\tthis._mouseX = (event.touches[0].clientX - boundingRect.left) * this._editorWidth / (boundingRect.right - boundingRect.left);\r\n\t\tthis._mouseY = (event.touches[0].clientY - boundingRect.top) * this._editorHeight / (boundingRect.bottom - boundingRect.top);\r\n\t\tif (isNaN(this._mouseX)) this._mouseX = 0;\r\n\t\tif (isNaN(this._mouseY)) this._mouseY = 0;\r\n\t\tthis._whenCursorPressed();\r\n\t}\r\n\t\r\n\tprivate _whenMouseMoved = (event: MouseEvent): void => {\r\n\t\tif (this.container.offsetParent == null) return;\r\n\t\tconst boundingRect: ClientRect = this._svg.getBoundingClientRect();\r\n\t\tthis._mouseX = ((event.clientX || event.pageX) - boundingRect.left) * this._editorWidth / (boundingRect.right - boundingRect.left);\r\n\t\tthis._mouseY = ((event.clientY || event.pageY) - boundingRect.top) * this._editorHeight / (boundingRect.bottom - boundingRect.top);\r\n\t\tif (isNaN(this._mouseX)) this._mouseX = 0;\r\n\t\tif (isNaN(this._mouseY)) this._mouseY = 0;\r\n\t\tif (!this._mouseDown) this._updateCursor();\r\n\t\tthis._whenCursorMoved();\r\n\t}\r\n\t\r\n\tprivate _whenTouchMoved = (event: TouchEvent): void => {\r\n\t\tif (this.container.offsetParent == null) return;\r\n\t\tif (this._mouseDown) event.preventDefault();\r\n\t\tconst boundingRect: ClientRect = this._svg.getBoundingClientRect();\r\n\t\tthis._mouseX = (event.touches[0].clientX - boundingRect.left) * this._editorWidth / (boundingRect.right - boundingRect.left);\r\n\t\tthis._mouseY = (event.touches[0].clientY - boundingRect.top) * this._editorHeight / (boundingRect.bottom - boundingRect.top);\r\n\t\tif (isNaN(this._mouseX)) this._mouseX = 0;\r\n\t\tif (isNaN(this._mouseY)) this._mouseY = 0;\r\n\t\tif (!this._mouseDown) this._updateCursor();\r\n\t\tthis._whenCursorMoved();\r\n\t}\r\n\t\r\n\tprivate _whenCursorPressed(): void {\r\n\t\tthis._mouseDown = true;\r\n\t\tconst sequence: ChangeSequence = new ChangeSequence();\r\n\t\tthis._dragChange = sequence;\r\n\t\tthis._doc.setProspectiveChange(this._dragChange);\r\n\t\tthis._updateCursor();\r\n\t\tthis._whenCursorMoved();\r\n\t}\r\n\t\r\n\tprivate _updateCursor(): void {\r\n\t\tthis._freqStart = this._xToFreq(this._mouseX);\r\n\t\tthis._gainStart = this._yToGain(this._mouseY);\r\n\t\t\r\n\t\tthis._addingPoint = true;\r\n\t\tthis._selectedIndex = -1;\r\n\t\tlet nearestDistance: number = Number.POSITIVE_INFINITY;\r\n\t\tfor (let i: number = 0; i < this._filterSettings.controlPointCount; i++) {\r\n\t\t\tconst point: FilterControlPoint = this._filterSettings.controlPoints[i];\r\n\t\t\tconst distance: number = Math.sqrt(Math.pow(this._freqToX(point.freq) - this._mouseX, 2) + Math.pow(this._gainToY(point.gain) - this._mouseY, 2));\r\n\t\t\tif ((distance <= 13 || this._filterSettings.controlPointCount >= Config.filterMaxPoints) && distance < nearestDistance) {\r\n\t\t\t\tnearestDistance = distance;\r\n\t\t\t\tthis._selectedIndex = i;\r\n\t\t\t\tthis._addingPoint = false;\r\n\t\t\t}\r\n\t\t}\r\n\t\tif (this._addingPoint) {\r\n\t\t\tconst ratio: number = this._mouseX / this._editorWidth;\r\n\t\t\tif (ratio < 0.2) {\r\n\t\t\t\tthis._addedType = FilterType.highPass;\r\n\t\t\t} else if (ratio < 0.8) {\r\n\t\t\t\tthis._addedType = FilterType.peak;\r\n\t\t\t} else {\r\n\t\t\t\tthis._addedType = FilterType.lowPass;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\t\r\n\tprivate _whenCursorMoved(): void {\r\n\t\tif (this._dragChange != null && this._doc.lastChangeWas(this._dragChange)) {\r\n\t\t\tthis._dragChange.undo();\r\n\t\t} else {\r\n\t\t\tthis._mouseDown = false;\r\n\t\t}\r\n\t\tthis._dragChange = null;\r\n\t\tthis._deletingPoint = false;\r\n\t\t\r\n\t\tif (this._mouseDown) {\r\n\t\t\tconst sequence: ChangeSequence = new ChangeSequence();\r\n\t\t\tthis._dragChange = sequence;\r\n\t\t\tthis._doc.setProspectiveChange(this._dragChange);\r\n\t\t\t\r\n\t\t\tif (this._addingPoint) {\r\n\t\t\t\tconst gain: number = Math.max(0, Math.min(Config.filterGainRange - 1, Math.round(this._yToGain(this._mouseY))));\r\n\t\t\t\tconst freq: number = this._findNearestFreqSlot(this._filterSettings, this._xToFreq(this._mouseX), -1);\r\n\t\t\t\tif (freq >= 0 && freq < Config.filterFreqRange) {\r\n\t\t\t\t\tconst point: FilterControlPoint = new FilterControlPoint();\r\n\t\t\t\t\tpoint.type = this._addedType;\r\n\t\t\t\t\tpoint.freq = freq;\r\n\t\t\t\t\tpoint.gain = gain;\r\n\t\t\t\t\tsequence.append(new ChangeFilterAddPoint(this._doc, this._filterSettings, point, this._filterSettings.controlPointCount, this._useNoteFilter));\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis._deletingPoint = true;\r\n\t\t\t\t}\r\n\t\t\t} else if (this._selectedIndex >= this._filterSettings.controlPointCount || this._selectedIndex == -1) {\r\n\t\t\t\tthis._dragChange = null;\r\n\t\t\t\tthis._mouseDown = false;\r\n\t\t\t} else {\r\n\t\t\t\tconst freqDelta: number = this._xToFreq(this._mouseX) - this._freqStart;\r\n\t\t\t\tconst gainDelta: number = this._yToGain(this._mouseY) - this._gainStart;\r\n\t\t\t\tconst point: FilterControlPoint = this._filterSettings.controlPoints[this._selectedIndex];\r\n\t\t\t\tconst gain: number = Math.max(0, Math.min(Config.filterGainRange - 1, Math.round(point.gain + gainDelta)));\r\n\t\t\t\tconst freq: number = this._findNearestFreqSlot(this._filterSettings, point.freq + freqDelta, this._selectedIndex);\r\n\t\t\t\t\r\n\t\t\t\tif (Math.round(freqDelta) != 0.0 || Math.round(gainDelta) != 0.0 || freq != point.freq || gain != point.gain) {\r\n\t\t\t\t\tthis._mouseDragging = true;\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tif (freq >= 0 && freq < Config.filterFreqRange) {\r\n\t\t\t\t\tsequence.append(new ChangeFilterMovePoint(this._doc, point, point.freq, freq, point.gain, gain));\r\n\t\t\t\t} else {\r\n\t\t\t\t\tsequence.append(new ChangeFilterAddPoint(this._doc, this._filterSettings, point, this._selectedIndex, this._useNoteFilter, true));\r\n\t\t\t\t\tthis._deletingPoint = true;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\tif (this._mouseDown || this._mouseOver) {\r\n\t\t\tthis._updatePath();\r\n\t\t}\r\n\t}\r\n\t\r\n\tprivate _whenCursorReleased = (event: Event): void => {\r\n\t\tif (this.container.offsetParent == null) return;\r\n\t\tif (this._mouseDown && this._doc.lastChangeWas(this._dragChange) && this._dragChange != null) {\r\n\t\t\tif (!this._addingPoint && !this._mouseDragging && !this._touchMode) {\r\n\t\t\t\tif (this._selectedIndex < this._filterSettings.controlPointCount && this._selectedIndex != -1) {\r\n\t\t\t\t\tconst point: FilterControlPoint = this._filterSettings.controlPoints[this._selectedIndex];\r\n\t\t\t\t\tthis._doc.record(new ChangeFilterAddPoint(this._doc, this._filterSettings, point, this._selectedIndex, this._useNoteFilter, true));\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\tthis._doc.record(this._dragChange);\r\n\t\t\t}\r\n\t\t\tthis._updatePath();\r\n\t\t}\r\n\t\tthis._dragChange = null;\r\n\t\tthis._mouseDragging = false;\r\n\t\tthis._deletingPoint = false;\r\n\t\tthis._mouseDown = false;\r\n\t\tthis._updateCursor();\r\n\t}\r\n\t\r\n\tprivate _findNearestFreqSlot(filterSettings: FilterSettings, targetFreq: number, ignoreIndex: number): number {\r\n\t\tconst roundedFreq: number = Math.round(targetFreq);\r\n\t\tlet lowerFreq: number = roundedFreq;\r\n\t\tlet upperFreq: number = roundedFreq;\r\n\t\tlet tryingLower: boolean = (roundedFreq <= targetFreq);\r\n\t\twhile (true) {\r\n\t\t\tlet foundConflict: boolean = false;\r\n\t\t\tconst currentFreq: number = tryingLower ? lowerFreq : upperFreq;\r\n\t\t\tfor (let i: number = 0; i < filterSettings.controlPointCount; i++) {\r\n\t\t\t\tif (i == ignoreIndex) continue;\r\n\t\t\t\tif (filterSettings.controlPoints[i].freq == currentFreq) {\r\n\t\t\t\t\tfoundConflict = true;\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tif (!foundConflict) return currentFreq;\r\n\t\t\ttryingLower = !tryingLower;\r\n\t\t\tif (tryingLower) lowerFreq--;\r\n\t\t\tif (!tryingLower) upperFreq++;\r\n\t\t}\r\n\t}\r\n\t\r\n\tprivate static _circlePath(cx: number, cy: number, radius: number, reverse: boolean = false): string {\r\n\t\treturn `M ${cx - radius} ${cy} ` +\r\n\t\t\t`a ${radius} ${radius} 0 1 ${reverse?1:0} ${ radius * 2} 0 ` +\r\n\t\t\t`a ${radius} ${radius} 0 1 ${reverse?1:0} ${-radius * 2} 0 `;\r\n\t}\r\n\t\r\n\tprivate _updatePath(): void {\r\n\t\tthis._highlight.style.display = \"none\";\r\n\t\tthis._label.textContent = \"\";\r\n\t\t\r\n\t\tlet controlPointPath: string = \"\";\r\n\t\tlet dottedLinePath: string = \"\";\r\n\t\tfor (let i: number = 0; i < this._filterSettings.controlPointCount; i++) {\r\n\t\t\tconst point: FilterControlPoint = this._filterSettings.controlPoints[i];\r\n\t\t\tconst pointX: number = this._freqToX(point.freq);\r\n\t\t\tconst pointY: number = this._gainToY(point.gain);\r\n\t\t\t\r\n\t\t\tcontrolPointPath += FilterEditor._circlePath(pointX, pointY, this._pointRadius);\r\n\t\t\t\r\n\t\t\tif (point.type == FilterType.highPass) {\r\n\t\t\t\tdottedLinePath += \"M \" + 0 + \" \" + pointY + \" L \" + pointX + \" \" + pointY + \" \";\r\n\t\t\t} else if (point.type == FilterType.lowPass) {\r\n\t\t\t\tdottedLinePath += \"M \" + this._editorWidth + \" \" + pointY + \" L \" + pointX + \" \" + pointY + \" \";\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tif (this._selectedIndex == i && this._mouseOver && !this._mouseDown) {\r\n\t\t\t\tthis._highlight.setAttribute(\"cx\", String(pointX));\r\n\t\t\t\tthis._highlight.setAttribute(\"cy\", String(pointY));\r\n\t\t\t\tthis._highlight.style.display = \"\";\r\n\t\t\t}\r\n\t\t\tif ((this._selectedIndex == i || (this._addingPoint && this._mouseDown && i == this._filterSettings.controlPointCount - 1)) && (this._mouseOver || this._mouseDown) && !this._deletingPoint) {\r\n\t\t\t\tthis._label.textContent = (i + 1) + \": \" + Config.filterTypeNames[point.type];// + \" \" + prettyNumber(point.getHz()) + \"Hz\";\r\n\t\t\t}\r\n\t\t}\r\n\t\tthis._controlPointPath.setAttribute(\"d\", controlPointPath);\r\n\t\tthis._dottedLinePath.setAttribute(\"d\", dottedLinePath);\r\n\t\tif (this._addingPoint && !this._mouseDown && this._mouseOver) {\r\n\t\t\tthis._label.textContent = \"+ \" + Config.filterTypeNames[this._addedType];\r\n\t\t}\r\n\t\t\r\n\t\t//let volumeCompensation: number = 1.0;\r\n\t\tconst standardSampleRate: number = 44800;\r\n\t\tconst filters: FilterCoefficients[] = [];\r\n\t\tfor (let i: number = 0; i < this._filterSettings.controlPointCount; i++) {\r\n\t\t\tconst point: FilterControlPoint = this._filterSettings.controlPoints[i];\r\n\t\t\tconst filter: FilterCoefficients = new FilterCoefficients();\r\n\t\t\tpoint.toCoefficients(filter, standardSampleRate);\r\n\t\t\tfilters.push(filter);\r\n\t\t\t//volumeCompensation *= point.getVolumeCompensationMult();\r\n\t\t}\r\n\t\t\r\n\t\tconst response: FrequencyResponse = new FrequencyResponse();\r\n\t\tlet responsePath: string = \"M 0 \" + this._editorHeight + \" \";\r\n\t\tfor (let i: number = -1; i <= Config.filterFreqRange; i++) {\r\n\t\t\tconst hz: number = FilterControlPoint.getHzFromSettingValue(i);\r\n\t\t\tconst cornerRadiansPerSample: number = 2.0 * Math.PI * hz / standardSampleRate;\r\n\t\t\tconst real: number = Math.cos(cornerRadiansPerSample);\r\n\t\t\tconst imag: number = Math.sin(cornerRadiansPerSample);\r\n\t\t\t\r\n\t\t\tlet linearGain: number = 1.0; //volumeCompensation;\r\n\t\t\tfor (const filter of filters) {\r\n\t\t\t\tresponse.analyzeComplex(filter, real, imag);\r\n\t\t\t\tlinearGain *= response.magnitude();\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tconst gainSetting: number = Math.log2(linearGain) / Config.filterGainStep + Config.filterGainCenter;\r\n\t\t\tconst y: number = this._gainToY(gainSetting);\r\n\t\t\tconst x: number = this._freqToX(i);\r\n\t\t\tresponsePath += \"L \" + prettyNumber(x) + \" \" + prettyNumber(y) + \" \";\r\n\t\t}\r\n\t\t\r\n\t\tresponsePath += \"L \" + this._editorWidth + \" \" + this._editorHeight + \" L 0 \" + this._editorHeight + \" z \";\r\n\t\tthis._responsePath.setAttribute(\"d\", responsePath);\r\n\t}\r\n\t\r\n\tpublic render(): void {\r\n\t\tconst instrument: Instrument = this._doc.song.channels[this._doc.channel].instruments[this._doc.getCurrentInstrument()];\r\n\t\tconst filterSettings: FilterSettings = this._useNoteFilter ? instrument.noteFilter : instrument.eqFilter;\r\n\t\tif (this._filterSettings != filterSettings) {\r\n\t\t\tthis._dragChange = null;\r\n\t\t\tthis._mouseDown = false;\r\n\t\t}\r\n\t\tthis._filterSettings = filterSettings;\r\n\t\tif (!this._mouseDown) this._updateCursor();\r\n\t\t\r\n\t\tlet pointTypes: number = 0;\r\n\t\tlet pointFreqs: number = 0;\r\n\t\tlet pointGains: number = 0;\r\n\t\tfor (let i: number = 0; i < filterSettings.controlPointCount; i++) {\r\n\t\t\tconst point: FilterControlPoint = filterSettings.controlPoints[i];\r\n\t\t\tpointTypes = pointTypes * FilterType.length      + point.type;\r\n\t\t\tpointFreqs = pointFreqs * Config.filterFreqRange + point.freq;\r\n\t\t\tpointGains = pointGains * Config.filterGainRange + point.gain;\r\n\t\t}\r\n\t\tif (this._renderedSelectedIndex != this._selectedIndex ||\r\n\t\t\tthis._renderedPointCount != filterSettings.controlPointCount ||\r\n\t\t\tthis._renderedPointTypes != pointTypes ||\r\n\t\t\tthis._renderedPointFreqs != pointFreqs ||\r\n\t\t\tthis._renderedPointGains != pointGains)\r\n\t\t{\r\n\t\t\tthis._renderedSelectedIndex = this._selectedIndex;\r\n\t\t\tthis._renderedPointCount = filterSettings.controlPointCount;\r\n\t\t\tthis._renderedPointTypes = pointTypes;\r\n\t\t\tthis._renderedPointFreqs = pointFreqs;\r\n\t\t\tthis._renderedPointGains = pointGains;\r\n\t\t\tthis._updatePath();\r\n\t\t}\r\n\t\t\r\n\t\t/*\r\n\t\tif (this._renderedKey != this._doc.song.key) {\r\n\t\t\tthis._renderedKey = this._doc.song.key;\r\n\t\t\tconst tonicHz: number = Instrument.frequencyFromPitch(Config.keys[this._doc.song.key].basePitch);\r\n\t\t\tconst x: number = this._freqToX(FilterControlPoint.getSettingValueFromHz(tonicHz));\r\n\t\t\tthis._octaves.setAttribute(\"x\", String(x));\r\n\t\t}\r\n\t\t*/\r\n\t}\r\n}\r\n","// Copyright (C) 2021 John Nesky, distributed under the MIT license.\r\n\r\nimport {Pattern} from \"../synth/synth\";\r\nimport {ColorConfig, ChannelColors} from \"./ColorConfig\";\r\nimport {SongDocument} from \"./SongDocument\";\r\nimport {HTML} from \"imperative-html/dist/esm/elements-strict\";\r\n\r\nexport class Box {\r\n\tprivate readonly _text: Text = document.createTextNode(\"\");\r\n\tprivate readonly _label: HTMLElement = HTML.div({class: \"channelBoxLabel\"}, this._text);\r\n\tpublic readonly container: HTMLElement = HTML.div({class: \"channelBox\", style: `margin: 1px; height: ${ChannelRow.patternHeight - 2}px;`}, this._label);\r\n\tprivate _renderedIndex: number = -1;\r\n\tconstructor(channel: number, color: string) {\r\n\t\tthis.container.style.background = ColorConfig.uiWidgetBackground;\r\n\t\tthis._label.style.color = color;\r\n\t}\r\n\t\r\n\tpublic setWidth(width: number): void {\r\n\t\tthis.container.style.width = (width - 2) + \"px\"; // there's a 1 pixel margin on either side.\r\n\t}\r\n\t\r\n\tpublic setIndex(index: number, selected: boolean, color: string): void {\r\n\t\tif (this._renderedIndex != index) {\r\n\t\t\tthis._renderedIndex = index;\r\n\t\t\tthis._text.data = String(index);\r\n\t\t}\r\n\t\tthis._label.style.color = selected ? ColorConfig.invertedText : color;\r\n\t\tthis.container.style.background = selected ? color : (index == 0) ? \"none\" : ColorConfig.uiWidgetBackground;\r\n\t}\r\n}\r\n\r\nexport class ChannelRow {\r\n\tpublic static patternHeight: number = 28;\r\n\t\r\n\tprivate _renderedBarWidth: number = -1;\r\n\tprivate _boxes: Box[] = [];\r\n\t\r\n\tpublic readonly container: HTMLElement = HTML.div({class: \"channelRow\"});\r\n\t\r\n\tconstructor(private readonly _doc: SongDocument, public readonly index: number) {}\r\n\t\r\n\tpublic render(): void {\r\n\t\tconst barWidth: number = this._doc.getBarWidth();\r\n\t\tif (this._boxes.length != this._doc.song.barCount) {\r\n\t\t\tfor (let x: number = this._boxes.length; x < this._doc.song.barCount; x++) {\r\n\t\t\t\tconst box: Box = new Box(this.index, ColorConfig.getChannelColor(this._doc.song, this.index).secondaryChannel);\r\n\t\t\t\tbox.setWidth(barWidth);\r\n\t\t\t\tthis.container.appendChild(box.container);\r\n\t\t\t\tthis._boxes[x] = box;\r\n\t\t\t}\r\n\t\t\tfor (let x: number = this._doc.song.barCount; x < this._boxes.length; x++) {\r\n\t\t\t\tthis.container.removeChild(this._boxes[x].container);\r\n\t\t\t}\r\n\t\t\tthis._boxes.length = this._doc.song.barCount;\r\n\t\t}\r\n\t\t\r\n\t\tif (this._renderedBarWidth != barWidth) {\r\n\t\t\tthis._renderedBarWidth = barWidth;\r\n\t\t\tfor (let x: number = 0; x < this._boxes.length; x++) {\r\n\t\t\t\tthis._boxes[x].setWidth(barWidth);\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tfor (let i: number = 0; i < this._boxes.length; i++) {\r\n\t\t\tconst pattern: Pattern | null = this._doc.song.getPattern(this.index, i);\r\n\t\t\tconst selected: boolean = (i == this._doc.bar && this.index == this._doc.channel);\r\n\t\t\tconst dim: boolean = (pattern == null || pattern.notes.length == 0);\r\n\t\t\t\r\n\t\t\tconst box: Box = this._boxes[i];\r\n\t\t\tif (i < this._doc.song.barCount) {\r\n\t\t\t\tconst colors: ChannelColors = ColorConfig.getChannelColor(this._doc.song, this.index);\r\n\t\t\t\tbox.setIndex(this._doc.song.channels[this.index].bars[i], selected, dim && !selected ? colors.secondaryChannel : colors.primaryChannel);\r\n\t\t\t\tbox.container.style.visibility = \"visible\";\r\n\t\t\t} else {\r\n\t\t\t\tbox.container.style.visibility = \"hidden\";\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nimport {SongDocument} from \"./SongDocument\";\r\nimport {HTML} from \"imperative-html/dist/esm/elements-strict\";\r\nimport {ColorConfig} from \"./ColorConfig\";\r\nimport {ChannelRow} from \"./ChannelRow\";\r\n\r\nexport class MuteEditor {\r\n\tprivate _cornerFiller: HTMLDivElement = HTML.div({style: `background: ${ColorConfig.editorBackground}; position: sticky; bottom: 0; left: 0; width: 32px; height: 30px;`});\r\n\t\r\n\tpublic readonly container: HTMLElement = HTML.div({class: \"muteEditor\"});\r\n\t\r\n\tprivate readonly _buttons: HTMLButtonElement[] = [];\r\n\t\r\n\tconstructor(private _doc: SongDocument) {\r\n\t\tthis.container.addEventListener(\"click\", this._onClick);\r\n\t}\r\n\t\r\n\tprivate _onClick = (event: MouseEvent): void => {\r\n\t\tconst index = this._buttons.indexOf(<HTMLButtonElement> event.target);\r\n\t\tif (index == -1) return;\r\n\t\tthis._doc.song.channels[index].muted = !this._doc.song.channels[index].muted;\r\n\t\tthis._doc.notifier.changed();\r\n\t}\r\n\t\r\n\tpublic render(): void {\r\n\t\tif (!this._doc.prefs.enableChannelMuting) return;\r\n\t\t\r\n\t\tif (this._buttons.length != this._doc.song.getChannelCount()) {\r\n\t\t\tfor (let y: number = this._buttons.length; y < this._doc.song.getChannelCount(); y++) {\r\n\t\t\t\tconst muteButton: HTMLButtonElement = HTML.button({class: \"mute-button\", title: \"Mute (M), Mute All (M), Solo (S), Exclude (S)\", style: `height: ${ChannelRow.patternHeight - 4}px; margin: 2px;`});\r\n\t\t\t\tthis.container.appendChild(muteButton);\r\n\t\t\t\tthis._buttons[y] = muteButton;\r\n\t\t\t}\r\n\t\t\tfor (let y: number = this._doc.song.getChannelCount(); y < this._buttons.length; y++) {\r\n\t\t\t\tthis.container.removeChild(this._buttons[y]);\r\n\t\t\t}\r\n\t\t\tthis._buttons.length = this._doc.song.getChannelCount();\r\n\t\t\t\r\n\t\t\t// Always put this at the bottom, below all the other buttons, to cover up the loop editor when scrolling.\r\n\t\t\tthis.container.appendChild(this._cornerFiller);\r\n\t\t}\r\n\t\t\r\n\t\tfor (let y: number = 0; y < this._doc.song.getChannelCount(); y++) {\r\n\t\t\tif (this._doc.song.channels[y].muted) {\r\n\t\t\t\tthis._buttons[y].classList.add(\"muted\");\r\n\t\t\t} else {\r\n\t\t\t\tthis._buttons[y].classList.remove(\"muted\");\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nimport {ColorConfig} from \"./ColorConfig\";\r\nimport {isMobile} from \"./EditorConfig\";\r\nimport {SongDocument} from \"./SongDocument\";\r\nimport {ChannelRow} from \"./ChannelRow\";\r\nimport {HTML, SVG} from \"imperative-html/dist/esm/elements-strict\";\r\n\r\nexport class TrackEditor {\r\n\tprivate readonly _channelRowContainer: HTMLElement = HTML.div({style: \"display: flex; flex-direction: column;\"});\r\n\tprivate readonly _playhead: SVGRectElement = SVG.rect({fill: ColorConfig.playhead, x: 0, y: 0, width: 4, height: 128});\r\n\tprivate readonly _boxHighlight: SVGRectElement = SVG.rect({fill: \"none\", stroke: ColorConfig.hoverPreview, \"stroke-width\": 2, \"pointer-events\": \"none\", x: 1, y: 1, width: 30, height: 30});\r\n\tprivate readonly _upHighlight: SVGPathElement = SVG.path({fill: ColorConfig.invertedText, stroke: ColorConfig.invertedText, \"stroke-width\": 1, \"pointer-events\": \"none\"});\r\n\tprivate readonly _downHighlight: SVGPathElement = SVG.path({fill: ColorConfig.invertedText, stroke: ColorConfig.invertedText, \"stroke-width\": 1, \"pointer-events\": \"none\"});\r\n\tprivate readonly _selectionRect: SVGRectElement = SVG.rect({fill: ColorConfig.boxSelectionFill, stroke: ColorConfig.hoverPreview, \"stroke-width\": 2, \"stroke-dasharray\": \"5, 3\", \"pointer-events\": \"none\", visibility: \"hidden\", x: 1, y: 1, width: 62, height: 62});\r\n\tprivate readonly _svg: SVGSVGElement = SVG.svg({style: `position: absolute; top: 0;`},\r\n\t\tthis._selectionRect,\r\n\t\tthis._boxHighlight,\r\n\t\tthis._upHighlight,\r\n\t\tthis._downHighlight,\r\n\t\tthis._playhead,\r\n\t);\r\n\tprivate readonly _select: HTMLSelectElement = HTML.select({class: \"trackSelectBox\", style: \"background: none; border: none; appearance: none; border-radius: initial; box-shadow: none; color: transparent; position: absolute; touch-action: none;\"});\r\n\tpublic readonly container: HTMLElement = HTML.div({class: \"noSelection\", style: \"position: relative; overflow: hidden;\"},\r\n\t\tthis._channelRowContainer,\r\n\t\tthis._svg,\r\n\t\tthis._select,\r\n\t);\r\n\t\r\n\tprivate readonly _channels: ChannelRow[] = [];\r\n\tprivate _mouseX: number = 0;\r\n\tprivate _mouseY: number = 0;\r\n\tprivate _mouseStartBar: number = 0;\r\n\tprivate _mouseStartChannel: number = 0;\r\n\tprivate _mouseBar: number = 0;\r\n\tprivate _mouseChannel: number = 0;\r\n\tprivate _mouseOver: boolean = false;\r\n\tprivate _mousePressed: boolean = false;\r\n\tprivate _mouseDragging = false;\r\n\tprivate _barWidth: number = 32;\r\n\tprivate _renderedEditorWidth: number = -1;\r\n\tprivate _renderedEditorHeight: number = -1;\r\n\tprivate _renderedPatternCount: number = 0;\r\n\tprivate _renderedPlayhead: number = -1;\r\n\tprivate _touchMode: boolean = isMobile;\r\n\t\r\n\tconstructor(private _doc: SongDocument) {\r\n\t\twindow.requestAnimationFrame(this._animatePlayhead);\r\n\t\tthis._svg.addEventListener(\"mousedown\", this._whenMousePressed);\r\n\t\tdocument.addEventListener(\"mousemove\", this._whenMouseMoved);\r\n\t\tdocument.addEventListener(\"mouseup\", this._whenMouseReleased);\r\n\t\tthis._svg.addEventListener(\"mouseover\", this._whenMouseOver);\r\n\t\tthis._svg.addEventListener(\"mouseout\", this._whenMouseOut);\r\n\t\t\r\n\t\tthis._select.addEventListener(\"change\", this._whenSelectChanged);\r\n\t\tthis._select.addEventListener(\"touchstart\", this._whenSelectPressed);\r\n\t\tthis._select.addEventListener(\"touchmove\", this._whenSelectMoved);\r\n\t\tthis._select.addEventListener(\"touchend\", this._whenSelectReleased);\r\n\t\tthis._select.addEventListener(\"touchcancel\", this._whenSelectReleased);\r\n\t\t\r\n\t\tlet determinedCursorType: boolean = false;\r\n\t\tdocument.addEventListener(\"mousedown\", () => {\r\n\t\t\tif (!determinedCursorType) {\r\n\t\t\t\tthis._touchMode = false;\r\n\t\t\t\tthis._updatePreview();\r\n\t\t\t}\r\n\t\t\tdeterminedCursorType = true;\r\n\t\t}, true);\r\n\t\tdocument.addEventListener(\"touchstart\", () => {\r\n\t\t\tif (!determinedCursorType) {\r\n\t\t\t\tthis._touchMode = true;\r\n\t\t\t\tthis._updatePreview();\r\n\t\t\t}\r\n\t\t\tdeterminedCursorType = true;\r\n\t\t}, true);\r\n\t}\r\n\t\r\n\tprivate _whenSelectChanged = (): void => {\r\n\t\tthis._doc.selection.setPattern(this._select.selectedIndex);\r\n\t}\r\n\t\r\n\tprivate _animatePlayhead = (timestamp: number): void => {\r\n\t\tconst playhead = (this._barWidth * this._doc.synth.playhead - 2);\r\n\t\tif (this._renderedPlayhead != playhead) {\r\n\t\t\tthis._renderedPlayhead = playhead;\r\n\t\t\tthis._playhead.setAttribute(\"x\", \"\" + playhead);\r\n\t\t}\r\n\t\twindow.requestAnimationFrame(this._animatePlayhead);\r\n\t}\r\n\t\r\n\tpublic movePlayheadToMouse(): boolean {\r\n\t\tif (this._mouseOver) {\r\n\t\t\tthis._doc.synth.playhead = this._mouseBar + (this._mouseX % this._barWidth) / this._barWidth;\r\n\t\t\treturn true;\r\n\t\t}\r\n\t\treturn false;\r\n\t}\r\n\t\r\n\tprivate _dragBoxSelection(): void {\r\n\t\tthis._doc.selection.setTrackSelection(this._doc.selection.boxSelectionX0, this._mouseBar, this._doc.selection.boxSelectionY0, this._mouseChannel);\r\n\t\tthis._doc.selection.selectionUpdated();\r\n\t}\r\n\t\r\n\tprivate _updateSelectPos(event: TouchEvent): void {\r\n\t\tconst boundingRect: ClientRect = this._svg.getBoundingClientRect();\r\n\t\tthis._mouseX = event.touches[0].clientX - boundingRect.left;\r\n\t\tthis._mouseY = event.touches[0].clientY - boundingRect.top;\r\n\t\tif (isNaN(this._mouseX)) this._mouseX = 0;\r\n\t\tif (isNaN(this._mouseY)) this._mouseY = 0;\r\n\t\tthis._mouseBar = Math.floor(Math.min(this._doc.song.barCount - 1, Math.max(0, this._mouseX / this._barWidth)));\r\n\t\tthis._mouseChannel = Math.floor(Math.min(this._doc.song.getChannelCount() - 1, Math.max(0, this._mouseY / ChannelRow.patternHeight)));\r\n\t}\r\n\t\r\n\tprivate _whenSelectPressed = (event: TouchEvent): void => {\r\n\t\tthis._mousePressed = true;\r\n\t\tthis._mouseDragging = true;\r\n\t\tthis._updateSelectPos(event);\r\n\t\tthis._mouseStartBar = this._mouseBar;\r\n\t\tthis._mouseStartChannel = this._mouseChannel;\r\n\t}\r\n\t\r\n\tprivate _whenSelectMoved = (event: TouchEvent): void => {\r\n\t\tthis._updateSelectPos(event);\r\n\t\tif (this._mouseStartBar != this._mouseBar || this._mouseStartChannel != this._mouseChannel) {\r\n\t\t\t// if the touch has started dragging, cancel opening the select menu.\r\n\t\t\tevent.preventDefault();\r\n\t\t}\r\n\t\tif (this._mousePressed) this._dragBoxSelection();\r\n\t\tthis._updatePreview();\r\n\t}\r\n\t\r\n\tprivate _whenSelectReleased = (event: TouchEvent): void => {\r\n\t\tthis._mousePressed = false;\r\n\t\tthis._mouseDragging = false;\r\n\t\tthis._updatePreview();\r\n\t}\r\n\t\r\n\tprivate _whenMouseOver = (event: MouseEvent): void => {\r\n\t\tif (this._mouseOver) return;\r\n\t\tthis._mouseOver = true;\r\n\t}\r\n\t\r\n\tprivate _whenMouseOut = (event: MouseEvent): void => {\r\n\t\tif (!this._mouseOver) return;\r\n\t\tthis._mouseOver = false;\r\n\t}\r\n\t\r\n\tprivate _updateMousePos(event: MouseEvent): void {\r\n\t\tconst boundingRect: ClientRect = this._svg.getBoundingClientRect();\r\n\t\tthis._mouseX = (event.clientX || event.pageX) - boundingRect.left;\r\n\t\tthis._mouseY = (event.clientY || event.pageY) - boundingRect.top;\r\n\t\tthis._mouseBar = Math.floor(Math.min(this._doc.song.barCount - 1, Math.max(0, this._mouseX / this._barWidth)));\r\n\t\tthis._mouseChannel = Math.floor(Math.min(this._doc.song.getChannelCount() - 1, Math.max(0, this._mouseY / ChannelRow.patternHeight)));\r\n\t}\r\n\t\r\n\tprivate _whenMousePressed = (event: MouseEvent): void => {\r\n\t\tevent.preventDefault();\r\n\t\tthis._mousePressed = true;\r\n\t\tthis._updateMousePos(event);\r\n\t\tthis._mouseStartBar = this._mouseBar;\r\n\t\tthis._mouseStartChannel = this._mouseChannel;\r\n\t\tif (event.shiftKey) {\r\n\t\t\tthis._mouseDragging = true;\r\n\t\t\tthis._doc.selection.setTrackSelection(this._doc.selection.boxSelectionX0, this._mouseBar, this._doc.selection.boxSelectionY0, this._mouseChannel);\r\n\t\t\tthis._doc.selection.selectionUpdated();\r\n\t\t} else {\r\n\t\t\tthis._mouseDragging = false;\r\n\t\t\tif (this._doc.channel != this._mouseChannel || this._doc.bar != this._mouseBar) {\r\n\t\t\t\tthis._doc.selection.setChannelBar(this._mouseChannel, this._mouseBar);\r\n\t\t\t\tthis._mouseDragging = true;\r\n\t\t\t}\r\n\t\t\tthis._doc.selection.resetBoxSelection();\r\n\t\t}\r\n\t}\r\n\t\r\n\tprivate _whenMouseMoved = (event: MouseEvent): void => {\r\n\t\tthis._updateMousePos(event);\r\n\t\tif (this._mousePressed) {\r\n\t\t\tif (this._mouseStartBar != this._mouseBar || this._mouseStartChannel != this._mouseChannel) {\r\n\t\t\t\tthis._mouseDragging = true;\r\n\t\t\t}\r\n\t\t\tthis._dragBoxSelection();\r\n\t\t}\r\n\t\tthis._updatePreview();\r\n\t}\r\n\t\r\n\tprivate _whenMouseReleased = (event: MouseEvent): void => {\r\n\t\tif (this._mousePressed && !this._mouseDragging) {\r\n\t\t\tif (this._doc.channel == this._mouseChannel && this._doc.bar == this._mouseBar) {\r\n\t\t\t\tconst up: boolean = (this._mouseY % ChannelRow.patternHeight) < ChannelRow.patternHeight / 2;\r\n\t\t\t\tconst patternCount: number = this._doc.song.patternsPerChannel;\r\n\t\t\t\tthis._doc.selection.setPattern((this._doc.song.channels[this._mouseChannel].bars[this._mouseBar] + (up ? 1 : patternCount)) % (patternCount + 1));\r\n\t\t\t}\r\n\t\t}\r\n\t\tthis._mousePressed = false;\r\n\t\tthis._mouseDragging = false;\r\n\t\tthis._updatePreview();\r\n\t}\r\n\t\r\n\tprivate _updatePreview(): void {\r\n\t\tlet channel: number = this._mouseChannel;\r\n\t\tlet bar: number = this._mouseBar;\r\n\t\t\r\n\t\tif (this._touchMode) {\r\n\t\t\tbar = this._doc.bar;\r\n\t\t\tchannel = this._doc.channel;\r\n\t\t}\r\n\t\t\r\n\t\tconst selected: boolean = (bar == this._doc.bar && channel == this._doc.channel);\r\n\t\t\r\n\t\tif (this._mouseOver && !this._mousePressed && !selected) {\r\n\t\t\tthis._boxHighlight.setAttribute(\"x\", \"\" + (1 + this._barWidth * bar));\r\n\t\t\tthis._boxHighlight.setAttribute(\"y\", \"\" + (1 + (ChannelRow.patternHeight * channel)));\r\n\t\t\tthis._boxHighlight.setAttribute(\"height\", \"\" + (ChannelRow.patternHeight - 2));\r\n\t\t\tthis._boxHighlight.setAttribute(\"width\", \"\" + (this._barWidth - 2));\r\n\t\t\tthis._boxHighlight.style.visibility = \"visible\";\r\n\t\t} else {\r\n\t\t\tthis._boxHighlight.style.visibility = \"hidden\";\r\n\t\t}\r\n\t\t\r\n\t\tif ((this._mouseOver || this._touchMode) && selected) {\r\n\t\t\tconst up: boolean = (this._mouseY % ChannelRow.patternHeight) < ChannelRow.patternHeight / 2;\r\n\t\t\tconst center: number = this._barWidth * (bar + 0.8);\r\n\t\t\tconst middle: number = ChannelRow.patternHeight * (channel + 0.5);\r\n\t\t\tconst base: number = ChannelRow.patternHeight * 0.1;\r\n\t\t\tconst tip: number = ChannelRow.patternHeight * 0.4;\r\n\t\t\tconst width: number = ChannelRow.patternHeight * 0.175;\r\n\t\t\t\r\n\t\t\tthis._upHighlight.setAttribute(\"fill\", up && !this._touchMode ? ColorConfig.hoverPreview : ColorConfig.invertedText);\r\n\t\t\tthis._downHighlight.setAttribute(\"fill\", !up && !this._touchMode ? ColorConfig.hoverPreview : ColorConfig.invertedText);\r\n\t\t\t\r\n\t\t\tthis._upHighlight.setAttribute(\"d\", `M ${center} ${middle - tip} L ${center + width} ${middle - base} L ${center - width} ${middle - base} z`);\r\n\t\t\tthis._downHighlight.setAttribute(\"d\", `M ${center} ${middle + tip} L ${center + width} ${middle + base} L ${center - width} ${middle + base} z`);\r\n\t\t\t\r\n\t\t\tthis._upHighlight.style.visibility = \"visible\";\r\n\t\t\tthis._downHighlight.style.visibility = \"visible\";\r\n\t\t} else {\r\n\t\t\tthis._upHighlight.style.visibility = \"hidden\";\r\n\t\t\tthis._downHighlight.style.visibility = \"hidden\";\r\n\t\t}\r\n\t\t\r\n\t\tthis._select.style.left = (this._barWidth * this._doc.bar) + \"px\";\r\n\t\tthis._select.style.width = this._barWidth + \"px\";\r\n\t\tthis._select.style.top = (ChannelRow.patternHeight * this._doc.channel) + \"px\";\r\n\t\tthis._select.style.height = ChannelRow.patternHeight + \"px\";\r\n\t\t\r\n\t\tconst patternCount: number = this._doc.song.patternsPerChannel + 1;\r\n\t\tfor (let i: number = this._renderedPatternCount; i < patternCount; i++) {\r\n\t\t\tthis._select.appendChild(HTML.option({value: i}, i));\r\n\t\t}\r\n\t\tfor (let i: number = patternCount; i < this._renderedPatternCount; i++) {\r\n\t\t\tthis._select.removeChild(<Node> this._select.lastChild);\r\n\t\t}\r\n\t\tthis._renderedPatternCount = patternCount;\r\n\t\tconst selectedPattern: number = this._doc.song.channels[this._doc.channel].bars[this._doc.bar];\r\n\t\tif (this._select.selectedIndex != selectedPattern) this._select.selectedIndex = selectedPattern;\r\n\t}\r\n\t\r\n\tpublic render(): void {\r\n\t\tthis._barWidth = this._doc.getBarWidth();\r\n\t\t\r\n\t\tif (this._channels.length != this._doc.song.getChannelCount()) {\r\n\t\t\tfor (let y: number = this._channels.length; y < this._doc.song.getChannelCount(); y++) {\r\n\t\t\t\tconst channelRow: ChannelRow = new ChannelRow(this._doc, y);\r\n\t\t\t\tthis._channels[y] = channelRow;\r\n\t\t\t\tthis._channelRowContainer.appendChild(channelRow.container);\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tfor (let y: number = this._doc.song.getChannelCount(); y < this._channels.length; y++) {\r\n\t\t\t\tthis._channelRowContainer.removeChild(this._channels[y].container);\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tthis._channels.length = this._doc.song.getChannelCount();\r\n\t\t\tthis._mousePressed = false;\r\n\t\t}\r\n\t\t\r\n\t\tfor (let j: number = 0; j < this._doc.song.getChannelCount(); j++) {\r\n\t\t\tthis._channels[j].render();\r\n\t\t}\r\n\t\t\r\n\t\tconst editorWidth: number = this._barWidth * this._doc.song.barCount;\r\n\t\tif (this._renderedEditorWidth != editorWidth) {\r\n\t\t\tthis._renderedEditorWidth = editorWidth;\r\n\t\t\tthis._channelRowContainer.style.width = editorWidth + \"px\";\r\n\t\t\tthis.container.style.width = editorWidth + \"px\";\r\n\t\t\tthis._svg.setAttribute(\"width\", editorWidth + \"\");\r\n\t\t\tthis._mousePressed = false;\r\n\t\t}\r\n\t\t\r\n\t\tconst editorHeight: number = this._doc.song.getChannelCount() * ChannelRow.patternHeight;\r\n\t\tif (this._renderedEditorHeight != editorHeight) {\r\n\t\t\tthis._renderedEditorHeight = editorHeight;\r\n\t\t\tthis._svg.setAttribute(\"height\", \"\" + editorHeight);\r\n\t\t\tthis._playhead.setAttribute(\"height\", \"\" + editorHeight);\r\n\t\t\tthis.container.style.height = editorHeight + \"px\";\r\n\t\t}\r\n\t\t\r\n\t\tthis._select.style.display = this._touchMode ? \"\" : \"none\";\r\n\t\t\r\n\t\tif (this._doc.selection.boxSelectionActive) {\r\n\t\t\t// TODO: This causes the selection rectangle to repaint every time the\r\n\t\t\t// editor renders and the selection is visible. Check if anything changed\r\n\t\t\t// before overwriting the attributes?\r\n\t\t\tthis._selectionRect.setAttribute(\"x\", String(this._barWidth * this._doc.selection.boxSelectionBar + 1));\r\n\t\t\tthis._selectionRect.setAttribute(\"y\", String(ChannelRow.patternHeight * this._doc.selection.boxSelectionChannel + 1));\r\n\t\t\tthis._selectionRect.setAttribute(\"width\", String(this._barWidth * this._doc.selection.boxSelectionWidth - 2));\r\n\t\t\tthis._selectionRect.setAttribute(\"height\", String(ChannelRow.patternHeight * this._doc.selection.boxSelectionHeight - 2));\r\n\t\t\tthis._selectionRect.setAttribute(\"visibility\", \"visible\");\r\n\t\t} else {\r\n\t\t\tthis._selectionRect.setAttribute(\"visibility\", \"hidden\");\r\n\t\t}\r\n\t\t\r\n\t\tthis._updatePreview();\r\n\t}\r\n}\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nimport {SongDocument} from \"./SongDocument\";\r\nimport {Layout} from \"./Layout\";\r\nimport {Prompt} from \"./Prompt\";\r\nimport {HTML, SVG} from \"imperative-html/dist/esm/elements-strict\";\r\n\r\nconst {button, label, div, form, h2, input} = HTML;\r\n\r\nexport class LayoutPrompt implements Prompt {\r\n\tprivate readonly _fileInput: HTMLInputElement = input({type: \"file\", accept: \".json,application/json,.mid,.midi,audio/midi,audio/x-midi\"});\r\n\tprivate readonly _okayButton: HTMLButtonElement = button({class: \"okayButton\", style: \"width:45%;\"}, \"Okay\");\r\n\tprivate readonly _cancelButton: HTMLButtonElement = button({class: \"cancelButton\"});\r\n\tprivate readonly _form: HTMLFormElement = form({style: \"display: flex; gap: 10px;\"},\r\n\t\t\tlabel({class: \"layout-option\"},\r\n\t\t\t\tinput({type: \"radio\", name: \"layout\", value: \"small\"}),\r\n\t\t\t\tSVG(`\\\r\n\t\t\t\t\t<svg viewBox=\"-4 -1 28 22\">\r\n\t\t\t\t\t\t<rect x=\"0\" y=\"0\" width=\"20\" height=\"20\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"1\"/>\r\n\t\t\t\t\t\t<rect x=\"2\" y=\"2\" width=\"11\" height=\"10\" fill=\"currentColor\"/>\r\n\t\t\t\t\t\t<rect x=\"14\" y=\"2\" width=\"4\" height=\"16\" fill=\"currentColor\"/>\r\n\t\t\t\t\t\t<rect x=\"2\" y=\"13\" width=\"11\" height=\"5\" fill=\"currentColor\"/>\r\n\t\t\t\t\t</svg>\r\n\t\t\t\t`),\r\n\t\t\t\tdiv(\"Small\"),\r\n\t\t\t),\r\n\t\t\tlabel({class: \"layout-option\"},\r\n\t\t\t\tinput({type: \"radio\", name: \"layout\", value: \"long\"}),\r\n\t\t\t\tSVG(`\\\r\n\t\t\t\t\t<svg viewBox=\"-1 -1 28 22\">\r\n\t\t\t\t\t\t<rect x=\"0\" y=\"0\" width=\"26\" height=\"20\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"1\"/>\r\n\t\t\t\t\t\t<rect x=\"2\" y=\"2\" width=\"12\" height=\"10\" fill=\"currentColor\"/>\r\n\t\t\t\t\t\t<rect x=\"15\" y=\"2\" width=\"4\" height=\"10\" fill=\"currentColor\"/>\r\n\t\t\t\t\t\t<rect x=\"20\" y=\"2\" width=\"4\" height=\"10\" fill=\"currentColor\"/>\r\n\t\t\t\t\t\t<rect x=\"2\" y=\"13\" width=\"22\" height=\"5\" fill=\"currentColor\"/>\r\n\t\t\t\t\t</svg>\r\n\t\t\t\t`),\r\n\t\t\t\tdiv(\"Long\"),\r\n\t\t\t),\r\n\t\t\tlabel({class: \"layout-option\"},\r\n\t\t\t\tinput({type: \"radio\", name: \"layout\", value: \"tall\"}),\r\n\t\t\t\tSVG(`\\\r\n\t\t\t\t\t<svg viewBox=\"-1 -1 28 22\">\r\n\t\t\t\t\t\t<rect x=\"0\" y=\"0\" width=\"26\" height=\"20\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"1\"/>\r\n\t\t\t\t\t\t<rect x=\"11\" y=\"2\" width=\"8\" height=\"16\" fill=\"currentColor\"/>\r\n\t\t\t\t\t\t<rect x=\"20\" y=\"2\" width=\"4\" height=\"16\" fill=\"currentColor\"/>\r\n\t\t\t\t\t\t<rect x=\"2\" y=\"2\" width=\"8\" height=\"16\" fill=\"currentColor\"/>\r\n\t\t\t\t\t</svg>\r\n\t\t\t\t`),\r\n\t\t\t\tdiv(\"Tall\"),\r\n\t\t\t),\r\n\t\t);\r\n\t\r\n\tpublic readonly container: HTMLDivElement = div({class: \"prompt noSelection\", style: \"width: 300px;\"},\r\n\t\th2(\"Layout\"),\r\n\t\tthis._form,\r\n\t\tdiv({style: \"display: flex; flex-direction: row-reverse; justify-content: space-between;\"},\r\n\t\t\tthis._okayButton,\r\n\t\t),\r\n\t\tthis._cancelButton,\r\n\t);\r\n\t\r\n\tconstructor(private _doc: SongDocument) {\r\n\t\tthis._fileInput.select();\r\n\t\tsetTimeout(()=>this._fileInput.focus());\r\n\t\t\r\n\t\tthis._okayButton.addEventListener(\"click\", this._confirm);\r\n\t\tthis._cancelButton.addEventListener(\"click\", this._close);\r\n\t\tthis.container.addEventListener(\"keydown\", this._whenKeyPressed);\r\n\t\t\r\n\t\t(<any> this._form.elements)[\"layout\"].value = this._doc.prefs.layout;\r\n\t}\r\n\t\r\n\tprivate _close = (): void => { \r\n\t\tthis._doc.undo();\r\n\t}\r\n\t\r\n\tpublic cleanUp = (): void => { \r\n\t\tthis._okayButton.removeEventListener(\"click\", this._confirm);\r\n\t\tthis._cancelButton.removeEventListener(\"click\", this._close);\r\n\t\tthis.container.removeEventListener(\"keydown\", this._whenKeyPressed);\r\n\t}\r\n\t\r\n\tprivate _whenKeyPressed = (event: KeyboardEvent): void => {\r\n\t\tif ((<Element> event.target).tagName != \"BUTTON\" && event.keyCode == 13) { // Enter key\r\n\t\t\tthis._confirm();\r\n\t\t}\r\n\t}\r\n\t\r\n\tprivate _confirm = (): void => { \r\n\t\tthis._doc.prefs.layout = (<any> this._form.elements)[\"layout\"].value;\r\n\t\tthis._doc.prefs.save();\r\n\t\tLayout.setLayout(this._doc.prefs.layout);\r\n\t\tthis._close();\r\n\t}\r\n}\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nimport {SongDocument} from \"./SongDocument\";\r\nimport {HTML, SVG} from \"imperative-html/dist/esm/elements-strict\";\r\nimport {ChangeLoop, ChangeChannelBar} from \"./changes\";\r\nimport {ColorConfig} from \"./ColorConfig\";\r\n\r\ninterface Cursor {\r\n\tstartBar: number;\r\n\tmode: number;\r\n}\r\n\r\ninterface Endpoints {\r\n\tstart: number;\r\n\tlength: number;\r\n}\r\n\r\nexport class LoopEditor {\r\n\tprivate readonly _editorHeight: number = 20;\r\n\tprivate readonly _startMode:   number = 0;\r\n\tprivate readonly _endMode:     number = 1;\r\n\tprivate readonly _bothMode:    number = 2;\r\n\t\r\n\tprivate readonly _loop: SVGPathElement = SVG.path({fill: \"none\", stroke: ColorConfig.loopAccent, \"stroke-width\": 4});\r\n\tprivate readonly _highlight: SVGPathElement = SVG.path({fill: ColorConfig.hoverPreview, \"pointer-events\": \"none\"});\r\n\t\r\n\tprivate readonly _svg: SVGSVGElement = SVG.svg({style: `touch-action: pan-y; position: absolute;`, height: this._editorHeight},\r\n\t\tthis._loop,\r\n\t\tthis._highlight,\r\n\t);\r\n\t\r\n\tpublic readonly container: HTMLElement = HTML.div({class: \"loopEditor\"}, this._svg);\r\n\t\r\n\tprivate _barWidth: number = 32;\r\n\tprivate _change: ChangeLoop | null = null;\r\n\tprivate _cursor: Cursor = {startBar: -1, mode: -1};\r\n\tprivate _mouseX: number = 0;\r\n\t//private _mouseY: number = 0;\r\n\tprivate _clientStartX: number = 0;\r\n\tprivate _clientStartY: number = 0;\r\n\tprivate _startedScrolling: boolean = false;\r\n\tprivate _draggingHorizontally: boolean = false;\r\n\tprivate _mouseDown: boolean = false;\r\n\tprivate _mouseOver: boolean = false;\r\n\tprivate _renderedLoopStart: number = -1;\r\n\tprivate _renderedLoopStop: number = -1;\r\n\tprivate _renderedBarCount: number = 0;\r\n\tprivate _renderedBarWidth: number = -1;\r\n\t\r\n\tconstructor(private _doc: SongDocument) {\r\n\t\tthis._updateCursorStatus();\r\n\t\tthis._render();\r\n\t\tthis._doc.notifier.watch(this._documentChanged);\r\n\t\t\r\n\t\tthis.container.addEventListener(\"mousedown\", this._whenMousePressed);\r\n\t\tdocument.addEventListener(\"mousemove\", this._whenMouseMoved);\r\n\t\tdocument.addEventListener(\"mouseup\", this._whenCursorReleased);\r\n\t\tthis.container.addEventListener(\"mouseover\", this._whenMouseOver);\r\n\t\tthis.container.addEventListener(\"mouseout\", this._whenMouseOut);\r\n\t\t\r\n\t\tthis.container.addEventListener(\"touchstart\", this._whenTouchPressed);\r\n\t\tthis.container.addEventListener(\"touchmove\", this._whenTouchMoved);\r\n\t\tthis.container.addEventListener(\"touchend\", this._whenTouchReleased);\r\n\t\tthis.container.addEventListener(\"touchcancel\", this._whenTouchReleased);\r\n\t}\r\n\t\r\n\tprivate _updateCursorStatus(): void {\r\n\t\tconst bar: number = this._mouseX / this._barWidth;\r\n\t\tthis._cursor.startBar = bar;\r\n\t\t\r\n\t\tif (bar > this._doc.song.loopStart - 0.25 && bar < this._doc.song.loopStart + this._doc.song.loopLength + 0.25) {\r\n\t\t\tif (bar - this._doc.song.loopStart < this._doc.song.loopLength * 0.5) {\r\n\t\t\t\tthis._cursor.mode = this._startMode;\r\n\t\t\t} else {\r\n\t\t\t\tthis._cursor.mode = this._endMode;\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tthis._cursor.mode = this._bothMode;\r\n\t\t}\r\n\t}\r\n\t\r\n\tprivate _findEndPoints(middle: number): Endpoints {\r\n\t\tlet start: number = Math.round(middle - this._doc.song.loopLength / 2);\r\n\t\tlet end: number = start + this._doc.song.loopLength;\r\n\t\tif (start < 0) {\r\n\t\t\tend -= start;\r\n\t\t\tstart = 0;\r\n\t\t}\r\n\t\tif (end > this._doc.song.barCount) {\r\n\t\t\tstart -= end - this._doc.song.barCount;\r\n\t\t\tend = this._doc.song.barCount;\r\n\t\t}\r\n\t\treturn {start: start, length: end - start};\r\n\t}\r\n\t\r\n\tprivate _whenMouseOver = (event: MouseEvent): void => {\r\n\t\tif (this._mouseOver) return;\r\n\t\tthis._mouseOver = true;\r\n\t\tthis._updatePreview();\r\n\t}\r\n\t\r\n\tprivate _whenMouseOut = (event: MouseEvent): void => {\r\n\t\tif (!this._mouseOver) return;\r\n\t\tthis._mouseOver = false;\r\n\t\tthis._updatePreview();\r\n\t}\r\n\t\r\n\tprivate _whenMousePressed = (event: MouseEvent): void => {\r\n\t\tevent.preventDefault();\r\n\t\tthis._mouseDown = true;\r\n\t\tconst boundingRect: ClientRect = this._svg.getBoundingClientRect();\r\n\t\tthis._mouseX = (event.clientX || event.pageX) - boundingRect.left;\r\n\t\t//this._mouseY = (event.clientY || event.pageY) - boundingRect.top;\r\n\t\tthis._updateCursorStatus();\r\n\t\tthis._updatePreview();\r\n\t\tthis._whenMouseMoved(event);\r\n\t}\r\n\t\r\n\tprivate _whenTouchPressed = (event: TouchEvent): void => {\r\n\t\t//event.preventDefault();\r\n\t\tthis._mouseDown = true;\r\n\t\tconst boundingRect: ClientRect = this._svg.getBoundingClientRect();\r\n\t\tthis._mouseX = event.touches[0].clientX - boundingRect.left;\r\n\t\t//this._mouseY = event.touches[0].clientY - boundingRect.top;\r\n\t\tthis._updateCursorStatus();\r\n\t\tthis._updatePreview();\r\n\t\t//this._whenTouchMoved(event);\r\n\t\tthis._clientStartX = event.touches[0].clientX;\r\n\t\tthis._clientStartY = event.touches[0].clientY;\r\n\t\tthis._draggingHorizontally = false;\r\n\t\tthis._startedScrolling = false;\r\n\t}\r\n\t\r\n\tprivate _whenMouseMoved = (event: MouseEvent): void => {\r\n\t\tconst boundingRect: ClientRect = this._svg.getBoundingClientRect();\r\n\t\tthis._mouseX = (event.clientX || event.pageX) - boundingRect.left;\r\n\t\t//this._mouseY = (event.clientY || event.pageY) - boundingRect.top;\r\n\t\tthis._whenCursorMoved();\r\n\t}\r\n\t\r\n\tprivate _whenTouchMoved = (event: TouchEvent): void => {\r\n\t\tif (!this._mouseDown) return;\r\n\t\tconst boundingRect: ClientRect = this._svg.getBoundingClientRect();\r\n\t\tthis._mouseX = event.touches[0].clientX - boundingRect.left;\r\n\t\t//this._mouseY = event.touches[0].clientY - boundingRect.top;\r\n\t\t\r\n\t\tif (!this._draggingHorizontally && !this._startedScrolling) {\r\n\t\t\tif (Math.abs(event.touches[0].clientY - this._clientStartY) > 10) {\r\n\t\t\t\tthis._startedScrolling = true;\r\n\t\t\t} else if (Math.abs(event.touches[0].clientX - this._clientStartX) > 10) {\r\n\t\t\t\tthis._draggingHorizontally = true;\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tif (this._draggingHorizontally) {\r\n\t\t\tthis._whenCursorMoved();\r\n\t\t\tevent.preventDefault();\r\n\t\t}\r\n\t}\r\n\t\r\n\tprivate _whenCursorMoved(): void {\r\n\t\tif (this._mouseDown) {\r\n\t\t\tlet oldStart: number = this._doc.song.loopStart;\r\n\t\t\tlet oldEnd: number = this._doc.song.loopStart + this._doc.song.loopLength;\r\n\t\t\tif (this._change != null && this._doc.lastChangeWas(this._change)) {\r\n\t\t\t\toldStart = this._change.oldStart;\r\n\t\t\t\toldEnd = oldStart + this._change.oldLength;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tconst bar: number = this._mouseX / this._barWidth;\r\n\t\t\tlet start: number;\r\n\t\t\tlet end: number;\r\n\t\t\tlet temp: number;\r\n\t\t\tif (this._cursor.mode == this._startMode) {\r\n\t\t\t\tstart = oldStart + Math.round(bar - this._cursor.startBar);\r\n\t\t\t\tend = oldEnd;\r\n\t\t\t\tif (start < 0) start = 0;\r\n\t\t\t\tif (start >= this._doc.song.barCount) start = this._doc.song.barCount;\r\n\t\t\t\tif (start == end) {\r\n\t\t\t\t\tstart = end - 1;\r\n\t\t\t\t} else if (start > end) {\r\n\t\t\t\t\ttemp = start;\r\n\t\t\t\t\tstart = end;\r\n\t\t\t\t\tend = temp;\r\n\t\t\t\t}\r\n\t\t\t\tthis._change = new ChangeLoop(this._doc, oldStart, oldEnd - oldStart, start, end - start);\r\n\t\t\t} else if (this._cursor.mode == this._endMode) {\r\n\t\t\t\tstart = oldStart;\r\n\t\t\t\tend = oldEnd + Math.round(bar - this._cursor.startBar);\r\n\t\t\t\tif (end < 0) end = 0;\r\n\t\t\t\tif (end >= this._doc.song.barCount) end = this._doc.song.barCount;\r\n\t\t\t\tif (end == start) {\r\n\t\t\t\t\tend = start + 1;\r\n\t\t\t\t} else if (end < start) {\r\n\t\t\t\t\ttemp = start;\r\n\t\t\t\t\tstart = end;\r\n\t\t\t\t\tend = temp;\r\n\t\t\t\t}\r\n\t\t\t\tthis._change = new ChangeLoop(this._doc, oldStart, oldEnd - oldStart, start, end - start);\r\n\t\t\t} else if (this._cursor.mode == this._bothMode) {\r\n\t\t\t\tconst endPoints: Endpoints = this._findEndPoints(bar);\r\n\t\t\t\tthis._change = new ChangeLoop(this._doc, oldStart, oldEnd - oldStart, endPoints.start, endPoints.length);\r\n\t\t\t}\r\n\t\t\tthis._doc.synth.jumpIntoLoop();\r\n\t\t\tif (this._doc.prefs.autoFollow) {\r\n\t\t\t\tnew ChangeChannelBar(this._doc, this._doc.channel, Math.floor(this._doc.synth.playhead), true);\r\n\t\t\t}\r\n\t\t\tthis._doc.setProspectiveChange(this._change);\r\n\t\t} else {\r\n\t\t\tthis._updateCursorStatus();\r\n\t\t\tthis._updatePreview();\r\n\t\t}\r\n\t}\r\n\t\r\n\tprivate _whenTouchReleased = (event: TouchEvent): void => {\r\n\t\tevent.preventDefault();\r\n\t\tif (!this._startedScrolling) {\r\n\t\t\tthis._whenCursorMoved();\r\n\t\t\tthis._mouseOver = false;\r\n\t\t\tthis._whenCursorReleased(event);\r\n\t\t\tthis._updatePreview();\r\n\t\t}\r\n\t\tthis._mouseDown = false;\r\n\t}\r\n\t\r\n\tprivate _whenCursorReleased = (event: Event): void => {\r\n\t\tif (this._change != null) this._doc.record(this._change);\r\n\t\tthis._change = null;\r\n\t\tthis._mouseDown = false;\r\n\t\tthis._updateCursorStatus();\r\n\t\tthis._render();\r\n\t}\r\n\t\r\n\tprivate _updatePreview(): void {\r\n\t\tconst showHighlight: boolean = this._mouseOver && !this._mouseDown;\r\n\t\tthis._highlight.style.visibility = showHighlight ? \"visible\" : \"hidden\";\r\n\t\t\r\n\t\tif (showHighlight) {\r\n\t\t\tconst radius: number = this._editorHeight / 2;\r\n\t\t\t\r\n\t\t\tlet highlightStart: number = (this._doc.song.loopStart) * this._barWidth;\r\n\t\t\tlet highlightStop: number = (this._doc.song.loopStart + this._doc.song.loopLength) * this._barWidth;\r\n\t\t\tif (this._cursor.mode == this._startMode) {\r\n\t\t\t\thighlightStop = (this._doc.song.loopStart) * this._barWidth + radius * 2;\r\n\t\t\t} else if (this._cursor.mode == this._endMode) {\r\n\t\t\t\thighlightStart = (this._doc.song.loopStart + this._doc.song.loopLength) * this._barWidth - radius * 2;\r\n\t\t\t} else {\r\n\t\t\t\tconst endPoints: Endpoints = this._findEndPoints(this._cursor.startBar);\r\n\t\t\t\thighlightStart = (endPoints.start) * this._barWidth;\r\n\t\t\t\thighlightStop = (endPoints.start + endPoints.length) * this._barWidth;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tthis._highlight.setAttribute(\"d\",\r\n\t\t\t\t`M ${highlightStart + radius} ${4} ` +\r\n\t\t\t\t`L ${highlightStop - radius} ${4} ` +\r\n\t\t\t\t`A ${radius - 4} ${radius - 4} ${0} ${0} ${1} ${highlightStop - radius} ${this._editorHeight - 4} ` +\r\n\t\t\t\t`L ${highlightStart + radius} ${this._editorHeight - 4} ` +\r\n\t\t\t\t`A ${radius - 4} ${radius - 4} ${0} ${0} ${1} ${highlightStart + radius} ${4} ` +\r\n\t\t\t\t`z`\r\n\t\t\t);\r\n\t\t}\r\n\t}\r\n\t\r\n\tprivate _documentChanged = (): void => {\r\n\t\tthis._render();\r\n\t}\r\n\t\r\n\tprivate _render(): void {\r\n\t\tthis._barWidth = this._doc.getBarWidth();\r\n\t\t\r\n\t\tconst radius: number = this._editorHeight / 2;\r\n\t\tconst loopStart: number = (this._doc.song.loopStart) * this._barWidth;\r\n\t\tconst loopStop: number = (this._doc.song.loopStart + this._doc.song.loopLength) * this._barWidth;\r\n\t\t\r\n\t\tif (this._renderedBarCount != this._doc.song.barCount || this._renderedBarWidth != this._barWidth) {\r\n\t\t\tthis._renderedBarCount = this._doc.song.barCount;\r\n\t\t\tthis._renderedBarWidth = this._barWidth;\r\n\t\t\tconst editorWidth = this._barWidth * this._doc.song.barCount;\r\n\t\t\tthis.container.style.width = editorWidth + \"px\";\r\n\t\t\tthis._svg.setAttribute(\"width\", editorWidth + \"\");\r\n\t\t}\r\n\r\n\t\tif (this._renderedLoopStart != loopStart || this._renderedLoopStop != loopStop) {\r\n\t\t\tthis._renderedLoopStart = loopStart;\r\n\t\t\tthis._renderedLoopStop = loopStop;\r\n\t\t\tthis._loop.setAttribute(\"d\",\r\n\t\t\t\t`M ${loopStart + radius} ${2} ` +\r\n\t\t\t\t`L ${loopStop - radius} ${2} ` +\r\n\t\t\t\t`A ${radius - 2} ${radius - 2} ${0} ${0} ${1} ${loopStop - radius} ${this._editorHeight - 2} ` +\r\n\t\t\t\t`L ${loopStart + radius} ${this._editorHeight - 2} ` +\r\n\t\t\t\t`A ${radius - 2} ${radius - 2} ${0} ${0} ${1} ${loopStart + radius} ${2} ` +\r\n\t\t\t\t`z`\r\n\t\t\t);\r\n\t\t}\r\n\t\t\r\n\t\tthis._updatePreview();\r\n\t}\r\n}\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nimport {Config} from \"../synth/SynthConfig\";\r\nimport {SpectrumWave, Instrument} from \"../synth/synth\";\r\nimport {SongDocument} from \"./SongDocument\";\r\nimport {HTML, SVG} from \"imperative-html/dist/esm/elements-strict\";\r\nimport {ColorConfig} from \"./ColorConfig\";\r\nimport {ChangeSpectrum} from \"./changes\";\r\nimport {prettyNumber} from \"./EditorConfig\";\r\n\r\nexport class SpectrumEditor {\r\n\tprivate readonly _editorWidth: number = 120;\r\n\tprivate readonly _editorHeight: number = 26;\r\n\tprivate readonly _fill: SVGPathElement = SVG.path({fill: ColorConfig.uiWidgetBackground, \"pointer-events\": \"none\"});\r\n\tprivate readonly _octaves: SVGSVGElement = SVG.svg({\"pointer-events\": \"none\"});\r\n\tprivate readonly _fifths: SVGSVGElement = SVG.svg({\"pointer-events\": \"none\"});\r\n\tprivate readonly _curve: SVGPathElement = SVG.path({fill: \"none\", stroke: \"currentColor\", \"stroke-width\": 2, \"pointer-events\": \"none\"});\r\n\tprivate readonly _arrow: SVGPathElement = SVG.path({fill: \"currentColor\", \"pointer-events\": \"none\"});\r\n\tprivate readonly _svg: SVGSVGElement = SVG.svg({style: `background-color: ${ColorConfig.editorBackground}; touch-action: none; cursor: crosshair;`, width: \"100%\", height: \"100%\", viewBox: \"0 0 \"+this._editorWidth+\" \"+this._editorHeight, preserveAspectRatio: \"none\"},\r\n\t\tthis._fill,\r\n\t\tthis._octaves,\r\n\t\tthis._fifths,\r\n\t\tthis._curve,\r\n\t\tthis._arrow,\r\n\t);\r\n\t\r\n\tpublic readonly container: HTMLElement = HTML.div({class: \"spectrum\", style: \"height: 100%;\"}, this._svg);\r\n\t\r\n\tprivate _mouseX: number = 0;\r\n\tprivate _mouseY: number = 0;\r\n\tprivate _freqPrev: number = 0;\r\n\tprivate _ampPrev: number = 0;\r\n\tprivate _mouseDown: boolean = false;\r\n\tprivate _change: ChangeSpectrum | null = null;\r\n\tprivate _renderedPath: String = \"\";\r\n\tprivate _renderedFifths: boolean = true;\r\n\t\r\n\tconstructor(private _doc: SongDocument, private _spectrumIndex: number | null) {\r\n\t\tfor (let i: number = 0; i < Config.spectrumControlPoints; i += Config.spectrumControlPointsPerOctave) {\r\n\t\t\tthis._octaves.appendChild(SVG.rect({fill: ColorConfig.tonic, x: (i+1) * this._editorWidth / (Config.spectrumControlPoints + 2) - 1, y: 0, width: 2, height: this._editorHeight}));\r\n\t\t}\r\n\t\tfor (let i: number = 4; i <= Config.spectrumControlPoints; i += Config.spectrumControlPointsPerOctave) {\r\n\t\t\tthis._fifths.appendChild(SVG.rect({fill: ColorConfig.fifthNote, x: (i+1) * this._editorWidth / (Config.spectrumControlPoints + 2) - 1, y: 0, width: 2, height: this._editorHeight}));\r\n\t\t}\r\n\t\t\r\n\t\tthis.container.addEventListener(\"mousedown\", this._whenMousePressed);\r\n\t\tdocument.addEventListener(\"mousemove\", this._whenMouseMoved);\r\n\t\tdocument.addEventListener(\"mouseup\", this._whenCursorReleased);\r\n\t\t\r\n\t\tthis.container.addEventListener(\"touchstart\", this._whenTouchPressed);\r\n\t\tthis.container.addEventListener(\"touchmove\", this._whenTouchMoved);\r\n\t\tthis.container.addEventListener(\"touchend\", this._whenCursorReleased);\r\n\t\tthis.container.addEventListener(\"touchcancel\", this._whenCursorReleased);\r\n\t}\r\n\t\r\n\tprivate _xToFreq(x: number): number {\r\n\t\treturn (Config.spectrumControlPoints + 2) * x / this._editorWidth - 1;\r\n\t}\r\n\t\r\n\tprivate _yToAmp(y: number): number {\r\n\t\treturn Config.spectrumMax * (1 - (y - 1) / (this._editorHeight - 2));\r\n\t}\r\n\t\r\n\tprivate _whenMousePressed = (event: MouseEvent): void => {\r\n\t\tevent.preventDefault();\r\n\t\tthis._mouseDown = true;\r\n\t\tconst boundingRect: ClientRect = this._svg.getBoundingClientRect();\r\n\t\tthis._mouseX = ((event.clientX || event.pageX) - boundingRect.left) * this._editorWidth / (boundingRect.right - boundingRect.left);\r\n\t\tthis._mouseY = ((event.clientY || event.pageY) - boundingRect.top) * this._editorHeight / (boundingRect.bottom - boundingRect.top);\r\n\t\tif (isNaN(this._mouseX)) this._mouseX = 0;\r\n\t\tif (isNaN(this._mouseY)) this._mouseY = 0;\r\n\t\t\r\n\t\tthis._freqPrev = this._xToFreq(this._mouseX);\r\n\t\tthis._ampPrev = this._yToAmp(this._mouseY);\r\n\t\tthis._whenCursorMoved();\r\n\t}\r\n\t\r\n\tprivate _whenTouchPressed = (event: TouchEvent): void => {\r\n\t\tevent.preventDefault();\r\n\t\tthis._mouseDown = true;\r\n\t\tconst boundingRect: ClientRect = this._svg.getBoundingClientRect();\r\n\t\tthis._mouseX = (event.touches[0].clientX - boundingRect.left) * this._editorWidth / (boundingRect.right - boundingRect.left);\r\n\t\tthis._mouseY = (event.touches[0].clientY - boundingRect.top) * this._editorHeight / (boundingRect.bottom - boundingRect.top);\r\n\t\tif (isNaN(this._mouseX)) this._mouseX = 0;\r\n\t\tif (isNaN(this._mouseY)) this._mouseY = 0;\r\n\t\t\r\n\t\tthis._freqPrev = this._xToFreq(this._mouseX);\r\n\t\tthis._ampPrev = this._yToAmp(this._mouseY);\r\n\t\tthis._whenCursorMoved();\r\n\t}\r\n\t\r\n\tprivate _whenMouseMoved = (event: MouseEvent): void => {\r\n\t\tif (this.container.offsetParent == null) return;\r\n\t\tconst boundingRect: ClientRect = this._svg.getBoundingClientRect();\r\n\t\tthis._mouseX = ((event.clientX || event.pageX) - boundingRect.left) * this._editorWidth / (boundingRect.right - boundingRect.left);\r\n\t\tthis._mouseY = ((event.clientY || event.pageY) - boundingRect.top) * this._editorHeight / (boundingRect.bottom - boundingRect.top);\r\n\t\tif (isNaN(this._mouseX)) this._mouseX = 0;\r\n\t\tif (isNaN(this._mouseY)) this._mouseY = 0;\r\n\t\tthis._whenCursorMoved();\r\n\t}\r\n\t\r\n\tprivate _whenTouchMoved = (event: TouchEvent): void => {\r\n\t\tif (this.container.offsetParent == null) return;\r\n\t\tif (!this._mouseDown) return;\r\n\t\tevent.preventDefault();\r\n\t\tconst boundingRect: ClientRect = this._svg.getBoundingClientRect();\r\n\t\tthis._mouseX = (event.touches[0].clientX - boundingRect.left) * this._editorWidth / (boundingRect.right - boundingRect.left);\r\n\t\tthis._mouseY = (event.touches[0].clientY - boundingRect.top) * this._editorHeight / (boundingRect.bottom - boundingRect.top);\r\n\t\tif (isNaN(this._mouseX)) this._mouseX = 0;\r\n\t\tif (isNaN(this._mouseY)) this._mouseY = 0;\r\n\t\tthis._whenCursorMoved();\r\n\t}\r\n\t\r\n\tprivate _whenCursorMoved(): void {\r\n\t\tif (this._mouseDown) {\r\n\t\t\tconst freq: number = this._xToFreq(this._mouseX);\r\n\t\t\tconst amp: number = this._yToAmp(this._mouseY);\r\n\t\t\t\r\n\t\t\tconst instrument: Instrument = this._doc.song.channels[this._doc.channel].instruments[this._doc.getCurrentInstrument()];\r\n\t\t\tconst spectrumWave: SpectrumWave = (this._spectrumIndex == null) ? instrument.spectrumWave : instrument.drumsetSpectrumWaves[this._spectrumIndex];\r\n\t\t\t\r\n\t\t\tif (freq != this._freqPrev) {\r\n\t\t\t\tconst slope: number = (amp - this._ampPrev) / (freq - this._freqPrev);\r\n\t\t\t\tconst offset: number = this._ampPrev - this._freqPrev * slope;\r\n\t\t\t\tconst lowerFreq: number = Math.ceil(Math.min(this._freqPrev, freq));\r\n\t\t\t\tconst upperFreq: number = Math.floor(Math.max(this._freqPrev, freq));\r\n\t\t\t\tfor (let i: number = lowerFreq; i <= upperFreq; i++) {\r\n\t\t\t\t\tif (i < 0 || i >= Config.spectrumControlPoints) continue;\r\n\t\t\t\t\tspectrumWave.spectrum[i] = Math.max(0, Math.min(Config.spectrumMax, Math.round(i * slope + offset)));\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tspectrumWave.spectrum[Math.max(0, Math.min(Config.spectrumControlPoints - 1, Math.round(freq)))] = Math.max(0, Math.min(Config.spectrumMax, Math.round(amp)));\r\n\t\t\t\r\n\t\t\tthis._freqPrev = freq;\r\n\t\t\tthis._ampPrev = amp;\r\n\t\t\t\r\n\t\t\tthis._change = new ChangeSpectrum(this._doc, instrument, spectrumWave);\r\n\t\t\tthis._doc.setProspectiveChange(this._change);\r\n\t\t}\r\n\t}\r\n\t\r\n\tprivate _whenCursorReleased = (event: Event): void => {\r\n\t\tif (this._mouseDown) {\r\n\t\t\tthis._doc.record(this._change!);\r\n\t\t\tthis._change = null;\r\n\t\t}\r\n\t\tthis._mouseDown = false;\r\n\t}\r\n\t\r\n\tpublic render(): void {\r\n\t\tconst instrument: Instrument = this._doc.song.channels[this._doc.channel].instruments[this._doc.getCurrentInstrument()];\r\n\t\tconst spectrumWave: SpectrumWave = (this._spectrumIndex == null) ? instrument.spectrumWave : instrument.drumsetSpectrumWaves[this._spectrumIndex];\r\n\t\tconst controlPointToHeight = (point: number): number => {\r\n\t\t\treturn (1 - (point / Config.spectrumMax)) * (this._editorHeight - 1) + 1;\r\n\t\t}\r\n\t\t\r\n\t\tlet lastValue: number = 0;\r\n\t\tlet path: string = \"M 0 \" + prettyNumber(this._editorHeight) + \" \";\r\n\t\tfor (let i: number = 0; i < Config.spectrumControlPoints; i++) {\r\n\t\t\tlet nextValue: number = spectrumWave.spectrum[i];\r\n\t\t\tif (lastValue != 0 || nextValue != 0) {\r\n\t\t\t\tpath += \"L \";\r\n\t\t\t} else {\r\n\t\t\t\tpath += \"M \";\r\n\t\t\t}\r\n\t\t\tpath += prettyNumber((i + 1) * this._editorWidth / (Config.spectrumControlPoints + 2)) + \" \" + prettyNumber(controlPointToHeight(nextValue)) + \" \";\r\n\t\t\tlastValue = nextValue;\r\n\t\t}\r\n\t\t\r\n\t\tconst lastHeight: number = controlPointToHeight(lastValue);\r\n\t\tif (lastValue > 0) {\r\n\t\t\tpath += \"L \" + (this._editorWidth - 1) + \" \" + prettyNumber(lastHeight) + \" \";\r\n\t\t}\r\n\t\t\r\n\t\tif (this._renderedPath != path) {\r\n\t\t\tthis._renderedPath = path;\r\n\t\t\tthis._curve.setAttribute(\"d\", path);\r\n\t\t\tthis._fill.setAttribute(\"d\", path + \"L \" + this._editorWidth + \" \" + prettyNumber(lastHeight) + \" L \" + this._editorWidth + \" \" + prettyNumber(this._editorHeight) + \" L 0 \" + prettyNumber(this._editorHeight) + \" z \");\r\n\t\t\t\r\n\t\t\tthis._arrow.setAttribute(\"d\", \"M \" + this._editorWidth + \" \" + prettyNumber(lastHeight) + \" L \" + (this._editorWidth - 4) + \" \" + prettyNumber(lastHeight - 4) + \" L \" + (this._editorWidth - 4) + \" \" + prettyNumber(lastHeight + 4) + \" z\");\r\n\t\t\tthis._arrow.style.display = (lastValue > 0) ? \"\" : \"none\";\r\n\t\t}\r\n\t\tif (this._renderedFifths != this._doc.prefs.showFifth) {\r\n\t\t\tthis._renderedFifths = this._doc.prefs.showFifth;\r\n\t\t\tthis._fifths.style.display = this._doc.prefs.showFifth ? \"\" : \"none\";\r\n\t\t}\r\n\t}\r\n}\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nimport {Config} from \"../synth/SynthConfig\";\r\nimport {HarmonicsWave, Instrument} from \"../synth/synth\";\r\nimport {SongDocument} from \"./SongDocument\";\r\nimport {HTML, SVG} from \"imperative-html/dist/esm/elements-strict\";\r\nimport {ColorConfig} from \"./ColorConfig\";\r\nimport {ChangeHarmonics} from \"./changes\";\r\nimport {prettyNumber} from \"./EditorConfig\";\r\n\r\nexport class HarmonicsEditor {\r\n\tprivate readonly _editorWidth: number = 120;\r\n\tprivate readonly _editorHeight: number = 26;\r\n\tprivate readonly _octaves: SVGSVGElement = SVG.svg({\"pointer-events\": \"none\"});\r\n\tprivate readonly _fifths: SVGSVGElement = SVG.svg({\"pointer-events\": \"none\"});\r\n\tprivate readonly _curve: SVGPathElement = SVG.path({fill: \"none\", stroke: \"currentColor\", \"stroke-width\": 2, \"pointer-events\": \"none\"});\r\n\tprivate readonly _lastControlPoints: SVGRectElement[] = [];\r\n\tprivate readonly _lastControlPointContainer: SVGSVGElement = SVG.svg({\"pointer-events\": \"none\"});\r\n\tprivate readonly _svg: SVGSVGElement = SVG.svg({style: `background-color: ${ColorConfig.editorBackground}; touch-action: none; cursor: crosshair;`, width: \"100%\", height: \"100%\", viewBox: \"0 0 \"+this._editorWidth+\" \"+this._editorHeight, preserveAspectRatio: \"none\"},\r\n\t\tthis._octaves,\r\n\t\tthis._fifths,\r\n\t\tthis._curve,\r\n\t\tthis._lastControlPointContainer,\r\n\t);\r\n\t\r\n\tpublic readonly container: HTMLElement = HTML.div({class: \"harmonics\", style: \"height: 100%;\"}, this._svg);\r\n\t\r\n\tprivate _mouseX: number = 0;\r\n\tprivate _mouseY: number = 0;\r\n\tprivate _freqPrev: number = 0;\r\n\tprivate _ampPrev: number = 0;\r\n\tprivate _mouseDown: boolean = false;\r\n\tprivate _change: ChangeHarmonics | null = null;\r\n\tprivate _renderedPath: String = \"\";\r\n\tprivate _renderedFifths: boolean = true;\r\n\t\r\n\tconstructor(private _doc: SongDocument) {\r\n\t\tfor (let i: number = 1; i <= Config.harmonicsControlPoints; i = i * 2) {\r\n\t\t\tthis._octaves.appendChild(SVG.rect({fill: ColorConfig.tonic, x: (i-0.5) * (this._editorWidth - 8) / (Config.harmonicsControlPoints - 1) - 1, y: 0, width: 2, height: this._editorHeight}));\r\n\t\t}\r\n\t\tfor (let i: number = 3; i <= Config.harmonicsControlPoints; i = i * 2) {\r\n\t\t\tthis._fifths.appendChild(SVG.rect({fill: ColorConfig.fifthNote, x: (i-0.5) * (this._editorWidth - 8) / (Config.harmonicsControlPoints - 1) - 1, y: 0, width: 2, height: this._editorHeight}));\r\n\t\t}\r\n\t\tfor (let i: number = 0; i < 4; i++) {\r\n\t\t\tconst rect: SVGRectElement = SVG.rect({fill: \"currentColor\", x: (this._editorWidth - i * 2 - 1), y: 0, width: 1, height: this._editorHeight});\r\n\t\t\tthis._lastControlPoints.push(rect);\r\n\t\t\tthis._lastControlPointContainer.appendChild(rect);\r\n\t\t}\r\n\t\t\r\n\t\tthis.container.addEventListener(\"mousedown\", this._whenMousePressed);\r\n\t\tdocument.addEventListener(\"mousemove\", this._whenMouseMoved);\r\n\t\tdocument.addEventListener(\"mouseup\", this._whenCursorReleased);\r\n\t\t\r\n\t\tthis.container.addEventListener(\"touchstart\", this._whenTouchPressed);\r\n\t\tthis.container.addEventListener(\"touchmove\", this._whenTouchMoved);\r\n\t\tthis.container.addEventListener(\"touchend\", this._whenCursorReleased);\r\n\t\tthis.container.addEventListener(\"touchcancel\", this._whenCursorReleased);\r\n\t}\r\n\t\r\n\tprivate _xToFreq(x: number): number {\r\n\t\treturn (Config.harmonicsControlPoints - 1) * x / (this._editorWidth - 8) - 0.5;\r\n\t}\r\n\t\r\n\tprivate _yToAmp(y: number): number {\r\n\t\treturn Config.harmonicsMax * (1 - y / this._editorHeight);\r\n\t}\r\n\t\r\n\tprivate _whenMousePressed = (event: MouseEvent): void => {\r\n\t\tevent.preventDefault();\r\n\t\tthis._mouseDown = true;\r\n\t\tconst boundingRect: ClientRect = this._svg.getBoundingClientRect();\r\n\t\tthis._mouseX = ((event.clientX || event.pageX) - boundingRect.left) * this._editorWidth / (boundingRect.right - boundingRect.left);\r\n\t\tthis._mouseY = ((event.clientY || event.pageY) - boundingRect.top) * this._editorHeight / (boundingRect.bottom - boundingRect.top);\r\n\t\tif (isNaN(this._mouseX)) this._mouseX = 0;\r\n\t\tif (isNaN(this._mouseY)) this._mouseY = 0;\r\n\t\t\r\n\t\tthis._freqPrev = this._xToFreq(this._mouseX);\r\n\t\tthis._ampPrev = this._yToAmp(this._mouseY);\r\n\t\tthis._whenCursorMoved();\r\n\t}\r\n\t\r\n\tprivate _whenTouchPressed = (event: TouchEvent): void => {\r\n\t\tevent.preventDefault();\r\n\t\tthis._mouseDown = true;\r\n\t\tconst boundingRect: ClientRect = this._svg.getBoundingClientRect();\r\n\t\tthis._mouseX = (event.touches[0].clientX - boundingRect.left) * this._editorWidth / (boundingRect.right - boundingRect.left);\r\n\t\tthis._mouseY = (event.touches[0].clientY - boundingRect.top) * this._editorHeight / (boundingRect.bottom - boundingRect.top);\r\n\t\tif (isNaN(this._mouseX)) this._mouseX = 0;\r\n\t\tif (isNaN(this._mouseY)) this._mouseY = 0;\r\n\t\t\r\n\t\tthis._freqPrev = this._xToFreq(this._mouseX);\r\n\t\tthis._ampPrev = this._yToAmp(this._mouseY);\r\n\t\tthis._whenCursorMoved();\r\n\t}\r\n\t\r\n\tprivate _whenMouseMoved = (event: MouseEvent): void => {\r\n\t\tif (this.container.offsetParent == null) return;\r\n\t\tconst boundingRect: ClientRect = this._svg.getBoundingClientRect();\r\n\t\tthis._mouseX = ((event.clientX || event.pageX) - boundingRect.left) * this._editorWidth / (boundingRect.right - boundingRect.left);\r\n\t\tthis._mouseY = ((event.clientY || event.pageY) - boundingRect.top) * this._editorHeight / (boundingRect.bottom - boundingRect.top);\r\n\t\tif (isNaN(this._mouseX)) this._mouseX = 0;\r\n\t\tif (isNaN(this._mouseY)) this._mouseY = 0;\r\n\t\tthis._whenCursorMoved();\r\n\t}\r\n\t\r\n\tprivate _whenTouchMoved = (event: TouchEvent): void => {\r\n\t\tif (this.container.offsetParent == null) return;\r\n\t\tif (!this._mouseDown) return;\r\n\t\tevent.preventDefault();\r\n\t\tconst boundingRect: ClientRect = this._svg.getBoundingClientRect();\r\n\t\tthis._mouseX = (event.touches[0].clientX - boundingRect.left) * this._editorWidth / (boundingRect.right - boundingRect.left);\r\n\t\tthis._mouseY = (event.touches[0].clientY - boundingRect.top) * this._editorHeight / (boundingRect.bottom - boundingRect.top);\r\n\t\tif (isNaN(this._mouseX)) this._mouseX = 0;\r\n\t\tif (isNaN(this._mouseY)) this._mouseY = 0;\r\n\t\tthis._whenCursorMoved();\r\n\t}\r\n\t\r\n\tprivate _whenCursorMoved(): void {\r\n\t\tif (this._mouseDown) {\r\n\t\t\tconst freq: number = this._xToFreq(this._mouseX);\r\n\t\t\tconst amp: number = this._yToAmp(this._mouseY);\r\n\t\t\t\r\n\t\t\tconst instrument: Instrument = this._doc.song.channels[this._doc.channel].instruments[this._doc.getCurrentInstrument()];\r\n\t\t\tconst harmonicsWave: HarmonicsWave = instrument.harmonicsWave; //(this._harmonicsIndex == null) ? instrument.harmonicsWave : instrument.drumsetSpectrumWaves[this._harmonicsIndex];\r\n\t\t\t\r\n\t\t\tif (freq != this._freqPrev) {\r\n\t\t\t\tconst slope: number = (amp - this._ampPrev) / (freq - this._freqPrev);\r\n\t\t\t\tconst offset: number = this._ampPrev - this._freqPrev * slope;\r\n\t\t\t\tconst lowerFreq: number = Math.ceil(Math.min(this._freqPrev, freq));\r\n\t\t\t\tconst upperFreq: number = Math.floor(Math.max(this._freqPrev, freq));\r\n\t\t\t\tfor (let i: number = lowerFreq; i <= upperFreq; i++) {\r\n\t\t\t\t\tif (i < 0 || i >= Config.harmonicsControlPoints) continue;\r\n\t\t\t\t\tharmonicsWave.harmonics[i] = Math.max(0, Math.min(Config.harmonicsMax, Math.round(i * slope + offset)));\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tharmonicsWave.harmonics[Math.max(0, Math.min(Config.harmonicsControlPoints - 1, Math.round(freq)))] = Math.max(0, Math.min(Config.harmonicsMax, Math.round(amp)));\r\n\t\t\t\r\n\t\t\tthis._freqPrev = freq;\r\n\t\t\tthis._ampPrev = amp;\r\n\t\t\t\r\n\t\t\tthis._change = new ChangeHarmonics(this._doc, instrument, harmonicsWave);\r\n\t\t\tthis._doc.setProspectiveChange(this._change);\r\n\t\t}\r\n\t}\r\n\t\r\n\tprivate _whenCursorReleased = (event: Event): void => {\r\n\t\tif (this._mouseDown) {\r\n\t\t\tthis._doc.record(this._change!);\r\n\t\t\tthis._change = null;\r\n\t\t}\r\n\t\tthis._mouseDown = false;\r\n\t}\r\n\t\r\n\tpublic render(): void {\r\n\t\tconst instrument: Instrument = this._doc.song.channels[this._doc.channel].instruments[this._doc.getCurrentInstrument()];\r\n\t\tconst harmonicsWave: HarmonicsWave = instrument.harmonicsWave; //(this._harmonicsIndex == null) ? instrument.harmonicsWave : instrument.drumsetSpectrumWaves[this._harmonicsIndex];\r\n\t\tconst controlPointToHeight = (point: number): number => {\r\n\t\t\treturn (1 - (point / Config.harmonicsMax)) * this._editorHeight;\r\n\t\t}\r\n\t\t\r\n\t\tlet bottom: string = prettyNumber(this._editorHeight);\r\n\t\tlet path: string = \"\";\r\n\t\tfor (let i: number = 0; i < Config.harmonicsControlPoints - 1; i++) {\r\n\t\t\tif (harmonicsWave.harmonics[i] == 0) continue;\r\n\t\t\tlet xPos: string = prettyNumber((i + 0.5) * (this._editorWidth - 8) / (Config.harmonicsControlPoints - 1));\r\n\t\t\tpath += \"M \" + xPos + \" \" + bottom + \" \";\r\n\t\t\tpath += \"L \" + xPos + \" \" + prettyNumber(controlPointToHeight(harmonicsWave.harmonics[i])) + \" \";\r\n\t\t}\r\n\t\t\r\n\t\tconst lastHeight: number = controlPointToHeight(harmonicsWave.harmonics[Config.harmonicsControlPoints - 1]);\r\n\t\tfor (let i: number = 0; i < 4; i++) {\r\n\t\t\tconst rect: SVGRectElement = this._lastControlPoints[i];\r\n\t\t\trect.setAttribute(\"y\", prettyNumber(lastHeight));\r\n\t\t\trect.setAttribute(\"height\", prettyNumber(this._editorHeight - lastHeight));\r\n\t\t}\r\n\t\t\r\n\t\tif (this._renderedPath != path) {\r\n\t\t\tthis._renderedPath = path;\r\n\t\t\tthis._curve.setAttribute(\"d\", path);\r\n\t\t}\r\n\t\tif (this._renderedFifths != this._doc.prefs.showFifth) {\r\n\t\t\tthis._renderedFifths = this._doc.prefs.showFifth;\r\n\t\t\tthis._fifths.style.display = this._doc.prefs.showFifth ? \"\" : \"none\";\r\n\t\t}\r\n\t}\r\n}\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nimport {SongDocument} from \"./SongDocument\";\r\nimport {HTML, SVG} from \"imperative-html/dist/esm/elements-strict\";\r\nimport {ColorConfig} from \"./ColorConfig\";\r\n\r\nexport class BarScrollBar {\r\n\tprivate readonly _editorWidth: number = 512;\r\n\tprivate readonly _editorHeight: number = 20;\r\n\t\r\n\tprivate readonly _notches: SVGSVGElement = SVG.svg({\"pointer-events\": \"none\"});\r\n\tprivate readonly _handle: SVGRectElement = SVG.rect({fill: ColorConfig.uiWidgetBackground, x: 0, y: 2, width: 10, height: this._editorHeight - 4});\r\n\tprivate readonly _handleHighlight: SVGRectElement = SVG.rect({fill: \"none\", stroke: ColorConfig.hoverPreview, \"stroke-width\": 2, \"pointer-events\": \"none\", x: 0, y: 1, width: 10, height: this._editorHeight - 2});\r\n\tprivate readonly _leftHighlight: SVGPathElement = SVG.path({fill: ColorConfig.hoverPreview, \"pointer-events\": \"none\"});\r\n\tprivate readonly _rightHighlight: SVGPathElement = SVG.path({fill: ColorConfig.hoverPreview, \"pointer-events\": \"none\"});\r\n\t\r\n\tprivate readonly _svg: SVGSVGElement = SVG.svg({style: `background-color: ${ColorConfig.editorBackground}; touch-action: pan-y; position: absolute;`, width: this._editorWidth, height: this._editorHeight},\r\n\t\tthis._notches,\r\n\t\tthis._handle,\r\n\t\tthis._handleHighlight,\r\n\t\tthis._leftHighlight,\r\n\t\tthis._rightHighlight,\r\n\t);\r\n\t\r\n\tpublic readonly container: HTMLElement = HTML.div({class: \"barScrollBar\", style: \"width: 512px; height: 20px; overflow: hidden; position: relative;\"}, this._svg);\r\n\t\r\n\tprivate _mouseX: number = 0;\r\n\t//private _mouseY: number = 0;\r\n\tprivate _mouseDown: boolean = false;\r\n\tprivate _mouseOver: boolean = false;\r\n\tprivate _dragging: boolean = false;\r\n\tprivate _dragStart: number;\r\n\tprivate _notchSpace: number;\r\n\tprivate _renderedNotchCount: number = -1;\r\n\tprivate _renderedScrollBarPos: number = -1;\r\n\t\r\n\tconstructor(private _doc: SongDocument) {\r\n\t\tconst center: number = this._editorHeight * 0.5;\r\n\t\tconst base: number = 20;\r\n\t\tconst tip: number = 9;\r\n\t\tconst arrowHeight: number = 6;\r\n\t\tthis._leftHighlight.setAttribute(\"d\", `M ${tip} ${center} L ${base} ${center + arrowHeight} L ${base} ${center - arrowHeight} z`);\r\n\t\tthis._rightHighlight.setAttribute(\"d\", `M ${this._editorWidth - tip} ${center} L ${this._editorWidth - base} ${center + arrowHeight} L ${this._editorWidth - base} ${center - arrowHeight} z`);\r\n\t\t\r\n\t\tthis.container.addEventListener(\"mousedown\", this._whenMousePressed);\r\n\t\tdocument.addEventListener(\"mousemove\", this._whenMouseMoved);\r\n\t\tdocument.addEventListener(\"mouseup\", this._whenCursorReleased);\r\n\t\tthis.container.addEventListener(\"mouseover\", this._whenMouseOver);\r\n\t\tthis.container.addEventListener(\"mouseout\", this._whenMouseOut);\r\n\t\t\r\n\t\tthis.container.addEventListener(\"touchstart\", this._whenTouchPressed);\r\n\t\tthis.container.addEventListener(\"touchmove\", this._whenTouchMoved);\r\n\t\tthis.container.addEventListener(\"touchend\", this._whenCursorReleased);\r\n\t\tthis.container.addEventListener(\"touchcancel\", this._whenCursorReleased);\r\n\t}\r\n\t\r\n\tprivate _whenMouseOver = (event: MouseEvent): void => {\r\n\t\tif (this._mouseOver) return;\r\n\t\tthis._mouseOver = true;\r\n\t\tthis._updatePreview();\r\n\t}\r\n\t\r\n\tprivate _whenMouseOut = (event: MouseEvent): void => {\r\n\t\tif (!this._mouseOver) return;\r\n\t\tthis._mouseOver = false;\r\n\t\tthis._updatePreview();\r\n\t}\r\n\t\r\n\tprivate _whenMousePressed = (event: MouseEvent): void => {\r\n\t\tevent.preventDefault();\r\n\t\tthis._mouseDown = true;\r\n\t\tconst boundingRect: ClientRect = this._svg.getBoundingClientRect();\r\n\t\tthis._mouseX = (event.clientX || event.pageX) - boundingRect.left;\r\n\t\t//this._mouseY = (event.clientY || event.pageY) - boundingRect.top;\r\n\t\tthis._updatePreview();\r\n\t\tif (this._mouseX >= this._doc.barScrollPos * this._notchSpace && this._mouseX <= (this._doc.barScrollPos + this._doc.trackVisibleBars) * this._notchSpace) {\r\n\t\t\tthis._dragging = true;\r\n\t\t\tthis._dragStart = this._mouseX;\r\n\t\t}\r\n\t}\r\n\t\r\n\tprivate _whenTouchPressed = (event: TouchEvent): void => {\r\n\t\tevent.preventDefault();\r\n\t\tthis._mouseDown = true;\r\n\t\tconst boundingRect: ClientRect = this._svg.getBoundingClientRect();\r\n\t\tthis._mouseX = event.touches[0].clientX - boundingRect.left;\r\n\t\t//this._mouseY = event.touches[0].clientY - boundingRect.top;\r\n\t\tthis._updatePreview();\r\n\t\tif (this._mouseX >= this._doc.barScrollPos * this._notchSpace && this._mouseX <= (this._doc.barScrollPos + this._doc.trackVisibleBars) * this._notchSpace) {\r\n\t\t\tthis._dragging = true;\r\n\t\t\tthis._dragStart = this._mouseX;\r\n\t\t}\r\n\t}\r\n\t\r\n\tprivate _whenMouseMoved = (event: MouseEvent): void => {\r\n\t\tconst boundingRect: ClientRect = this._svg.getBoundingClientRect();\r\n\t\tthis._mouseX = (event.clientX || event.pageX) - boundingRect.left;\r\n\t\t//this._mouseY = (event.clientY || event.pageY) - boundingRect.top;\r\n\t\tthis._whenCursorMoved();\r\n\t}\r\n\t\r\n\tprivate _whenTouchMoved = (event: TouchEvent): void => {\r\n\t\tif (!this._mouseDown) return;\r\n\t\tevent.preventDefault();\r\n\t\tconst boundingRect: ClientRect = this._svg.getBoundingClientRect();\r\n\t\tthis._mouseX = event.touches[0].clientX - boundingRect.left;\r\n\t\t//this._mouseY = event.touches[0].clientY - boundingRect.top;\r\n\t\tthis._whenCursorMoved();\r\n\t}\r\n\t\r\n\tprivate _whenCursorMoved(): void {\r\n\t\tif (this._dragging) {\r\n\t\t\twhile (this._mouseX - this._dragStart < -this._notchSpace * 0.5) {\r\n\t\t\t\tif (this._doc.barScrollPos > 0) {\r\n\t\t\t\t\tthis._doc.barScrollPos--;\r\n\t\t\t\t\tthis._dragStart -= this._notchSpace;\r\n\t\t\t\t\tthis._doc.notifier.changed();\r\n\t\t\t\t} else {\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\twhile (this._mouseX - this._dragStart > this._notchSpace * 0.5) {\r\n\t\t\t\tif (this._doc.barScrollPos < this._doc.song.barCount - this._doc.trackVisibleBars) {\r\n\t\t\t\t\tthis._doc.barScrollPos++;\r\n\t\t\t\t\tthis._dragStart += this._notchSpace;\r\n\t\t\t\t\tthis._doc.notifier.changed();\r\n\t\t\t\t} else {\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\tif (this._mouseOver) this._updatePreview();\r\n\t}\r\n\t\r\n\tprivate _whenCursorReleased = (event: Event): void => {\r\n\t\tif (!this._dragging && this._mouseDown) {\r\n\t\t\tif (this._mouseX < (this._doc.barScrollPos + 8) * this._notchSpace) {\r\n\t\t\t\tif (this._doc.barScrollPos > 0) this._doc.barScrollPos--;\r\n\t\t\t\tthis._doc.notifier.changed();\r\n\t\t\t} else {\r\n\t\t\t\tif (this._doc.barScrollPos < this._doc.song.barCount - this._doc.trackVisibleBars) this._doc.barScrollPos++;\r\n\t\t\t\tthis._doc.notifier.changed();\r\n\t\t\t}\r\n\t\t}\r\n\t\tthis._mouseDown = false;\r\n\t\tthis._dragging = false;\r\n\t\tthis._updatePreview();\r\n\t}\r\n\t\r\n\tprivate _updatePreview(): void {\r\n\t\tconst showHighlight: boolean = this._mouseOver && !this._mouseDown;\r\n\t\tlet showleftHighlight: boolean = false;\r\n\t\tlet showRightHighlight: boolean = false;\r\n\t\tlet showHandleHighlight: boolean = false;\r\n\t\t\r\n\t\tif (showHighlight) {\r\n\t\t\tif (this._mouseX < this._doc.barScrollPos * this._notchSpace) {\r\n\t\t\t\tshowleftHighlight = true;\r\n\t\t\t} else if (this._mouseX > (this._doc.barScrollPos + this._doc.trackVisibleBars) * this._notchSpace) {\r\n\t\t\t\tshowRightHighlight = true;\r\n\t\t\t} else {\r\n\t\t\t\tshowHandleHighlight = true;\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tthis._leftHighlight.style.visibility = showleftHighlight ? \"visible\" : \"hidden\";\r\n\t\tthis._rightHighlight.style.visibility = showRightHighlight ? \"visible\" : \"hidden\";\r\n\t\tthis._handleHighlight.style.visibility = showHandleHighlight ? \"visible\" : \"hidden\";\r\n\t}\r\n\t\r\n\tpublic render(): void {\r\n\t\tthis._notchSpace = (this._editorWidth-1) / Math.max(this._doc.trackVisibleBars, this._doc.song.barCount);\r\n\t\t\r\n\t\tconst resized: boolean = this._renderedNotchCount != this._doc.song.barCount;\r\n\t\tif (resized) {\r\n\t\t\tthis._renderedNotchCount = this._doc.song.barCount;\r\n\t\t\t\r\n\t\t\twhile (this._notches.firstChild) this._notches.removeChild(this._notches.firstChild);\r\n\t\t\t\r\n\t\t\tfor (let i: number = 0; i <= this._doc.song.barCount; i++) {\r\n\t\t\t\tconst lineHeight: number = (i % 16 == 0) ? 0 : ((i % 4 == 0) ? this._editorHeight / 8 : this._editorHeight / 3);\r\n\t\t\t\tthis._notches.appendChild(SVG.rect({fill: ColorConfig.uiWidgetBackground, x: i * this._notchSpace - 1, y: lineHeight, width: 2, height: this._editorHeight - lineHeight * 2}));\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tif (resized || this._renderedScrollBarPos != this._doc.barScrollPos) {\r\n\t\t\tthis._renderedScrollBarPos = this._doc.barScrollPos;\r\n\t\t\tthis._handle.setAttribute(\"x\", String(this._notchSpace * this._doc.barScrollPos));\r\n\t\t\tthis._handle.setAttribute(\"width\", String(this._notchSpace * this._doc.trackVisibleBars));\r\n\t\t\tthis._handleHighlight.setAttribute(\"x\", String(this._notchSpace * this._doc.barScrollPos));\r\n\t\t\tthis._handleHighlight.setAttribute(\"width\", String(this._notchSpace * this._doc.trackVisibleBars));\r\n\t\t}\r\n\t\t\r\n\t\tthis._updatePreview();\r\n\t}\r\n}\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nimport {Config} from \"../synth/SynthConfig\";\r\nimport {SongDocument} from \"./SongDocument\";\r\nimport {HTML, SVG} from \"imperative-html/dist/esm/elements-strict\";\r\nimport {ChangeOctave} from \"./changes\";\r\nimport {ColorConfig} from \"./ColorConfig\";\r\n\r\nexport class OctaveScrollBar {\r\n\tprivate readonly _editorWidth: number = 20;\r\n\tprivate readonly _editorHeight: number = 481;\r\n\tprivate readonly _notchHeight: number = 4.0;\r\n\tprivate readonly _octaveCount: number = Config.pitchOctaves;\r\n\tprivate readonly _octaveHeight: number = (this._editorHeight - this._notchHeight) / this._octaveCount;\r\n\t\r\n\tprivate readonly _handle: SVGRectElement = SVG.rect({fill: ColorConfig.uiWidgetBackground, x: 2, y: 0, width: this._editorWidth - 4});\r\n\tprivate readonly _handleHighlight: SVGRectElement = SVG.rect({fill: \"none\", stroke: ColorConfig.hoverPreview, \"stroke-width\": 2, \"pointer-events\": \"none\", x: 1, y: 0, width: this._editorWidth - 2});\r\n\tprivate readonly _upHighlight: SVGPathElement = SVG.path({fill: ColorConfig.hoverPreview, \"pointer-events\": \"none\"});\r\n\tprivate readonly _downHighlight: SVGPathElement = SVG.path({fill: ColorConfig.hoverPreview, \"pointer-events\": \"none\"});\r\n\t\r\n\tprivate readonly _svg: SVGSVGElement = SVG.svg({style: `background-color: ${ColorConfig.editorBackground}; touch-action: pan-x; position: absolute;`, width: this._editorWidth, height: \"100%\", viewBox: \"0 0 20 481\", preserveAspectRatio: \"none\"});\r\n\tpublic readonly container: HTMLDivElement = HTML.div({id: \"octaveScrollBarContainer\", style: \"width: 20px; height: 100%; overflow: hidden; position: relative; flex-shrink: 0;\"}, this._svg);\r\n\t\r\n\t//private _mouseX: number = 0;\r\n\tprivate _mouseY: number = 0;\r\n\tprivate _mouseDown: boolean = false;\r\n\tprivate _mouseOver: boolean = false;\r\n\tprivate _dragging: boolean = false;\r\n\tprivate _dragStart: number;\r\n\tprivate _barBottom: number;\r\n\tprivate _barHeight: number;\r\n\tprivate _renderedBarBottom: number = -1;\r\n\tprivate _renderedVisibleOctaveCount: number = -1;\r\n\tprivate _change: ChangeOctave | null = null;\r\n\t\r\n\tconstructor(private _doc: SongDocument) {\r\n\t\tthis._doc.notifier.watch(this._documentChanged);\r\n\t\tthis._documentChanged();\r\n\t\t\r\n\t\tthis._svg.appendChild(this._handle);\r\n\t\t\r\n\t\t// notches:\r\n\t\tfor (let i: number = 0; i <= this._octaveCount; i++) {\r\n\t\t\tthis._svg.appendChild(SVG.rect({fill: ColorConfig.tonic, x: 0, y: i * this._octaveHeight, width: this._editorWidth, height: this._notchHeight}));\r\n\t\t}\r\n\t\t\r\n\t\tthis._svg.appendChild(this._handleHighlight);\r\n\t\tthis._svg.appendChild(this._upHighlight);\r\n\t\tthis._svg.appendChild(this._downHighlight);\r\n\t\t\r\n\t\tconst center: number = this._editorWidth * 0.5;\r\n\t\tconst base: number = 20;\r\n\t\tconst tip: number = 9;\r\n\t\tconst arrowWidth: number = 6;\r\n\t\tthis._upHighlight.setAttribute(\"d\", `M ${center} ${tip} L ${center + arrowWidth} ${base} L ${center - arrowWidth} ${base} z`);\r\n\t\tthis._downHighlight.setAttribute(\"d\", `M ${center} ${this._editorHeight - tip} L ${center + arrowWidth} ${this._editorHeight - base} L ${center - arrowWidth} ${this._editorHeight - base} z`);\r\n\t\t\r\n\t\tthis.container.addEventListener(\"mousedown\", this._whenMousePressed);\r\n\t\tdocument.addEventListener(\"mousemove\", this._whenMouseMoved);\r\n\t\tdocument.addEventListener(\"mouseup\", this._whenCursorReleased);\r\n\t\tthis.container.addEventListener(\"mouseover\", this._whenMouseOver);\r\n\t\tthis.container.addEventListener(\"mouseout\", this._whenMouseOut);\r\n\t\t\r\n\t\tthis.container.addEventListener(\"touchstart\", this._whenTouchPressed);\r\n\t\tthis.container.addEventListener(\"touchmove\", this._whenTouchMoved);\r\n\t\tthis.container.addEventListener(\"touchend\", this._whenCursorReleased);\r\n\t\tthis.container.addEventListener(\"touchcancel\", this._whenCursorReleased);\r\n\t}\r\n\t\r\n\tprivate _whenMouseOver = (event: MouseEvent): void => {\r\n\t\tif (this._mouseOver) return;\r\n\t\tthis._mouseOver = true;\r\n\t\tthis._updatePreview();\r\n\t}\r\n\t\r\n\tprivate _whenMouseOut = (event: MouseEvent): void => {\r\n\t\tif (!this._mouseOver) return;\r\n\t\tthis._mouseOver = false;\r\n\t\tthis._updatePreview();\r\n\t}\r\n\t\r\n\tprivate _whenMousePressed = (event: MouseEvent): void => {\r\n\t\tevent.preventDefault();\r\n\t\tthis._mouseDown = true;\r\n\t\tconst boundingRect: ClientRect = this._svg.getBoundingClientRect();\r\n\t\t//this._mouseX = (event.clientX || event.pageX) - boundingRect.left;\r\n\t\tthis._mouseY = ((event.clientY || event.pageY) - boundingRect.top) * this._editorHeight / (boundingRect.bottom - boundingRect.top);\r\n\t\tif (isNaN(this._mouseY)) this._mouseY = 0;\r\n\t\tif (this._doc.song.getChannelIsNoise(this._doc.channel)) return;\r\n\t\tthis._updatePreview();\r\n\t\t\r\n\t\tif (this._mouseY >= this._barBottom - this._barHeight && this._mouseY <= this._barBottom) {\r\n\t\t\tthis._dragging = true;\r\n\t\t\tthis._change = null;\r\n\t\t\tthis._dragStart = this._mouseY;\r\n\t\t}\r\n\t}\r\n\t\r\n\tprivate _whenTouchPressed = (event: TouchEvent): void => {\r\n\t\tevent.preventDefault();\r\n\t\tthis._mouseDown = true;\r\n\t\tconst boundingRect: ClientRect = this._svg.getBoundingClientRect();\r\n\t\t//this._mouseX = event.touches[0].clientX - boundingRect.left;\r\n\t\tthis._mouseY = (event.touches[0].clientY - boundingRect.top) * this._editorHeight / (boundingRect.bottom - boundingRect.top);\r\n\t\tif (isNaN(this._mouseY)) this._mouseY = 0;\r\n\t\tif (this._doc.song.getChannelIsNoise(this._doc.channel)) return;\r\n\t\tthis._updatePreview();\r\n\t\t\r\n\t\tif (this._mouseY >= this._barBottom - this._barHeight && this._mouseY <= this._barBottom) {\r\n\t\t\tthis._dragging = true;\r\n\t\t\tthis._change = null;\r\n\t\t\tthis._dragStart = this._mouseY;\r\n\t\t}\r\n\t}\r\n\t\r\n\tprivate _whenMouseMoved = (event: MouseEvent): void => {\r\n\t\tconst boundingRect: ClientRect = this._svg.getBoundingClientRect();\r\n\t\t//this._mouseX = (event.clientX || event.pageX) - boundingRect.left;\r\n\t\tthis._mouseY = ((event.clientY || event.pageY) - boundingRect.top) * this._editorHeight / (boundingRect.bottom - boundingRect.top);\r\n\t\tif (isNaN(this._mouseY)) this._mouseY = 0;\r\n\t\tthis._whenCursorMoved();\r\n\t}\r\n\t\r\n\tprivate _whenTouchMoved = (event: TouchEvent): void => {\r\n\t\tif (!this._mouseDown) return;\r\n\t\tevent.preventDefault();\r\n\t\tconst boundingRect: ClientRect = this._svg.getBoundingClientRect();\r\n\t\t//this._mouseX = event.touches[0].clientX - boundingRect.left;\r\n\t\tthis._mouseY = (event.touches[0].clientY - boundingRect.top) * this._editorHeight / (boundingRect.bottom - boundingRect.top);\r\n\t\tif (isNaN(this._mouseY)) this._mouseY = 0;\r\n\t\tthis._whenCursorMoved();\r\n\t}\r\n\t\r\n\tprivate _whenCursorMoved(): void {\r\n\t\tif (this._doc.song.getChannelIsNoise(this._doc.channel)) return;\r\n\t\tif (this._dragging) {\r\n\t\t\tconst visibleOctaveCount: number = this._doc.getVisibleOctaveCount();\r\n\t\t\tconst scrollableOctaves: number = Config.pitchOctaves - visibleOctaveCount;\r\n\t\t\tconst continuingProspectiveChange: boolean = this._doc.lastChangeWas(this._change);\r\n\t\t\tconst oldValue: number = continuingProspectiveChange ? this._change!.oldValue : this._doc.song.channels[this._doc.channel].octave;\r\n\t\t\t\r\n\t\t\tconst currentOctave: number = this._doc.getBaseVisibleOctave(this._doc.channel);\r\n\t\t\tlet octave: number = currentOctave;\r\n\t\t\twhile (this._mouseY - this._dragStart < -this._octaveHeight * 0.5) {\r\n\t\t\t\tif (octave < scrollableOctaves) {\r\n\t\t\t\t\toctave++;\r\n\t\t\t\t\tthis._dragStart -= this._octaveHeight;\r\n\t\t\t\t} else {\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\twhile (this._mouseY - this._dragStart > this._octaveHeight * 0.5) {\r\n\t\t\t\tif (octave > 0) {\r\n\t\t\t\t\toctave--;\r\n\t\t\t\t\tthis._dragStart += this._octaveHeight;\r\n\t\t\t\t} else {\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tthis._change = new ChangeOctave(this._doc, oldValue, Math.floor(octave + visibleOctaveCount * 0.5));\r\n\t\t\tthis._doc.setProspectiveChange(this._change);\r\n\t\t}\r\n\t\t\r\n\t\tif (this._mouseOver) this._updatePreview();\r\n\t}\r\n\t\r\n\tprivate _whenCursorReleased = (event: Event): void => {\r\n\t\tif (!this._doc.song.getChannelIsNoise(this._doc.channel) && this._mouseDown) {\r\n\t\t\tif (this._dragging) {\r\n\t\t\t\tif (this._change != null) this._doc.record(this._change);\r\n\t\t\t} else {\r\n\t\t\t\tconst visibleOctaveCount: number = this._doc.getVisibleOctaveCount();\r\n\t\t\t\tconst scrollableOctaves: number = Config.pitchOctaves - visibleOctaveCount;\r\n\t\t\t\tconst canReplaceLastChange: boolean = this._doc.lastChangeWas(this._change);\r\n\t\t\t\tconst oldValue: number = canReplaceLastChange ? this._change!.oldValue : this._doc.song.channels[this._doc.channel].octave;\r\n\t\t\t\r\n\t\t\t\tconst currentOctave: number = this._doc.getBaseVisibleOctave(this._doc.channel);\r\n\t\t\t\tif (this._mouseY < this._barBottom - this._barHeight * 0.5) {\r\n\t\t\t\t\tif (currentOctave < scrollableOctaves) {\r\n\t\t\t\t\t\tthis._change = new ChangeOctave(this._doc, oldValue, Math.floor(currentOctave + 1 + visibleOctaveCount * 0.5));\r\n\t\t\t\t\t\tthis._doc.record(this._change, canReplaceLastChange);\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\tif (currentOctave > 0) {\r\n\t\t\t\t\t\tthis._change = new ChangeOctave(this._doc, oldValue, Math.floor(currentOctave - 1 + visibleOctaveCount * 0.5));\r\n\t\t\t\t\t\tthis._doc.record(this._change, canReplaceLastChange);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\tthis._mouseDown = false;\r\n\t\tthis._dragging = false;\r\n\t\tthis._updatePreview();\r\n\t}\r\n\t\r\n\tprivate _updatePreview(): void {\r\n\t\tconst showHighlight: boolean = this._mouseOver && !this._mouseDown;\r\n\t\tlet showUpHighlight: boolean = false;\r\n\t\tlet showDownHighlight: boolean = false;\r\n\t\tlet showHandleHighlight: boolean = false;\r\n\t\t\r\n\t\tif (showHighlight) {\r\n\t\t\tif (this._mouseY < this._barBottom - this._barHeight) {\r\n\t\t\t\tshowUpHighlight = true;\r\n\t\t\t} else if (this._mouseY > this._barBottom) {\r\n\t\t\t\tshowDownHighlight = true;\r\n\t\t\t} else {\r\n\t\t\t\tshowHandleHighlight = true;\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tthis._upHighlight.style.visibility = showUpHighlight ? \"inherit\" : \"hidden\";\r\n\t\tthis._downHighlight.style.visibility = showDownHighlight ? \"inherit\" : \"hidden\";\r\n\t\tthis._handleHighlight.style.visibility = showHandleHighlight ? \"inherit\" : \"hidden\";\r\n\t}\r\n\t\r\n\tprivate _documentChanged = (): void => {\r\n\t\tthis._barBottom = this._editorHeight - (this._octaveHeight * this._doc.getBaseVisibleOctave(this._doc.channel));\r\n\t\tthis._svg.style.visibility = (this._doc.song.getChannelIsNoise(this._doc.channel)) ? \"hidden\" : \"visible\";\r\n\t\tconst visibleOctaveCount: number = this._doc.getVisibleOctaveCount();\r\n\t\tif (this._renderedBarBottom != this._barBottom || this._renderedVisibleOctaveCount != visibleOctaveCount) {\r\n\t\t\tthis._renderedBarBottom = this._barBottom;\r\n\t\t\tthis._renderedVisibleOctaveCount = visibleOctaveCount;\r\n\t\t\tthis._barHeight = (this._octaveHeight * visibleOctaveCount + this._notchHeight);\r\n\t\t\tthis._handle.setAttribute(\"height\", String(this._barHeight));\r\n\t\t\tthis._handleHighlight.setAttribute(\"height\", String(this._barHeight));\r\n\t\t\tthis._handle.setAttribute(\"y\", String(this._barBottom - this._barHeight));\r\n\t\t\tthis._handleHighlight.setAttribute(\"y\", String(this._barBottom - this._barHeight));\r\n\t\t}\r\n\t\tthis._updatePreview();\r\n\t}\r\n}\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nexport const defaultMidiExpression: number = 0x7F;\r\nexport const defaultMidiPitchBend: number = 0x2000;\r\n\r\nexport const enum MidiChunkType {\r\n\theader = 0x4D546864, // \"MThd\" as bytes, big endian\r\n\ttrack = 0x4D54726B, // \"MTrk\" as bytes, big endian\r\n}\r\n\r\nexport const enum MidiFileFormat {\r\n\tsingleTrack = 0x0000,\r\n\tsimultaneousTracks = 0x0001,\r\n\tindependentTracks = 0x0002,\r\n}\r\n\r\n// Lower 4 bits indicate channel, except for meta and sysex events.\r\nexport const enum MidiEventType {\r\n\t//channelMode = 0x70,\r\n\tnoteOff = 0x80,\r\n\tnoteOn = 0x90,\r\n\tkeyPressure = 0xA0,\r\n\tcontrolChange = 0xB0,\r\n\tprogramChange = 0xC0,\r\n\tchannelPressure = 0xD0,\r\n\tpitchBend = 0xE0,\r\n\tmetaAndSysex = 0xF0,\r\n\t\r\n\t// These events are identified by all 8 bits.\r\n\tmeta = 0xFF,\r\n\t// sysexStart = 0xF0,\r\n\t// sysexEscape = 0xF7,\r\n}\r\n\r\nexport const enum MidiControlEventMessage {\r\n\t\r\n\tsetParameterMSB = 0x06,\r\n\tvolumeMSB = 0x07,\r\n\tpanMSB = 0x0A,\r\n\texpressionMSB = 0x0B,\r\n\t\r\n\tsetParameterLSB = 0x26,\r\n\t//volumeLSB = 0x27,\r\n\t//expressionLSB = 0x2B,\r\n\t\r\n\t//nonRegisteredParameterNumberLSB = 0x62,\r\n\t//nonRegisteredParameterNumberMSB = 0x63,\r\n\tregisteredParameterNumberLSB = 0x64,\r\n\tregisteredParameterNumberMSB = 0x65,\r\n\t\r\n\t// Channel mode messages:\r\n\t/*\r\n\tallSoundOff = 0x78,\r\n\tresetControllers = 0x79,\r\n\tlocalControl = 0x7A,\r\n\tallNotesOff = 0x7B,\r\n\tomniModeOff = 0x7C,\r\n\tomniModeOn = 0x7D,\r\n\tmonoMode = 0x7E,\r\n\tpolyphonicMode = 0x7F,\r\n\t*/\r\n}\r\n\r\nexport const enum MidiRegisteredParameterNumberMSB {\r\n\tpitchBendRange = 0x00, // semitones\r\n\tfineTuning = 0x00,\r\n\tcoarseTuning = 0x00,\r\n\ttuningProgramSelect = 0x00,\r\n\ttuningBankSelect = 0x00,\r\n\treset = 0x7f,\r\n}\r\n\r\nexport const enum MidiRegisteredParameterNumberLSB {\r\n\tpitchBendRange = 0x00, // cents\r\n\tfineTuning = 0x01,\r\n\tcoarseTuning = 0x02,\r\n\ttuningProgramSelect = 0x03,\r\n\ttuningBankSelect = 0x04,\r\n\treset = 0x7f,\r\n}\r\n\r\nexport const enum MidiMetaEventMessage {\r\n\tsequenceNumber = 0x00,\r\n\ttext = 0x01,\r\n\tcopyrightNotice = 0x02,\r\n\ttrackName = 0x03,\r\n\tinstrumentName = 0x04,\r\n\tlyricText = 0x05,\r\n\tmarker = 0x06,\r\n\tcuePoint = 0x07,\r\n\tchannelPrefix = 0x20,\r\n\tendOfTrack = 0x2F,\r\n\ttempo = 0x51,\r\n\tsmpteOffset = 0x54,\r\n\ttimeSignature = 0x58,\r\n\tkeySignature = 0x59,\r\n\tsequencerSpecificEvent = 0x7F,\r\n}\r\n\r\n// BeepBox noise channels are very different from Midi drumsets, but here's my attempt at a conversion from Midi to BeepBox.\r\nexport interface AnalogousDrum {\r\n\tfrequency: number;\r\n\tduration: number;\r\n\tvolume: number;\r\n}\r\nexport const analogousDrumMap: { [K: number]: AnalogousDrum } = {\r\n\t35: { frequency:  0, duration: 2, volume: 3 }, // Acoustic Bass Drum\r\n\t36: { frequency:  0, duration: 2, volume: 3 }, // Bass Drum 1\r\n\t37: { frequency:  5, duration: 1, volume: 3 }, // Side Stick\r\n\t38: { frequency:  4, duration: 2, volume: 3 }, // Acoustic Snare\r\n\t39: { frequency:  5, duration: 2, volume: 3 }, // Hand Clap\r\n\t40: { frequency:  4, duration: 2, volume: 3 }, // Electric Snare\r\n\t41: { frequency:  1, duration: 2, volume: 3 }, // Low Floor Tom\r\n\t42: { frequency:  8, duration: 1, volume: 3 }, // Closed Hi Hat\r\n\t43: { frequency:  1, duration: 2, volume: 3 }, // High Floor Tom\r\n\t44: { frequency:  8, duration: 1, volume: 2 }, // Pedal Hi-Hat\r\n\t45: { frequency:  2, duration: 2, volume: 3 }, // Low Tom\r\n\t46: { frequency:  8, duration: 4, volume: 3 }, // Open Hi-Hat\r\n\t47: { frequency:  2, duration: 2, volume: 3 }, // Low-Mid Tom\r\n\t48: { frequency:  3, duration: 2, volume: 3 }, // Hi-Mid Tom\r\n\t49: { frequency:  7, duration: 4, volume: 3 }, // Crash Cymbal 1\r\n\t50: { frequency:  3, duration: 2, volume: 3 }, // High Tom\r\n\t51: { frequency:  6, duration: 4, volume: 2 }, // Ride Cymbal 1\r\n\t52: { frequency:  7, duration: 4, volume: 3 }, // Chinese Cymbal\r\n\t53: { frequency:  6, duration: 2, volume: 3 }, // Ride Bell\r\n\t54: { frequency: 11, duration: 2, volume: 3 }, // Tambourine\r\n\t55: { frequency:  9, duration: 4, volume: 3 }, // Splash Cymbal\r\n\t56: { frequency:  7, duration: 1, volume: 2 }, // Cowbell\r\n\t57: { frequency:  7, duration: 4, volume: 3 }, // Crash Cymbal 2\r\n\t58: { frequency: 10, duration: 2, volume: 2 }, // Vibraslap\r\n\t59: { frequency:  6, duration: 4, volume: 3 }, // Ride Cymbal 2\r\n\t//60: { frequency:  7, duration: 1, volume: 3 }, // Hi Bongo\r\n\t//61: { frequency:  5, duration: 1, volume: 3 }, // Low Bongo\r\n\t//62: { frequency:  6, duration: 1, volume: 3 }, // Mute Hi Conga\r\n\t//63: { frequency:  5, duration: 1, volume: 3 }, // Open Hi Conga\r\n\t//64: { frequency:  4, duration: 1, volume: 3 }, // Low Conga\r\n\t//65: { frequency:  6, duration: 2, volume: 3 }, // High Timbale\r\n\t//66: { frequency:  4, duration: 2, volume: 3 }, // Low Timbale\r\n\t//67: { frequency: 10, duration: 1, volume: 2 }, // High Agogo\r\n\t//68: { frequency:  9, duration: 1, volume: 2 }, // Low Agogo\r\n\t69: { frequency: 10, duration: 2, volume: 3 }, // Cabasa\r\n\t70: { frequency: 10, duration: 2, volume: 3 }, // Maracas\r\n\t//71: { frequency: 10, duration: 2, volume: 3 }, // Short Whistle\r\n\t//72: { frequency:  9, duration: 2, volume: 3 }, // Long Whistle\r\n\t73: { frequency: 10, duration: 1, volume: 2 }, // Short Guiro\r\n\t74: { frequency: 10, duration: 2, volume: 2 }, // Long Guiro\r\n\t//75: { frequency: 10, duration: 1, volume: 2 }, // Claves\r\n\t//76: { frequency:  6, duration: 1, volume: 2 }, // Hi Wood Block\r\n\t//77: { frequency:  5, duration: 1, volume: 2 }, // Low Wood Block\r\n\t//78: { frequency:  6, duration: 2, volume: 3 }, // Mute Cuica\r\n\t//79: { frequency:  4, duration: 2, volume: 3 }, // Open Cuica\r\n\t//80: { frequency:  7, duration: 1, volume: 2 }, // Mute Triangle\r\n\t//81: { frequency:  7, duration: 4, volume: 2 }, // Open Triangle\r\n};\r\n\r\nexport function midiVolumeToVolumeMult(volume: number): number {\r\n\t// default midi volume is 100, pow(100/127,4)0.384 so I'm considering that the baseline volume.\r\n\treturn Math.pow(volume / 127, 4.0) / 0.3844015376046128;\r\n}\r\nexport function volumeMultToMidiVolume(volumeMult: number): number {\r\n\treturn Math.pow(volumeMult * 0.3844015376046128, 0.25) * 127;\r\n}\r\nexport function midiExpressionToVolumeMult(expression: number): number {\r\n\treturn Math.pow(expression / 127, 4.0);\r\n}\r\nexport function volumeMultToMidiExpression(volumeMult: number): number {\r\n\treturn Math.pow(volumeMult, 0.25) * 127;\r\n}\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nimport {Config} from \"../synth/SynthConfig\";\r\nimport {SongDocument} from \"./SongDocument\";\r\nimport {AnalogousDrum, analogousDrumMap, MidiEventType} from \"./Midi\";\r\n\r\ndeclare global {\r\n\tinterface Navigator {\r\n\t\trequestMIDIAccess?(): Promise<any>;\r\n\t}\r\n}\r\n\r\ninterface MIDIInput extends EventTarget {\r\n\tid: string;\r\n\ttype: \"input\" | \"output\";\r\n\tstate: \"disconnected\" | \"connected\";\r\n}\r\n\r\ninterface MIDIConnectionEvent {\r\n\tport: MIDIInput;\r\n}\r\n\r\ninterface MIDIMessageEvent {\r\n\tdata: [type: number, key: number, velocity: number];\r\n\ttarget: MIDIInput;\r\n}\r\n\r\n// A unique id for this tab.\r\nconst id: string = ((Math.random() * 0xffffffff) >>> 0).toString(16);\r\n\r\nexport class MidiInputHandler {\r\n\tconstructor(private _doc: SongDocument) {\r\n\t\tthis.registerMidiAccessHandler();\r\n\t}\r\n\t\r\n\tprivate async registerMidiAccessHandler() {\r\n\t\tif (navigator.requestMIDIAccess == null) return;\r\n\t\t\r\n\t\ttry {\r\n\t\t\tconst midiAccess = await navigator.requestMIDIAccess();\r\n\t\t\t\r\n\t\t\tmidiAccess.inputs.forEach(this._registerMidiInput);\r\n\t\t\tmidiAccess.addEventListener(\"statechange\", this._handleStateChange);\r\n\t\t\t\r\n\t\t\tthis._takeMidiHandlerFocus();\r\n\t\t\twindow.addEventListener(\"focus\", this._takeMidiHandlerFocus);\r\n\t\t} catch (e) {\r\n\t\t\tconsole.error(\"Failed to get MIDI access\", e);\r\n\t\t}\r\n\t}\r\n\t\r\n\tprivate _takeMidiHandlerFocus = (event?: Event) => {\r\n\t\t// Record that this browser tab is the one that should handle midi\r\n\t\t// events and any other open tabs should ignore midi events for now.\r\n\t\tlocalStorage.setItem(\"midiHandlerId\", id);\r\n\t}\r\n\t\r\n\tprivate _handleStateChange = (event: MIDIConnectionEvent) => {\r\n\t\tif (event.port.type !== \"input\") return;\r\n\t\t\r\n\t\tswitch (event.port.state) {\r\n\t\t\tcase \"connected\":\r\n\t\t\t\tthis._registerMidiInput(event.port);\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"disconnected\":\r\n\t\t\t\tthis._unregisterMidiInput(event.port);\r\n\t\t\t\tbreak;\r\n\t\t}\r\n\t}\r\n\t\r\n\tprivate _registerMidiInput = (midiInput: MIDIInput) => {\r\n\t\tmidiInput.addEventListener(\"midimessage\", this._onMidiMessage as any);\r\n\t}\r\n\t\r\n\tprivate _unregisterMidiInput = (midiInput: MIDIInput) => {\r\n\t\tmidiInput.removeEventListener(\"midimessage\", this._onMidiMessage as any);\r\n\t\tthis._doc.performance.clearAllPitches();\r\n\t}\r\n\t\r\n\tprivate _onMidiMessage = (event: MIDIMessageEvent) => {\r\n\t\t// Ignore midi events if disabled or a different tab is handling them.\r\n\t\tif (!this._doc.prefs.enableMidi || localStorage.getItem(\"midiHandlerId\") != id) return;\r\n\t\t\r\n\t\tconst isDrum: boolean = this._doc.song.getChannelIsNoise(this._doc.channel);\r\n\t\tlet [eventType, key, velocity] = event.data;\r\n\t\teventType &= 0xF0;\r\n\t\t\r\n\t\tif (isDrum) {\r\n\t\t\tconst drum: AnalogousDrum | undefined = analogousDrumMap[key];\r\n\t\t\tif (drum != undefined) {\r\n\t\t\t\tkey = drum.frequency;\r\n\t\t\t} else {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tkey -= Config.keys[this._doc.song.key].basePitch; // The basePitch of the song key is implicit so don't include it.\r\n\t\t\tif (key < 0 || key > Config.maxPitch) return;\r\n\t\t}\r\n\t\t\r\n\t\tif (eventType == MidiEventType.noteOn && velocity == 0) {\r\n\t\t\teventType = MidiEventType.noteOff;\r\n\t\t}\r\n\t\t\r\n\t\tswitch (eventType) {\r\n\t\t\tcase MidiEventType.noteOn:\r\n\t\t\t\tthis._doc.synth.preferLowerLatency = true;\r\n\t\t\t\tthis._doc.performance.addPerformedPitch(key);\r\n\t\t\t\tbreak;\r\n\t\t\tcase MidiEventType.noteOff:\r\n\t\t\t\tthis._doc.performance.removePerformedPitch(key);\r\n\t\t\t\tbreak;\r\n\t\t}\r\n\t}\r\n}\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nimport {Config} from \"../synth/SynthConfig\";\r\nimport {SongDocument} from \"./SongDocument\";\r\n\r\nexport class KeyboardLayout {\r\n\tprivate static _pianoAtC: ReadonlyArray<ReadonlyArray<number | null>> = [\r\n\t\t[   0,   2,   4,   5,   7,   9,  11,  12,  14,  16,  17],\r\n\t\t[null,   1,   3,null,   6,   8,  10,null,  13,  15,null,  18],\r\n\t\t[  12,  14,  16,  17,  19,  21,  23,  24,  26,  28,  29,  31,  33],\r\n\t\t[null,  13,  15,null,  18,  20,  22,null,  25,  27,null,  30,  32],\r\n\t];\r\n\tprivate static _pianoAtA: ReadonlyArray<ReadonlyArray<number | null>> = [\r\n\t\t[   0,   2,   3,   5,   7,   8,  10,  12,  14,  15,  17],\r\n\t\t[  -1,   1,null,   4,   6,null,   9,  11,  13,null,  16,  18],\r\n\t\t[  12,  14,  15,  17,  19,  20,  22,  24,  26,  27,  29,  31,  32],\r\n\t\t[  11,  13,null,  16,  18,null,  21,  23,  25,null,  28,  30,null],\r\n\t];\r\n\t\r\n\tpublic static keyPosToPitch(doc: SongDocument, x: number, y: number, keyboardLayout: string): number | null {\r\n\t\tlet pitchOffset: number | null = null;\r\n\t\tlet forcedKey: number | null = null;\r\n\t\tswitch (keyboardLayout) {\r\n\t\t\tcase \"wickiHayden\":\r\n\t\t\t\tpitchOffset = y * 5 + x * 2 - 2;\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"songScale\":\r\n\t\t\t\tconst scaleFlags: ReadonlyArray<boolean> = Config.scales[doc.song.scale].flags;\r\n\t\t\t\tconst scaleIndices: number[] = <number[]> scaleFlags.map((flag, index) => flag ? index : null).filter((index) => index != null);\r\n\t\t\t\tpitchOffset = (y - 1 + Math.floor(x / scaleIndices.length)) * Config.pitchesPerOctave + scaleIndices[(x + scaleIndices.length) % scaleIndices.length];\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"pianoAtC\":\r\n\t\t\t\tpitchOffset = KeyboardLayout._pianoAtC[y][x];\r\n\t\t\t\tforcedKey = Config.keys.dictionary[\"C\"].basePitch;\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"pianoAtA\":\r\n\t\t\t\tpitchOffset = KeyboardLayout._pianoAtA[y][x];\r\n\t\t\t\tforcedKey = Config.keys.dictionary[\"A\"].basePitch;\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"pianoTransposingC\":\r\n\t\t\t\tpitchOffset = KeyboardLayout._pianoAtC[y][x];\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"pianoTransposingA\":\r\n\t\t\t\tpitchOffset = KeyboardLayout._pianoAtA[y][x];\r\n\t\t\t\tbreak;\r\n\t\t}\r\n\t\t\r\n\t\tif (pitchOffset == null) return null;\r\n\t\t\r\n\t\tconst octaveOffset: number = Math.max(0, doc.song.channels[doc.channel].octave - 1) * Config.pitchesPerOctave;\r\n\t\tlet keyOffset: number = 0; // The basePitch of the song key is implicit.\r\n\t\t\r\n\t\tif (forcedKey != null) {\r\n\t\t\tconst keyBasePitch: number = Config.keys[doc.song.key].basePitch;\r\n\t\t\tkeyOffset = (forcedKey - keyBasePitch + 144) % 12;\r\n\t\t}\r\n\t\t\r\n\t\tconst pitch = octaveOffset + keyOffset + pitchOffset;\r\n\t\tif (pitch < 0 || pitch > Config.maxPitch) return null;\r\n\t\t\t\r\n\t\treturn pitch;\r\n\t}\r\n\t\r\n\tprivate _possiblyPlayingPitchesFromKeyboard: boolean = false;\r\n\t\r\n\tconstructor(private _doc: SongDocument) {\r\n\t\twindow.addEventListener(\"blur\", this._onWindowBlur);\r\n\t}\r\n\t\r\n\tprivate _onWindowBlur = (event: Event) => {\r\n\t\t// Browsers don't explicitly release keys when the page isn't in focus so let's just assume they're all released.\r\n\t\tif (this._possiblyPlayingPitchesFromKeyboard) {\r\n\t\t\tthis._doc.performance.clearAllPitches();\r\n\t\t\tthis._possiblyPlayingPitchesFromKeyboard = false;\r\n\t\t}\r\n\t}\r\n\t\r\n\tpublic handleKeyEvent(event: KeyboardEvent, pressed: boolean): void {\r\n\t\t// See: https://www.w3.org/TR/uievents-code/#key-alphanumeric-writing-system\r\n\t\tswitch (event.code) {\r\n\t\t\tcase \"Backquote\": this.handleKey(-1, 3, pressed); break;\r\n\t\t\tcase \"Digit1\": this.handleKey(0, 3, pressed); break;\r\n\t\t\tcase \"Digit2\": this.handleKey(1, 3, pressed); break;\r\n\t\t\tcase \"Digit3\": this.handleKey(2, 3, pressed); break;\r\n\t\t\tcase \"Digit4\": this.handleKey(3, 3, pressed); break;\r\n\t\t\tcase \"Digit5\": this.handleKey(4, 3, pressed); break;\r\n\t\t\tcase \"Digit6\": this.handleKey(5, 3, pressed); break;\r\n\t\t\tcase \"Digit7\": this.handleKey(6, 3, pressed); break;\r\n\t\t\tcase \"Digit8\": this.handleKey(7, 3, pressed); break;\r\n\t\t\tcase \"Digit9\": this.handleKey(8, 3, pressed); break;\r\n\t\t\tcase \"Digit0\": this.handleKey(9, 3, pressed); break;\r\n\t\t\tcase \"Minus\": this.handleKey(10, 3, pressed); break;\r\n\t\t\tcase \"Equal\": this.handleKey(11, 3, pressed); break;\r\n\t\t\tcase \"IntlYen\": this.handleKey(12, 3, pressed); break; // Present on Russian and Japanese keyboards.\r\n\t\t\t\r\n\t\t\tcase \"KeyQ\": this.handleKey(0, 2, pressed); break;\r\n\t\t\tcase \"KeyW\": this.handleKey(1, 2, pressed); break;\r\n\t\t\tcase \"KeyE\": this.handleKey(2, 2, pressed); break;\r\n\t\t\tcase \"KeyR\": this.handleKey(3, 2, pressed); break;\r\n\t\t\tcase \"KeyT\": this.handleKey(4, 2, pressed); break;\r\n\t\t\tcase \"KeyY\": this.handleKey(5, 2, pressed); break;\r\n\t\t\tcase \"KeyU\": this.handleKey(6, 2, pressed); break;\r\n\t\t\tcase \"KeyI\": this.handleKey(7, 2, pressed); break;\r\n\t\t\tcase \"KeyO\": this.handleKey(8, 2, pressed); break;\r\n\t\t\tcase \"KeyP\": this.handleKey(9, 2, pressed); break;\r\n\t\t\tcase \"BracketLeft\": this.handleKey(10, 2, pressed); break;\r\n\t\t\tcase \"BracketRight\": this.handleKey(11, 2, pressed); break;\r\n\t\t\tcase \"Backslash\":\r\n\t\t\t\t// Present on US keyboards... but on non-US keyboards it's also used at a different location, see \"IntlHash\" below. :/\r\n\t\t\t\tif (event.key == \"\\\\\" || event.key == \"|\") {\r\n\t\t\t\t\tthis.handleKey(12, 2, pressed);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis.handleKey(11, 1, pressed);\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\t\t\t\r\n\t\t\tcase \"KeyA\": this.handleKey(0, 1, pressed); break;\r\n\t\t\tcase \"KeyS\": this.handleKey(1, 1, pressed); break;\r\n\t\t\tcase \"KeyD\": this.handleKey(2, 1, pressed); break;\r\n\t\t\tcase \"KeyF\": this.handleKey(3, 1, pressed); break;\r\n\t\t\tcase \"KeyG\": this.handleKey(4, 1, pressed); break;\r\n\t\t\tcase \"KeyH\": this.handleKey(5, 1, pressed); break;\r\n\t\t\tcase \"KeyJ\": this.handleKey(6, 1, pressed); break;\r\n\t\t\tcase \"KeyK\": this.handleKey(7, 1, pressed); break;\r\n\t\t\tcase \"KeyL\": this.handleKey(8, 1, pressed); break;\r\n\t\t\tcase \"Semicolon\": this.handleKey(9, 1, pressed); break;\r\n\t\t\tcase \"Quote\": this.handleKey(10, 1, pressed); break;\r\n\t\t\tcase \"IntlHash\": this.handleKey(11, 1, pressed); break; // Present on non-US keyboards... but in practice it is actually represented as \"Backslash\" so this is obsolete. Oh well. :/\r\n\t\t\t\r\n\t\t\tcase \"IntlBackslash\": this.handleKey(-1, 0, pressed); break; // Present on Brazillian and many European keyboards.\r\n\t\t\tcase \"KeyZ\": this.handleKey(0, 0, pressed); break;\r\n\t\t\tcase \"KeyX\": this.handleKey(1, 0, pressed); break;\r\n\t\t\tcase \"KeyC\": this.handleKey(2, 0, pressed); break;\r\n\t\t\tcase \"KeyV\": this.handleKey(3, 0, pressed); break;\r\n\t\t\tcase \"KeyB\": this.handleKey(4, 0, pressed); break;\r\n\t\t\tcase \"KeyN\": this.handleKey(5, 0, pressed); break;\r\n\t\t\tcase \"KeyM\": this.handleKey(6, 0, pressed); break;\r\n\t\t\tcase \"Comma\": this.handleKey(7, 0, pressed); break;\r\n\t\t\tcase \"Period\": this.handleKey(8, 0, pressed); break;\r\n\t\t\tcase \"Slash\": this.handleKey(9, 0, pressed); break;\r\n\t\t\tcase \"IntlRo\": this.handleKey(10, 0, pressed); break; // Present on Brazillian and Japanese keyboards.\r\n\t\t\t\r\n\t\t\tdefault: return; //unhandled, don't prevent default.\r\n\t\t}\r\n\t\t\r\n\t\t// If the key event was handled as a note, prevent default behavior.\r\n\t\tevent.preventDefault();\r\n\t}\r\n\t\r\n\tpublic handleKey(x: number, y: number, pressed: boolean): void {\r\n\t\t\r\n\t\tconst isDrum: boolean = this._doc.song.getChannelIsNoise(this._doc.channel);\r\n\t\tif (isDrum) {\r\n\t\t\tif (x >= 0 && x < Config.drumCount) {\r\n\t\t\t\tif (pressed) {\r\n\t\t\t\t\tthis._doc.synth.preferLowerLatency = true;\r\n\t\t\t\t\tthis._doc.performance.addPerformedPitch(x);\r\n\t\t\t\t\tthis._possiblyPlayingPitchesFromKeyboard = true;\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis._doc.performance.removePerformedPitch(x);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\treturn;\r\n\t\t}\r\n\t\t\r\n\t\tconst pitch: number | null = KeyboardLayout.keyPosToPitch(this._doc, x, y, this._doc.prefs.keyboardLayout);\r\n\t\t\r\n\t\tif (pitch != null) {\r\n\t\t\tif (pressed) {\r\n\t\t\t\tthis._doc.synth.preferLowerLatency = true;\r\n\t\t\t\tthis._doc.performance.addPerformedPitch(pitch);\r\n\t\t\t\tthis._possiblyPlayingPitchesFromKeyboard = true;\r\n\t\t\t} else {\r\n\t\t\t\tthis._doc.performance.removePerformedPitch(pitch);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nimport {Config} from \"../synth/SynthConfig\";\r\nimport {SongDocument} from \"./SongDocument\";\r\nimport {HTML} from \"imperative-html/dist/esm/elements-strict\";\r\nimport {ColorConfig} from \"./ColorConfig\";\r\n\r\nexport class Piano {\r\n\tprivate readonly _pianoContainer: HTMLDivElement = HTML.div({style: \"width: 100%; height: 100%; display: flex; flex-direction: column-reverse; align-items: stretch;\"});\r\n\tprivate readonly _drumContainer: HTMLDivElement = HTML.div({style: \"width: 100%; height: 100%; display: flex; flex-direction: column-reverse; align-items: stretch;\"});\r\n\tprivate readonly _preview: HTMLDivElement = HTML.div({style: `width: 100%; height: 40px; border: 2px solid ${ColorConfig.primaryText}; position: absolute; box-sizing: border-box; pointer-events: none;`});\r\n\tpublic readonly container: HTMLDivElement = HTML.div({style: \"width: 32px; height: 100%; overflow: hidden; position: relative; flex-shrink: 0; touch-action: none;\"},\r\n\t\tthis._pianoContainer,\r\n\t\tthis._drumContainer,\r\n\t\tthis._preview,\r\n\t);\r\n\tprivate readonly _editorHeight: number = 481;\r\n\tprivate readonly _pianoKeys: HTMLDivElement[] = [];\r\n\tprivate readonly _pianoLabels: HTMLDivElement[] = [];\r\n\t\r\n\tprivate _pitchHeight: number;\r\n\tprivate _pitchCount: number;\r\n\t//private _mouseX: number = 0;\r\n\tprivate _mouseY: number = 0;\r\n\tprivate _mouseDown: boolean = false;\r\n\tprivate _mouseOver: boolean = false;\r\n\tprivate _cursorPitch: number;\r\n\tprivate _playedPitch: number = -1;\r\n\tprivate _renderedScale: number = -1;\r\n\tprivate _renderedDrums: boolean = false;\r\n\tprivate _renderedKey: number = -1;\r\n\tprivate _renderedPitchCount: number = -1;\r\n\tprivate readonly _renderedLiveInputPitches: number[] = [];\r\n\t\r\n\tconstructor(private _doc: SongDocument) {\r\n\t\tfor (let i: number = 0; i < Config.drumCount; i++) {\r\n\t\t\tconst scale: number = (1.0 - (i / Config.drumCount) * 0.35) * 100;\r\n\t\t\tthis._drumContainer.appendChild(HTML.div({class: \"drum-button\", style: `background-size: ${scale}% ${scale}%;`}));\r\n\t\t}\r\n\t\t\r\n\t\tthis.container.addEventListener(\"mousedown\", this._whenMousePressed);\r\n\t\tdocument.addEventListener(\"mousemove\", this._whenMouseMoved);\r\n\t\tdocument.addEventListener(\"mouseup\", this._whenMouseReleased);\r\n\t\tthis.container.addEventListener(\"mouseover\", this._whenMouseOver);\r\n\t\tthis.container.addEventListener(\"mouseout\", this._whenMouseOut);\r\n\t\t\r\n\t\tthis.container.addEventListener(\"touchstart\", this._whenTouchPressed);\r\n\t\tthis.container.addEventListener(\"touchmove\", this._whenTouchMoved);\r\n\t\tthis.container.addEventListener(\"touchend\", this._whenTouchReleased);\r\n\t\tthis.container.addEventListener(\"touchcancel\", this._whenTouchReleased);\r\n\t\t\r\n\t\tthis._doc.notifier.watch(this._documentChanged);\r\n\t\tthis._documentChanged();\r\n\t\t\r\n\t\twindow.requestAnimationFrame(this._onAnimationFrame);\r\n\t}\r\n\t\r\n\tprivate _updateCursorPitch(): void {\r\n\t\tconst scale: ReadonlyArray<boolean> = Config.scales[this._doc.song.scale].flags;\r\n\t\tconst mousePitch: number = Math.max(0, Math.min(this._pitchCount-1, this._pitchCount - (this._mouseY / this._pitchHeight)));\r\n\t\tif (scale[Math.floor(mousePitch) % Config.pitchesPerOctave] || this._doc.song.getChannelIsNoise(this._doc.channel)) {\r\n\t\t\tthis._cursorPitch = Math.floor(mousePitch);\r\n\t\t} else {\r\n\t\t\tlet topPitch: number = Math.floor(mousePitch) + 1;\r\n\t\t\tlet bottomPitch: number = Math.floor(mousePitch) - 1;\r\n\t\t\twhile (!scale[topPitch % Config.pitchesPerOctave]) {\r\n\t\t\t\ttopPitch++;\r\n\t\t\t}\r\n\t\t\twhile (!scale[(bottomPitch) % Config.pitchesPerOctave]) {\r\n\t\t\t\tbottomPitch--;\r\n\t\t\t}\r\n\t\t\tlet topRange: number = topPitch;\r\n\t\t\tlet bottomRange: number = bottomPitch + 1;\r\n\t\t\tif (topPitch % Config.pitchesPerOctave == 0 || topPitch % Config.pitchesPerOctave == 7) {\r\n\t\t\t\ttopRange -= 0.5;\r\n\t\t\t}\r\n\t\t\tif (bottomPitch % Config.pitchesPerOctave == 0 || bottomPitch % Config.pitchesPerOctave == 7) {\r\n\t\t\t\tbottomRange += 0.5;\r\n\t\t\t}\r\n\t\t\tthis._cursorPitch = mousePitch - bottomRange > topRange - mousePitch ? topPitch : bottomPitch;\r\n\t\t}\r\n\t}\r\n\t\r\n\tprivate _playLiveInput(): void {\r\n\t\tconst octaveOffset: number = this._doc.getBaseVisibleOctave(this._doc.channel) * Config.pitchesPerOctave;\r\n\t\tconst currentPitch: number = this._cursorPitch + octaveOffset;\r\n\t\tif (this._playedPitch == currentPitch) return;\r\n\t\tthis._doc.performance.removePerformedPitch(this._playedPitch);\r\n\t\tthis._playedPitch = currentPitch;\r\n\t\tthis._doc.performance.addPerformedPitch(currentPitch);\r\n\t}\r\n\t\r\n\tprivate _releaseLiveInput(): void {\r\n\t\tthis._doc.performance.removePerformedPitch(this._playedPitch);\r\n\t\tthis._playedPitch = -1;\r\n\t}\r\n\t\r\n\tprivate _whenMouseOver = (event: MouseEvent): void => {\r\n\t\tif (this._mouseOver) return;\r\n\t\tthis._mouseOver = true;\r\n\t\tthis._updatePreview();\r\n\t}\r\n\t\r\n\tprivate _whenMouseOut = (event: MouseEvent): void => {\r\n\t\tif (!this._mouseOver) return;\r\n\t\tthis._mouseOver = false;\r\n\t\tthis._updatePreview();\r\n\t}\r\n\t\r\n\tprivate _whenMousePressed = (event: MouseEvent): void => {\r\n\t\tevent.preventDefault();\r\n\t\tthis._doc.synth.maintainLiveInput();\r\n\t\tthis._mouseDown = true;\r\n\t\tconst boundingRect: ClientRect = this.container.getBoundingClientRect();\r\n\t\t//this._mouseX = (event.clientX || event.pageX) - boundingRect.left;\r\n\t\tthis._mouseY = ((event.clientY || event.pageY) - boundingRect.top) * this._editorHeight / (boundingRect.bottom - boundingRect.top);\r\n\t\tif (isNaN(this._mouseY)) this._mouseY = 0;\r\n\t\tthis._updateCursorPitch();\r\n\t\tthis._playLiveInput();\r\n\t\tthis._updatePreview();\r\n\t}\r\n\t\r\n\tprivate _whenMouseMoved = (event: MouseEvent): void => {\r\n\t\tif (this._mouseDown || this._mouseOver) this._doc.synth.maintainLiveInput();\r\n\t\tconst boundingRect: ClientRect = this.container.getBoundingClientRect();\r\n\t\t//this._mouseX = (event.clientX || event.pageX) - boundingRect.left;\r\n\t\tthis._mouseY = ((event.clientY || event.pageY) - boundingRect.top) * this._editorHeight / (boundingRect.bottom - boundingRect.top);\r\n\t\tif (isNaN(this._mouseY)) this._mouseY = 0;\r\n\t\tthis._updateCursorPitch();\r\n\t\tif (this._mouseDown) this._playLiveInput();\r\n\t\tthis._updatePreview();\r\n\t}\r\n\t\r\n\tprivate _whenMouseReleased = (event: MouseEvent): void => {\r\n\t\tif (this._mouseDown) this._releaseLiveInput();\r\n\t\tthis._mouseDown = false;\r\n\t\tthis._updatePreview();\r\n\t}\r\n\t\r\n\tprivate _whenTouchPressed = (event: TouchEvent): void => {\r\n\t\tevent.preventDefault();\r\n\t\tthis._doc.synth.maintainLiveInput();\r\n\t\tthis._mouseDown = true;\r\n\t\tconst boundingRect: ClientRect = this.container.getBoundingClientRect();\r\n\t\t//this._mouseX = event.touches[0].clientX - boundingRect.left;\r\n\t\tthis._mouseY = (event.touches[0].clientY - boundingRect.top) * this._editorHeight / (boundingRect.bottom - boundingRect.top);\r\n\t\tif (isNaN(this._mouseY)) this._mouseY = 0;\r\n\t\tthis._updateCursorPitch();\r\n\t\tthis._playLiveInput();\r\n\t}\r\n\t\r\n\tprivate _whenTouchMoved = (event: TouchEvent): void => {\r\n\t\tevent.preventDefault();\r\n\t\tthis._doc.synth.maintainLiveInput();\r\n\t\tconst boundingRect: ClientRect = this.container.getBoundingClientRect();\r\n\t\t//this._mouseX = event.touches[0].clientX - boundingRect.left;\r\n\t\tthis._mouseY = (event.touches[0].clientY - boundingRect.top) * this._editorHeight / (boundingRect.bottom - boundingRect.top);\r\n\t\tif (isNaN(this._mouseY)) this._mouseY = 0;\r\n\t\tthis._updateCursorPitch();\r\n\t\tif (this._mouseDown) this._playLiveInput();\r\n\t}\r\n\t\r\n\tprivate _whenTouchReleased = (event: TouchEvent): void => {\r\n\t\tevent.preventDefault();\r\n\t\tthis._mouseDown = false;\r\n\t\tthis._releaseLiveInput();\r\n\t}\r\n\t\r\n\tprivate _onAnimationFrame = (): void => {\r\n\t\twindow.requestAnimationFrame(this._onAnimationFrame);\r\n\t\t\r\n\t\tlet liveInputChanged: boolean = false;\r\n\t\tconst liveInputPitchCount: number = !this._doc.performance.pitchesAreTemporary() ? this._doc.synth.liveInputPitches.length : 0;\r\n\t\tif (this._renderedLiveInputPitches.length != liveInputPitchCount) {\r\n\t\t\tliveInputChanged = true;\r\n\t\t}\r\n\t\tfor (let i: number = 0; i < liveInputPitchCount; i++) {\r\n\t\t\tif (this._renderedLiveInputPitches[i] != this._doc.synth.liveInputPitches[i]) {\r\n\t\t\t\tthis._renderedLiveInputPitches[i] = this._doc.synth.liveInputPitches[i];\r\n\t\t\t\tliveInputChanged = true;\r\n\t\t\t}\r\n\t\t}\r\n\t\tthis._renderedLiveInputPitches.length = liveInputPitchCount;\r\n\t\t\r\n\t\tif (liveInputChanged) {\r\n\t\t\tthis._updatePreview();\r\n\t\t}\r\n\t}\r\n\t\r\n\tprivate _updatePreview(): void {\r\n\t\tthis._preview.style.visibility = (!this._mouseOver || this._mouseDown) ? \"hidden\" : \"visible\";\r\n\t\t\r\n\t\tif (this._mouseOver && !this._mouseDown) {\r\n\t\t\tconst boundingRect: ClientRect = this.container.getBoundingClientRect();\r\n\t\t\tconst pitchHeight: number = this._pitchHeight / (this._editorHeight / (boundingRect.bottom - boundingRect.top));\r\n\t\t\t\r\n\t\t\tthis._preview.style.left = \"0px\";\r\n\t\t\tthis._preview.style.top = pitchHeight * (this._pitchCount - this._cursorPitch - 1) + \"px\";\r\n\t\t\tthis._preview.style.height = pitchHeight + \"px\";\r\n\t\t}\r\n\t\t\r\n\t\tconst octaveOffset: number = this._doc.getBaseVisibleOctave(this._doc.channel) * Config.pitchesPerOctave;\r\n\t\tconst container: HTMLDivElement = this._doc.song.getChannelIsNoise(this._doc.channel) ? this._drumContainer : this._pianoContainer;\r\n\t\tconst children: HTMLCollection = container.children;\r\n\t\tfor (let i: number = 0; i < children.length; i++) {\r\n\t\t\tconst child: Element = children[i];\r\n\t\t\tif (this._renderedLiveInputPitches.indexOf(i + octaveOffset) == -1) {\r\n\t\t\t\tchild.classList.remove(\"pressed\");\r\n\t\t\t} else {\r\n\t\t\t\tchild.classList.add(\"pressed\");\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\t\r\n\tprivate _documentChanged = (): void => {\r\n\t\tconst isDrum: boolean = this._doc.song.getChannelIsNoise(this._doc.channel);\r\n\t\tthis._pitchCount = isDrum ? Config.drumCount : this._doc.getVisiblePitchCount();\r\n\t\tthis._pitchHeight = this._editorHeight / this._pitchCount;\r\n\t\tthis._updateCursorPitch();\r\n\t\tif (this._mouseDown) this._playLiveInput();\r\n\t\t\r\n\t\tif (!this._doc.prefs.showLetters) return;\r\n\t\tif (this._renderedScale == this._doc.song.scale && this._renderedKey == this._doc.song.key && this._renderedDrums == isDrum && this._renderedPitchCount == this._pitchCount) return;\r\n\t\t\r\n\t\tthis._renderedScale = this._doc.song.scale;\r\n\t\tthis._renderedKey = this._doc.song.key;\r\n\t\tthis._renderedDrums = isDrum;\r\n\t\t\r\n\t\tthis._pianoContainer.style.display = isDrum ? \"none\" : \"flex\";\r\n\t\tthis._drumContainer.style.display = isDrum ? \"flex\" : \"none\";\r\n\t\t\r\n\t\tif (!isDrum) {\r\n\t\t\tif (this._renderedPitchCount != this._pitchCount) {\r\n\t\t\t\tthis._pianoContainer.innerHTML = \"\";\r\n\t\t\t\tfor (let i: number = 0; i < this._pitchCount; i++) {\r\n\t\t\t\t\tconst pianoLabel: HTMLDivElement = HTML.div({class: \"piano-label\", style: \"font-weight: bold; -webkit-text-stroke-width: 0; font-size: 11px; font-family: sans-serif; position: absolute; padding-left: 15px;\"});\r\n\t\t\t\t\tconst pianoKey: HTMLDivElement = HTML.div({class: \"piano-button\", style: \"background: gray;\"}, pianoLabel);\r\n\t\t\t\t\tthis._pianoContainer.appendChild(pianoKey);\r\n\t\t\t\t\tthis._pianoLabels[i] = pianoLabel;\r\n\t\t\t\t\tthis._pianoKeys[i] = pianoKey;\r\n\t\t\t\t}\r\n\t\t\t\tthis._pianoLabels.length = this._pitchCount;\r\n\t\t\t\tthis._pianoKeys.length = this._pitchCount;\r\n\t\t\t\tthis._renderedPitchCount = this._pitchCount;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tfor (let j: number = 0; j < this._pitchCount; j++) {\r\n\t\t\t\tconst pitchNameIndex: number = (j + Config.keys[this._doc.song.key].basePitch) % Config.pitchesPerOctave;\r\n\t\t\t\tconst isWhiteKey: boolean = Config.keys[pitchNameIndex].isWhiteKey;\r\n\t\t\t\tthis._pianoKeys[j].style.background = isWhiteKey ? ColorConfig.whitePianoKey : ColorConfig.blackPianoKey;\r\n\t\t\t\tif (!Config.scales[this._doc.song.scale].flags[j % Config.pitchesPerOctave]) {\r\n\t\t\t\t\tthis._pianoKeys[j].classList.add(\"disabled\");\r\n\t\t\t\t\tthis._pianoLabels[j].style.display = \"none\";\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis._pianoKeys[j].classList.remove(\"disabled\");\r\n\t\t\t\t\tthis._pianoLabels[j].style.display = \"\";\r\n\t\t\t\t\t\r\n\t\t\t\t\tconst label: HTMLDivElement = this._pianoLabels[j];\r\n\t\t\t\t\tlabel.style.color = Config.keys[pitchNameIndex].isWhiteKey ? \"black\" : \"white\";\r\n\t\t\t\t\tlabel.textContent = Piano.getPitchName(pitchNameIndex, j);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\tthis._updatePreview();\r\n\t}\r\n\t\r\n\tpublic static getPitchName(pitchNameIndex: number, scaleIndex: number): string {\r\n\t\tlet text: string;\r\n\t\t\r\n\t\tif (Config.keys[pitchNameIndex].isWhiteKey) {\r\n\t\t\ttext = Config.keys[pitchNameIndex].name;\r\n\t\t} else {\r\n\t\t\tconst shiftDir: number = Config.blackKeyNameParents[scaleIndex % Config.pitchesPerOctave];\r\n\t\t\ttext = Config.keys[(pitchNameIndex + Config.pitchesPerOctave + shiftDir) % Config.pitchesPerOctave].name;\r\n\t\t\tif (shiftDir == 1) {\r\n\t\t\t\ttext += \"\";\r\n\t\t\t} else if (shiftDir == -1) {\r\n\t\t\t\ttext += \"\";\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\treturn text;\r\n\t}\r\n}\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nimport {Config} from \"../synth/SynthConfig\";\r\nimport {HTML} from \"imperative-html/dist/esm/elements-strict\";\r\nimport {SongDocument} from \"./SongDocument\";\r\nimport {Prompt} from \"./Prompt\";\r\nimport {ChangeBeatsPerBar} from \"./changes\";\r\nimport {ColorConfig} from \"./ColorConfig\";\r\n\r\nconst {button, div, span, h2, input, br, select, option} = HTML;\r\n\r\nexport class BeatsPerBarPrompt implements Prompt {\r\n\tprivate readonly _beatsStepper: HTMLInputElement = input({style: \"width: 3em; margin-left: 1em;\", type: \"number\", step: \"1\"});\r\n\tprivate readonly _conversionStrategySelect: HTMLSelectElement = select({style: \"width: 100%;\"},\r\n\t\toption({value: \"splice\"}, \"Splice beats at end of bars.\"),\r\n\t\toption({value: \"stretch\"}, \"Stretch notes to fit in bars.\"),\r\n\t\toption({value: \"overflow\"}, \"Overflow notes across bars.\"),\r\n\t);\r\n\tprivate readonly _cancelButton: HTMLButtonElement = button({class: \"cancelButton\"});\r\n\tprivate readonly _okayButton: HTMLButtonElement = button({class: \"okayButton\", style: \"width:45%;\"}, \"Okay\");\r\n\t\r\n\tpublic readonly container: HTMLDivElement = div({class: \"prompt noSelection\", style: \"width: 250px;\"},\r\n\t\th2(\"Beats Per Bar\"),\r\n\t\tdiv({style: \"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;\"},\r\n\t\t\tdiv({style: \"text-align: right;\"},\r\n\t\t\t\t\"Beats per bar:\",\r\n\t\t\t\tbr(),\r\n\t\t\t\tspan({style: `font-size: smaller; color: ${ColorConfig.secondaryText};`}, \"(Multiples of 3 or 4 are recommended)\"),\r\n\t\t\t),\r\n\t\t\tthis._beatsStepper,\r\n\t\t),\r\n\t\tdiv({style: \"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;\"},\r\n\t\t\tdiv({class: \"selectContainer\", style: \"width: 100%;\"}, this._conversionStrategySelect),\r\n\t\t),\r\n\t\tdiv({style: \"display: flex; flex-direction: row-reverse; justify-content: space-between;\"},\r\n\t\t\tthis._okayButton,\r\n\t\t),\r\n\t\tthis._cancelButton,\r\n\t);\r\n\t\r\n\tconstructor(private _doc: SongDocument) {\r\n\t\tthis._beatsStepper.value = this._doc.song.beatsPerBar + \"\";\r\n\t\tthis._beatsStepper.min = Config.beatsPerBarMin + \"\";\r\n\t\tthis._beatsStepper.max = Config.beatsPerBarMax + \"\";\r\n\t\t\r\n\t\tconst lastStrategy: string | null = window.localStorage.getItem(\"beatCountStrategy\");\r\n\t\tif (lastStrategy != null) {\r\n\t\t\tthis._conversionStrategySelect.value = lastStrategy;\r\n\t\t}\r\n\t\t\r\n\t\tthis._beatsStepper.select();\r\n\t\tsetTimeout(()=>this._beatsStepper.focus());\r\n\t\t\r\n\t\tthis._okayButton.addEventListener(\"click\", this._saveChanges);\r\n\t\tthis._cancelButton.addEventListener(\"click\", this._close);\r\n\t\tthis._beatsStepper.addEventListener(\"keypress\", BeatsPerBarPrompt._validateKey);\r\n\t\tthis._beatsStepper.addEventListener(\"blur\", BeatsPerBarPrompt._validateNumber);\r\n\t\tthis.container.addEventListener(\"keydown\", this._whenKeyPressed);\r\n\t}\r\n\t\r\n\tprivate _close = (): void => { \r\n\t\tthis._doc.undo();\r\n\t}\r\n\t\r\n\tpublic cleanUp = (): void => { \r\n\t\tthis._okayButton.removeEventListener(\"click\", this._saveChanges);\r\n\t\tthis._cancelButton.removeEventListener(\"click\", this._close);\r\n\t\tthis._beatsStepper.removeEventListener(\"keypress\", BeatsPerBarPrompt._validateKey);\r\n\t\tthis._beatsStepper.removeEventListener(\"blur\", BeatsPerBarPrompt._validateNumber);\r\n\t\tthis.container.removeEventListener(\"keydown\", this._whenKeyPressed);\r\n\t}\r\n\t\r\n\tprivate _whenKeyPressed = (event: KeyboardEvent): void => {\r\n\t\tif ((<Element> event.target).tagName != \"BUTTON\" && event.keyCode == 13) { // Enter key\r\n\t\t\tthis._saveChanges();\r\n\t\t}\r\n\t}\r\n\t\r\n\tprivate static _validateKey(event: KeyboardEvent): boolean {\r\n\t\tconst charCode = (event.which) ? event.which : event.keyCode;\r\n\t\tif (charCode != 46 && charCode > 31 && (charCode < 48 || charCode > 57)) {\r\n\t\t\tevent.preventDefault();\r\n\t\t\treturn true;\r\n\t\t}\r\n\t\treturn false;\r\n\t}\r\n\t\r\n\tprivate static _validateNumber(event: Event): void {\r\n\t\tconst input: HTMLInputElement = <HTMLInputElement>event.target;\r\n\t\tinput.value = String(BeatsPerBarPrompt._validate(input));\r\n\t}\r\n\t\r\n\tprivate static _validate(input: HTMLInputElement): number {\r\n\t\treturn Math.floor(Math.max(Number(input.min), Math.min(Number(input.max), Number(input.value))));\r\n\t}\r\n\t\r\n\tprivate _saveChanges = (): void => {\r\n\t\twindow.localStorage.setItem(\"beatCountStrategy\", this._conversionStrategySelect.value);\r\n\t\tthis._doc.prompt = null;\r\n\t\tthis._doc.record(new ChangeBeatsPerBar(this._doc, BeatsPerBarPrompt._validate(this._beatsStepper), this._conversionStrategySelect.value), true);\r\n\t}\r\n}\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nimport {Config} from \"../synth/SynthConfig\";\r\nimport {HTML} from \"imperative-html/dist/esm/elements-strict\";\r\nimport {SongDocument} from \"./SongDocument\";\r\nimport {Prompt} from \"./Prompt\";\r\nimport {ChangeMoveNotesSideways} from \"./changes\";\r\nimport {ColorConfig} from \"./ColorConfig\";\r\n\r\nconst {button, div, span, h2, input, br, select, option} = HTML;\r\n\r\nexport class MoveNotesSidewaysPrompt implements Prompt {\r\n\tprivate readonly _beatsStepper: HTMLInputElement = input({style: \"width: 3em; margin-left: 1em;\", type: \"number\", step: \"0.01\", value: \"0\"});\r\n\tprivate readonly _conversionStrategySelect: HTMLSelectElement = select({style: \"width: 100%;\"},\r\n\t\toption({value: \"overflow\"}, \"Overflow notes across bars.\"),\r\n\t\toption({value: \"wrapAround\"}, \"Wrap notes around within bars.\"),\r\n\t);\r\n\tprivate readonly _cancelButton: HTMLButtonElement = button({class: \"cancelButton\"});\r\n\tprivate readonly _okayButton: HTMLButtonElement = button({class: \"okayButton\", style: \"width:45%;\"}, \"Okay\");\r\n\t\r\n\tpublic readonly container: HTMLDivElement = div({class: \"prompt noSelection\", style: \"width: 250px;\"},\r\n\t\th2(\"Move Notes Sideways\"),\r\n\t\tdiv({style: \"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;\"},\r\n\t\t\tdiv({style: \"text-align: right;\"},\r\n\t\t\t\t\"Beats to move:\",\r\n\t\t\t\tbr(),\r\n\t\t\t\tspan({style: `font-size: smaller; color: ${ColorConfig.secondaryText};`}, \"(Negative is left, positive is right)\"),\r\n\t\t\t),\r\n\t\t\tthis._beatsStepper,\r\n\t\t),\r\n\t\tdiv({style: \"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;\"},\r\n\t\t\tdiv({class: \"selectContainer\", style: \"width: 100%;\"}, this._conversionStrategySelect),\r\n\t\t),\r\n\t\tdiv({style: \"display: flex; flex-direction: row-reverse; justify-content: space-between;\"},\r\n\t\t\tthis._okayButton,\r\n\t\t),\r\n\t\tthis._cancelButton,\r\n\t);\r\n\t\r\n\tconstructor(private _doc: SongDocument) {\r\n\t\tthis._beatsStepper.min = (-this._doc.song.beatsPerBar) + \"\";\r\n\t\tthis._beatsStepper.max = this._doc.song.beatsPerBar + \"\";\r\n\t\t\r\n\t\tconst lastStrategy: string | null = window.localStorage.getItem(\"moveNotesSidewaysStrategy\");\r\n\t\tif (lastStrategy != null) {\r\n\t\t\tthis._conversionStrategySelect.value = lastStrategy;\r\n\t\t}\r\n\t\t\r\n\t\tthis._beatsStepper.select();\r\n\t\tsetTimeout(()=>this._beatsStepper.focus());\r\n\t\t\r\n\t\tthis._okayButton.addEventListener(\"click\", this._saveChanges);\r\n\t\tthis._cancelButton.addEventListener(\"click\", this._close);\r\n\t\tthis._beatsStepper.addEventListener(\"blur\", MoveNotesSidewaysPrompt._validateNumber);\r\n\t\tthis.container.addEventListener(\"keydown\", this._whenKeyPressed);\r\n\t}\r\n\t\r\n\tprivate _close = (): void => { \r\n\t\tthis._doc.undo();\r\n\t}\r\n\t\r\n\tpublic cleanUp = (): void => { \r\n\t\tthis._okayButton.removeEventListener(\"click\", this._saveChanges);\r\n\t\tthis._cancelButton.removeEventListener(\"click\", this._close);\r\n\t\tthis._beatsStepper.removeEventListener(\"blur\", MoveNotesSidewaysPrompt._validateNumber);\r\n\t\tthis.container.removeEventListener(\"keydown\", this._whenKeyPressed);\r\n\t}\r\n\t\r\n\tprivate _whenKeyPressed = (event: KeyboardEvent): void => {\r\n\t\tif ((<Element> event.target).tagName != \"BUTTON\" && event.keyCode == 13) { // Enter key\r\n\t\t\tthis._saveChanges();\r\n\t\t}\r\n\t}\r\n\t\r\n\tprivate static _validateNumber(event: Event): void {\r\n\t\tconst input: HTMLInputElement = <HTMLInputElement>event.target;\r\n\t\tlet value: number = +input.value;\r\n\t\tvalue = Math.round(value * Config.partsPerBeat) / Config.partsPerBeat;\r\n\t\tvalue = Math.round(value * 100) / 100;\r\n\t\tinput.value = Math.max(+input.min, Math.min(+input.max, value)) + \"\";\r\n\t}\r\n\t\r\n\tprivate _saveChanges = (): void => {\r\n\t\twindow.localStorage.setItem(\"moveNotesSidewaysStrategy\", this._conversionStrategySelect.value);\r\n\t\tthis._doc.prompt = null;\r\n\t\tthis._doc.record(new ChangeMoveNotesSideways(this._doc, +this._beatsStepper.value, this._conversionStrategySelect.value), true);\r\n\t}\r\n}\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nimport {Config} from \"../synth/SynthConfig\";\r\nimport {HTML} from \"imperative-html/dist/esm/elements-strict\";\r\nimport {SongDocument} from \"./SongDocument\";\r\nimport {Prompt} from \"./Prompt\";\r\nimport {ChangeGroup} from \"./Change\";\r\nimport {ChangeBarCount} from \"./changes\";\r\nimport {ColorConfig} from \"./ColorConfig\";\r\n\r\nconst {button, div, span, h2, input, br, select, option} = HTML;\r\n\r\nexport class SongDurationPrompt implements Prompt {\r\n\tprivate readonly _barsStepper: HTMLInputElement = input({style: \"width: 3em; margin-left: 1em;\", type: \"number\", step: \"1\"});\r\n\tprivate readonly _positionSelect: HTMLSelectElement = select({style: \"width: 100%;\"},\r\n\t\toption({value: \"end\"},       \"Apply change at end of song.\"),\r\n\t\toption({value: \"beginning\"}, \"Apply change at beginning of song.\"),\r\n\t);\r\n\tprivate readonly _cancelButton: HTMLButtonElement = button({class: \"cancelButton\"});\r\n\tprivate readonly _okayButton: HTMLButtonElement = button({class: \"okayButton\", style: \"width:45%;\"}, \"Okay\");\r\n\t\r\n\tpublic readonly container: HTMLDivElement = div({class: \"prompt noSelection\", style: \"width: 250px;\"},\r\n\t\th2(\"Song Length\"),\r\n\t\tdiv({style: \"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;\"},\r\n\t\t\tdiv({style: \"display: inline-block; text-align: right;\"},\r\n\t\t\t\t\"Bars per song:\",\r\n\t\t\t\tbr(),\r\n\t\t\t\tspan({style: `font-size: smaller; color: ${ColorConfig.secondaryText};`}, \"(Multiples of 4 are recommended)\"),\r\n\t\t\t),\r\n\t\t\tthis._barsStepper,\r\n\t\t),\r\n\t\tdiv({style: \"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;\"},\r\n\t\t\tdiv({class: \"selectContainer\", style: \"width: 100%;\"}, this._positionSelect),\r\n\t\t),\r\n\t\tdiv({style: \"display: flex; flex-direction: row-reverse; justify-content: space-between;\"},\r\n\t\t\tthis._okayButton,\r\n\t\t),\r\n\t\tthis._cancelButton,\r\n\t);\r\n\t\r\n\tconstructor(private _doc: SongDocument) {\r\n\t\tthis._barsStepper.value = this._doc.song.barCount + \"\";\r\n\t\tthis._barsStepper.min = Config.barCountMin + \"\";\r\n\t\tthis._barsStepper.max = Config.barCountMax + \"\";\r\n\t\t\r\n\t\tconst lastPosition: string | null = window.localStorage.getItem(\"barCountPosition\");\r\n\t\tif (lastPosition != null) {\r\n\t\t\tthis._positionSelect.value = lastPosition;\r\n\t\t}\r\n\t\t\r\n\t\tthis._barsStepper.select();\r\n\t\tsetTimeout(()=>this._barsStepper.focus());\r\n\t\t\r\n\t\tthis._okayButton.addEventListener(\"click\", this._saveChanges);\r\n\t\tthis._cancelButton.addEventListener(\"click\", this._close);\r\n\t\tthis._barsStepper.addEventListener(\"keypress\", SongDurationPrompt._validateKey);\r\n\t\tthis._barsStepper.addEventListener(\"blur\", SongDurationPrompt._validateNumber);\r\n\t\tthis.container.addEventListener(\"keydown\", this._whenKeyPressed);\r\n\t}\r\n\t\r\n\tprivate _close = (): void => { \r\n\t\tthis._doc.undo();\r\n\t}\r\n\t\r\n\tpublic cleanUp = (): void => {\r\n\t\tthis._okayButton.removeEventListener(\"click\", this._saveChanges);\r\n\t\tthis._cancelButton.removeEventListener(\"click\", this._close);\r\n\t\tthis._barsStepper.removeEventListener(\"keypress\", SongDurationPrompt._validateKey);\r\n\t\tthis._barsStepper.removeEventListener(\"blur\", SongDurationPrompt._validateNumber);\r\n\t\tthis.container.removeEventListener(\"keydown\", this._whenKeyPressed);\r\n\t}\r\n\t\r\n\tprivate _whenKeyPressed = (event: KeyboardEvent): void => {\r\n\t\tif ((<Element> event.target).tagName != \"BUTTON\" && event.keyCode == 13) { // Enter key\r\n\t\t\tthis._saveChanges();\r\n\t\t}\r\n\t}\r\n\t\r\n\tprivate static _validateKey(event: KeyboardEvent): boolean {\r\n\t\tconst charCode = (event.which) ? event.which : event.keyCode;\r\n\t\tif (charCode != 46 && charCode > 31 && (charCode < 48 || charCode > 57)) {\r\n\t\t\tevent.preventDefault();\r\n\t\t\treturn true;\r\n\t\t}\r\n\t\treturn false;\r\n\t}\r\n\t\r\n\tprivate static _validateNumber(event: Event): void {\r\n\t\tconst input: HTMLInputElement = <HTMLInputElement>event.target;\r\n\t\tinput.value = String(SongDurationPrompt._validate(input));\r\n\t}\r\n\t\r\n\tprivate static _validate(input: HTMLInputElement): number {\r\n\t\treturn Math.floor(Math.max(Number(input.min), Math.min(Number(input.max), Number(input.value))));\r\n\t}\r\n\t\r\n\tprivate _saveChanges = (): void => {\r\n\t\twindow.localStorage.setItem(\"barCountPosition\", this._positionSelect.value);\r\n\t\tconst group: ChangeGroup = new ChangeGroup();\r\n\t\tgroup.append(new ChangeBarCount(this._doc, SongDurationPrompt._validate(this._barsStepper), this._positionSelect.value == \"beginning\"));\r\n\t\tthis._doc.prompt = null;\r\n\t\tthis._doc.record(group, true);\r\n\t}\r\n}\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nimport {Config} from \"../synth/SynthConfig\";\r\nimport {Instrument} from \"../synth/synth\";\r\nimport {HTML} from \"imperative-html/dist/esm/elements-strict\";\r\nimport {SongDocument} from \"./SongDocument\";\r\nimport {Prompt} from \"./Prompt\";\r\nimport {ChangeGroup} from \"./Change\";\r\nimport {ChangeStringSustainType} from \"./changes\";\r\n\r\nconst {button, div, h2, p, select, option} = HTML;\r\n\r\nexport class SustainPrompt implements Prompt {\r\n\tprivate readonly _typeSelect: HTMLSelectElement = select({style: \"width: 100%;\"},\r\n\t\toption({value: \"acoustic\"}, \"(A) Acoustic\"),\r\n\t\toption({value: \"bright\"}, \"(B) Bright\"),\r\n\t);\r\n\tprivate readonly _cancelButton: HTMLButtonElement = button({class: \"cancelButton\"});\r\n\tprivate readonly _okayButton: HTMLButtonElement = button({class: \"okayButton\", style: \"width:45%;\"}, \"Okay\");\r\n\t\r\n\tpublic readonly container: HTMLDivElement = div({class: \"prompt\", style: \"width: 300px;\"},\r\n\t\tdiv(\r\n\t\t\th2(\"String Sustain\"),\r\n\t\t\tp(\"This setting controls how quickly the picked string vibration decays.\"),\r\n\t\t\tp(\"Unlike most of BeepBox's instrument synthesizer features, a picked string cannot change frequency suddenly while maintaining its decay. If a tone's pitch changes suddenly (e.g. if the chord type is set to \\\"arpeggio\\\" or the transition type is set to \\\"continues\\\") then the string will be re-picked and start decaying from the beginning again, even if the envelopes don't otherwise restart.\"),\r\n\t\t),\r\n\t\tdiv({style: {display: Config.enableAcousticSustain ? undefined : \"none\"}},\r\n\t\t\tp(\"BeepBox comes with two slightly different sustain designs. You can select one here and press \\\"Okay\\\" to confirm it.\"),\r\n\t\t\tdiv({class: \"selectContainer\", style: \"width: 100%;\"}, this._typeSelect),\r\n\t\t),\r\n\t\tdiv({style: {display: Config.enableAcousticSustain ? \"flex\" : \"none\", \"flex-direction\": \"row-reverse\", \"justify-content\": \"space-between\"}},\r\n\t\t\tthis._okayButton,\r\n\t\t),\r\n\t\tthis._cancelButton,\r\n\t);\r\n\t\r\n\tconstructor(private _doc: SongDocument) {\r\n\t\tconst instrument: Instrument = this._doc.song.channels[this._doc.channel].instruments[this._doc.getCurrentInstrument()];\r\n\t\tthis._typeSelect.value = Config.sustainTypeNames[instrument.stringSustainType];\r\n\t\t\r\n\t\tsetTimeout(()=>this._cancelButton.focus());\r\n\t\t\r\n\t\tthis._okayButton.addEventListener(\"click\", this._saveChanges);\r\n\t\tthis._cancelButton.addEventListener(\"click\", this._close);\r\n\t\tthis.container.addEventListener(\"keydown\", this._whenKeyPressed);\r\n\t}\r\n\t\r\n\tprivate _close = (): void => { \r\n\t\tthis._doc.undo();\r\n\t}\r\n\t\r\n\tpublic cleanUp = (): void => { \r\n\t\tthis._okayButton.removeEventListener(\"click\", this._saveChanges);\r\n\t\tthis._cancelButton.removeEventListener(\"click\", this._close);\r\n\t\tthis.container.removeEventListener(\"keydown\", this._whenKeyPressed);\r\n\t}\r\n\t\r\n\tprivate _whenKeyPressed = (event: KeyboardEvent): void => {\r\n\t\tif ((<Element> event.target).tagName != \"BUTTON\" && event.keyCode == 13) { // Enter key\r\n\t\t\tthis._saveChanges();\r\n\t\t}\r\n\t}\r\n\t\r\n\tprivate _saveChanges = (): void => {\r\n\t\tif (Config.enableAcousticSustain) {\r\n\t\t\tconst group: ChangeGroup = new ChangeGroup();\r\n\t\t\tgroup.append(new ChangeStringSustainType(this._doc, <any> Config.sustainTypeNames.indexOf(this._typeSelect.value)));\r\n\t\t\tthis._doc.prompt = null;\r\n\t\t\tthis._doc.record(group, true);\r\n\t\t} else {\r\n\t\t\tthis._close();\r\n\t\t}\r\n\t}\r\n}\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nimport {Config} from \"../synth/SynthConfig\";\r\nimport {HTML} from \"imperative-html/dist/esm/elements-strict\";\r\nimport {SongDocument} from \"./SongDocument\";\r\nimport {Prompt} from \"./Prompt\";\r\nimport {ChangeGroup} from \"./Change\";\r\nimport {ChangePatternsPerChannel, ChangeInstrumentsFlags, ChangeChannelCount} from \"./changes\";\r\n\r\nconst {button, div, label, br, h2, input} = HTML;\r\n\r\nexport class ChannelSettingsPrompt implements Prompt {\r\n\tprivate readonly _patternsStepper: HTMLInputElement = input({style: \"width: 3em; margin-left: 1em;\", type: \"number\", step: \"1\"});\r\n\tprivate readonly _pitchChannelStepper: HTMLInputElement = input({style: \"width: 3em; margin-left: 1em;\", type: \"number\", step: \"1\"});\r\n\tprivate readonly _drumChannelStepper: HTMLInputElement = input({style: \"width: 3em; margin-left: 1em;\", type: \"number\", step: \"1\"});\r\n\tprivate readonly _layeredInstrumentsBox: HTMLInputElement = input({style: \"width: 3em; margin-left: 1em;\", type: \"checkbox\"});\r\n\tprivate readonly _patternInstrumentsBox: HTMLInputElement = input({style: \"width: 3em; margin-left: 1em;\", type: \"checkbox\"});\r\n\tprivate readonly _cancelButton: HTMLButtonElement = button({class: \"cancelButton\"});\r\n\tprivate readonly _okayButton: HTMLButtonElement = button({class: \"okayButton\", style: \"width:45%;\"}, \"Okay\");\r\n\t\r\n\tpublic readonly container: HTMLDivElement = div({class: \"prompt noSelection\", style: \"width: 250px; text-align: right;\"},\r\n\t\th2(\"Channel Settings\"),\r\n\t\tlabel({style: \"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;\"},\r\n\t\t\t\"Pitch channels:\",\r\n\t\t\tthis._pitchChannelStepper,\r\n\t\t),\r\n\t\tlabel({style: \"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;\"},\r\n\t\t\t\"Drum channels:\",\r\n\t\t\tthis._drumChannelStepper,\r\n\t\t),\r\n\t\tlabel({style: \"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;\"},\r\n\t\t\t\"Available patterns per channel:\",\r\n\t\t\tthis._patternsStepper,\r\n\t\t),\r\n\t\tlabel({style: \"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;\"},\r\n\t\t\t\"Simultaneous instruments\",\r\n\t\t\tbr(),\r\n\t\t\t\"per channel:\",\r\n\t\t\tthis._layeredInstrumentsBox,\r\n\t\t),\r\n\t\tlabel({style: \"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;\"},\r\n\t\t\t\"Different instruments\",\r\n\t\t\tbr(),\r\n\t\t\t\"per pattern:\",\r\n\t\t\tthis._patternInstrumentsBox,\r\n\t\t),\r\n\t\tdiv({style: \"display: flex; flex-direction: row-reverse; justify-content: space-between;\"},\r\n\t\t\tthis._okayButton,\r\n\t\t),\r\n\t\tthis._cancelButton,\r\n\t);\r\n\t\r\n\tconstructor(private _doc: SongDocument) {\r\n\t\tthis._patternsStepper.value = this._doc.song.patternsPerChannel + \"\";\r\n\t\tthis._patternsStepper.min = \"1\";\r\n\t\tthis._patternsStepper.max = Config.barCountMax + \"\";\r\n\t\t\r\n\t\tthis._pitchChannelStepper.value = this._doc.song.pitchChannelCount + \"\";\r\n\t\tthis._pitchChannelStepper.min = Config.pitchChannelCountMin + \"\";\r\n\t\tthis._pitchChannelStepper.max = Config.pitchChannelCountMax + \"\";\r\n\t\t\r\n\t\tthis._drumChannelStepper.value = this._doc.song.noiseChannelCount + \"\";\r\n\t\tthis._drumChannelStepper.min = Config.noiseChannelCountMin + \"\";\r\n\t\tthis._drumChannelStepper.max = Config.noiseChannelCountMax + \"\";\r\n\t\t\r\n\t\tthis._layeredInstrumentsBox.checked = this._doc.song.layeredInstruments;\r\n\t\tthis._patternInstrumentsBox.checked = this._doc.song.patternInstruments;\r\n\t\t\r\n\t\tthis._pitchChannelStepper.select();\r\n\t\tsetTimeout(()=>this._pitchChannelStepper.focus());\r\n\t\t\r\n\t\tthis._okayButton.addEventListener(\"click\", this._saveChanges);\r\n\t\tthis._cancelButton.addEventListener(\"click\", this._close);\r\n\t\tthis._patternsStepper.addEventListener(\"keypress\", ChannelSettingsPrompt._validateKey);\r\n\t\tthis._pitchChannelStepper.addEventListener(\"keypress\", ChannelSettingsPrompt._validateKey);\r\n\t\tthis._drumChannelStepper.addEventListener(\"keypress\", ChannelSettingsPrompt._validateKey);\r\n\t\tthis._patternsStepper.addEventListener(\"blur\", this._validateNumber);\r\n\t\tthis._pitchChannelStepper.addEventListener(\"blur\", this._validateNumber);\r\n\t\tthis._drumChannelStepper.addEventListener(\"blur\", this._validateNumber);\r\n\t\tthis.container.addEventListener(\"keydown\", this._whenKeyPressed);\r\n\t}\r\n\t\r\n\tprivate _close = (): void => { \r\n\t\tthis._doc.undo();\r\n\t}\r\n\t\r\n\tpublic cleanUp = (): void => { \r\n\t\tthis._okayButton.removeEventListener(\"click\", this._saveChanges);\r\n\t\tthis._cancelButton.removeEventListener(\"click\", this._close);\r\n\t\tthis._patternsStepper.removeEventListener(\"keypress\", ChannelSettingsPrompt._validateKey);\r\n\t\tthis._pitchChannelStepper.removeEventListener(\"keypress\", ChannelSettingsPrompt._validateKey);\r\n\t\tthis._drumChannelStepper.removeEventListener(\"keypress\", ChannelSettingsPrompt._validateKey);\r\n\t\tthis._patternsStepper.removeEventListener(\"blur\", this._validateNumber);\r\n\t\tthis._pitchChannelStepper.removeEventListener(\"blur\", this._validateNumber);\r\n\t\tthis._drumChannelStepper.removeEventListener(\"blur\", this._validateNumber);\r\n\t\tthis.container.removeEventListener(\"keydown\", this._whenKeyPressed);\r\n\t}\r\n\t\r\n\tprivate _whenKeyPressed = (event: KeyboardEvent): void => {\r\n\t\tif ((<Element> event.target).tagName != \"BUTTON\" && event.keyCode == 13) { // Enter key\r\n\t\t\tthis._saveChanges();\r\n\t\t}\r\n\t}\r\n\t\r\n\tprivate static _validateKey(event: KeyboardEvent): boolean {\r\n\t\tconst charCode = (event.which) ? event.which : event.keyCode;\r\n\t\tif (charCode != 46 && charCode > 31 && (charCode < 48 || charCode > 57)) {\r\n\t\t\tevent.preventDefault();\r\n\t\t\treturn true;\r\n\t\t}\r\n\t\treturn false;\r\n\t}\r\n\t\r\n\tprivate _validateNumber = (event: Event): void => {\r\n\t\tconst input: HTMLInputElement = <HTMLInputElement>event.target;\r\n\t\tinput.value = String(ChannelSettingsPrompt._validate(input));\r\n\t}\r\n\t\r\n\tprivate static _validate(input: HTMLInputElement): number {\r\n\t\treturn Math.floor(Math.max(Number(input.min), Math.min(Number(input.max), Number(input.value))));\r\n\t}\r\n\t\r\n\tprivate _saveChanges = (): void => {\r\n\t\tconst group: ChangeGroup = new ChangeGroup();\r\n\t\tgroup.append(new ChangeInstrumentsFlags(this._doc, this._layeredInstrumentsBox.checked, this._patternInstrumentsBox.checked));\r\n\t\tgroup.append(new ChangePatternsPerChannel(this._doc, ChannelSettingsPrompt._validate(this._patternsStepper)));\r\n\t\tgroup.append(new ChangeChannelCount(this._doc, ChannelSettingsPrompt._validate(this._pitchChannelStepper), ChannelSettingsPrompt._validate(this._drumChannelStepper)));\r\n\t\tthis._doc.prompt = null;\r\n\t\tthis._doc.record(group, true);\r\n\t}\r\n}\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nfunction transfer(source: ArrayBuffer, length: number): ArrayBuffer {\r\n\tconst dest: ArrayBuffer = new ArrayBuffer(length);\r\n\tlet nextOffset = 0;\r\n\tlet leftBytes = Math.min(source.byteLength, dest.byteLength);\r\n\tconst wordSizes = [8, 4, 2, 1];\r\n\tfor (const wordSize of wordSizes) {\r\n\t\tif (leftBytes >= wordSize) {\r\n\t\t\tconst done = transferWith(wordSize, source, dest, nextOffset, leftBytes);\r\n\t\t\tnextOffset = done.nextOffset;\r\n\t\t\tleftBytes = done.leftBytes;\r\n\t\t}\r\n\t}\r\n\treturn dest;\r\n\tfunction transferWith(wordSize: number, source: ArrayBuffer, dest: ArrayBuffer, nextOffset: number, leftBytes: number) {\r\n\t\tlet ViewClass: any = Uint8Array;\r\n\t\tswitch (wordSize) {\r\n\t\t\tcase 8:\r\n\t\t\t\tViewClass = Float64Array;\r\n\t\t\t\tbreak;\r\n\t\t\tcase 4:\r\n\t\t\t\tViewClass = Float32Array;\r\n\t\t\t\tbreak;\r\n\t\t\tcase 2:\r\n\t\t\t\tViewClass = Uint16Array;\r\n\t\t\t\tbreak;\r\n\t\t\tcase 1:\r\n\t\t\t\tViewClass = Uint8Array;\r\n\t\t\t\tbreak;\r\n\t\t\tdefault:\r\n\t\t\t\tViewClass = Uint8Array;\r\n\t\t\t\tbreak;\r\n\t\t}\r\n\t\t\r\n\t\tconst view_source = new ViewClass(source, nextOffset, (leftBytes / wordSize) | 0);\r\n\t\tconst view_dest = new ViewClass(dest, nextOffset, (leftBytes / wordSize) | 0);\r\n\t\tfor (let i: number = 0; i < view_dest.length; i++) {\r\n\t\t\tview_dest[i] = view_source[i];\r\n\t\t}\r\n\t\treturn {\r\n\t\t\tnextOffset : view_source.byteOffset + view_source.byteLength,\r\n\t\t\tleftBytes : leftBytes - view_dest.length * wordSize,\r\n\t\t}\r\n\t}\r\n}\r\n\r\n// Note: All methods are big endian.\r\nexport class ArrayBufferWriter {\r\n\tprivate _writeIndex: number = 0;\r\n\tprivate _fileSize: number = 0;\r\n\tprivate _arrayBuffer: ArrayBuffer;\r\n\tprivate _data: DataView;\r\n\t\r\n\tconstructor(initialCapacity: number) {\r\n\t\tthis._arrayBuffer = new ArrayBuffer(initialCapacity);\r\n\t\tthis._data = new DataView(this._arrayBuffer);\r\n\t}\r\n\t\r\n\tprivate _addBytes(numBytes: number): void {\r\n\t\tthis._fileSize += numBytes;\r\n\t\tif (this._fileSize > this._arrayBuffer.byteLength) {\r\n\t\t\tthis._arrayBuffer = transfer(this._arrayBuffer, Math.max(this._arrayBuffer.byteLength * 2, this._fileSize));\r\n\t\t\tthis._data = new DataView(this._arrayBuffer);\r\n\t\t}\r\n\t}\r\n\t\r\n\tpublic getWriteIndex(): number {\r\n\t\treturn this._writeIndex;\r\n\t}\r\n\t\r\n\tpublic rewriteUint32(index: number, value: number): void {\r\n\t\tthis._data.setUint32(index, value >>> 0, false);\r\n\t}\r\n\t\r\n\tpublic writeUint32(value: number): void {\r\n\t\tvalue = value >>> 0;\r\n\t\tthis._addBytes(4);\r\n\t\tthis._data.setUint32(this._writeIndex, value, false);\r\n\t\tthis._writeIndex = this._fileSize;\r\n\t}\r\n\t\r\n\tpublic writeUint24(value: number): void {\r\n\t\tvalue = value >>> 0;\r\n\t\tthis._addBytes(3);\r\n\t\tthis._data.setUint8(this._writeIndex  , (value>>16)&0xff);\r\n\t\tthis._data.setUint8(this._writeIndex+1, (value>> 8)&0xff);\r\n\t\tthis._data.setUint8(this._writeIndex+2, (value    )&0xff);\r\n\t\tthis._writeIndex = this._fileSize;\r\n\t}\r\n\t\r\n\tpublic writeUint16(value: number): void {\r\n\t\tvalue = value >>> 0;\r\n\t\tthis._addBytes(2);\r\n\t\tthis._data.setUint16(this._writeIndex, value, false);\r\n\t\tthis._writeIndex = this._fileSize;\r\n\t}\r\n\t\r\n\tpublic writeUint8(value: number): void {\r\n\t\tvalue = value >>> 0;\r\n\t\tthis._addBytes(1);\r\n\t\tthis._data.setUint8(this._writeIndex, value);\r\n\t\tthis._writeIndex = this._fileSize;\r\n\t}\r\n\t\r\n\tpublic writeInt8(value: number): void {\r\n\t\tvalue = value | 0;\r\n\t\tthis._addBytes(1);\r\n\t\tthis._data.setInt8(this._writeIndex, value);\r\n\t\tthis._writeIndex = this._fileSize;\r\n\t}\r\n\t\r\n\tpublic writeMidi7Bits(value: number): void {\r\n\t\tvalue = value >>> 0;\r\n\t\tif (value >= 0x80) throw new Error(\"7 bit value contained 8th bit!\");\r\n\t\tthis._addBytes(1);\r\n\t\tthis._data.setUint8(this._writeIndex, value);\r\n\t\tthis._writeIndex = this._fileSize;\r\n\t}\r\n\t\r\n\tpublic writeMidiVariableLength(value: number): void {\r\n\t\tvalue = value >>> 0;\r\n\t\tif (value > 0x0fffffff) throw new Error(\"writeVariableLength value too big.\");\r\n\t\tlet startWriting: boolean = false;\r\n\t\tfor (let i: number = 0; i < 4; i++) {\r\n\t\t\tconst shift: number = 21 - i * 7;\r\n\t\t\tconst bits: number = (value >>> shift) & 0x7f;\r\n\t\t\tif (bits != 0 || i == 3) startWriting = true; // skip leading zero bytes, but always write the last byte even if it's zero. \r\n\t\t\tif (startWriting) this.writeUint8((i == 3 ? 0x00 : 0x80) | bits);\r\n\t\t}\r\n\t}\r\n\t\r\n\tpublic writeMidiAscii(string: string): void {\r\n\t\tthis.writeMidiVariableLength(string.length);\r\n\t\tfor (let i: number = 0; i < string.length; i++) {\r\n\t\t\tconst charCode: number = string.charCodeAt(i);\r\n\t\t\tif (charCode > 0x7f) throw new Error(\"Trying to write unicode character as ascii.\");\r\n\t\t\tthis.writeUint8(charCode); // technically charCodeAt returns 2 byte values, but this string should contain exclusively 1 byte values.\r\n\t\t}\r\n\t}\r\n\t\r\n\tpublic toCompactArrayBuffer(): ArrayBuffer {\r\n\t\treturn transfer(this._arrayBuffer, this._fileSize);\r\n\t}\r\n}\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nimport {InstrumentType, /*EnvelopeType,*/ Config, getArpeggioPitchIndex} from \"../synth/SynthConfig\";\r\nimport {Instrument, Pattern, Note, Song, Synth} from \"../synth/synth\";\r\nimport {ColorConfig} from \"./ColorConfig\";\r\nimport {Preset, EditorConfig} from \"./EditorConfig\";\r\nimport {SongDocument} from \"./SongDocument\";\r\nimport {Prompt} from \"./Prompt\";\r\nimport {HTML} from \"imperative-html/dist/esm/elements-strict\";\r\nimport {ArrayBufferWriter} from \"./ArrayBufferWriter\";\r\nimport {MidiChunkType, MidiFileFormat, MidiControlEventMessage, MidiEventType, MidiMetaEventMessage, MidiRegisteredParameterNumberMSB, MidiRegisteredParameterNumberLSB, volumeMultToMidiVolume, volumeMultToMidiExpression, defaultMidiPitchBend, defaultMidiExpression} from \"./Midi\";\r\n\r\nconst {button, div, h2, input, select, option} = HTML;\r\n\r\nfunction lerp(low: number, high: number, t: number): number {\r\n\treturn low + t * (high - low);\r\n}\r\n\r\nfunction save(blob: Blob, name: string): void {\r\n\tif ((<any>navigator).msSaveOrOpenBlob) {\r\n\t\t(<any>navigator).msSaveOrOpenBlob(blob, name);\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst anchor: HTMLAnchorElement = document.createElement(\"a\");\r\n\tif (anchor.download != undefined) {\r\n\t\tconst url: string = URL.createObjectURL(blob);\r\n\t\tsetTimeout(function() { URL.revokeObjectURL(url); }, 60000);\r\n\t\tanchor.href = url;\r\n\t\tanchor.download = name;\r\n\t\t// Chrome bug regression: We need to delay dispatching the click\r\n\t\t// event. Seems to be related to going back in the browser history.\r\n\t\t// https://bugs.chromium.org/p/chromium/issues/detail?id=825100\r\n\t\tsetTimeout(function() { anchor.dispatchEvent(new MouseEvent(\"click\")); }, 0);\r\n\t} else {\r\n\t\tconst url: string = URL.createObjectURL(blob);\r\n\t\tsetTimeout(function() { URL.revokeObjectURL(url); }, 60000);\r\n\t\tif (!window.open(url, \"_blank\")) window.location.href = url;\r\n\t}\r\n}\r\n\r\nexport class ExportPrompt implements Prompt {\r\n\tprivate readonly _fileName: HTMLInputElement = input({type: \"text\", style: \"width: 10em;\", value: \"BeepBox-Song\", maxlength: 250, \"autofocus\": \"autofocus\"});\r\n\tprivate readonly _enableIntro: HTMLInputElement = input({type: \"checkbox\"});\r\n\tprivate readonly _loopDropDown: HTMLInputElement = input({style:\"width: 2em;\", type: \"number\", min: \"1\", max: \"4\", step: \"1\"});\r\n\tprivate readonly _enableOutro: HTMLInputElement = input({type: \"checkbox\"});\r\n\tprivate readonly _formatSelect: HTMLSelectElement = select({style: \"width: 100%;\"},\r\n\t\toption({value: \"wav\"}, \".wav\"),\r\n\t\toption({value: \"mp3\"}, \".mp3\"),\r\n\t\toption({value: \"midi\"}, \".mid\"),\r\n\t\toption({value: \"json\"}, \".json (for any BeepBox version)\"),\r\n\t\toption({value: \"html\"}, \".html (opens BeepBox)\"),\r\n\t);\r\n\tprivate readonly _cancelButton: HTMLButtonElement = button({class: \"cancelButton\"});\r\n\tprivate readonly _exportButton: HTMLButtonElement = button({class: \"exportButton\", style: \"width:45%;\"}, \"Export\");\r\n\tprivate static readonly midiChipInstruments: number[] = [\r\n\t\t0x4A, // rounded -> recorder\r\n\t\t0x47, // triangle -> clarinet\r\n\t\t0x50, // square -> square wave\r\n\t\t0x46, // / pulse -> bassoon\r\n\t\t0x44, // / pulse -> oboe\r\n\t\t0x51, // sawtooth -> sawtooth wave\r\n\t\t0x51, // double saw -> sawtooth wave\r\n\t\t0x51, // double pulse -> sawtooth wave\r\n\t\t0x51, // spiky -> sawtooth wave\r\n\t];\r\n\t\r\n\tpublic readonly container: HTMLDivElement = div({class: \"prompt noSelection\", style: \"width: 200px;\"},\r\n\t\th2(\"Export Options\"),\r\n\t\tdiv({style: \"display: flex; flex-direction: row; align-items: center; justify-content: space-between;\"},\r\n\t\t\t\"File name:\",\r\n\t\t\tthis._fileName,\r\n\t\t),\r\n\t\tdiv({style: \"display: table; width: 100%;\"},\r\n\t\t\tdiv({style: \"display: table-row;\"},\r\n\t\t\t\tdiv({style: \"display: table-cell;\"}, \"Intro:\"),\r\n\t\t\t\tdiv({style: \"display: table-cell;\"}, \"Loop Count:\"),\r\n\t\t\t\tdiv({style: \"display: table-cell;\"}, \"Outro:\"),\r\n\t\t\t),\r\n\t\t\tdiv({style: \"display: table-row;\"},\r\n\t\t\t\tdiv({style: \"display: table-cell; vertical-align: middle;\"}, this._enableIntro),\r\n\t\t\t\tdiv({style: \"display: table-cell; vertical-align: middle;\"}, this._loopDropDown),\r\n\t\t\t\tdiv({style: \"display: table-cell; vertical-align: middle;\"}, this._enableOutro),\r\n\t\t\t),\r\n\t\t),\r\n\t\tdiv({style: \"text-align: left;\"}, \"File Type:\"),\r\n\t\tdiv({class: \"selectContainer\", style: \"width: 100%;\"}, this._formatSelect),\r\n\t\tdiv({style: \"text-align: left;\"}, \"(Be patient, exporting may take some time...)\"),\r\n\t\tdiv({style: \"display: flex; flex-direction: row-reverse; justify-content: space-between;\"},\r\n\t\t\tthis._exportButton,\r\n\t\t),\r\n\t\tthis._cancelButton,\r\n\t);\r\n\t\r\n\tconstructor(private _doc: SongDocument) {\r\n\t\tthis._loopDropDown.value = \"1\";\r\n\t\t\r\n\t\tif (this._doc.song.loopStart == 0) {\r\n\t\t\tthis._enableIntro.checked = false;\r\n\t\t\tthis._enableIntro.disabled = true;\r\n\t\t} else {\r\n\t\t\tthis._enableIntro.checked = true;\r\n\t\t\tthis._enableIntro.disabled = false;\r\n\t\t}\r\n\t\tif (this._doc.song.loopStart + this._doc.song.loopLength == this._doc.song.barCount) {\r\n\t\t\tthis._enableOutro.checked = false;\r\n\t\t\tthis._enableOutro.disabled = true;\r\n\t\t} else {\r\n\t\t\tthis._enableOutro.checked = true;\r\n\t\t\tthis._enableOutro.disabled = false;\r\n\t\t}\r\n\t\t\r\n\t\tconst lastExportFormat: string | null = window.localStorage.getItem(\"exportFormat\");\r\n\t\tif (lastExportFormat != null) {\r\n\t\t\tthis._formatSelect.value = lastExportFormat;\r\n\t\t}\r\n\t\t\r\n\t\tthis._fileName.select();\r\n\t\tsetTimeout(()=>this._fileName.focus());\r\n\t\t\r\n\t\tthis._fileName.addEventListener(\"input\", ExportPrompt._validateFileName);\r\n\t\tthis._loopDropDown.addEventListener(\"blur\", ExportPrompt._validateNumber);\r\n\t\tthis._exportButton.addEventListener(\"click\", this._export);\r\n\t\tthis._cancelButton.addEventListener(\"click\", this._close);\r\n\t\tthis.container.addEventListener(\"keydown\", this._whenKeyPressed);\r\n\t}\r\n\t\r\n\tprivate _close = (): void => { \r\n\t\tthis._doc.undo();\r\n\t}\r\n\t\r\n\tpublic cleanUp = (): void => { \r\n\t\tthis._fileName.removeEventListener(\"input\", ExportPrompt._validateFileName);\r\n\t\tthis._loopDropDown.removeEventListener(\"blur\", ExportPrompt._validateNumber);\r\n\t\tthis._exportButton.removeEventListener(\"click\", this._export);\r\n\t\tthis._cancelButton.removeEventListener(\"click\", this._close);\r\n\t\tthis.container.removeEventListener(\"keydown\", this._whenKeyPressed);\r\n\t}\r\n\t\r\n\tprivate _whenKeyPressed = (event: KeyboardEvent): void => {\r\n\t\tif ((<Element> event.target).tagName != \"BUTTON\" && event.keyCode == 13) { // Enter key\r\n\t\t\tthis._export();\r\n\t\t}\r\n\t}\r\n\t\r\n\tprivate static _validateFileName(event: Event): void {\r\n\t\tconst input: HTMLInputElement = <HTMLInputElement>event.target;\r\n\t\tconst deleteChars = /[\\+\\*\\$\\?\\|\\{\\}\\\\\\/<>#%!`&'\"=:@]/gi;\r\n\t\tif (deleteChars.test(input.value)) {\r\n\t\t\tlet cursorPos: number = <number>input.selectionStart;\r\n\t\t\tinput.value = input.value.replace(deleteChars, \"\");\r\n\t\t\tcursorPos--;\r\n\t\t\tinput.setSelectionRange(cursorPos, cursorPos);\r\n\t\t}\r\n\t}\r\n\t\r\n\tprivate static _validateNumber(event: Event): void {\r\n\t\tconst input: HTMLInputElement = <HTMLInputElement>event.target;\r\n\t\tinput.value = Math.floor(Math.max(Number(input.min), Math.min(Number(input.max), Number(input.value)))) + \"\";\r\n\t}\r\n\t\r\n\tprivate _export = (): void => {\r\n\t\twindow.localStorage.setItem(\"exportFormat\", this._formatSelect.value);\r\n\t\tswitch(this._formatSelect.value) {\r\n\t\t\tcase \"wav\":\r\n\t\t\t\tthis._exportToWav();\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"mp3\":\r\n\t\t\t\tthis._exportToMp3();\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"midi\":\r\n\t\t\t\tthis._exportToMidi();\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"json\":\r\n\t\t\t\tthis._exportToJson();\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"html\":\r\n\t\t\t\tthis._exportToHtml();\r\n\t\t\t\tbreak;\r\n\t\t\tdefault:\r\n\t\t\t\tthrow new Error(\"Unhandled file export type.\");\r\n\t\t}\r\n\t}\r\n\t\r\n\tprivate _synthesize(sampleRate: number): {recordedSamplesL: Float32Array, recordedSamplesR: Float32Array} {\r\n\t\tconst synth: Synth = new Synth(this._doc.song);\r\n\t\tsynth.samplesPerSecond = sampleRate;\r\n\t\tsynth.loopRepeatCount = Number(this._loopDropDown.value) - 1;\r\n\t\tif (!this._enableIntro.checked) {\r\n\t\t\tfor (let introIter: number = 0; introIter < this._doc.song.loopStart; introIter++) {\r\n\t\t\t\tsynth.goToNextBar();\r\n\t\t\t}\r\n\t\t}\r\n\t\tconst sampleFrames: number = Math.ceil(synth.getSamplesPerBar() * synth.getTotalBars(this._enableIntro.checked, this._enableOutro.checked));\r\n\t\tconst recordedSamplesL: Float32Array = new Float32Array(sampleFrames);\r\n\t\tconst recordedSamplesR: Float32Array = new Float32Array(sampleFrames);\r\n\t\t//const timer: number = performance.now();\r\n\t\tsynth.synthesize(recordedSamplesL, recordedSamplesR, sampleFrames);\r\n\t\t//console.log(\"export timer\", (performance.now() - timer) / 1000.0);\r\n\t\t\r\n\t\treturn {recordedSamplesL, recordedSamplesR};\r\n\t}\r\n\t\r\n\tprivate _exportToWav(): void {\r\n\t\tconst sampleRate: number = 48000; // Use professional video editing standard sample rate for .wav file export.\r\n\t\tconst {recordedSamplesL, recordedSamplesR} = this._synthesize(sampleRate);\r\n\t\tconst sampleFrames: number = recordedSamplesL.length;\r\n\t\t\r\n\t\tconst wavChannelCount: number = 2;\r\n\t\tconst bytesPerSample: number = 2;\r\n\t\tconst bitsPerSample: number = 8 * bytesPerSample;\r\n\t\tconst sampleCount: number = wavChannelCount * sampleFrames;\r\n\t\t\r\n\t\tconst totalFileSize: number = 44 + sampleCount * bytesPerSample;\r\n\t\t\r\n\t\tlet index: number = 0;\r\n\t\tconst arrayBuffer: ArrayBuffer = new ArrayBuffer(totalFileSize);\r\n\t\tconst data: DataView = new DataView(arrayBuffer);\r\n\t\tdata.setUint32(index, 0x52494646, false); index += 4;\r\n\t\tdata.setUint32(index, 36 + sampleCount * bytesPerSample, true); index += 4; // size of remaining file\r\n\t\tdata.setUint32(index, 0x57415645, false); index += 4;\r\n\t\tdata.setUint32(index, 0x666D7420, false); index += 4;\r\n\t\tdata.setUint32(index, 0x00000010, true); index += 4; // size of following header\r\n\t\tdata.setUint16(index, 0x0001, true); index += 2; // not compressed\r\n\t\tdata.setUint16(index, wavChannelCount, true); index += 2; // channel count\r\n\t\tdata.setUint32(index, sampleRate, true); index += 4; // sample rate\r\n\t\tdata.setUint32(index, sampleRate * bytesPerSample * wavChannelCount, true); index += 4; // bytes per second\r\n\t\tdata.setUint16(index, bytesPerSample * wavChannelCount, true); index += 2; // block align\r\n\t\tdata.setUint16(index, bitsPerSample, true); index += 2; // bits per sample\r\n\t\tdata.setUint32(index, 0x64617461, false); index += 4;\r\n\t\tdata.setUint32(index, sampleCount * bytesPerSample, true); index += 4;\r\n\t\t\r\n\t\tif (bytesPerSample > 1) {\r\n\t\t\t// usually samples are signed. \r\n\t\t\tconst range: number = (1 << (bitsPerSample - 1)) - 1;\r\n\t\t\tfor (let i: number = 0; i < sampleFrames; i++) {\r\n\t\t\t\tlet valL: number = Math.floor(Math.max(-1, Math.min(1, recordedSamplesL[i])) * range);\r\n\t\t\t\tlet valR: number = Math.floor(Math.max(-1, Math.min(1, recordedSamplesR[i])) * range);\r\n\t\t\t\tif (bytesPerSample == 2) {\r\n\t\t\t\t\tdata.setInt16(index, valL, true); index += 2;\r\n\t\t\t\t\tdata.setInt16(index, valR, true); index += 2;\r\n\t\t\t\t} else if (bytesPerSample == 4) {\r\n\t\t\t\t\tdata.setInt32(index, valL, true); index += 4;\r\n\t\t\t\t\tdata.setInt32(index, valR, true); index += 4;\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthrow new Error(\"unsupported sample size\");\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\t// 8 bit samples are a special case: they are unsigned.\r\n\t\t\tfor (let i: number = 0; i < sampleFrames; i++) {\r\n\t\t\t\tlet valL: number = Math.floor(Math.max(-1, Math.min(1, recordedSamplesL[i])) * 127 + 128);\r\n\t\t\t\tlet valR: number = Math.floor(Math.max(-1, Math.min(1, recordedSamplesR[i])) * 127 + 128);\r\n\t\t\t\tdata.setUint8(index, valL > 255 ? 255 : (valL < 0 ? 0 : valL)); index++;\r\n\t\t\t\tdata.setUint8(index, valR > 255 ? 255 : (valR < 0 ? 0 : valR)); index++;\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tconst blob: Blob = new Blob([arrayBuffer], {type: \"audio/wav\"});\r\n\t\tsave(blob, this._fileName.value.trim() + \".wav\");\r\n\t\tthis._close();\r\n\t}\r\n\t\r\n\tprivate _exportToMp3(): void {\r\n\t\tconst whenEncoderIsAvailable = (): void => {\r\n\t\t\tconst sampleRate: number = 44100; // Use consumer CD standard sample rate for .mp3 export.\r\n\t\t\tconst {recordedSamplesL, recordedSamplesR} = this._synthesize(sampleRate);\r\n\t\t\t\r\n\t\t\tconst lamejs: any = (<any> window)[\"lamejs\"];\r\n\t\t\tconst channelCount: number = 2;\r\n\t\t\tconst kbps: number = 192;\r\n\t\t\tconst sampleBlockSize: number = 1152;\r\n\t\t\tconst mp3encoder: any = new lamejs.Mp3Encoder(channelCount, sampleRate, kbps);\r\n\t\t\tconst mp3Data: any[] = [];\r\n\t\t\t\r\n\t\t\tconst left: Int16Array = new Int16Array(recordedSamplesL.length);\r\n\t\t\tconst right: Int16Array = new Int16Array(recordedSamplesR.length);\r\n\t\t\tconst range: number = (1 << 15) - 1;\r\n\t\t\tfor (let i: number = 0; i < recordedSamplesL.length; i++) {\r\n\t\t\t\tleft[i]  = Math.floor(Math.max(-1, Math.min(1, recordedSamplesL[i])) * range);\r\n\t\t\t\tright[i] = Math.floor(Math.max(-1, Math.min(1, recordedSamplesR[i])) * range);\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tfor (let i: number = 0; i < left.length; i += sampleBlockSize) {\r\n\t\t\t\tconst leftChunk: Int16Array = left.subarray(i, i + sampleBlockSize);\r\n\t\t\t\tconst rightChunk: Int16Array = right.subarray(i, i + sampleBlockSize);\r\n\t\t\t\tconst mp3buf: any = mp3encoder.encodeBuffer(leftChunk, rightChunk);\r\n\t\t\t\tif (mp3buf.length > 0) mp3Data.push(mp3buf);\r\n\t\t\t}\r\n\t\t\tconst mp3buf: any = mp3encoder.flush();\r\n\t\t\tif (mp3buf.length > 0) mp3Data.push(mp3buf);\r\n\t\t\t\r\n\t\t\tconst blob: Blob = new Blob(mp3Data, {type: \"audio/mp3\"});\r\n\t\t\tsave(blob, this._fileName.value.trim() + \".mp3\");\r\n\t\t\tthis._close();\r\n\t\t}\r\n\t\t\r\n\t\tif (\"lamejs\" in window) {\r\n\t\t\twhenEncoderIsAvailable();\r\n\t\t} else {\r\n\t\t\tvar script = document.createElement(\"script\");\r\n\t\t\tscript.src = \"https://cdn.jsdelivr.net/npm/lamejs@1.2.0/lame.min.js\";\r\n\t\t\tscript.onload = whenEncoderIsAvailable;\r\n\t\t\tdocument.head.appendChild(script);\r\n\t\t}\r\n\t}\r\n\t\r\n\tprivate _exportToMidi(): void {\r\n\t\tconst song: Song = this._doc.song;\r\n\t\tconst midiTicksPerBeepBoxTick: number = 2;\r\n\t\tconst midiTicksPerBeat: number = midiTicksPerBeepBoxTick * Config.ticksPerPart * Config.partsPerBeat;\r\n\t\tconst midiTicksPerPart: number = midiTicksPerBeepBoxTick * Config.ticksPerPart;\r\n\t\tconst secondsPerMinute: number = 60;\r\n\t\tconst microsecondsPerMinute: number = secondsPerMinute * 1000000;\r\n\t\tconst beatsPerMinute: number = song.getBeatsPerMinute();\r\n\t\tconst microsecondsPerBeat: number = Math.round(microsecondsPerMinute / beatsPerMinute);\r\n\t\t//const secondsPerMidiTick: number = secondsPerMinute / (midiTicksPerBeat * beatsPerMinute);\r\n\t\tconst midiTicksPerBar: number = midiTicksPerBeat * song.beatsPerBar;\r\n\t\tconst pitchBendRange: number = 24;\r\n\t\tconst defaultNoteVelocity: number = 90;\r\n\t\t\r\n\t\tconst unrolledBars: number[] = [];\r\n\t\tif (this._enableIntro.checked) {\r\n\t\t\tfor (let bar: number = 0; bar < song.loopStart; bar++) {\r\n\t\t\t\tunrolledBars.push(bar);\r\n\t\t\t}\r\n\t\t}\r\n\t\tfor (let loopIndex: number = 0; loopIndex < Number(this._loopDropDown.value); loopIndex++) {\r\n\t\t\tfor (let bar: number = song.loopStart; bar < song.loopStart + song.loopLength; bar++) {\r\n\t\t\t\tunrolledBars.push(bar);\r\n\t\t\t}\r\n\t\t}\r\n\t\tif (this._enableOutro.checked) {\r\n\t\t\tfor (let bar: number = song.loopStart + song.loopLength; bar < song.barCount; bar++) {\r\n\t\t\t\tunrolledBars.push(bar);\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tconst tracks = [{isMeta:  true, channel: -1, midiChannel: -1, isNoise: false, isDrumset: false}];\r\n\t\tlet midiChannelCounter: number = 0;\r\n\t\tlet foundADrumset: boolean = false;\r\n\t\tfor (let channel: number = 0; channel < this._doc.song.getChannelCount(); channel++) {\r\n\t\t\tif (!foundADrumset && this._doc.song.channels[channel].instruments[0].type == InstrumentType.drumset) {\r\n\t\t\t\ttracks.push({isMeta: false, channel: channel, midiChannel: 9, isNoise: true, isDrumset: true});\r\n\t\t\t\tfoundADrumset = true; // There can only be one drumset channel, and it's always channel 9 (seen as 10 in most UIs). :/\r\n\t\t\t} else {\r\n\t\t\t\tif (midiChannelCounter >= 16) continue; // The MIDI standard only supports 16 channels.\r\n\t\t\t\ttracks.push({isMeta: false, channel: channel, midiChannel: midiChannelCounter++, isNoise: this._doc.song.getChannelIsNoise(channel), isDrumset: false});\r\n\t\t\t\tif (midiChannelCounter == 9) midiChannelCounter++; // skip midi drum channel.\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tconst writer: ArrayBufferWriter = new ArrayBufferWriter(1024);\r\n\t\twriter.writeUint32(MidiChunkType.header);\r\n\t\twriter.writeUint32(6); // length of headers is 6 bytes\r\n\t\twriter.writeUint16(MidiFileFormat.simultaneousTracks);\r\n\t\twriter.writeUint16(tracks.length);\r\n\t\twriter.writeUint16(midiTicksPerBeat); // number of \"ticks\" per beat, independent of tempo\r\n\t\t\r\n\t\tfor (const track of tracks) {\r\n\t\t\twriter.writeUint32(MidiChunkType.track);\r\n\t\t\t\r\n\t\t\tconst {isMeta, channel, midiChannel, isNoise, isDrumset} = track;\r\n\t\t\t\r\n\t\t\t// We're gonna come back here and overwrite this placeholder once we know how many bytes this track is.\r\n\t\t\tconst trackStartIndex: number = writer.getWriteIndex();\r\n\t\t\twriter.writeUint32(0); // placeholder for track size\r\n\t\t\t\r\n\t\t\tlet prevTime: number = 0;\r\n\t\t\tlet barStartTime: number = 0;\r\n\t\t\tconst writeEventTime = function(time: number): void {\r\n\t\t\t\tif (time < prevTime) throw new Error(\"Midi event time cannot go backwards.\");\r\n\t\t\t\twriter.writeMidiVariableLength(time - prevTime);\r\n\t\t\t\tprevTime = time;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tconst writeControlEvent = function(message: MidiControlEventMessage, value: number): void {\r\n\t\t\t\tif (!(value >= 0 && value <= 0x7F)) throw new Error(\"Midi control event value out of range: \" + value);\r\n\t\t\t\twriter.writeUint8(MidiEventType.controlChange | midiChannel);\r\n\t\t\t\twriter.writeMidi7Bits(message);\r\n\t\t\t\twriter.writeMidi7Bits(value | 0);\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tif (isMeta) {\r\n\t\t\t\t// for first midi track, include tempo, time signature, and key signature information.\r\n\t\t\t\t\r\n\t\t\t\twriteEventTime(0);\r\n\t\t\t\twriter.writeUint8(MidiEventType.meta);\r\n\t\t\t\twriter.writeMidi7Bits(MidiMetaEventMessage.text);\r\n\t\t\t\twriter.writeMidiAscii(\"Composed with https://www.beepbox.co\");\r\n\t\t\t\t\r\n\t\t\t\twriteEventTime(0);\r\n\t\t\t\twriter.writeUint8(MidiEventType.meta);\r\n\t\t\t\twriter.writeMidi7Bits(MidiMetaEventMessage.tempo);\r\n\t\t\t\twriter.writeMidiVariableLength(3); // Tempo message length is 3 bytes.\r\n\t\t\t\twriter.writeUint24(microsecondsPerBeat); // Tempo in microseconds per \"quarter\" note, commonly known as a \"beat\"\r\n\t\t\t\t\r\n\t\t\t\twriteEventTime(0);\r\n\t\t\t\twriter.writeUint8(MidiEventType.meta);\r\n\t\t\t\twriter.writeMidi7Bits(MidiMetaEventMessage.timeSignature);\r\n\t\t\t\twriter.writeMidiVariableLength(4); // Time signature message length is 4 bytes.\r\n\t\t\t\twriter.writeUint8(song.beatsPerBar); // numerator.\r\n\t\t\t\twriter.writeUint8(2); // denominator exponent in 2^E. 2^2 = 4, and we will always use \"quarter\" notes.\r\n\t\t\t\twriter.writeUint8(24); // MIDI Clocks per metronome tick (should match beats), standard is 24\r\n\t\t\t\twriter.writeUint8(8); // number of 1/32 notes per 24 MIDI Clocks, standard is 8, meaning 24 clocks per \"quarter\" note.\r\n\t\t\t\t\r\n\t\t\t\tconst isMinor: boolean = Config.scales[song.scale].flags[3] && !Config.scales[song.scale].flags[4];\r\n\t\t\t\tconst key: number = song.key; // C=0, C#=1, counting up to B=11\r\n\t\t\t\tlet numSharps: number = key; // For even key values in major scale, number of sharps/flats is same...\r\n\t\t\t\tif ((key & 1) == 1) numSharps += 6; // For odd key values (consider circle of fifths) rotate around the circle... kinda... Look conventional key signatures are just weird, okay?\r\n\t\t\t\tif (isMinor) numSharps += 9; // A minor A scale has zero sharps, shift it appropriately\r\n\t\t\t\twhile (numSharps > 6) numSharps -= 12; // Range is (modulo 12) - 5. Midi supports -7 to +7, but I only have 12 options.\r\n\t\t\t\t\r\n\t\t\t\twriteEventTime(0);\r\n\t\t\t\twriter.writeUint8(MidiEventType.meta);\r\n\t\t\t\twriter.writeMidi7Bits(MidiMetaEventMessage.keySignature);\r\n\t\t\t\twriter.writeMidiVariableLength(2); // Key signature message length is 2 bytes.\r\n\t\t\t\twriter.writeInt8(numSharps); // See above calculation. Assumes scale is diatonic. :/\r\n\t\t\t\twriter.writeUint8(isMinor ? 1 : 0); // 0: major, 1: minor\r\n\t\t\t\t\r\n\t\t\t\tif (this._enableIntro.checked) barStartTime += midiTicksPerBar * song.loopStart;\r\n\t\t\t\twriteEventTime(barStartTime);\r\n\t\t\t\twriter.writeUint8(MidiEventType.meta);\r\n\t\t\t\twriter.writeMidi7Bits(MidiMetaEventMessage.marker);\r\n\t\t\t\twriter.writeMidiAscii(\"Loop Start\");\r\n\t\t\t\t\r\n\t\t\t\tfor (let loopIndex: number = 0; loopIndex < parseInt(this._loopDropDown.value); loopIndex++) {\r\n\t\t\t\t\tbarStartTime += midiTicksPerBar * song.loopLength;\r\n\t\t\t\t\twriteEventTime(barStartTime);\r\n\t\t\t\t\twriter.writeUint8(MidiEventType.meta);\r\n\t\t\t\t\twriter.writeMidi7Bits(MidiMetaEventMessage.marker);\r\n\t\t\t\t\twriter.writeMidiAscii(loopIndex < Number(this._loopDropDown.value) - 1 ? \"Loop Repeat\" : \"Loop End\");\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tif (this._enableOutro.checked) barStartTime += midiTicksPerBar * (song.barCount - song.loopStart - song.loopLength);\r\n\t\t\t\tif (barStartTime != midiTicksPerBar * unrolledBars.length) throw new Error(\"Miscalculated number of bars.\");\r\n\t\t\t\t\r\n\t\t\t} else {\r\n\t\t\t\t// For remaining tracks, set up the instruments and write the notes:\r\n\t\t\t\t\r\n\t\t\t\tlet channelName: string = ColorConfig.getChannelColor(song, channel).name + \" channel\";\r\n\t\t\t\twriteEventTime(0);\r\n\t\t\t\twriter.writeUint8(MidiEventType.meta);\r\n\t\t\t\twriter.writeMidi7Bits(MidiMetaEventMessage.trackName);\r\n\t\t\t\twriter.writeMidiAscii(channelName);\r\n\t\t\t\t\r\n\t\t\t\t// This sets up pitch bend range. First we choose the pitch bend RPN (which has MSB and LSB components), then we set the value for that RPN (which also has MSB and LSB components) and finally reset the current RPN to null, which is considered best practice.\r\n\t\t\t\twriteEventTime(0); writeControlEvent(MidiControlEventMessage.registeredParameterNumberMSB, MidiRegisteredParameterNumberMSB.pitchBendRange);\r\n\t\t\t\twriteEventTime(0); writeControlEvent(MidiControlEventMessage.registeredParameterNumberLSB, MidiRegisteredParameterNumberLSB.pitchBendRange);\r\n\t\t\t\twriteEventTime(0); writeControlEvent(MidiControlEventMessage.setParameterMSB, pitchBendRange); // pitch bend semitone range\r\n\t\t\t\twriteEventTime(0); writeControlEvent(MidiControlEventMessage.setParameterLSB, 0); // pitch bend cent range\r\n\t\t\t\twriteEventTime(0); writeControlEvent(MidiControlEventMessage.registeredParameterNumberMSB, MidiRegisteredParameterNumberMSB.reset);\r\n\t\t\t\twriteEventTime(0); writeControlEvent(MidiControlEventMessage.registeredParameterNumberLSB, MidiRegisteredParameterNumberLSB.reset);\r\n\t\t\t\t\r\n\t\t\t\tlet prevInstrumentIndex: number = -1;\r\n\t\t\t\tfunction writeInstrumentSettings(instrumentIndex: number): void {\r\n\t\t\t\t\tconst instrument: Instrument = song.channels[channel].instruments[instrumentIndex];\r\n\t\t\t\t\tconst preset: Preset | null = EditorConfig.valueToPreset(instrument.preset);\r\n\t\t\t\t\t\r\n\t\t\t\t\tif (prevInstrumentIndex != instrumentIndex) {\r\n\t\t\t\t\t\tprevInstrumentIndex = instrumentIndex;\r\n\t\t\t\t\t\twriteEventTime(barStartTime);\r\n\t\t\t\t\t\twriter.writeUint8(MidiEventType.meta);\r\n\t\t\t\t\t\twriter.writeMidi7Bits(MidiMetaEventMessage.instrumentName);\r\n\t\t\t\t\t\twriter.writeMidiAscii(\"Instrument \" + (instrumentIndex + 1));\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tif (!isDrumset) {\r\n\t\t\t\t\t\t\tlet instrumentProgram: number = 81; // default to sawtooth wave. \r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tif (preset != null && preset.midiProgram != undefined) {\r\n\t\t\t\t\t\t\t\tinstrumentProgram = preset.midiProgram;\r\n\t\t\t\t\t\t\t} else if (instrument.type == InstrumentType.drumset) {\r\n\t\t\t\t\t\t\t\t// The first BeepBox drumset channel is handled as a Midi drumset channel and doesn't need a program, but any subsequent drumsets will just be set to taiko.\r\n\t\t\t\t\t\t\t\tinstrumentProgram = 116; // taiko\r\n\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\tif (instrument.type == InstrumentType.noise || instrument.type == InstrumentType.spectrum) {\r\n\t\t\t\t\t\t\t\t\tif (isNoise) {\r\n\t\t\t\t\t\t\t\t\t\tinstrumentProgram = 116; // taiko\r\n\t\t\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\t\t\tinstrumentProgram = 75; // pan flute\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t} else if (instrument.type == InstrumentType.chip) {\r\n\t\t\t\t\t\t\t\t\tif (ExportPrompt.midiChipInstruments.length > instrument.chipWave) {\r\n\t\t\t\t\t\t\t\t\t\tinstrumentProgram = ExportPrompt.midiChipInstruments[instrument.chipWave];\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t} else if (instrument.type == InstrumentType.pwm || instrument.type == InstrumentType.fm || instrument.type == InstrumentType.harmonics || instrument.type == InstrumentType.supersaw) {\r\n\t\t\t\t\t\t\t\t\tinstrumentProgram = 81; // sawtooth\r\n\t\t\t\t\t\t\t\t} else if (instrument.type == InstrumentType.pickedString) {\r\n\t\t\t\t\t\t\t\t\tinstrumentProgram = 0x19; // steel guitar\r\n\t\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\t\tthrow new Error(\"Unrecognized instrument type.\");\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t// Program (instrument) change event:\r\n\t\t\t\t\t\t\twriteEventTime(barStartTime);\r\n\t\t\t\t\t\t\twriter.writeUint8(MidiEventType.programChange | midiChannel);\r\n\t\t\t\t\t\t\twriter.writeMidi7Bits(instrumentProgram);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t// Instrument volume:\r\n\t\t\t\t\t\twriteEventTime(barStartTime);\r\n\t\t\t\t\t\tlet instrumentVolume: number = volumeMultToMidiVolume(Synth.instrumentVolumeToVolumeMult(instrument.volume));\r\n\t\t\t\t\t\twriteControlEvent(MidiControlEventMessage.volumeMSB, Math.min(0x7f, Math.round(instrumentVolume)));\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t// Instrument pan:\r\n\t\t\t\t\t\twriteEventTime(barStartTime);\r\n\t\t\t\t\t\tlet instrumentPan: number = (instrument.pan / Config.panCenter - 1) * 0x3f + 0x40;\r\n\t\t\t\t\t\twriteControlEvent(MidiControlEventMessage.panMSB, Math.min(0x7f, Math.round(instrumentPan)));\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tif (song.getPattern(channel, 0) == null) {\r\n\t\t\t\t\t// Go ahead and apply the instrument settings at the beginning of the channel\r\n\t\t\t\t\t// even if a bar doesn't kick in until later.\r\n\t\t\t\t\twriteInstrumentSettings(0);\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tlet prevPitchBend: number = defaultMidiPitchBend;\r\n\t\t\t\tlet prevExpression: number = defaultMidiExpression;\r\n\t\t\t\tlet shouldResetExpressionAndPitchBend: boolean = false;\r\n\t\t\t\t//let prevTremolo: number = -1;\r\n\t\t\t\tconst channelRoot: number = isNoise ? Config.spectrumBasePitch : Config.keys[song.key].basePitch;\r\n\t\t\t\tconst intervalScale: number = isNoise ? Config.noiseInterval : 1;\r\n\t\t\t\t\r\n\t\t\t\tfor (const bar of unrolledBars) {\r\n\t\t\t\t\tconst pattern: Pattern | null = song.getPattern(channel, bar);\r\n\t\t\t\t\t\r\n\t\t\t\t\tif (pattern != null) {\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tconst instrumentIndex: number = pattern.instruments[0]; // Don't bother trying to export multiple instruments per pattern to midi, just pick the first one.\r\n\t\t\t\t\t\tconst instrument: Instrument = song.channels[channel].instruments[instrumentIndex];\r\n\t\t\t\t\t\tconst preset: Preset | null = EditorConfig.valueToPreset(instrument.preset);\r\n\t\t\t\t\t\twriteInstrumentSettings(instrumentIndex);\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tlet usesArpeggio: boolean = instrument.getChord().arpeggiates;\r\n\t\t\t\t\t\tlet polyphony: number = usesArpeggio ? 1 : Config.maxChordSize;\r\n\t\t\t\t\t\tif (instrument.getChord().customInterval) {\r\n\t\t\t\t\t\t\tif (instrument.type == InstrumentType.chip || instrument.type == InstrumentType.harmonics) {\r\n\t\t\t\t\t\t\t\tpolyphony = 2;\r\n\t\t\t\t\t\t\t\tusesArpeggio = true;\r\n\t\t\t\t\t\t\t} else if (instrument.type == InstrumentType.fm) {\r\n\t\t\t\t\t\t\t\tpolyphony = Config.operatorCount;\r\n\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\tconsole.error(\"Unrecognized instrument type for harmonizing arpeggio: \" + instrument.type);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tfor (let noteIndex: number = 0; noteIndex < pattern.notes.length; noteIndex++) {\r\n\t\t\t\t\t\t\tconst note: Note = pattern.notes[noteIndex];\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tconst noteStartTime: number = barStartTime + note.start * midiTicksPerPart;\r\n\t\t\t\t\t\t\tlet pinTime: number = noteStartTime;\r\n\t\t\t\t\t\t\tlet pinSize: number = note.pins[0].size;\r\n\t\t\t\t\t\t\tlet pinInterval: number = note.pins[0].interval;\r\n\t\t\t\t\t\t\tconst prevPitches: number[] = [-1, -1, -1, -1];\r\n\t\t\t\t\t\t\tconst nextPitches: number[] = [-1, -1, -1, -1];\r\n\t\t\t\t\t\t\tconst toneCount: number = Math.min(polyphony, note.pitches.length);\r\n\t\t\t\t\t\t\tconst velocity: number = isDrumset ? Math.max(1, Math.round(defaultNoteVelocity * note.pins[0].size / Config.noteSizeMax)) : defaultNoteVelocity;\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t// The maximum midi pitch bend range is +/- 24 semitones from the base pitch. \r\n\t\t\t\t\t\t\t// To make the most of this, choose a base pitch that is within 24 semitones from as much of the note as possible.\r\n\t\t\t\t\t\t\t// This may involve offsetting this base pitch from BeepBox's note pitch.\r\n\t\t\t\t\t\t\tlet mainInterval: number = note.pickMainInterval();\r\n\t\t\t\t\t\t\tlet pitchOffset: number = mainInterval * intervalScale;\r\n\t\t\t\t\t\t\tif (!isDrumset) {\r\n\t\t\t\t\t\t\t\tlet maxPitchOffset: number = pitchBendRange;\r\n\t\t\t\t\t\t\t\tlet minPitchOffset: number = -pitchBendRange;\r\n\t\t\t\t\t\t\t\tfor (let pinIndex: number = 1; pinIndex < note.pins.length; pinIndex++) {\r\n\t\t\t\t\t\t\t\t\tconst interval = note.pins[pinIndex].interval * intervalScale;\r\n\t\t\t\t\t\t\t\t\tmaxPitchOffset = Math.min(maxPitchOffset, interval + pitchBendRange);\r\n\t\t\t\t\t\t\t\t\tminPitchOffset = Math.max(minPitchOffset, interval - pitchBendRange);\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t/*\r\n\t\t\t\t\t\t\t\t// I'd like to be able to use pitch bend to implement arpeggio, but the \"custom inverval\" setting in chip instruments combines arpeggio in one tone with another flat tone, and midi can't selectively apply arpeggio to one out of two simultaneous tones. Also it would be hard to reimport. :/\r\n\t\t\t\t\t\t\t\tif (usesArpeggio && note.pitches.length > polyphony) {\r\n\t\t\t\t\t\t\t\t\tlet lowestArpeggioOffset: number = 0;\r\n\t\t\t\t\t\t\t\t\tlet highestArpeggioOffset: number = 0;\r\n\t\t\t\t\t\t\t\t\tconst basePitch: number = note.pitches[toneCount - 1];\r\n\t\t\t\t\t\t\t\t\tfor (let pitchIndex: number = toneCount; pitchIndex < note.pitches.length; pitchIndex++) {\r\n\t\t\t\t\t\t\t\t\t\tlowestArpeggioOffset = Math.min(note.pitches[pitchIndex] - basePitch);\r\n\t\t\t\t\t\t\t\t\t\thighestArpeggioOffset = Math.max(note.pitches[pitchIndex] - basePitch);\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\tmaxPitchOffset -= lowestArpeggioOffset;\r\n\t\t\t\t\t\t\t\t\tminPitchOffset += lowestArpeggioOffset;\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t*/\r\n\t\t\t\t\t\t\t\tpitchOffset = Math.min(maxPitchOffset, Math.max(minPitchOffset, pitchOffset));\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tfor (let pinIndex: number = 1; pinIndex < note.pins.length; pinIndex++) {\r\n\t\t\t\t\t\t\t\tconst nextPinTime: number = noteStartTime + note.pins[pinIndex].time * midiTicksPerPart;\r\n\t\t\t\t\t\t\t\tconst nextPinSize: number = note.pins[pinIndex].size;\r\n\t\t\t\t\t\t\t\tconst nextPinInterval: number = note.pins[pinIndex].interval;\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tconst length: number = nextPinTime - pinTime;\r\n\t\t\t\t\t\t\t\tfor (let midiTick: number = 0; midiTick < length; midiTick++) {\r\n\t\t\t\t\t\t\t\t\tconst midiTickTime: number = pinTime + midiTick;\r\n\t\t\t\t\t\t\t\t\tconst linearSize: number = lerp(pinSize, nextPinSize, midiTick / length);\r\n\t\t\t\t\t\t\t\t\tconst linearInterval: number = lerp(pinInterval, nextPinInterval, midiTick / length);\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tconst interval: number = linearInterval * intervalScale - pitchOffset;\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tconst pitchBend: number = Math.max(0, Math.min(0x3fff, Math.round(0x2000 * (1.0 + interval / pitchBendRange))));\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tconst expression: number = Math.min(0x7f, Math.round(volumeMultToMidiExpression(Synth.noteSizeToVolumeMult(linearSize))));\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tif (pitchBend != prevPitchBend) {\r\n\t\t\t\t\t\t\t\t\t\twriteEventTime(midiTickTime);\r\n\t\t\t\t\t\t\t\t\t\twriter.writeUint8(MidiEventType.pitchBend | midiChannel);\r\n\t\t\t\t\t\t\t\t\t\twriter.writeMidi7Bits(pitchBend & 0x7f); // least significant bits\r\n\t\t\t\t\t\t\t\t\t\twriter.writeMidi7Bits((pitchBend >> 7) & 0x7f); // most significant bits\r\n\t\t\t\t\t\t\t\t\t\tprevPitchBend = pitchBend;\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tif (expression != prevExpression && !isDrumset) {\r\n\t\t\t\t\t\t\t\t\t\twriteEventTime(midiTickTime);\r\n\t\t\t\t\t\t\t\t\t\twriteControlEvent(MidiControlEventMessage.expressionMSB, expression);\r\n\t\t\t\t\t\t\t\t\t\tprevExpression = expression;\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tconst noteStarting: boolean = midiTickTime == noteStartTime;\r\n\t\t\t\t\t\t\t\t\tfor (let toneIndex: number = 0; toneIndex < toneCount; toneIndex++) {\r\n\t\t\t\t\t\t\t\t\t\tlet nextPitch: number = note.pitches[toneIndex];\r\n\t\t\t\t\t\t\t\t\t\tif (isDrumset) {\r\n\t\t\t\t\t\t\t\t\t\t\tnextPitch += mainInterval;\r\n\t\t\t\t\t\t\t\t\t\t\tconst drumsetMap: number[] = [\r\n\t\t\t\t\t\t\t\t\t\t\t\t36, // Bass Drum 1\r\n\t\t\t\t\t\t\t\t\t\t\t\t41, // Low Floor Tom\r\n\t\t\t\t\t\t\t\t\t\t\t\t45, // Low Tom\r\n\t\t\t\t\t\t\t\t\t\t\t\t48, // Hi-Mid Tom\r\n\t\t\t\t\t\t\t\t\t\t\t\t40, // Electric Snare\r\n\t\t\t\t\t\t\t\t\t\t\t\t39, // Hand Clap\r\n\t\t\t\t\t\t\t\t\t\t\t\t59, // Ride Cymbal 2\r\n\t\t\t\t\t\t\t\t\t\t\t\t49, // Crash Cymbal 1\r\n\t\t\t\t\t\t\t\t\t\t\t\t46, // Open Hi-Hat\r\n\t\t\t\t\t\t\t\t\t\t\t\t55, // Splash Cymbal\r\n\t\t\t\t\t\t\t\t\t\t\t\t69, // Cabasa\r\n\t\t\t\t\t\t\t\t\t\t\t\t54, // Tambourine\r\n\t\t\t\t\t\t\t\t\t\t\t];\r\n\t\t\t\t\t\t\t\t\t\t\tif (nextPitch < 0 || nextPitch >= drumsetMap.length) throw new Error(\"Could not find corresponding drumset pitch. \" + nextPitch);\r\n\t\t\t\t\t\t\t\t\t\t\tnextPitch = drumsetMap[nextPitch];\r\n\t\t\t\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\t\t\t\tif (usesArpeggio && note.pitches.length > toneIndex + 1 && toneIndex == toneCount - 1) {\r\n\t\t\t\t\t\t\t\t\t\t\t\tconst midiTicksSinceBeat = (midiTickTime - barStartTime) % midiTicksPerBeat;\r\n\t\t\t\t\t\t\t\t\t\t\t\tconst midiTicksPerArpeggio = Config.rhythms[song.rhythm].ticksPerArpeggio * midiTicksPerPart / Config.ticksPerPart;\r\n\t\t\t\t\t\t\t\t\t\t\t\tconst arpeggio: number = Math.floor(midiTicksSinceBeat / midiTicksPerArpeggio);\r\n\t\t\t\t\t\t\t\t\t\t\t\tnextPitch = note.pitches[toneIndex + getArpeggioPitchIndex(note.pitches.length - toneIndex, song.rhythm, arpeggio)];\r\n\t\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t\tnextPitch = channelRoot + nextPitch * intervalScale + pitchOffset;\r\n\t\t\t\t\t\t\t\t\t\t\tif (preset != null && preset.midiSubharmonicOctaves != undefined) {\r\n\t\t\t\t\t\t\t\t\t\t\t\tnextPitch += 12 * preset.midiSubharmonicOctaves;\r\n\t\t\t\t\t\t\t\t\t\t\t} else if (isNoise) {\r\n\t\t\t\t\t\t\t\t\t\t\t\tnextPitch += 12 * (+EditorConfig.presetCategories.dictionary[\"Drum Presets\"].presets.dictionary[\"taiko drum\"].midiSubharmonicOctaves!);\r\n\t\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t\tif (isNoise) nextPitch *= 2;\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\tnextPitch = Math.max(0, Math.min(127, nextPitch));\r\n\t\t\t\t\t\t\t\t\t\tnextPitches[toneIndex] = nextPitch;\r\n\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\tif (!noteStarting && prevPitches[toneIndex] != nextPitches[toneIndex]) {\r\n\t\t\t\t\t\t\t\t\t\t\twriteEventTime(midiTickTime);\r\n\t\t\t\t\t\t\t\t\t\t\twriter.writeUint8(MidiEventType.noteOff | midiChannel);\r\n\t\t\t\t\t\t\t\t\t\t\twriter.writeMidi7Bits(prevPitches[toneIndex]); // old pitch\r\n\t\t\t\t\t\t\t\t\t\t\twriter.writeMidi7Bits(velocity); // velocity\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tfor (let toneIndex: number = 0; toneIndex < toneCount; toneIndex++) {\r\n\t\t\t\t\t\t\t\t\t\tif (noteStarting || prevPitches[toneIndex] != nextPitches[toneIndex]) {\r\n\t\t\t\t\t\t\t\t\t\t\twriteEventTime(midiTickTime);\r\n\t\t\t\t\t\t\t\t\t\t\twriter.writeUint8(MidiEventType.noteOn | midiChannel);\r\n\t\t\t\t\t\t\t\t\t\t\twriter.writeMidi7Bits(nextPitches[toneIndex]); // new pitch\r\n\t\t\t\t\t\t\t\t\t\t\twriter.writeMidi7Bits(velocity); // velocity\r\n\t\t\t\t\t\t\t\t\t\t\tprevPitches[toneIndex] = nextPitches[toneIndex];\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tpinTime = nextPinTime;\r\n\t\t\t\t\t\t\t\tpinSize = nextPinSize;\r\n\t\t\t\t\t\t\t\tpinInterval = nextPinInterval;\r\n\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\tconst noteEndTime: number = barStartTime + note.end * midiTicksPerPart;\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t// End all tones.\r\n\t\t\t\t\t\t\tfor (let toneIndex: number = 0; toneIndex < toneCount; toneIndex++) {\r\n\t\t\t\t\t\t\t\t// TODO: If the note at the start of the next pattern has\r\n\t\t\t\t\t\t\t\t// continuesLastPattern and has the same chord, it ought to extend\r\n\t\t\t\t\t\t\t\t// this previous note.\r\n\t\t\t\t\t\t\t\twriteEventTime(noteEndTime);\r\n\t\t\t\t\t\t\t\twriter.writeUint8(MidiEventType.noteOff | midiChannel);\r\n\t\t\t\t\t\t\t\twriter.writeMidi7Bits(prevPitches[toneIndex]); // pitch\r\n\t\t\t\t\t\t\t\twriter.writeMidi7Bits(velocity); // velocity\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tshouldResetExpressionAndPitchBend = true;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tif (shouldResetExpressionAndPitchBend) {\r\n\t\t\t\t\t\t\tshouldResetExpressionAndPitchBend = false;\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tif (prevExpression != defaultMidiExpression) {\r\n\t\t\t\t\t\t\t\tprevExpression = defaultMidiExpression;\r\n\t\t\t\t\t\t\t\t// Reset expression\r\n\t\t\t\t\t\t\t\twriteEventTime(barStartTime);\r\n\t\t\t\t\t\t\t\twriteControlEvent(MidiControlEventMessage.expressionMSB, prevExpression);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tif (prevPitchBend != defaultMidiPitchBend) {\r\n\t\t\t\t\t\t\t\t// Reset pitch bend\r\n\t\t\t\t\t\t\t\tprevPitchBend = defaultMidiPitchBend;\r\n\t\t\t\t\t\t\t\twriteEventTime(barStartTime);\r\n\t\t\t\t\t\t\t\twriter.writeUint8(MidiEventType.pitchBend | midiChannel);\r\n\t\t\t\t\t\t\t\twriter.writeMidi7Bits(prevPitchBend & 0x7f); // least significant bits\r\n\t\t\t\t\t\t\t\twriter.writeMidi7Bits((prevPitchBend >> 7) & 0x7f); // most significant bits\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t\tbarStartTime += midiTicksPerBar;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\twriteEventTime(barStartTime);\r\n\t\t\twriter.writeUint8(MidiEventType.meta);\r\n\t\t\twriter.writeMidi7Bits(MidiMetaEventMessage.endOfTrack);\r\n\t\t\twriter.writeMidiVariableLength(0x00);\r\n\t\t\t\r\n\t\t\t// Finally, write the length of the track in bytes at the front of the track.\r\n\t\t\twriter.rewriteUint32(trackStartIndex, writer.getWriteIndex() - trackStartIndex - 4);\r\n\t\t}\r\n\t\t\r\n\t\tconst blob: Blob = new Blob([writer.toCompactArrayBuffer()], {type: \"audio/midi\"});\r\n\t\tsave(blob, this._fileName.value.trim() + \".mid\");\r\n\t\t\r\n\t\tthis._close();\r\n\t}\r\n\t\r\n\tprivate _exportToJson(): void {\r\n\t\tconst jsonObject: Object = this._doc.song.toJsonObject(this._enableIntro.checked, Number(this._loopDropDown.value), this._enableOutro.checked);\r\n\t\tconst jsonString: string = JSON.stringify(jsonObject, null, '\\t');\r\n\t\tconst blob: Blob = new Blob([jsonString], {type: \"application/json\"});\r\n\t\tsave(blob, this._fileName.value.trim() + \".json\");\r\n\t\tthis._close();\r\n\t}\r\n\t\r\n\tprivate _exportToHtml(): void {\r\n\t\tconst fileContents = `\\\r\n<!DOCTYPE html><meta charset=\"utf-8\">\r\n\r\nYou should be redirected to the song at:<br /><br />\r\n\r\n<a id=\"destination\" href=\"${new URL(\"#\" + this._doc.song.toBase64String(), location.href).href}\"></a>\r\n\r\n<style>\r\n\t:root {\r\n\t\tcolor: white;\r\n\t\tbackground: black;\r\n\t\tfont-family:\r\n\t\tsans-serif;\r\n\t}\r\n\ta {\r\n\t\tcolor: #98f;\r\n\t}\r\n\ta[href]::before {\r\n\t\tcontent: attr(href);\r\n\t}\r\n</style>\r\n\r\n<script>\r\n\tlocation.assign(document.querySelector(\"a#destination\").href);\r\n</script>\r\n`;\r\n\t\tconst blob: Blob = new Blob([fileContents], {type: \"text/html\"});\r\n\t\tsave(blob, this._fileName.value.trim() + \".html\");\r\n\t\tthis._close();\r\n\t}\r\n}\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\n// Note: All methods are big endian.\r\nexport class ArrayBufferReader {\r\n\tprivate _readIndex: number = 0;\r\n\tprivate _data: DataView;\r\n\t\r\n\tconstructor(data: DataView) {\r\n\t\tthis._data = data;\r\n\t}\r\n\t\r\n\tpublic getReadIndex(): number {\r\n\t\treturn this._readIndex;\r\n\t}\r\n\t\r\n\tpublic readUint32(): number {\r\n\t\tif (this._readIndex + 4 > this._data.byteLength) throw new Error(\"Reading past the end of the buffer.\");\r\n\t\tconst result: number = this._data.getUint32(this._readIndex, false);\r\n\t\tthis._readIndex += 4;\r\n\t\treturn result;\r\n\t}\r\n\t\r\n\tpublic readUint24(): number {\r\n\t\treturn (this.readUint8() << 16) | (this.readUint8() << 8) | (this.readUint8());\r\n\t}\r\n\t\r\n\tpublic readUint16(): number {\r\n\t\tif (this._readIndex + 2 > this._data.byteLength) throw new Error(\"Reading past the end of the buffer.\");\r\n\t\tconst result: number = this._data.getUint16(this._readIndex, false);\r\n\t\tthis._readIndex += 2;\r\n\t\treturn result;\r\n\t}\r\n\t\r\n\tpublic readUint8(): number {\r\n\t\tif (this._readIndex + 1 > this._data.byteLength) throw new Error(\"Reading past the end of the buffer.\");\r\n\t\tconst result: number = this._data.getUint8(this._readIndex);\r\n\t\tthis._readIndex++;\r\n\t\treturn result;\r\n\t}\r\n\t\r\n\tpublic readInt8(): number {\r\n\t\tif (this._readIndex + 1 > this._data.byteLength) throw new Error(\"Reading past the end of the buffer.\");\r\n\t\tconst result: number = this._data.getInt8(this._readIndex);\r\n\t\tthis._readIndex++;\r\n\t\treturn result;\r\n\t}\r\n\t\r\n\tpublic peakUint8(): number {\r\n\t\tif (this._readIndex + 1 > this._data.byteLength) throw new Error(\"Reading past the end of the buffer.\");\r\n\t\treturn this._data.getUint8(this._readIndex);\r\n\t}\r\n\t\r\n\tpublic readMidi7Bits(): number {\r\n\t\tconst result: number = this.readUint8();\r\n\t\tif (result >= 0x80) console.log(\"7 bit value contained 8th bit! value \" + result + \", index \" + this._readIndex);\r\n\t\treturn result & 0x7f;\r\n\t}\r\n\t\r\n\tpublic readMidiVariableLength(): number {\r\n\t\tlet result: number = 0;\r\n\t\tfor (let i: number = 0; i < 4; i++) {\r\n\t\t\tconst nextByte: number = this.readUint8();\r\n\t\t\tresult += nextByte & 0x7f;\r\n\t\t\tif (nextByte & 0x80) {\r\n\t\t\t\tresult = result << 7;\r\n\t\t\t} else {\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn result;\r\n\t}\r\n\t\r\n\tpublic skipBytes(length: number): void {\r\n\t\tthis._readIndex += length;\r\n\t}\r\n\t\r\n\tpublic hasMore(): boolean {\r\n\t\treturn this._data.byteLength > this._readIndex;\r\n\t}\r\n\t\r\n\tpublic getReaderForNextBytes(length: number): ArrayBufferReader {\r\n\t\tif (this._readIndex + length > this._data.byteLength) throw new Error(\"Reading past the end of the buffer.\");\r\n\t\tconst result: ArrayBufferReader = new ArrayBufferReader(new DataView(this._data.buffer, this._data.byteOffset + this._readIndex, length));\r\n\t\tthis.skipBytes(length);\r\n\t\treturn result;\r\n\t}\r\n}\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nimport {InstrumentType, Config} from \"../synth/SynthConfig\";\r\nimport {NotePin, Note, makeNotePin, Pattern, Instrument, Channel, Song, Synth} from \"../synth/synth\";\r\nimport {Preset, EditorConfig} from \"./EditorConfig\";\r\nimport {SongDocument} from \"./SongDocument\";\r\nimport {Prompt} from \"./Prompt\";\r\nimport {HTML} from \"imperative-html/dist/esm/elements-strict\";\r\nimport {ChangeGroup} from \"./Change\";\r\nimport {removeDuplicatePatterns, ChangeSong, ChangeReplacePatterns} from \"./changes\";\r\nimport {AnalogousDrum, analogousDrumMap, MidiChunkType, MidiFileFormat, MidiEventType, MidiControlEventMessage, MidiMetaEventMessage, MidiRegisteredParameterNumberMSB, MidiRegisteredParameterNumberLSB, midiVolumeToVolumeMult, midiExpressionToVolumeMult} from \"./Midi\";\r\nimport {ArrayBufferReader} from \"./ArrayBufferReader\";\r\n\r\nconst {button, p, div, h2, input} = HTML;\r\n\r\nexport class ImportPrompt implements Prompt {\r\n\tprivate readonly _fileInput: HTMLInputElement = input({type: \"file\", accept: \".json,application/json,.mid,.midi,audio/midi,audio/x-midi\"});\r\n\tprivate readonly _cancelButton: HTMLButtonElement = button({class: \"cancelButton\"});\r\n\t\r\n\tpublic readonly container: HTMLDivElement = div({class: \"prompt noSelection\", style: \"width: 300px;\"},\r\n\t\th2(\"Import\"),\r\n\t\tp({style: \"text-align: left; margin: 0.5em 0;\"},\r\n\t\t\t\"BeepBox songs can be exported and re-imported as .json files. You could also use other means to make .json files for BeepBox as long as they follow the same structure.\",\r\n\t\t),\r\n\t\tp({style: \"text-align: left; margin: 0.5em 0;\"},\r\n\t\t\t\"BeepBox can also (crudely) import .mid files. There are many tools available for creating .mid files. Shorter and simpler songs are more likely to work well.\",\r\n\t\t),\r\n\t\tthis._fileInput,\r\n\t\tthis._cancelButton,\r\n\t);\r\n\t\r\n\tconstructor(private _doc: SongDocument) {\r\n\t\tthis._fileInput.select();\r\n\t\tsetTimeout(()=>this._fileInput.focus());\r\n\t\t\r\n\t\tthis._fileInput.addEventListener(\"change\", this._whenFileSelected);\r\n\t\tthis._cancelButton.addEventListener(\"click\", this._close);\r\n\t}\r\n\t\r\n\tprivate _close = (): void => { \r\n\t\tthis._doc.undo();\r\n\t}\r\n\t\r\n\tpublic cleanUp = (): void => { \r\n\t\tthis._fileInput.removeEventListener(\"change\", this._whenFileSelected);\r\n\t\tthis._cancelButton.removeEventListener(\"click\", this._close);\r\n\t}\r\n\t\r\n\tprivate _whenFileSelected = (): void => {\r\n\t\tconst file: File = this._fileInput.files![0];\r\n\t\tif (!file) return;\r\n\t\t\r\n\t\tconst extension: string = file.name.slice((file.name.lastIndexOf(\".\") - 1 >>> 0) + 2).toLowerCase();\r\n\t\tif (extension == \"json\") {\r\n\t\t\tconst reader: FileReader = new FileReader();\r\n\t\t\treader.addEventListener(\"load\", (event: Event): void => {\r\n\t\t\t\tthis._doc.prompt = null;\r\n\t\t\t\tthis._doc.goBackToStart();\r\n\t\t\t\tthis._doc.record(new ChangeSong(this._doc, <string>reader.result), true, true);\r\n\t\t\t});\r\n\t\t\treader.readAsText(file);\r\n\t\t} else if (extension == \"midi\" || extension == \"mid\") {\r\n\t\t\tconst reader: FileReader = new FileReader();\r\n\t\t\treader.addEventListener(\"load\", (event: Event): void => {\r\n\t\t\t\tthis._doc.prompt = null;\r\n\t\t\t\tthis._doc.goBackToStart();\r\n\t\t\t\tthis._parseMidiFile(<ArrayBuffer>reader.result);\r\n\t\t\t});\r\n\t\t\treader.readAsArrayBuffer(file);\r\n\t\t} else {\r\n\t\t\tconsole.error(\"Unrecognized file extension.\");\r\n\t\t\tthis._close();\r\n\t\t}\r\n\t}\r\n\t\r\n\tprivate _parseMidiFile(buffer: ArrayBuffer): void {\r\n\t\t\r\n\t\t// First, split the file into separate buffer readers for each chunk. There should be one header chunk and one or more track chunks.\r\n\t\tconst reader = new ArrayBufferReader(new DataView(buffer));\r\n\t\tlet headerReader: ArrayBufferReader | null = null;\r\n\t\tinterface Track {\r\n\t\t\treader: ArrayBufferReader;\r\n\t\t\tnextEventMidiTick: number;\r\n\t\t\tended: boolean;\r\n\t\t\trunningStatus: number;\r\n\t\t}\r\n\t\tconst tracks: Track[] = [];\r\n\t\twhile(reader.hasMore()) {\r\n\t\t\tconst chunkType: number = reader.readUint32();\r\n\t\t\tconst chunkLength: number = reader.readUint32();\r\n\t\t\tif (chunkType == MidiChunkType.header) {\r\n\t\t\t\tif (headerReader == null) {\r\n\t\t\t\t\theaderReader = reader.getReaderForNextBytes(chunkLength);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tconsole.error(\"This MIDI file has more than one header chunk.\");\r\n\t\t\t\t}\r\n\t\t\t} else if (chunkType == MidiChunkType.track) {\r\n\t\t\t\tconst trackReader: ArrayBufferReader = reader.getReaderForNextBytes(chunkLength);\r\n\t\t\t\tif (trackReader.hasMore()) {\r\n\t\t\t\t\ttracks.push({\r\n\t\t\t\t\t\treader: trackReader,\r\n\t\t\t\t\t\tnextEventMidiTick: trackReader.readMidiVariableLength(),\r\n\t\t\t\t\t\tended: false,\r\n\t\t\t\t\t\trunningStatus: -1,\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\t// Unknown chunk type. Skip it.\r\n\t\t\t\treader.skipBytes(chunkLength);\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tif (headerReader == null) {\r\n\t\t\tconsole.error(\"No header chunk found in this MIDI file.\");\r\n\t\t\tthis._close();\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tconst fileFormat: number = headerReader.readUint16();\r\n\t\t/*const trackCount: number =*/ headerReader.readUint16();\r\n\t\tconst midiTicksPerBeat: number = headerReader.readUint16();\r\n\t\t\r\n\t\t// Midi tracks are generally intended to be played in parallel, but in the format\r\n\t\t// MidiFileFormat.independentTracks, they are played in sequence. Make a list of all\r\n\t\t// of the track indices that should be played in parallel (one or all of the tracks).\r\n\t\tlet currentIndependentTrackIndex: number = 0;\r\n\t\tconst currentTrackIndices: number[] = [];\r\n\t\tconst independentTracks: boolean = (fileFormat == MidiFileFormat.independentTracks);\r\n\t\tif (independentTracks) {\r\n\t\t\tcurrentTrackIndices.push(currentIndependentTrackIndex);\r\n\t\t} else {\r\n\t\t\tfor (let trackIndex: number = 0; trackIndex < tracks.length; trackIndex++) {\r\n\t\t\t\tcurrentTrackIndices.push(trackIndex);\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tinterface NoteEvent {\r\n\t\t\tmidiTick: number;\r\n\t\t\tpitch: number;\r\n\t\t\tvelocity: number;\r\n\t\t\tprogram: number;\r\n\t\t\tinstrumentVolume: number;\r\n\t\t\tinstrumentPan: number;\r\n\t\t\ton: boolean;\r\n\t\t}\r\n\t\tinterface PitchBendEvent {\r\n\t\t\tmidiTick: number;\r\n\t\t\tinterval: number;\r\n\t\t}\r\n\t\tinterface NoteSizeEvent {\r\n\t\t\tmidiTick: number;\r\n\t\t\tsize: number;\r\n\t\t}\r\n\t\t\r\n\t\t// To read a MIDI file we have to simulate state changing over time.\r\n\t\t// Keep a record of various parameters for each channel that may\r\n\t\t// change over time, initialized to default values.\r\n\t\t// Consider making a MidiChannel class and single array of midiChannels.\r\n\t\tconst channelRPNMSB: number[] = [0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff];\r\n\t\tconst channelRPNLSB: number[] = [0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff];\r\n\t\tconst pitchBendRangeMSB: number[] = [2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2]; // pitch bend range defaults to 2 semitones.\r\n\t\tconst pitchBendRangeLSB: number[] = [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]; // and 0 cents.\r\n\t\tconst currentInstrumentProgram: number[] = [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];\r\n\t\tconst currentInstrumentVolumes: number[] = [100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100];\r\n\t\tconst currentInstrumentPans: number[] = [64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64];\r\n\t\tconst noteEvents: NoteEvent[][] = [[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]];\r\n\t\tconst pitchBendEvents: PitchBendEvent[][] = [[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]];\r\n\t\tconst noteSizeEvents: NoteSizeEvent[][] = [[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]];\r\n\t\tlet microsecondsPerBeat: number = 500000; // Tempo in microseconds per \"quarter\" note, commonly known as a \"beat\", default is equivalent to 120 beats per minute.\r\n\t\tlet beatsPerBar: number = 8;\r\n\t\tlet numSharps: number = 0;\r\n\t\tlet isMinor: boolean = false;\r\n\t\t\r\n\t\t// Progress in time through all tracks (in parallel or in sequence) recording state changes and events until all tracks have ended.\r\n\t\tlet currentMidiTick: number = 0;\r\n\t\twhile (true) {\r\n\t\t\tlet nextEventMidiTick: number = Number.MAX_VALUE;\r\n\t\t\tlet anyTrackHasMore: boolean = false;\r\n\t\t\tfor (const trackIndex of currentTrackIndices) {\r\n\t\t\t\t\r\n\t\t\t\t// Parse any events in this track that occur at the currentMidiTick.\r\n\t\t\t\tconst track: Track = tracks[trackIndex];\r\n\t\t\t\twhile (!track.ended && track.nextEventMidiTick == currentMidiTick) {\r\n\t\t\t\t\t\r\n\t\t\t\t\t// If the most significant bit is set in the first byte\r\n\t\t\t\t\t// of the event, it's a new event status, otherwise\r\n\t\t\t\t\t// reuse the running status and save the next byte for\r\n\t\t\t\t\t// the content of the event. I'm assuming running status\r\n\t\t\t\t\t// is separate for each track.\r\n\t\t\t\t\tconst peakStatus: number = track.reader.peakUint8();\r\n\t\t\t\t\tconst eventStatus: number = (peakStatus & 0x80) ? track.reader.readUint8() : track.runningStatus;\r\n\t\t\t\t\tconst eventType: number = eventStatus & 0xF0;\r\n\t\t\t\t\tconst eventChannel: number = eventStatus & 0x0F;\r\n\t\t\t\t\tif (eventType != MidiEventType.metaAndSysex) {\r\n\t\t\t\t\t\ttrack.runningStatus = eventStatus;\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t\tlet foundTrackEndEvent: boolean = false;\r\n\t\t\t\t\t\r\n\t\t\t\t\tswitch (eventType) {\r\n\t\t\t\t\t\tcase MidiEventType.noteOff: {\r\n\t\t\t\t\t\t\tconst pitch: number = track.reader.readMidi7Bits();\r\n\t\t\t\t\t\t\t/*const velocity: number =*/ track.reader.readMidi7Bits();\r\n\t\t\t\t\t\t\tnoteEvents[eventChannel].push({midiTick: currentMidiTick, pitch: pitch, velocity: 0.0, program: -1, instrumentVolume: -1, instrumentPan: -1, on: false});\r\n\t\t\t\t\t\t} break;\r\n\t\t\t\t\t\tcase MidiEventType.noteOn: {\r\n\t\t\t\t\t\t\tconst pitch: number = track.reader.readMidi7Bits();\r\n\t\t\t\t\t\t\tconst velocity: number = track.reader.readMidi7Bits();\r\n\t\t\t\t\t\t\tif (velocity == 0) {\r\n\t\t\t\t\t\t\t\tnoteEvents[eventChannel].push({midiTick: currentMidiTick, pitch: pitch, velocity: 0.0, program: -1, instrumentVolume: -1, instrumentPan: -1, on: false});\r\n\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\tconst volume: number = Math.max(0, Math.min(Config.volumeRange - 1, Math.round(\r\n\t\t\t\t\t\t\t\t\tSynth.volumeMultToInstrumentVolume(midiVolumeToVolumeMult(currentInstrumentVolumes[eventChannel]))\r\n\t\t\t\t\t\t\t\t)));\r\n\t\t\t\t\t\t\t\tconst pan: number = Math.max(0, Math.min(Config.panMax, Math.round(\r\n\t\t\t\t\t\t\t\t\t((currentInstrumentPans[eventChannel] - 64) / 63 + 1) * Config.panCenter\r\n\t\t\t\t\t\t\t\t)));\r\n\t\t\t\t\t\t\t\tnoteEvents[eventChannel].push({\r\n\t\t\t\t\t\t\t\t\tmidiTick: currentMidiTick,\r\n\t\t\t\t\t\t\t\t\tpitch: pitch,\r\n\t\t\t\t\t\t\t\t\tvelocity: Math.max(0.0, Math.min(1.0, (velocity + 14) / 90.0)),\r\n\t\t\t\t\t\t\t\t\tprogram: currentInstrumentProgram[eventChannel],\r\n\t\t\t\t\t\t\t\t\tinstrumentVolume: volume,\r\n\t\t\t\t\t\t\t\t\tinstrumentPan: pan,\r\n\t\t\t\t\t\t\t\t\ton: true,\r\n\t\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t} break;\r\n\t\t\t\t\t\tcase MidiEventType.keyPressure: {\r\n\t\t\t\t\t\t\t/*const pitch: number =*/ track.reader.readMidi7Bits();\r\n\t\t\t\t\t\t\t/*const pressure: number =*/ track.reader.readMidi7Bits();\r\n\t\t\t\t\t\t} break;\r\n\t\t\t\t\t\tcase MidiEventType.controlChange: {\r\n\t\t\t\t\t\t\tconst message: number = track.reader.readMidi7Bits();\r\n\t\t\t\t\t\t\tconst value: number = track.reader.readMidi7Bits();\r\n\t\t\t\t\t\t\t//console.log(\"Control change, message:\", message, \"value:\", value);\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tswitch (message) {\r\n\t\t\t\t\t\t\t\tcase MidiControlEventMessage.setParameterMSB: {\r\n\t\t\t\t\t\t\t\t\tif (channelRPNMSB[eventChannel] == MidiRegisteredParameterNumberMSB.pitchBendRange && channelRPNLSB[eventChannel] == MidiRegisteredParameterNumberLSB.pitchBendRange) {\r\n\t\t\t\t\t\t\t\t\t\tpitchBendRangeMSB[eventChannel] = value;\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t} break;\r\n\t\t\t\t\t\t\t\tcase MidiControlEventMessage.volumeMSB: {\r\n\t\t\t\t\t\t\t\t\tcurrentInstrumentVolumes[eventChannel] = value;\r\n\t\t\t\t\t\t\t\t} break;\r\n\t\t\t\t\t\t\t\tcase MidiControlEventMessage.panMSB: {\r\n\t\t\t\t\t\t\t\t\tcurrentInstrumentPans[eventChannel] = value;\r\n\t\t\t\t\t\t\t\t} break;\r\n\t\t\t\t\t\t\t\tcase MidiControlEventMessage.expressionMSB: {\r\n\t\t\t\t\t\t\t\t\tnoteSizeEvents[eventChannel].push({midiTick: currentMidiTick, size: Synth.volumeMultToNoteSize(midiExpressionToVolumeMult(value))});\r\n\t\t\t\t\t\t\t\t} break;\r\n\t\t\t\t\t\t\t\tcase MidiControlEventMessage.setParameterLSB: {\r\n\t\t\t\t\t\t\t\t\tif (channelRPNMSB[eventChannel] == MidiRegisteredParameterNumberMSB.pitchBendRange && channelRPNLSB[eventChannel] == MidiRegisteredParameterNumberLSB.pitchBendRange) {\r\n\t\t\t\t\t\t\t\t\t\tpitchBendRangeLSB[eventChannel] = value;\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t} break;\r\n\t\t\t\t\t\t\t\tcase MidiControlEventMessage.registeredParameterNumberLSB: {\r\n\t\t\t\t\t\t\t\t\tchannelRPNLSB[eventChannel] = value;\r\n\t\t\t\t\t\t\t\t} break;\r\n\t\t\t\t\t\t\t\tcase MidiControlEventMessage.registeredParameterNumberMSB: {\r\n\t\t\t\t\t\t\t\t\tchannelRPNMSB[eventChannel] = value;\r\n\t\t\t\t\t\t\t\t} break;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t} break;\r\n\t\t\t\t\t\tcase MidiEventType.programChange: {\r\n\t\t\t\t\t\t\tconst program: number = track.reader.readMidi7Bits();\r\n\t\t\t\t\t\t\tcurrentInstrumentProgram[eventChannel] = program;\r\n\t\t\t\t\t\t} break;\r\n\t\t\t\t\t\tcase MidiEventType.channelPressure: {\r\n\t\t\t\t\t\t\t/*const pressure: number =*/ track.reader.readMidi7Bits();\r\n\t\t\t\t\t\t} break;\r\n\t\t\t\t\t\tcase MidiEventType.pitchBend: {\r\n\t\t\t\t\t\t\tconst lsb: number = track.reader.readMidi7Bits();\r\n\t\t\t\t\t\t\tconst msb: number = track.reader.readMidi7Bits();\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tconst pitchBend: number = (((msb << 7) | lsb) / 0x2000) - 1.0;\r\n\t\t\t\t\t\t\tconst pitchBendRange: number = pitchBendRangeMSB[eventChannel] + pitchBendRangeLSB[eventChannel] * 0.01;\r\n\t\t\t\t\t\t\tconst interval: number = pitchBend * pitchBendRange;\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tpitchBendEvents[eventChannel].push({midiTick: currentMidiTick, interval: interval});\r\n\t\t\t\t\t\t} break;\r\n\t\t\t\t\t\tcase MidiEventType.metaAndSysex: {\r\n\t\t\t\t\t\t\tif (eventStatus == MidiEventType.meta) {\r\n\t\t\t\t\t\t\t\tconst message: number = track.reader.readMidi7Bits();\r\n\t\t\t\t\t\t\t\tconst length: number = track.reader.readMidiVariableLength();\r\n\t\t\t\t\t\t\t\t//console.log(\"Meta, message:\", message, \"length:\", length);\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tif (message == MidiMetaEventMessage.endOfTrack) {\r\n\t\t\t\t\t\t\t\t\tfoundTrackEndEvent = true;\r\n\t\t\t\t\t\t\t\t\ttrack.reader.skipBytes(length);\r\n\t\t\t\t\t\t\t\t} else if (message == MidiMetaEventMessage.tempo) {\r\n\t\t\t\t\t\t\t\t\tmicrosecondsPerBeat = track.reader.readUint24();\r\n\t\t\t\t\t\t\t\t\ttrack.reader.skipBytes(length - 3);\r\n\t\t\t\t\t\t\t\t} else if (message == MidiMetaEventMessage.timeSignature) {\r\n\t\t\t\t\t\t\t\t\tconst numerator: number = track.reader.readUint8();\r\n\t\t\t\t\t\t\t\t\tlet denominatorExponent: number = track.reader.readUint8();\r\n\t\t\t\t\t\t\t\t\t/*const midiClocksPerMetronome: number =*/ track.reader.readUint8();\r\n\t\t\t\t\t\t\t\t\t/*const thirtySecondNotesPer24MidiClocks: number =*/ track.reader.readUint8();\r\n\t\t\t\t\t\t\t\t\ttrack.reader.skipBytes(length - 4);\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t// A beat is a quarter note. \r\n\t\t\t\t\t\t\t\t\t// A ratio of 4/4, or 1/1, corresponds to 4 beats per bar.\r\n\t\t\t\t\t\t\t\t\t// Apply the numerator first.\r\n\t\t\t\t\t\t\t\t\tbeatsPerBar = numerator * 4;\r\n\t\t\t\t\t\t\t\t\t// Then apply the denominator, dividing by two until either\r\n\t\t\t\t\t\t\t\t\t// the denominator is satisfied or there's an odd number of\r\n\t\t\t\t\t\t\t\t\t// beats. BeepBox doesn't support fractional beats in a bar.\r\n\t\t\t\t\t\t\t\t\twhile ((beatsPerBar & 1) == 0 && (denominatorExponent > 0 || beatsPerBar > Config.beatsPerBarMax) && beatsPerBar >= Config.beatsPerBarMin * 2) {\r\n\t\t\t\t\t\t\t\t\t\tbeatsPerBar = beatsPerBar >> 1;\r\n\t\t\t\t\t\t\t\t\t\tdenominatorExponent = denominatorExponent - 1;\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\tbeatsPerBar = Math.max(Config.beatsPerBarMin, Math.min(Config.beatsPerBarMax, beatsPerBar));\r\n\t\t\t\t\t\t\t\t} else if (message == MidiMetaEventMessage.keySignature) {\r\n\t\t\t\t\t\t\t\t\tnumSharps = track.reader.readInt8(); // Note: can be negative for flats.\r\n\t\t\t\t\t\t\t\t\tisMinor = track.reader.readUint8() == 1; // 0: major, 1: minor\r\n\t\t\t\t\t\t\t\t\ttrack.reader.skipBytes(length - 2);\r\n\t\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\t\t// Ignore other meta event message types.\r\n\t\t\t\t\t\t\t\t\ttrack.reader.skipBytes(length);\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t} else if (eventStatus == 0xF0 || eventStatus == 0xF7) {\r\n\t\t\t\t\t\t\t\t// Sysex events, just skip the data.\r\n\t\t\t\t\t\t\t\tconst length: number = track.reader.readMidiVariableLength();\r\n\t\t\t\t\t\t\t\ttrack.reader.skipBytes(length);\r\n\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\tconsole.error(\"Unrecognized event status: \" + eventStatus);\r\n\t\t\t\t\t\t\t\tthis._close();\r\n\t\t\t\t\t\t\t\treturn;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t} break;\r\n\t\t\t\t\t\tdefault: {\r\n\t\t\t\t\t\t\tconsole.error(\"Unrecognized event type: \" + eventType);\r\n\t\t\t\t\t\t\tthis._close();\r\n\t\t\t\t\t\t\treturn;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t\tif (!foundTrackEndEvent && track.reader.hasMore()) {\r\n\t\t\t\t\t\ttrack.nextEventMidiTick = currentMidiTick + track.reader.readMidiVariableLength();\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\ttrack.ended = true;\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t// If the tracks are sequential, start the next track when this one ends.\r\n\t\t\t\t\t\tif (independentTracks) {\r\n\t\t\t\t\t\t\tcurrentIndependentTrackIndex++;\r\n\t\t\t\t\t\t\tif (currentIndependentTrackIndex < tracks.length) {\r\n\t\t\t\t\t\t\t\tcurrentTrackIndices[0] = currentIndependentTrackIndex;\r\n\t\t\t\t\t\t\t\ttracks[currentIndependentTrackIndex].nextEventMidiTick += currentMidiTick;\r\n\t\t\t\t\t\t\t\tnextEventMidiTick = Math.min(nextEventMidiTick, tracks[currentIndependentTrackIndex].nextEventMidiTick);\r\n\t\t\t\t\t\t\t\tanyTrackHasMore = true;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tif (!track.ended) {\r\n\t\t\t\t\tanyTrackHasMore = true;\r\n\t\t\t\t\tnextEventMidiTick = Math.min(nextEventMidiTick, track.nextEventMidiTick);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tif (anyTrackHasMore) {\r\n\t\t\t\tcurrentMidiTick = nextEventMidiTick;\r\n\t\t\t} else {\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\t// Now the MIDI file is fully parsed. Next, constuct BeepBox channels out of the data.\r\n\t\tconst microsecondsPerMinute: number = 60 * 1000 * 1000;\r\n\t\tconst beatsPerMinute: number = Math.max(Config.tempoMin, Math.min(Config.tempoMax, Math.round(microsecondsPerMinute / microsecondsPerBeat)));\r\n\t\tconst midiTicksPerPart: number = midiTicksPerBeat / Config.partsPerBeat;\r\n\t\tconst partsPerBar: number = Config.partsPerBeat * beatsPerBar;\r\n\t\tconst songTotalBars: number = Math.ceil(currentMidiTick / midiTicksPerPart / partsPerBar);\r\n\t\t\r\n\t\tfunction quantizeMidiTickToPart(midiTick: number): number {\r\n\t\t\treturn Math.round(midiTick / midiTicksPerPart);\r\n\t\t}\r\n\r\n\t\tlet key: number = numSharps;\r\n\t\tif (isMinor) key += 3; // Diatonic C Major has the same sharps/flats as A Minor, and these keys are 3 semitones apart.\r\n\t\tif ((key & 1) == 1) key += 6; // If the number of sharps/flats is odd, rotate it halfway around the circle of fifths. The key of C# has little in common with the key of C.\r\n\t\twhile (key < 0) key += 12; // Wrap around to a range from 0 to 11.\r\n\t\tkey = key % 12; // Wrap around to a range from 0 to 11.\r\n\t\t\r\n\t\t// Convert each midi channel into a BeepBox channel.\r\n\t\tconst pitchChannels: Channel[] = [];\r\n\t\tconst noiseChannels: Channel[] = [];\r\n\t\tfor (let midiChannel: number = 0; midiChannel < 16; midiChannel++) {\r\n\t\t\tif (noteEvents[midiChannel].length == 0) continue;\r\n\t\t\t\r\n\t\t\tconst channel: Channel = new Channel();\r\n\t\t\t\r\n\t\t\tconst channelPresetValue: number | null = EditorConfig.midiProgramToPresetValue(noteEvents[midiChannel][0].program);\r\n\t\t\tconst channelPreset: Preset | null = (channelPresetValue == null) ? null : EditorConfig.valueToPreset(channelPresetValue);\r\n\t\t\t\r\n\t\t\tconst isDrumsetChannel: boolean = (midiChannel == 9);\r\n\t\t\tconst isNoiseChannel: boolean = isDrumsetChannel || (channelPreset != null && channelPreset.isNoise == true);\r\n\t\t\tconst channelBasePitch: number = isNoiseChannel ? Config.spectrumBasePitch : Config.keys[key].basePitch;\r\n\t\t\tconst intervalScale: number = isNoiseChannel ? Config.noiseInterval : 1;\r\n\t\t\tconst midiIntervalScale: number = isNoiseChannel ? 0.5 : 1;\r\n\t\t\tconst channelMaxPitch: number = isNoiseChannel ? Config.drumCount - 1 : Config.maxPitch;\r\n\t\t\t\r\n\t\t\tif (isNoiseChannel) {\r\n\t\t\t\tif (isDrumsetChannel) {\r\n\t\t\t\t\tnoiseChannels.unshift(channel);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tnoiseChannels.push(channel);\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\tpitchChannels.push(channel);\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tlet currentVelocity: number = 1.0;\r\n\t\t\tlet currentProgram: number = 0;\r\n\t\t\tlet currentInstrumentVolume: number = 0;\r\n\t\t\tlet currentInstrumentPan: number = Config.panCenter;\r\n\t\t\t\r\n\t\t\tif (isDrumsetChannel) {\r\n\t\t\t\tconst heldPitches: number[] = [];\r\n\t\t\t\tlet currentBar: number = -1;\r\n\t\t\t\tlet pattern: Pattern | null = null;\r\n\t\t\t\tlet prevEventPart: number = 0;\r\n\t\t\t\tlet setInstrumentVolume: boolean = false;\r\n\t\t\t\t\r\n\t\t\t\tconst presetValue: number = EditorConfig.nameToPresetValue(\"standard drumset\")!;\r\n\t\t\t\tconst preset: Preset = EditorConfig.valueToPreset(presetValue)!;\r\n\t\t\t\tconst instrument: Instrument = new Instrument(false);\r\n\t\t\t\tinstrument.fromJsonObject(preset.settings, false, 1);\r\n\t\t\t\tinstrument.preset = presetValue;\r\n\t\t\t\tchannel.instruments.push(instrument);\r\n\r\n\t\t\t\tfor (let noteEventIndex: number = 0; noteEventIndex <= noteEvents[midiChannel].length; noteEventIndex++) {\r\n\t\t\t\t\tconst noMoreNotes: boolean = noteEventIndex == noteEvents[midiChannel].length;\r\n\t\t\t\t\tconst noteEvent: NoteEvent | null = noMoreNotes ? null : noteEvents[midiChannel][noteEventIndex];\r\n\t\t\t\t\tconst nextEventPart: number = noteEvent == null ? Number.MAX_SAFE_INTEGER : quantizeMidiTickToPart(noteEvent.midiTick);\r\n\t\t\t\t\tif (heldPitches.length > 0 && nextEventPart > prevEventPart && (noteEvent == null || noteEvent.on)) {\r\n\t\t\t\t\t\tconst bar: number = Math.floor(prevEventPart / partsPerBar);\r\n\t\t\t\t\t\tconst barStartPart: number = bar * partsPerBar;\r\n\t\t\t\t\t\t// Ensure a pattern exists for the current bar before inserting notes into it.\r\n\t\t\t\t\t\tif (currentBar != bar || pattern == null) {\r\n\t\t\t\t\t\t\tcurrentBar++;\r\n\t\t\t\t\t\t\twhile (currentBar < bar) {\r\n\t\t\t\t\t\t\t\tchannel.bars[currentBar] = 0;\r\n\t\t\t\t\t\t\t\tcurrentBar++;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tpattern = new Pattern();\r\n\t\t\t\t\t\t\tchannel.patterns.push(pattern);\r\n\t\t\t\t\t\t\tchannel.bars[currentBar] = channel.patterns.length;\r\n\t\t\t\t\t\t\tpattern.instruments[0] = 0;\r\n\t\t\t\t\t\t\tpattern.instruments.length = 1;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t// Use the loudest volume setting for the instrument, since \r\n\t\t\t\t\t\t// many midis unfortunately use the instrument volume control to fade\r\n\t\t\t\t\t\t// in at the beginning and we don't want to get stuck with the initial\r\n\t\t\t\t\t\t// zero volume.\r\n\t\t\t\t\t\tif (!setInstrumentVolume || instrument.volume > currentInstrumentVolume) {\r\n\t\t\t\t\t\t\tinstrument.volume = currentInstrumentVolume;\r\n\t\t\t\t\t\t\tinstrument.pan = currentInstrumentPan;\r\n\t\t\t\t\t\t\tsetInstrumentVolume = true;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tconst drumFreqs: number[] = [];\r\n\t\t\t\t\t\tlet minDuration: number = channelMaxPitch;\r\n\t\t\t\t\t\tlet maxDuration: number = 0;\r\n\t\t\t\t\t\tlet noteSize: number = 1; // the minimum non-zero note size.\r\n\t\t\t\t\t\tfor (const pitch of heldPitches) {\r\n\t\t\t\t\t\t\tconst drum: AnalogousDrum | undefined = analogousDrumMap[pitch];\r\n\t\t\t\t\t\t\tif (drumFreqs.indexOf(drum.frequency) == -1) {\r\n\t\t\t\t\t\t\t\tdrumFreqs.push(drum.frequency);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tnoteSize = Math.max(noteSize, Math.round(drum.volume * currentVelocity));\r\n\t\t\t\t\t\t\tminDuration = Math.min(minDuration, drum.duration);\r\n\t\t\t\t\t\t\tmaxDuration = Math.max(maxDuration, drum.duration);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tconst duration: number = Math.min(maxDuration, Math.max(minDuration, 2));\r\n\t\t\t\t\t\tconst noteStartPart: number = prevEventPart - barStartPart;\r\n\t\t\t\t\t\tconst noteEndPart: number = Math.min(partsPerBar, Math.min(nextEventPart - barStartPart, noteStartPart + duration * 6));\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tconst note: Note = new Note(-1, noteStartPart, noteEndPart, noteSize, true);\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tnote.pitches.length = 0;\r\n\t\t\t\t\t\tfor (let pitchIndex: number = 0; pitchIndex < Math.min(Config.maxChordSize, drumFreqs.length); pitchIndex++) {\r\n\t\t\t\t\t\t\tconst heldPitch: number = drumFreqs[pitchIndex + Math.max(0, drumFreqs.length - Config.maxChordSize)];\r\n\t\t\t\t\t\t\tif (note.pitches.indexOf(heldPitch) == -1) {\r\n\t\t\t\t\t\t\t\tnote.pitches.push(heldPitch);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tpattern.notes.push(note);\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\theldPitches.length = 0;\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t\t// Process the next midi note event before continuing, updating the list of currently held pitches.\r\n\t\t\t\t\tif (noteEvent != null && noteEvent.on && analogousDrumMap[noteEvent.pitch] != undefined) {\r\n\t\t\t\t\t\theldPitches.push(noteEvent.pitch);\r\n\t\t\t\t\t\tprevEventPart = nextEventPart;\r\n\t\t\t\t\t\tcurrentVelocity = noteEvent.velocity;\r\n\t\t\t\t\t\tcurrentInstrumentVolume = noteEvent.instrumentVolume;\r\n\t\t\t\t\t\tcurrentInstrumentPan = noteEvent.instrumentPan;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\t// If not a drumset, handle as a tonal instrument.\r\n\t\t\t\t\r\n\t\t\t\t// Advance the pitch bend and note size timelines to the given midiTick, \r\n\t\t\t\t// changing the value of currentMidiInterval or currentMidiNoteSize.\r\n\t\t\t\t// IMPORTANT: These functions can't rewind!\r\n\t\t\t\tlet currentMidiInterval: number = 0.0;\r\n\t\t\t\tlet currentMidiNoteSize: number = Config.noteSizeMax;\r\n\t\t\t\tlet pitchBendEventIndex: number = 0;\r\n\t\t\t\tlet noteSizeEventIndex: number = 0;\r\n\t\t\t\tfunction updateCurrentMidiInterval(midiTick: number) {\r\n\t\t\t\t\twhile (pitchBendEventIndex < pitchBendEvents[midiChannel].length && pitchBendEvents[midiChannel][pitchBendEventIndex].midiTick <= midiTick) {\r\n\t\t\t\t\t\tcurrentMidiInterval = pitchBendEvents[midiChannel][pitchBendEventIndex].interval;\r\n\t\t\t\t\t\tpitchBendEventIndex++;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tfunction updateCurrentMidiNoteSize(midiTick: number) {\r\n\t\t\t\t\twhile (noteSizeEventIndex < noteSizeEvents[midiChannel].length && noteSizeEvents[midiChannel][noteSizeEventIndex].midiTick <= midiTick) {\r\n\t\t\t\t\t\tcurrentMidiNoteSize = noteSizeEvents[midiChannel][noteSizeEventIndex].size;\r\n\t\t\t\t\t\tnoteSizeEventIndex++;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tconst instrumentByProgram: Instrument[] = [];\r\n\t\t\t\tconst heldPitches: number[] = [];\r\n\t\t\t\tlet currentBar: number = -1;\r\n\t\t\t\tlet pattern: Pattern | null = null;\r\n\t\t\t\tlet prevEventMidiTick: number = 0;\r\n\t\t\t\tlet prevEventPart: number = 0;\r\n\t\t\t\tlet pitchSum: number = 0;\r\n\t\t\t\tlet pitchCount: number = 0;\r\n\t\t\t\t\r\n\t\t\t\tfor (let noteEvent of noteEvents[midiChannel]) {\r\n\t\t\t\t\tconst nextEventMidiTick: number = noteEvent.midiTick;\r\n\t\t\t\t\tconst nextEventPart: number = quantizeMidiTickToPart(nextEventMidiTick);\r\n\t\t\t\t\t\r\n\t\t\t\t\tif (heldPitches.length > 0 && nextEventPart > prevEventPart) {\r\n\t\t\t\t\t\t// If there are any pitches held between the previous event and the next\r\n\t\t\t\t\t\t// event, iterate over all bars covered by this time period, ensure they\r\n\t\t\t\t\t\t// have a pattern instantiated, and insert notes for these pitches.\r\n\t\t\t\t\t\tconst startBar: number = Math.floor(prevEventPart / partsPerBar);\r\n\t\t\t\t\t\tconst endBar: number = Math.ceil(nextEventPart / partsPerBar);\r\n\t\t\t\t\t\tlet createdNote: boolean = false;\r\n\t\t\t\t\t\tfor (let bar: number = startBar; bar < endBar; bar++) {\r\n\t\t\t\t\t\t\tconst barStartPart: number = bar * partsPerBar;\r\n\t\t\t\t\t\t\tconst barStartMidiTick: number = bar * beatsPerBar * midiTicksPerBeat;\r\n\t\t\t\t\t\t\tconst barEndMidiTick: number = (bar + 1) * beatsPerBar * midiTicksPerBeat;\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tconst noteStartPart: number = Math.max(0, prevEventPart - barStartPart);\r\n\t\t\t\t\t\t\tconst noteEndPart: number = Math.min(partsPerBar, nextEventPart - barStartPart);\r\n\t\t\t\t\t\t\tconst noteStartMidiTick: number = Math.max(barStartMidiTick, prevEventMidiTick);\r\n\t\t\t\t\t\t\tconst noteEndMidiTick: number = Math.min(barEndMidiTick, nextEventMidiTick);\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tif (noteStartPart < noteEndPart) {\r\n\t\t\t\t\t\t\t\tconst presetValue: number | null = EditorConfig.midiProgramToPresetValue(currentProgram);\r\n\t\t\t\t\t\t\t\tconst preset: Preset | null = (presetValue == null) ? null : EditorConfig.valueToPreset(presetValue);\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t// Ensure a pattern exists for the current bar before inserting notes into it.\r\n\t\t\t\t\t\t\t\tif (currentBar != bar || pattern == null) {\r\n\t\t\t\t\t\t\t\t\tcurrentBar++;\r\n\t\t\t\t\t\t\t\t\twhile (currentBar < bar) {\r\n\t\t\t\t\t\t\t\t\t\tchannel.bars[currentBar] = 0;\r\n\t\t\t\t\t\t\t\t\t\tcurrentBar++;\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\tpattern = new Pattern();\r\n\t\t\t\t\t\t\t\t\tchannel.patterns.push(pattern);\r\n\t\t\t\t\t\t\t\t\tchannel.bars[currentBar] = channel.patterns.length;\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t// If this is the first time a note is trying to use a specific instrument\r\n\t\t\t\t\t\t\t\t\t// program in this channel, create a new BeepBox instrument for it.\r\n\t\t\t\t\t\t\t\t\tif (instrumentByProgram[currentProgram] == undefined) {\r\n\t\t\t\t\t\t\t\t\t\tconst instrument: Instrument = new Instrument(isNoiseChannel);\r\n\t\t\t\t\t\t\t\t\t\tinstrumentByProgram[currentProgram] = instrument;\r\n\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\tif (presetValue != null && preset != null && (preset.isNoise == true) == isNoiseChannel) {\r\n\t\t\t\t\t\t\t\t\t\t\tinstrument.fromJsonObject(preset.settings, isNoiseChannel, 1);\r\n\t\t\t\t\t\t\t\t\t\t\tinstrument.preset = presetValue;\r\n\t\t\t\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\t\t\t\tinstrument.setTypeAndReset(isNoiseChannel ? InstrumentType.noise : InstrumentType.chip, isNoiseChannel);\r\n\t\t\t\t\t\t\t\t\t\t\tinstrument.chord = 0; // Midi instruments use polyphonic harmony by default.\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\tinstrument.volume = currentInstrumentVolume;\r\n\t\t\t\t\t\t\t\t\t\tinstrument.pan = currentInstrumentPan;\r\n\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\tchannel.instruments.push(instrument);\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tpattern.instruments[0] = channel.instruments.indexOf(instrumentByProgram[currentProgram]);\r\n\t\t\t\t\t\t\t\t\tpattern.instruments.length = 1;\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t// Use the loudest volume setting for the instrument, since \r\n\t\t\t\t\t\t\t\t// many midis unfortunately use the instrument volume control to fade\r\n\t\t\t\t\t\t\t\t// in at the beginning and we don't want to get stuck with the initial\r\n\t\t\t\t\t\t\t\t// zero volume.\r\n\t\t\t\t\t\t\t\tif (instrumentByProgram[currentProgram] != undefined) {\r\n\t\t\t\t\t\t\t\t\tinstrumentByProgram[currentProgram].volume = Math.min(instrumentByProgram[currentProgram].volume, currentInstrumentVolume);\r\n\t\t\t\t\t\t\t\t\tinstrumentByProgram[currentProgram].pan = Math.min(instrumentByProgram[currentProgram].pan, currentInstrumentPan);\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t// Create a new note, and interpret the pitch bend and note size events\r\n\t\t\t\t\t\t\t\t// to determine where we need to insert pins to control interval and size.\r\n\t\t\t\t\t\t\t\tconst note: Note = new Note(-1, noteStartPart, noteEndPart, Config.noteSizeMax, false);\r\n\t\t\t\t\t\t\t\tnote.pins.length = 0;\r\n\t\t\t\t\t\t\t\tnote.continuesLastPattern = (createdNote && noteStartPart == 0);\r\n\t\t\t\t\t\t\t\tcreatedNote = true;\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tupdateCurrentMidiInterval(noteStartMidiTick);\r\n\t\t\t\t\t\t\t\tupdateCurrentMidiNoteSize(noteStartMidiTick);\r\n\t\t\t\t\t\t\t\tconst shiftedHeldPitch: number = heldPitches[0] * midiIntervalScale - channelBasePitch;\r\n\t\t\t\t\t\t\t\tconst initialBeepBoxPitch: number = Math.round((shiftedHeldPitch + currentMidiInterval) / intervalScale);\r\n\t\t\t\t\t\t\t\tconst heldPitchOffset: number = Math.round(currentMidiInterval - channelBasePitch);\r\n\t\t\t\t\t\t\t\tlet firstPin: NotePin = makeNotePin(0, 0, Math.round(currentVelocity * currentMidiNoteSize));\r\n\t\t\t\t\t\t\t\tnote.pins.push(firstPin);\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tinterface PotentialPin {\r\n\t\t\t\t\t\t\t\t\tpart: number;\r\n\t\t\t\t\t\t\t\t\tpitch: number;\r\n\t\t\t\t\t\t\t\t\tsize: number;\r\n\t\t\t\t\t\t\t\t\tkeyPitch: boolean;\r\n\t\t\t\t\t\t\t\t\tkeySize: boolean;\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\tconst potentialPins: PotentialPin[] = [\r\n\t\t\t\t\t\t\t\t\t{part: 0, pitch: initialBeepBoxPitch, size: firstPin.size, keyPitch: false, keySize: false}\r\n\t\t\t\t\t\t\t\t];\r\n\t\t\t\t\t\t\t\tlet prevPinIndex: number = 0;\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tlet prevPartPitch: number = (shiftedHeldPitch + currentMidiInterval) / intervalScale;\r\n\t\t\t\t\t\t\t\tlet prevPartSize: number = currentVelocity * currentMidiNoteSize;\r\n\t\t\t\t\t\t\t\tfor (let part: number = noteStartPart + 1; part <= noteEndPart; part++) {\r\n\t\t\t\t\t\t\t\t\tconst midiTick: number = Math.max(noteStartMidiTick, Math.min(noteEndMidiTick - 1, Math.round(midiTicksPerPart * (part + barStartPart))));\r\n\t\t\t\t\t\t\t\t\tconst noteRelativePart: number = part - noteStartPart;\r\n\t\t\t\t\t\t\t\t\tconst lastPart: boolean = (part == noteEndPart);\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t// BeepBox can only add pins at whole number intervals and sizes. Detect places where\r\n\t\t\t\t\t\t\t\t\t// the interval or size are at or cross whole numbers, and add these to the list of\r\n\t\t\t\t\t\t\t\t\t// potential places to insert pins.\r\n\t\t\t\t\t\t\t\t\tupdateCurrentMidiInterval(midiTick);\r\n\t\t\t\t\t\t\t\t\tupdateCurrentMidiNoteSize(midiTick);\r\n\t\t\t\t\t\t\t\t\tconst partPitch: number = (currentMidiInterval + shiftedHeldPitch) / intervalScale;\r\n\t\t\t\t\t\t\t\t\tconst partSize: number = currentVelocity * currentMidiNoteSize;\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tconst nearestPitch: number = Math.round(partPitch);\r\n\t\t\t\t\t\t\t\t\tconst pitchIsNearInteger: boolean = Math.abs(partPitch - nearestPitch) < 0.01;\r\n\t\t\t\t\t\t\t\t\tconst pitchCrossedInteger: boolean = (Math.abs(prevPartPitch - Math.round(prevPartPitch)) < 0.01)\r\n\t\t\t\t\t\t\t\t\t\t? Math.abs(partPitch - prevPartPitch) >= 1.0\r\n\t\t\t\t\t\t\t\t\t\t: Math.floor(partPitch) != Math.floor(prevPartPitch);\r\n\t\t\t\t\t\t\t\t\tconst keyPitch: boolean = pitchIsNearInteger || pitchCrossedInteger;\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tconst nearestSize: number = Math.round(partSize);\r\n\t\t\t\t\t\t\t\t\tconst sizeIsNearInteger: boolean = Math.abs(partSize - nearestSize) < 0.01;\r\n\t\t\t\t\t\t\t\t\tconst sizeCrossedInteger: boolean = (Math.abs(prevPartSize - Math.round(prevPartSize)))\r\n\t\t\t\t\t\t\t\t\t\t? Math.abs(partSize - prevPartSize) >= 1.0\r\n\t\t\t\t\t\t\t\t\t\t: Math.floor(partSize) != Math.floor(prevPartSize);\r\n\t\t\t\t\t\t\t\t\tconst keySize: boolean = sizeIsNearInteger || sizeCrossedInteger;\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tprevPartPitch = partPitch;\r\n\t\t\t\t\t\t\t\t\tprevPartSize = partSize;\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tif (keyPitch || keySize || lastPart) {\r\n\t\t\t\t\t\t\t\t\t\tconst currentPin: PotentialPin = {part: noteRelativePart, pitch: nearestPitch, size: nearestSize, keyPitch: keyPitch || lastPart, keySize: keySize || lastPart};\r\n\t\t\t\t\t\t\t\t\t\tconst prevPin: PotentialPin = potentialPins[prevPinIndex];\r\n\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t// At all key points in the list of potential pins, check to see if they\r\n\t\t\t\t\t\t\t\t\t\t// continue the recent slope. If not, insert a pin at the corner, where\r\n\t\t\t\t\t\t\t\t\t\t// the recent recorded values deviate the furthest from the slope.\r\n\t\t\t\t\t\t\t\t\t\tlet addPin: boolean = false;\r\n\t\t\t\t\t\t\t\t\t\tlet addPinAtIndex: number = Number.MAX_VALUE;\r\n\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\tif (currentPin.keyPitch) {\r\n\t\t\t\t\t\t\t\t\t\t\tconst slope: number = (currentPin.pitch - prevPin.pitch) / (currentPin.part - prevPin.part);\r\n\t\t\t\t\t\t\t\t\t\t\tlet furthestIntervalDistance: number = Math.abs(slope); // minimum distance to make a new pin.\r\n\t\t\t\t\t\t\t\t\t\t\tlet addIntervalPin: boolean = false;\r\n\t\t\t\t\t\t\t\t\t\t\tlet addIntervalPinAtIndex: number = Number.MAX_VALUE;\r\n\t\t\t\t\t\t\t\t\t\t\tfor (let potentialIndex: number = prevPinIndex + 1; potentialIndex < potentialPins.length; potentialIndex++) {\r\n\t\t\t\t\t\t\t\t\t\t\t\tconst potentialPin: PotentialPin = potentialPins[potentialIndex];\r\n\t\t\t\t\t\t\t\t\t\t\t\tif (potentialPin.keyPitch) {\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tconst interpolatedInterval: number = prevPin.pitch + slope * (potentialPin.part - prevPin.part);\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tconst distance: number = Math.abs(interpolatedInterval - potentialPin.pitch);\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tif (furthestIntervalDistance < distance) {\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfurthestIntervalDistance = distance;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\taddIntervalPin = true;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\taddIntervalPinAtIndex = potentialIndex;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t\tif (addIntervalPin) {\r\n\t\t\t\t\t\t\t\t\t\t\t\taddPin = true;\r\n\t\t\t\t\t\t\t\t\t\t\t\taddPinAtIndex = Math.min(addPinAtIndex, addIntervalPinAtIndex);\r\n\t\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\tif (currentPin.keySize) {\r\n\t\t\t\t\t\t\t\t\t\t\tconst slope: number = (currentPin.size - prevPin.size) / (currentPin.part - prevPin.part);\r\n\t\t\t\t\t\t\t\t\t\t\tlet furthestSizeDistance: number = Math.abs(slope); // minimum distance to make a new pin.\r\n\t\t\t\t\t\t\t\t\t\t\tlet addSizePin: boolean = false;\r\n\t\t\t\t\t\t\t\t\t\t\tlet addSizePinAtIndex: number = Number.MAX_VALUE;\r\n\t\t\t\t\t\t\t\t\t\t\tfor (let potentialIndex: number = prevPinIndex + 1; potentialIndex < potentialPins.length; potentialIndex++) {\r\n\t\t\t\t\t\t\t\t\t\t\t\tconst potentialPin: PotentialPin = potentialPins[potentialIndex];\r\n\t\t\t\t\t\t\t\t\t\t\t\tif (potentialPin.keySize) {\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tconst interpolatedSize: number = prevPin.size + slope * (potentialPin.part - prevPin.part);\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tconst distance: number = Math.abs(interpolatedSize - potentialPin.size);\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tif (furthestSizeDistance < distance) {\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfurthestSizeDistance = distance;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\taddSizePin = true;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\taddSizePinAtIndex = potentialIndex;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t\tif (addSizePin) {\r\n\t\t\t\t\t\t\t\t\t\t\t\taddPin = true;\r\n\t\t\t\t\t\t\t\t\t\t\t\taddPinAtIndex = Math.min(addPinAtIndex, addSizePinAtIndex);\r\n\t\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\tif (addPin) {\r\n\t\t\t\t\t\t\t\t\t\t\tconst toBePinned: PotentialPin = potentialPins[addPinAtIndex];\r\n\t\t\t\t\t\t\t\t\t\t\tnote.pins.push(makeNotePin(toBePinned.pitch - initialBeepBoxPitch, toBePinned.part, toBePinned.size));\r\n\t\t\t\t\t\t\t\t\t\t\tprevPinIndex = addPinAtIndex;\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\tpotentialPins.push(currentPin);\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t// And always add a pin at the end of the note.\r\n\t\t\t\t\t\t\t\tconst lastToBePinned: PotentialPin = potentialPins[potentialPins.length - 1];\r\n\t\t\t\t\t\t\t\tnote.pins.push(makeNotePin(lastToBePinned.pitch - initialBeepBoxPitch, lastToBePinned.part, lastToBePinned.size));\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t// Use interval range to constrain min/max pitches so no pin is out of bounds.\r\n\t\t\t\t\t\t\t\tlet maxPitch: number = channelMaxPitch;\r\n\t\t\t\t\t\t\t\tlet minPitch: number = 0;\r\n\t\t\t\t\t\t\t\tfor (const notePin of note.pins) {\r\n\t\t\t\t\t\t\t\t\tmaxPitch = Math.min(maxPitch, channelMaxPitch - notePin.interval);\r\n\t\t\t\t\t\t\t\t\tminPitch = Math.min(minPitch, -notePin.interval);\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t// Build the note chord out of the current pitches, shifted into BeepBox channelBasePitch relative values.\r\n\t\t\t\t\t\t\t\tnote.pitches.length = 0;\r\n\t\t\t\t\t\t\t\tfor (let pitchIndex: number = 0; pitchIndex < Math.min(Config.maxChordSize, heldPitches.length); pitchIndex++) {\r\n\t\t\t\t\t\t\t\t\tlet heldPitch: number = heldPitches[pitchIndex + Math.max(0, heldPitches.length - Config.maxChordSize)] * midiIntervalScale;\r\n\t\t\t\t\t\t\t\t\tif (preset != null && preset.midiSubharmonicOctaves != undefined) {\r\n\t\t\t\t\t\t\t\t\t\theldPitch -= 12 * preset.midiSubharmonicOctaves;\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\tconst shiftedPitch: number = Math.max(minPitch, Math.min(maxPitch, Math.round((heldPitch + heldPitchOffset) / intervalScale)));\r\n\t\t\t\t\t\t\t\t\tif (note.pitches.indexOf(shiftedPitch) == -1) {\r\n\t\t\t\t\t\t\t\t\t\tnote.pitches.push(shiftedPitch);\r\n\t\t\t\t\t\t\t\t\t\tconst weight: number = note.end - note.start;\r\n\t\t\t\t\t\t\t\t\t\tpitchSum += shiftedPitch * weight;\r\n\t\t\t\t\t\t\t\t\t\tpitchCount += weight;\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\tpattern.notes.push(note);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t\t// Process the next midi note event before continuing, updating the list of currently held pitches.\r\n\t\t\t\t\tif (heldPitches.indexOf(noteEvent.pitch) != -1) {\r\n\t\t\t\t\t\theldPitches.splice(heldPitches.indexOf(noteEvent.pitch), 1);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (noteEvent.on) {\r\n\t\t\t\t\t\theldPitches.push(noteEvent.pitch);\r\n\t\t\t\t\t\tcurrentVelocity = noteEvent.velocity;\r\n\t\t\t\t\t\tcurrentProgram = noteEvent.program;\r\n\t\t\t\t\t\tcurrentInstrumentVolume = noteEvent.instrumentVolume;\r\n\t\t\t\t\t\tcurrentInstrumentPan = noteEvent.instrumentPan;\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t\tprevEventMidiTick = nextEventMidiTick;\r\n\t\t\t\t\tprevEventPart = nextEventPart;\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tconst averagePitch: number = pitchSum / pitchCount;\r\n\t\t\t\tchannel.octave = isNoiseChannel ? 0 : Math.max(0, Math.min(Config.pitchOctaves - 1, Math.floor(averagePitch / 12)));\r\n\t\t\t}\r\n\t\t\t\t\r\n\t\t\twhile (channel.bars.length < songTotalBars) {\r\n\t\t\t\tchannel.bars.push(0);\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\t// For better or for worse, BeepBox has a more limited number of channels than Midi.\r\n\t\t// To compensate, try to merge non-overlapping channels.\r\n\t\tfunction compactChannels(channels: Channel[], maxLength: number): void {\r\n\t\t\twhile (channels.length > maxLength) {\r\n\t\t\t\tlet bestChannelIndexA: number = channels.length - 2;\r\n\t\t\t\tlet bestChannelIndexB: number = channels.length - 1;\r\n\t\t\t\tlet fewestConflicts: number = Number.MAX_VALUE;\r\n\t\t\t\tlet fewestGaps: number = Number.MAX_VALUE;\r\n\t\t\t\tfor (let channelIndexA: number = 0; channelIndexA < channels.length - 1; channelIndexA++) {\r\n\t\t\t\t\tfor (let channelIndexB: number = channelIndexA + 1; channelIndexB < channels.length; channelIndexB++) {\r\n\t\t\t\t\t\tconst channelA: Channel = channels[channelIndexA];\r\n\t\t\t\t\t\tconst channelB: Channel = channels[channelIndexB];\r\n\t\t\t\t\t\tlet conflicts: number = 0;\r\n\t\t\t\t\t\tlet gaps: number = 0;\r\n\t\t\t\t\t\tfor (let barIndex: number = 0; barIndex < channelA.bars.length && barIndex < channelB.bars.length; barIndex++) {\r\n\t\t\t\t\t\t\tif (channelA.bars[barIndex] != 0 && channelB.bars[barIndex] != 0) conflicts++;\r\n\t\t\t\t\t\t\tif (channelA.bars[barIndex] == 0 && channelB.bars[barIndex] == 0) gaps++;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif (conflicts <= fewestConflicts) {\r\n\t\t\t\t\t\t\tif (conflicts < fewestConflicts || gaps < fewestGaps) {\r\n\t\t\t\t\t\t\t\tbestChannelIndexA = channelIndexA;\r\n\t\t\t\t\t\t\t\tbestChannelIndexB = channelIndexB;\r\n\t\t\t\t\t\t\t\tfewestConflicts = conflicts;\r\n\t\t\t\t\t\t\t\tfewestGaps = gaps;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\t// Merge channelB's patterns, instruments, and bars into channelA.\r\n\t\t\t\tconst channelA: Channel = channels[bestChannelIndexA];\r\n\t\t\t\tconst channelB: Channel = channels[bestChannelIndexB];\r\n\t\t\t\tconst channelAInstrumentCount: number = channelA.instruments.length;\r\n\t\t\t\tconst channelAPatternCount: number = channelA.patterns.length;\r\n\t\t\t\tfor (const instrument of channelB.instruments) {\r\n\t\t\t\t\tchannelA.instruments.push(instrument);\r\n\t\t\t\t}\r\n\t\t\t\tfor (const pattern of channelB.patterns) {\r\n\t\t\t\t\tpattern.instruments[0] += channelAInstrumentCount;\r\n\t\t\t\t\tchannelA.patterns.push(pattern);\r\n\t\t\t\t}\r\n\t\t\t\tfor (let barIndex: number = 0; barIndex < channelA.bars.length && barIndex < channelB.bars.length; barIndex++) {\r\n\t\t\t\t\tif (channelA.bars[barIndex] == 0 && channelB.bars[barIndex] != 0) {\r\n\t\t\t\t\t\tchannelA.bars[barIndex] = channelB.bars[barIndex] + channelAPatternCount;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\t// Remove channelB.\r\n\t\t\t\tchannels.splice(bestChannelIndexB, 1);\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tcompactChannels(pitchChannels, Config.pitchChannelCountMax);\r\n\t\tcompactChannels(noiseChannels, Config.noiseChannelCountMax);\r\n\t\t\r\n\t\tclass ChangeImportMidi extends ChangeGroup {\r\n\t\t\tconstructor(doc: SongDocument) {\r\n\t\t\t\tsuper();\r\n\t\t\t\tconst song: Song = doc.song;\r\n\t\t\t\tsong.tempo = beatsPerMinute;\r\n\t\t\t\tsong.beatsPerBar = beatsPerBar;\r\n\t\t\t\tsong.key = key;\r\n\t\t\t\tsong.scale = 11;\r\n\t\t\t\tsong.rhythm = 1;\r\n\t\t\t\tsong.layeredInstruments = false;\r\n\t\t\t\tsong.patternInstruments = pitchChannels.some(channel => channel.instruments.length > 1) || noiseChannels.some(channel => channel.instruments.length > 1);\r\n\t\t\t\t\r\n\t\t\t\tremoveDuplicatePatterns(pitchChannels);\r\n\t\t\t\tremoveDuplicatePatterns(noiseChannels);\r\n\t\t\t\t\r\n\t\t\t\tthis.append(new ChangeReplacePatterns(doc, pitchChannels, noiseChannels));\r\n\t\t\t\tsong.loopStart = 0;\r\n\t\t\t\tsong.loopLength = song.barCount;\r\n\t\t\t\tthis._didSomething();\r\n\t\t\t\tdoc.notifier.changed();\r\n\t\t\t}\r\n\t\t}\r\n\t\tthis._doc.goBackToStart();\r\n\t\tfor (const channel of this._doc.song.channels) channel.muted = false;\r\n\t\tthis._doc.prompt = null;\r\n\t\tthis._doc.record(new ChangeImportMidi(this._doc), true, true);\r\n\t}\r\n}\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nimport {Dictionary} from \"../synth/SynthConfig\";\r\nimport {Song} from \"../synth/synth\";\r\n\r\nexport interface RecoveredVersion {\r\n\tuid: string;\r\n\ttime: number;\r\n\twork: number;\r\n}\r\n\r\nexport interface RecoveredSong {\r\n\tversions: RecoveredVersion[];\r\n}\r\n\r\nconst versionPrefix = \"songVersion: \";\r\nconst maximumSongCount = 8;\r\nconst maximumWorkPerVersion = 3 * 60 * 1000; // 3 minutes\r\nconst minimumWorkPerSpan = 1 * 60 * 1000; // 1 minute\r\n\r\nfunction keyIsVersion(key: string): boolean {\r\n\treturn key.indexOf(versionPrefix) == 0;\r\n}\r\n\r\nfunction keyToVersion(key: string): RecoveredVersion {\r\n\treturn JSON.parse(key.substring(versionPrefix.length));\r\n}\r\n\r\nexport function versionToKey(version: RecoveredVersion): string {\r\n\treturn versionPrefix + JSON.stringify(version);\r\n}\r\n\r\nexport function generateUid(): string {\r\n\t// Not especially robust, but simple and effective!\r\n\treturn ((Math.random() * (-1 >>> 0)) >>> 0).toString(32);\r\n}\r\n\r\nexport function errorAlert(error: any): void {\r\n\tconsole.warn(error);\r\n\twindow.alert(\"Whoops, the song data appears to have been corrupted! Please try to recover the last working version of the song from the \\\"Recover Recent Song...\\\" option in BeepBox's \\\"File\\\" menu.\");\r\n}\r\n\r\nfunction compareSongs(a: RecoveredSong, b: RecoveredSong): number {\r\n\treturn b.versions[0].time - a.versions[0].time;\r\n}\r\n\r\nfunction compareVersions(a: RecoveredVersion, b: RecoveredVersion): number {\r\n\treturn b.time - a.time;\r\n}\r\n\t\r\nexport class SongRecovery {\r\n\tprivate _saveVersionTimeoutHandle: ReturnType<typeof setTimeout>;\r\n\t\r\n\tprivate _song: Song = new Song();\r\n\t\r\n\tpublic static getAllRecoveredSongs(): RecoveredSong[] {\r\n\t\tconst songs: RecoveredSong[] = [];\r\n\t\tconst songsByUid: Dictionary<RecoveredSong> = {};\r\n\t\tfor (let i = 0; i < localStorage.length; i++) {\r\n\t\t\tconst itemKey: string = localStorage.key(i)!;\r\n\t\t\tif (keyIsVersion(itemKey)) {\r\n\t\t\t\tconst version: RecoveredVersion = keyToVersion(itemKey);\r\n\t\t\t\tlet song: RecoveredSong | undefined = songsByUid[version.uid];\r\n\t\t\t\tif (song == undefined) {\r\n\t\t\t\t\tsong = {versions: []};\r\n\t\t\t\t\tsongsByUid[version.uid] = song;\r\n\t\t\t\t\tsongs.push(song);\r\n\t\t\t\t}\r\n\t\t\t\tsong.versions.push(version);\r\n\t\t\t}\r\n\t\t}\r\n\t\tfor (const song of songs) {\r\n\t\t\tsong.versions.sort(compareVersions);\r\n\t\t}\r\n\t\tsongs.sort(compareSongs);\r\n\t\treturn songs;\r\n\t}\r\n\t\r\n\tpublic saveVersion(uid: string, songData: string): void {\r\n\t\tconst newTime: number = Math.round(Date.now());\r\n\t\t\r\n\t\tclearTimeout(this._saveVersionTimeoutHandle);\r\n\t\tthis._saveVersionTimeoutHandle = setTimeout((): void => {\r\n\t\t\ttry {\r\n\t\t\t\t// Ensure that the song is not corrupted.\r\n\t\t\t\tthis._song.fromBase64String(songData);\r\n\t\t\t} catch (error) {\r\n\t\t\t\terrorAlert(error);\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tconst songs: RecoveredSong[] = SongRecovery.getAllRecoveredSongs();\r\n\t\t\tlet currentSong: RecoveredSong | null = null;\r\n\t\t\tfor (const song of songs) {\r\n\t\t\t\tif (song.versions[0].uid == uid) {\r\n\t\t\t\t\tcurrentSong = song;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tif (currentSong == null) {\r\n\t\t\t\tcurrentSong = {versions: []};\r\n\t\t\t\tsongs.unshift(currentSong);\r\n\t\t\t}\r\n\t\t\tlet versions: RecoveredVersion[] = currentSong.versions;\r\n\t\t\t\r\n\t\t\tlet newWork: number = 1000; // default to 1 second of work for the first change.\r\n\t\t\tif (versions.length > 0) {\r\n\t\t\t\tconst mostRecentTime: number = versions[0].time;\r\n\t\t\t\tconst mostRecentWork: number = versions[0].work;\r\n\t\t\t\tnewWork = mostRecentWork + Math.min(maximumWorkPerVersion, newTime - mostRecentTime);\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tconst newVersion: RecoveredVersion = {uid: uid, time: newTime, work: newWork};\r\n\t\t\tconst newKey: string = versionToKey(newVersion);\r\n\t\t\tversions.unshift(newVersion);\r\n\t\t\tlocalStorage.setItem(newKey, songData);\r\n\t\t\t\r\n\t\t\t// Consider deleting an old version to free up space.\r\n\t\t\tlet minSpan: number = minimumWorkPerSpan; // start out with a gap between versions.\r\n\t\t\tconst spanMult: number = Math.pow(2, 1 / 2); // Double the span every 2 versions back.\r\n\t\t\tfor (var i: number = 1; i < versions.length; i++) {\r\n\t\t\t\tconst currentWork: number = versions[i].work;\r\n\t\t\t\tconst olderWork: number = (i == versions.length - 1) ? 0.0 : versions[i + 1].work;\r\n\t\t\t\t// If not enough work happened between two versions, discard one of them.\r\n\t\t\t\tif (currentWork - olderWork < minSpan) {\r\n\t\t\t\t\tlet indexToDiscard: number = i;\r\n\t\t\t\t\tif (i < versions.length - 1) {\r\n\t\t\t\t\t\tconst currentTime: number = versions[i].time;\r\n\t\t\t\t\t\tconst newerTime: number = versions[i - 1].time;\r\n\t\t\t\t\t\tconst olderTime: number = versions[i + 1].time;\r\n\t\t\t\t\t\t// Weird heuristic: Between the three adjacent versions, prefer to keep\r\n\t\t\t\t\t\t// the newest and the oldest, discarding the middle one (i), unless\r\n\t\t\t\t\t\t// there is a large gap of time between the newest and middle one, in\r\n\t\t\t\t\t\t// which case the middle one represents the end of a span of work and is\r\n\t\t\t\t\t\t// thus more memorable.\r\n\t\t\t\t\t\tif ((currentTime - olderTime) < 0.5 * (newerTime - currentTime)) {\r\n\t\t\t\t\t\t\tindexToDiscard = i + 1;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\tlocalStorage.removeItem(versionToKey(versions[indexToDiscard]));\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t\tminSpan *= spanMult;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t// If there are too many songs, discard the least important ones.\r\n\t\t\t// Songs that are older, or have less work, are less important.\r\n\t\t\twhile (songs.length > maximumSongCount) {\r\n\t\t\t\tlet leastImportantSong: RecoveredSong | null = null;\r\n\t\t\t\tlet leastImportance: number = Number.POSITIVE_INFINITY;\r\n\t\t\t\tfor (let i: number = Math.round(maximumSongCount / 2); i < songs.length; i++) {\r\n\t\t\t\t\tconst song: RecoveredSong = songs[i];\r\n\t\t\t\t\tconst timePassed: number = newTime - song.versions[0].time;\r\n\t\t\t\t\t// Convert the time into a factor of 12 hours, add one, then divide by the result.\r\n\t\t\t\t\t// This creates a curve that starts at 1, and then gradually drops off.\r\n\t\t\t\t\tconst timeScale: number = 1.0 / ((timePassed / (12 * 60 * 60 * 1000)) + 1.0);\r\n\t\t\t\t\t// Add 5 minutes of work, to balance out simple songs a little bit.\r\n\t\t\t\t\tconst adjustedWork: number = song.versions[0].work + 5 * 60 * 1000;\r\n\t\t\t\t\tconst weight: number = adjustedWork * timeScale;\r\n\t\t\t\t\tif (leastImportance > weight) {\r\n\t\t\t\t\t\tleastImportance = weight;\r\n\t\t\t\t\t\tleastImportantSong = song;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tfor (const version of leastImportantSong!.versions) {\r\n\t\t\t\t\tlocalStorage.removeItem(versionToKey(version));\r\n\t\t\t\t}\r\n\t\t\t\tsongs.splice(songs.indexOf(leastImportantSong!), 1);\r\n\t\t\t}\r\n\t\t}, 750); // Wait 3/4 of a second before saving a version.\r\n\t}\r\n}\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nimport {SongDocument} from \"./SongDocument\";\r\nimport {RecoveredSong, RecoveredVersion, SongRecovery, versionToKey} from \"./SongRecovery\";\r\nimport {Prompt} from \"./Prompt\";\r\nimport {HTML} from \"imperative-html/dist/esm/elements-strict\";\r\n\r\nconst {button, div, h2, p, select, option, iframe} = HTML;\r\n\r\nexport class SongRecoveryPrompt implements Prompt {\r\n\tprivate readonly _songContainer: HTMLDivElement = div();\r\n\tprivate readonly _cancelButton: HTMLButtonElement = button({class: \"cancelButton\"});\r\n\t\r\n\tpublic readonly container: HTMLDivElement = div({class: \"prompt\", style: \"width: 300px;\"},\r\n\t\th2(\"Song Recovery\"),\r\n\t\tdiv({style: \"max-height: 385px; overflow-y: auto;\"},\r\n\t\t\tp(\"This is a TEMPORARY list of songs you have recently modified. Please keep your own backups of songs you care about!\"),\r\n\t\t\tthis._songContainer,\r\n\t\t\tp(\"(If \\\"Display Song Data in URL\\\" is enabled in your preferences, then you may also be able to find song versions in your browser history. However, song recovery won't work if you were browsing in private/incognito mode.)\"),\r\n\t\t),\r\n\t\tthis._cancelButton,\r\n\t);\r\n\t\r\n\tconstructor(private _doc: SongDocument) {\r\n\t\tthis._cancelButton.addEventListener(\"click\", this._close);\r\n\t\t\r\n\t\tconst songs: RecoveredSong[] = SongRecovery.getAllRecoveredSongs();\r\n\t\t\r\n\t\tif (songs.length == 0) {\r\n\t\t\tthis._songContainer.appendChild(p(\"There are no recovered songs available yet. Try making a song!\"));\r\n\t\t}\r\n\t\t\r\n\t\tfor (const song of songs) {\r\n\t\t\tconst versionMenu: HTMLSelectElement = select({style: \"width: 100%;\"});\r\n\t\t\t\r\n\t\t\tfor (const version of song.versions) {\r\n\t\t\t\tversionMenu.appendChild(option({value: version.time}, new Date(version.time).toLocaleString()));\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tconst player: HTMLIFrameElement = iframe({style: \"width: 100%; height: 60px; border: none; display: block;\"});\r\n\t\t\tplayer.src = \"player/#song=\" + window.localStorage.getItem(versionToKey(song.versions[0]));\r\n\t\t\tconst container: HTMLDivElement = div({style: \"margin: 4px 0;\"}, div({class: \"selectContainer\", style: \"width: 100%; margin: 2px 0;\"}, versionMenu), player);\r\n\t\t\tthis._songContainer.appendChild(container);\r\n\t\t\t\r\n\t\t\tversionMenu.addEventListener(\"change\", () => {\r\n\t\t\t\tconst version: RecoveredVersion = song.versions[versionMenu.selectedIndex];\r\n\t\t\t\tplayer.contentWindow!.location.replace(\"player/#song=\" + window.localStorage.getItem(versionToKey(version)));\r\n\t\t\t\tplayer.contentWindow!.dispatchEvent(new Event(\"hashchange\"));\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\t\r\n\tprivate _close = (): void => { \r\n\t\tthis._doc.undo();\r\n\t}\r\n\t\r\n\tpublic cleanUp = (): void => { \r\n\t\tthis._cancelButton.removeEventListener(\"click\", this._close);\r\n\t}\r\n}\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nimport {Config} from \"../synth/SynthConfig\";\r\nimport {EditorConfig} from \"./EditorConfig\";\r\nimport {SongDocument} from \"./SongDocument\";\r\nimport {Prompt} from \"./Prompt\";\r\nimport {HTML} from \"imperative-html/dist/esm/elements-strict\";\r\nimport {ColorConfig} from \"./ColorConfig\";\r\nimport {KeyboardLayout} from \"./KeyboardLayout\";\r\nimport {Piano} from \"./Piano\";\r\n\r\nconst {button, label, div, p, a, h2, input, select, option} = HTML;\r\n\r\nexport class RecordingSetupPrompt implements Prompt {\r\n\tprivate readonly _keyboardMode: HTMLSelectElement = select({style: \"width: 100%;\"},\r\n\t\toption({value: \"useCapsLockForNotes\"}, \"simple shortcuts, use caps lock to play notes\"),\r\n\t\toption({value: \"pressControlForShortcuts\"}, \"simple notes, press \" + EditorConfig.ctrlName + \" for shortcuts\"),\r\n\t);\r\n\tprivate readonly _keyboardLayout: HTMLSelectElement = select({style: \"width: 100%;\"},\r\n\t\toption({value: \"wickiHayden\"}, \"Wicki-Hayden\"),\r\n\t\toption({value: \"songScale\"}, \"selected song scale\"),\r\n\t\toption({value: \"pianoAtC\"}, \"piano starting at C :)\"),\r\n\t\toption({value: \"pianoAtA\"}, \"piano starting at A :(\"),\r\n\t\toption({value: \"pianoTransposingC\"}, \"piano transposing C :) to song key\"),\r\n\t\toption({value: \"pianoTransposingA\"}, \"piano transposing A :( to song key\"),\r\n\t);\r\n\tprivate readonly _keyboardLayoutPreview: HTMLDivElement = div({style: \"display: grid; row-gap: 4px; margin: 4px auto; font-size: 10px;\"});\r\n\tprivate readonly _enableMidi: HTMLInputElement = input({style: \"width: 2em; margin-left: 1em;\", type: \"checkbox\"});\r\n\tprivate readonly _showRecordButton: HTMLInputElement = input({style: \"width: 2em; margin-left: 1em;\", type: \"checkbox\"});\r\n\tprivate readonly _snapRecordedNotesToRhythm: HTMLInputElement = input({style: \"width: 2em; margin-left: 1em;\", type: \"checkbox\"});\r\n\tprivate readonly _ignorePerformedNotesNotInScale: HTMLInputElement = input({style: \"width: 2em; margin-left: 1em;\", type: \"checkbox\"});\r\n\tprivate readonly _metronomeCountIn: HTMLInputElement = input({style: \"width: 2em; margin-left: 1em;\", type: \"checkbox\"});\r\n\tprivate readonly _metronomeWhileRecording: HTMLInputElement = input({style: \"width: 2em; margin-left: 1em;\", type: \"checkbox\"});\r\n\t\r\n\tprivate readonly _okayButton: HTMLButtonElement = button({class: \"okayButton\", style: \"width:45%;\"}, \"Okay\");\r\n\tprivate readonly _cancelButton: HTMLButtonElement = button({class: \"cancelButton\"});\r\n\tpublic readonly container: HTMLDivElement = div({class: \"prompt noSelection recordingSetupPrompt\", style: \"width: 333px; text-align: right; max-height: 90%;\"},\r\n\t\th2(\"Note Recording Setup\"),\r\n\t\tdiv({style: \"display: grid; overflow-y: auto; overflow-x: hidden; flex-shrink: 1;\"},\r\n\t\t\tp(\"BeepBox can record notes as you perform them. You can start recording by pressing Ctrl+Space (or \" + EditorConfig.ctrlSymbol + \"P).\"),\r\n\t\t\tlabel({style: \"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;\"},\r\n\t\t\t\t\"Add  record button next to  play button:\",\r\n\t\t\t\tthis._showRecordButton,\r\n\t\t\t),\r\n\t\t\tlabel({style: \"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;\"},\r\n\t\t\t\t\"Snap recorded notes to the song's rhythm:\",\r\n\t\t\t\tthis._snapRecordedNotesToRhythm,\r\n\t\t\t),\r\n\t\t\tlabel({style: \"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;\"},\r\n\t\t\t\t\"Ignore notes not in the song's scale:\",\r\n\t\t\t\tthis._ignorePerformedNotesNotInScale,\r\n\t\t\t),\r\n\t\t\tp(\"While recording, you can perform notes on your keyboard!\"),\r\n\t\t\tlabel({style: \"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;\"},\r\n\t\t\t\t\"Keyboard layout:\",\r\n\t\t\t\tdiv({class: \"selectContainer\", style: \"width: 65%; margin-left: 1em;\"}, this._keyboardLayout),\r\n\t\t\t),\r\n\t\t\tthis._keyboardLayoutPreview,\r\n\t\t\tp(\"When not recording, you can use the computer keyboard either for shortcuts (like C and V for copy and paste) or for performing notes, depending on this mode:\"),\r\n\t\t\tlabel({style: \"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;\"},\r\n\t\t\t\tdiv({class: \"selectContainer\", style: \"width: 100%;\"}, this._keyboardMode),\r\n\t\t\t),\r\n\t\t\tp(\"Performing music takes practice! Try slowing the tempo and using this metronome to help you keep a rhythm.\"),\r\n\t\t\tlabel({style: \"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;\"},\r\n\t\t\t\t\"Hear metronome while recording:\",\r\n\t\t\t\tthis._metronomeWhileRecording,\r\n\t\t\t),\r\n\t\t\tlabel({style: \"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;\"},\r\n\t\t\t\t\"Count-in 1 bar of metronome before recording:\",\r\n\t\t\t\tthis._metronomeCountIn,\r\n\t\t\t),\r\n\t\t\tp(\"If you have a \", a({href: \"https://caniuse.com/midi\", target: \"_blank\"}, \"compatible browser\"), \" on a device connected to a MIDI keyboard, you can use it to perform notes in BeepBox! (Or you could buy \", a({href: \"https://imitone.com/\", target: \"_blank\"}, \"Imitone\"), \" or \", a({href: \"https://vochlea.com/\", target: \"_blank\"}, \"Dubler\"), \" to hum notes into a microphone while wearing headphones!)\"),\r\n\t\t\tlabel({style: \"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;\"},\r\n\t\t\t\t\"Enable MIDI performance:\",\r\n\t\t\t\tthis._enableMidi,\r\n\t\t\t),\r\n\t\t\tp(\"The range of pitches available to play via your computer keyboard is affected by the octave scrollbar of the currently selected channel.\"),\r\n\t\t\tp(\"Recorded notes often overlap such that one note ends after the next note already started. In BeepBox, these notes get split into multiple notes which may sound different when re-played than they did when you were recording. To fix the sound, you can either manually clean up the notes in the pattern editor, or you could try enabling the \\\"transition type\\\" effect on the instrument and setting it to \\\"continue\\\".\"),\r\n\t\t\tdiv({style: `width: 100%; height: 80px; background: linear-gradient(rgba(0,0,0,0), ${ColorConfig.editorBackground}); position: sticky; bottom: 0; pointer-events: none;`}),\r\n\t\t),\r\n\t\tdiv({style: \"display: flex; flex-direction: row-reverse; justify-content: space-between;\"},\r\n\t\t\tthis._okayButton,\r\n\t\t),\r\n\t\tthis._cancelButton,\r\n\t);\r\n\t\r\n\tconstructor(private _doc: SongDocument) {\r\n\t\tthis._keyboardMode.value = this._doc.prefs.pressControlForShortcuts ? \"pressControlForShortcuts\" : \"useCapsLockForNotes\";\r\n\t\tthis._keyboardLayout.value = this._doc.prefs.keyboardLayout;\r\n\t\tthis._enableMidi.checked = this._doc.prefs.enableMidi;\r\n\t\tthis._showRecordButton.checked = this._doc.prefs.showRecordButton;\r\n\t\tthis._snapRecordedNotesToRhythm.checked = this._doc.prefs.snapRecordedNotesToRhythm;\r\n\t\tthis._ignorePerformedNotesNotInScale.checked = this._doc.prefs.ignorePerformedNotesNotInScale;\r\n\t\tthis._metronomeCountIn.checked = this._doc.prefs.metronomeCountIn;\r\n\t\tthis._metronomeWhileRecording.checked = this._doc.prefs.metronomeWhileRecording;\r\n\t\t\r\n\t\tsetTimeout(()=>this._showRecordButton.focus());\r\n\t\t\r\n\t\tthis._okayButton.addEventListener(\"click\", this._confirm);\r\n\t\tthis._cancelButton.addEventListener(\"click\", this._close);\r\n\t\tthis.container.addEventListener(\"keydown\", this._whenKeyPressed);\r\n\t\t\r\n\t\tthis._renderKeyboardLayoutPreview();\r\n\t\tthis._keyboardLayout.addEventListener(\"change\", this._renderKeyboardLayoutPreview);\r\n\t}\r\n\t\r\n\tprivate _close = (): void => { \r\n\t\tthis._doc.undo();\r\n\t}\r\n\t\r\n\tpublic cleanUp = (): void => { \r\n\t\tthis._okayButton.removeEventListener(\"click\", this._confirm);\r\n\t\tthis._cancelButton.removeEventListener(\"click\", this._close);\r\n\t\tthis.container.removeEventListener(\"keydown\", this._whenKeyPressed);\r\n\t}\r\n\t\r\n\tprivate _whenKeyPressed = (event: KeyboardEvent): void => {\r\n\t\tif ((<Element> event.target).tagName != \"BUTTON\" && event.keyCode == 13) { // Enter key\r\n\t\t\tthis._confirm();\r\n\t\t}\r\n\t}\r\n\t\r\n\tprivate _confirm = (): void => { \r\n\t\tthis._doc.prefs.pressControlForShortcuts = (this._keyboardMode.value == \"pressControlForShortcuts\");\r\n\t\tthis._doc.prefs.keyboardLayout = this._keyboardLayout.value;\r\n\t\tthis._doc.prefs.enableMidi = this._enableMidi.checked;\r\n\t\tthis._doc.prefs.showRecordButton = this._showRecordButton.checked;\r\n\t\tthis._doc.prefs.snapRecordedNotesToRhythm = this._snapRecordedNotesToRhythm.checked;\r\n\t\tthis._doc.prefs.ignorePerformedNotesNotInScale = this._ignorePerformedNotesNotInScale.checked;\r\n\t\tthis._doc.prefs.metronomeCountIn = this._metronomeCountIn.checked;\r\n\t\tthis._doc.prefs.metronomeWhileRecording = this._metronomeWhileRecording.checked;\r\n\t\tthis._doc.prefs.save();\r\n\t\tthis._close();\r\n\t}\r\n\t\r\n\tprivate _renderKeyboardLayoutPreview = (): void => {\r\n\t\twhile (this._keyboardLayoutPreview.firstChild) {\r\n\t\t\tthis._keyboardLayoutPreview.removeChild(this._keyboardLayoutPreview.firstChild);\r\n\t\t}\r\n\t\tconst rowLengths: number[] = [12, 12, 11, 10];\r\n\t\tconst scale: ReadonlyArray<boolean> = Config.scales[this._doc.song.scale].flags;\r\n\t\tfor (let rowIndex: number = 0; rowIndex < 4; rowIndex++) {\r\n\t\t\tconst row: HTMLDivElement = div({style: \"display: flex;\"});\r\n\t\t\tthis._keyboardLayoutPreview.appendChild(row);\r\n\t\t\tconst spacer: HTMLDivElement = div({style: \"width: \" + (rowIndex * 12) + \"px; height: 20px; flex-shrink: 0;\"});\r\n\t\t\trow.appendChild(spacer);\r\n\t\t\tfor (let colIndex: number = 0; colIndex < rowLengths[rowIndex]; colIndex++) {\r\n\t\t\t\tconst key: HTMLDivElement = div({style: `width: 20px; height: 20px; margin: 0 2px; box-sizing: border-box; flex-shrink: 0; display: flex; justify-content: center; align-items: center;`});\r\n\t\t\t\trow.appendChild(key);\r\n\t\t\t\tconst pitch: number | null = KeyboardLayout.keyPosToPitch(this._doc, colIndex, 3 - rowIndex, this._keyboardLayout.value);\r\n\t\t\t\tif (pitch != null) {\r\n\t\t\t\t\tconst scalePitch: number = pitch % 12;\r\n\t\t\t\t\tif (scale[scalePitch]) {\r\n\t\t\t\t\t\tif (scalePitch == 0) {\r\n\t\t\t\t\t\t\tkey.style.background = ColorConfig.tonic;\r\n\t\t\t\t\t\t} else if (scalePitch == 7 && this._doc.prefs.showFifth) {\r\n\t\t\t\t\t\t\tkey.style.background = ColorConfig.fifthNote;\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\tkey.style.background = ColorConfig.pitchBackground;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tkey.style.border = \"2px solid \" + ColorConfig.pitchBackground;\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t\tconst pitchNameIndex: number = (scalePitch + Config.keys[this._doc.song.key].basePitch) % Config.pitchesPerOctave;\r\n\t\t\t\t\tkey.textContent = Piano.getPitchName(pitchNameIndex, scalePitch);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nimport {InstrumentType, EffectType, Config, getPulseWidthRatio, effectsIncludeTransition, effectsIncludeChord, effectsIncludePitchShift, effectsIncludeDetune, effectsIncludeVibrato, effectsIncludeNoteFilter, effectsIncludeDistortion, effectsIncludeBitcrusher, effectsIncludePanning, effectsIncludeChorus, effectsIncludeEcho, effectsIncludeReverb} from \"../synth/SynthConfig\";\r\nimport {Preset, PresetCategory, EditorConfig, isMobile, prettyNumber} from \"./EditorConfig\";\r\nimport {ColorConfig, ChannelColors} from \"./ColorConfig\";\r\nimport \"./Layout\"; // Imported here for the sake of ensuring this code is transpiled early.\r\nimport {ThemePrompt} from \"./ThemePrompt\";\r\nimport {Instrument, Channel, Synth} from \"../synth/synth\";\r\nimport {HTML} from \"imperative-html/dist/esm/elements-strict\";\r\nimport {Preferences} from \"./Preferences\";\r\nimport {SongDocument} from \"./SongDocument\";\r\nimport {Prompt} from \"./Prompt\";\r\nimport {TipPrompt} from \"./TipPrompt\";\r\nimport {PatternEditor} from \"./PatternEditor\";\r\nimport {EnvelopeEditor} from \"./EnvelopeEditor\";\r\nimport {FadeInOutEditor} from \"./FadeInOutEditor\";\r\nimport {FilterEditor} from \"./FilterEditor\";\r\nimport {MuteEditor} from \"./MuteEditor\";\r\nimport {TrackEditor} from \"./TrackEditor\";\r\nimport {ChannelRow} from \"./ChannelRow\";\r\nimport {LayoutPrompt} from \"./LayoutPrompt\";\r\nimport {LoopEditor} from \"./LoopEditor\";\r\nimport {SpectrumEditor} from \"./SpectrumEditor\";\r\nimport {HarmonicsEditor} from \"./HarmonicsEditor\";\r\nimport {BarScrollBar} from \"./BarScrollBar\";\r\nimport {OctaveScrollBar} from \"./OctaveScrollBar\";\r\nimport {MidiInputHandler} from \"./MidiInput\";\r\nimport {KeyboardLayout} from \"./KeyboardLayout\";\r\nimport {Piano} from \"./Piano\";\r\nimport {BeatsPerBarPrompt} from \"./BeatsPerBarPrompt\";\r\nimport {MoveNotesSidewaysPrompt} from \"./MoveNotesSidewaysPrompt\";\r\nimport {SongDurationPrompt} from \"./SongDurationPrompt\";\r\nimport {SustainPrompt} from \"./SustainPrompt\";\r\nimport {ChannelSettingsPrompt} from \"./ChannelSettingsPrompt\";\r\nimport {ExportPrompt} from \"./ExportPrompt\";\r\nimport {ImportPrompt} from \"./ImportPrompt\";\r\nimport {SongRecoveryPrompt} from \"./SongRecoveryPrompt\";\r\nimport {RecordingSetupPrompt} from \"./RecordingSetupPrompt\";\r\nimport {Change} from \"./Change\";\r\nimport {ChangeTempo, ChangeChorus, ChangeEchoDelay, ChangeEchoSustain, ChangeReverb, ChangeVolume, ChangePan, ChangePatternSelection, ChangeSupersawDynamism, ChangeSupersawSpread, ChangeSupersawShape, ChangePulseWidth, ChangeFeedbackAmplitude, ChangeOperatorAmplitude, ChangeOperatorFrequency, ChangeDrumsetEnvelope, ChangePasteInstrument, ChangePreset, pickRandomPresetValue, ChangeRandomGeneratedInstrument, ChangeScale, ChangeDetectKey, ChangeKey, ChangeRhythm, ChangeFeedbackType, ChangeAlgorithm, ChangeCustomizeInstrument, ChangeChipWave, ChangeNoiseWave, ChangeTransition, ChangeToggleEffects, ChangeVibrato, ChangeUnison, ChangeChord, ChangeSong, ChangePitchShift, ChangeDetune, ChangeDistortion, ChangeStringSustain, ChangeBitcrusherFreq, ChangeBitcrusherQuantization, ChangeAddEnvelope, ChangeAddChannelInstrument, ChangeRemoveChannelInstrument} from \"./changes\";\r\n\r\nconst {a, button, div, input, select, span, optgroup, option} = HTML;\r\n\r\nfunction buildOptions(menu: HTMLSelectElement, items: ReadonlyArray<string | number>): HTMLSelectElement {\r\n\tfor (let index: number = 0; index < items.length; index++) {\r\n\t\tmenu.appendChild(option({value: index}, items[index]));\r\n\t} \r\n\treturn menu;\r\n}\r\n\r\nfunction buildPresetOptions(isNoise: boolean): HTMLSelectElement {\r\n\tconst menu: HTMLSelectElement = select();\r\n\t\r\n\tmenu.appendChild(optgroup({label: \"Edit\"},\r\n\t\toption({value: \"copyInstrument\"}, \"Copy Instrument (C)\"),\r\n\t\toption({value: \"pasteInstrument\"}, \"Paste Instrument (V)\"),\r\n\t\toption({value: \"randomPreset\"}, \"Random Preset (R)\"),\r\n\t\toption({value: \"randomGenerated\"}, \"Random Generated (R)\"),\r\n\t));\r\n\t\r\n\t// Show the \"spectrum\" custom type in both pitched and noise channels.\r\n\tconst customTypeGroup: HTMLElement = optgroup({label: EditorConfig.presetCategories[0].name});\r\n\tif (isNoise) {\r\n\t\tcustomTypeGroup.appendChild(option({value: InstrumentType.noise}, EditorConfig.valueToPreset(InstrumentType.noise)!.name));\r\n\t\tcustomTypeGroup.appendChild(option({value: InstrumentType.spectrum}, EditorConfig.valueToPreset(InstrumentType.spectrum)!.name));\r\n\t\tcustomTypeGroup.appendChild(option({value: InstrumentType.drumset}, EditorConfig.valueToPreset(InstrumentType.drumset)!.name));\r\n\t} else {\r\n\t\tcustomTypeGroup.appendChild(option({value: InstrumentType.chip}, EditorConfig.valueToPreset(InstrumentType.chip)!.name));\r\n\t\tcustomTypeGroup.appendChild(option({value: InstrumentType.pwm}, EditorConfig.valueToPreset(InstrumentType.pwm)!.name));\r\n\t\tcustomTypeGroup.appendChild(option({value: InstrumentType.supersaw}, EditorConfig.valueToPreset(InstrumentType.supersaw)!.name));\r\n\t\tcustomTypeGroup.appendChild(option({value: InstrumentType.harmonics}, EditorConfig.valueToPreset(InstrumentType.harmonics)!.name));\r\n\t\tcustomTypeGroup.appendChild(option({value: InstrumentType.pickedString}, EditorConfig.valueToPreset(InstrumentType.pickedString)!.name));\r\n\t\tcustomTypeGroup.appendChild(option({value: InstrumentType.spectrum}, EditorConfig.valueToPreset(InstrumentType.spectrum)!.name));\r\n\t\tcustomTypeGroup.appendChild(option({value: InstrumentType.fm}, EditorConfig.valueToPreset(InstrumentType.fm)!.name));\r\n\t}\r\n\tmenu.appendChild(customTypeGroup);\r\n\t\r\n\tfor (let categoryIndex: number = 1; categoryIndex < EditorConfig.presetCategories.length; categoryIndex++) {\r\n\t\tconst category: PresetCategory = EditorConfig.presetCategories[categoryIndex];\r\n\t\tconst group: HTMLElement = optgroup({label: category.name});\r\n\t\tlet foundAny: boolean = false;\r\n\t\tfor (let presetIndex: number = 0; presetIndex < category.presets.length; presetIndex++) {\r\n\t\t\tconst preset: Preset = category.presets[presetIndex];\r\n\t\t\tif ((preset.isNoise == true) == isNoise) {\r\n\t\t\t\tgroup.appendChild(option({value: (categoryIndex << 6) + presetIndex}, preset.name));\r\n\t\t\t\tfoundAny = true;\r\n\t\t\t}\r\n\t\t}\r\n\t\tif (foundAny) menu.appendChild(group);\r\n\t}\r\n\treturn menu;\r\n}\r\n\r\nfunction setSelectedValue(menu: HTMLSelectElement, value: number): void {\r\n\tconst stringValue = value.toString();\r\n\tif (menu.value != stringValue) menu.value = stringValue;\r\n}\r\n\r\nclass Slider {\r\n\tprivate _change: Change | null = null;\r\n\tprivate _value: number = 0;\r\n\tprivate _oldValue: number = 0;\r\n\t\r\n\tconstructor(public readonly input: HTMLInputElement, private readonly _doc: SongDocument, private readonly _getChange: (oldValue: number, newValue: number)=>Change) {\r\n\t\tinput.addEventListener(\"input\", this._whenInput);\r\n\t\tinput.addEventListener(\"change\", this._whenChange);\r\n\t}\r\n\t\r\n\tpublic updateValue(value: number): void {\r\n\t\tthis._value = value;\r\n\t\tthis.input.value = String(value);\r\n\t}\r\n\t\r\n\tprivate _whenInput = (): void => {\r\n\t\tconst continuingProspectiveChange: boolean = this._doc.lastChangeWas(this._change);\r\n\t\tif (!continuingProspectiveChange) this._oldValue = this._value;\r\n\t\tthis._change = this._getChange(this._oldValue, parseInt(this.input.value));\r\n\t\tthis._doc.setProspectiveChange(this._change);\r\n\t};\r\n\t\r\n\tprivate _whenChange = (): void => {\r\n\t\tthis._doc.record(this._change!);\r\n\t\tthis._change = null;\r\n\t};\r\n}\r\n\r\nexport class SongEditor {\r\n\tpublic prompt: Prompt | null = null;\r\n\t\r\n\tprivate readonly _keyboardLayout: KeyboardLayout = new KeyboardLayout(this._doc);\r\n\tprivate readonly _patternEditorPrev: PatternEditor = new PatternEditor(this._doc, false, -1);\r\n\tprivate readonly _patternEditor: PatternEditor = new PatternEditor(this._doc, true, 0);\r\n\tprivate readonly _patternEditorNext: PatternEditor = new PatternEditor(this._doc, false, 1);\r\n\tprivate readonly _muteEditor: MuteEditor = new MuteEditor(this._doc);\r\n\tprivate readonly _trackEditor: TrackEditor = new TrackEditor(this._doc);\r\n\tprivate readonly _loopEditor: LoopEditor = new LoopEditor(this._doc);\r\n\tprivate readonly _octaveScrollBar: OctaveScrollBar = new OctaveScrollBar(this._doc);\r\n\tprivate readonly _piano: Piano = new Piano(this._doc);\r\n\tprivate readonly _playButton: HTMLButtonElement = button({class: \"playButton\", type: \"button\", title: \"Play (Space)\"}, span(\"Play\"));\r\n\tprivate readonly _pauseButton: HTMLButtonElement = button({class: \"pauseButton\", style: \"display: none;\", type: \"button\", title: \"Pause (Space)\"}, \"Pause\");\r\n\tprivate readonly _recordButton: HTMLButtonElement = button({class: \"recordButton\", style: \"display: none;\", type: \"button\", title: \"Record (Ctrl+Space)\"}, span(\"Record\"));\r\n\tprivate readonly _stopButton: HTMLButtonElement = button({class: \"stopButton\", style: \"display: none;\", type: \"button\", title: \"Stop Recording (Space)\"}, \"Stop Recording\");\r\n\tprivate readonly _prevBarButton: HTMLButtonElement = button({class: \"prevBarButton\", type: \"button\", title: \"Previous Bar (left bracket)\"});\r\n\tprivate readonly _nextBarButton: HTMLButtonElement = button({class: \"nextBarButton\", type: \"button\", title: \"Next Bar (right bracket)\"});\r\n\tprivate readonly _volumeSlider: HTMLInputElement = input({title: \"main volume\", style: \"width: 5em; flex-grow: 1; margin: 0;\", type: \"range\", min: \"0\", max: \"75\", value: \"50\", step: \"1\"});\r\n\tprivate readonly _fileMenu: HTMLSelectElement = select({style: \"width: 100%;\"},\r\n\t\toption({selected: true, disabled: true, hidden: false}, \"File\"), // todo: \"hidden\" should be true but looks wrong on mac chrome, adds checkmark next to first visible option even though it's not selected. :(\r\n\t\toption({value: \"new\"}, \"+ New Blank Song\"),\r\n\t\toption({value: \"import\"}, \" Import Song... (\" + EditorConfig.ctrlSymbol + \"O)\"),\r\n\t\toption({value: \"export\"}, \" Export Song... (\" + EditorConfig.ctrlSymbol + \"S)\"),\r\n\t\toption({value: \"copyUrl\"}, \" Copy Song URL\"),\r\n\t\toption({value: \"shareUrl\"}, \" Share Song URL\"),\r\n\t\toption({value: \"shortenUrl\"}, \" Shorten Song URL\"),\r\n\t\toption({value: \"viewPlayer\"}, \" View in Song Player\"),\r\n\t\toption({value: \"copyEmbed\"}, \" Copy HTML Embed Code\"),\r\n\t\toption({value: \"songRecovery\"}, \" Recover Recent Song...\"),\r\n\t);\r\n\tprivate readonly _editMenu: HTMLSelectElement = select({style: \"width: 100%;\"},\r\n\t\toption({selected: true, disabled: true, hidden: false}, \"Edit\"), // todo: \"hidden\" should be true but looks wrong on mac chrome, adds checkmark next to first visible option even though it's not selected. :(\r\n\t\toption({value: \"undo\"}, \"Undo (Z)\"),\r\n\t\toption({value: \"redo\"}, \"Redo (Y)\"),\r\n\t\toption({value: \"copy\"}, \"Copy Pattern (C)\"),\r\n\t\toption({value: \"pasteNotes\"}, \"Paste Pattern Notes (V)\"),\r\n\t\toption({value: \"pasteNumbers\"}, \"Paste Pattern Numbers (\" + EditorConfig.ctrlSymbol + \"V)\"),\r\n\t\toption({value: \"insertBars\"}, \"Insert Bar ()\"),\r\n\t\toption({value: \"deleteBars\"}, \"Delete Selected Bars ()\"),\r\n\t\toption({value: \"insertChannel\"}, \"Insert Channel (\" + EditorConfig.ctrlSymbol + \")\"),\r\n\t\toption({value: \"deleteChannel\"}, \"Delete Selected Channels (\" + EditorConfig.ctrlSymbol + \")\"),\r\n\t\toption({value: \"selectAll\"}, \"Select All (A)\"),\r\n\t\toption({value: \"selectChannel\"}, \"Select Channel (A)\"),\r\n\t\toption({value: \"duplicatePatterns\"}, \"Duplicate Reused Patterns (D)\"),\r\n\t\toption({value: \"transposeUp\"}, \"Move Notes Up (+ or +)\"),\r\n\t\toption({value: \"transposeDown\"}, \"Move Notes Down (- or -)\"),\r\n\t\toption({value: \"moveNotesSideways\"}, \"Move All Notes Sideways...\"),\r\n\t\toption({value: \"beatsPerBar\"}, \"Change Beats Per Bar...\"),\r\n\t\toption({value: \"barCount\"}, \"Change Song Length...\"),\r\n\t\toption({value: \"channelSettings\"}, \"Channel Settings... (Q)\"),\r\n\t);\r\n\tprivate readonly _optionsMenu: HTMLSelectElement = select({style: \"width: 100%;\"},\r\n\t\toption({selected: true, disabled: true, hidden: false}, \"Preferences\"), // todo: \"hidden\" should be true but looks wrong on mac chrome, adds checkmark next to first visible option even though it's not selected. :(\r\n\t\toption({value: \"autoPlay\"}, \"Auto Play on Load\"),\r\n\t\toption({value: \"autoFollow\"}, \"Show And Play The Same Bar\"),\r\n\t\toption({value: \"enableNotePreview\"}, \"Hear Preview of Added Notes\"),\r\n\t\toption({value: \"showLetters\"}, \"Show Piano Keys\"),\r\n\t\toption({value: \"showFifth\"}, 'Highlight \"Fifth\" of Song Key'),\r\n\t\toption({value: \"notesOutsideScale\"}, \"Allow Adding Notes Not in Scale\"),\r\n\t\toption({value: \"setDefaultScale\"}, \"Use Current Scale as Default\"),\r\n\t\toption({value: \"showChannels\"}, \"Show Notes From All Channels\"),\r\n\t\toption({value: \"showScrollBar\"}, \"Show Octave Scroll Bar\"),\r\n\t\toption({value: \"alwaysShowSettings\"}, \"Customize All Instruments\"),\r\n\t\toption({value: \"instrumentCopyPaste\"}, \"Instrument Copy/Paste Buttons\"),\r\n\t\toption({value: \"enableChannelMuting\"}, \"Enable Channel Muting\"),\r\n\t\toption({value: \"displayBrowserUrl\"}, \"Display Song Data in URL\"),\r\n\t\toption({value: \"layout\"}, \"Choose Layout...\"),\r\n\t\toption({value: \"colorTheme\"}, \"Choose Theme...\"),\r\n\t\toption({value: \"recordingSetup\"}, \"Set Up Note Recording...\"),\r\n\t);\r\n\tprivate readonly _scaleSelect: HTMLSelectElement = buildOptions(select(), Config.scales.map(scale=>scale.name));\r\n\tprivate readonly _keySelect: HTMLSelectElement = buildOptions(select(), Config.keys.map(key=>key.name).reverse());\r\n\tprivate readonly _tempoSlider: Slider = new Slider(input({style: \"margin: 0; width: 4em; flex-grow: 1; vertical-align: middle;\", type: \"range\", min: \"0\", max: \"14\", value: \"7\", step: \"1\"}), this._doc, (oldValue: number, newValue: number) => new ChangeTempo(this._doc, oldValue, Math.round(120.0 * Math.pow(2.0, (-4.0 + newValue) / 9.0))));\r\n\tprivate readonly _tempoStepper: HTMLInputElement = input({style: \"width: 3em; margin-left: 0.4em; vertical-align: middle;\", type: \"number\", step: \"1\"});\r\n\tprivate readonly _chorusSlider: Slider = new Slider(input({style: \"margin: 0;\", type: \"range\", min: \"0\", max: Config.chorusRange - 1, value: \"0\", step: \"1\"}), this._doc, (oldValue: number, newValue: number) => new ChangeChorus(this._doc, oldValue, newValue));\r\n\tprivate readonly _chorusRow: HTMLDivElement = div({class: \"selectRow\"}, span({class: \"tip\", onclick: ()=>this._openPrompt(\"chorus\")}, \"Chorus:\"), this._chorusSlider.input);\r\n\tprivate readonly _reverbSlider: Slider = new Slider(input({style: \"margin: 0;\", type: \"range\", min: \"0\", max: Config.reverbRange - 1, value: \"0\", step: \"1\"}), this._doc, (oldValue: number, newValue: number) => new ChangeReverb(this._doc, oldValue, newValue));\r\n\tprivate readonly _reverbRow: HTMLDivElement = div({class: \"selectRow\"}, span({class: \"tip\", onclick: ()=>this._openPrompt(\"reverb\")}, \"Reverb:\"), this._reverbSlider.input);\r\n\tprivate readonly _echoSustainSlider: Slider = new Slider(input({style: \"margin: 0;\", type: \"range\", min: \"0\", max: Config.echoSustainRange - 1, value: \"0\", step: \"1\"}), this._doc, (oldValue: number, newValue: number) => new ChangeEchoSustain(this._doc, oldValue, newValue));\r\n\tprivate readonly _echoSustainRow: HTMLDivElement = div({class: \"selectRow\"}, span({class: \"tip\", onclick: ()=>this._openPrompt(\"echoSustain\")}, \"Echo:\"), this._echoSustainSlider.input);\r\n\tprivate readonly _echoDelaySlider: Slider = new Slider(input({style: \"margin: 0;\", type: \"range\", min: \"0\", max: Config.echoDelayRange - 1, value: \"0\", step: \"1\"}), this._doc, (oldValue: number, newValue: number) => new ChangeEchoDelay(this._doc, oldValue, newValue));\r\n\tprivate readonly _echoDelayRow: HTMLDivElement = div({class: \"selectRow\"}, span({class: \"tip\", onclick: ()=>this._openPrompt(\"echoDelay\")}, \"Echo Delay:\"), this._echoDelaySlider.input);\r\n\tprivate readonly _rhythmSelect: HTMLSelectElement = buildOptions(select(), Config.rhythms.map(rhythm=>rhythm.name));\r\n\tprivate readonly _pitchedPresetSelect: HTMLSelectElement = buildPresetOptions(false);\r\n\tprivate readonly _drumPresetSelect: HTMLSelectElement = buildPresetOptions(true);\r\n\tprivate readonly _algorithmSelect: HTMLSelectElement = buildOptions(select(), Config.algorithms.map(algorithm=>algorithm.name));\r\n\tprivate readonly _algorithmSelectRow: HTMLDivElement = div({class: \"selectRow\"}, span({class: \"tip\", onclick: ()=>this._openPrompt(\"algorithm\")}, \"Algorithm:\"), div({class: \"selectContainer\"}, this._algorithmSelect));\r\n\tprivate readonly _instrumentButtons: HTMLButtonElement[] = [];\r\n\tprivate readonly _instrumentAddButton: HTMLButtonElement = button({type: \"button\", class: \"add-instrument last-button\"});\r\n\tprivate readonly _instrumentRemoveButton: HTMLButtonElement = button({type: \"button\", class: \"remove-instrument\"});\r\n\tprivate readonly _instrumentsButtonBar: HTMLDivElement = div({class: \"instrument-bar\"}, this._instrumentRemoveButton, this._instrumentAddButton);\r\n\tprivate readonly _instrumentsButtonRow: HTMLDivElement = div({class: \"selectRow\", style: \"display: none;\"}, span({class: \"tip\", onclick: ()=>this._openPrompt(\"instrumentIndex\")}, \"Instrument:\"), this._instrumentsButtonBar);\r\n\tprivate readonly _instrumentCopyButton: HTMLButtonElement = button({type: \"button\", class: \"copy-instrument\", title: \"Copy Instrument (C)\"}, \"Copy\");\r\n\tprivate readonly _instrumentPasteButton: HTMLButtonElement = button({type: \"button\", class: \"paste-instrument\", title: \"Paste Instrument (V)\"}, \"Paste\");\r\n\tprivate readonly _instrumentCopyPasteRow: HTMLDivElement = div({class: \"instrumentCopyPasteRow\", style: \"display: none;\"}, this._instrumentCopyButton, this._instrumentPasteButton);\r\n\tprivate readonly _instrumentVolumeSlider: Slider = new Slider(input({style: \"margin: 0;\", type: \"range\", min: -(Config.volumeRange - 1), max: \"0\", value: \"0\", step: \"1\"}), this._doc, (oldValue: number, newValue: number) => new ChangeVolume(this._doc, oldValue, -newValue));\r\n\tprivate readonly _instrumentVolumeSliderRow: HTMLDivElement = div({class: \"selectRow\"}, span({class: \"tip\", onclick: ()=>this._openPrompt(\"instrumentVolume\")}, \"Volume:\"), this._instrumentVolumeSlider.input);\r\n\tprivate readonly _panSlider: Slider = new Slider(input({style: \"margin: 0;\", type: \"range\", min: \"0\", max: Config.panMax, value: Config.panCenter, step: \"1\"}), this._doc, (oldValue: number, newValue: number) => new ChangePan(this._doc, oldValue, newValue));\r\n\tprivate readonly _panSliderRow: HTMLDivElement = div({class: \"selectRow\"}, span({class: \"tip\", onclick: ()=>this._openPrompt(\"pan\")}, \"Panning:\"), this._panSlider.input);\r\n\tprivate readonly _chipWaveSelect: HTMLSelectElement = buildOptions(select(), Config.chipWaves.map(wave=>wave.name));\r\n\tprivate readonly _chipNoiseSelect: HTMLSelectElement = buildOptions(select(), Config.chipNoises.map(wave=>wave.name));\r\n\tprivate readonly _chipWaveSelectRow: HTMLDivElement = div({class: \"selectRow\"}, span({class: \"tip\", onclick: ()=>this._openPrompt(\"chipWave\")}, \"Wave:\"), div({class: \"selectContainer\"}, this._chipWaveSelect));\r\n\tprivate readonly _chipNoiseSelectRow: HTMLDivElement = div({class: \"selectRow\"}, span({class: \"tip\", onclick: ()=>this._openPrompt(\"chipNoise\")}, \"Noise:\"), div({class: \"selectContainer\"}, this._chipNoiseSelect));\r\n\tprivate readonly _fadeInOutEditor: FadeInOutEditor = new FadeInOutEditor(this._doc);\r\n\tprivate readonly _fadeInOutRow: HTMLElement = div({class: \"selectRow\"}, span({class: \"tip\", onclick: ()=>this._openPrompt(\"fadeInOut\")}, \"Fade In/Out:\"), this._fadeInOutEditor.container);\r\n\tprivate readonly _transitionSelect: HTMLSelectElement = buildOptions(select(), Config.transitions.map(transition=>transition.name));\r\n\tprivate readonly _transitionRow: HTMLDivElement = div({class: \"selectRow\"}, span({class: \"tip\", onclick: ()=>this._openPrompt(\"transition\")}, \"Transition:\"), div({class: \"selectContainer\"}, this._transitionSelect));\r\n\tprivate readonly _effectsSelect: HTMLSelectElement = select(option({selected: true, disabled: true, hidden: false})); // todo: \"hidden\" should be true but looks wrong on mac chrome, adds checkmark next to first visible option even though it's not selected. :(\r\n\tprivate readonly _eqFilterEditor: FilterEditor = new FilterEditor(this._doc);\r\n\tprivate readonly _eqFilterRow: HTMLElement = div({class: \"selectRow\"}, span({class: \"tip\", onclick: ()=>this._openPrompt(\"eqFilter\")}, \"EQ Filter:\"), this._eqFilterEditor.container);\r\n\tprivate readonly _noteFilterEditor: FilterEditor = new FilterEditor(this._doc, true);\r\n\tprivate readonly _noteFilterRow: HTMLElement = div({class: \"selectRow\"}, span({class: \"tip\", onclick: ()=>this._openPrompt(\"noteFilter\")}, \"Note Filter:\"), this._noteFilterEditor.container);\r\n\tprivate readonly _supersawDynamismSlider: Slider = new Slider(input({style: \"margin: 0;\", type: \"range\", min: \"0\", max: Config.supersawDynamismMax, value: \"0\", step: \"1\"}), this._doc, (oldValue: number, newValue: number) => new ChangeSupersawDynamism(this._doc, oldValue, newValue));\r\n\tprivate readonly _supersawDynamismRow: HTMLDivElement = div({class: \"selectRow\"}, span({class: \"tip\", onclick: ()=>this._openPrompt(\"supersawDynamism\")}, \"Dynamism:\"), this._supersawDynamismSlider.input);\r\n\tprivate readonly _supersawSpreadSlider: Slider = new Slider(input({style: \"margin: 0;\", type: \"range\", min: \"0\", max: Config.supersawSpreadMax, value: \"0\", step: \"1\"}), this._doc, (oldValue: number, newValue: number) => new ChangeSupersawSpread(this._doc, oldValue, newValue));\r\n\tprivate readonly _supersawSpreadRow: HTMLDivElement = div({class: \"selectRow\"}, span({class: \"tip\", onclick: ()=>this._openPrompt(\"supersawSpread\")}, \"Spread:\"), this._supersawSpreadSlider.input);\r\n\tprivate readonly _supersawShapeSlider: Slider = new Slider(input({style: \"margin: 0;\", type: \"range\", min: \"0\", max: Config.supersawShapeMax, value: \"0\", step: \"1\"}), this._doc, (oldValue: number, newValue: number) => new ChangeSupersawShape(this._doc, oldValue, newValue));\r\n\tprivate readonly _supersawShapeRow: HTMLDivElement = div({class: \"selectRow\"}, span({class: \"tip\", onclick: ()=>this._openPrompt(\"supersawShape\")}, \"SawPulse:\"), this._supersawShapeSlider.input);\r\n\tprivate readonly _pulseWidthSlider: Slider = new Slider(input({style: \"margin: 0;\", type: \"range\", min: \"0\", max: Config.pulseWidthRange - 1, value: \"0\", step: \"1\"}), this._doc, (oldValue: number, newValue: number) => new ChangePulseWidth(this._doc, oldValue, newValue));\r\n\tprivate readonly _pulseWidthRow: HTMLDivElement = div({class: \"selectRow\"}, span({class: \"tip\", onclick: ()=>this._openPrompt(\"pulseWidth\")}, \"Pulse Width:\"), this._pulseWidthSlider.input);\r\n\tprivate readonly _pitchShiftSlider: Slider = new Slider(input({style: \"margin: 0;\", type: \"range\", min: \"0\", max: Config.pitchShiftRange - 1, value: \"0\", step: \"1\"}), this._doc, (oldValue: number, newValue: number) => new ChangePitchShift(this._doc, oldValue, newValue));\r\n\tprivate readonly _pitchShiftTonicMarkers: HTMLDivElement[] = [div({class: \"pitchShiftMarker\", style: {color: ColorConfig.tonic}}), div({class: \"pitchShiftMarker\", style: {color: ColorConfig.tonic, left: \"50%\"}}), div({class: \"pitchShiftMarker\", style: {color: ColorConfig.tonic, left: \"100%\"}})];\r\n\tprivate readonly _pitchShiftFifthMarkers: HTMLDivElement[] = [div({class: \"pitchShiftMarker\", style: {color: ColorConfig.fifthNote, left: (100*7/24)+\"%\"}}), div({class: \"pitchShiftMarker\", style: {color: ColorConfig.fifthNote, left: (100*19/24)+\"%\"}})];\r\n\tprivate readonly _pitchShiftMarkerContainer: HTMLDivElement = div({style: \"display: flex; position: relative;\"}, this._pitchShiftSlider.input, div({class: \"pitchShiftMarkerContainer\"}, this._pitchShiftTonicMarkers, this._pitchShiftFifthMarkers));\r\n\tprivate readonly _pitchShiftRow: HTMLDivElement = div({class: \"selectRow\"}, span({class: \"tip\", onclick: ()=>this._openPrompt(\"pitchShift\")}, \"Pitch Shift:\"), this._pitchShiftMarkerContainer);\r\n\tprivate readonly _detuneSlider: Slider = new Slider(input({style: \"margin: 0;\", type: \"range\", min: \"0\", max: Config.detuneMax, value: \"0\", step: \"1\"}), this._doc, (oldValue: number, newValue: number) => new ChangeDetune(this._doc, oldValue, newValue));\r\n\tprivate readonly _detuneRow: HTMLDivElement = div({class: \"selectRow\"}, span({class: \"tip\", onclick: ()=>this._openPrompt(\"detune\")}, \"Detune:\"), this._detuneSlider.input);\r\n\tprivate readonly _distortionSlider: Slider = new Slider(input({style: \"margin: 0;\", type: \"range\", min: \"0\", max: Config.distortionRange - 1, value: \"0\", step: \"1\"}), this._doc, (oldValue: number, newValue: number) => new ChangeDistortion(this._doc, oldValue, newValue));\r\n\tprivate readonly _distortionRow: HTMLDivElement = div({class: \"selectRow\"}, span({class: \"tip\", onclick: ()=>this._openPrompt(\"distortion\")}, \"Distortion:\"), this._distortionSlider.input);\r\n\tprivate readonly _bitcrusherQuantizationSlider: Slider = new Slider(input({style: \"margin: 0;\", type: \"range\", min: \"0\", max: Config.bitcrusherQuantizationRange - 1, value: \"0\", step: \"1\"}), this._doc, (oldValue: number, newValue: number) => new ChangeBitcrusherQuantization(this._doc, oldValue, newValue));\r\n\tprivate readonly _bitcrusherQuantizationRow: HTMLDivElement = div({class: \"selectRow\"}, span({class: \"tip\", onclick: ()=>this._openPrompt(\"bitcrusherQuantization\")}, \"Bit Crush:\"), this._bitcrusherQuantizationSlider.input);\r\n\tprivate readonly _bitcrusherFreqSlider: Slider = new Slider(input({style: \"margin: 0;\", type: \"range\", min: \"0\", max: Config.bitcrusherFreqRange - 1, value: \"0\", step: \"1\"}), this._doc, (oldValue: number, newValue: number) => new ChangeBitcrusherFreq(this._doc, oldValue, newValue));\r\n\tprivate readonly _bitcrusherFreqRow: HTMLDivElement = div({class: \"selectRow\"}, span({class: \"tip\", onclick: ()=>this._openPrompt(\"bitcrusherFreq\")}, \"Freq Crush:\"), this._bitcrusherFreqSlider.input);\r\n\tprivate readonly _stringSustainSlider: Slider = new Slider(input({style: \"margin: 0;\", type: \"range\", min: \"0\", max: Config.stringSustainRange - 1, value: \"0\", step: \"1\"}), this._doc, (oldValue: number, newValue: number) => new ChangeStringSustain(this._doc, oldValue, newValue));\r\n\tprivate readonly _stringSustainLabel: HTMLSpanElement = span({class: \"tip\", onclick: ()=>this._openPrompt(\"stringSustain\")}, \"Sustain:\");\r\n\tprivate readonly _stringSustainRow: HTMLDivElement = div({class: \"selectRow\"}, this._stringSustainLabel, this._stringSustainSlider.input);\r\n\tprivate readonly _unisonSelect: HTMLSelectElement = buildOptions(select(), Config.unisons.map(unison=>unison.name));\r\n\tprivate readonly _unisonSelectRow: HTMLElement = div({class: \"selectRow\"}, span({class: \"tip\", onclick: ()=>this._openPrompt(\"unison\")}, \"Unison:\"), div({class: \"selectContainer\"}, this._unisonSelect));\r\n\tprivate readonly _chordSelect: HTMLSelectElement = buildOptions(select(), Config.chords.map(chord=>chord.name));\r\n\tprivate readonly _chordSelectRow: HTMLElement = div({class: \"selectRow\"}, span({class: \"tip\", onclick: ()=>this._openPrompt(\"chords\")}, \"Chords:\"), div({class: \"selectContainer\"}, this._chordSelect));\r\n\tprivate readonly _vibratoSelect: HTMLSelectElement = buildOptions(select(), Config.vibratos.map(vibrato=>vibrato.name));\r\n\tprivate readonly _vibratoSelectRow: HTMLElement = div({class: \"selectRow\"}, span({class: \"tip\", onclick: ()=>this._openPrompt(\"vibrato\")}, \"Vibrato:\"), div({class: \"selectContainer\"}, this._vibratoSelect));\r\n\tprivate readonly _phaseModGroup: HTMLElement = div({class: \"editor-controls\"});\r\n\tprivate readonly _feedbackTypeSelect: HTMLSelectElement = buildOptions(select(), Config.feedbacks.map(feedback=>feedback.name));\r\n\tprivate readonly _feedbackRow1: HTMLDivElement = div({class: \"selectRow\"}, span({class: \"tip\", onclick: ()=>this._openPrompt(\"feedbackType\")}, \"Feedback:\"), div({class: \"selectContainer\"}, this._feedbackTypeSelect));\r\n\tprivate readonly _spectrumEditor: SpectrumEditor = new SpectrumEditor(this._doc, null);\r\n\tprivate readonly _spectrumRow: HTMLElement = div({class: \"selectRow\"}, span({class: \"tip\", onclick: ()=>this._openPrompt(\"spectrum\")}, \"Spectrum:\"), this._spectrumEditor.container);\r\n\tprivate readonly _harmonicsEditor: HarmonicsEditor = new HarmonicsEditor(this._doc);\r\n\tprivate readonly _harmonicsRow: HTMLElement = div({class: \"selectRow\"}, span({class: \"tip\", onclick: ()=>this._openPrompt(\"harmonics\")}, \"Harmonics:\"), this._harmonicsEditor.container);\r\n\tprivate readonly _envelopeEditor: EnvelopeEditor = new EnvelopeEditor(this._doc);\r\n\tprivate readonly _drumsetGroup: HTMLElement = div({class: \"editor-controls\"});\r\n\t\r\n\tprivate readonly _feedbackAmplitudeSlider: Slider = new Slider(input({type: \"range\", min: \"0\", max: Config.operatorAmplitudeMax, value: \"0\", step: \"1\", title: \"Feedback Amplitude\"}), this._doc, (oldValue: number, newValue: number) => new ChangeFeedbackAmplitude(this._doc, oldValue, newValue));\r\n\tprivate readonly _feedbackRow2: HTMLDivElement = div({class: \"selectRow\"}, span({class: \"tip\", onclick: ()=>this._openPrompt(\"feedbackVolume\")}, \"Fdback Vol:\"), this._feedbackAmplitudeSlider.input);\r\n\tprivate readonly _customizeInstrumentButton: HTMLButtonElement = button({type: \"button\", class: \"customize-instrument\"},\r\n\t\t\"Customize Instrument\",\r\n\t);\r\n\tprivate readonly _addEnvelopeButton: HTMLButtonElement = button({type: \"button\", class: \"add-envelope\"});\r\n\tprivate readonly _customInstrumentSettingsGroup: HTMLDivElement = div({class: \"editor-controls\"},\r\n\t\tthis._eqFilterRow,\r\n\t\tthis._fadeInOutRow,\r\n\t\tthis._chipWaveSelectRow,\r\n\t\tthis._chipNoiseSelectRow,\r\n\t\tthis._algorithmSelectRow,\r\n\t\tthis._phaseModGroup,\r\n\t\tthis._feedbackRow1,\r\n\t\tthis._feedbackRow2,\r\n\t\tthis._spectrumRow,\r\n\t\tthis._harmonicsRow,\r\n\t\tthis._drumsetGroup,\r\n\t\tthis._supersawDynamismRow,\r\n\t\tthis._supersawSpreadRow,\r\n\t\tthis._supersawShapeRow,\r\n\t\tthis._pulseWidthRow,\r\n\t\tthis._stringSustainRow,\r\n\t\tthis._unisonSelectRow,\r\n\t\tdiv({style: `margin: 2px 0; margin-left: 2em; display: flex; align-items: center;`},\r\n\t\t\tspan({style: `flex-grow: 1; text-align: center;`}, span({class: \"tip\", onclick: ()=>this._openPrompt(\"effects\")}, \"Effects\")),\r\n\t\t\tdiv({class: \"effects-menu\"}, this._effectsSelect),\r\n\t\t),\r\n\t\tthis._transitionRow,\r\n\t\tthis._chordSelectRow,\r\n\t\tthis._pitchShiftRow,\r\n\t\tthis._detuneRow,\r\n\t\tthis._vibratoSelectRow,\r\n\t\tthis._noteFilterRow,\r\n\t\tthis._distortionRow,\r\n\t\tthis._bitcrusherQuantizationRow,\r\n\t\tthis._bitcrusherFreqRow,\r\n\t\tthis._panSliderRow,\r\n\t\tthis._chorusRow,\r\n\t\tthis._echoSustainRow,\r\n\t\tthis._echoDelayRow,\r\n\t\tthis._reverbRow,\r\n\t\tdiv({style: `margin: 2px 0; margin-left: 2em; display: flex; align-items: center;`},\r\n\t\t\tspan({style: `flex-grow: 1; text-align: center;`}, span({class: \"tip\", onclick: ()=>this._openPrompt(\"envelopes\")}, \"Envelopes\")),\r\n\t\t\tthis._addEnvelopeButton,\r\n\t\t),\r\n\t\tthis._envelopeEditor.container,\r\n\t);\r\n\tprivate readonly _instrumentSettingsGroup: HTMLDivElement = div({class: \"editor-controls\"},\r\n\t\tdiv({style: `margin: 3px 0; text-align: center; color: ${ColorConfig.secondaryText};`},\r\n\t\t\t\"Instrument Settings\"\r\n\t\t),\r\n\t\tthis._instrumentsButtonRow,\r\n\t\tthis._instrumentCopyPasteRow,\r\n\t\tthis._instrumentVolumeSliderRow,\r\n\t\tdiv({class: \"selectRow\"},\r\n\t\t\tspan({class: \"tip\", onclick: ()=>this._openPrompt(\"instrumentType\")}, \"Type:\"),\r\n\t\t\tdiv({class: \"selectContainer\"}, this._pitchedPresetSelect, this._drumPresetSelect),\r\n\t\t),\r\n\t\tthis._customizeInstrumentButton,\r\n\t\tthis._customInstrumentSettingsGroup,\r\n\t);\r\n\tprivate readonly _promptContainer: HTMLDivElement = div({class: \"promptContainer\", style: \"display: none;\"});\r\n\tprivate readonly _zoomInButton: HTMLButtonElement = button({class: \"zoomInButton\", type: \"button\", title: \"Zoom In\"});\r\n\tprivate readonly _zoomOutButton: HTMLButtonElement = button({class: \"zoomOutButton\", type: \"button\", title: \"Zoom Out\"});\r\n\tprivate readonly _patternEditorRow: HTMLDivElement = div({style: \"flex: 1; height: 100%; display: flex; overflow: hidden; justify-content: center;\"},\r\n\t\tthis._patternEditorPrev.container,\r\n\t\tthis._patternEditor.container,\r\n\t\tthis._patternEditorNext.container,\r\n\t);\r\n\tprivate readonly _patternArea: HTMLDivElement = div({class: \"pattern-area\"},\r\n\t\tthis._piano.container,\r\n\t\tthis._patternEditorRow,\r\n\t\tthis._octaveScrollBar.container,\r\n\t\tthis._zoomInButton,\r\n\t\tthis._zoomOutButton,\r\n\t);\r\n\tprivate readonly _trackContainer: HTMLDivElement = div({class: \"trackContainer\"},\r\n\t\tthis._trackEditor.container,\r\n\t\tthis._loopEditor.container,\r\n\t);\r\n\tprivate readonly _trackVisibleArea: HTMLDivElement = div({style: \"position: absolute; width: 100%; height: 100%; pointer-events: none;\"});\r\n\tprivate readonly _trackAndMuteContainer: HTMLDivElement = div({class: \"trackAndMuteContainer\"},\r\n\t\tthis._muteEditor.container,\r\n\t\tthis._trackContainer,\r\n\t\tthis._trackVisibleArea,\r\n\t);\r\n\tprivate readonly _barScrollBar: BarScrollBar = new BarScrollBar(this._doc);\r\n\tprivate readonly _trackArea: HTMLDivElement = div({class: \"track-area\"},\r\n\t\tthis._trackAndMuteContainer,\r\n\t\tthis._barScrollBar.container,\r\n\t);\r\n\t\r\n\tprivate readonly _menuArea: HTMLDivElement = div({class: \"menu-area\"},\r\n\t\tdiv({class: \"selectContainer menu file\"},\r\n\t\t\tthis._fileMenu,\r\n\t\t),\r\n\t\tdiv({class: \"selectContainer menu edit\"},\r\n\t\t\tthis._editMenu,\r\n\t\t),\r\n\t\tdiv({class: \"selectContainer menu preferences\"},\r\n\t\t\tthis._optionsMenu,\r\n\t\t),\r\n\t);\r\n\tprivate readonly _songSettingsArea: HTMLDivElement = div({class: \"song-settings-area\"},\r\n\t\tdiv({class: \"editor-controls\"},\r\n\t\t\tdiv({style: `margin: 3px 0; text-align: center; color: ${ColorConfig.secondaryText};`},\r\n\t\t\t\t\"Song Settings\",\r\n\t\t\t),\r\n\t\t\tdiv({class: \"selectRow\"},\r\n\t\t\t\tspan({class: \"tip\", onclick: ()=>this._openPrompt(\"scale\")}, \"Scale:\"),\r\n\t\t\t\tdiv({class: \"selectContainer\"}, this._scaleSelect),\r\n\t\t\t),\r\n\t\t\tdiv({class: \"selectRow\"},\r\n\t\t\t\tspan({class: \"tip\", onclick: ()=>this._openPrompt(\"key\")}, \"Key:\"),\r\n\t\t\t\tdiv({class: \"selectContainer\"}, this._keySelect),\r\n\t\t\t),\r\n\t\t\tdiv({class: \"selectRow\"},\r\n\t\t\t\tspan({class: \"tip\", onclick: ()=>this._openPrompt(\"tempo\")}, \"Tempo:\"),\r\n\t\t\t\tspan({style: \"display: flex;\"},\r\n\t\t\t\t\tthis._tempoSlider.input,\r\n\t\t\t\t\tthis._tempoStepper,\r\n\t\t\t\t),\r\n\t\t\t),\r\n\t\t\tdiv({class: \"selectRow\"},\r\n\t\t\t\tspan({class: \"tip\", onclick: ()=>this._openPrompt(\"rhythm\")}, \"Rhythm:\"),\r\n\t\t\t\tdiv({class: \"selectContainer\"}, this._rhythmSelect),\r\n\t\t\t),\r\n\t\t),\r\n\t);\r\n\tprivate readonly _instrumentSettingsArea: HTMLDivElement = div({class: \"instrument-settings-area\"}, this._instrumentSettingsGroup);\r\n\tprivate readonly _settingsArea: HTMLDivElement = div({class: \"settings-area noSelection\"},\r\n\t\tdiv({class: \"version-area\"},\r\n\t\t\tdiv({style: `text-align: center; margin: 3px 0; color: ${ColorConfig.secondaryText};`},\r\n\t\t\t\tEditorConfig.versionDisplayName,\r\n\t\t\t\t\" \",\r\n\t\t\t\ta({class: \"tip\", target: \"_blank\", href: EditorConfig.releaseNotesURL},\r\n\t\t\t\t\tEditorConfig.version,\r\n\t\t\t\t),\r\n\t\t\t),\r\n\t\t),\r\n\t\tdiv({class: \"play-pause-area\"},\r\n\t\t\tdiv({class: \"playback-bar-controls\"},\r\n\t\t\t\tthis._playButton,\r\n\t\t\t\tthis._pauseButton,\r\n\t\t\t\tthis._recordButton,\r\n\t\t\t\tthis._stopButton,\r\n\t\t\t\tthis._prevBarButton,\r\n\t\t\t\tthis._nextBarButton,\r\n\t\t\t),\r\n\t\t\tdiv({class: \"playback-volume-controls\"},\r\n\t\t\t\tspan({class: \"volume-speaker\"}),\r\n\t\t\t\tthis._volumeSlider,\r\n\t\t\t),\r\n\t\t),\r\n\t\tthis._menuArea,\r\n\t\tthis._songSettingsArea,\r\n\t\tthis._instrumentSettingsArea,\r\n\t);\r\n\t\r\n\tpublic readonly mainLayer: HTMLDivElement = div({class: \"beepboxEditor\", tabIndex: \"0\"},\r\n\t\tthis._patternArea,\r\n\t\tthis._trackArea,\r\n\t\tthis._settingsArea,\r\n\t\tthis._promptContainer,\r\n\t);\r\n\t\r\n\tprivate _wasPlaying: boolean = false;\r\n\tprivate _currentPromptName: string | null = null;\r\n\tprivate _highlightedInstrumentIndex: number = -1;\r\n\tprivate _renderedInstrumentCount: number = 0;\r\n\tprivate _renderedIsPlaying: boolean = false;\r\n\tprivate _renderedIsRecording: boolean = false;\r\n\tprivate _renderedShowRecordButton: boolean = false;\r\n\tprivate _renderedCtrlHeld: boolean = false;\r\n\tprivate _ctrlHeld: boolean = false;\r\n\tprivate _deactivatedInstruments: boolean = false;\r\n\tprivate readonly _operatorRows: HTMLDivElement[] = []\r\n\tprivate readonly _operatorAmplitudeSliders: Slider[] = []\r\n\tprivate readonly _operatorFrequencySelects: HTMLSelectElement[] = []\r\n\tprivate readonly _drumsetSpectrumEditors: SpectrumEditor[] = [];\r\n\tprivate readonly _drumsetEnvelopeSelects: HTMLSelectElement[] = [];\r\n\t\r\n\tconstructor(private _doc: SongDocument) {\r\n\t\tthis._doc.notifier.watch(this.whenUpdated);\r\n\t\tnew MidiInputHandler(this._doc);\r\n\t\twindow.addEventListener(\"resize\", this.whenUpdated);\r\n\t\twindow.requestAnimationFrame(this.updatePlayButton);\r\n\t\t\r\n\t\tif (!(\"share\" in navigator)) {\r\n\t\t\tthis._fileMenu.removeChild(this._fileMenu.querySelector(\"[value='shareUrl']\")!);\r\n\t\t}\r\n\t\t\r\n\t\tthis._scaleSelect.appendChild(optgroup({label: \"Edit\"},\r\n\t\t\toption({value: \"forceScale\"}, \"Snap Notes To Scale\"),\r\n\t\t));\r\n\t\tthis._keySelect.appendChild(optgroup({label: \"Edit\"},\r\n\t\t\toption({value: \"detectKey\"}, \"Detect Key\"),\r\n\t\t));\r\n\t\tthis._rhythmSelect.appendChild(optgroup({label: \"Edit\"},\r\n\t\t\toption({value: \"forceRhythm\"}, \"Snap Notes To Rhythm\"),\r\n\t\t));\r\n\t\t\r\n\t\tthis._phaseModGroup.appendChild(div({class: \"selectRow\", style: `color: ${ColorConfig.secondaryText}; height: 1em; margin-top: 0.5em;`},\r\n\t\t\tdiv({style: \"margin-right: .1em; visibility: hidden;\"}, 1 + \".\"),\r\n\t\t\tdiv({style: \"width: 3em; margin-right: .3em;\", class: \"tip\", onclick: ()=>this._openPrompt(\"operatorFrequency\")}, \"Freq:\"),\r\n\t\t\tdiv({class: \"tip\", onclick: ()=>this._openPrompt(\"operatorVolume\")}, \"Volume:\"),\r\n\t\t));\r\n\t\tfor (let i: number = 0; i < Config.operatorCount; i++) {\r\n\t\t\tconst operatorIndex: number = i;\r\n\t\t\tconst operatorNumber: HTMLDivElement = div({style: `margin-right: .1em; color: ${ColorConfig.secondaryText};`}, i + 1 + \".\");\r\n\t\t\tconst frequencySelect: HTMLSelectElement = buildOptions(select({style: \"width: 100%;\", title: \"Frequency\"}), Config.operatorFrequencies.map(freq=>freq.name));\r\n\t\t\tconst amplitudeSlider: Slider = new Slider(input({type: \"range\", min: \"0\", max: Config.operatorAmplitudeMax, value: \"0\", step: \"1\", title: \"Volume\"}), this._doc, (oldValue: number, newValue: number) => new ChangeOperatorAmplitude(this._doc, operatorIndex, oldValue, newValue));\r\n\t\t\tconst row: HTMLDivElement = div({class: \"selectRow\"},\r\n\t\t\t\toperatorNumber,\r\n\t\t\t\tdiv({class: \"selectContainer\", style: \"width: 3em; margin-right: .3em;\"}, frequencySelect),\r\n\t\t\t\tamplitudeSlider.input,\r\n\t\t\t);\r\n\t\t\tthis._phaseModGroup.appendChild(row);\r\n\t\t\tthis._operatorRows[i] = row;\r\n\t\t\tthis._operatorAmplitudeSliders[i] = amplitudeSlider;\r\n\t\t\tthis._operatorFrequencySelects[i] = frequencySelect;\r\n\t\t\t\r\n\t\t\tfrequencySelect.addEventListener(\"change\", () => {\r\n\t\t\t\tthis._doc.record(new ChangeOperatorFrequency(this._doc, operatorIndex, frequencySelect.selectedIndex));\r\n\t\t\t});\r\n\t\t}\r\n\t\t\r\n\t\tthis._drumsetGroup.appendChild(\r\n\t\t\tdiv({class: \"selectRow\"},\r\n\t\t\t\tspan({class: \"tip\", onclick: ()=>this._openPrompt(\"drumsetEnvelope\")}, \"Envelope:\"),\r\n\t\t\t\tspan({class: \"tip\", onclick: ()=>this._openPrompt(\"drumsetSpectrum\")}, \"Spectrum:\"),\r\n\t\t\t),\r\n\t\t);\r\n\t\tfor (let i: number = Config.drumCount - 1; i >= 0; i--) {\r\n\t\t\tconst drumIndex: number = i;\r\n\t\t\tconst spectrumEditor: SpectrumEditor = new SpectrumEditor(this._doc, drumIndex);\r\n\t\t\tspectrumEditor.container.addEventListener(\"mousedown\", this._refocusStage);\r\n\t\t\tthis._drumsetSpectrumEditors[i] = spectrumEditor;\r\n\t\t\t\r\n\t\t\tconst envelopeSelect: HTMLSelectElement = buildOptions(select({style: \"width: 100%;\", title: \"Filter Envelope\"}), Config.envelopes.map(envelope=>envelope.name));\r\n\t\t\tthis._drumsetEnvelopeSelects[i] = envelopeSelect;\r\n\t\t\tenvelopeSelect.addEventListener(\"change\", () => {\r\n\t\t\t\tthis._doc.record(new ChangeDrumsetEnvelope(this._doc, drumIndex, envelopeSelect.selectedIndex));\r\n\t\t\t});\r\n\t\t\t\r\n\t\t\tconst row: HTMLDivElement = div({class: \"selectRow\"},\r\n\t\t\t\tdiv({class: \"selectContainer\", style: \"width: 5em; margin-right: .3em;\"}, envelopeSelect),\r\n\t\t\t\tthis._drumsetSpectrumEditors[i].container,\r\n\t\t\t);\r\n\t\t\tthis._drumsetGroup.appendChild(row);\r\n\t\t}\r\n\t\t\r\n\t\tthis._fileMenu.addEventListener(\"change\", this._fileMenuHandler);\r\n\t\tthis._editMenu.addEventListener(\"change\", this._editMenuHandler);\r\n\t\tthis._optionsMenu.addEventListener(\"change\", this._optionsMenuHandler);\r\n\t\tthis._tempoStepper.addEventListener(\"change\", this._whenSetTempo);\r\n\t\tthis._scaleSelect.addEventListener(\"change\", this._whenSetScale);\r\n\t\tthis._keySelect.addEventListener(\"change\", this._whenSetKey);\r\n\t\tthis._rhythmSelect.addEventListener(\"change\", this._whenSetRhythm);\r\n\t\tthis._pitchedPresetSelect.addEventListener(\"change\", this._whenSetPitchedPreset);\r\n\t\tthis._drumPresetSelect.addEventListener(\"change\", this._whenSetDrumPreset);\r\n\t\tthis._algorithmSelect.addEventListener(\"change\", this._whenSetAlgorithm);\r\n\t\tthis._instrumentsButtonBar.addEventListener(\"click\", this._whenSelectInstrument);\r\n\t\tthis._instrumentCopyButton.addEventListener(\"click\", this._copyInstrument);\r\n\t\tthis._instrumentPasteButton.addEventListener(\"click\", this._pasteInstrument);\r\n\t\tthis._customizeInstrumentButton.addEventListener(\"click\", this._whenCustomizePressed);\r\n\t\tthis._feedbackTypeSelect.addEventListener(\"change\", this._whenSetFeedbackType);\r\n\t\tthis._chipWaveSelect.addEventListener(\"change\", this._whenSetChipWave);\r\n\t\tthis._chipNoiseSelect.addEventListener(\"change\", this._whenSetNoiseWave);\r\n\t\tthis._transitionSelect.addEventListener(\"change\", this._whenSetTransition);\r\n\t\tthis._effectsSelect.addEventListener(\"change\", this._whenSetEffects);\r\n\t\tthis._unisonSelect.addEventListener(\"change\", this._whenSetUnison);\r\n\t\tthis._chordSelect.addEventListener(\"change\", this._whenSetChord);\r\n\t\tthis._vibratoSelect.addEventListener(\"change\", this._whenSetVibrato);\r\n\t\tthis._playButton.addEventListener(\"click\", this._togglePlay);\r\n\t\tthis._pauseButton.addEventListener(\"click\", this._togglePlay);\r\n\t\tthis._recordButton.addEventListener(\"click\", this._toggleRecord);\r\n\t\tthis._stopButton.addEventListener(\"click\", this._toggleRecord);\r\n\t\t// Start recording instead of opening context menu when control-clicking the record button on a Mac.\r\n\t\tthis._recordButton.addEventListener(\"contextmenu\", (event: MouseEvent) => {\r\n\t\t\tif (event.ctrlKey) {\r\n\t\t\t\tevent.preventDefault();\r\n\t\t\t\tthis._toggleRecord();\r\n\t\t\t}\r\n\t\t});\r\n\t\tthis._stopButton.addEventListener(\"contextmenu\", (event: MouseEvent) => {\r\n\t\t\tif (event.ctrlKey) {\r\n\t\t\t\tevent.preventDefault();\r\n\t\t\t\tthis._toggleRecord();\r\n\t\t\t}\r\n\t\t});\r\n\t\tthis._prevBarButton.addEventListener(\"click\", this._whenPrevBarPressed);\r\n\t\tthis._nextBarButton.addEventListener(\"click\", this._whenNextBarPressed);\r\n\t\tthis._volumeSlider.addEventListener(\"input\", this._setVolumeSlider);\r\n\t\tthis._zoomInButton.addEventListener(\"click\", this._zoomIn);\r\n\t\tthis._zoomOutButton.addEventListener(\"click\", this._zoomOut);\r\n\t\t\r\n\t\tthis._patternArea.addEventListener(\"mousedown\", this._refocusStage);\r\n\t\tthis._trackArea.addEventListener(\"mousedown\", this._refocusStage);\r\n\t\tthis._fadeInOutEditor.container.addEventListener(\"mousedown\", this._refocusStage);\r\n\t\tthis._spectrumEditor.container.addEventListener(\"mousedown\", this._refocusStage);\r\n\t\tthis._eqFilterEditor.container.addEventListener(\"mousedown\", this._refocusStage);\r\n\t\tthis._noteFilterEditor.container.addEventListener(\"mousedown\", this._refocusStage);\r\n\t\tthis._harmonicsEditor.container.addEventListener(\"mousedown\", this._refocusStage);\r\n\t\tthis._tempoStepper.addEventListener(\"keydown\", this._tempoStepperCaptureNumberKeys, false);\r\n\t\tthis._addEnvelopeButton.addEventListener(\"click\", this._addNewEnvelope);\r\n\t\tthis._patternArea.addEventListener(\"contextmenu\", this._disableCtrlContextMenu);\r\n\t\tthis._trackArea.addEventListener(\"contextmenu\", this._disableCtrlContextMenu);\r\n\t\tthis.mainLayer.addEventListener(\"keydown\", this._whenKeyPressed);\r\n\t\tthis.mainLayer.addEventListener(\"keyup\", this._whenKeyReleased);\r\n\t\tthis.mainLayer.addEventListener(\"focusin\", this._onFocusIn);\r\n\t\t\r\n\t\tthis._promptContainer.addEventListener(\"click\", (event) => {\r\n\t\t\tif (event.target == this._promptContainer) {\r\n\t\t\t\tthis._doc.undo();\r\n\t\t\t}\r\n\t\t});\r\n\t\t\r\n\t\t// Sorry, bypassing typescript type safety on this function because I want to use the new \"passive\" option.\r\n\t\t//this._trackAndMuteContainer.addEventListener(\"scroll\", this._onTrackAreaScroll, {capture: false, passive: true});\r\n\t\t(<Function>this._trackAndMuteContainer.addEventListener)(\"scroll\", this._onTrackAreaScroll, {capture: false, passive: true});\r\n\t\t\r\n\t\tif (isMobile) {\r\n\t\t\tconst autoPlayOption: HTMLOptionElement = <HTMLOptionElement> this._optionsMenu.querySelector(\"[value=autoPlay]\");\r\n\t\t\tautoPlayOption.disabled = true;\r\n\t\t\tautoPlayOption.setAttribute(\"hidden\", \"\");\r\n\t\t}\r\n\t\t\r\n\t\tif (window.screen.availWidth < 710 || window.screen.availHeight < 710) {\r\n\t\t\tconst layoutOption: HTMLOptionElement = <HTMLOptionElement> this._optionsMenu.querySelector(\"[value=layout]\");\r\n\t\t\tlayoutOption.disabled = true;\r\n\t\t\tlayoutOption.setAttribute(\"hidden\", \"\");\r\n\t\t}\r\n\t}\r\n\t\r\n\tprivate _openPrompt(promptName: string): void {\r\n\t\tthis._doc.openPrompt(promptName);\r\n\t\tthis._setPrompt(promptName);\r\n\t}\r\n\t\r\n\tprivate _setPrompt(promptName: string | null): void {\r\n\t\tif (this._currentPromptName == promptName) return;\r\n\t\tthis._currentPromptName = promptName;\r\n\t\t\r\n\t\tif (this.prompt) {\r\n\t\t\tif (this._wasPlaying && !(this.prompt instanceof TipPrompt || this.prompt instanceof SustainPrompt)) {\r\n\t\t\t\tthis._doc.performance.play();\r\n\t\t\t}\r\n\t\t\tthis._wasPlaying = false;\r\n\t\t\tthis._promptContainer.style.display = \"none\";\r\n\t\t\tthis._promptContainer.removeChild(this.prompt.container);\r\n\t\t\tthis.prompt.cleanUp();\r\n\t\t\tthis.prompt = null;\r\n\t\t\tthis._refocusStage();\r\n\t\t}\r\n\t\t\r\n\t\tif (promptName) {\r\n\t\t\tswitch (promptName) {\r\n\t\t\t\tcase \"export\":\r\n\t\t\t\t\tthis.prompt = new ExportPrompt(this._doc);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase \"import\":\r\n\t\t\t\t\tthis.prompt = new ImportPrompt(this._doc);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase \"songRecovery\":\r\n\t\t\t\t\tthis.prompt = new SongRecoveryPrompt(this._doc);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase \"barCount\":\r\n\t\t\t\t\tthis.prompt = new SongDurationPrompt(this._doc);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase \"beatsPerBar\":\r\n\t\t\t\t\tthis.prompt = new BeatsPerBarPrompt(this._doc);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase \"moveNotesSideways\":\r\n\t\t\t\t\tthis.prompt = new MoveNotesSidewaysPrompt(this._doc);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase \"channelSettings\":\r\n\t\t\t\t\tthis.prompt = new ChannelSettingsPrompt(this._doc);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase \"layout\":\r\n\t\t\t\t\tthis.prompt = new LayoutPrompt(this._doc);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase \"recordingSetup\":\r\n\t\t\t\t\tthis.prompt = new RecordingSetupPrompt(this._doc);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase \"stringSustain\":\r\n\t\t\t\t\tthis.prompt = new SustainPrompt(this._doc);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase \"colorTheme\":\r\n\t\t\t\t\tthis.prompt = new ThemePrompt(this._doc);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tdefault:\r\n\t\t\t\t\tthis.prompt = new TipPrompt(this._doc, promptName);\r\n\t\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tif (this.prompt) {\r\n\t\t\t\tif (!(this.prompt instanceof TipPrompt || this.prompt instanceof SustainPrompt)) {\r\n\t\t\t\t\tthis._wasPlaying = this._doc.synth.playing;\r\n\t\t\t\t\tthis._doc.performance.pause();\r\n\t\t\t\t}\r\n\t\t\t\tthis._promptContainer.style.display = \"\";\r\n\t\t\t\tthis._promptContainer.appendChild(this.prompt.container);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\t\r\n\tprivate _refocusStage = (): void => {\r\n\t\tthis.mainLayer.focus({preventScroll: true});\r\n\t}\r\n\t\r\n\tprivate _onFocusIn = (event: Event): void => {\r\n\t\tif (this._doc.synth.recording && event.target != this.mainLayer && event.target != this._stopButton && event.target != this._volumeSlider) {\r\n\t\t\t// Don't allow using tab to focus on the song settings while recording,\r\n\t\t\t// since interacting with them while recording would mess up the recording.\r\n\t\t\tthis._refocusStage();\r\n\t\t}\r\n\t}\r\n\t\r\n\tpublic whenUpdated = (): void => {\r\n\t\tconst prefs: Preferences = this._doc.prefs;\r\n\t\tthis._muteEditor.container.style.display = prefs.enableChannelMuting ? \"\" : \"none\";\r\n\t\tconst trackBounds: DOMRect = this._trackVisibleArea.getBoundingClientRect();\r\n\t\tthis._doc.trackVisibleBars = Math.floor((trackBounds.right - trackBounds.left - (prefs.enableChannelMuting ? 32 : 0)) / this._doc.getBarWidth());\r\n\t\tthis._doc.trackVisibleChannels = Math.floor((trackBounds.bottom - trackBounds.top - 30) / ChannelRow.patternHeight);\r\n\t\tthis._barScrollBar.render();\r\n\t\tthis._muteEditor.render();\r\n\t\tthis._trackEditor.render();\r\n\t\t\r\n\t\tthis._trackAndMuteContainer.scrollLeft = this._doc.barScrollPos * this._doc.getBarWidth();\r\n\t\tthis._trackAndMuteContainer.scrollTop = this._doc.channelScrollPos * ChannelRow.patternHeight;\r\n\t\t\r\n\t\tthis._piano.container.style.display = prefs.showLetters ? \"\" : \"none\";\r\n\t\tthis._octaveScrollBar.container.style.display = prefs.showScrollBar ? \"\" : \"none\";\r\n\t\tthis._barScrollBar.container.style.display = this._doc.song.barCount > this._doc.trackVisibleBars ? \"\" : \"none\";\r\n\t\t\r\n\t\tif (this._doc.getFullScreen()) {\r\n\t\t\tconst semitoneHeight: number = this._patternEditorRow.clientHeight / this._doc.getVisiblePitchCount();\r\n\t\t\tconst targetBeatWidth: number = semitoneHeight * 5;\r\n\t\t\tconst minBeatWidth: number = this._patternEditorRow.clientWidth / (this._doc.song.beatsPerBar * 3);\r\n\t\t\tconst maxBeatWidth: number = this._patternEditorRow.clientWidth / (this._doc.song.beatsPerBar + 2);\r\n\t\t\tconst beatWidth: number = Math.max(minBeatWidth, Math.min(maxBeatWidth, targetBeatWidth));\r\n\t\t\tconst patternEditorWidth: number = beatWidth * this._doc.song.beatsPerBar;\r\n\t\t\t\r\n\t\t\tthis._patternEditorPrev.container.style.width = patternEditorWidth + \"px\";\r\n\t\t\tthis._patternEditor.container.style.width = patternEditorWidth + \"px\";\r\n\t\t\tthis._patternEditorNext.container.style.width = patternEditorWidth + \"px\";\r\n\t\t\tthis._patternEditorPrev.container.style.flexShrink = \"0\";\r\n\t\t\tthis._patternEditor.container.style.flexShrink = \"0\";\r\n\t\t\tthis._patternEditorNext.container.style.flexShrink = \"0\";\r\n\t\t\tthis._patternEditorPrev.container.style.display = \"\";\r\n\t\t\tthis._patternEditorNext.container.style.display = \"\";\r\n\t\t\tthis._patternEditorPrev.render();\r\n\t\t\tthis._patternEditorNext.render();\r\n\t\t\tthis._zoomInButton.style.display = \"\";\r\n\t\t\tthis._zoomOutButton.style.display = \"\";\r\n\t\t\tthis._zoomInButton.style.right = prefs.showScrollBar ? \"24px\" : \"4px\";\r\n\t\t\tthis._zoomOutButton.style.right = prefs.showScrollBar ? \"24px\" : \"4px\";\r\n\t\t} else {\r\n\t\t\tthis._patternEditor.container.style.width = \"\";\r\n\t\t\tthis._patternEditor.container.style.flexShrink = \"\";\r\n\t\t\tthis._patternEditorPrev.container.style.display = \"none\";\r\n\t\t\tthis._patternEditorNext.container.style.display = \"none\";\r\n\t\t\tthis._zoomInButton.style.display = \"none\";\r\n\t\t\tthis._zoomOutButton.style.display = \"none\";\r\n\t\t}\r\n\t\tthis._patternEditor.render();\r\n\t\t\r\n\t\tconst optionCommands: ReadonlyArray<string> = [\r\n\t\t\t(prefs.autoPlay ? \" \" : \"\") + \"Auto Play on Load\",\r\n\t\t\t(prefs.autoFollow ? \" \" : \"\") + \"Show And Play The Same Bar\",\r\n\t\t\t(prefs.enableNotePreview ? \" \" : \"\") + \"Hear Preview of Added Notes\",\r\n\t\t\t(prefs.showLetters ? \" \" : \"\") + \"Show Piano Keys\",\r\n\t\t\t(prefs.showFifth ? \" \" : \"\") + 'Highlight \"Fifth\" of Song Key',\r\n\t\t\t(prefs.notesOutsideScale ? \" \" : \"\") + \"Allow Adding Notes Not in Scale\",\r\n\t\t\t(prefs.defaultScale == this._doc.song.scale ? \" \" : \"\") + \"Use Current Scale as Default\",\r\n\t\t\t(prefs.showChannels ? \" \" : \"\") + \"Show Notes From All Channels\",\r\n\t\t\t(prefs.showScrollBar ? \" \" : \"\") + \"Show Octave Scroll Bar\",\r\n\t\t\t(prefs.alwaysShowSettings ? \" \" : \"\") + \"Customize All Instruments\",\r\n\t\t\t(prefs.instrumentCopyPaste ? \" \" : \"\") + \"Instrument Copy/Paste Buttons\",\r\n\t\t\t(prefs.enableChannelMuting ? \" \" : \"\") + \"Enable Channel Muting\",\r\n\t\t\t(prefs.displayBrowserUrl ? \" \" : \"\") + \"Display Song Data in URL\",\r\n\t\t\t\"Choose Layout...\",\r\n\t\t\t\"Choose Theme...\",\r\n\t\t\t\"Set Up Note Recording...\",\r\n\t\t];\r\n\t\tfor (let i: number = 0; i < optionCommands.length; i++) {\r\n\t\t\tconst option: HTMLOptionElement = <HTMLOptionElement> this._optionsMenu.children[i + 1];\r\n\t\t\tif (option.textContent != optionCommands[i]) option.textContent = optionCommands[i];\r\n\t\t}\r\n\t\t\r\n\t\tconst channel: Channel = this._doc.song.channels[this._doc.channel];\r\n\t\tconst instrumentIndex: number = this._doc.getCurrentInstrument();\r\n\t\tconst instrument: Instrument = channel.instruments[instrumentIndex];\r\n\t\tconst wasActive: boolean = this.mainLayer.contains(document.activeElement);\r\n\t\tconst activeElement: Element | null = document.activeElement;\r\n\t\tconst colors: ChannelColors = ColorConfig.getChannelColor(this._doc.song, this._doc.channel);\r\n\t\t\r\n\t\tfor (let i: number = this._effectsSelect.childElementCount - 1; i < Config.effectOrder.length; i++) {\r\n\t\t\tthis._effectsSelect.appendChild(option({value: i}));\r\n\t\t}\r\n\t\tthis._effectsSelect.selectedIndex = 0;\r\n\t\tfor (let i: number = 0; i < Config.effectOrder.length; i++) {\r\n\t\t\tlet effectFlag: number = Config.effectOrder[i];\r\n\t\t\tconst selected: boolean = ((instrument.effects & (1 << effectFlag)) != 0);\r\n\t\t\tconst label: string = (selected ? \" \" : \"\") + Config.effectNames[effectFlag];\r\n\t\t\tconst option: HTMLOptionElement = <HTMLOptionElement> this._effectsSelect.children[i + 1];\r\n\t\t\tif (option.textContent != label) option.textContent = label;\r\n\t\t}\r\n\t\t\r\n\t\tsetSelectedValue(this._scaleSelect, this._doc.song.scale);\r\n\t\tthis._scaleSelect.title = Config.scales[this._doc.song.scale].realName;\r\n\t\tsetSelectedValue(this._keySelect, Config.keys.length - 1 - this._doc.song.key);\r\n\t\tthis._tempoSlider.updateValue(Math.max(0, Math.min(28, Math.round(4.0 + 9.0 * Math.log2(this._doc.song.tempo / 120.0)))));\r\n\t\tthis._tempoStepper.value = this._doc.song.tempo.toString();\r\n\t\tsetSelectedValue(this._rhythmSelect, this._doc.song.rhythm);\r\n\t\t\r\n\t\tif (this._doc.song.getChannelIsNoise(this._doc.channel)) {\r\n\t\t\tthis._pitchedPresetSelect.style.display = \"none\";\r\n\t\t\tthis._drumPresetSelect.style.display = \"\";\r\n\t\t\tsetSelectedValue(this._drumPresetSelect, instrument.preset);\r\n\t\t} else {\r\n\t\t\tthis._pitchedPresetSelect.style.display = \"\";\r\n\t\t\tthis._drumPresetSelect.style.display = \"none\";\r\n\t\t\tsetSelectedValue(this._pitchedPresetSelect, instrument.preset);\r\n\t\t}\r\n\t\t\r\n\t\tif (prefs.instrumentCopyPaste) {\r\n\t\t\tthis._instrumentCopyPasteRow.style.display = \"\";\r\n\t\t} else {\r\n\t\t\tthis._instrumentCopyPasteRow.style.display = \"none\";\r\n\t\t}\r\n\t\t\r\n\t\tif (!prefs.alwaysShowSettings && instrument.preset != instrument.type) {\r\n\t\t\tthis._customizeInstrumentButton.style.display = \"\";\r\n\t\t\tthis._customInstrumentSettingsGroup.style.display = \"none\";\r\n\t\t} else {\r\n\t\t\tthis._customizeInstrumentButton.style.display = \"none\";\r\n\t\t\tthis._customInstrumentSettingsGroup.style.display = \"\";\r\n\t\t\t\r\n\t\t\tif (instrument.type == InstrumentType.noise) {\r\n\t\t\t\tthis._chipNoiseSelectRow.style.display = \"\";\r\n\t\t\t\tsetSelectedValue(this._chipNoiseSelect, instrument.chipNoise);\r\n\t\t\t} else {\r\n\t\t\t\tthis._chipNoiseSelectRow.style.display = \"none\";\r\n\t\t\t}\r\n\t\t\tif (instrument.type == InstrumentType.spectrum) {\r\n\t\t\t\tthis._spectrumRow.style.display = \"\";\r\n\t\t\t\tthis._spectrumEditor.render();\r\n\t\t\t} else {\r\n\t\t\t\tthis._spectrumRow.style.display = \"none\";\r\n\t\t\t}\r\n\t\t\tif (instrument.type == InstrumentType.harmonics || instrument.type == InstrumentType.pickedString) {\r\n\t\t\t\tthis._harmonicsRow.style.display = \"\";\r\n\t\t\t\tthis._harmonicsEditor.render();\r\n\t\t\t} else {\r\n\t\t\t\tthis._harmonicsRow.style.display = \"none\";\r\n\t\t\t}\r\n\t\t\tif (instrument.type == InstrumentType.pickedString) {\r\n\t\t\t\tthis._stringSustainRow.style.display = \"\";\r\n\t\t\t\tthis._stringSustainSlider.updateValue(instrument.stringSustain);\r\n\t\t\t\tthis._stringSustainLabel.textContent = Config.enableAcousticSustain ? \"Sustain (\" + Config.sustainTypeNames[instrument.stringSustainType].substring(0,1).toUpperCase() + \"):\" : \"Sustain:\";\r\n\t\t\t} else {\r\n\t\t\t\tthis._stringSustainRow.style.display = \"none\";\r\n\t\t\t}\r\n\t\t\tif (instrument.type == InstrumentType.drumset) {\r\n\t\t\t\tthis._drumsetGroup.style.display = \"\";\r\n\t\t\t\tthis._fadeInOutRow.style.display = \"none\";\r\n\t\t\t\tfor (let i: number = 0; i < Config.drumCount; i++) {\r\n\t\t\t\t\tsetSelectedValue(this._drumsetEnvelopeSelects[i], instrument.drumsetEnvelopes[i]);\r\n\t\t\t\t\tthis._drumsetSpectrumEditors[i].render();\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\tthis._drumsetGroup.style.display = \"none\";\r\n\t\t\t\tthis._fadeInOutRow.style.display = \"\";\r\n\t\t\t\tthis._fadeInOutEditor.render();\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tif (instrument.type == InstrumentType.chip) {\r\n\t\t\t\tthis._chipWaveSelectRow.style.display = \"\";\r\n\t\t\t\tsetSelectedValue(this._chipWaveSelect, instrument.chipWave);\r\n\t\t\t} else {\r\n\t\t\t\tthis._chipWaveSelectRow.style.display = \"none\";\r\n\t\t\t}\r\n\t\t\tif (instrument.type == InstrumentType.fm) {\r\n\t\t\t\tthis._algorithmSelectRow.style.display = \"\";\r\n\t\t\t\tthis._phaseModGroup.style.display = \"\";\r\n\t\t\t\tthis._feedbackRow1.style.display = \"\";\r\n\t\t\t\tthis._feedbackRow2.style.display = \"\";\r\n\t\t\t\tsetSelectedValue(this._algorithmSelect, instrument.algorithm);\r\n\t\t\t\tsetSelectedValue(this._feedbackTypeSelect, instrument.feedbackType);\r\n\t\t\t\tthis._feedbackAmplitudeSlider.updateValue(instrument.feedbackAmplitude);\r\n\t\t\t\tfor (let i: number = 0; i < Config.operatorCount; i++) {\r\n\t\t\t\t\tconst isCarrier: boolean = (i < Config.algorithms[instrument.algorithm].carrierCount);\r\n\t\t\t\t\tthis._operatorRows[i].style.color = isCarrier ? ColorConfig.primaryText : \"\";\r\n\t\t\t\t\tsetSelectedValue(this._operatorFrequencySelects[i], instrument.operators[i].frequency);\r\n\t\t\t\t\tthis._operatorAmplitudeSliders[i].updateValue(instrument.operators[i].amplitude);\r\n\t\t\t\t\tconst operatorName: string = (isCarrier ? \"Voice \" : \"Modulator \") + (i + 1);\r\n\t\t\t\t\tthis._operatorFrequencySelects[i].title = operatorName + \" Frequency\";\r\n\t\t\t\t\tthis._operatorAmplitudeSliders[i].input.title = operatorName + (isCarrier ? \" Volume\" : \" Amplitude\");\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\tthis._algorithmSelectRow.style.display = \"none\";\r\n\t\t\t\tthis._phaseModGroup.style.display = \"none\";\r\n\t\t\t\tthis._feedbackRow1.style.display = \"none\";\r\n\t\t\t\tthis._feedbackRow2.style.display = \"none\";\r\n\t\t\t}\r\n\t\t\tif (instrument.type == InstrumentType.supersaw) {\r\n\t\t\t\tthis._supersawDynamismRow.style.display = \"\";\r\n\t\t\t\tthis._supersawSpreadRow.style.display = \"\";\r\n\t\t\t\tthis._supersawShapeRow.style.display = \"\";\r\n\t\t\t\tthis._supersawDynamismSlider.updateValue(instrument.supersawDynamism);\r\n\t\t\t\tthis._supersawSpreadSlider.updateValue(instrument.supersawSpread);\r\n\t\t\t\tthis._supersawShapeSlider.updateValue(instrument.supersawShape);\r\n\t\t\t} else {\r\n\t\t\t\tthis._supersawDynamismRow.style.display = \"none\";\r\n\t\t\t\tthis._supersawSpreadRow.style.display = \"none\";\r\n\t\t\t\tthis._supersawShapeRow.style.display = \"none\";\r\n\t\t\t}\r\n\t\t\tif (instrument.type == InstrumentType.pwm || instrument.type == InstrumentType.supersaw) {\r\n\t\t\t\tthis._pulseWidthRow.style.display = \"\";\r\n\t\t\t\tthis._pulseWidthSlider.input.title = prettyNumber(getPulseWidthRatio(instrument.pulseWidth) * 100) + \"%\";\r\n\t\t\t\tthis._pulseWidthSlider.updateValue(instrument.pulseWidth);\r\n\t\t\t} else {\r\n\t\t\t\tthis._pulseWidthRow.style.display = \"none\";\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tif (effectsIncludeTransition(instrument.effects)) {\r\n\t\t\t\tthis._transitionRow.style.display = \"\";\r\n\t\t\t\tsetSelectedValue(this._transitionSelect, instrument.transition);\r\n\t\t\t} else {\r\n\t\t\t\tthis._transitionRow.style.display = \"none\";\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tif (effectsIncludeChord(instrument.effects)) {\r\n\t\t\t\tthis._chordSelectRow.style.display = \"\";\r\n\t\t\t\tsetSelectedValue(this._chordSelect, instrument.chord);\r\n\t\t\t} else {\r\n\t\t\t\tthis._chordSelectRow.style.display = \"none\";\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tif (effectsIncludePitchShift(instrument.effects)) {\r\n\t\t\t\tthis._pitchShiftRow.style.display = \"\";\r\n\t\t\t\tthis._pitchShiftSlider.updateValue(instrument.pitchShift);\r\n\t\t\t\tthis._pitchShiftSlider.input.title = (instrument.pitchShift - Config.pitchShiftCenter) + \" semitone(s)\";\r\n\t\t\t\tfor (const marker of this._pitchShiftFifthMarkers) {\r\n\t\t\t\t\tmarker.style.display = prefs.showFifth ? \"\" : \"none\";\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\tthis._pitchShiftRow.style.display = \"none\";\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tif (effectsIncludeDetune(instrument.effects)) {\r\n\t\t\t\tthis._detuneRow.style.display = \"\";\r\n\t\t\t\tthis._detuneSlider.updateValue(instrument.detune);\r\n\t\t\t\tthis._detuneSlider.input.title = (Synth.detuneToCents(instrument.detune - Config.detuneCenter)) + \" cent(s)\";\r\n\t\t\t} else {\r\n\t\t\t\tthis._detuneRow.style.display = \"none\";\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tif (effectsIncludeVibrato(instrument.effects)) {\r\n\t\t\t\tthis._vibratoSelectRow.style.display = \"\";\r\n\t\t\t\tsetSelectedValue(this._vibratoSelect, instrument.vibrato);\r\n\t\t\t} else {\r\n\t\t\t\tthis._vibratoSelectRow.style.display = \"none\";\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tif (effectsIncludeNoteFilter(instrument.effects)) {\r\n\t\t\t\tthis._noteFilterRow.style.display = \"\";\r\n\t\t\t\tthis._noteFilterEditor.render();\r\n\t\t\t} else {\r\n\t\t\t\tthis._noteFilterRow.style.display = \"none\";\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tif (effectsIncludeDistortion(instrument.effects)) {\r\n\t\t\t\tthis._distortionRow.style.display = \"\";\r\n\t\t\t\tthis._distortionSlider.updateValue(instrument.distortion);\r\n\t\t\t} else {\r\n\t\t\t\tthis._distortionRow.style.display = \"none\";\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tif (effectsIncludeBitcrusher(instrument.effects)) {\r\n\t\t\t\tthis._bitcrusherQuantizationRow.style.display = \"\";\r\n\t\t\t\tthis._bitcrusherFreqRow.style.display = \"\";\r\n\t\t\t\tthis._bitcrusherQuantizationSlider.updateValue(instrument.bitcrusherQuantization);\r\n\t\t\t\tthis._bitcrusherFreqSlider.updateValue(instrument.bitcrusherFreq);\r\n\t\t\t} else {\r\n\t\t\t\tthis._bitcrusherQuantizationRow.style.display = \"none\";\r\n\t\t\t\tthis._bitcrusherFreqRow.style.display = \"none\";\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tif (effectsIncludePanning(instrument.effects)) {\r\n\t\t\t\tthis._panSliderRow.style.display = \"\";\r\n\t\t\t\tthis._panSlider.updateValue(instrument.pan);\r\n\t\t\t} else {\r\n\t\t\t\tthis._panSliderRow.style.display = \"none\";\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tif (effectsIncludeChorus(instrument.effects)) {\r\n\t\t\t\tthis._chorusRow.style.display = \"\";\r\n\t\t\t\tthis._chorusSlider.updateValue(instrument.chorus);\r\n\t\t\t} else {\r\n\t\t\t\tthis._chorusRow.style.display = \"none\";\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tif (effectsIncludeEcho(instrument.effects)) {\r\n\t\t\t\tthis._echoSustainRow.style.display = \"\";\r\n\t\t\t\tthis._echoSustainSlider.updateValue(instrument.echoSustain);\r\n\t\t\t\tthis._echoDelayRow.style.display = \"\";\r\n\t\t\t\tthis._echoDelaySlider.updateValue(instrument.echoDelay);\r\n\t\t\t\tthis._echoDelaySlider.input.title = (Math.round((instrument.echoDelay + 1) * Config.echoDelayStepTicks / (Config.ticksPerPart * Config.partsPerBeat) * 1000) / 1000) + \" beat(s)\";\r\n\t\t\t} else {\r\n\t\t\t\tthis._echoSustainRow.style.display = \"none\";\r\n\t\t\t\tthis._echoDelayRow.style.display = \"none\";\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tif (effectsIncludeReverb(instrument.effects)) {\r\n\t\t\t\tthis._reverbRow.style.display = \"\";\r\n\t\t\t\tthis._reverbSlider.updateValue(instrument.reverb);\r\n\t\t\t} else {\r\n\t\t\t\tthis._reverbRow.style.display = \"none\";\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tif (instrument.type == InstrumentType.chip || instrument.type == InstrumentType.harmonics || instrument.type == InstrumentType.pickedString) {\r\n\t\t\t\tthis._unisonSelectRow.style.display = \"\";\r\n\t\t\t\tsetSelectedValue(this._unisonSelect, instrument.unison);\r\n\t\t\t} else {\r\n\t\t\t\tthis._unisonSelectRow.style.display = \"none\";\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tthis._envelopeEditor.render();\r\n\t\t}\r\n\t\t\r\n\t\tfor (let chordIndex: number = 0; chordIndex < Config.chords.length; chordIndex++) {\r\n\t\t\tlet hidden: boolean = (!Config.instrumentTypeHasSpecialInterval[instrument.type] && Config.chords[chordIndex].customInterval);\r\n\t\t\tconst option: Element = this._chordSelect.children[chordIndex];\r\n\t\t\tif (hidden) {\r\n\t\t\t\tif (!option.hasAttribute(\"hidden\")) {\r\n\t\t\t\t\toption.setAttribute(\"hidden\", \"\");\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\toption.removeAttribute(\"hidden\");\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tif (this._doc.song.layeredInstruments || this._doc.song.patternInstruments) {\r\n\t\t\tthis._instrumentsButtonRow.style.display = \"\";\r\n\t\t\t\r\n\t\t\tthis._instrumentsButtonBar.style.setProperty(\"--text-color-lit\", colors.primaryNote);\r\n\t\t\tthis._instrumentsButtonBar.style.setProperty(\"--text-color-dim\", colors.secondaryNote);\r\n\t\t\tthis._instrumentsButtonBar.style.setProperty(\"--background-color-lit\", colors.primaryChannel);\r\n\t\t\tthis._instrumentsButtonBar.style.setProperty(\"--background-color-dim\", colors.secondaryChannel);\r\n\t\t\t\r\n\t\t\tconst maxInstrumentsPerChannel = this._doc.song.getMaxInstrumentsPerChannel();\r\n\t\t\twhile (this._instrumentButtons.length < channel.instruments.length) {\r\n\t\t\t\tconst instrumentButton: HTMLButtonElement = button(String(this._instrumentButtons.length + 1));\r\n\t\t\t\tthis._instrumentButtons.push(instrumentButton);\r\n\t\t\t\tthis._instrumentsButtonBar.insertBefore(instrumentButton, this._instrumentRemoveButton);\r\n\t\t\t}\r\n\t\t\tfor (let i: number = this._renderedInstrumentCount; i < channel.instruments.length; i++) {\r\n\t\t\t\tthis._instrumentButtons[i].style.display = \"\";\r\n\t\t\t}\r\n\t\t\tfor (let i: number = channel.instruments.length; i < this._renderedInstrumentCount; i++) {\r\n\t\t\t\tthis._instrumentButtons[i].style.display = \"none\";\r\n\t\t\t}\r\n\t\t\tthis._renderedInstrumentCount = channel.instruments.length;\r\n\t\t\twhile (this._instrumentButtons.length > maxInstrumentsPerChannel) {\r\n\t\t\t\tthis._instrumentsButtonBar.removeChild(this._instrumentButtons.pop()!);\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tthis._instrumentRemoveButton.style.display = (channel.instruments.length > Config.instrumentCountMin) ? \"\" : \"none\";\r\n\t\t\tthis._instrumentAddButton.style.display = (channel.instruments.length < maxInstrumentsPerChannel) ? \"\" : \"none\";\r\n\t\t\tif (channel.instruments.length < maxInstrumentsPerChannel) {\r\n\t\t\t\tthis._instrumentRemoveButton.classList.remove(\"last-button\");\r\n\t\t\t} else {\r\n\t\t\t\tthis._instrumentRemoveButton.classList.add(\"last-button\");\r\n\t\t\t}\r\n\t\t\tif (channel.instruments.length > 1) {\r\n\t\t\t\tif (this._highlightedInstrumentIndex != instrumentIndex) {\r\n\t\t\t\t\tconst oldButton: HTMLButtonElement = this._instrumentButtons[this._highlightedInstrumentIndex];\r\n\t\t\t\t\tif (oldButton != null) oldButton.classList.remove(\"selected-instrument\");\r\n\t\t\t\t\tconst newButton: HTMLButtonElement = this._instrumentButtons[instrumentIndex];\r\n\t\t\t\t\tnewButton.classList.add(\"selected-instrument\");\r\n\t\t\t\t\tthis._highlightedInstrumentIndex = instrumentIndex;\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\tconst oldButton: HTMLButtonElement = this._instrumentButtons[this._highlightedInstrumentIndex];\r\n\t\t\t\tif (oldButton != null) oldButton.classList.remove(\"selected-instrument\");\r\n\t\t\t\tthis._highlightedInstrumentIndex = -1;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tif (this._doc.song.layeredInstruments && this._doc.song.patternInstruments) {\r\n\t\t\t\t//const pattern: Pattern | null = this._doc.getCurrentPattern();\r\n\t\t\t\tfor (let i: number = 0; i < channel.instruments.length; i++) {\r\n\t\t\t\t\tif (this._doc.recentPatternInstruments[this._doc.channel].indexOf(i) != -1) {\r\n\t\t\t\t\t\tthis._instrumentButtons[i].classList.remove(\"deactivated\");\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tthis._instrumentButtons[i].classList.add(\"deactivated\");\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tthis._deactivatedInstruments = true;\r\n\t\t\t} else if (this._deactivatedInstruments) {\r\n\t\t\t\tfor (let i: number = 0; i < channel.instruments.length; i++) {\r\n\t\t\t\t\tthis._instrumentButtons[i].classList.remove(\"deactivated\");\r\n\t\t\t\t}\r\n\t\t\t\tthis._deactivatedInstruments = false;\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tthis._instrumentsButtonRow.style.display = \"none\";\r\n\t\t}\r\n\t\t\r\n\t\tthis._instrumentSettingsGroup.style.color = colors.primaryNote;\r\n\t\t\r\n\t\tthis._eqFilterEditor.render();\r\n\t\tthis._instrumentVolumeSlider.updateValue(-instrument.volume);\r\n\t\tthis._addEnvelopeButton.disabled = (instrument.envelopeCount >= Config.maxEnvelopeCount);\r\n\t\t\r\n\t\tthis._volumeSlider.value = String(prefs.volume);\r\n\t\t\r\n\t\t// If an interface element was selected, but becomes invisible (e.g. an instrument\r\n\t\t// select menu) just select the editor container so keyboard commands still work.\r\n\t\tif (wasActive && activeElement != null && activeElement.clientWidth == 0) {\r\n\t\t\tthis._refocusStage();\r\n\t\t}\r\n\t\t\r\n\t\tthis._setPrompt(this._doc.prompt);\r\n\t\t\r\n\t\tif (prefs.autoFollow && !this._doc.synth.playing) {\r\n\t\t\tthis._doc.synth.goToBar(this._doc.bar);\r\n\t\t}\r\n\t\t\r\n\t\t// When adding effects or envelopes to an instrument in fullscreen modes,\r\n\t\t// auto-scroll the settings areas to ensure the new settings are visible.\r\n\t\tif (this._doc.addedEffect) {\r\n\t\t\tconst envButtonRect: DOMRect = this._addEnvelopeButton.getBoundingClientRect();\r\n\t\t\tconst instSettingsRect: DOMRect = this._instrumentSettingsArea.getBoundingClientRect();\r\n\t\t\tconst settingsRect: DOMRect = this._settingsArea.getBoundingClientRect();\r\n\t\t\tthis._instrumentSettingsArea.scrollTop += Math.max(0, envButtonRect.top - (instSettingsRect.top + instSettingsRect.height));\r\n\t\t\tthis._settingsArea.scrollTop += Math.max(0, envButtonRect.top - (settingsRect.top + settingsRect.height));\r\n\t\t\tthis._doc.addedEffect = false;\r\n\t\t}\r\n\t\tif (this._doc.addedEnvelope) {\r\n\t\t\tthis._instrumentSettingsArea.scrollTop = this._instrumentSettingsArea.scrollHeight;\r\n\t\t\tthis._settingsArea.scrollTop = this._settingsArea.scrollHeight;\r\n\t\t\tthis._doc.addedEnvelope = false;\r\n\t\t}\r\n\t}\r\n\t\r\n\tpublic updatePlayButton = (): void => {\r\n\t\tif (this._renderedIsPlaying != this._doc.synth.playing || this._renderedIsRecording != this._doc.synth.recording || this._renderedShowRecordButton != this._doc.prefs.showRecordButton || this._renderedCtrlHeld != this._ctrlHeld) {\r\n\t\t\tthis._renderedIsPlaying = this._doc.synth.playing;\r\n\t\t\tthis._renderedIsRecording = this._doc.synth.recording;\r\n\t\t\tthis._renderedShowRecordButton = this._doc.prefs.showRecordButton;\r\n\t\t\tthis._renderedCtrlHeld = this._ctrlHeld;\r\n\t\t\t\r\n\t\t\tif (document.activeElement == this._playButton || document.activeElement == this._pauseButton || document.activeElement == this._recordButton || document.activeElement == this._stopButton) {\r\n\t\t\t\t// When a focused element is hidden, focus is transferred to the document, so let's refocus the editor instead to make sure we can still capture keyboard input.\r\n\t\t\t\tthis._refocusStage();\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tthis._playButton.style.display = \"none\";\r\n\t\t\tthis._pauseButton.style.display = \"none\";\r\n\t\t\tthis._recordButton.style.display = \"none\";\r\n\t\t\tthis._stopButton.style.display = \"none\";\r\n\t\t\tthis._prevBarButton.style.display = \"\";\r\n\t\t\tthis._nextBarButton.style.display = \"\";\r\n\t\t\tthis._playButton.classList.remove(\"shrunk\");\r\n\t\t\tthis._recordButton.classList.remove(\"shrunk\");\r\n\t\t\tthis._patternEditorRow.style.pointerEvents = \"\";\r\n\t\t\tthis._octaveScrollBar.container.style.pointerEvents = \"\";\r\n\t\t\tthis._octaveScrollBar.container.style.opacity = \"\";\r\n\t\t\tthis._trackContainer.style.pointerEvents = \"\";\r\n\t\t\tthis._loopEditor.container.style.opacity = \"\";\r\n\t\t\tthis._instrumentSettingsArea.style.pointerEvents = \"\";\r\n\t\t\tthis._instrumentSettingsArea.style.opacity = \"\";\r\n\t\t\tthis._menuArea.style.pointerEvents = \"\";\r\n\t\t\tthis._menuArea.style.opacity = \"\";\r\n\t\t\tthis._songSettingsArea.style.pointerEvents = \"\";\r\n\t\t\tthis._songSettingsArea.style.opacity = \"\";\r\n\t\t\t\r\n\t\t\tif (this._doc.synth.recording) {\r\n\t\t\t\tthis._stopButton.style.display = \"\";\r\n\t\t\t\tthis._prevBarButton.style.display = \"none\";\r\n\t\t\t\tthis._nextBarButton.style.display = \"none\";\r\n\t\t\t\tthis._patternEditorRow.style.pointerEvents = \"none\";\r\n\t\t\t\tthis._octaveScrollBar.container.style.pointerEvents = \"none\";\r\n\t\t\t\tthis._octaveScrollBar.container.style.opacity = \"0.5\";\r\n\t\t\t\tthis._trackContainer.style.pointerEvents = \"none\";\r\n\t\t\t\tthis._loopEditor.container.style.opacity = \"0.5\";\r\n\t\t\t\tthis._instrumentSettingsArea.style.pointerEvents = \"none\";\r\n\t\t\t\tthis._instrumentSettingsArea.style.opacity = \"0.5\";\r\n\t\t\t\tthis._menuArea.style.pointerEvents = \"none\";\r\n\t\t\t\tthis._menuArea.style.opacity = \"0.5\";\r\n\t\t\t\tthis._songSettingsArea.style.pointerEvents = \"none\";\r\n\t\t\t\tthis._songSettingsArea.style.opacity = \"0.5\";\r\n\t\t\t} else if (this._doc.synth.playing) {\r\n\t\t\t\tthis._pauseButton.style.display = \"\";\r\n\t\t\t} else if (this._doc.prefs.showRecordButton) {\r\n\t\t\t\tthis._playButton.style.display = \"\";\r\n\t\t\t\tthis._recordButton.style.display = \"\";\r\n\t\t\t\tthis._playButton.classList.add(\"shrunk\");\r\n\t\t\t\tthis._recordButton.classList.add(\"shrunk\");\r\n\t\t\t} else if (this._ctrlHeld) {\r\n\t\t\t\tthis._recordButton.style.display = \"\";\r\n\t\t\t} else {\r\n\t\t\t\tthis._playButton.style.display = \"\";\r\n\t\t\t}\r\n\t\t}\r\n\t\twindow.requestAnimationFrame(this.updatePlayButton);\r\n\t}\r\n\t\r\n\tprivate _onTrackAreaScroll = (event: Event): void => {\r\n\t\tthis._doc.barScrollPos = (this._trackAndMuteContainer.scrollLeft / this._doc.getBarWidth());\r\n\t\t//this._doc.notifier.changed();\r\n\t}\r\n\t\r\n\tprivate _disableCtrlContextMenu = (event: MouseEvent): boolean => {\r\n\t\t// On a Mac, clicking while holding control opens the right-click context menu.\r\n\t\t// But in the pattern and track editors I'd rather prevent that and instead allow\r\n\t\t// custom behaviors such as setting the volume of a note.\r\n\t\tif (event.ctrlKey) {\r\n\t\t\tevent.preventDefault();\r\n\t\t\treturn false;\r\n\t\t}\r\n\t\treturn true;\r\n\t}\r\n\t\r\n\tprivate _tempoStepperCaptureNumberKeys = (event: KeyboardEvent): void => {\r\n\t\t// When the number input is in focus, allow some keyboard events to\r\n\t\t// edit the input without accidentally editing the song otherwise.\r\n\t\tswitch (event.keyCode) {\r\n\t\t\tcase 8: // backspace/delete\r\n\t\t\tcase 13: // enter/return\r\n\t\t\tcase 38: // up\r\n\t\t\tcase 40: // down\r\n\t\t\tcase 37: // left\r\n\t\t\tcase 39: // right\r\n\t\t\tcase 48: // 0\r\n\t\t\tcase 49: // 1\r\n\t\t\tcase 50: // 2\r\n\t\t\tcase 51: // 3\r\n\t\t\tcase 52: // 4\r\n\t\t\tcase 53: // 5\r\n\t\t\tcase 54: // 6\r\n\t\t\tcase 55: // 7\r\n\t\t\tcase 56: // 8\r\n\t\t\tcase 57: // 9\r\n\t\t\t\tevent.stopPropagation();\r\n\t\t\t\tbreak;\r\n\t\t}\r\n\t}\r\n\t\r\n\tprivate _whenKeyPressed = (event: KeyboardEvent): void => {\r\n\t\tthis._ctrlHeld = event.ctrlKey;\r\n\t\t\r\n\t\tif (this.prompt) {\r\n\t\t\tif (event.keyCode == 27) { // ESC key\r\n\t\t\t\t// close prompt.\r\n\t\t\t\tthis._doc.undo();\r\n\t\t\t}\r\n\t\t\treturn;\r\n\t\t}\r\n\t\t\r\n\t\tif (this._doc.synth.recording) {\r\n\t\t\t// The only valid keyboard interactions when recording are playing notes or pressing space OR P to stop.\r\n\t\t\tif (!event.ctrlKey && !event.metaKey) {\r\n\t\t\t\tthis._keyboardLayout.handleKeyEvent(event, true);\r\n\t\t\t}\r\n\t\t\tif (event.keyCode == 32) { // space\r\n\t\t\t\tthis._toggleRecord();\r\n\t\t\t\tevent.preventDefault();\r\n\t\t\t\tthis._refocusStage();\r\n\t\t\t} else if (event.keyCode == 80 && (event.ctrlKey || event.metaKey)) { // p\r\n\t\t\t\tthis._toggleRecord();\r\n\t\t\t\tevent.preventDefault();\r\n\t\t\t\tthis._refocusStage();\r\n\t\t\t}\r\n\t\t\treturn;\r\n\t\t}\r\n\t\t\r\n\t\tconst needControlForShortcuts: boolean = (this._doc.prefs.pressControlForShortcuts != event.getModifierState(\"CapsLock\"));\r\n\t\tconst canPlayNotes: boolean = (!event.ctrlKey && !event.metaKey && needControlForShortcuts);\r\n\t\tif (canPlayNotes) this._keyboardLayout.handleKeyEvent(event, true);\r\n\t\t\r\n\t\tswitch (event.keyCode) {\r\n\t\t\tcase 27: // ESC key\r\n\t\t\t\tif (!event.ctrlKey && !event.metaKey) {\r\n\t\t\t\t\tnew ChangePatternSelection(this._doc, 0, 0);\r\n\t\t\t\t\tthis._doc.selection.resetBoxSelection();\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\t\t\tcase 32: // space\r\n\t\t\t\tif (event.ctrlKey) {\r\n\t\t\t\t\tthis._toggleRecord();\r\n\t\t\t\t} else if (event.shiftKey) {\r\n\t\t\t\t\t// Jump to mouse\r\n\t\t\t\t\tif (this._trackEditor.movePlayheadToMouse() || this._patternEditor.movePlayheadToMouse()) {\r\n\t\t\t\t\t\tif (!this._doc.synth.playing) this._doc.performance.play();\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis._togglePlay();\r\n\t\t\t\t}\r\n\t\t\t\tevent.preventDefault();\r\n\t\t\t\tthis._refocusStage();\r\n\t\t\t\tbreak;\r\n\t\t\tcase 80: // p\r\n\t\t\t\tif (canPlayNotes) break;\r\n\t\t\t\tif (event.ctrlKey || event.metaKey) {\r\n\t\t\t\t\tthis._toggleRecord();\r\n\t\t\t\t\tevent.preventDefault();\r\n\t\t\t\t\tthis._refocusStage();\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\t\t\tcase 90: // z\r\n\t\t\t\tif (canPlayNotes) break;\r\n\t\t\t\tif (event.shiftKey) {\r\n\t\t\t\t\tthis._doc.redo();\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis._doc.undo();\r\n\t\t\t\t}\r\n\t\t\t\tevent.preventDefault();\r\n\t\t\t\tbreak;\r\n\t\t\tcase 89: // y\r\n\t\t\t\tif (canPlayNotes) break;\r\n\t\t\t\tthis._doc.redo();\r\n\t\t\t\tevent.preventDefault();\r\n\t\t\t\tbreak;\r\n\t\t\tcase 67: // c\r\n\t\t\t\tif (canPlayNotes) break;\r\n\t\t\t\tif (event.shiftKey) {\r\n\t\t\t\t\tthis._copyInstrument();\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis._doc.selection.copy();\r\n\t\t\t\t}\r\n\t\t\t\tevent.preventDefault();\r\n\t\t\t\tbreak;\r\n\t\t\tcase 13: // enter/return\r\n\t\t\t\tif (event.ctrlKey || event.metaKey) {\r\n\t\t\t\t\tthis._doc.selection.insertChannel();\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis._doc.selection.insertBars();\r\n\t\t\t\t}\r\n\t\t\t\tevent.preventDefault();\r\n\t\t\t\tbreak;\r\n\t\t\tcase 8: // backspace/delete\r\n\t\t\t\tif (event.ctrlKey || event.metaKey) {\r\n\t\t\t\t\tthis._doc.selection.deleteChannel();\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis._doc.selection.deleteBars();\r\n\t\t\t\t}\r\n\t\t\t\tevent.preventDefault();\r\n\t\t\t\tbreak;\r\n\t\t\tcase 65: // a\r\n\t\t\t\tif (canPlayNotes) break;\r\n\t\t\t\tif (event.shiftKey) {\r\n\t\t\t\t\tthis._doc.selection.selectChannel();\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis._doc.selection.selectAll();\r\n\t\t\t\t}\r\n\t\t\t\tevent.preventDefault();\r\n\t\t\t\tbreak;\r\n\t\t\tcase 68: // d\r\n\t\t\t\tif (canPlayNotes) break;\r\n\t\t\t\tif (needControlForShortcuts == (event.ctrlKey || event.metaKey)) {\r\n\t\t\t\t\tthis._doc.selection.duplicatePatterns();\r\n\t\t\t\t\tevent.preventDefault();\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\t\t\tcase 70: // f\r\n\t\t\t\tif (canPlayNotes) break;\r\n\t\t\t\tif (needControlForShortcuts == (event.ctrlKey || event.metaKey)) {\r\n\t\t\t\t\tthis._doc.synth.snapToStart();\r\n\t\t\t\t\tif (this._doc.prefs.autoFollow) {\r\n\t\t\t\t\t\tthis._doc.selection.setChannelBar(this._doc.channel, Math.floor(this._doc.synth.playhead));\r\n\t\t\t\t\t}\r\n\t\t\t\t\tevent.preventDefault();\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\t\t\tcase 72: // h\r\n\t\t\t\tif (canPlayNotes) break;\r\n\t\t\t\tif (needControlForShortcuts == (event.ctrlKey || event.metaKey)) {\r\n\t\t\t\t\tthis._doc.synth.goToBar(this._doc.bar);\r\n\t\t\t\t\tthis._doc.synth.snapToBar();\r\n\t\t\t\t\tif (this._doc.prefs.autoFollow) {\r\n\t\t\t\t\t\tthis._doc.selection.setChannelBar(this._doc.channel, Math.floor(this._doc.synth.playhead));\r\n\t\t\t\t\t}\r\n\t\t\t\t\tevent.preventDefault();\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\t\t\tcase 77: // m\r\n\t\t\t\tif (canPlayNotes) break;\r\n\t\t\t\tif (needControlForShortcuts == (event.ctrlKey || event.metaKey)) {\r\n\t\t\t\t\tif (this._doc.prefs.enableChannelMuting) {\r\n\t\t\t\t\t\tthis._doc.selection.muteChannels(event.shiftKey);\r\n\t\t\t\t\t\tevent.preventDefault();\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\t\t\tcase 81: // q\r\n\t\t\t\tif (canPlayNotes) break;\r\n\t\t\t\tif (needControlForShortcuts == (event.ctrlKey || event.metaKey)) {\r\n\t\t\t\t\tthis._openPrompt(\"channelSettings\");\r\n\t\t\t\t\tevent.preventDefault();\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\t\t\tcase 83: // s\r\n\t\t\t\tif (canPlayNotes) break;\r\n\t\t\t\tif (event.ctrlKey || event.metaKey) {\r\n\t\t\t\t\tthis._openPrompt(\"export\");\r\n\t\t\t\t\tevent.preventDefault();\r\n\t\t\t\t} else {\r\n\t\t\t\t\tif (this._doc.prefs.enableChannelMuting) {\r\n\t\t\t\t\t\tthis._doc.selection.soloChannels(event.shiftKey);\r\n\t\t\t\t\t\tevent.preventDefault();\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\t\t\tcase 79: // o\r\n\t\t\t\tif (canPlayNotes) break;\r\n\t\t\t\tif (event.ctrlKey || event.metaKey) {\r\n\t\t\t\t\tthis._openPrompt(\"import\");\r\n\t\t\t\t\tevent.preventDefault();\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\t\t\tcase 86: // v\r\n\t\t\t\tif (canPlayNotes) break;\r\n\t\t\t\tif ((event.ctrlKey || event.metaKey) && event.shiftKey && !needControlForShortcuts) {\r\n\t\t\t\t\tthis._doc.selection.pasteNumbers();\r\n\t\t\t\t} else if (event.shiftKey) {\r\n\t\t\t\t\tthis._pasteInstrument();\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis._doc.selection.pasteNotes();\r\n\t\t\t\t}\r\n\t\t\t\tevent.preventDefault();\r\n\t\t\t\tbreak;\r\n\t\t\tcase 73: // i\r\n\t\t\t\tif (canPlayNotes) break;\r\n\t\t\t\tif (needControlForShortcuts == (event.ctrlKey || event.metaKey) && event.shiftKey) {\r\n\t\t\t\t\t// Copy the current instrument as a preset to the clipboard.\r\n\t\t\t\t\tconst instrument: Instrument = this._doc.song.channels[this._doc.channel].instruments[this._doc.getCurrentInstrument()];\r\n\t\t\t\t\tconst instrumentObject: any = instrument.toJsonObject();\r\n\t\t\t\t\tdelete instrumentObject[\"preset\"];\r\n\t\t\t\t\t// Volume and the panning effect are not included in presets.\r\n\t\t\t\t\tdelete instrumentObject[\"volume\"];\r\n\t\t\t\t\tdelete instrumentObject[\"pan\"];\r\n\t\t\t\t\tconst panningEffectIndex: number = instrumentObject[\"effects\"].indexOf(Config.effectNames[EffectType.panning]);\r\n\t\t\t\t\tif (panningEffectIndex != -1) instrumentObject[\"effects\"].splice(panningEffectIndex, 1);\r\n\t\t\t\t\tfor (let i: number = 0; i < instrumentObject[\"envelopes\"].length; i++) {\r\n\t\t\t\t\t\tconst envelope: any = instrumentObject[\"envelopes\"][i];\r\n\t\t\t\t\t\t// If there are any envelopes targeting panning or none, remove those too.\r\n\t\t\t\t\t\tif (envelope[\"target\"] == \"panning\" || envelope[\"target\"] == \"none\" || envelope[\"envelope\"] == \"none\") {\r\n\t\t\t\t\t\t\tinstrumentObject[\"envelopes\"].splice(i, 1);\r\n\t\t\t\t\t\t\ti--;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\tthis._copyTextToClipboard(JSON.stringify(instrumentObject));\r\n\t\t\t\t\tevent.preventDefault();\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\t\t\tcase 82: // r\r\n\t\t\t\tif (canPlayNotes) break;\r\n\t\t\t\tif (needControlForShortcuts == (event.ctrlKey || event.metaKey)) {\r\n\t\t\t\t\tif (event.shiftKey) {\r\n\t\t\t\t\t\tthis._randomGenerated();\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tthis._randomPreset();\r\n\t\t\t\t\t}\r\n\t\t\t\t\tevent.preventDefault();\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\t\t\tcase 219: // left brace\r\n\t\t\t\tif (canPlayNotes) break;\r\n\t\t\t\tif (needControlForShortcuts == (event.ctrlKey || event.metaKey)) {\r\n\t\t\t\t\tthis._doc.synth.goToPrevBar();\r\n\t\t\t\t\tif (this._doc.prefs.autoFollow) {\r\n\t\t\t\t\t\tthis._doc.selection.setChannelBar(this._doc.channel, Math.floor(this._doc.synth.playhead));\r\n\t\t\t\t\t}\r\n\t\t\t\t\tevent.preventDefault();\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\t\t\tcase 221: // right brace\r\n\t\t\t\tif (canPlayNotes) break;\r\n\t\t\t\tif (needControlForShortcuts == (event.ctrlKey || event.metaKey)) {\r\n\t\t\t\t\tthis._doc.synth.goToNextBar();\r\n\t\t\t\t\tif (this._doc.prefs.autoFollow) {\r\n\t\t\t\t\t\tthis._doc.selection.setChannelBar(this._doc.channel, Math.floor(this._doc.synth.playhead));\r\n\t\t\t\t\t}\r\n\t\t\t\t\tevent.preventDefault();\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\t\t\tcase 189: // -\r\n\t\t\tcase 173: // Firefox -\r\n\t\t\t\tif (canPlayNotes) break;\r\n\t\t\t\tif (needControlForShortcuts == (event.ctrlKey || event.metaKey)) {\r\n\t\t\t\t\tthis._doc.selection.transpose(false, event.shiftKey);\r\n\t\t\t\t\tevent.preventDefault();\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\t\t\tcase 187: // +\r\n\t\t\tcase 61: // Firefox +\r\n\t\t\tcase 171: // Some users have this as +? Hmm.\r\n\t\t\t\tif (canPlayNotes) break;\r\n\t\t\t\tif (needControlForShortcuts == (event.ctrlKey || event.metaKey)) {\r\n\t\t\t\t\tthis._doc.selection.transpose(true, event.shiftKey);\r\n\t\t\t\t\tevent.preventDefault();\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\t\t\tcase 38: // up\r\n\t\t\t\tif (event.ctrlKey || event.metaKey) {\r\n\t\t\t\t\tthis._doc.selection.swapChannels(-1);\r\n\t\t\t\t} else if (event.shiftKey) {\r\n\t\t\t\t\tthis._doc.selection.boxSelectionY1 = Math.max(0, this._doc.selection.boxSelectionY1 - 1);\r\n\t\t\t\t\tthis._doc.selection.scrollToEndOfSelection();\r\n\t\t\t\t\tthis._doc.selection.selectionUpdated();\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis._doc.selection.setChannelBar((this._doc.channel - 1 + this._doc.song.getChannelCount()) % this._doc.song.getChannelCount(), this._doc.bar);\r\n\t\t\t\t\tthis._doc.selection.resetBoxSelection();\r\n\t\t\t\t}\r\n\t\t\t\tevent.preventDefault();\r\n\t\t\t\tbreak;\r\n\t\t\tcase 40: // down\r\n\t\t\t\tif (event.ctrlKey || event.metaKey) {\r\n\t\t\t\t\tthis._doc.selection.swapChannels(1);\r\n\t\t\t\t} else if (event.shiftKey) {\r\n\t\t\t\t\tthis._doc.selection.boxSelectionY1 = Math.min(this._doc.song.getChannelCount() - 1, this._doc.selection.boxSelectionY1 + 1);\r\n\t\t\t\t\tthis._doc.selection.scrollToEndOfSelection();\r\n\t\t\t\t\tthis._doc.selection.selectionUpdated();\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis._doc.selection.setChannelBar((this._doc.channel + 1) % this._doc.song.getChannelCount(), this._doc.bar);\r\n\t\t\t\t\tthis._doc.selection.resetBoxSelection();\r\n\t\t\t\t}\r\n\t\t\t\tevent.preventDefault();\r\n\t\t\t\tbreak;\r\n\t\t\tcase 37: // left\r\n\t\t\t\tif (event.shiftKey) {\r\n\t\t\t\t\tthis._doc.selection.boxSelectionX1 = Math.max(0, this._doc.selection.boxSelectionX1 - 1);\r\n\t\t\t\t\tthis._doc.selection.scrollToEndOfSelection();\r\n\t\t\t\t\tthis._doc.selection.selectionUpdated();\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis._doc.selection.setChannelBar(this._doc.channel, (this._doc.bar + this._doc.song.barCount - 1) % this._doc.song.barCount);\r\n\t\t\t\t\tthis._doc.selection.resetBoxSelection();\r\n\t\t\t\t}\r\n\t\t\t\tevent.preventDefault();\r\n\t\t\t\tbreak;\r\n\t\t\tcase 39: // right\r\n\t\t\t\tif (event.shiftKey) {\r\n\t\t\t\t\tthis._doc.selection.boxSelectionX1 = Math.min(this._doc.song.barCount - 1, this._doc.selection.boxSelectionX1 + 1);\r\n\t\t\t\t\tthis._doc.selection.scrollToEndOfSelection();\r\n\t\t\t\t\tthis._doc.selection.selectionUpdated();\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis._doc.selection.setChannelBar(this._doc.channel, (this._doc.bar + 1) % this._doc.song.barCount);\r\n\t\t\t\t\tthis._doc.selection.resetBoxSelection();\r\n\t\t\t\t}\r\n\t\t\t\tevent.preventDefault();\r\n\t\t\t\tbreak;\r\n\t\t\tcase 48: // 0\r\n\t\t\t\tif (canPlayNotes) break;\r\n\t\t\t\tif (needControlForShortcuts == (event.ctrlKey || event.metaKey)) {\r\n\t\t\t\t\tthis._doc.selection.nextDigit(\"0\", event.shiftKey);\r\n\t\t\t\t\tevent.preventDefault();\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\t\t\tcase 49: // 1\r\n\t\t\t\tif (canPlayNotes) break;\r\n\t\t\t\tif (needControlForShortcuts == (event.ctrlKey || event.metaKey)) {\r\n\t\t\t\t\tthis._doc.selection.nextDigit(\"1\", event.shiftKey);\r\n\t\t\t\t\tevent.preventDefault();\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\t\t\tcase 50: // 2\r\n\t\t\t\tif (canPlayNotes) break;\r\n\t\t\t\tif (needControlForShortcuts == (event.ctrlKey || event.metaKey)) {\r\n\t\t\t\t\tthis._doc.selection.nextDigit(\"2\", event.shiftKey);\r\n\t\t\t\t\tevent.preventDefault();\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\t\t\tcase 51: // 3\r\n\t\t\t\tif (canPlayNotes) break;\r\n\t\t\t\tif (needControlForShortcuts == (event.ctrlKey || event.metaKey)) {\r\n\t\t\t\t\tthis._doc.selection.nextDigit(\"3\", event.shiftKey);\r\n\t\t\t\t\tevent.preventDefault();\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\t\t\tcase 52: // 4\r\n\t\t\t\tif (canPlayNotes) break;\r\n\t\t\t\tif (needControlForShortcuts == (event.ctrlKey || event.metaKey)) {\r\n\t\t\t\t\tthis._doc.selection.nextDigit(\"4\", event.shiftKey);\r\n\t\t\t\t\tevent.preventDefault();\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\t\t\tcase 53: // 5\r\n\t\t\t\tif (canPlayNotes) break;\r\n\t\t\t\tif (needControlForShortcuts == (event.ctrlKey || event.metaKey)) {\r\n\t\t\t\t\tthis._doc.selection.nextDigit(\"5\", event.shiftKey);\r\n\t\t\t\t\tevent.preventDefault();\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\t\t\tcase 54: // 6\r\n\t\t\t\tif (canPlayNotes) break;\r\n\t\t\t\tif (needControlForShortcuts == (event.ctrlKey || event.metaKey)) {\r\n\t\t\t\t\tthis._doc.selection.nextDigit(\"6\", event.shiftKey);\r\n\t\t\t\t\tevent.preventDefault();\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\t\t\tcase 55: // 7\r\n\t\t\t\tif (canPlayNotes) break;\r\n\t\t\t\tif (needControlForShortcuts == (event.ctrlKey || event.metaKey)) {\r\n\t\t\t\t\tthis._doc.selection.nextDigit(\"7\", event.shiftKey);\r\n\t\t\t\t\tevent.preventDefault();\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\t\t\tcase 56: // 8\r\n\t\t\t\tif (canPlayNotes) break;\r\n\t\t\t\tif (needControlForShortcuts == (event.ctrlKey || event.metaKey)) {\r\n\t\t\t\t\tthis._doc.selection.nextDigit(\"8\", event.shiftKey);\r\n\t\t\t\t\tevent.preventDefault();\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\t\t\tcase 57: // 9\r\n\t\t\t\tif (canPlayNotes) break;\r\n\t\t\t\tif (needControlForShortcuts == (event.ctrlKey || event.metaKey)) {\r\n\t\t\t\t\tthis._doc.selection.nextDigit(\"9\", event.shiftKey);\r\n\t\t\t\t\tevent.preventDefault();\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\t\t\tdefault:\r\n\t\t\t\tthis._doc.selection.digits = \"\";\r\n\t\t\t\tthis._doc.selection.instrumentDigits = \"\";\r\n\t\t\t\tbreak;\r\n\t\t}\r\n\t\t\r\n\t\tif (canPlayNotes) {\r\n\t\t\tthis._doc.selection.digits = \"\";\r\n\t\t\tthis._doc.selection.instrumentDigits = \"\";\r\n\t\t}\r\n\t}\r\n\t\r\n\tprivate _whenKeyReleased = (event: KeyboardEvent): void => {\r\n\t\tthis._ctrlHeld = event.ctrlKey;\r\n\t\t// Release live pitches regardless of control or caps lock so that any pitches played before will get released even if the modifier keys changed.\r\n\t\tthis._keyboardLayout.handleKeyEvent(event, false);\r\n\t}\r\n\t\r\n\tprivate _copyTextToClipboard(text: string): void {\r\n\t\tif (navigator.clipboard && navigator.clipboard.writeText) {\r\n\t\t\tnavigator.clipboard.writeText(text).catch(()=>{\r\n\t\t\t\twindow.prompt(\"Copy to clipboard:\", text);\r\n\t\t\t});\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tconst textField: HTMLTextAreaElement = document.createElement(\"textarea\");\r\n\t\ttextField.textContent = text;\r\n\t\tdocument.body.appendChild(textField);\r\n\t\ttextField.select();\r\n\t\tconst succeeded: boolean = document.execCommand(\"copy\");\r\n\t\ttextField.remove();\r\n\t\tthis._refocusStage();\r\n\t\tif (!succeeded) window.prompt(\"Copy this:\", text);\r\n\t}\r\n\t\r\n\tprivate _whenPrevBarPressed = (): void => {\r\n\t\tthis._doc.synth.goToPrevBar();\r\n\t}\r\n\t\r\n\tprivate _whenNextBarPressed = (): void => {\r\n\t\tthis._doc.synth.goToNextBar();\r\n\t}\r\n\t\r\n\tprivate _togglePlay = (): void => {\r\n\t\tif (this._doc.synth.playing) {\r\n\t\t\tthis._doc.performance.pause();\r\n\t\t} else {\r\n\t\t\tthis._doc.synth.snapToBar();\r\n\t\t\tthis._doc.performance.play();\r\n\t\t}\r\n\t}\r\n\t\r\n\tprivate _toggleRecord = (): void => {\r\n\t\tif (this._doc.synth.playing) {\r\n\t\t\tthis._doc.performance.pause();\r\n\t\t} else {\r\n\t\t\tthis._doc.performance.record();\r\n\t\t}\r\n\t}\r\n\t\r\n\tprivate _setVolumeSlider = (): void => {\r\n\t\tthis._doc.setVolume(Number(this._volumeSlider.value));\r\n\t}\r\n\t\r\n\tprivate _copyInstrument = (): void => {\r\n\t\tconst channel: Channel = this._doc.song.channels[this._doc.channel];\r\n\t\tconst instrument: Instrument = channel.instruments[this._doc.getCurrentInstrument()];\r\n\t\tconst instrumentCopy: any = instrument.toJsonObject();\r\n\t\tinstrumentCopy[\"isDrum\"] = this._doc.song.getChannelIsNoise(this._doc.channel);\r\n\t\twindow.localStorage.setItem(\"instrumentCopy\", JSON.stringify(instrumentCopy));\r\n\t\tthis._refocusStage();\r\n\t}\r\n\t\r\n\tprivate _pasteInstrument = (): void => {\r\n\t\tconst channel: Channel = this._doc.song.channels[this._doc.channel];\r\n\t\tconst instrument: Instrument = channel.instruments[this._doc.getCurrentInstrument()];\r\n\t\tconst instrumentCopy: any = JSON.parse(String(window.localStorage.getItem(\"instrumentCopy\")));\r\n\t\tif (instrumentCopy != null && instrumentCopy[\"isDrum\"] == this._doc.song.getChannelIsNoise(this._doc.channel)) {\r\n\t\t\tthis._doc.record(new ChangePasteInstrument(this._doc, instrument, instrumentCopy));\r\n\t\t}\r\n\t\tthis._refocusStage();\r\n\t}\r\n\t\r\n\tprivate _randomPreset(): void {\r\n\t\tconst isNoise: boolean = this._doc.song.getChannelIsNoise(this._doc.channel);\r\n\t\tthis._doc.record(new ChangePreset(this._doc, pickRandomPresetValue(isNoise)));\r\n\t}\r\n\t\r\n\tprivate _randomGenerated(): void {\r\n\t\tthis._doc.record(new ChangeRandomGeneratedInstrument(this._doc));\r\n\t}\r\n\t\r\n\tprivate _whenSetTempo = (): void => {\r\n\t\tthis._doc.record(new ChangeTempo(this._doc, -1, parseInt(this._tempoStepper.value) | 0));\r\n\t}\r\n\t\r\n\tprivate _whenSetScale = (): void => {\r\n\t\tif (isNaN(<number> <unknown> this._scaleSelect.value)) {\r\n\t\t\tswitch (this._scaleSelect.value) {\r\n\t\t\t\tcase \"forceScale\":\r\n\t\t\t\t\tthis._doc.selection.forceScale();\r\n\t\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t\tthis._doc.notifier.changed();\r\n\t\t} else {\r\n\t\t\tthis._doc.record(new ChangeScale(this._doc, this._scaleSelect.selectedIndex));\r\n\t\t}\r\n\t}\r\n\t\r\n\tprivate _whenSetKey = (): void => {\r\n\t\tif (isNaN(<number> <unknown> this._keySelect.value)) {\r\n\t\t\tswitch (this._keySelect.value) {\r\n\t\t\t\tcase \"detectKey\":\r\n\t\t\t\t\tthis._doc.record(new ChangeDetectKey(this._doc));\r\n\t\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t\tthis._doc.notifier.changed();\r\n\t\t} else {\r\n\t\t\tthis._doc.record(new ChangeKey(this._doc, Config.keys.length - 1 - this._keySelect.selectedIndex));\r\n\t\t}\r\n\t}\r\n\t\r\n\tprivate _whenSetRhythm = (): void => {\r\n\t\tif (isNaN(<number> <unknown> this._rhythmSelect.value)) {\r\n\t\t\tswitch (this._rhythmSelect.value) {\r\n\t\t\t\tcase \"forceRhythm\":\r\n\t\t\t\t\tthis._doc.selection.forceRhythm();\r\n\t\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t\tthis._doc.notifier.changed();\r\n\t\t} else {\r\n\t\t\tthis._doc.record(new ChangeRhythm(this._doc, this._rhythmSelect.selectedIndex));\r\n\t\t}\r\n\t}\r\n\t\r\n\tprivate _whenSetPitchedPreset = (): void => {\r\n\t\tthis._setPreset(this._pitchedPresetSelect.value);\r\n\t}\r\n\t\r\n\tprivate _whenSetDrumPreset = (): void => {\r\n\t\tthis._setPreset(this._drumPresetSelect.value);\r\n\t}\r\n\t\r\n\tprivate _setPreset(preset: string): void {\r\n\t\tif (isNaN(<number> <unknown> preset)) {\r\n\t\t\tswitch (preset) {\r\n\t\t\t\tcase \"copyInstrument\":\r\n\t\t\t\t\tthis._copyInstrument();\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase \"pasteInstrument\":\r\n\t\t\t\t\tthis._pasteInstrument();\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase \"randomPreset\":\r\n\t\t\t\t\tthis._randomPreset();\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase \"randomGenerated\":\r\n\t\t\t\t\tthis._randomGenerated();\r\n\t\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t\tthis._doc.notifier.changed();\r\n\t\t} else {\r\n\t\t\tthis._doc.record(new ChangePreset(this._doc, parseInt(preset)));\r\n\t\t}\r\n\t}\r\n\t\r\n\tprivate _whenSetFeedbackType = (): void => {\r\n\t\tthis._doc.record(new ChangeFeedbackType(this._doc, this._feedbackTypeSelect.selectedIndex));\r\n\t}\r\n\t\r\n\tprivate _whenSetAlgorithm = (): void => {\r\n\t\tthis._doc.record(new ChangeAlgorithm(this._doc, this._algorithmSelect.selectedIndex));\r\n\t}\r\n\t\r\n\tprivate _whenSelectInstrument = (event: MouseEvent): void => {\r\n\t\tif (event.target == this._instrumentAddButton) {\r\n\t\t\tthis._doc.record(new ChangeAddChannelInstrument(this._doc));\r\n\t\t} else if (event.target == this._instrumentRemoveButton) {\r\n\t\t\tthis._doc.record(new ChangeRemoveChannelInstrument(this._doc));\r\n\t\t} else {\r\n\t\t\tconst index: number = this._instrumentButtons.indexOf(<any>event.target);\r\n\t\t\tif (index != -1) {\r\n\t\t\t\tthis._doc.selection.selectInstrument(index);\r\n\t\t\t}\r\n\t\t}\r\n\t\tthis._refocusStage();\r\n\t}\r\n\t\r\n\tprivate _whenCustomizePressed = (): void => {\r\n\t\tthis._doc.record(new ChangeCustomizeInstrument(this._doc));\r\n\t}\r\n\t\r\n\tprivate _whenSetChipWave = (): void => {\r\n\t\tthis._doc.record(new ChangeChipWave(this._doc, this._chipWaveSelect.selectedIndex));\r\n\t}\r\n\t\r\n\tprivate _whenSetNoiseWave = (): void => {\r\n\t\tthis._doc.record(new ChangeNoiseWave(this._doc, this._chipNoiseSelect.selectedIndex));\r\n\t}\r\n\tprivate _whenSetTransition = (): void => {\r\n\t\tthis._doc.record(new ChangeTransition(this._doc, this._transitionSelect.selectedIndex));\r\n\t}\r\n\t\r\n\tprivate _whenSetEffects = (): void => {\r\n\t\tconst instrument: Instrument = this._doc.song.channels[this._doc.channel].instruments[this._doc.getCurrentInstrument()];\r\n\t\tconst oldValue: number = instrument.effects;\r\n\t\tconst toggleFlag: number = Config.effectOrder[this._effectsSelect.selectedIndex - 1];\r\n\t\tthis._doc.record(new ChangeToggleEffects(this._doc, toggleFlag));\r\n\t\tthis._effectsSelect.selectedIndex = 0;\r\n\t\tif (instrument.effects > oldValue) {\r\n\t\t\tthis._doc.addedEffect = true;\r\n\t\t}\r\n\t}\r\n\t\r\n\tprivate _whenSetVibrato = (): void => {\r\n\t\tthis._doc.record(new ChangeVibrato(this._doc, this._vibratoSelect.selectedIndex));\r\n\t}\r\n\t\r\n\tprivate _whenSetUnison = (): void => {\r\n\t\tthis._doc.record(new ChangeUnison(this._doc, this._unisonSelect.selectedIndex));\r\n\t}\r\n\t\r\n\tprivate _whenSetChord = (): void => {\r\n\t\tthis._doc.record(new ChangeChord(this._doc, this._chordSelect.selectedIndex));\r\n\t}\r\n\t\r\n\tprivate _addNewEnvelope = (): void => {\r\n\t\tthis._doc.record(new ChangeAddEnvelope(this._doc));\r\n\t\tthis._refocusStage();\r\n\t\tthis._doc.addedEnvelope = true;\r\n\t}\r\n\t\r\n\tprivate _zoomIn = (): void => {\r\n\t\tthis._doc.prefs.visibleOctaves = Math.max(1, this._doc.prefs.visibleOctaves - 1);\r\n\t\tthis._doc.prefs.save();\r\n\t\tthis._doc.notifier.changed();\r\n\t\tthis._refocusStage();\r\n\t}\r\n\t\r\n\tprivate _zoomOut = (): void => {\r\n\t\tthis._doc.prefs.visibleOctaves = Math.min(Config.pitchOctaves, this._doc.prefs.visibleOctaves + 1);\r\n\t\tthis._doc.prefs.save();\r\n\t\tthis._doc.notifier.changed();\r\n\t\tthis._refocusStage();\r\n\t}\r\n\t\r\n\tprivate _fileMenuHandler = (event:Event): void => {\r\n\t\tswitch (this._fileMenu.value) {\r\n\t\t\tcase \"new\":\r\n\t\t\t\tthis._doc.goBackToStart();\r\n\t\t\t\tfor (const channel of this._doc.song.channels) channel.muted = false;\r\n\t\t\t\tthis._doc.record(new ChangeSong(this._doc, \"\"), false, true);\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"export\":\r\n\t\t\t\tthis._openPrompt(\"export\");\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"import\":\r\n\t\t\t\tthis._openPrompt(\"import\");\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"copyUrl\":\r\n\t\t\t\tthis._copyTextToClipboard(new URL(\"#\" + this._doc.song.toBase64String(), location.href).href);\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"shareUrl\":\r\n\t\t\t\t(<any>navigator).share({ url: new URL(\"#\" + this._doc.song.toBase64String(), location.href).href });\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"shortenUrl\":\r\n\t\t\t\twindow.open(\"https://tinyurl.com/api-create.php?url=\" + encodeURIComponent(new URL(\"#\" + this._doc.song.toBase64String(), location.href).href));\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"viewPlayer\":\r\n\t\t\t\tlocation.href = \"player/#song=\" + this._doc.song.toBase64String();\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"copyEmbed\":\r\n\t\t\t\tthis._copyTextToClipboard(`<iframe width=\"384\" height=\"60\" style=\"border: none;\" src=\"${new URL(\"player/#song=\" + this._doc.song.toBase64String(), location.href).href}\"></iframe>`);\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"songRecovery\":\r\n\t\t\t\tthis._openPrompt(\"songRecovery\");\r\n\t\t\t\tbreak;\r\n\t\t}\r\n\t\tthis._fileMenu.selectedIndex = 0;\r\n\t}\r\n\t\r\n\tprivate _editMenuHandler = (event:Event): void => {\r\n\t\tswitch (this._editMenu.value) {\r\n\t\t\tcase \"undo\":\r\n\t\t\t\tthis._doc.undo();\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"redo\":\r\n\t\t\t\tthis._doc.redo();\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"copy\":\r\n\t\t\t\tthis._doc.selection.copy();\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"insertBars\":\r\n\t\t\t\tthis._doc.selection.insertBars();\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"deleteBars\":\r\n\t\t\t\tthis._doc.selection.deleteBars();\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"insertChannel\":\r\n\t\t\t\tthis._doc.selection.insertChannel();\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"deleteChannel\":\r\n\t\t\t\tthis._doc.selection.deleteChannel();\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"pasteNotes\":\r\n\t\t\t\tthis._doc.selection.pasteNotes();\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"pasteNumbers\":\r\n\t\t\t\tthis._doc.selection.pasteNumbers();\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"transposeUp\":\r\n\t\t\t\tthis._doc.selection.transpose(true, false);\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"transposeDown\":\r\n\t\t\t\tthis._doc.selection.transpose(false, false);\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"selectAll\":\r\n\t\t\t\tthis._doc.selection.selectAll();\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"selectChannel\":\r\n\t\t\t\tthis._doc.selection.selectChannel();\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"duplicatePatterns\":\r\n\t\t\t\tthis._doc.selection.duplicatePatterns();\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"barCount\":\r\n\t\t\t\tthis._openPrompt(\"barCount\");\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"beatsPerBar\":\r\n\t\t\t\tthis._openPrompt(\"beatsPerBar\");\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"moveNotesSideways\":\r\n\t\t\t\tthis._openPrompt(\"moveNotesSideways\");\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"channelSettings\":\r\n\t\t\t\tthis._openPrompt(\"channelSettings\");\r\n\t\t\t\tbreak;\r\n\t\t}\r\n\t\tthis._editMenu.selectedIndex = 0;\r\n\t}\r\n\t\r\n\tprivate _optionsMenuHandler = (event:Event): void => {\r\n\t\tswitch (this._optionsMenu.value) {\r\n\t\t\tcase \"autoPlay\":\r\n\t\t\t\tthis._doc.prefs.autoPlay = !this._doc.prefs.autoPlay;\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"autoFollow\":\r\n\t\t\t\tthis._doc.prefs.autoFollow = !this._doc.prefs.autoFollow;\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"enableNotePreview\":\r\n\t\t\t\tthis._doc.prefs.enableNotePreview = !this._doc.prefs.enableNotePreview;\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"showLetters\":\r\n\t\t\t\tthis._doc.prefs.showLetters = !this._doc.prefs.showLetters;\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"showFifth\":\r\n\t\t\t\tthis._doc.prefs.showFifth = !this._doc.prefs.showFifth;\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"notesOutsideScale\":\r\n\t\t\t\tthis._doc.prefs.notesOutsideScale = !this._doc.prefs.notesOutsideScale;\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"setDefaultScale\":\r\n\t\t\t\tthis._doc.prefs.defaultScale = this._doc.song.scale;\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"showChannels\":\r\n\t\t\t\tthis._doc.prefs.showChannels = !this._doc.prefs.showChannels;\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"showScrollBar\":\r\n\t\t\t\tthis._doc.prefs.showScrollBar = !this._doc.prefs.showScrollBar;\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"alwaysShowSettings\":\r\n\t\t\t\tthis._doc.prefs.alwaysShowSettings = !this._doc.prefs.alwaysShowSettings;\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"instrumentCopyPaste\":\r\n\t\t\t\tthis._doc.prefs.instrumentCopyPaste = !this._doc.prefs.instrumentCopyPaste;\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"enableChannelMuting\":\r\n\t\t\t\tthis._doc.prefs.enableChannelMuting = !this._doc.prefs.enableChannelMuting;\r\n\t\t\t\tfor (const channel of this._doc.song.channels) channel.muted = false;\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"displayBrowserUrl\":\r\n\t\t\t\tthis._doc.toggleDisplayBrowserUrl();\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"layout\":\r\n\t\t\t\tthis._openPrompt(\"layout\");\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"colorTheme\":\r\n\t\t\t\tthis._openPrompt(\"colorTheme\");\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"recordingSetup\":\r\n\t\t\t\tthis._openPrompt(\"recordingSetup\");\r\n\t\t\t\tbreak;\r\n\t\t}\r\n\t\tthis._optionsMenu.selectedIndex = 0;\r\n\t\tthis._doc.notifier.changed();\r\n\t\tthis._doc.prefs.save();\r\n\t}\r\n}\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nimport {Config} from \"../synth/SynthConfig\";\r\nimport {Note, Pattern} from \"../synth/synth\";\r\nimport {SongDocument} from \"./SongDocument\";\r\nimport {ChangeGroup} from \"./Change\";\r\nimport {ChangeChannelBar, ChangePinTime, ChangeEnsurePatternExists, ChangeNoteAdded, ChangeInsertBars, ChangeDeleteBars, ChangeNoteLength} from \"./changes\";\r\n\r\nexport class SongPerformance {\r\n\tprivate _channelIsDrum: boolean = false;\r\n\tprivate _channelOctave: number = -1;\r\n\tprivate _songKey: number = -1;\r\n\tprivate _pitchesAreTemporary: boolean = false;\r\n\tprivate readonly _recentlyAddedPitches: number[] = []; // Pitches that are rapidly added then removed within a minimum rhythm duration wouldn't get recorded until I explicitly track recently added notes and check if any are no longer held.\r\n\t\r\n\tprivate _songLengthWhenRecordingStarted: number = -1;\r\n\tprivate _playheadPart: number = -1;\r\n\tprivate _playheadPattern: Pattern | null = null;\r\n\tprivate _pitchesChanged: boolean = false;\r\n\tprivate _lastNote: Note | null = null;\r\n\tprivate _recordingChange: ChangeGroup | null = null;\r\n\t\r\n\tconstructor(private _doc: SongDocument) {\r\n\t\tthis._doc.notifier.watch(this._documentChanged);\r\n\t\tthis._documentChanged();\r\n\t\twindow.requestAnimationFrame(this._onAnimationFrame);\r\n\t}\r\n\t\r\n\tpublic play(): void {\r\n\t\tthis._doc.synth.play();\r\n\t\tthis._doc.synth.enableMetronome = false;\r\n\t\tthis._doc.synth.countInMetronome = false\r\n\t\tthis._doc.synth.maintainLiveInput();\r\n\t}\r\n\t\r\n\tpublic pause(): void {\r\n\t\tthis.clearAllPitches();\r\n\t\tif (this._recordingChange != null) {\r\n\t\t\tif (this._doc.song.barCount > this._songLengthWhenRecordingStarted && !this._lastBarHasPatterns()) {\r\n\t\t\t\t// If an extra empty bar was added in case it was needed for recording, but it didn't end up getting used, delete it now.\r\n\t\t\t\tnew ChangeDeleteBars(this._doc, this._doc.song.barCount - 1, 1);\r\n\t\t\t\tnew ChangeChannelBar(this._doc, this._doc.channel, this._doc.song.barCount - 1);\r\n\t\t\t}\r\n\t\t\tif (!this._recordingChange.isNoop()) {\r\n\t\t\t\tthis._doc.record(this._recordingChange);\r\n\t\t\t\tthis._recordingChange = null;\r\n\t\t\t}\r\n\t\t\tthis._lastNote = null;\r\n\t\t}\r\n\t\tthis._doc.synth.pause();\r\n\t\tthis._doc.synth.resetEffects();\r\n\t\tthis._doc.synth.enableMetronome = false;\r\n\t\tthis._doc.synth.countInMetronome = false\r\n\t\tif (this._doc.prefs.autoFollow) {\r\n\t\t\tthis._doc.synth.goToBar(this._doc.bar);\r\n\t\t}\r\n\t\tthis._doc.synth.snapToBar();\r\n\t}\r\n\t\r\n\tpublic record(): void {\r\n\t\tthis._doc.synth.snapToBar();\r\n\t\tconst playheadBar: number = Math.floor(this._doc.synth.playhead);\r\n\t\tif (playheadBar != this._doc.bar) {\r\n\t\t\tnew ChangeChannelBar(this._doc, this._doc.channel, playheadBar);\r\n\t\t}\r\n\t\tif (this._pitchesAreTemporary) {\r\n\t\t\tthis.clearAllPitches();\r\n\t\t\tthis._pitchesAreTemporary = false;\r\n\t\t}\r\n\t\tthis._doc.synth.enableMetronome = this._doc.prefs.metronomeWhileRecording;\r\n\t\tthis._doc.synth.countInMetronome = this._doc.prefs.metronomeCountIn;\r\n\t\tthis._doc.synth.startRecording();\r\n\t\tthis._doc.synth.maintainLiveInput();\r\n\t\tthis._songLengthWhenRecordingStarted = this._doc.song.barCount;\r\n\t\tthis._playheadPart = this._getCurrentPlayheadPart();\r\n\t\tthis._playheadPattern = null;\r\n\t\tthis._pitchesChanged = false;\r\n\t\tthis._lastNote = null;\r\n\t\tthis._recentlyAddedPitches.length = 0;\r\n\t\tthis._recordingChange = new ChangeGroup();\r\n\t\tthis._doc.setProspectiveChange(this._recordingChange);\r\n\t}\r\n\t\r\n\tpublic abortRecording(): void {\r\n\t\tthis._recordingChange = null;\r\n\t\tthis.pause();\r\n\t}\r\n\t\r\n\tpublic pitchesAreTemporary(): boolean {\r\n\t\treturn this._pitchesAreTemporary;\r\n\t}\r\n\t\r\n\tprivate _getMinDivision(): number {\r\n\t\tif (this._doc.prefs.snapRecordedNotesToRhythm) {\r\n\t\t\treturn Config.partsPerBeat / Config.rhythms[this._doc.song.rhythm].stepsPerBeat;\r\n\t\t} else {\r\n\t\t\treturn 1;\r\n\t\t}\r\n\t}\r\n\t\r\n\tprivate _getCurrentPlayheadPart(): number {\r\n\t\tconst currentPart: number = this._doc.synth.playhead * this._doc.song.beatsPerBar * Config.partsPerBeat;\r\n\t\tif (this._doc.prefs.snapRecordedNotesToRhythm) {\r\n\t\t\tconst minDivision: number = this._getMinDivision();\r\n\t\t\treturn Math.round(currentPart / minDivision) * minDivision;\r\n\t\t}\r\n\t\treturn Math.round(currentPart);\r\n\t}\r\n\t\r\n\tprivate _lastBarHasPatterns(): boolean {\r\n\t\tfor (let channelIndex: number = 0; channelIndex < this._doc.song.getChannelCount(); channelIndex++) {\r\n\t\t\tif (this._doc.song.channels[channelIndex].bars[this._doc.song.barCount - 1] != 0) return true;\r\n\t\t}\r\n\t\treturn false;\r\n\t}\r\n\t\r\n\tprivate _onAnimationFrame = (): void => {\r\n\t\twindow.requestAnimationFrame(this._onAnimationFrame);\r\n\t\tif (this._doc.synth.recording) {\r\n\t\t\tconst dirty = this._updateRecordedNotes();\r\n\t\t\tif (dirty) {\r\n\t\t\t\t// The full interface is usually only rerendered in response to user input events, not animation events, but in this case go ahead and rerender everything.\r\n\t\t\t\tthis._doc.notifier.notifyWatchers();\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\t\r\n\t// Returns true if the full interface needs to be rerendered.\r\n\tprivate _updateRecordedNotes(): boolean {\r\n\t\tif (this._recordingChange == null) return false;\r\n\t\tif (!this._doc.lastChangeWas(this._recordingChange)) {\r\n\t\t\tthis.abortRecording();\r\n\t\t\treturn false;\r\n\t\t}\r\n\t\tif (this._doc.synth.countInMetronome) {\r\n\t\t\t// If the synth is still counting in before recording, discard any recently added pitches.\r\n\t\t\tthis._recentlyAddedPitches.length = 0;\r\n\t\t\tthis._pitchesChanged = false;\r\n\t\t\treturn false;\r\n\t\t}\r\n\t\t\r\n\t\tconst partsPerBar: number = this._doc.song.beatsPerBar * Config.partsPerBeat;\r\n\t\tconst oldPart: number = this._playheadPart % partsPerBar;\r\n\t\tconst oldBar: number = Math.floor(this._playheadPart / partsPerBar);\r\n\t\tconst oldPlayheadPart: number = this._playheadPart;\r\n\t\tthis._playheadPart = this._getCurrentPlayheadPart();\r\n\t\tconst newPart: number = this._playheadPart % partsPerBar;\r\n\t\tconst newBar: number = Math.floor(this._playheadPart / partsPerBar);\r\n\t\tif (oldPart == newPart && oldBar == newBar) return false;\r\n\t\tif (this._playheadPart < oldPlayheadPart) {\r\n\t\t\tthis._lastNote = null;\r\n\t\t\tthis._playheadPattern = null;\r\n\t\t\treturn false;\r\n\t\t}\r\n\t\t\r\n\t\tlet dirty = false;\r\n\t\tfor (let bar: number = oldBar; bar <= newBar; bar++) {\r\n\t\t\tif (bar != oldBar) this._playheadPattern = null;\r\n\t\t\tconst startPart: number = (bar == oldBar) ? oldPart : 0;\r\n\t\t\tconst endPart: number = (bar == newBar) ? newPart : partsPerBar;\r\n\t\t\tif (startPart == endPart) break;\r\n\t\t\tif (this._lastNote != null && !this._pitchesChanged && startPart > 0 && this._doc.synth.liveInputPitches.length > 0) {\r\n\t\t\t\tthis._recordingChange.append(new ChangePinTime(this._doc, this._lastNote, 1, endPart, this._lastNote.continuesLastPattern));\r\n\t\t\t\t// Instead of updating the entire interface when extending the last note, just update the current pattern as a special case to avoid doing too much work every frame since performance is important while recording.\r\n\t\t\t\tthis._doc.currentPatternIsDirty = true;\r\n\t\t\t} else {\r\n\t\t\t\tif (this._lastNote != null) {\r\n\t\t\t\t\t// End the last note.\r\n\t\t\t\t\tthis._lastNote = null;\r\n\t\t\t\t}\r\n\t\t\t\t// All current pitches will usually fill the time span from startPart to endPart, but\r\n\t\t\t\t// if any recent pitches were released before being recorded, they'll get recorded here\r\n\t\t\t\t// as short as possible and then any remaining time will be dedicated to pitches that\r\n\t\t\t\t// haven't been released yet.\r\n\t\t\t\tlet noteStartPart: number = startPart;\r\n\t\t\t\tlet noteEndPart: number = endPart;\r\n\t\t\t\twhile (noteStartPart < endPart) {\r\n\t\t\t\t\tlet addedAlreadyReleasedPitch: boolean = false;\r\n\t\t\t\t\tif (this._recentlyAddedPitches.length > 0 || this._doc.synth.liveInputPitches.length > 0) {\r\n\t\t\t\t\t\tif (this._playheadPattern == null) {\r\n\t\t\t\t\t\t\tthis._doc.selection.erasePatternInBar(this._recordingChange, this._doc.synth.liveInputChannel, bar);\r\n\t\t\t\t\t\t\tthis._recordingChange.append(new ChangeEnsurePatternExists(this._doc, this._doc.synth.liveInputChannel, bar));\r\n\t\t\t\t\t\t\tthis._playheadPattern = this._doc.song.getPattern(this._doc.synth.liveInputChannel, bar);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif (this._playheadPattern == null) throw new Error();\r\n\t\t\t\t\t\tthis._lastNote = new Note(-1, noteStartPart, noteEndPart, Config.noteSizeMax, this._doc.song.getChannelIsNoise(this._doc.synth.liveInputChannel));\r\n\t\t\t\t\t\tthis._lastNote.continuesLastPattern = (noteStartPart == 0 && !this._pitchesChanged);\r\n\t\t\t\t\t\tthis._lastNote.pitches.length = 0;\r\n\t\t\t\t\t\twhile (this._recentlyAddedPitches.length > 0) {\r\n\t\t\t\t\t\t\tif (this._lastNote.pitches.length >= Config.maxChordSize) break;\r\n\t\t\t\t\t\t\tconst recentPitch: number = this._recentlyAddedPitches.shift()!;\r\n\t\t\t\t\t\t\tif (this._doc.synth.liveInputPitches.indexOf(recentPitch) == -1) {\r\n\t\t\t\t\t\t\t\tthis._lastNote.pitches.push(recentPitch);\r\n\t\t\t\t\t\t\t\taddedAlreadyReleasedPitch = true;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tfor (let i: number = 0; i < this._doc.synth.liveInputPitches.length; i++) {\r\n\t\t\t\t\t\t\tif (this._lastNote.pitches.length >= Config.maxChordSize) break;\r\n\t\t\t\t\t\t\tthis._lastNote.pitches.push(this._doc.synth.liveInputPitches[i]);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tthis._recordingChange.append(new ChangeNoteAdded(this._doc, this._playheadPattern, this._lastNote, this._playheadPattern.notes.length));\r\n\t\t\t\t\t\tif (addedAlreadyReleasedPitch) {\r\n\t\t\t\t\t\t\t// If this note contains pitches that were already released, shorten it and start a new note.\r\n\t\t\t\t\t\t\tnoteEndPart = noteStartPart + this._getMinDivision();\r\n\t\t\t\t\t\t\tnew ChangeNoteLength(this._doc, this._lastNote, this._lastNote.start, noteEndPart);\r\n\t\t\t\t\t\t\tthis._lastNote = null;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tdirty = true;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tthis._pitchesChanged = addedAlreadyReleasedPitch;\r\n\t\t\t\t\tnoteStartPart = noteEndPart;\r\n\t\t\t\t\tnoteEndPart = endPart;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tif (bar == this._doc.song.barCount - 1) {\r\n\t\t\t\tif (this._lastBarHasPatterns()) {\r\n\t\t\t\t\tnew ChangeInsertBars(this._doc, this._doc.song.barCount, 1);\r\n\t\t\t\t\tthis._doc.bar--; // To counteract it increasing in ChangeInsertBars.\r\n\t\t\t\t\tdirty = true;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn dirty;\r\n\t}\r\n\t\r\n\tpublic setTemporaryPitches(pitches: number[], duration: number): void {\r\n\t\tthis._updateRecordedNotes();\r\n\t\tfor (let i: number = 0; i < pitches.length; i++) {\r\n\t\t\tthis._doc.synth.liveInputPitches[i] = pitches[i];\r\n\t\t}\r\n\t\tthis._doc.synth.liveInputPitches.length = Math.min(pitches.length, Config.maxChordSize);\r\n\t\tthis._doc.synth.liveInputDuration = duration;\r\n\t\tthis._doc.synth.liveInputStarted = true;\r\n\t\tthis._pitchesAreTemporary = true;\r\n\t\tthis._pitchesChanged = true;\r\n\t}\r\n\t\r\n\tpublic addPerformedPitch(pitch: number): void {\r\n\t\tthis._doc.synth.maintainLiveInput();\r\n\t\tthis._updateRecordedNotes();\r\n\t\tif (this._pitchesAreTemporary) {\r\n\t\t\tthis.clearAllPitches();\r\n\t\t\tthis._pitchesAreTemporary = false;\r\n\t\t}\r\n\t\tif (this._doc.prefs.ignorePerformedNotesNotInScale && !Config.scales[this._doc.song.scale].flags[pitch % Config.pitchesPerOctave]) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tif (this._doc.synth.liveInputPitches.indexOf(pitch) == -1) {\r\n\t\t\tthis._doc.synth.liveInputPitches.push(pitch);\r\n\t\t\tthis._pitchesChanged = true;\r\n\t\t\twhile (this._doc.synth.liveInputPitches.length > Config.maxChordSize) {\r\n\t\t\t\tthis._doc.synth.liveInputPitches.shift();\r\n\t\t\t}\r\n\t\t\tthis._doc.synth.liveInputDuration = Number.MAX_SAFE_INTEGER;\r\n\t\t\t\r\n\t\t\tif (this._recordingChange != null) {\r\n\t\t\t\tconst recentIndex: number = this._recentlyAddedPitches.indexOf(pitch);\r\n\t\t\t\tif (recentIndex != -1) {\r\n\t\t\t\t\t// If the latest pitch is already in _recentlyAddedPitches, remove it before adding it back at the end.\r\n\t\t\t\t\tthis._recentlyAddedPitches.splice(recentIndex, 1);\r\n\t\t\t\t}\r\n\t\t\t\tthis._recentlyAddedPitches.push(pitch);\r\n\t\t\t\twhile (this._recentlyAddedPitches.length > Config.maxChordSize * 4) {\r\n\t\t\t\t\tthis._recentlyAddedPitches.shift();\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\t\r\n\tpublic removePerformedPitch(pitch: number): void {\r\n\t\tthis._updateRecordedNotes();\r\n\t\tfor (let i: number = 0; i < this._doc.synth.liveInputPitches.length; i++) {\r\n\t\t\tif (this._doc.synth.liveInputPitches[i] == pitch) {\r\n\t\t\t\tthis._doc.synth.liveInputPitches.splice(i, 1);\r\n\t\t\t\tthis._pitchesChanged = true;\r\n\t\t\t\ti--;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\t\r\n\tpublic clearAllPitches(): void {\r\n\t\tthis._updateRecordedNotes();\r\n\t\tthis._doc.synth.liveInputPitches.length = 0;\r\n\t\tthis._pitchesChanged = true;\r\n\t}\r\n\t\r\n\tprivate _documentChanged = (): void => {\r\n\t\tconst isDrum: boolean = this._doc.song.getChannelIsNoise(this._doc.channel);\r\n\t\tconst octave: number = this._doc.song.channels[this._doc.channel].octave;\r\n\t\tif (this._doc.synth.liveInputChannel != this._doc.channel || this._channelIsDrum != isDrum || this._channelOctave != octave || this._songKey != this._doc.song.key) {\r\n\t\t\tthis._doc.synth.liveInputChannel = this._doc.channel;\r\n\t\t\tthis._channelIsDrum = isDrum;\r\n\t\t\tthis._channelOctave = octave;\r\n\t\t\tthis._songKey = this._doc.song.key;\r\n\t\t\tthis.clearAllPitches();\r\n\t\t}\r\n\t\tthis._doc.synth.liveInputInstruments = this._doc.recentPatternInstruments[this._doc.channel];\r\n\t}\r\n}\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nimport {Dictionary, Config} from \"../synth/SynthConfig\";\r\nimport {Note, Pattern, Channel} from \"../synth/synth\";\r\nimport {SongDocument} from \"./SongDocument\";\r\nimport {ChangeGroup} from \"./Change\";\r\nimport {ChangeTrackSelection, ChangeChannelBar, ChangeDuplicateSelectedReusedPatterns, ChangeNoteAdded, ChangeNoteTruncate, ChangePatternNumbers, ChangePatternSelection, ChangeInsertBars, ChangeAddChannel, ChangeDeleteBars, ChangeRemoveChannel, ChangeEnsurePatternExists, ChangeNoteLength, ChangePaste, ChangeSetPatternInstruments, ChangeViewInstrument, ChangePatternsPerChannel, ChangePatternRhythm, ChangePatternScale, ChangeTranspose, ChangeChannelOrder, comparePatternNotes, unionOfUsedNotes, generateScaleMap, discardInvalidPatternInstruments, patternsContainSameInstruments} from \"./changes\";\r\n\r\ninterface PatternCopy {\r\n\tinstruments: number[];\r\n\tnotes: any[];\r\n}\r\n\r\ninterface ChannelCopy {\r\n\tisNoise: boolean;\r\n\tpatterns: Dictionary<PatternCopy>;\r\n\tbars: number[];\r\n}\r\n\r\ninterface SelectionCopy {\r\n\tpartDuration: number;\r\n\tchannels: ChannelCopy[];\r\n}\r\n\r\nexport class Selection {\r\n\tpublic boxSelectionX0: number = 0;\r\n\tpublic boxSelectionY0: number = 0;\r\n\tpublic boxSelectionX1: number = 0;\r\n\tpublic boxSelectionY1: number = 0;\r\n\tpublic digits: string = \"\";\r\n\tpublic instrumentDigits: string = \"\";\r\n\tpublic patternSelectionStart: number = 0;\r\n\tpublic patternSelectionEnd: number = 0;\r\n\tpublic patternSelectionActive: boolean = false;\r\n\t\r\n\tprivate _changeTranspose: ChangeGroup | null = null;\r\n\tprivate _changeReorder: ChangeGroup | null = null;\r\n\tprivate _changeTrack: ChangeGroup | null = null;\r\n\tprivate _changeInstrument: ChangeGroup | null = null;\r\n\t\r\n\tconstructor(private _doc: SongDocument) {}\r\n\t\r\n\tpublic toJSON(): {x0: number, x1: number, y0: number, y1: number, start: number, end: number} {\r\n\t\treturn {\r\n\t\t\t\"x0\": this.boxSelectionX0,\r\n\t\t\t\"x1\": this.boxSelectionX1,\r\n\t\t\t\"y0\": this.boxSelectionY0,\r\n\t\t\t\"y1\": this.boxSelectionY1,\r\n\t\t\t\"start\": this.patternSelectionStart,\r\n\t\t\t\"end\": this.patternSelectionEnd,\r\n\t\t};\r\n\t}\r\n\t\r\n\tpublic fromJSON(json: {x0: number, x1: number, y0: number, y1: number, start: number, end: number}): void {\r\n\t\tif (json == null) return;\r\n\t\tthis.boxSelectionX0 = +json[\"x0\"];\r\n\t\tthis.boxSelectionX1 = +json[\"x1\"];\r\n\t\tthis.boxSelectionY0 = +json[\"y0\"];\r\n\t\tthis.boxSelectionY1 = +json[\"y1\"];\r\n\t\tthis.patternSelectionStart = +json[\"start\"];\r\n\t\tthis.patternSelectionEnd = +json[\"end\"];\r\n\t\tthis.digits = \"\";\r\n\t\tthis.instrumentDigits = \"\";\r\n\t\tthis.patternSelectionActive = this.patternSelectionStart < this.patternSelectionEnd;\r\n\t}\r\n\t\r\n\tpublic selectionUpdated(): void {\r\n\t\tthis._doc.notifier.changed();\r\n\t\tthis.digits = \"\";\r\n\t\tthis.instrumentDigits = \"\";\r\n\t}\r\n\t\r\n\tpublic get boxSelectionBar(): number {\r\n\t\treturn Math.min(this.boxSelectionX0, this.boxSelectionX1);\r\n\t}\r\n\tpublic get boxSelectionChannel(): number {\r\n\t\treturn Math.min(this.boxSelectionY0, this.boxSelectionY1);\r\n\t}\r\n\tpublic get boxSelectionWidth(): number {\r\n\t\treturn Math.abs(this.boxSelectionX0 - this.boxSelectionX1) + 1;\r\n\t}\r\n\tpublic get boxSelectionHeight(): number {\r\n\t\treturn Math.abs(this.boxSelectionY0 - this.boxSelectionY1) + 1;\r\n\t}\r\n\tpublic get boxSelectionActive(): boolean {\r\n\t\treturn this.boxSelectionWidth > 1 || this.boxSelectionHeight > 1;\r\n\t}\r\n\tpublic scrollToSelectedPattern(): void {\r\n\t\tthis._doc.barScrollPos     = Math.min(this._doc.bar,     Math.max(this._doc.bar     - (this._doc.trackVisibleBars     - 1), this._doc.barScrollPos));\r\n\t\tthis._doc.channelScrollPos = Math.min(this._doc.channel, Math.max(this._doc.channel - (this._doc.trackVisibleChannels - 1), this._doc.channelScrollPos));\r\n\t}\r\n\tpublic scrollToEndOfSelection(): void {\r\n\t\tthis._doc.barScrollPos     = Math.min(this.boxSelectionX1, Math.max(this.boxSelectionX1 - (this._doc.trackVisibleBars     - 1), this._doc.barScrollPos));\r\n\t\tthis._doc.channelScrollPos = Math.min(this.boxSelectionY1, Math.max(this.boxSelectionY1 - (this._doc.trackVisibleChannels - 1), this._doc.channelScrollPos));\r\n\t}\r\n\t\r\n\tpublic setChannelBar(channelIndex: number, bar: number): void {\r\n\t\tif (channelIndex == this._doc.channel && bar == this._doc.bar) return;\r\n\t\tconst canReplaceLastChange: boolean = this._doc.lastChangeWas(this._changeTrack);\r\n\t\tthis._changeTrack = new ChangeGroup();\r\n\t\tthis._changeTrack.append(new ChangeChannelBar(this._doc, channelIndex, bar));\r\n\t\t// @jummbus - changing current viewed instrument to the first for the current pattern if the viewedInstrument is not in the pattern\r\n\t\tconst pattern: Pattern | null = this._doc.getCurrentPattern(0);\r\n\t\tif (pattern != null && this._doc.song.patternInstruments) {\r\n\t\t\tif (pattern.instruments.indexOf(this._doc.viewedInstrument[this._doc.channel]) == -1) {\r\n\t\t\t\tthis._doc.viewedInstrument[this._doc.channel] = pattern.instruments[0];\r\n\t\t\t}\r\n\t\t}\r\n\t\t// Don't erase existing redo history just to look at highlighted pattern.\r\n\t\tif (!this._doc.hasRedoHistory()) {\r\n\t\t\tthis._doc.record(this._changeTrack, canReplaceLastChange);\r\n\t\t}\r\n\t\tthis.selectionUpdated();\r\n\t}\r\n\t\r\n\tpublic setPattern(pattern: number): void {\r\n\t\tthis._doc.record(new ChangePatternNumbers(this._doc, pattern, this.boxSelectionBar, this.boxSelectionChannel, this.boxSelectionWidth, this.boxSelectionHeight));\r\n\t}\r\n\t\r\n\tpublic nextDigit(digit: string, forInstrument: boolean): void {\r\n\t\tconst channel: Channel = this._doc.song.channels[this._doc.channel];\r\n\t\t\r\n\t\tif (forInstrument) {\r\n\t\t\t// Treat \"0\" as meaning instrument 10\r\n\t\t\tif (digit == \"0\") digit = \"10\";\r\n\t\t\tthis.instrumentDigits += digit;\r\n\t\t\tvar parsed = parseInt(this.instrumentDigits);\r\n\t\t\tif (parsed != 0 && parsed <= channel.instruments.length) {\r\n\t\t\t\tthis.selectInstrument(parsed - 1);\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tthis.instrumentDigits = digit;\r\n\t\t\tparsed = parseInt(this.instrumentDigits);\r\n\t\t\tif (parsed != 0 && parsed <= channel.instruments.length) {\r\n\t\t\t\tthis.selectInstrument(parsed - 1);\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tthis.instrumentDigits = \"\";\r\n\t\t} else {\r\n\t\t\tif (this.digits.length > 0 && this.digits != String(channel.bars[this.boxSelectionBar])) {\r\n\t\t\t\tthis.digits = \"\";\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tthis.digits += digit;\r\n\t\t\tlet parsed: number = parseInt(this.digits);\r\n\t\t\tif (parsed <= this._doc.song.patternsPerChannel) {\r\n\t\t\t\tthis.setPattern(parsed);\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tthis.digits = digit;\r\n\t\t\tparsed = parseInt(this.digits);\r\n\t\t\tif (parsed <= this._doc.song.patternsPerChannel) {\r\n\t\t\t\tthis.setPattern(parsed);\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tthis.digits = \"\";\r\n\t\t}\r\n\t}\r\n\t\r\n\tpublic insertBars(): void {\r\n\t\tthis._doc.record(new ChangeInsertBars(this._doc, this.boxSelectionBar + this.boxSelectionWidth, this.boxSelectionWidth));\r\n\t\tconst width: number = this.boxSelectionWidth;\r\n\t\tthis.boxSelectionX0 += width;\r\n\t\tthis.boxSelectionX1 += width;\r\n\t}\r\n\t\r\n\tpublic insertChannel(): void {\r\n\t\tconst group: ChangeGroup = new ChangeGroup();\r\n\t\tconst insertIndex: number = this.boxSelectionChannel + this.boxSelectionHeight;\r\n\t\tconst isNoise: boolean = this._doc.song.getChannelIsNoise(insertIndex - 1);\r\n\t\tgroup.append(new ChangeAddChannel(this._doc, insertIndex, isNoise));\r\n\t\tif (!group.isNoop()) {\r\n\t\t\tthis.boxSelectionY0 = this.boxSelectionY1 = insertIndex;\r\n\t\t\tgroup.append(new ChangeChannelBar(this._doc, insertIndex, this._doc.bar));\r\n\t\t\tthis._doc.record(group);\r\n\t\t}\r\n\t}\r\n\t\r\n\tpublic deleteBars(): void {\r\n\t\tconst group: ChangeGroup = new ChangeGroup();\r\n\t\tif (this._doc.selection.patternSelectionActive) {\r\n\t\t\t\r\n\t\t\tif (this.boxSelectionActive) {\r\n\t\t\t\tgroup.append(new ChangeDuplicateSelectedReusedPatterns(this._doc, this.boxSelectionBar, this.boxSelectionWidth, this.boxSelectionChannel, this.boxSelectionHeight));\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tfor (const channelIndex of this._eachSelectedChannel()) {\r\n\t\t\t\tfor (const pattern of this._eachSelectedPattern(channelIndex)) {\r\n\t\t\t\t\tgroup.append(new ChangeNoteTruncate(this._doc, pattern, this._doc.selection.patternSelectionStart, this._doc.selection.patternSelectionEnd));\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tgroup.append(new ChangePatternSelection(this._doc, 0, 0));\r\n\t\t} else {\r\n\t\t\tgroup.append(new ChangeDeleteBars(this._doc, this.boxSelectionBar, this.boxSelectionWidth));\r\n\t\t\tconst width: number = this.boxSelectionWidth;\r\n\t\t\tthis.boxSelectionX0 = Math.max(0, this.boxSelectionX0 - width);\r\n\t\t\tthis.boxSelectionX1 = Math.max(0, this.boxSelectionX1 - width);\r\n\t\t}\r\n\t\tthis._doc.record(group);\r\n\t}\r\n\t\r\n\tpublic deleteChannel(): void {\r\n\t\tthis._doc.record(new ChangeRemoveChannel(this._doc, this.boxSelectionChannel, this.boxSelectionChannel + this.boxSelectionHeight - 1));\r\n\t\tthis.boxSelectionY0 = this.boxSelectionY1 = this._doc.channel;\r\n\t}\r\n\t\r\n\tprivate *_eachSelectedChannel(): IterableIterator<number> {\r\n\t\tfor (let channelIndex: number = this.boxSelectionChannel; channelIndex < this.boxSelectionChannel + this.boxSelectionHeight; channelIndex++) {\r\n\t\t\tyield channelIndex;\r\n\t\t}\r\n\t}\r\n\t\r\n\tprivate *_eachSelectedBar(): IterableIterator<number> {\r\n\t\tfor (let bar: number = this.boxSelectionBar; bar < this.boxSelectionBar + this.boxSelectionWidth; bar++) {\r\n\t\t\tyield bar;\r\n\t\t}\r\n\t}\r\n\t\r\n\tprivate *_eachSelectedPattern(channelIndex: number): IterableIterator<Pattern> {\r\n\t\tconst handledPatterns: Dictionary<boolean> = {};\r\n\t\tfor (const bar of this._eachSelectedBar()) {\r\n\t\t\tconst currentPatternIndex: number = this._doc.song.channels[channelIndex].bars[bar];\r\n\t\t\tif (currentPatternIndex == 0) continue;\r\n\t\t\tif (handledPatterns[String(currentPatternIndex)]) continue;\r\n\t\t\thandledPatterns[String(currentPatternIndex)] = true;\r\n\t\t\tconst pattern: Pattern | null = this._doc.song.getPattern(channelIndex, bar);\r\n\t\t\tif (pattern == null) throw new Error();\r\n\t\t\tyield pattern;\r\n\t\t}\r\n\t}\r\n\t\r\n\tprivate _parseCopiedInstrumentArray(patternCopy: any, channelIndex: number): number[] {\r\n\t\tconst instruments: number[] = Array.from(patternCopy[\"instruments\"]).map(i => (<any>i) >>> 0);\r\n\t\tdiscardInvalidPatternInstruments(instruments, this._doc.song, channelIndex);\r\n\t\treturn instruments;\r\n\t}\r\n\t\r\n\tprivate _patternIndexIsUnused(channelIndex: number, patternIndex: number): boolean {\r\n\t\tfor (let i: number = 0; i < this._doc.song.barCount; i++) {\r\n\t\t\tif (this._doc.song.channels[channelIndex].bars[i] == patternIndex) {\r\n\t\t\t\treturn false;\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn true;\r\n\t}\r\n\t\r\n\tpublic copy(): void {\r\n\t\tconst channels: ChannelCopy[] = [];\r\n\t\t\r\n\t\tfor (const channelIndex of this._eachSelectedChannel()) {\r\n\t\t\tconst patterns: Dictionary<PatternCopy> = {};\r\n\t\t\tconst bars: number[] = [];\r\n\t\t\t\r\n\t\t\tfor (const bar of this._eachSelectedBar()) {\r\n\t\t\t\tconst patternNumber: number = this._doc.song.channels[channelIndex].bars[bar];\r\n\t\t\t\tbars.push(patternNumber);\r\n\t\t\t\tif (patterns[String(patternNumber)] == undefined) {\r\n\t\t\t\t\tconst pattern: Pattern | null = this._doc.song.getPattern(channelIndex, bar);\r\n\t\t\t\t\tlet instruments: number[] = this._doc.recentPatternInstruments[channelIndex];\r\n\t\t\t\t\tlet notes: Note[] = [];\r\n\t\t\t\t\tif (pattern != null) {\r\n\t\t\t\t\t\tinstruments = pattern.instruments.concat();\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tif (this.patternSelectionActive) {\r\n\t\t\t\t\t\t\tfor (const note of pattern.cloneNotes()) {\r\n\t\t\t\t\t\t\t\tif (note.end <= this.patternSelectionStart) continue;\r\n\t\t\t\t\t\t\t\tif (note.start >= this.patternSelectionEnd) continue;\r\n\t\t\t\t\t\t\t\tnote.start -= this.patternSelectionStart;\r\n\t\t\t\t\t\t\t\tnote.end -= this.patternSelectionStart;\r\n\t\t\t\t\t\t\t\tif (note.start < 0 || note.end > this.patternSelectionEnd - this.patternSelectionStart) {\r\n\t\t\t\t\t\t\t\t\tnew ChangeNoteLength(null, note, Math.max(note.start, 0), Math.min(this.patternSelectionEnd - this.patternSelectionStart, note.end));\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\tnotes.push(note);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\tnotes = pattern.notes;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\tpatterns[String(patternNumber)] = {\"instruments\": instruments, \"notes\": notes};\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tconst channelCopy: ChannelCopy = {\r\n\t\t\t\t\"isNoise\": this._doc.song.getChannelIsNoise(channelIndex),\r\n\t\t\t\t\"patterns\": patterns,\r\n\t\t\t\t\"bars\": bars,\r\n\t\t\t};\r\n\t\t\tchannels.push(channelCopy);\r\n\t\t}\r\n\t\t\r\n\t\tconst selectionCopy: SelectionCopy = {\r\n\t\t\t\"partDuration\": this.patternSelectionActive ? this.patternSelectionEnd - this.patternSelectionStart : this._doc.song.beatsPerBar * Config.partsPerBeat,\r\n\t\t\t\"channels\": channels,\r\n\t\t};\r\n\t\twindow.localStorage.setItem(\"selectionCopy\", JSON.stringify(selectionCopy));\r\n\t}\r\n\t\r\n\t// I'm sorry this function is so complicated!\r\n\t// Basically I'm trying to avoid accidentally modifying patterns that are used\r\n\t// elsewhere in the song (unless we're just pasting a single pattern) but I'm\r\n\t// also trying to reuse patterns where it makes sense to do so, especially \r\n\t// in the same channel it was copied from.\r\n\tpublic pasteNotes(): void {\r\n\t\tconst selectionCopy: SelectionCopy | null = JSON.parse(String(window.localStorage.getItem(\"selectionCopy\")));\r\n\t\tif (selectionCopy == null) return;\r\n\t\tconst channelCopies: ChannelCopy[] = selectionCopy[\"channels\"] || [];\r\n\t\tconst copiedPartDuration: number = selectionCopy[\"partDuration\"] >>> 0;\r\n\t\t\r\n\t\tconst group: ChangeGroup = new ChangeGroup();\r\n\t\tconst fillSelection: boolean = this.boxSelectionActive;\r\n\t\t\r\n\t\tconst pasteHeight: number = fillSelection ? this.boxSelectionHeight : Math.min(channelCopies.length, this._doc.song.getChannelCount() - this.boxSelectionChannel);\r\n\t\tfor (let pasteChannel: number = 0; pasteChannel < pasteHeight; pasteChannel++) {\r\n\t\t\tconst channelCopy: ChannelCopy = channelCopies[pasteChannel % channelCopies.length];\r\n\t\t\tconst channelIndex: number = this.boxSelectionChannel + pasteChannel;\r\n\t\t\t\r\n\t\t\tconst isNoise: boolean = !!channelCopy[\"isNoise\"];\r\n\t\t\tconst patternCopies: Dictionary<PatternCopy> = channelCopy[\"patterns\"] || {};\r\n\t\t\tconst copiedBars: number[] = channelCopy[\"bars\"] || [];\r\n\t\t\tif (copiedBars.length == 0) continue;\r\n\t\t\tif (isNoise != this._doc.song.getChannelIsNoise(channelIndex)) continue;\r\n\t\t\t\r\n\t\t\tconst pasteWidth: number = fillSelection ? this.boxSelectionWidth : Math.min(copiedBars.length, this._doc.song.barCount - this.boxSelectionBar);\r\n\t\t\tif (!fillSelection && copiedBars.length == 1 && channelCopies.length == 1) {\r\n\t\t\t\t// Special case: if there's just one pattern being copied, try to insert it\r\n\t\t\t\t// into whatever pattern is already selected.\r\n\t\t\t\tconst copiedPatternIndex: number = copiedBars[0] >>> 0;\r\n\t\t\t\tconst bar: number = this.boxSelectionBar;\r\n\t\t\t\tconst currentPatternIndex: number = this._doc.song.channels[channelIndex].bars[bar];\r\n\t\t\t\tif (copiedPatternIndex == 0 && currentPatternIndex == 0) continue;\r\n\t\t\t\t\r\n\t\t\t\tconst patternCopy: PatternCopy = patternCopies[String(copiedPatternIndex)];\r\n\t\t\t\tconst instrumentsCopy: number[] = this._parseCopiedInstrumentArray(patternCopy, channelIndex);\r\n\t\t\t\t\r\n\t\t\t\tif (currentPatternIndex == 0) {\r\n\t\t\t\t\tconst existingPattern: Pattern | undefined = this._doc.song.channels[channelIndex].patterns[copiedPatternIndex - 1];\r\n\t\t\t\t\tif (existingPattern != undefined &&\r\n\t\t\t\t\t\t!this.patternSelectionActive &&\r\n\t\t\t\t\t\t((comparePatternNotes(patternCopy[\"notes\"], existingPattern.notes) && patternsContainSameInstruments(instrumentsCopy, existingPattern.instruments)) ||\r\n\t\t\t\t\t\tthis._patternIndexIsUnused(channelIndex, copiedPatternIndex)))\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tgroup.append(new ChangePatternNumbers(this._doc, copiedPatternIndex, bar, channelIndex, 1, 1));\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tgroup.append(new ChangeEnsurePatternExists(this._doc, channelIndex, bar));\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tconst pattern: Pattern | null = this._doc.song.getPattern(channelIndex, bar);\r\n\t\t\t\tif (pattern == null) throw new Error();\r\n\t\t\t\tgroup.append(new ChangePaste(this._doc, pattern, patternCopy[\"notes\"], this.patternSelectionActive ? this.patternSelectionStart : 0, this.patternSelectionActive ? this.patternSelectionEnd : Config.partsPerBeat * this._doc.song.beatsPerBar, copiedPartDuration));\r\n\t\t\t\tif (currentPatternIndex == 0) group.append(new ChangeSetPatternInstruments(this._doc, channelIndex, instrumentsCopy, pattern));\r\n\t\t\t} else if (this.patternSelectionActive) {\r\n\t\t\t\tconst reusablePatterns: Dictionary<number> = {};\r\n\t\t\t\tconst usedPatterns: Dictionary<boolean> = {};\r\n\t\t\t\t\r\n\t\t\t\tgroup.append(new ChangeDuplicateSelectedReusedPatterns(this._doc, this.boxSelectionBar, pasteWidth, this.boxSelectionChannel, pasteHeight));\r\n\t\t\t\t\r\n\t\t\t\tfor (let pasteBar: number = 0; pasteBar < pasteWidth; pasteBar++) {\r\n\t\t\t\t\tconst bar: number = this.boxSelectionBar + pasteBar;\r\n\t\t\t\t\tconst copiedPatternIndex: number = copiedBars[pasteBar % copiedBars.length] >>> 0;\r\n\t\t\t\t\tconst currentPatternIndex: number = this._doc.song.channels[channelIndex].bars[bar];\r\n\t\t\t\t\tconst reusedIndex: string = [copiedPatternIndex, currentPatternIndex].join(\",\");\r\n\t\t\t\t\tif (copiedPatternIndex == 0 && currentPatternIndex == 0) continue;\r\n\t\t\t\t\tif (reusablePatterns[reusedIndex] != undefined) {\r\n\t\t\t\t\t\tgroup.append(new ChangePatternNumbers(this._doc, reusablePatterns[reusedIndex], bar, channelIndex, 1, 1));\r\n\t\t\t\t\t\tcontinue;\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t\tif (currentPatternIndex == 0) {\r\n\t\t\t\t\t\tgroup.append(new ChangeEnsurePatternExists(this._doc, channelIndex, bar));\r\n\t\t\t\t\t\tconst patternCopy: PatternCopy = patternCopies[String(copiedPatternIndex)];\r\n\t\t\t\t\t\tconst instrumentsCopy: number[] = this._parseCopiedInstrumentArray(patternCopy, channelIndex);\r\n\t\t\t\t\t\tconst pattern: Pattern = this._doc.song.getPattern(channelIndex, bar)!;\r\n\t\t\t\t\t\tgroup.append(new ChangeSetPatternInstruments(this._doc, channelIndex, instrumentsCopy, pattern));\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tconst pattern: Pattern | null = this._doc.song.getPattern(channelIndex, bar);\r\n\t\t\t\t\t\tif (pattern == null) throw new Error();\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tif (!usedPatterns[String(currentPatternIndex)]) {\r\n\t\t\t\t\t\t\tusedPatterns[String(currentPatternIndex)] = true;\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t// If this pattern is used here and elsewhere, it's not safe to modify it directly, so\r\n\t\t\t\t\t\t\t// make a duplicate of it and modify that instead.\r\n\t\t\t\t\t\t\tgroup.append(new ChangePatternNumbers(this._doc, 0, bar, channelIndex, 1, 1));\r\n\t\t\t\t\t\t\tgroup.append(new ChangeEnsurePatternExists(this._doc, channelIndex, bar));\r\n\t\t\t\t\t\t\tconst newPattern: Pattern | null = this._doc.song.getPattern(channelIndex, bar);\r\n\t\t\t\t\t\t\tif (newPattern == null) throw new Error();\r\n\t\t\t\t\t\t\tfor (const note of pattern.cloneNotes()) {\r\n\t\t\t\t\t\t\t\tgroup.append(new ChangeNoteAdded(this._doc, newPattern, note, newPattern.notes.length, false));\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t// Don't overwrite the existing pattern's instruments if only part of the pattern content is being replaced.\r\n\t\t\t\t\t\t\t//group.append(new ChangeSetPatternInstruments(this._doc, channelIndex, pattern.instruments, newPattern));\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t\tconst pattern: Pattern | null = this._doc.song.getPattern(channelIndex, bar);\r\n\t\t\t\t\tif (pattern == null) throw new Error();\r\n\t\t\t\t\tif (copiedPatternIndex == 0) {\r\n\t\t\t\t\t\tgroup.append(new ChangeNoteTruncate(this._doc, pattern, this.patternSelectionStart, this.patternSelectionEnd));\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tconst patternCopy: PatternCopy = patternCopies[String(copiedPatternIndex)];\r\n\t\t\t\t\t\tgroup.append(new ChangePaste(this._doc, pattern, patternCopy[\"notes\"], this.patternSelectionStart, this.patternSelectionEnd, copiedPartDuration));\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t\treusablePatterns[reusedIndex] = this._doc.song.channels[channelIndex].bars[bar];\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t} else {\r\n\t\t\t\tfor (let pasteBar: number = 0; pasteBar < pasteWidth; pasteBar++) {\r\n\t\t\t\t\t// When a pattern becomes unused when replaced by rectangular selection pasting,\r\n\t\t\t\t\t// remove all the notes from the pattern so that it may be reused.\r\n\t\t\t\t\tthis.erasePatternInBar(group, channelIndex, this.boxSelectionBar + pasteBar);\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tconst reusablePatterns: Dictionary<number> = {};\r\n\t\t\t\tfor (let pasteBar: number = 0; pasteBar < pasteWidth; pasteBar++) {\r\n\t\t\t\t\tconst bar: number = this.boxSelectionBar + pasteBar;\r\n\t\t\t\t\tconst copiedPatternIndex: number = copiedBars[pasteBar % copiedBars.length] >>> 0;\r\n\t\t\t\t\tconst reusedIndex: string = String(copiedPatternIndex);\r\n\t\t\t\t\t\r\n\t\t\t\t\tif (copiedPatternIndex == 0) continue;\r\n\t\t\t\t\tif (reusablePatterns[reusedIndex] != undefined) {\r\n\t\t\t\t\t\tgroup.append(new ChangePatternNumbers(this._doc, reusablePatterns[reusedIndex], bar, channelIndex, 1, 1));\r\n\t\t\t\t\t\tcontinue;\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t\tconst patternCopy: PatternCopy = patternCopies[String(copiedPatternIndex)];\r\n\t\t\t\t\tconst instrumentsCopy: number[] = this._parseCopiedInstrumentArray(patternCopy, channelIndex);\r\n\t\t\t\t\tconst existingPattern: Pattern | undefined = this._doc.song.channels[channelIndex].patterns[copiedPatternIndex - 1];\r\n\t\t\t\t\t\r\n\t\t\t\t\tif (existingPattern != undefined &&\r\n\t\t\t\t\t\tcopiedPartDuration == Config.partsPerBeat * this._doc.song.beatsPerBar &&\r\n\t\t\t\t\t\tcomparePatternNotes(patternCopy[\"notes\"], existingPattern.notes) &&\r\n\t\t\t\t\t\tpatternsContainSameInstruments(instrumentsCopy, existingPattern.instruments))\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tgroup.append(new ChangePatternNumbers(this._doc, copiedPatternIndex, bar, channelIndex, 1, 1));\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tif (existingPattern != undefined && this._patternIndexIsUnused(channelIndex, copiedPatternIndex)) {\r\n\t\t\t\t\t\t\tgroup.append(new ChangePatternNumbers(this._doc, copiedPatternIndex, bar, channelIndex, 1, 1));\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\tgroup.append(new ChangeEnsurePatternExists(this._doc, channelIndex, bar));\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tconst pattern: Pattern | null = this._doc.song.getPattern(channelIndex, bar);\r\n\t\t\t\t\t\tif (pattern == null) throw new Error();\r\n\t\t\t\t\t\tgroup.append(new ChangePaste(this._doc, pattern, patternCopy[\"notes\"], this.patternSelectionActive ? this.patternSelectionStart : 0, this.patternSelectionActive ? this.patternSelectionEnd : Config.partsPerBeat * this._doc.song.beatsPerBar, copiedPartDuration));\r\n\t\t\t\t\t\tgroup.append(new ChangeSetPatternInstruments(this._doc, channelIndex, instrumentsCopy, pattern));\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t\treusablePatterns[reusedIndex] = this._doc.song.channels[channelIndex].bars[bar];\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tthis._doc.record(group);\r\n\t}\r\n\t\r\n\t// Set a bar's pattern number to zero, and if that pattern was not used\r\n\t// elsewhere in the channel, erase all notes in it as well.\r\n\tpublic erasePatternInBar(group: ChangeGroup, channelIndex: number, bar: number): void {\r\n\t\tconst removedPattern: number = this._doc.song.channels[channelIndex].bars[bar];\r\n\t\tif (removedPattern != 0) {\r\n\t\t\tgroup.append(new ChangePatternNumbers(this._doc, 0, bar, channelIndex, 1, 1));\r\n\t\t\tif (this._patternIndexIsUnused(channelIndex, removedPattern)) {\r\n\t\t\t\t// When a pattern becomes unused when replaced by rectangular selection pasting,\r\n\t\t\t\t// remove all the notes from the pattern so that it may be reused.\r\n\t\t\t\tthis._doc.song.channels[channelIndex].patterns[removedPattern - 1].notes.length = 0;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\t\r\n\tpublic pasteNumbers(): void {\r\n\t\tconst selectionCopy: SelectionCopy | null = JSON.parse(String(window.localStorage.getItem(\"selectionCopy\")));\r\n\t\tif (selectionCopy == null) return;\r\n\t\tconst channelCopies: ChannelCopy[] = selectionCopy[\"channels\"] || [];\r\n\t\t\r\n\t\tconst group: ChangeGroup = new ChangeGroup();\r\n\t\tconst fillSelection: boolean = this.boxSelectionActive;\r\n\t\t\r\n\t\tconst pasteHeight: number = fillSelection ? this.boxSelectionHeight : Math.min(channelCopies.length, this._doc.song.getChannelCount() - this.boxSelectionChannel);\r\n\t\tfor (let pasteChannel: number = 0; pasteChannel < pasteHeight; pasteChannel++) {\r\n\t\t\tconst channelCopy: ChannelCopy = channelCopies[pasteChannel % channelCopies.length];\r\n\t\t\tconst channelIndex: number = this.boxSelectionChannel + pasteChannel;\r\n\t\t\t\r\n\t\t\tconst copiedBars: number[] = channelCopy[\"bars\"] || [];\r\n\t\t\tif (copiedBars.length == 0) continue;\r\n\t\t\t\r\n\t\t\tconst pasteWidth: number = fillSelection ? this.boxSelectionWidth : Math.min(copiedBars.length, this._doc.song.barCount - this.boxSelectionBar);\r\n\t\t\tfor (let pasteBar: number = 0; pasteBar < pasteWidth; pasteBar++) {\r\n\t\t\t\tconst copiedPatternIndex: number = copiedBars[pasteBar % copiedBars.length] >>> 0;\r\n\t\t\t\tconst bar: number = this.boxSelectionBar + pasteBar;\r\n\t\t\t\t\r\n\t\t\t\tif (copiedPatternIndex > this._doc.song.patternsPerChannel) {\r\n\t\t\t\t\tgroup.append(new ChangePatternsPerChannel(this._doc, copiedPatternIndex));\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tgroup.append(new ChangePatternNumbers(this._doc, copiedPatternIndex, bar, channelIndex, 1, 1));\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tthis._doc.record(group);\r\n\t}\r\n\t\r\n\tpublic selectAll(): void {\r\n\t\tnew ChangePatternSelection(this._doc, 0, 0);\r\n\t\tif (this.boxSelectionBar == 0 &&\r\n\t\t\tthis.boxSelectionChannel == 0 &&\r\n\t\t\tthis.boxSelectionWidth == this._doc.song.barCount &&\r\n\t\t\tthis.boxSelectionHeight == this._doc.song.getChannelCount())\r\n\t\t{\r\n\t\t\tthis.setTrackSelection(this._doc.bar, this._doc.bar, this._doc.channel, this._doc.channel);\r\n\t\t} else {\r\n\t\t\tthis.setTrackSelection(0, this._doc.song.barCount - 1, 0, this._doc.song.getChannelCount() - 1);\r\n\t\t}\r\n\t\tthis.selectionUpdated();\r\n\t}\r\n\t\r\n\tpublic selectChannel(): void {\r\n\t\tnew ChangePatternSelection(this._doc, 0, 0);\r\n\t\tif (this.boxSelectionBar == 0 && this.boxSelectionWidth == this._doc.song.barCount) {\r\n\t\t\tthis.setTrackSelection(this._doc.bar, this._doc.bar, this.boxSelectionY0, this.boxSelectionY1);\r\n\t\t} else {\r\n\t\t\tthis.setTrackSelection(0, this._doc.song.barCount - 1, this.boxSelectionY0, this.boxSelectionY1);\r\n\t\t}\r\n\t\tthis.selectionUpdated();\r\n\t}\r\n\t\r\n\tpublic duplicatePatterns(): void {\r\n\t\tthis._doc.record(new ChangeDuplicateSelectedReusedPatterns(this._doc, this.boxSelectionBar, this.boxSelectionWidth, this.boxSelectionChannel, this.boxSelectionHeight));\r\n\t}\r\n\t\r\n\tpublic muteChannels(allChannels: boolean): void {\r\n\t\tif (allChannels) {\r\n\t\t\tlet anyMuted: boolean = false;\r\n\t\t\tfor (let channelIndex: number = 0; channelIndex < this._doc.song.channels.length; channelIndex++) {\r\n\t\t\t\tif (this._doc.song.channels[channelIndex].muted) {\r\n\t\t\t\t\tanyMuted = true;\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tfor (let channelIndex: number = 0; channelIndex < this._doc.song.channels.length; channelIndex++) {\r\n\t\t\t\tthis._doc.song.channels[channelIndex].muted = !anyMuted;\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tlet anyUnmuted: boolean = false;\r\n\t\t\tfor (const channelIndex of this._eachSelectedChannel()) {\r\n\t\t\t\tif (!this._doc.song.channels[channelIndex].muted) {\r\n\t\t\t\t\tanyUnmuted = true;\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tfor (const channelIndex of this._eachSelectedChannel()) {\r\n\t\t\t\tthis._doc.song.channels[channelIndex].muted = anyUnmuted;\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tthis._doc.notifier.changed();\r\n\t}\r\n\t\r\n\tpublic soloChannels(invert: boolean): void {\r\n\t\tlet alreadySoloed: boolean = true;\r\n\t\t\r\n\t\tfor (let channelIndex: number = 0; channelIndex < this._doc.song.channels.length; channelIndex++) {\r\n\t\t\tconst shouldBeMuted: boolean = (channelIndex < this.boxSelectionChannel || channelIndex >= this.boxSelectionChannel + this.boxSelectionHeight) ? !invert : invert;\r\n\t\t\tif (this._doc.song.channels[channelIndex].muted != shouldBeMuted) {\r\n\t\t\t\talreadySoloed = false;\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tif (alreadySoloed) {\r\n\t\t\tfor (let channelIndex: number = 0; channelIndex < this._doc.song.channels.length; channelIndex++) {\r\n\t\t\t\tthis._doc.song.channels[channelIndex].muted = false;\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tfor (let channelIndex: number = 0; channelIndex < this._doc.song.channels.length; channelIndex++) {\r\n\t\t\t\tthis._doc.song.channels[channelIndex].muted = (channelIndex < this.boxSelectionChannel || channelIndex >= this.boxSelectionChannel + this.boxSelectionHeight) ? !invert : invert;\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tthis._doc.notifier.changed();\r\n\t}\r\n\t\r\n\tpublic forceRhythm(): void {\r\n\t\tconst group: ChangeGroup = new ChangeGroup();\r\n\t\t\r\n\t\tif (this.boxSelectionActive) {\r\n\t\t\tgroup.append(new ChangeDuplicateSelectedReusedPatterns(this._doc, this.boxSelectionBar, this.boxSelectionWidth, this.boxSelectionChannel, this.boxSelectionHeight));\r\n\t\t}\r\n\t\t\r\n\t\tfor (const channelIndex of this._eachSelectedChannel()) {\r\n\t\t\tfor (const pattern of this._eachSelectedPattern(channelIndex)) {\r\n\t\t\t\tgroup.append(new ChangePatternRhythm(this._doc, pattern));\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tthis._doc.record(group);\r\n\t}\r\n\t\r\n\tpublic forceScale(): void {\r\n\t\tconst group: ChangeGroup = new ChangeGroup();\r\n\t\t\r\n\t\tif (this.boxSelectionActive) {\r\n\t\t\tgroup.append(new ChangeDuplicateSelectedReusedPatterns(this._doc, this.boxSelectionBar, this.boxSelectionWidth, this.boxSelectionChannel, this.boxSelectionHeight));\r\n\t\t}\r\n\t\t\r\n\t\tconst scaleFlags: boolean[] = [true, false, false, false, false, false, false, false, false, false, false, false];\r\n\t\tfor (const channelIndex of this._eachSelectedChannel()) {\r\n\t\t\tif (this._doc.song.getChannelIsNoise(channelIndex)) continue;\r\n\t\t\tfor (const pattern of this._eachSelectedPattern(channelIndex)) {\r\n\t\t\t\tunionOfUsedNotes(pattern, scaleFlags);\r\n\t\t\t}\r\n\t\t}\r\n\t\t\t\r\n\t\tconst scaleMap: number[] = generateScaleMap(scaleFlags, this._doc.song.scale);\r\n\t\t\t\r\n\t\tfor (const channelIndex of this._eachSelectedChannel()) {\r\n\t\t\tif (this._doc.song.getChannelIsNoise(channelIndex)) continue;\r\n\t\t\tfor (const pattern of this._eachSelectedPattern(channelIndex)) {\r\n\t\t\t\tgroup.append(new ChangePatternScale(this._doc, pattern, scaleMap));\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tthis._doc.record(group);\r\n\t}\r\n\t\r\n\tpublic setTrackSelection(newX0: number, newX1: number, newY0: number, newY1: number): void {\r\n\t\tconst canReplaceLastChange: boolean = this._doc.lastChangeWas(this._changeTrack);\r\n\t\tthis._changeTrack = new ChangeGroup();\r\n\t\tthis._changeTrack.append(new ChangeTrackSelection(this._doc, newX0, newX1, newY0, newY1));\r\n\t\t// Don't erase existing redo history just to change track selection.\r\n\t\tif (!this._doc.hasRedoHistory()) {\r\n\t\t\tthis._doc.record(this._changeTrack, canReplaceLastChange);\r\n\t\t}\r\n\t}\r\n\t\r\n\tpublic transpose(upward: boolean, octave: boolean): void {\r\n\t\tconst canReplaceLastChange: boolean = this._doc.lastChangeWas(this._changeTranspose);\r\n\t\tthis._changeTranspose = new ChangeGroup();\r\n\t\t\r\n\t\tif (this.boxSelectionActive) {\r\n\t\t\tthis._changeTranspose.append(new ChangeDuplicateSelectedReusedPatterns(this._doc, this.boxSelectionBar, this.boxSelectionWidth, this.boxSelectionChannel, this.boxSelectionHeight));\r\n\t\t}\r\n\t\t\r\n\t\tfor (const channelIndex of this._eachSelectedChannel()) {\r\n\t\t\tfor (const pattern of this._eachSelectedPattern(channelIndex)) {\r\n\t\t\t\tthis._changeTranspose.append(new ChangeTranspose(this._doc, channelIndex, pattern, upward, this._doc.prefs.notesOutsideScale, octave));\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tthis._doc.record(this._changeTranspose, canReplaceLastChange);\r\n\t}\r\n\t\r\n\tpublic swapChannels(offset: number): void {\r\n\t\tconst possibleSectionBoundaries: number[] = [\r\n\t\t\tthis._doc.song.pitchChannelCount,\r\n\t\t\tthis._doc.song.pitchChannelCount + this._doc.song.noiseChannelCount,\r\n\t\t\tthis._doc.song.getChannelCount(),\r\n\t\t];\r\n\t\tlet channelSectionMin: number = 0;\r\n\t\tlet channelSectionMax: number = 0;\r\n\t\tfor (const nextBoundary of possibleSectionBoundaries) {\r\n\t\t\tif ((this.boxSelectionChannel < nextBoundary && offset < 0) || (this.boxSelectionChannel + this.boxSelectionHeight <= nextBoundary)) {\r\n\t\t\t\tchannelSectionMax = nextBoundary - 1;\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t\tchannelSectionMin = nextBoundary;\r\n\t\t}\r\n\t\tconst newSelectionMin: number = Math.max(this.boxSelectionChannel, channelSectionMin);\r\n\t\tconst newSelectionMax: number = Math.min(this.boxSelectionChannel + this.boxSelectionHeight - 1, channelSectionMax);\r\n\t\toffset = Math.max(offset, channelSectionMin - newSelectionMin);\r\n\t\toffset = Math.min(offset, channelSectionMax - newSelectionMax);\r\n\t\t\r\n\t\tif (offset != 0) {\r\n\t\t\tconst canReplaceLastChange: boolean = this._doc.lastChangeWas(this._changeReorder);\r\n\t\t\tthis._changeReorder = new ChangeGroup();\r\n\t\t\tthis.boxSelectionY0 = newSelectionMin + offset;\r\n\t\t\tthis.boxSelectionY1 = newSelectionMax + offset;\r\n\t\t\tthis._changeReorder.append(new ChangeChannelOrder(this._doc, newSelectionMin, newSelectionMax, offset));\r\n\t\t\tthis._changeReorder.append(new ChangeChannelBar(this._doc, Math.max(this.boxSelectionY0, Math.min(this.boxSelectionY1, this._doc.channel + offset)), this._doc.bar));\r\n\t\t\tthis.selectionUpdated();\r\n\t\t\tthis._doc.record(this._changeReorder, canReplaceLastChange);\r\n\t\t}\r\n\t}\r\n\t\r\n\tpublic selectInstrument(instrument: number): void {\r\n\t\tif (this._doc.viewedInstrument[this._doc.channel] == instrument) {\r\n\t\t\tif (this._doc.song.layeredInstruments && this._doc.song.patternInstruments) {\r\n\t\t\t\tconst canReplaceLastChange: boolean = this._doc.lastChangeWas(this._changeInstrument);\r\n\t\t\t\tthis._changeInstrument = new ChangeGroup();\r\n\t\t\t\tconst instruments: number[] = this._doc.recentPatternInstruments[this._doc.channel];\r\n\t\t\t\tthis._doc.notifier.changed(); // doc.recentPatternInstruments changes even if a 0 pattern is selected.\r\n\t\t\t\tif (instruments.indexOf(instrument) == -1) {\r\n\t\t\t\t\tinstruments.push(instrument);\r\n\t\t\t\t\tconst maxLayers: number = this._doc.song.getMaxInstrumentsPerPattern(this._doc.channel);\r\n\t\t\t\t\tif (instruments.length > maxLayers) {\r\n\t\t\t\t\t\tinstruments.splice(0, instruments.length - maxLayers);\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\tinstruments.splice(instruments.indexOf(instrument), 1);\r\n\t\t\t\t\tif (instruments.length == 0) instruments[0] = 0;\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tif (this.boxSelectionActive) {\r\n\t\t\t\t\tthis._changeInstrument.append(new ChangeDuplicateSelectedReusedPatterns(this._doc, this.boxSelectionBar, this.boxSelectionWidth, this.boxSelectionChannel, this.boxSelectionHeight));\r\n\t\t\t\t}\r\n\t\t\t\tfor (const channelIndex of this._eachSelectedChannel()) {\r\n\t\t\t\t\tfor (const pattern of this._eachSelectedPattern(channelIndex)) {\r\n\t\t\t\t\t\tthis._changeInstrument.append(new ChangeSetPatternInstruments(this._doc, channelIndex, instruments, pattern));\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tthis._doc.record(this._changeInstrument, canReplaceLastChange);\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tconst canReplaceLastChange: boolean = this._doc.lastChangeWas(this._changeInstrument);\r\n\t\t\tthis._changeInstrument = new ChangeGroup();\r\n\t\t\tthis._changeInstrument.append(new ChangeViewInstrument(this._doc, instrument));\r\n\t\t\t\r\n\t\t\tif (!this._doc.song.layeredInstruments && this._doc.song.patternInstruments) {\r\n\t\t\t\tif (this.boxSelectionActive) {\r\n\t\t\t\t\tthis._changeInstrument.append(new ChangeDuplicateSelectedReusedPatterns(this._doc, this.boxSelectionBar, this.boxSelectionWidth, this.boxSelectionChannel, this.boxSelectionHeight));\r\n\t\t\t\t}\r\n\t\t\t\tconst instruments: number[] = [instrument];\r\n\t\t\t\tfor (const channelIndex of this._eachSelectedChannel()) {\r\n\t\t\t\t\tfor (const pattern of this._eachSelectedPattern(channelIndex)) {\r\n\t\t\t\t\t\tthis._changeInstrument.append(new ChangeSetPatternInstruments(this._doc, channelIndex, instruments, pattern));\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tthis._doc.record(this._changeInstrument, canReplaceLastChange);\r\n\t\t\t} else if (!this._doc.hasRedoHistory()) {\r\n\t\t\t\t// Don't erase existing redo history just to look at highlighted pattern.\r\n\t\t\t\tthis._doc.record(this._changeInstrument, canReplaceLastChange);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\t\r\n\tpublic resetBoxSelection(): void {\r\n\t\tthis.boxSelectionX0 = this.boxSelectionX1 = this._doc.bar;\r\n\t\tthis.boxSelectionY0 = this.boxSelectionY1 = this._doc.channel;\r\n\t}\r\n}\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nimport {Scale, Config} from \"../synth/SynthConfig\";\r\n\r\nexport class Preferences {\r\n\tpublic static readonly defaultVisibleOctaves: number = 3;\r\n\t\r\n\tpublic autoPlay: boolean;\r\n\tpublic autoFollow: boolean;\r\n\tpublic enableNotePreview: boolean;\r\n\tpublic showFifth: boolean;\r\n\tpublic notesOutsideScale: boolean;\r\n\tpublic defaultScale: number;\r\n\tpublic showLetters: boolean;\r\n\tpublic showChannels: boolean;\r\n\tpublic showScrollBar: boolean;\r\n\tpublic alwaysShowSettings: boolean;\r\n\tpublic instrumentCopyPaste: boolean;\r\n\tpublic enableChannelMuting: boolean;\r\n\tpublic colorTheme: string;\r\n\tpublic layout: string;\r\n\tpublic displayBrowserUrl: boolean;\r\n\tpublic volume: number = 75;\r\n\tpublic visibleOctaves: number = Preferences.defaultVisibleOctaves;\r\n\tpublic pressControlForShortcuts: boolean;\r\n\tpublic keyboardLayout: string;\r\n\tpublic enableMidi: boolean;\r\n\tpublic showRecordButton: boolean;\r\n\tpublic snapRecordedNotesToRhythm: boolean;\r\n\tpublic ignorePerformedNotesNotInScale: boolean;\r\n\tpublic metronomeCountIn: boolean;\r\n\tpublic metronomeWhileRecording: boolean;\r\n\t\r\n\tconstructor() {\r\n\t\tthis.reload();\r\n\t}\r\n\t\r\n\tpublic reload(): void {\r\n\t\tthis.autoPlay = window.localStorage.getItem(\"autoPlay\") == \"true\";\r\n\t\tthis.autoFollow = window.localStorage.getItem(\"autoFollow\") != \"false\";\r\n\t\tthis.enableNotePreview = window.localStorage.getItem(\"enableNotePreview\") != \"false\";\r\n\t\tthis.showFifth = window.localStorage.getItem(\"showFifth\") == \"true\";\r\n\t\tthis.notesOutsideScale = window.localStorage.getItem(\"notesOutsideScale\") == \"true\";\r\n\t\tthis.showLetters = window.localStorage.getItem(\"showLetters\") == \"true\";\r\n\t\tthis.showChannels = window.localStorage.getItem(\"showChannels\") == \"true\";\r\n\t\tthis.showScrollBar = window.localStorage.getItem(\"showScrollBar\") == \"true\";\r\n\t\tthis.alwaysShowSettings = window.localStorage.getItem(\"alwaysShowSettings\") == \"true\";\r\n\t\tthis.instrumentCopyPaste = window.localStorage.getItem(\"instrumentCopyPaste\") == \"true\";\r\n\t\tthis.enableChannelMuting = window.localStorage.getItem(\"enableChannelMuting\") == \"true\";\r\n\t\tthis.displayBrowserUrl = window.localStorage.getItem(\"displayBrowserUrl\") != \"false\";\r\n\t\tthis.pressControlForShortcuts = window.localStorage.getItem(\"pressControlForShortcuts\") == \"true\";\r\n\t\tthis.enableMidi = window.localStorage.getItem(\"enableMidi\") != \"false\";\r\n\t\tthis.showRecordButton = window.localStorage.getItem(\"showRecordButton\") == \"true\";\r\n\t\tthis.snapRecordedNotesToRhythm = window.localStorage.getItem(\"snapRecordedNotesToRhythm\") == \"true\";\r\n\t\tthis.ignorePerformedNotesNotInScale = window.localStorage.getItem(\"ignorePerformedNotesNotInScale\") == \"true\";\r\n\t\tthis.metronomeCountIn = window.localStorage.getItem(\"metronomeCountIn\") != \"false\";\r\n\t\tthis.metronomeWhileRecording = window.localStorage.getItem(\"metronomeWhileRecording\") != \"false\";\r\n\t\tthis.keyboardLayout = window.localStorage.getItem(\"keyboardLayout\") || \"wickiHayden\";\r\n\t\tthis.layout = window.localStorage.getItem(\"TBBlayout\") || \"small\";\r\n\t\tthis.colorTheme = window.localStorage.getItem(\"TBBcolorTheme\") || \"dark classic\";\r\n\t\tthis.visibleOctaves = ((<any>window.localStorage.getItem(\"visibleOctaves\")) >>> 0) || Preferences.defaultVisibleOctaves;\r\n\t\t\r\n\t\tconst defaultScale: Scale | undefined = Config.scales.dictionary[window.localStorage.getItem(\"defaultScale\")!];\r\n\t\tthis.defaultScale = (defaultScale != undefined) ? defaultScale.index : 0;\r\n\t\t\r\n\t\tif (window.localStorage.getItem(\"volume\") != null) {\r\n\t\t\tthis.volume = Math.min(<any>window.localStorage.getItem(\"volume\") >>> 0, 75);\r\n\t\t}\r\n\t\t\r\n\t\tif (window.localStorage.getItem(\"fullScreen\") != null) {\r\n\t\t\tif (window.localStorage.getItem(\"fullScreen\") == \"true\") this.layout = \"long\";\r\n\t\t\twindow.localStorage.removeItem(\"fullScreen\");\r\n\t\t}\r\n\t}\r\n\t\r\n\tpublic save(): void {\r\n\t\twindow.localStorage.setItem(\"autoPlay\", this.autoPlay ? \"true\" : \"false\");\r\n\t\twindow.localStorage.setItem(\"autoFollow\", this.autoFollow ? \"true\" : \"false\");\r\n\t\twindow.localStorage.setItem(\"enableNotePreview\", this.enableNotePreview ? \"true\" : \"false\");\r\n\t\twindow.localStorage.setItem(\"showFifth\", this.showFifth ? \"true\" : \"false\");\r\n\t\twindow.localStorage.setItem(\"notesOutsideScale\", this.notesOutsideScale ? \"true\" : \"false\");\r\n\t\twindow.localStorage.setItem(\"defaultScale\", Config.scales[this.defaultScale].name);\r\n\t\twindow.localStorage.setItem(\"showLetters\", this.showLetters ? \"true\" : \"false\");\r\n\t\twindow.localStorage.setItem(\"showChannels\", this.showChannels ? \"true\" : \"false\");\r\n\t\twindow.localStorage.setItem(\"showScrollBar\", this.showScrollBar ? \"true\" : \"false\");\r\n\t\twindow.localStorage.setItem(\"alwaysShowSettings\", this.alwaysShowSettings ? \"true\" : \"false\");\r\n\t\twindow.localStorage.setItem(\"enableChannelMuting\", this.enableChannelMuting ? \"true\" : \"false\");\r\n\t\twindow.localStorage.setItem(\"instrumentCopyPaste\", this.instrumentCopyPaste ? \"true\" : \"false\");\r\n\t\twindow.localStorage.setItem(\"displayBrowserUrl\", this.displayBrowserUrl ? \"true\" : \"false\");\r\n\t\twindow.localStorage.setItem(\"pressControlForShortcuts\", this.pressControlForShortcuts ? \"true\" : \"false\");\r\n\t\twindow.localStorage.setItem(\"enableMidi\", this.enableMidi ? \"true\" : \"false\");\r\n\t\twindow.localStorage.setItem(\"showRecordButton\", this.showRecordButton ? \"true\" : \"false\");\r\n\t\twindow.localStorage.setItem(\"snapRecordedNotesToRhythm\", this.snapRecordedNotesToRhythm ? \"true\" : \"false\");\r\n\t\twindow.localStorage.setItem(\"ignorePerformedNotesNotInScale\", this.ignorePerformedNotesNotInScale ? \"true\" : \"false\");\r\n\t\twindow.localStorage.setItem(\"metronomeCountIn\", this.metronomeCountIn ? \"true\" : \"false\");\r\n\t\twindow.localStorage.setItem(\"metronomeWhileRecording\", this.metronomeWhileRecording ? \"true\" : \"false\");\r\n\t\twindow.localStorage.setItem(\"keyboardLayout\", this.keyboardLayout);\r\n\t\twindow.localStorage.setItem(\"TBBlayout\", this.layout);\r\n\t\twindow.localStorage.setItem(\"TBBcolorTheme\", this.colorTheme);\r\n\t\twindow.localStorage.setItem(\"volume\", String(this.volume));\r\n\t\twindow.localStorage.setItem(\"visibleOctaves\", String(this.visibleOctaves));\r\n\t}\r\n}\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nexport class ChangeNotifier {\r\n\tprivate _watchers: (()=>void)[] = [];\r\n\tprivate _dirty: boolean = false;\r\n\t\r\n\tpublic watch(watcher: ()=>void): void {\r\n\t\tif (this._watchers.indexOf(watcher) == -1) {\r\n\t\t\tthis._watchers.push(watcher);\r\n\t\t}\r\n\t}\r\n\t\r\n\tpublic unwatch(watcher: ()=>void): void {\r\n\t\tconst index: number = this._watchers.indexOf(watcher);\r\n\t\tif (index != -1) {\r\n\t\t\tthis._watchers.splice(index, 1);\r\n\t\t}\r\n\t}\r\n\t\r\n\tpublic changed(): void {\r\n\t\tthis._dirty = true;\r\n\t}\r\n\t\r\n\tpublic notifyWatchers(): void {\r\n\t\tif (!this._dirty) return;\r\n\t\tthis._dirty = false;\r\n\t\tfor (const watcher of this._watchers.concat()) {\r\n\t\t\twatcher();\r\n\t\t}\r\n\t}\r\n}\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nimport {Config} from \"../synth/SynthConfig\";\r\nimport {isMobile} from \"./EditorConfig\";\r\nimport {Pattern, Channel, Song, Synth} from \"../synth/synth\";\r\nimport {SongRecovery, generateUid, errorAlert} from \"./SongRecovery\";\r\nimport {ColorConfig} from \"./ColorConfig\";\r\nimport {Layout} from \"./Layout\";\r\nimport {SongPerformance} from \"./SongPerformance\";\r\nimport {Selection} from \"./Selection\";\r\nimport {Preferences} from \"./Preferences\";\r\nimport {Change} from \"./Change\";\r\nimport {ChangeNotifier} from \"./ChangeNotifier\";\r\nimport {ChangeSong, setDefaultInstruments, discardInvalidPatternInstruments} from \"./changes\";\r\n\r\ninterface HistoryState {\r\n\tcanUndo: boolean;\r\n\tsequenceNumber: number;\r\n\tbar: number;\r\n\tchannel: number;\r\n\tinstrument: number;\r\n\trecoveryUid: string;\r\n\tprompt: string | null;\r\n\tselection: {x0: number, x1: number, y0: number, y1: number, start: number, end: number};\r\n}\r\n\r\nexport class SongDocument {\r\n\tpublic song: Song;\r\n\tpublic synth: Synth;\r\n\tpublic performance: SongPerformance;\r\n\tpublic readonly notifier: ChangeNotifier = new ChangeNotifier();\r\n\tpublic readonly selection: Selection = new Selection(this);\r\n\tpublic readonly prefs: Preferences = new Preferences();\r\n\tpublic channel: number = 0;\r\n\tpublic bar: number = 0;\r\n\tpublic readonly recentPatternInstruments: number[][] = [];\r\n\tpublic readonly viewedInstrument: number[] = [];\r\n\t\r\n\tpublic trackVisibleBars: number = 16;\r\n\tpublic trackVisibleChannels: number = 4;\r\n\tpublic barScrollPos: number = 0;\r\n\tpublic channelScrollPos: number = 0;\r\n\tpublic prompt: string | null = null;\r\n\t\r\n\tpublic addedEffect: boolean = false;\r\n\tpublic addedEnvelope: boolean = false;\r\n\tpublic currentPatternIsDirty: boolean = false;\r\n\t\r\n\tprivate static readonly _maximumUndoHistory: number = 100;\r\n\tprivate _recovery: SongRecovery = new SongRecovery();\r\n\tprivate _recoveryUid: string;\r\n\tprivate _recentChange: Change | null = null;\r\n\tprivate _sequenceNumber: number = 0;\r\n\tprivate _lastSequenceNumber: number = 0;\r\n\tprivate _stateShouldBePushed: boolean = false;\r\n\tprivate _recordedNewSong: boolean = false;\r\n\tprivate _waitingToUpdateState: boolean = false;\r\n\t\r\n\tconstructor() {\r\n\t\tthis.notifier.watch(this._validateDocState);\r\n\t\t\r\n\t\tColorConfig.setTheme(this.prefs.colorTheme);\r\n\t\tLayout.setLayout(this.prefs.layout);\r\n\t\t\r\n\t\tif (window.sessionStorage.getItem(\"currentUndoIndex\") == null) {\r\n\t\t\twindow.sessionStorage.setItem(\"currentUndoIndex\", \"0\");\r\n\t\t\twindow.sessionStorage.setItem(\"oldestUndoIndex\", \"0\");\r\n\t\t\twindow.sessionStorage.setItem(\"newestUndoIndex\", \"0\");\r\n\t\t}\r\n\t\t\r\n\t\tlet songString: string = window.location.hash;\r\n\t\tif (songString == \"\") {\r\n\t\t\tsongString = this._getHash();\r\n\t\t}\r\n\t\ttry {\r\n\t\t\tthis.song = new Song(songString);\r\n\t\t\tif (songString == \"\" || songString == undefined) {\r\n\t\t\t\tsetDefaultInstruments(this.song);\r\n\t\t\t\tthis.song.scale = this.prefs.defaultScale;\r\n\t\t\t}\r\n\t\t} catch (error) {\r\n\t\t\terrorAlert(error);\r\n\t\t}\r\n\t\tsongString = this.song.toBase64String();\r\n\t\tthis.synth = new Synth(this.song);\r\n\t\tthis.synth.volume = this._calcVolume();\r\n\t\tthis.synth.anticipatePoorPerformance = isMobile;\r\n\t\t\r\n\t\tlet state: HistoryState | null = this._getHistoryState();\r\n\t\tif (state == null) {\r\n\t\t\t// When the page is first loaded, indicate that undo is NOT possible.\r\n\t\t\tstate = {canUndo: false, sequenceNumber: 0, bar: 0, channel: 0, instrument: 0, recoveryUid: generateUid(), prompt: null, selection: this.selection.toJSON()};\r\n\t\t}\r\n\t\tif (state.recoveryUid == undefined) state.recoveryUid = generateUid();\r\n\t\tthis._replaceState(state, songString);\r\n\t\twindow.addEventListener(\"hashchange\", this._whenHistoryStateChanged);\r\n\t\twindow.addEventListener(\"popstate\", this._whenHistoryStateChanged);\r\n\t\t\r\n\t\tthis.bar = state.bar | 0;\r\n\t\tthis.channel = state.channel | 0;\r\n\t\tfor (let i: number = 0; i <= this.channel; i++) this.viewedInstrument[i] = 0;\r\n\t\tthis.viewedInstrument[this.channel] = state.instrument | 0;\r\n\t\tthis._recoveryUid = state.recoveryUid;\r\n\t\t//this.barScrollPos = Math.max(0, this.bar - (this.trackVisibleBars - 6));\r\n\t\tthis.prompt = state.prompt;\r\n\t\tthis.selection.fromJSON(state.selection);\r\n\t\tthis.selection.scrollToSelectedPattern();\r\n\t\t\r\n\t\t// For all input events, catch them when they are about to finish bubbling,\r\n\t\t// presumably after all handlers are done updating the model, then update the\r\n\t\t// view before the screen renders. mouseenter and mouseleave do not bubble,\r\n\t\t// but they are immediately followed by mousemove which does. \r\n\t\tfor (const eventName of [\"input\", \"change\", \"click\", \"keyup\", \"keydown\", \"mousedown\", \"mousemove\", \"mouseup\", \"touchstart\", \"touchmove\", \"touchend\", \"touchcancel\"]) {\r\n\t\t\twindow.addEventListener(eventName, this._cleanDocument);\r\n\t\t}\r\n\t\t\r\n\t\tthis._validateDocState();\r\n\t\tthis.performance = new SongPerformance(this);\r\n\t}\r\n\t\r\n\tpublic toggleDisplayBrowserUrl() {\r\n\t\tconst state: HistoryState | null = this._getHistoryState();\r\n\t\tif (state == null) throw new Error(\"History state is null.\");\r\n\t\tthis.prefs.displayBrowserUrl = !this.prefs.displayBrowserUrl;\r\n\t\tthis._replaceState(state, this.song.toBase64String());\r\n\t}\r\n\t\r\n\tprivate _getHistoryState(): HistoryState | null {\r\n\t\tif (this.prefs.displayBrowserUrl) {\r\n\t\t\treturn window.history.state;\r\n\t\t} else {\r\n\t\t\tconst json: any = JSON.parse(window.sessionStorage.getItem(window.sessionStorage.getItem(\"currentUndoIndex\")!)!);\r\n\t\t\treturn json == null ? null : json.state;\r\n\t\t}\r\n\t}\r\n\t\r\n\tprivate _getHash(): string {\r\n\t\tif (this.prefs.displayBrowserUrl) {\r\n\t\t\treturn window.location.hash;\r\n\t\t} else {\r\n\t\t\tconst json: any = JSON.parse(window.sessionStorage.getItem(window.sessionStorage.getItem(\"currentUndoIndex\")!)!);\r\n\t\t\treturn json == null ? \"\" : json.hash;\r\n\t\t}\r\n\t}\r\n\t\r\n\tprivate _replaceState(state: HistoryState, hash: string): void {\r\n\t\tif (this.prefs.displayBrowserUrl) {\r\n\t\t\twindow.history.replaceState(state, \"\", \"#\" + hash);\r\n\t\t} else {\r\n\t\t\twindow.sessionStorage.setItem(window.sessionStorage.getItem(\"currentUndoIndex\") || \"0\", JSON.stringify({state, hash}));\r\n\t\t\twindow.history.replaceState(null, \"\", location.pathname);\r\n\t\t}\r\n\t}\r\n\t\r\n\tprivate _pushState(state: HistoryState, hash: string): void {\r\n\t\tif (this.prefs.displayBrowserUrl) {\r\n\t\t\twindow.history.pushState(state, \"\", \"#\" + hash);\r\n\t\t} else {\r\n\t\t\tlet currentIndex: number = Number(window.sessionStorage.getItem(\"currentUndoIndex\"));\r\n\t\t\tlet oldestIndex: number = Number(window.sessionStorage.getItem(\"oldestUndoIndex\"));\r\n\t\t\tcurrentIndex = (currentIndex + 1) % SongDocument._maximumUndoHistory;\r\n\t\t\twindow.sessionStorage.setItem(\"currentUndoIndex\", String(currentIndex));\r\n\t\t\twindow.sessionStorage.setItem(\"newestUndoIndex\", String(currentIndex));\r\n\t\t\tif (currentIndex == oldestIndex) {\r\n\t\t\t\toldestIndex = (oldestIndex + 1) % SongDocument._maximumUndoHistory;\r\n\t\t\t\twindow.sessionStorage.setItem(\"oldestUndoIndex\", String(oldestIndex));\r\n\t\t\t}\r\n\t\t\twindow.sessionStorage.setItem(String(currentIndex), JSON.stringify({state, hash}));\r\n\t\t\twindow.history.replaceState(null, \"\", location.pathname);\r\n\t\t}\r\n\t\tthis._lastSequenceNumber = state.sequenceNumber;\r\n\t}\r\n\t\r\n\tpublic hasRedoHistory(): boolean {\r\n\t\treturn this._lastSequenceNumber > this._sequenceNumber;\r\n\t}\r\n\t\r\n\tprivate _forward(): void {\r\n\t\tif (this.prefs.displayBrowserUrl) {\r\n\t\t\twindow.history.forward();\r\n\t\t} else {\r\n\t\t\tlet currentIndex: number = Number(window.sessionStorage.getItem(\"currentUndoIndex\"));\r\n\t\t\tlet newestIndex: number = Number(window.sessionStorage.getItem(\"newestUndoIndex\"));\r\n\t\t\tif (currentIndex != newestIndex) {\r\n\t\t\t\tcurrentIndex = (currentIndex + 1) % SongDocument._maximumUndoHistory;\r\n\t\t\t\twindow.sessionStorage.setItem(\"currentUndoIndex\", String(currentIndex));\r\n\t\t\t\tsetTimeout(this._whenHistoryStateChanged);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\t\r\n\tprivate _back(): void {\r\n\t\tif (this.prefs.displayBrowserUrl) {\r\n\t\t\twindow.history.back();\r\n\t\t} else {\r\n\t\t\tlet currentIndex: number = Number(window.sessionStorage.getItem(\"currentUndoIndex\"));\r\n\t\t\tlet oldestIndex: number = Number(window.sessionStorage.getItem(\"oldestUndoIndex\"));\r\n\t\t\tif (currentIndex != oldestIndex) {\r\n\t\t\t\tcurrentIndex = (currentIndex + SongDocument._maximumUndoHistory - 1) % SongDocument._maximumUndoHistory;\r\n\t\t\t\twindow.sessionStorage.setItem(\"currentUndoIndex\", String(currentIndex));\r\n\t\t\t\tsetTimeout(this._whenHistoryStateChanged);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\t\r\n\tprivate _whenHistoryStateChanged = (): void => {\r\n\t\tif (this.synth.recording) {\r\n\t\t\t// Changes to the song while it's recording to could mess up the recording so just abort the recording.\r\n\t\t\tthis.performance.abortRecording();\r\n\t\t}\r\n\t\t\r\n\t\tif (window.history.state == null && window.location.hash != \"\") {\r\n\t\t\t// The user changed the hash directly.\r\n\t\t\tthis._sequenceNumber++;\r\n\t\t\tthis._resetSongRecoveryUid();\r\n\t\t\tconst state: HistoryState = {canUndo: true, sequenceNumber: this._sequenceNumber, bar: this.bar, channel: this.channel, instrument: this.viewedInstrument[this.channel], recoveryUid: this._recoveryUid, prompt: null, selection: this.selection.toJSON()};\r\n\t\t\ttry {\r\n\t\t\t\tnew ChangeSong(this, window.location.hash);\r\n\t\t\t} catch (error) {\r\n\t\t\t\terrorAlert(error);\r\n\t\t\t}\r\n\t\t\tthis.prompt = state.prompt;\r\n\t\t\tif (this.prefs.displayBrowserUrl) {\r\n\t\t\t\tthis._replaceState(state, this.song.toBase64String());\r\n\t\t\t} else {\r\n\t\t\t\tthis._pushState(state, this.song.toBase64String());\r\n\t\t\t}\r\n\t\t\tthis.forgetLastChange();\r\n\t\t\tthis.notifier.notifyWatchers();\r\n\t\t\treturn;\r\n\t\t}\r\n\t\t\r\n\t\tconst state: HistoryState | null = this._getHistoryState();\r\n\t\tif (state == null) throw new Error(\"History state is null.\");\r\n\t\t\r\n\t\t// Abort if we've already handled the current state. \r\n\t\tif (state.sequenceNumber == this._sequenceNumber) return;\r\n\t\t\r\n\t\tthis.bar = state.bar;\r\n\t\tthis.channel = state.channel;\r\n\t\tthis.viewedInstrument[this.channel] = state.instrument;\r\n\t\tthis._sequenceNumber = state.sequenceNumber;\r\n\t\tthis.prompt = state.prompt;\r\n\t\t\r\n\t\ttry {\r\n\t\t\tnew ChangeSong(this, this._getHash());\r\n\t\t} catch (error) {\r\n\t\t\terrorAlert(error);\r\n\t\t}\r\n\t\t\r\n\t\tthis._recoveryUid = state.recoveryUid;\r\n\t\tthis.selection.fromJSON(state.selection);\r\n\t\t\r\n\t\t//this.barScrollPos = Math.min(this.bar, Math.max(this.bar - (this.trackVisibleBars - 1), this.barScrollPos));\r\n\t\t\r\n\t\tthis.forgetLastChange();\r\n\t\tthis.notifier.notifyWatchers();\r\n\t}\r\n\t\r\n\tprivate _cleanDocument = (): void => {\r\n\t\tthis.notifier.notifyWatchers();\r\n\t}\r\n\t\r\n\tprivate _validateDocState = (): void => {\r\n\t\tconst channelCount: number = this.song.getChannelCount();\r\n\t\tfor (let i: number = this.recentPatternInstruments.length; i < channelCount; i++) {\r\n\t\t\tthis.recentPatternInstruments[i] = [0];\r\n\t\t}\r\n\t\tthis.recentPatternInstruments.length = channelCount;\r\n\t\tfor (let i: number = 0; i < channelCount; i++) {\r\n\t\t\tif (i == this.channel) {\r\n\t\t\t\tif (this.song.patternInstruments) {\r\n\t\t\t\t\tconst pattern: Pattern | null = this.song.getPattern(this.channel, this.bar);\r\n\t\t\t\t\tif (pattern != null) {\r\n\t\t\t\t\t\tthis.recentPatternInstruments[i] = pattern.instruments.concat();\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\tconst channel: Channel = this.song.channels[this.channel];\r\n\t\t\t\t\tfor (let j: number = 0; j < channel.instruments.length; j++) {\r\n\t\t\t\t\t\tthis.recentPatternInstruments[i][j] = j;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tthis.recentPatternInstruments[i].length = channel.instruments.length;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tdiscardInvalidPatternInstruments(this.recentPatternInstruments[i], this.song, i);\r\n\t\t}\r\n\t\t\r\n\t\tfor (let i: number = this.viewedInstrument.length; i < channelCount; i++) {\r\n\t\t\tthis.viewedInstrument[i] = 0;\r\n\t\t}\r\n\t\tthis.viewedInstrument.length = channelCount;\r\n\t\tfor (let i: number = 0; i < channelCount; i++) {\r\n\t\t\tif (this.song.patternInstruments && !this.song.layeredInstruments && i == this.channel) {\r\n\t\t\t\tconst pattern: Pattern | null = this.song.getPattern(this.channel, this.bar);\r\n\t\t\t\tif (pattern != null) {\r\n\t\t\t\t\tthis.viewedInstrument[i] = pattern.instruments[0];\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tthis.viewedInstrument[i] = Math.min(this.viewedInstrument[i] | 0, this.song.channels[i].instruments.length - 1);\r\n\t\t}\r\n\t\t\r\n\t\tconst highlightedPattern: Pattern | null = this.getCurrentPattern();\r\n\t\tif (highlightedPattern != null && this.song.patternInstruments) {\r\n\t\t\tthis.recentPatternInstruments[this.channel] = highlightedPattern.instruments.concat();\r\n\t\t}\r\n\t\t\r\n\t\t// Normalize selection.\r\n\t\t// I'm allowing the doc.bar to drift outside the box selection while playing\r\n\t\t// because it may auto-follow the playhead outside the selection but it would\r\n\t\t// be annoying to lose your selection just because the song is playing.\r\n\t\tif ((!this.synth.playing && (this.bar < this.selection.boxSelectionBar || this.selection.boxSelectionBar + this.selection.boxSelectionWidth <= this.bar)) ||\r\n\t\t\tthis.channel < this.selection.boxSelectionChannel ||\r\n\t\t\tthis.selection.boxSelectionChannel + this.selection.boxSelectionHeight <= this.channel ||\r\n\t\t\tthis.song.barCount < this.selection.boxSelectionBar + this.selection.boxSelectionWidth ||\r\n\t\t\tchannelCount < this.selection.boxSelectionChannel + this.selection.boxSelectionHeight ||\r\n\t\t\t(this.selection.boxSelectionWidth == 1 && this.selection.boxSelectionHeight == 1))\r\n\t\t{\r\n\t\t\tthis.selection.resetBoxSelection();\r\n\t\t}\r\n\t\t\r\n\t\tthis.barScrollPos     = Math.max(0, Math.min(this.song.barCount          - this.trackVisibleBars,     this.barScrollPos));\r\n\t\tthis.channelScrollPos = Math.max(0, Math.min(this.song.getChannelCount() - this.trackVisibleChannels, this.channelScrollPos));\r\n\t}\r\n\t\r\n\tprivate _updateHistoryState = (): void => {\r\n\t\tthis._waitingToUpdateState = false;\r\n\t\tlet hash: string;\r\n\t\ttry {\r\n\t\t\t// Ensure that the song is not corrupted before saving it.\r\n\t\t\thash = this.song.toBase64String();\r\n\t\t} catch (error) {\r\n\t\t\terrorAlert(error);\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tif (this._stateShouldBePushed) this._sequenceNumber++;\r\n\t\tif (this._recordedNewSong) {\r\n\t\t\tthis._resetSongRecoveryUid();\r\n\t\t} else {\r\n\t\t\tthis._recovery.saveVersion(this._recoveryUid, hash);\r\n\t\t}\r\n\t\tlet state: HistoryState = {canUndo: true, sequenceNumber: this._sequenceNumber, bar: this.bar, channel: this.channel, instrument: this.viewedInstrument[this.channel], recoveryUid: this._recoveryUid, prompt: this.prompt, selection: this.selection.toJSON()};\r\n\t\tif (this._stateShouldBePushed) {\r\n\t\t\tthis._pushState(state, hash);\r\n\t\t} else {\r\n\t\t\tthis._replaceState(state, hash);\r\n\t\t}\r\n\t\tthis._stateShouldBePushed = false;\r\n\t\tthis._recordedNewSong = false;\r\n\t}\r\n\t\r\n\tpublic record(change: Change, replace: boolean = false, newSong: boolean = false): void {\r\n\t\tif (change.isNoop()) {\r\n\t\t\tthis._recentChange = null;\r\n\t\t\tif (replace) this._back();\r\n\t\t} else {\r\n\t\t\tchange.commit();\r\n\t\t\tthis._recentChange = change;\r\n\t\t\tthis._stateShouldBePushed = this._stateShouldBePushed || !replace;\r\n\t\t\tthis._recordedNewSong = this._recordedNewSong || newSong;\r\n\t\t\tif (!this._waitingToUpdateState) {\r\n\t\t\t\t// Defer updating the url/history until all sequenced changes have\r\n\t\t\t\t// committed and the interface has rendered the latest changes to\r\n\t\t\t\t// improve perceived responsiveness.\r\n\t\t\t\twindow.requestAnimationFrame(this._updateHistoryState);\r\n\t\t\t\tthis._waitingToUpdateState = true;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\t\r\n\tprivate _resetSongRecoveryUid(): void {\r\n\t\tthis._recoveryUid = generateUid();\r\n\t}\r\n\t\r\n\tpublic openPrompt(prompt: string): void {\r\n\t\tthis.prompt = prompt;\r\n\t\tconst hash: string = this.song.toBase64String();\r\n\t\tthis._sequenceNumber++;\r\n\t\tconst state = {canUndo: true, sequenceNumber: this._sequenceNumber, bar: this.bar, channel: this.channel, instrument: this.viewedInstrument[this.channel], recoveryUid: this._recoveryUid, prompt: this.prompt, selection: this.selection.toJSON()};\r\n\t\tthis._pushState(state, hash);\r\n\t}\r\n\t\r\n\tpublic undo(): void {\r\n\t\tconst state: HistoryState | null = this._getHistoryState();\r\n\t\tif (state == null || state.canUndo) this._back();\r\n\t}\r\n\t\r\n\tpublic redo(): void {\r\n\t\tthis._forward();\r\n\t}\r\n\t\r\n\tpublic setProspectiveChange(change: Change | null): void {\r\n\t\tthis._recentChange = change;\r\n\t}\r\n\t\r\n\tpublic forgetLastChange(): void {\r\n\t\tthis._recentChange = null;\r\n\t}\r\n\t\r\n\tpublic lastChangeWas(change: Change | null): boolean {\r\n\t\treturn change != null && change == this._recentChange;\r\n\t}\r\n\t\r\n\tpublic goBackToStart(): void {\r\n\t\tthis.bar = 0;\r\n\t\tthis.channel = 0;\r\n\t\tthis.barScrollPos = 0;\r\n\t\tthis.channelScrollPos = 0;\r\n\t\tthis.synth.snapToStart();\r\n\t\tthis.notifier.changed();\r\n\t}\r\n\t\r\n\tpublic setVolume(val: number): void {\r\n\t\tthis.prefs.volume = val;\r\n\t\tthis.prefs.save();\r\n\t\tthis.synth.volume = this._calcVolume();\r\n\t}\r\n\t\r\n\tprivate _calcVolume(): number {\r\n\t\treturn Math.min(1.0, Math.pow(this.prefs.volume / 50.0, 0.5)) * Math.pow(2.0, (this.prefs.volume - 75.0) / 25.0);\r\n\t}\r\n\t\r\n\tpublic getCurrentPattern(barOffset: number = 0): Pattern | null {\r\n\t\treturn this.song.getPattern(this.channel, this.bar + barOffset);\r\n\t}\r\n\t\r\n\tpublic getCurrentInstrument(barOffset: number = 0): number {\r\n\t\treturn this.viewedInstrument[this.channel];\r\n\t}\r\n\t\r\n\tpublic getMobileLayout(): boolean {\r\n\t\treturn window.innerWidth <= 710;\r\n\t}\r\n\t\r\n\tpublic getBarWidth(): number {\r\n\t\treturn (!this.getMobileLayout() && this.prefs.enableChannelMuting && !this.getFullScreen()) ? 30 : 32;\r\n\t}\r\n\t\r\n\tpublic getFullScreen(): boolean {\r\n\t\treturn !this.getMobileLayout() && (this.prefs.layout != \"small\");\r\n\t}\r\n\t\r\n\tpublic getVisibleOctaveCount(): number {\r\n\t\treturn this.getFullScreen() ? this.prefs.visibleOctaves : Preferences.defaultVisibleOctaves;\r\n\t}\r\n\t\r\n\tpublic getVisiblePitchCount(): number {\r\n\t\t return this.getVisibleOctaveCount() * Config.pitchesPerOctave + 1;\r\n\t}\r\n\t\r\n\tpublic getBaseVisibleOctave(channel: number): number {\r\n\t\tconst visibleOctaveCount: number = this.getVisibleOctaveCount();\r\n\t\treturn Math.max(0, Math.min(Config.pitchOctaves - visibleOctaveCount, Math.ceil(this.song.channels[channel].octave - visibleOctaveCount * 0.5)));\r\n\t}\r\n}\r\n","// Copyright (c) 2012-2022 John Nesky and contributing authors, distributed under the MIT license, see accompanying the LICENSE.md file.\r\n\r\nimport {Dictionary, DictionaryArray, EnvelopeType, InstrumentType, Transition, Chord, Envelope, Config} from \"../synth/SynthConfig\";\r\nimport {isMobile, EditorConfig} from \"./EditorConfig\";\r\nimport {ColorConfig} from \"./ColorConfig\";\r\nimport \"./style\"; // Import for the side effects, there's no exports.\r\nimport {SongEditor} from \"./SongEditor\";\r\nimport {NotePin, Note, Pattern, Instrument, Channel, Song, Synth} from \"../synth/synth\";\r\nimport {SongDocument} from \"./SongDocument\";\r\nimport {ExportPrompt} from \"./ExportPrompt\";\r\nimport {ChangePreset} from \"./changes\";\r\n\r\nconst doc: SongDocument = new SongDocument();\r\nconst editor: SongEditor = new SongEditor(doc);\r\nconst beepboxEditorContainer: HTMLElement = document.getElementById(\"beepboxEditorContainer\")!;\r\nbeepboxEditorContainer.appendChild(editor.mainLayer);\r\neditor.whenUpdated();\r\neditor.mainLayer.focus();\r\n\r\n// don't autoplay on mobile devices, wait for input.\r\nif (!isMobile && doc.prefs.autoPlay) {\r\n\tfunction autoplay(): void {\r\n\t\tif (!document.hidden) {\r\n\t\t\tdoc.synth.play();\r\n\t\t\teditor.updatePlayButton();\r\n\t\t\twindow.removeEventListener(\"visibilitychange\", autoplay);\r\n\t\t}\r\n\t}\r\n\tif (document.hidden) {\r\n\t\t// Wait until the tab is visible to autoplay:\r\n\t\twindow.addEventListener(\"visibilitychange\", autoplay);\r\n\t} else {\r\n\t\tautoplay();\r\n\t}\r\n}\r\n\r\n// BeepBox uses browser history state as its own undo history. Browsers typically\r\n// remember scroll position for each history state, but BeepBox users would prefer not \r\n// auto scrolling when undoing. Sadly this tweak doesn't work on Edge or IE.\r\nif (\"scrollRestoration\" in history) history.scrollRestoration = \"manual\";\r\n\r\neditor.updatePlayButton();\r\n\r\nif (\"serviceWorker\" in navigator) {\r\n\tnavigator.serviceWorker.register(\"/service_worker.js\", {updateViaCache: \"all\", scope: \"/\"}).catch(() => {});\r\n}\r\n\r\n// When compiling synth.ts as a standalone module named \"beepbox\", expose these classes as members to JavaScript:\r\nexport {Dictionary, DictionaryArray, EnvelopeType, InstrumentType, Transition, Chord, Envelope, Config, NotePin, Note, Pattern, Instrument, Channel, Song, Synth, ColorConfig, EditorConfig, SongDocument, SongEditor, ExportPrompt, ChangePreset};\r\n"],"mappings":"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G,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,KAAK,CAACtB,eAAiB,UAAUsB,SAAW,CAAC,EAAE,EAAE,EAAE,EAAE,EAAE,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,KAAK,CAACtB,eAAiB,UAAUsB,SAAW,CAAC,EAAE,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,KAAK,CAACtB,eAAiB,UAAUsB,SAAW,CAAC,EAAE,EAAE,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,KAAK,CAACtB,eAAiB,UAAUsB,SAAW,CAAC,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,KAAK,CAACtB,eAAiB,UAAUsB,SAAW,CAAC,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,KAAK,CAACtB,eAAiB,UAAUsB,SAAW,CAAC,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,KAAK,CAACtB,eAAiB,UAAUsB,SAAW,CAAC,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAAG,GAA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ChBnE,KAAKi5C,GAAa70C,oBAAoB,QAASpE,KAAKiE,EAAO,EAjTnDvQ,GACP,IAAK,QACJslD,EAAU12C,GACTa,GAAG,SACH21C,GAAE,wdACFA,GAAE,wVAEF,MACF,IAAK,MACJE,EAAU12C,GACTa,GAAG,YACH21C,GAAE,gMACFA,GAAE,+PAEF,MACF,IAAK,QACJE,EAAU12C,GACTa,GAAG,cACH21C,GAAE,kPAEF,MACF,IAAK,SACJE,EAAU12C,GACTa,GAAG,UACH21C,GAAE,oSAEF,MACF,IAAK,SACJE,EAAU12C,GACTa,GAAG,UACH21C,GAAE,yIACFA,GAAE,wPAEF,MACF,IAAK,kBACJE,EAAU12C,GACTa,GAAG,qBACH21C,GAAE,kIACFA,GAAE,6OACFA,GAAE,0OACFA,GAAE,kMACFA,GAAE,wNAEF,MACF,IAAK,mBACJE,EAAU12C,GACTa,GAAG,qBACH21C,GAAE,0MAEF,MACF,IAAK,MACJE,EAAU12C,GACTa,GAAG,sBACH21C,GAAE,0LACFA,GAAE,iUAEF,MACF,IAAK,iBACJE,EAAU12C,GACTa,GAAG,mBACH21C,GAAE,8GACFA,GAAE,qJAEF,MACF,IAAK,WACJE,EAAU12C,GACTa,GAAG,aACH21C,GAAE,0RACFA,GAAE,kPACFA,GAAE,oRACFA,GAAE,6SAEF,MACF,IAAK,aACJE,EAAU12C,GACTa,GAAG,eACH21C,GAAE,kQACFA,GAAE,0RACFA,GAAE,kPACFA,GAAE,qRAEF,MACF,IAAK,YACJE,EAAU12C,GACTa,GAAG,eACH21C,GAAE,2HACFA,GAAE,qKACFA,GAAE,uNAEF,MACF,IAAK,aACJE,EAAU12C,GACTa,GAAG,cACH21C,GAAE,6PACFA,GAAE,gXACFA,GAAE,wTAEF,MACF,IAAK,WACJE,EAAU12C,GACTa,GAAG,aACH21C,GAAE,+NAEF,MACF,IAAK,YACJE,EAAU12C,GACTa,GAAG,SACH21C,GAAE,8KAEF,MACF,IAAK,mBACJE,EAAU12C,GACTa,GAAG,qBACH21C,GAAE,2HACFA,GAAE,uVAEF,MACF,IAAK,iBACJE,EAAU12C,GACTa,GAAG,mBACH21C,GAAE,mMACFA,GAAE,qaAEF,MACF,IAAK,gBACJE,EAAU12C,GACTa,GAAG,kBACH21C,GAAE,sKACFA,GAAE,mGAEF,MACF,IAAK,aACJE,EAAU12C,GACTa,GAAG,oBACH21C,GAAE,+KAEF,MACF,IAAK,SACJE,EAAU12C,GACTa,GAAG,UACH21C,GAAE,+ZACFA,GAAE,gSAEF,MACF,IAAK,SACJE,EAAU12C,GACTa,GAAG,UACH21C,GAAE,gLACFA,GAAE,0YACFA,GAAE,oOAEF,MACF,IAAK,UACJE,EAAU12C,GACTa,GAAG,WACH21C,GAAE,8GAEF,MACF,IAAK,YACJE,EAAU12C,GACTa,GAAG,gBACH21C,GAAE,mRACFA,GAAE,wHACFA,GAAE,yYAEF,MACF,IAAK,eACJE,EAAU12C,GACTa,GAAG,iBACH21C,GAAE,6KAEF,MACF,IAAK,iBACJE,EAAU12C,GACTa,GAAG,uBACH21C,GAAE,gGAEF,MACF,IAAK,oBACJE,EAAU12C,GACTa,GAAG,sBACH21C,GAAE,kWACFA,GAAE,gJAEF,MACF,IAAK,iBACJE,EAAU12C,GACTa,GAAG,mBACH21C,GAAE,kIAEF,MACF,IAAK,WACJE,EAAU12C,GACTa,GAAG,YACH21C,GAAE,iGACFA,GAAE,gJACFA,GAAE,yIAEF,MACF,IAAK,YACJE,EAAU12C,GACTa,GAAG,aACH21C,GAAE,mNACFA,GAAE,+IAEF,MACF,IAAK,UACJE,EAAU12C,GACTa,GAAG,WACH21C,GAAE,yLAEF,MACF,IAAK,kBACJE,EAAU12C,GACTa,GAAG,oBACH21C,GAAE,oMAEF,MACF,IAAK,kBACJE,EAAU12C,GACTa,GAAG,oBACH21C,GAAE,oJACFA,GAAE,yIAEF,MACF,IAAK,SACJE,EAAU12C,GACTa,GAAG,UACH21C,GAAE,0MAEF,MACF,IAAK,cACJE,EAAU12C,GACTa,GAAG,eACH21C,GAAE,+JAEF,MACF,IAAK,YACJE,EAAU12C,GACTa,GAAG,cACH21C,GAAE,mHAEF,MACF,IAAK,aACJE,EAAU12C,GACTa,GAAG,eACH21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"}